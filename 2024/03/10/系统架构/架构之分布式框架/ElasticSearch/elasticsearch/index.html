

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Kblayt">
  <meta name="keywords" content="">
  
    <meta name="description" content="全文检索数据分类：  结构化数据： 固定格式，有限长度    比如mysql存的数据 非结构化数据：不定长，无固定格式   比如邮件，word文档，日志 半结构化数据： 前两者结合     比如xml，html  搜索分类：  结构化数据搜索：  使用关系型数据库  非结构化数据搜索   顺序扫描 全文检索    设想一个关于搜索的场景，假设我们要搜索一首诗句内容中带“前”字的古诗    name">
<meta property="og:type" content="article">
<meta property="og:title" content="elasticsearch">
<meta property="og:url" content="https://kblayt.github.io/2024/03/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6/ElasticSearch/elasticsearch/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="全文检索数据分类：  结构化数据： 固定格式，有限长度    比如mysql存的数据 非结构化数据：不定长，无固定格式   比如邮件，word文档，日志 半结构化数据： 前两者结合     比如xml，html  搜索分类：  结构化数据搜索：  使用关系型数据库  非结构化数据搜索   顺序扫描 全文检索    设想一个关于搜索的场景，假设我们要搜索一首诗句内容中带“前”字的古诗    name">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46866">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46781">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46333">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46329">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/50604">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/50800">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46439">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46437">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46325">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46442">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46527">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46255">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46614">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/49275">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46552">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/48965">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46611">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46817">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46920">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/49281">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46708">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46764">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46726">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46891">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46896">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46918">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/47001">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46977">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46942">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/46988">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/47023">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/50609">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/47101">
<meta property="og:image" content="https://kblayt.github.io/elasticsearch/47219">
<meta property="article:published_time" content="2024-03-10T05:11:13.000Z">
<meta property="article:modified_time" content="2024-03-14T09:16:30.425Z">
<meta property="article:author" content="Kblayt">
<meta property="article:tag" content="elasticsearch">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://kblayt.github.io/elasticsearch/46866">
  
  
  
  <title>elasticsearch - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"kblayt.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="elasticsearch"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-03-10 13:11" pubdate>
          2024年3月10日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          20k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          170 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">elasticsearch</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a><strong>全文检索</strong></h1><p><strong>数据分类：</strong></p>
<ul>
<li>结构化数据： 固定格式，有限长度    比如mysql存的数据</li>
<li>非结构化数据：不定长，无固定格式   比如邮件，word文档，日志</li>
<li>半结构化数据： 前两者结合     比如xml，html</li>
</ul>
<p><strong>搜索分类：</strong></p>
<ul>
<li><p>结构化数据搜索：  使用关系型数据库</p>
</li>
<li><p>非结构化数据搜索</p>
</li>
<li><ul>
<li>顺序扫描</li>
<li>全文检索</li>
</ul>
</li>
</ul>
<p>设想一个关于搜索的场景，假设我们要搜索一首诗句内容中带“前”字的古诗</p>
<table>
<thead>
<tr>
<th>name</th>
<th>content</th>
<th>author</th>
</tr>
</thead>
<tbody><tr>
<td>静夜思</td>
<td>床前明月光,疑是地上霜。举头望明月，低头思故乡。</td>
<td>李白</td>
</tr>
<tr>
<td>望庐山瀑布</td>
<td>日照香炉生紫烟，遥看瀑布挂前川。飞流直下三千尺,疑是银河落九天。</td>
<td>李白</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<p>思考：用传统关系型数据库和ES 实现会有什么差别？</p>
<p>如果用像 MySQL 这样的 RDBMS 来存储古诗的话，我们应该会去使用这样的 SQL 去查询</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">select</span> <span class="hljs-type">name</span> <span class="hljs-keyword">from</span> poems <span class="hljs-keyword">where</span> content <span class="hljs-keyword">like</span> &quot;%前%&quot;              <br></code></pre></td></tr></table></figure>

<p>这种我们称为顺序扫描法，需要遍历所有的记录进行匹配。不但效率低，而且不符合我们搜索时的期望，比如我们在搜索“ABCD”这样的关键词时，通常还希望看到”A”,”AB”,”CD”,“ABC”的搜索结果。</p>
<h2 id="什么是全文检索"><a href="#什么是全文检索" class="headerlink" title="什么是全文检索"></a><strong>什么是全文检索</strong></h2><p>全文检索是指：</p>
<ul>
<li>通过一个程序扫描文本中的每一个单词，针对单词建立索引，并保存该单词在文本中的位置、以及出现的次数</li>
<li>用户查询时，通过之前建立好的索引来查询，将索引中单词对应的文本位置、出现的次数返回给用户，因为有了具体文本的位置，所以就可以将具体内容读取出来了</li>
</ul>
<p>​    <img src="/elasticsearch/46866" srcset="/img/loading.gif" lazyload alt="0"></p>
<p>搜索原理简单概括的话可以分为这么几步：</p>
<ul>
<li>内容爬取，停顿词过滤比如一些无用的像”的”，“了”之类的语气词&#x2F;连接词</li>
<li>内容分词，提取关键词</li>
<li>根据关键词建立倒排索引</li>
<li>用户输入关键词进行搜索</li>
</ul>
<h2 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a><strong>倒排索引</strong></h2><p>索引就类似于目录，平时我们使用的都是索引，都是通过主键定位到某条数据，那么倒排索引呢，刚好相反，数据对应到主键。</p>
<p>​    <img src="/elasticsearch/46781" srcset="/img/loading.gif" lazyload alt="0"></p>
<p>这里以一个博客文章的内容为例:</p>
<p><strong>正排索引（正向索引）</strong></p>
<table>
<thead>
<tr>
<th>文章ID</th>
<th>文章标题</th>
<th>文章内容</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>浅析JAVA设计模式</td>
<td>JAVA设计模式是每一个JAVA程序员都应该掌握的进阶知识</td>
</tr>
<tr>
<td>2</td>
<td>JAVA多线程设计模式</td>
<td>JAVA多线程与设计模式结合</td>
</tr>
</tbody></table>
<p><strong>倒排索引（反向索引）</strong></p>
<p>假如，我们有一个站内搜索的功能，通过某个关键词来搜索相关的文章，那么这个关键词可能出现在标题中，也可能出现在文章内容中，那我们将会在创建或修改文章的时候，建立一个关键词与文章的对应关系表，这种，我们可以称之为倒排索引。</p>
<p>like %java设计模式%     java  设计模式</p>
<table>
<thead>
<tr>
<th>关键词</th>
<th>文章ID</th>
</tr>
</thead>
<tbody><tr>
<td>JAVA</td>
<td>1,2</td>
</tr>
<tr>
<td>设计模式</td>
<td>1,2</td>
</tr>
<tr>
<td>多线程</td>
<td>2</td>
</tr>
</tbody></table>
<p>简单理解，正向索引是通过key找value，反向索引则是通过value找key。ES底层在检索时底层使用的就是倒排索引。</p>
<h1 id="ElasticSearch简介"><a href="#ElasticSearch简介" class="headerlink" title="ElasticSearch简介"></a><strong>ElasticSearch简介</strong></h1><h2 id="ElasticSearch是什么"><a href="#ElasticSearch是什么" class="headerlink" title="ElasticSearch是什么"></a><strong>ElasticSearch是什么</strong></h2><p>ElasticSearch（简称ES）是一个分布式、RESTful 风格的搜索和数据分析引擎，是用Java开发并且是当前最流行的开源的企业级搜索引擎，能够达到近实时搜索，稳定，可靠，快速，安装使用方便。</p>
<p>客户端支持Java、.NET（C#）、PHP、Python、Ruby等多种语言。</p>
<p><strong>官方网站:</strong> <a target="_blank" rel="noopener" href="https://www.elastic.co/">https://www.elastic.co/</a></p>
<p><strong>下载地址：</strong><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch">https://www.elastic.co/cn/downloads/past-releases#elasticsearch</a></p>
<p>搜索引擎排名：</p>
<p>​    <img src="/elasticsearch/46333" srcset="/img/loading.gif" lazyload alt="0"></p>
<p>参考网站：<a target="_blank" rel="noopener" href="https://db-engines.com/en/ranking/search+engine">https://db-engines.com/en/ranking/search+engine</a></p>
<h3 id="起源——Lucene"><a href="#起源——Lucene" class="headerlink" title="起源——Lucene"></a><strong>起源——Lucene</strong></h3><ul>
<li><p>基于Java语言开发的搜索引擎库类</p>
</li>
<li><p>创建于1999年，2005年成为Apache 顶级开源项目</p>
</li>
<li><p>Lucene具有高性能、易扩展的优点</p>
</li>
<li><p>Lucene的局限性︰</p>
</li>
<li><ul>
<li>只能基于Java语言开发</li>
<li>类库的接口学习曲线陡峭</li>
<li>原生并不支持水平扩展</li>
</ul>
</li>
</ul>
<h3 id="Elasticsearch的诞生"><a href="#Elasticsearch的诞生" class="headerlink" title="Elasticsearch的诞生"></a><strong>Elasticsearch的诞生</strong></h3><p>Elasticsearch是构建在Apache Lucene之上的开源分布式搜索引擎。</p>
<ul>
<li><p>2004年 Shay Banon 基于Lucene开发了Compass</p>
</li>
<li><p>2010年 Shay Banon重写了Compass，取名Elasticsearch</p>
</li>
<li><ul>
<li>支持分布式，可水平扩展</li>
<li>降低全文检索的学习曲线，可以被任何编程语言调用</li>
</ul>
</li>
</ul>
<p>​    <img src="/elasticsearch/46329" srcset="/img/loading.gif" lazyload alt="0"></p>
<p>Elasticsearch 与 Lucene 核心库竞争的优势在于： </p>
<ul>
<li>完美封装了 Lucene 核心库，设计了友好的 Restful-API，开发者无需过多关注底层机制，直接开箱即用。</li>
<li>分片与副本机制，直接解决了集群下性能与高可用问题。</li>
</ul>
<p>ES Server进程  3节点   raft  (奇数节点) </p>
<p>数据分片 -》lucene实例   分片和副本数    1个ES节点可以有多个lucene实例。也可以指定一个索引的多个分片</p>
<p>​    <img src="/elasticsearch/50604" srcset="/img/loading.gif" lazyload alt="0"></p>
<h3 id="ElasticSearch版本特性"><a href="#ElasticSearch版本特性" class="headerlink" title="ElasticSearch版本特性"></a><strong>ElasticSearch版本特性</strong></h3><p>5.x新特性</p>
<ul>
<li><p>Lucene 6.x， 性能提升，默认打分机制从TF-IDF改为BM 25</p>
</li>
<li><p>支持Ingest节点&#x2F; Painless Scripting &#x2F; Completion suggested支持&#x2F;原生的Java REST客户端</p>
</li>
<li><p>Type标记成deprecated， 支持了Keyword的类型</p>
</li>
<li><p>性能优化</p>
</li>
<li><ul>
<li>内部引擎移除了避免同一文档并发更新的竞争锁，带来15% - 20%的性能提升</li>
<li>Instant aggregation,支持分片，上聚合的缓存</li>
<li>新增了Profile API</li>
</ul>
</li>
</ul>
<p>6.x新特性</p>
<ul>
<li><p>Lucene 7.x</p>
</li>
<li><p>新功能</p>
</li>
<li><ul>
<li>跨集群复制(CCR)</li>
<li>索引生命周期管理</li>
<li>SQL的支持</li>
</ul>
</li>
<li><p>更友好的的升级及数据迁移</p>
</li>
<li><ul>
<li>在主要版本之间的迁移更为简化，体验升级</li>
<li>全新的基于操作的数据复制框架，可加快恢复数据</li>
</ul>
</li>
<li><p>性能优化</p>
</li>
<li><ul>
<li>有效存储稀疏字段的新方法，降低了存储成本</li>
<li>在索引时进行排序，可加快排序的查询性能</li>
</ul>
</li>
</ul>
<p>7.x新特性</p>
<ul>
<li><p>Lucene 8.0</p>
</li>
<li><p>重大改进-正式废除单个索引下多Type的支持</p>
</li>
<li><p>7.1开始，Security 功能免费使用</p>
</li>
<li><p>ECK - Elasticseach Operator on Kubernetes</p>
</li>
<li><p>新功能</p>
</li>
<li><ul>
<li>New Cluster coordination</li>
<li>Feature——Complete High Level REST Client</li>
<li>Script Score Query</li>
</ul>
</li>
<li><p>性能优化</p>
</li>
<li><ul>
<li>默认的Primary Shard数从5改为1,避免Over Sharding</li>
<li>性能优化， 更快的Top K</li>
</ul>
</li>
</ul>
<p>8.x新特性</p>
<ul>
<li>Rest API相比较7.x而言做了比较大的改动（比如彻底删除_type）</li>
<li>默认开启安全配置</li>
<li>存储空间优化：对倒排文件使用新的编码集，对于keyword、match_only_text、text类型字段有效，有3.5%的空间优化提升，对于新建索引和segment自动生效。</li>
<li>优化geo_point，geo_shape类型的索引（写入）效率：15%的提升。</li>
<li>技术预览版KNN API发布，（K邻近算法），跟推荐系统、自然语言排名相关。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elastic-stack/current/elasticsearch-breaking-changes.html">https://www.elastic.co/guide/en/elastic-stack/current/elasticsearch-breaking-changes.html</a></li>
</ul>
<h3 id="ElasticSearch-vs-Solr"><a href="#ElasticSearch-vs-Solr" class="headerlink" title="ElasticSearch vs Solr"></a><strong>ElasticSearch vs Solr</strong></h3><p>Solr 是第一个基于 Lucene 核心库功能完备的搜索引擎产品，诞生远早于 Elasticsearch。</p>
<p>当单纯的对已有数据进行搜索时，Solr更快。当实时建立索引时, Solr会产生io阻塞，查询性能较差, Elasticsearch具有明显的优势。</p>
<p>​    <img src="/elasticsearch/50800" srcset="/img/loading.gif" lazyload alt="0"></p>
<p>​    <img src="/elasticsearch/46439" srcset="/img/loading.gif" lazyload alt="0"></p>
<p>大型互联网公司，实际生产环境测试，将搜索引擎从Solr转到 Elasticsearch以后的平均查询速度有了50倍的提升。</p>
<p>​    <img src="/elasticsearch/46437" srcset="/img/loading.gif" lazyload alt="0"></p>
<p><strong>总结：</strong></p>
<ul>
<li>Solr 利用 Zookeeper 进行分布式管理，而Elasticsearch 自身带有分布式协调管理功能。 </li>
<li>Solr 支持更多格式的数据，比如JSON、XML、CSV，而 Elasticsearch 仅支持json文件格式。 </li>
<li>Solr 在传统的搜索应用中表现好于 Elasticsearch，但在处理实时搜索应用时效率明显低于 Elasticsearch。 </li>
<li>Solr 是传统搜索应用的有力解决方案，但 Elasticsearch更适用于新兴的实时搜索应用。</li>
</ul>
<h2 id="Elastic-Stack介绍"><a href="#Elastic-Stack介绍" class="headerlink" title="Elastic Stack介绍"></a><strong>Elastic Stack介绍</strong></h2><p>   在Elastic Stack之前我们听说过ELK，ELK分别是Elasticsearch，Logstash，Kibana这三款软件在一起的简称，在发展的过程中又有新的成员Beats的加入，就形成了Elastic Stack。</p>
<p>​    <img src="/elasticsearch/46325" srcset="/img/loading.gif" lazyload alt="0"></p>
<p> 　　　　　　　              Elastic Stack生态圈</p>
<p>在Elastic Stack生态圈中Elasticsearch作为数据存储和搜索，是生态圈的基石，Kibana在上层提供用户一个可视化及操作的界面，Logstash和Beat可以对数据进行收集。在上图的右侧X-Pack部分则是Elastic公司提供的商业项目。</p>
<p>指标分析&#x2F;日志分析：</p>
<p>​    <img src="/elasticsearch/46442" srcset="/img/loading.gif" lazyload alt="0"></p>
<h2 id="ElasticSearch应用场景"><a href="#ElasticSearch应用场景" class="headerlink" title="ElasticSearch应用场景"></a><strong>ElasticSearch应用场景</strong></h2><ul>
<li>站内搜索</li>
<li>日志管理与分析</li>
<li>大数据分析</li>
<li>应用性能监控</li>
<li>机器学习</li>
</ul>
<p>国内现在有大量的公司都在使用 Elasticsearch，包括携程、滴滴、今日头条、饿了么、360安全、小米、vivo等诸多知名公司。除了搜索之外，结合Kibana、Logstash、Beats，Elastic Stack还被广泛运用在大数据近实时分析领域，包括日志分析、指标监控、信息安全等多个领域。它可以帮助你探索海量结构化、非结构化数据，按需创建可视化报表，对监控数据设置报警阈值，甚至通过使用机器学习技术，自动识别异常状况。</p>
<p><strong>通用数据处理流程：</strong></p>
<p>​    <img src="/elasticsearch/46527" srcset="/img/loading.gif" lazyload alt="0"></p>
<h1 id="ElasticSearch快速开始"><a href="#ElasticSearch快速开始" class="headerlink" title="ElasticSearch快速开始"></a><strong>ElasticSearch快速开始</strong></h1><h2 id="ElasticSearch安装运行"><a href="#ElasticSearch安装运行" class="headerlink" title="ElasticSearch安装运行"></a><strong>ElasticSearch安装运行</strong></h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a><strong>环境准备</strong></h3><ul>
<li><p>运行Elasticsearch，需安装并配置JDK</p>
</li>
<li><ul>
<li>设置$JAVA_HOME</li>
</ul>
</li>
<li><p>各个版本对Java的依赖 <a target="_blank" rel="noopener" href="https://www.elastic.co/support/matrix#matrix_jvm">https://www.elastic.co/support/matrix#matrix_jvm</a></p>
</li>
<li><ul>
<li>Elasticsearch 5需要Java 8以上的版本	</li>
<li>Elasticsearch 从6.5开始支持Java 11</li>
<li>7.0开始，内置了Java环境</li>
</ul>
</li>
<li><p>ES比较耗内存，建议虚拟机4G或以上内存，jvm1g以上的内存分配</p>
</li>
</ul>
<p>可以参考es的环境文件elasticsearch-env.bat</p>
<p>​    <img src="/elasticsearch/46255" srcset="/img/loading.gif" lazyload alt="0"></p>
<p>ES的jdk环境生效的优先级配置ES_JAVA_HOME&gt;JAVA_HOME&gt;ES_HOME</p>
<h3 id="下载并解压ElasticSearch"><a href="#下载并解压ElasticSearch" class="headerlink" title="下载并解压ElasticSearch"></a><strong>下载并解压ElasticSearch</strong></h3><p>下载地址： <a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch">https://www.elastic.co/cn/downloads/past-releases#elasticsearch</a></p>
<p>选择版本：7.17.3</p>
<p>​    <img src="/elasticsearch/46614" srcset="/img/loading.gif" lazyload alt="0"></p>
<p><strong>ElasticSearch文件目录结构</strong></p>
<table>
<thead>
<tr>
<th>目录</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>bin</td>
<td>脚本文件，包括启动elasticsearch，安装插件，运行统计数据等</td>
</tr>
<tr>
<td>config</td>
<td>配置文件目录，如elasticsearch配置、角色配置、jvm配置等。</td>
</tr>
<tr>
<td>jdk</td>
<td>java运行环境</td>
</tr>
<tr>
<td>data</td>
<td>默认的数据存放目录，包含节点、分片、索引、文档的所有数据，生产环境需要修改。</td>
</tr>
<tr>
<td>lib</td>
<td>elasticsearch依赖的Java类库</td>
</tr>
<tr>
<td>logs</td>
<td>默认的日志文件存储路径，生产环境需要修改。</td>
</tr>
<tr>
<td>modules</td>
<td>包含所有的Elasticsearch模块，如Cluster、Discovery、Indices等。</td>
</tr>
<tr>
<td>plugins</td>
<td>已安装插件目录</td>
</tr>
</tbody></table>
<p><strong>主配置文件elasticsearch.yml</strong></p>
<ul>
<li>cluster.name</li>
</ul>
<p>当前节点所属集群名称，多个节点如果要组成同一个集群，那么集群名称一定要配置成相同。默认值elasticsearch，生产环境建议根据ES集群的使用目的修改成合适的名字。</p>
<ul>
<li>node.name</li>
</ul>
<p>当前节点名称，默认值当前节点部署所在机器的主机名，所以如果一台机器上要起多个ES节点的话，需要通过配置该属性明确指定不同的节点名称。</p>
<ul>
<li>path.data</li>
</ul>
<p>配置数据存储目录，比如索引数据等，默认值 $ES_HOME&#x2F;data，生产环境下强烈建议部署到另外的安全目录，防止ES升级导致数据被误删除。</p>
<ul>
<li>path.logs</li>
</ul>
<p>配置日志存储目录，比如运行日志和集群健康信息等，默认值 $ES_HOME&#x2F;logs，生产环境下强烈建议部署到另外的安全目录，防止ES升级导致数据被误删除。</p>
<ul>
<li>bootstrap.memory_lock</li>
</ul>
<p>配置ES启动时是否进行内存锁定检查，默认值true。</p>
<p>ES对于内存的需求比较大，一般生产环境建议配置大内存，如果内存不足，容易导致内存交换到磁盘，严重影响ES的性能。所以默认启动时进行相应大小内存的锁定，如果无法锁定则会启动失败。</p>
<p>非生产环境可能机器内存本身就很小，能够供给ES使用的就更小，如果该参数配置为true的话很可能导致无法锁定内存以致ES无法成功启动，此时可以修改为false。</p>
<ul>
<li>network.host</li>
</ul>
<p>配置能够访问当前节点的主机，默认值为当前节点所在机器的本机回环地址127.0.0.1 和[::1]，这就导致默认情况下只能通过当前节点所在主机访问当前节点。可以配置为 0.0.0.0 ，表示所有主机均可访问。</p>
<ul>
<li>http.port</li>
</ul>
<p>配置当前ES节点对外提供服务的http端口，默认值 9200</p>
<ul>
<li>discovery.seed_hosts</li>
</ul>
<p>配置参与集群节点发现过程的主机列表，说白一点就是集群中所有节点所在的主机列表，可以是具体的IP地址，也可以是可解析的域名。</p>
<ul>
<li>cluster.initial_master_nodes</li>
</ul>
<p>配置ES集群初始化时参与master选举的节点名称列表，必须与node.name配置的一致。ES集群首次构建完成后，应该将集群中所有节点的配置文件中的cluster.initial_master_nodes配置项移除，重启集群或者将新节点加入某个已存在的集群时切记不要设置该配置项。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment">#ES开启远程访问  </span><br><span class="hljs-attribute">network</span>.host: <span class="hljs-number">0.0.0.0</span><br></code></pre></td></tr></table></figure>

<h3 id="修改JVM配置"><a href="#修改JVM配置" class="headerlink" title="修改JVM配置"></a><strong>修改JVM配置</strong></h3><p>修改config&#x2F;jvm.options配置文件，调整jvm堆内存大小</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs diff">vim jvm.options<br><span class="hljs-deletion">-Xms4g</span><br><span class="hljs-deletion">-Xmx4g</span><br></code></pre></td></tr></table></figure>

<p>配置的建议</p>
<ul>
<li>Xms和Xms设置成—样</li>
<li>Xmx不要超过机器内存的50%</li>
<li>不要超过30GB - <a target="_blank" rel="noopener" href="https://www.elastic.co/cn/blog/a-heap-of-trouble">https://www.elastic.co/cn/blog/a-heap-of-trouble</a></li>
</ul>
<h3 id="启动ElasticSearch服务"><a href="#启动ElasticSearch服务" class="headerlink" title="启动ElasticSearch服务"></a><strong>启动ElasticSearch服务</strong></h3><p><strong>Windows</strong></p>
<p><strong>直接运行elasticsearch.bat</strong></p>
<p><strong>Linux（centos7）</strong></p>
<p>ES不允许使用root账号启动服务，如果你当前账号是root，则需要创建一个专有账户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#非root用户</span><br>bin/elasticsearch <br><br><span class="hljs-comment"># -d 后台启动</span><br>bin/elasticsearch -d<br></code></pre></td></tr></table></figure>

<p>​    <img src="/elasticsearch/49275" srcset="/img/loading.gif" lazyload alt="0"></p>
<p>注意：es默认不能用root用户启动，生产环境建议为elasticsearch创建用户。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">#为elaticsearch创建用户并赋予相应权限<br>adduser <span class="hljs-built_in">es</span><br>passwd <span class="hljs-built_in">es</span><br>chown -R <span class="hljs-built_in">es</span>:<span class="hljs-built_in">es</span> elasticsearch-<span class="hljs-number">17.3</span><br></code></pre></td></tr></table></figure>

<p>​      </p>
<p>运行<a target="_blank" rel="noopener" href="http://localhost:9200/">http://localhost:9200/</a></p>
<p>​    <img src="/elasticsearch/46552" srcset="/img/loading.gif" lazyload alt="0"></p>
<p>如果ES服务启动异常，会有提示：</p>
<p>​    <img src="/elasticsearch/48965" srcset="/img/loading.gif" lazyload alt="0"></p>
<p><strong>启动ES服务常见错误解决方案</strong></p>
<p>[1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65536]</p>
<p>ES因为需要大量的创建索引文件，需要大量的打开系统的文件，所以我们需要解除linux系统当中打开文件最大数目的限制，不然ES启动就会抛错</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section">#切换到root用户</span><br>vim /etc/security/limits.conf<br><br>末尾添加如下配置：<br><span class="hljs-bullet">  *</span>	    soft 	nofile 	65536<br><span class="hljs-bullet">  *</span>     hard 	nofile 	65536<br><span class="hljs-bullet">  *</span>     soft 	nproc 	4096<br><span class="hljs-bullet">  *</span>	    hard 	nproc 	4096<br></code></pre></td></tr></table></figure>

<p>​    </p>
<p>[2]: max number of threads [1024] for user [es] is too low, increase to at least [4096]</p>
<p>无法创建本地线程问题,用户最大可创建线程数太小</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">vim <span class="hljs-regexp">/etc/</span>security<span class="hljs-regexp">/limits.d/</span><span class="hljs-number">20</span>-nproc.conf<br><br>改为如下配置：<br>* soft nproc <span class="hljs-number">4096</span><br></code></pre></td></tr></table></figure>

<p>[3]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</p>
<p>最大虚拟内存太小,调大系统的虚拟内存</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">vim</span> /etc/sysctl.<span class="hljs-keyword">conf</span><br>追加以下内容：<br><span class="hljs-keyword">vm</span>.max_map_count=<span class="hljs-number">262144</span><br>保存退出之后执行如下命令：<br>sysctl -<span class="hljs-keyword">p</span><br></code></pre></td></tr></table></figure>

<p>​      </p>
<p>[4]: the default discovery settings are unsuitable for production use; at least one of [discovery.seed_hosts, discovery.seed_providers, cluster.initial_master_nodes] must be configured</p>
<p>缺少默认配置，至少需要配置discovery.seed_hosts&#x2F;discovery.seed_providers&#x2F;cluster.initial_master_nodes中的一个参数.</p>
<ul>
<li>discovery.seed_hosts:  集群主机列表</li>
<li>discovery.seed_providers: 基于配置文件配置集群主机列表</li>
<li>cluster.initial_master_nodes: 启动时初始化的参与选主的node，生产环境必填</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">vim config/elasticsearch<span class="hljs-selector-class">.yml</span><br>#添加配置<br>discovery<span class="hljs-selector-class">.seed_hosts</span>: <span class="hljs-selector-attr">[<span class="hljs-string">&quot;127.0.0.1&quot;</span>]</span><br>cluster<span class="hljs-selector-class">.initial_master_nodes</span>: <span class="hljs-selector-attr">[<span class="hljs-string">&quot;node-1&quot;</span>]</span><br><br>#或者  单节点（集群单节点）<br>discovery<span class="hljs-selector-class">.type</span>: single-node<br></code></pre></td></tr></table></figure>

<h3 id="客户端Kibana安装"><a href="#客户端Kibana安装" class="headerlink" title="客户端Kibana安装"></a><strong>客户端Kibana安装</strong></h3><p>Kibana是一个开源分析和可视化平台，旨在与Elasticsearch协同工作。</p>
<p><strong>1）下载并解压缩Kibana</strong></p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases#kibana">https://www.elastic.co/cn/downloads/past-releases#kibana</a></p>
<p>选择版本：7.17.3</p>
<p>​    <img src="/elasticsearch/46611" srcset="/img/loading.gif" lazyload alt="0"></p>
<p><strong>2）修改Kibana.yml</strong></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">vim config/kibana.yml<br><br><span class="hljs-symbol">server.port:</span> <span class="hljs-number">5601</span><br><span class="hljs-symbol">server.host:</span> <span class="hljs-string">&quot;localhost&quot;</span>  <span class="hljs-meta">#服务器ip</span><br><span class="hljs-symbol">elasticsearch.hosts:</span> [<span class="hljs-string">&quot;http://localhost:9200&quot;</span>]  <span class="hljs-meta">#elasticsearch的访问地址</span><br><span class="hljs-symbol">i18n.locale:</span> <span class="hljs-string">&quot;zh-CN&quot;</span>   <span class="hljs-meta">#Kibana汉化</span><br></code></pre></td></tr></table></figure>

<p><strong>3）运行Kibana</strong></p>
<p>注意：kibana也需要非root用户启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">bin/kibana<br><span class="hljs-comment">#后台启动</span><br><span class="hljs-built_in">nohup</span>  bin/kibana &amp;<br><br><span class="hljs-comment">#查询kibana进程</span><br>netstat -tunlp | grep 5601<br></code></pre></td></tr></table></figure>

<p>​       </p>
<p><strong>访问Kibana:</strong> <a target="_blank" rel="noopener" href="http://localhost:5601/"><strong>http://localhost:5601/</strong></a></p>
<p>​    <img src="/elasticsearch/46817" srcset="/img/loading.gif" lazyload alt="0"></p>
<p><strong>cat API</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/_cat/</span>allocation         <span class="hljs-comment">#查看单节点的shard分配整体情况</span><br><span class="hljs-regexp">/_cat/</span>shards          <span class="hljs-comment">#查看各shard的详细情况</span><br><span class="hljs-regexp">/_cat/</span>shards/&#123;index&#125;     <span class="hljs-comment">#查看指定分片的详细情况</span><br><span class="hljs-regexp">/_cat/m</span>aster          <span class="hljs-comment">#查看master节点信息</span><br><span class="hljs-regexp">/_cat/</span>nodes           <span class="hljs-comment">#查看所有节点信息</span><br><span class="hljs-regexp">/_cat/i</span>ndices         <span class="hljs-comment">#查看集群中所有index的详细信息</span><br><span class="hljs-regexp">/_cat/i</span>ndices/&#123;index&#125;      <span class="hljs-comment">#查看集群中指定index的详细信息</span><br><span class="hljs-regexp">/_cat/</span>segments        <span class="hljs-comment">#查看各index的segment详细信息,包括segment名, 所属shard, 内存(磁盘)占用大小, 是否刷盘</span><br><span class="hljs-regexp">/_cat/</span>segments/&#123;index&#125;<span class="hljs-comment">#查看指定index的segment详细信息</span><br><span class="hljs-regexp">/_cat/</span>count           <span class="hljs-comment">#查看当前集群的doc数量</span><br><span class="hljs-regexp">/_cat/</span>count/&#123;index&#125;   <span class="hljs-comment">#查看指定索引的doc数量</span><br><span class="hljs-regexp">/_cat/</span>recovery        <span class="hljs-comment">#查看集群内每个shard的recovery过程.调整replica。</span><br><span class="hljs-regexp">/_cat/</span>recovery/&#123;index&#125;<span class="hljs-comment">#查看指定索引shard的recovery过程</span><br><span class="hljs-regexp">/_cat/</span>health          <span class="hljs-comment">#查看集群当前状态：红、黄、绿</span><br><span class="hljs-regexp">/_cat/</span>pending_tasks   <span class="hljs-comment">#查看当前集群的pending task</span><br><span class="hljs-regexp">/_cat/</span>aliases         <span class="hljs-comment">#查看集群中所有alias信息,路由配置等</span><br><span class="hljs-regexp">/_cat/</span>aliases/&#123;alias&#125; <span class="hljs-comment">#查看指定索引的alias信息</span><br><span class="hljs-regexp">/_cat/</span>thread_pool     <span class="hljs-comment">#查看集群各节点内部不同类型的threadpool的统计信息,</span><br><span class="hljs-regexp">/_cat/</span>plugins         <span class="hljs-comment">#查看集群各个节点上的plugin信息</span><br><span class="hljs-regexp">/_cat/</span>fielddata       <span class="hljs-comment">#查看当前集群各个节点的fielddata内存使用情况</span><br><span class="hljs-regexp">/_cat/</span>fielddata/&#123;fields&#125;     <span class="hljs-comment">#查看指定field的内存使用情况,里面传field属性对应的值</span><br><span class="hljs-regexp">/_cat/</span>nodeattrs              <span class="hljs-comment">#查看单节点的自定义属性</span><br><span class="hljs-regexp">/_cat/</span>repositories           <span class="hljs-comment">#输出集群中注册快照存储库</span><br><span class="hljs-regexp">/_cat/</span>templates              <span class="hljs-comment">#输出当前正在存在的模板信息</span><br></code></pre></td></tr></table></figure>

<h3 id="Elasticsearch安装分词插件"><a href="#Elasticsearch安装分词插件" class="headerlink" title="Elasticsearch安装分词插件"></a><strong>Elasticsearch安装分词插件</strong></h3><p>Elasticsearch提供插件机制对系统进行扩展</p>
<p>以安装analysis-icu这个分词插件为例</p>
<p><strong>在线安装</strong></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment">#查看已安装插件</span><br><span class="hljs-keyword">bin/elasticsearch-plugin </span>list<br><span class="hljs-comment">#安装插件</span><br><span class="hljs-keyword">bin/elasticsearch-plugin </span><span class="hljs-keyword">install </span>analysis-icu<br><span class="hljs-comment">#删除插件</span><br><span class="hljs-keyword">bin/elasticsearch-plugin </span>remove analysis-icu<br></code></pre></td></tr></table></figure>

<p>注意：安装和删除完插件后，需要重启ES服务才能生效。</p>
<p>测试分词效果</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs fsharp">POST <span class="hljs-keyword">_analyze</span><br>&#123;<br>    <span class="hljs-string">&quot;analyzer&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;icu_analyzer&quot;</span>,<br>    <span class="hljs-string">&quot;text&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;中华人民共和国&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>​      </p>
<p>​    <img src="/elasticsearch/46920" srcset="/img/loading.gif" lazyload alt="0"></p>
<p><strong>离线安装</strong></p>
<p>本地下载相应的插件，解压，然后手动上传到elasticsearch的plugins目录，然后重启ES实例就可以了。</p>
<p>比如ik中文分词插件：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p>
<p>测试分词效果</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-meta">#ES的默认分词设置是standard，会单字拆分</span><br>POST <span class="hljs-title class_">_analyze</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-string">&quot;analyzer&quot;</span>:<span class="hljs-string">&quot;standard&quot;</span>,<br>    <span class="hljs-string">&quot;text&quot;</span>:<span class="hljs-string">&quot;中华人民共和国&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-meta">#ik_smart:会做最粗粒度的拆</span><br>POST <span class="hljs-title class_">_analyze</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_smart&quot;</span>,<br>    <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;中华人民共和国&quot;</span><br> <span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-meta">#ik_max_word:会将文本做最细粒度的拆分</span><br>POST <span class="hljs-title class_">_analyze</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-string">&quot;analyzer&quot;</span>:<span class="hljs-string">&quot;ik_max_word&quot;</span>,<br>    <span class="hljs-string">&quot;text&quot;</span>:<span class="hljs-string">&quot;中华人民共和国&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure>

<p>​    </p>
<p>创建索引时可以指定IK分词器作为默认分词器</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ada">PUT /es_db<br>&#123;<br>    <span class="hljs-string">&quot;settings&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;index&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;analysis.analyzer.default.type&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​     </p>
<p>​    <img src="/elasticsearch/49281" srcset="/img/loading.gif" lazyload alt="0"></p>
<h2 id="ElasticSearch基本概念"><a href="#ElasticSearch基本概念" class="headerlink" title="ElasticSearch基本概念"></a><strong>ElasticSearch基本概念</strong></h2><h3 id="关系型数据库-VS-ElasticSearch"><a href="#关系型数据库-VS-ElasticSearch" class="headerlink" title="关系型数据库 VS ElasticSearch"></a><strong>关系型数据库 VS ElasticSearch</strong></h3><ul>
<li><p>在7.0之前，一个 Index可以设置多个Types</p>
</li>
<li><p>目前Type已经被Deprecated，7.0开始，一个索引只能创建一个Type - “_doc”</p>
</li>
<li><p>传统关系型数据库和Elasticsearch的区别:</p>
</li>
<li><ul>
<li>Elasticsearch- Schemaless &#x2F;相关性&#x2F;高性能全文检索</li>
<li>RDMS —事务性&#x2F; Join</li>
</ul>
</li>
</ul>
<p>	</p>
<p>​    <img src="/elasticsearch/46708" srcset="/img/loading.gif" lazyload alt="0"></p>
<h3 id="索引（Index）"><a href="#索引（Index）" class="headerlink" title="索引（Index）"></a><strong>索引（Index）</strong></h3><p>一个索引就是一个拥有几分相似特征的文档的集合。比如说，可以有一个客户数据的索引，另一个产品目录的索引，还有一个订单数据的索引。</p>
<p>一个索引由一个名字来标识（必须全部是小写字母的），并且当我们要对对应于这个索引中的文档进行索引、搜索、更新和删除的时候，都要使用到这个名字。</p>
<p>​    <img src="/elasticsearch/46764" srcset="/img/loading.gif" lazyload alt="0"></p>
<h3 id="文档（Document）"><a href="#文档（Document）" class="headerlink" title="文档（Document）"></a><strong>文档（Document）</strong></h3><ul>
<li><p>Elasticsearch是面向文档的，文档是所有可搜索数据的最小单位。</p>
</li>
<li><ul>
<li>日志文件中的日志项</li>
<li>一本电影的具体信息&#x2F;一张唱片的详细信息</li>
<li>MP3播放器里的一首歌&#x2F;一篇PDF文档中的具体内容</li>
</ul>
</li>
<li><p>文档会被序列化成JSON格式，保存在Elasticsearch中</p>
</li>
<li><ul>
<li>JSON对象由字段组成</li>
<li>每个字段都有对应的字段类型(字符串&#x2F;数值&#x2F;布尔&#x2F;日期&#x2F;二进制&#x2F;范围类型)</li>
</ul>
</li>
<li><p>每个文档都有一个Unique ID</p>
</li>
<li><ul>
<li>可以自己指定ID或者通过Elasticsearch自动生成</li>
</ul>
</li>
<li><p>一篇文档包含了一系列字段，类似数据库表中的一条记录</p>
</li>
<li><p>JSON文档，格式灵活，不需要预先定义格式</p>
</li>
<li><ul>
<li>字段的类型可以指定或者通过Elasticsearch自动推算</li>
<li>支持数组&#x2F;支持嵌套</li>
</ul>
</li>
</ul>
<p><strong>文档元数据</strong></p>
<p>​    <img src="/elasticsearch/46726" srcset="/img/loading.gif" lazyload alt="0"></p>
<p>元数据，用于标注文档的相关信息：</p>
<ul>
<li>_index：文档所属的索引名</li>
<li>_type：文档所属的类型名</li>
<li>_id：文档唯—ld</li>
<li>_source: 文档的原始Json数据</li>
<li>_version:  文档的版本号，修改删除操作_version都会自增1</li>
<li>_seq_no:  和_version一样，一旦数据发生更改，数据也一直是累计的。Shard级别严格递增，保证后写入的Doc的_seq_no大于先写入的Doc的_seq_no。</li>
<li>_primary_term: _primary_term主要是用来恢复数据时处理当多个文档的_seq_no一样时的冲突，避免Primary Shard上的写入被覆盖。每当Primary Shard发生重新分配时，比如重启，Primary选举等，_primary_term会递增1。</li>
</ul>
<h2 id="ElasticSearch索引操作"><a href="#ElasticSearch索引操作" class="headerlink" title="ElasticSearch索引操作"></a><strong>ElasticSearch索引操作</strong></h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/index.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/index.html</a></p>
<h3 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a><strong>创建索引</strong></h3><p>索引命名必须小写，不能以下划线开头</p>
<p>格式: PUT &#x2F;索引名称</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#创建索引</span><br>PUT /es_db<br>&#123;<br>	<span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>		<span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>			<span class="hljs-string">&quot;字段名&quot;</span>:&#123;<br>				<span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>, <span class="hljs-regexp">//</span>字段类型<br>				<span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_smart&quot;</span> <span class="hljs-regexp">//</span>分词器选择<br>			&#125;,<br>			<span class="hljs-string">&quot;字段名2&quot;</span>:&#123;<br>				<span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>				<span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;false&quot;</span><br>			&#125;<br>			<span class="hljs-string">&quot;字段名3&quot;</span>:&#123;<br>				<span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>					<span class="hljs-string">&quot;子字段&quot;</span>: &#123;<br>						<span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span><br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br><br>字段类型：text，keyword，日期类型，布尔类型，数值类型，数组类型，对象类型，范围类型<br><br><span class="hljs-comment">#创建索引时可以设置分片数和副本数</span><br>PUT /es_db<br>&#123;<br>    <span class="hljs-string">&quot;settings&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;number_of_shards&quot;</span> : <span class="hljs-number">3</span>,<br>        <span class="hljs-string">&quot;number_of_replicas&quot;</span> : <span class="hljs-number">2</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#修改索引配置</span><br>PUT <span class="hljs-regexp">/es_db/</span>_settings<br>&#123;<br>    <span class="hljs-string">&quot;index&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;number_of_replicas&quot;</span> : <span class="hljs-number">1</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​    <img src="/elasticsearch/46891" srcset="/img/loading.gif" lazyload alt="0"></p>
<h3 id="查询索引"><a href="#查询索引" class="headerlink" title="查询索引"></a><strong>查询索引</strong></h3><p>格式: GET &#x2F;索引名称</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查询索引</span><br>GET /es_db<br><br><span class="hljs-comment">#es_db是否存在</span><br>HEAD /es_db<br></code></pre></td></tr></table></figure>

<p>​     </p>
<p>​    <img src="/elasticsearch/46896" srcset="/img/loading.gif" lazyload alt="0"></p>
<p>​		</p>
<h3 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a><strong>删除索引</strong></h3><p>格式: DELETE &#x2F;索引名称</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">DELETE /es_db<br></code></pre></td></tr></table></figure>

<h3 id="修改索引"><a href="#修改索引" class="headerlink" title="修改索引"></a>修改索引</h3><p>索引库和mapping一旦创建无法修改，但是可以添加新的字段</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/索引库名/</span>_mapping<br>&#123;<br>	<span class="hljs-string">&quot;properties&quot;</span>:&#123;<br>		<span class="hljs-string">&quot;新字段名&quot;</span>:&#123;<br>			<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;integer&quot;</span><br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="ElasticSearch文档操作"><a href="#ElasticSearch文档操作" class="headerlink" title="ElasticSearch文档操作"></a><strong>ElasticSearch文档操作</strong></h2><p>示例数据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT /es_db<br>&#123;<br>    <span class="hljs-string">&quot;settings&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;index&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;analysis.analyzer.default.type&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br>PUT <span class="hljs-regexp">/es_db/</span>_doc/<span class="hljs-number">1</span><br>&#123;<br><span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三&quot;</span>,<br><span class="hljs-string">&quot;sex&quot;</span>: <span class="hljs-number">1</span>,<br><span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">25</span>,<br><span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;广州天河公园&quot;</span>,<br><span class="hljs-string">&quot;remark&quot;</span>: <span class="hljs-string">&quot;java developer&quot;</span><br>&#125;<br>PUT <span class="hljs-regexp">/es_db/</span>_doc/<span class="hljs-number">2</span><br>&#123;<br><span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;李四&quot;</span>,<br><span class="hljs-string">&quot;sex&quot;</span>: <span class="hljs-number">1</span>,<br><span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">28</span>,<br><span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;广州荔湾大厦&quot;</span>,<br><span class="hljs-string">&quot;remark&quot;</span>: <span class="hljs-string">&quot;java assistant&quot;</span><br>&#125;<br><br>PUT <span class="hljs-regexp">/es_db/</span>_doc/<span class="hljs-number">3</span><br>&#123;<br><span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;王五&quot;</span>,<br><span class="hljs-string">&quot;sex&quot;</span>: <span class="hljs-number">0</span>,<br><span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">26</span>,<br><span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;广州白云山公园&quot;</span>,<br><span class="hljs-string">&quot;remark&quot;</span>: <span class="hljs-string">&quot;php developer&quot;</span><br>&#125;<br><br>PUT <span class="hljs-regexp">/es_db/</span>_doc/<span class="hljs-number">4</span><br>&#123;<br><span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;赵六&quot;</span>,<br><span class="hljs-string">&quot;sex&quot;</span>: <span class="hljs-number">0</span>,<br><span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">22</span>,<br><span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;长沙橘子洲&quot;</span>,<br><span class="hljs-string">&quot;remark&quot;</span>: <span class="hljs-string">&quot;python assistant&quot;</span><br>&#125;<br><br>PUT <span class="hljs-regexp">/es_db/</span>_doc/<span class="hljs-number">5</span><br>&#123;<br><span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张龙&quot;</span>,<br><span class="hljs-string">&quot;sex&quot;</span>: <span class="hljs-number">0</span>,<br><span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">19</span>,<br><span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;长沙麓谷企业广场&quot;</span>,<br><span class="hljs-string">&quot;remark&quot;</span>: <span class="hljs-string">&quot;java architect assistant&quot;</span><br>&#125;	<br>	<br>PUT <span class="hljs-regexp">/es_db/</span>_doc/<span class="hljs-number">6</span><br>&#123;<br><span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;赵虎&quot;</span>,<br><span class="hljs-string">&quot;sex&quot;</span>: <span class="hljs-number">1</span>,<br><span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">32</span>,<br><span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;长沙麓谷兴工国际产业园&quot;</span>,<br><span class="hljs-string">&quot;remark&quot;</span>: <span class="hljs-string">&quot;java architect&quot;</span><br>&#125;	<br></code></pre></td></tr></table></figure>

<p>​           </p>
<h3 id="添加（索引）文档"><a href="#添加（索引）文档" class="headerlink" title="添加（索引）文档"></a><strong>添加（索引）文档</strong></h3><ul>
<li>格式: [PUT | POST] &#x2F;索引名称&#x2F;[_doc  | _create ]&#x2F;id</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 创建文档,指定id</span><br><span class="hljs-comment"># 如果id不存在，创建新的文档，否则先删除现有文档，再创建新的文档，版本会增加</span><br>PUT <span class="hljs-regexp">/es_db/</span>_doc/<span class="hljs-number">1</span><br>&#123;<br><span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三&quot;</span>,<br><span class="hljs-string">&quot;sex&quot;</span>: <span class="hljs-number">1</span>,<br><span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">25</span>,<br><span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;广州天河公园&quot;</span>,<br><span class="hljs-string">&quot;remark&quot;</span>: <span class="hljs-string">&quot;java developer&quot;</span><br>&#125;	<br><br><span class="hljs-comment">#创建文档，ES生成id</span><br>POST <span class="hljs-regexp">/es_db/</span>_doc<br>&#123;<br><span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三&quot;</span>,<br><span class="hljs-string">&quot;sex&quot;</span>: <span class="hljs-number">1</span>,<br><span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">25</span>,<br><span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;广州天河公园&quot;</span>,<br><span class="hljs-string">&quot;remark&quot;</span>: <span class="hljs-string">&quot;java developer&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>​        </p>
<p>​    <img src="/elasticsearch/46918" srcset="/img/loading.gif" lazyload alt="0"></p>
<p>注意:POST和PUT都能起到创建&#x2F;更新的作用，PUT需要对一个具体的资源进行操作也就是要确定id才能进行更新&#x2F;创建，而POST是可以针对整个资源集合进行操作的，如果不写id就由ES生成一个唯一id进行创建新文档，如果填了id那就针对这个id的文档进行创建&#x2F;更新</p>
<p>​    <img src="/elasticsearch/47001" srcset="/img/loading.gif" lazyload alt="0"></p>
<p>Create -如果ID已经存在，会失败</p>
<p>​    <img src="/elasticsearch/46977" srcset="/img/loading.gif" lazyload alt="0"></p>
<h3 id="修改文档"><a href="#修改文档" class="headerlink" title="修改文档"></a><strong>修改文档</strong></h3><ul>
<li>全量更新，整个json都会替换，格式: [PUT | POST] &#x2F;索引名称&#x2F;_doc&#x2F;id</li>
</ul>
<p>如果文档存在，现有文档会被删除，新的文档会被索引</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 全量更新，替换整个json</span><br>PUT <span class="hljs-regexp">/es_db/</span>_doc/<span class="hljs-number">1</span><br>&#123;<br><span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三&quot;</span>,<br><span class="hljs-string">&quot;sex&quot;</span>: <span class="hljs-number">1</span>,<br><span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">25</span><br>&#125;<br><br><span class="hljs-comment">#查询文档</span><br>GET <span class="hljs-regexp">/es_db/</span>_doc/<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>​        </p>
<p>​    <img src="/elasticsearch/46942" srcset="/img/loading.gif" lazyload alt="0"></p>
<ul>
<li>使用_update部分更新，格式: POST &#x2F;索引名称&#x2F;_update&#x2F;id</li>
</ul>
<p>update不会删除原来的文档，而是实现真正的数据更新</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 部分更新：在原有文档上更新</span><br><span class="hljs-comment"># Update -文档必须已经存在，更新只会对相应字段做增量修改</span><br>POST <span class="hljs-regexp">/es_db/</span>_update/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;doc&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">28</span><br>  &#125;<br>&#125;<br><br><span class="hljs-comment">#查询文档</span><br>GET <span class="hljs-regexp">/es_db/</span>_doc/<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>​     </p>
<p>​    <img src="/elasticsearch/46988" srcset="/img/loading.gif" lazyload alt="0"></p>
<ul>
<li>使用 _update_by_query 更新文档</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/es_db/</span>_update_by_query<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123; <br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-number">1</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;script&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;source&quot;</span>: <span class="hljs-string">&quot;ctx._source.age = 30&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​    <img src="/elasticsearch/47023" srcset="/img/loading.gif" lazyload alt="0"></p>
<h3 id="并发场景下修改文档"><a href="#并发场景下修改文档" class="headerlink" title="并发场景下修改文档"></a><strong>并发场景下修改文档</strong></h3><p>_seq_no和_primary_term是对_version的优化，7.X版本的ES默认使用这种方式控制版本，所以当在高并发环境下使用乐观锁机制修改文档时，要带上当前文档的_seq_no和_primary_term进行更新：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/es_db/</span>_doc/<span class="hljs-number">2</span>?if_seq_no=<span class="hljs-number">21</span>&amp;if_primary_term=<span class="hljs-number">6</span><br>&#123;<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;李四xxx&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果版本号不对，会抛出版本冲突异常，如下图：</p>
<p>​    <img src="/elasticsearch/50609" srcset="/img/loading.gif" lazyload alt="0"></p>
<h3 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a><strong>查询文档</strong></h3><ul>
<li>根据id查询文档，格式: GET &#x2F;索引名称&#x2F;_doc&#x2F;id</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/es_db/</span>_doc/<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>​        </p>
<ul>
<li>条件查询 _search，格式： &#x2F;索引名称&#x2F;_doc&#x2F;_search</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 查询前10条文档</span><br>GET <span class="hljs-regexp">/es_db/</span>_doc/_search<br></code></pre></td></tr></table></figure>

<p>ES Search API提供了两种条件查询搜索方式：</p>
<ul>
<li>REST风格的请求URI，直接将参数带过去</li>
<li>封装到request body中，这种方式可以定义更加易读的JSON格式</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#通过URI搜索，使用“q”指定查询字符串，“query string syntax” KV键值对</span><br><br><span class="hljs-comment">#条件查询, 如要查询age等于28岁的 _search?q=*:***</span><br><span class="hljs-built_in">GET</span> /es_db/_doc/_search?<span class="hljs-attribute">q</span>=age:28<br><br><span class="hljs-comment">#范围查询, 如要查询age在25至26岁之间的 _search?q=***[** TO **]  注意: TO 必须为大写</span><br><span class="hljs-built_in">GET</span> /es_db/_doc/_search?<span class="hljs-attribute">q</span>=age[25 <span class="hljs-keyword">TO</span> 26]<br><br><span class="hljs-comment">#查询年龄小于等于28岁的 :&lt;=</span><br><span class="hljs-built_in">GET</span> /es_db/_doc/_search?<span class="hljs-attribute">q</span>=age:&lt;=28<br><span class="hljs-comment">#查询年龄大于28前的 :&gt;</span><br><span class="hljs-built_in">GET</span> /es_db/_doc/_search?<span class="hljs-attribute">q</span>=age:&gt;28<br><br><span class="hljs-comment">#分页查询 from=*&amp;size=*</span><br><span class="hljs-built_in">GET</span> /es_db/_doc/_search?<span class="hljs-attribute">q</span>=age[25 <span class="hljs-keyword">TO</span> 26]&amp;<span class="hljs-attribute">from</span>=0&amp;size=1<br><br><span class="hljs-comment">#对查询结果只输出某些字段 _source=字段,字段</span><br><span class="hljs-built_in">GET</span> /es_db/_doc/_search?<span class="hljs-attribute">_source</span>=name,age<br><br><span class="hljs-comment">#对查询结果排序 sort=字段:desc/asc</span><br><span class="hljs-built_in">GET</span> /es_db/_doc/_search?<span class="hljs-attribute">sort</span>=age:desc<br></code></pre></td></tr></table></figure>

<p>​        </p>
<p>通过请求体的搜索方式会在第二节课中详细讲解（DSL）</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/es_db/</span>_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;广州白云&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a><strong>删除文档</strong></h3><p>格式: DELETE &#x2F;索引名称&#x2F;_doc&#x2F;id</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">DELETE</span> <span class="hljs-regexp">/es_db/</span>_doc/<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<h2 id="ElasticSearch文档批量操作"><a href="#ElasticSearch文档批量操作" class="headerlink" title="ElasticSearch文档批量操作"></a><strong>ElasticSearch文档批量操作</strong></h2><p>批量操作可以减少网络连接所产生的开销，提升性能</p>
<ul>
<li>支持在一次API调用中，对不同的索引进行操作</li>
<li>可以在URI中指定Index，也可以在请求的Payload中进行</li>
<li>操作中单条操作失败，并不会影响其他操作</li>
<li>返回结果包括了每一条操作执行的结果</li>
</ul>
<h3 id="批量写入"><a href="#批量写入" class="headerlink" title="批量写入"></a><strong>批量写入</strong></h3><p>批量对文档进行写操作是通过_bulk的API来实现的</p>
<ul>
<li><p>请求方式：POST</p>
</li>
<li><p>请求地址：_bulk</p>
</li>
<li><p>请求参数：通过_bulk操作文档，一般至少有两行参数(或偶数行参数)</p>
</li>
<li><ul>
<li>第一行参数为指定操作的类型及操作的对象(index,type和id)</li>
<li>第二行参数才是操作的数据</li>
</ul>
</li>
</ul>
<p>参数类似于：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;actionName&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;indexName&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;typeName&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;id&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;field1&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;value1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;field2&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;value2&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>actionName：表示操作类型，主要有create,index,delete和update</li>
</ul>
<p><strong>批量创建文档create</strong></p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST _bulk<br>&#123;&quot;<span class="hljs-keyword">create</span><span class="hljs-string">&quot;:&#123;&quot;</span>_index<span class="hljs-string">&quot;:&quot;</span>article<span class="hljs-string">&quot;, &quot;</span>_type<span class="hljs-string">&quot;:&quot;</span>_doc<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;:3&#125;&#125;</span><br><span class="hljs-string">&#123;&quot;</span>id<span class="hljs-string">&quot;:3,&quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot;:&quot;</span>fox老师<span class="hljs-string">&quot;,&quot;</span>content<span class="hljs-string">&quot;:&quot;</span>fox老师<span class="hljs-number">666</span><span class="hljs-string">&quot;,&quot;</span>tags<span class="hljs-string">&quot;:[&quot;</span>java<span class="hljs-string">&quot;, &quot;</span>面向对象<span class="hljs-string">&quot;],&quot;</span>create_time<span class="hljs-string">&quot;:1554015482530&#125;</span><br><span class="hljs-string">&#123;&quot;</span><span class="hljs-keyword">create</span><span class="hljs-string">&quot;:&#123;&quot;</span>_index<span class="hljs-string">&quot;:&quot;</span>article<span class="hljs-string">&quot;, &quot;</span>_type<span class="hljs-string">&quot;:&quot;</span>_doc<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;:4&#125;&#125;</span><br><span class="hljs-string">&#123;&quot;</span>id<span class="hljs-string">&quot;:4,&quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot;:&quot;</span>mark老师<span class="hljs-string">&quot;,&quot;</span>content<span class="hljs-string">&quot;:&quot;</span>mark老师NB<span class="hljs-string">&quot;,&quot;</span>tags<span class="hljs-string">&quot;:[&quot;</span>java<span class="hljs-string">&quot;, &quot;</span>面向对象<span class="hljs-string">&quot;],&quot;</span>create_time<span class="hljs-string">&quot;:1554015482530&#125;</span><br></code></pre></td></tr></table></figure>

<p>​         </p>
<p><strong>普通创建或全量替换index</strong></p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST _bulk<br>&#123;&quot;<span class="hljs-keyword">index</span><span class="hljs-string">&quot;:&#123;&quot;</span>_index<span class="hljs-string">&quot;:&quot;</span>article<span class="hljs-string">&quot;, &quot;</span>_type<span class="hljs-string">&quot;:&quot;</span>_doc<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;:3&#125;&#125;</span><br><span class="hljs-string">&#123;&quot;</span>id<span class="hljs-string">&quot;:3,&quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot;:&quot;</span>图灵徐庶老师<span class="hljs-string">&quot;,&quot;</span>content<span class="hljs-string">&quot;:&quot;</span>图灵学院徐庶老师<span class="hljs-number">666</span><span class="hljs-string">&quot;,&quot;</span>tags<span class="hljs-string">&quot;:[&quot;</span>java<span class="hljs-string">&quot;, &quot;</span>面向对象<span class="hljs-string">&quot;],&quot;</span>create_time<span class="hljs-string">&quot;:1554015482530&#125;</span><br><span class="hljs-string">&#123;&quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;:&#123;&quot;</span>_index<span class="hljs-string">&quot;:&quot;</span>article<span class="hljs-string">&quot;, &quot;</span>_type<span class="hljs-string">&quot;:&quot;</span>_doc<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;:4&#125;&#125;</span><br><span class="hljs-string">&#123;&quot;</span>id<span class="hljs-string">&quot;:4,&quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot;:&quot;</span>图灵诸葛老师<span class="hljs-string">&quot;,&quot;</span>content<span class="hljs-string">&quot;:&quot;</span>图灵学院诸葛老师NB<span class="hljs-string">&quot;,&quot;</span>tags<span class="hljs-string">&quot;:[&quot;</span>java<span class="hljs-string">&quot;, &quot;</span>面向对象<span class="hljs-string">&quot;],&quot;</span>create_time<span class="hljs-string">&quot;:1554015482530&#125;</span><br></code></pre></td></tr></table></figure>

<p>​          </p>
<ul>
<li>如果原文档不存在，则是创建</li>
<li>如果原文档存在，则是替换(全量修改原文档)</li>
</ul>
<p><strong>批量删除delete</strong></p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs fsharp">POST <span class="hljs-keyword">_bulk</span><br>&#123;<span class="hljs-string">&quot;delete&quot;</span><span class="hljs-operator">:</span>&#123;<span class="hljs-string">&quot;_index&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;article&quot;</span>, <span class="hljs-string">&quot;_type&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;_doc&quot;</span>, <span class="hljs-string">&quot;_id&quot;</span><span class="hljs-operator">:</span>3&#125;&#125;<br>&#123;<span class="hljs-string">&quot;delete&quot;</span><span class="hljs-operator">:</span>&#123;<span class="hljs-string">&quot;_index&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;article&quot;</span>, <span class="hljs-string">&quot;_type&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;_doc&quot;</span>, <span class="hljs-string">&quot;_id&quot;</span><span class="hljs-operator">:</span>4&#125;&#125;<br></code></pre></td></tr></table></figure>

<p><strong>批量修改update</strong></p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST _bulk<br>&#123;&quot;<span class="hljs-keyword">update</span><span class="hljs-string">&quot;:&#123;&quot;</span>_index<span class="hljs-string">&quot;:&quot;</span>article<span class="hljs-string">&quot;, &quot;</span>_type<span class="hljs-string">&quot;:&quot;</span>_doc<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;:3&#125;&#125;</span><br><span class="hljs-string">&#123;&quot;</span>doc<span class="hljs-string">&quot;:&#123;&quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot;:&quot;</span>ES大法必修内功<span class="hljs-string">&quot;&#125;&#125;</span><br><span class="hljs-string">&#123;&quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;:&#123;&quot;</span>_index<span class="hljs-string">&quot;:&quot;</span>article<span class="hljs-string">&quot;, &quot;</span>_type<span class="hljs-string">&quot;:&quot;</span>_doc<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;:4&#125;&#125;</span><br><span class="hljs-string">&#123;&quot;</span>doc<span class="hljs-string">&quot;:&#123;&quot;</span>create_time<span class="hljs-string">&quot;:1554018421008&#125;&#125;</span><br></code></pre></td></tr></table></figure>

<p><strong>组合应用</strong></p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST _bulk<br>&#123;&quot;<span class="hljs-keyword">create</span><span class="hljs-string">&quot;:&#123;&quot;</span>_index<span class="hljs-string">&quot;:&quot;</span>article<span class="hljs-string">&quot;, &quot;</span>_type<span class="hljs-string">&quot;:&quot;</span>_doc<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;:3&#125;&#125;</span><br><span class="hljs-string">&#123;&quot;</span>id<span class="hljs-string">&quot;:3,&quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot;:&quot;</span>fox老师<span class="hljs-string">&quot;,&quot;</span>content<span class="hljs-string">&quot;:&quot;</span>fox老师<span class="hljs-number">666</span><span class="hljs-string">&quot;,&quot;</span>tags<span class="hljs-string">&quot;:[&quot;</span>java<span class="hljs-string">&quot;, &quot;</span>面向对象<span class="hljs-string">&quot;],&quot;</span>create_time<span class="hljs-string">&quot;:1554015482530&#125;</span><br><span class="hljs-string">&#123;&quot;</span><span class="hljs-keyword">delete</span><span class="hljs-string">&quot;:&#123;&quot;</span>_index<span class="hljs-string">&quot;:&quot;</span>article<span class="hljs-string">&quot;, &quot;</span>_type<span class="hljs-string">&quot;:&quot;</span>_doc<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;:3&#125;&#125;</span><br><span class="hljs-string">&#123;&quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;:&#123;&quot;</span>_index<span class="hljs-string">&quot;:&quot;</span>article<span class="hljs-string">&quot;, &quot;</span>_type<span class="hljs-string">&quot;:&quot;</span>_doc<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;:4&#125;&#125;</span><br><span class="hljs-string">&#123;&quot;</span>doc<span class="hljs-string">&quot;:&#123;&quot;</span>create_time<span class="hljs-string">&quot;:1554018421008&#125;&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="批量读取"><a href="#批量读取" class="headerlink" title="批量读取"></a><strong>批量读取</strong></h3><p>es的批量查询可以使用mget和msearch两种。其中mget是需要我们知道它的id，可以指定不同的index，也可以指定返回值source。msearch可以通过字段查询来进行一个批量的查找。</p>
<p><strong>_mget</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#可以通过ID批量获取不同index和type的数据</span><br><span class="hljs-built_in">GET</span> _mget<br>&#123;<br><span class="hljs-string">&quot;docs&quot;</span>: [<br>&#123;<br><span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;es_db&quot;</span>,<br><span class="hljs-string">&quot;_id&quot;</span>: 1<br>&#125;,<br>&#123;<br><span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;article&quot;</span>,<br><span class="hljs-string">&quot;_id&quot;</span>: 4<br>&#125;<br>]<br>&#125;<br><br><span class="hljs-comment">#可以通过ID批量获取es_db的数据</span><br><span class="hljs-built_in">GET</span> /es_db/_mget<br>&#123;<br><span class="hljs-string">&quot;docs&quot;</span>: [<br>&#123;<br><span class="hljs-string">&quot;_id&quot;</span>: 1<br>&#125;,<br>&#123;<br><span class="hljs-string">&quot;_id&quot;</span>: 4<br>&#125;<br>]<br>&#125;<br><span class="hljs-comment">#简化后</span><br><span class="hljs-built_in">GET</span> /es_db/_mget <br>&#123;<br> <span class="hljs-string">&quot;ids&quot;</span>:[<span class="hljs-string">&quot;1&quot;</span>,<span class="hljs-string">&quot;2&quot;</span>]  <br> &#125;<br></code></pre></td></tr></table></figure>

<p>​      </p>
<p>​    <img src="/elasticsearch/47101" srcset="/img/loading.gif" lazyload alt="0"></p>
<p><strong>_msearch</strong></p>
<p>在_msearch中，请求格式和bulk类似。查询一条数据需要两个对象，第一个设置index和type，第二个设置查询语句。查询语句和search相同。如果只是查询一个index，我们可以在url中带上index，这样，如果查该index可以直接用空对象表示。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/es_db/</span>_msearch<br>&#123;&#125;<br>&#123;<span class="hljs-string">&quot;query&quot;</span> : &#123;<span class="hljs-string">&quot;match_all&quot;</span> : &#123;&#125;&#125;, <span class="hljs-string">&quot;from&quot;</span> : <span class="hljs-number">0</span>, <span class="hljs-string">&quot;size&quot;</span> : <span class="hljs-number">2</span>&#125;<br>&#123;<span class="hljs-string">&quot;index&quot;</span> : <span class="hljs-string">&quot;article&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;query&quot;</span> : &#123;<span class="hljs-string">&quot;match_all&quot;</span> : &#123;&#125;&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>​    <img src="/elasticsearch/47219" srcset="/img/loading.gif" lazyload alt="0"></p>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/" class="category-chain-item">系统架构</a>
  
  
    <span>></span>
    
  <a href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6/" class="category-chain-item">架构之分布式框架</a>
  
  
    <span>></span>
    
  <a href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6/elasticsearch/" class="category-chain-item">elasticsearch</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/elasticsearch/">#elasticsearch</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>elasticsearch</div>
      <div>https://kblayt.github.io/2024/03/10/系统架构/架构之分布式框架/ElasticSearch/elasticsearch/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Kblayt</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年3月10日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/03/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6/ElasticSearch/elasticSearch-%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%B3%95Query/" title="elasticSearch 高级查询语法Query">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">elasticSearch 高级查询语法Query</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/03/07/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E5%BE%AE%E6%9C%8D%E5%8A%A1/feign/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E7%BB%84%E4%BB%B6Feign/" title="微服务调用组件Feign">
                        <span class="hidden-mobile">微服务调用组件Feign</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
