<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>13、Hotspot源码初探-实战模拟JVM如何调用Java方法</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/13%E3%80%81Hotspot%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2-%E5%AE%9E%E6%88%98%E6%A8%A1%E6%8B%9FJVM%E5%A6%82%E4%BD%95%E8%B0%83%E7%94%A8Java%E6%96%B9%E6%B3%95/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/13%E3%80%81Hotspot%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2-%E5%AE%9E%E6%88%98%E6%A8%A1%E6%8B%9FJVM%E5%A6%82%E4%BD%95%E8%B0%83%E7%94%A8Java%E6%96%B9%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>12、Hotspot源码初探-用Java实现一个JVM框架</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/12%E3%80%81Hotspot%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2-%E7%94%A8Java%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAJVM%E6%A1%86%E6%9E%B6/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/12%E3%80%81Hotspot%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2-%E7%94%A8Java%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAJVM%E6%A1%86%E6%9E%B6/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>11、GraalVM.云原生时代的Java虚拟机</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/11%E3%80%81GraalVM-%E4%BA%91%E5%8E%9F%E7%94%9F%E6%97%B6%E4%BB%A3%E7%9A%84Java%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/11%E3%80%81GraalVM-%E4%BA%91%E5%8E%9F%E7%94%9F%E6%97%B6%E4%BB%A3%E7%9A%84Java%E8%99%9A%E6%8B%9F%E6%9C%BA/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>10、让Java性能提升的JIT深度剖析</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/10%E3%80%81%E8%AE%A9Java%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87%E7%9A%84JIT%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/10%E3%80%81%E8%AE%A9Java%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87%E7%9A%84JIT%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>9、为Java开疆拓土的ZGC深度剖析</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/9%E3%80%81%E4%B8%BAJava%E5%BC%80%E7%96%86%E6%8B%93%E5%9C%9F%E7%9A%84ZGC%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/9%E3%80%81%E4%B8%BAJava%E5%BC%80%E7%96%86%E6%8B%93%E5%9C%9F%E7%9A%84ZGC%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>8、JVM调优实战及常量池详解</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/8%E3%80%81JVM%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98%E5%8F%8A%E5%B8%B8%E9%87%8F%E6%B1%A0%E8%AF%A6%E8%A7%A3/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/8%E3%80%81JVM%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98%E5%8F%8A%E5%B8%B8%E9%87%8F%E6%B1%A0%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>7、JVM调优工具详解及调优实战</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/7%E3%80%81JVM%E8%B0%83%E4%BC%98%E5%B7%A5%E5%85%B7%E8%AF%A6%E8%A7%A3%E5%8F%8A%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/7%E3%80%81JVM%E8%B0%83%E4%BC%98%E5%B7%A5%E5%85%B7%E8%AF%A6%E8%A7%A3%E5%8F%8A%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>6、垃圾收集器G1&amp;ZGC详解</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/6%E3%80%81%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8G1-ZGC%E8%AF%A6%E8%A7%A3/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/6%E3%80%81%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8G1-ZGC%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>5、垃圾收集器ParNew&amp;CMS底层三色标记算法详解</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/5%E3%80%81%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8ParNew-CMS%E5%BA%95%E5%B1%82%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/5%E3%80%81%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8ParNew-CMS%E5%BA%95%E5%B1%82%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>4、深度剖析class文件结构</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/4%E3%80%81%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90class%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/4%E3%80%81%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90class%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>3、JVM对象创建与内存分配机制深度剖析</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/3%E3%80%81JVM%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E4%B8%8E%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/3%E3%80%81JVM%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E4%B8%8E%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>2、JVM内存模型深度剖析与优化</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/2%E3%80%81JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%E4%B8%8E%E4%BC%98%E5%8C%96/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/2%E3%80%81JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%E4%B8%8E%E4%BC%98%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>1、从JDK源码级别彻底剖析JVM类加载机制</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/1%E3%80%81%E4%BB%8EJDK%E6%BA%90%E7%A0%81%E7%BA%A7%E5%88%AB%E5%BD%BB%E5%BA%95%E5%89%96%E6%9E%90JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/1%E3%80%81%E4%BB%8EJDK%E6%BA%90%E7%A0%81%E7%BA%A7%E5%88%AB%E5%BD%BB%E5%BA%95%E5%89%96%E6%9E%90JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>4、Tomcat类加载机制及其热部署热加载原理剖析</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/Tomcat%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/4%E3%80%81Tomcat%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%E5%8F%8A%E5%85%B6%E7%83%AD%E9%83%A8%E7%BD%B2%E7%83%AD%E5%8A%A0%E8%BD%BD%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/Tomcat%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/4%E3%80%81Tomcat%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%E5%8F%8A%E5%85%B6%E7%83%AD%E9%83%A8%E7%BD%B2%E7%83%AD%E5%8A%A0%E8%BD%BD%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>Tomcat性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Tomcat性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>3、Tomcat线程模型分析及其性能调优</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/Tomcat%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/3%E3%80%81Tomcat%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E5%88%86%E6%9E%90%E5%8F%8A%E5%85%B6%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/Tomcat%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/3%E3%80%81Tomcat%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E5%88%86%E6%9E%90%E5%8F%8A%E5%85%B6%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>Tomcat性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Tomcat性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2、Tomcat整体架构及其设计精髓分析(下)</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/Tomcat%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/2%E3%80%81Tomcat%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%85%B6%E8%AE%BE%E8%AE%A1%E7%B2%BE%E9%AB%93%E5%88%86%E6%9E%90(%E4%B8%8B)/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/Tomcat%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/2%E3%80%81Tomcat%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%85%B6%E8%AE%BE%E8%AE%A1%E7%B2%BE%E9%AB%93%E5%88%86%E6%9E%90(%E4%B8%8B)/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>Tomcat性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Tomcat性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>15、Tomcat整体架构及其设计精髓分析(上)</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/Tomcat%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/1%E3%80%81Tomcat%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%85%B6%E8%AE%BE%E8%AE%A1%E7%B2%BE%E9%AB%93%E5%88%86%E6%9E%90(%E4%B8%8A)/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/Tomcat%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/1%E3%80%81Tomcat%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%85%B6%E8%AE%BE%E8%AE%A1%E7%B2%BE%E9%AB%93%E5%88%86%E6%9E%90(%E4%B8%8A)/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>Tomcat性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Tomcat性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>14、InnoDB引擎底层redo日志</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/14%E3%80%81InnoDB%E5%BC%95%E6%93%8E%E5%BA%95%E5%B1%82redo%E6%97%A5%E5%BF%97/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/14%E3%80%81InnoDB%E5%BC%95%E6%93%8E%E5%BA%95%E5%B1%82redo%E6%97%A5%E5%BF%97/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>MySQL性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>13、InnoDB的Buffer Pool详解</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/13%E3%80%81InnoDB%E7%9A%84Buffer-Pool%E8%AF%A6%E8%A7%A3/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/13%E3%80%81InnoDB%E7%9A%84Buffer-Pool%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>MySQL性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>12、MySQL查询优化规则详解InnoDB记录存储结构</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/12%E3%80%81MySQL%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E8%A7%84%E5%88%99%E8%AF%A6%E8%A7%A3InnoDB%E8%AE%B0%E5%BD%95%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/12%E3%80%81MySQL%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E8%A7%84%E5%88%99%E8%AF%A6%E8%A7%A3InnoDB%E8%AE%B0%E5%BD%95%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>MySQL性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>11、从架构师角度理解MySQL性能优化和索引合并</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/11%E3%80%81%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%B8%88%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%92%8C%E7%B4%A2%E5%BC%95%E5%90%88%E5%B9%B6/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/11%E3%80%81%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%B8%88%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%92%8C%E7%B4%A2%E5%BC%95%E5%90%88%E5%B9%B6/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>MySQL性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>10、连接查询成本分析和成本统计数据辨析</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/10%E3%80%81%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2%E6%88%90%E6%9C%AC%E5%88%86%E6%9E%90%E5%92%8C%E6%88%90%E6%9C%AC%E7%BB%9F%E8%AE%A1%E6%95%B0%E6%8D%AE%E8%BE%A8%E6%9E%90/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/10%E3%80%81%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2%E6%88%90%E6%9C%AC%E5%88%86%E6%9E%90%E5%92%8C%E6%88%90%E6%9C%AC%E7%BB%9F%E8%AE%A1%E6%95%B0%E6%8D%AE%E8%BE%A8%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>MySQL性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>9、三星索引和MySQL内核查询成本计算实战</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/9%E3%80%81%E4%B8%89%E6%98%9F%E7%B4%A2%E5%BC%95%E5%92%8CMySQL%E5%86%85%E6%A0%B8%E6%9F%A5%E8%AF%A2%E6%88%90%E6%9C%AC%E8%AE%A1%E7%AE%97%E5%AE%9E%E6%88%98/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/9%E3%80%81%E4%B8%89%E6%98%9F%E7%B4%A2%E5%BC%95%E5%92%8CMySQL%E5%86%85%E6%A0%B8%E6%9F%A5%E8%AF%A2%E6%88%90%E6%9C%AC%E8%AE%A1%E7%AE%97%E5%AE%9E%E6%88%98/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>MySQL性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>3、SQL底层执行原理详解</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/3%E3%80%81SQL%E5%BA%95%E5%B1%82%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/3%E3%80%81SQL%E5%BA%95%E5%B1%82%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>4、MySQL索引优化实战2</title>
    <link href="/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/5%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/"/>
    <url>/2023/06/16/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/5%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/</url>
    
    <content type="html"><![CDATA[<h1 id="分页查询优化"><a href="#分页查询优化" class="headerlink" title="分页查询优化"></a><strong>分页查询优化</strong></h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mysql">示例表：<br>CREATE TABLE `employees` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `name` varchar(24) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;姓名&#x27;,<br>  `age` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;年龄&#x27;,<br>  `position` varchar(20) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;职位&#x27;,<br>  `hire_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;入职时间&#x27;,<br>  PRIMARY KEY (`id`),<br>  KEY `idx_name_age_position` (`name`,`age`,`position`) USING BTREE<br>) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT=&#x27;员工记录表&#x27;;<br></code></pre></td></tr></table></figure><p>​          </p><p>很多时候我们业务系统实现分页功能可能会用如下sql实现</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; select * from employees limit 10000,10;         <br></code></pre></td></tr></table></figure><p>​     </p><p>表示从表 employees 中取出从 10001 行开始的 10 行记录。看似只查询了 10 条记录，实际这条 SQL 是先读取 10010 条记录，然后抛弃前 10000 条记录，然后读到后面 10 条想要的数据。因此要查询一张大表比较靠后的数据，执行效率是非常低的。</p><h1 id="gt-gt-常见的分页场景优化技巧："><a href="#gt-gt-常见的分页场景优化技巧：" class="headerlink" title="&gt;&gt;常见的分页场景优化技巧："></a><strong>&gt;&gt;常见的分页场景优化技巧：</strong></h1><h2 id="1、根据自增且连续的主键排序的分页查询"><a href="#1、根据自增且连续的主键排序的分页查询" class="headerlink" title="1、根据自增且连续的主键排序的分页查询"></a><strong>1、根据自增且连续的主键排序的分页查询</strong></h2><p>首先来看一个根据自增且连续主键排序的分页查询的例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; select * from employees limit 90000,5;    <br></code></pre></td></tr></table></figure><p>​          </p><p>​    <img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100109" alt="0"></p><p>该 SQL 表示查询从第 90001开始的五行数据，没添加单独 order by，表示通过<strong>主键排序</strong>。我们再看表 employees ，因为主键是自增并且连续的，所以可以改写成按照主键去查询从第 90001开始的五行数据，如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; select * from employees where id &gt; 90000 limit 5;         <br></code></pre></td></tr></table></figure><p>​     </p><p>​    <img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100108" alt="0"></p><p>查询的结果是一致的。我们再对比一下执行计划：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; EXPLAIN select * from employees limit 90000,5; <br></code></pre></td></tr></table></figure><p><img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100117" alt="0"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; EXPLAIN select * from employees where id &gt; 90000 limit 5;     <br></code></pre></td></tr></table></figure><p><img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100113" alt="0"></p><p>显然改写后的 SQL 走了索引，而且扫描的行数大大减少，执行效率更高。 </p><p>但是，这条改写的SQL 在很多场景并不实用，因为表中可能某些记录被删后，主键空缺，导致结果不一致，如下图试验所示（先删除一条前面的记录，然后再测试原 SQL 和优化后的 SQL）：</p><p>​    <img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100105" alt="0"></p><p>​    <img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100103" alt="0"></p><p>两条 SQL 的结果并不一样，因此，如果主键不连续，不能使用上面描述的优化方法。</p><p>另外如果原 SQL 是 order by 非主键的字段，按照上面说的方法改写会导致两条 SQL 的结果不一致。所以这种改写得满足以下两个条件：</p><ul><li>主键自增且连续</li><li>结果是按照主键排序的</li></ul><h2 id="2、根据非主键字段排序的分页查询"><a href="#2、根据非主键字段排序的分页查询" class="headerlink" title="2、根据非主键字段排序的分页查询"></a><strong>2、根据非主键字段排序的分页查询</strong></h2><p>再看一个根据非主键字段排序的分页查询，SQL 如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt;  select * from employees ORDER BY name limit 90000,5;<br></code></pre></td></tr></table></figure><p>​    <img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100110" alt="0"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; EXPLAIN select * from employees ORDER BY name limit 90000,5;<br></code></pre></td></tr></table></figure><p><img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100107" alt="0"></p><p>发现并没有使用 name 字段的索引（key 字段对应的值为 null），具体原因上节课讲过：<strong>扫描整个索引并查找到没索引的行(可能要遍历多个索引树)的成本比扫描全表的成本更高，所以优化器放弃使用索引</strong>。</p><p>知道不走索引的原因，那么怎么优化呢？</p><p>其实关键是<strong>让排序时返回的字段尽可能少</strong>，所以可以让排序和分页操作先查出主键，然后根据主键查到对应的记录，SQL改写如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; select * from employees e inner join (select id from employees order by name limit 90000,5) ed on e.id = ed.id;   <br></code></pre></td></tr></table></figure><p><img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100106" alt="0"></p><p>需要的结果与原 SQL 一致，执行时间减少了一半以上，我们再对比优化前后sql的执行计划：</p><p>​    <img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100104" alt="0"></p><p>原 SQL 使用的是 filesort 排序，而优化后的 SQL 使用的是索引排序。</p><h1 id="Join关联查询优化"><a href="#Join关联查询优化" class="headerlink" title="Join关联查询优化"></a><strong>Join关联查询优化</strong></h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs mysql">-- 示例表：<br>CREATE TABLE `t1` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `a` int(11) DEFAULT NULL,<br>  `b` int(11) DEFAULT NULL,<br>  PRIMARY KEY (`id`),<br>  KEY `idx_a` (`a`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br><br>create table t2 like t1;<br><br>-- 插入一些示例数据<br>-- 往t1表插入1万行记录<br>drop procedure if exists insert_t1; <br>delimiter ;;<br>create procedure insert_t1()        <br>begin<br>  declare i int;                    <br>  set i=1;                          <br>  while(i&lt;=10000)do                 <br>    insert into t1(a,b) values(i,i);  <br>    set i=i+1;                       <br>  end while;<br>end;;<br>delimiter ;<br>call insert_t1();<br><br>-- 往t2表插入100行记录<br>drop procedure if exists insert_t2; <br>delimiter ;;<br>create procedure insert_t2()        <br>begin<br>  declare i int;                    <br>  set i=1;                          <br>  while(i&lt;=100)do                 <br>    insert into t2(a,b) values(i,i);  <br>    set i=i+1;                       <br>  end while;<br>end;;<br>delimiter ;<br>call insert_t2();<br></code></pre></td></tr></table></figure><h1 id="mysql的表关联常见有两种算法"><a href="#mysql的表关联常见有两种算法" class="headerlink" title="mysql的表关联常见有两种算法"></a><strong>mysql的表关联常见有两种算法</strong></h1><ul><li><p>Nested-Loop Join 算法</p></li><li><p>Block Nested-Loop Join 算法</p></li></ul><h2 id="1、-嵌套循环连接-Nested-Loop-Join-NLJ-算法"><a href="#1、-嵌套循环连接-Nested-Loop-Join-NLJ-算法" class="headerlink" title="1、 嵌套循环连接 Nested-Loop Join(NLJ) 算法"></a><strong>1、</strong> <strong>嵌套循环连接</strong> <strong>Nested-Loop Join(NLJ) 算法</strong></h2><p>一次一行循环地从第一张表（称为<strong>驱动表</strong>）中读取行，在这行数据中取到关联字段，根据关联字段在另一张表（<strong>被驱动表</strong>）里取出满足条件的行，然后取出两张表的结果合集。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; EXPLAIN select * from t1 inner join t2 on t1.a= t2.a;          <br></code></pre></td></tr></table></figure><p>​    <img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100112" alt="0"></p><p>从执行计划中可以看到这些信息：</p><ul><li>驱动表是 t2，被驱动表是 t1。先执行的就是驱动表(执行计划结果的id如果一样则按从上到下顺序执行sql)；优化器一般会优先选择<strong>小表做驱动表，</strong>用where条件过滤完驱动表，然后再跟被驱动表做关联查询。<strong>所以使用 inner join 时，排在前面的表并不一定就是驱动表。</strong></li><li>当使用left join时，左表是驱动表，右表是被驱动表，当使用right join时，右表时驱动表，左表是被驱动表，当使用join时，mysql会选择数据量比较小的表作为驱动表，大表作为被驱动表。</li><li>使用了 NLJ算法。一般 join 语句中，如果执行计划 Extra 中未出现 <strong>Using join buffer</strong> 则表示使用的 join 算法是 NLJ。</li></ul><p><strong>上面sql的大致流程如下：</strong></p><ol><li>从表 t2 中读取一行数据（如果t2表有查询过滤条件的，用先用条件过滤完，再从过滤结果里取出一行数据）；</li><li>从第 1 步的数据中，取出关联字段 a，到表 t1 中查找；</li><li>取出表 t1 中满足条件的行，跟 t2 中获取到的结果合并，作为结果返回给客户端；</li><li>重复上面 3 步。</li></ol><p>整个过程会读取 t2 表的所有数据(<strong>扫描100行</strong>)，然后遍历这每行数据中字段 a 的值，根据 t2 表中 a 的值索引扫描 t1 表中的对应行(<strong>扫描100次 t1 表的索引，1次扫描可以认为最终只扫描 t1 表一行完整数据，也就是总共 t1 表也扫描了100行</strong>)。因此整个过程扫描了 <strong>200 行</strong>。</p><p>如果被驱动表的关联字段没索引，**使用NLJ算法性能会比较低(下面有详细解释)**，mysql会选择Block Nested-Loop Join算法。</p><h2 id="2、-基于块的嵌套循环连接-Block-Nested-Loop-Join-BNL-算法"><a href="#2、-基于块的嵌套循环连接-Block-Nested-Loop-Join-BNL-算法" class="headerlink" title="2、 基于块的嵌套循环连接 Block Nested-Loop Join(BNL)算法"></a><strong>2、</strong> <strong>基于块的嵌套循环连接</strong> <strong>Block Nested-Loop Join(BNL)算法</strong></h2><p>把<strong>驱动表</strong>的数据读入到 join_buffer 中，然后扫描<strong>被驱动表</strong>，把<strong>被驱动表</strong>每一行取出来跟 join_buffer 中的数据做对比。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt;EXPLAIN select * from t1 inner join t2 on t1.b= t2.b;<br></code></pre></td></tr></table></figure><p><img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100111" alt="0"></p><p>Extra 中 的Using join buffer (Block Nested Loop)说明该关联查询使用的是 BNL 算法。</p><p><strong>上面sql的大致流程如下：</strong></p><ol><li>把 t2 的所有数据放入到 <strong>join_buffer</strong> 中</li><li>把表 t1 中每一行取出来，跟 join_buffer 中的数据做对比</li><li>返回满足 join 条件的数据</li></ol><p>整个过程对表 t1 和 t2 都做了一次全表扫描，因此扫描的总行数为10000(表 t1 的数据总量) + 100(表 t2 的数据总量) &#x3D; <strong>10100</strong>。并且 join_buffer 里的数据是无序的，因此对表 t1 中的每一行，都要做 100 次判断，所以内存中的判断次数是 100 * 10000&#x3D; <strong>100 万次</strong>。</p><p>这个例子里表 t2 才 100 行，要是表 t2 是一个大表，join_buffer 放不下怎么办呢？·</p><p>join_buffer 的大小是由参数 join_buffer_size 设定的，默认值是 256k。如果放不下表 t2 的所有数据话，策略很简单，就是<strong>分段放</strong>。</p><p>比如 t2 表有1000行记录， join_buffer 一次只能放800行数据，那么执行过程就是先往 join_buffer 里放800行记录，然后从 t1 表里取数据跟 join_buffer 中数据对比得到部分结果，然后清空  join_buffer ，再放入 t2 表剩余200行记录，再次从 t1 表里取数据跟 join_buffer 中数据对比。所以就多扫了一次 t1 表。</p><p><strong>被驱动表的关联字段没索引为什么要选择使用 BNL 算法而不使用 Nested-Loop Join 呢？</strong></p><p>如果上面第二条sql使用 Nested-Loop Join，那么扫描行数为 100 * 10000 &#x3D; 100万次，这个是<strong>磁盘扫描</strong>。</p><p>很显然，用BNL磁盘扫描次数少很多，相比于磁盘扫描，BNL的内存计算会快得多。</p><p>因此MySQL对于被驱动表的关联字段没索引的关联查询，一般都会使用 BNL 算法。如果有索引一般选择 NLJ 算法，有索引的情况下 NLJ 算法比 BNL算法性能更高</p><h1 id="对于关联sql的优化"><a href="#对于关联sql的优化" class="headerlink" title="对于关联sql的优化"></a><strong>对于关联sql的优化</strong></h1><ul><li><strong>关联字段加索引</strong>，让mysql做join操作时尽量选择NLJ算法，驱动表因为需要全部查询出来，所以过滤的条件也尽量要走索引，避免全表扫描，总之，能走索引的过滤条件尽量都走索引</li><li><strong>小表驱动大表</strong>，写多表连接sql时如果<strong>明确知道</strong>哪张表是小表可以用straight_join写法固定连接驱动方式，省去mysql优化器自己判断的时间</li></ul><p><strong>straight_join解释：straight_join</strong>功能同join类似，但能让左边的表来驱动右边的表，能改表优化器对于联表查询的执行顺序。</p><p>比如：select * from t2 straight_join t1 on t2.a &#x3D; t1.a; 代表指定mysql选着 t2 表作为驱动表。</p><ul><li><strong>straight_join</strong>只适用于inner join，并不适用于left join，right join。（因为left join，right join已经代表指定了表的执行顺序）</li><li>尽可能让优化器去判断，因为大部分情况下mysql优化器是比人要聪明的。使用<strong>straight_join</strong>一定要慎重，因为部分情况下人为指定的执行顺序并不一定会比优化引擎要靠谱。</li></ul><h1 id="对于小表定义的明确"><a href="#对于小表定义的明确" class="headerlink" title="对于小表定义的明确"></a><strong>对于小表定义的明确</strong></h1><p>在决定哪个表做驱动表的时候，应该是两个表按照各自的条件过滤，<strong>过滤完成之后</strong>，计算参与 join 的各个字段的总数据量，<strong>数据量小的那个表，就是“小表”</strong>，应该作为驱动表。</p><h2 id="in和exsits优化"><a href="#in和exsits优化" class="headerlink" title="in和exsits优化"></a><strong>in和exsits优化</strong></h2><p>原则：<strong>小表驱动大表</strong>，即小的数据集驱动大的数据集</p><p><strong>in：</strong>当B表的数据集小于A表的数据集时，in优于exists </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select * from A where id in (select id from B)  <br>#等价于：<br>　　for(select id from B)&#123;<br>      select * from A where A.id = B.id<br>    &#125;<br></code></pre></td></tr></table></figure><p>​       </p><p><strong>exists：</strong>当A表的数据集小于B表的数据集时，exists优于in</p><p>　　将主查询A的数据，放到子查询B中做条件验证，根据验证结果（true或false）来决定主查询的数据是否保留</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select * from A where exists (select 1 from B where B.id = A.id)<br>#等价于:<br>    for(select * from A)&#123;<br>      select * from B where B.id = A.id<br>    &#125;<br>    <br>#A表与B表的ID字段应建立索引<br></code></pre></td></tr></table></figure><p>1、EXISTS (subquery)只返回TRUE或FALSE,因此子查询中的SELECT * 也可以用SELECT 1替换,官方说法是实际执行时会忽略SELECT清单,因此没有区别</p><p>2、EXISTS子查询的实际执行过程可能经过了优化而不是我们理解上的逐条对比</p><p>3、EXISTS子查询往往也可以用JOIN来代替，何种最优需要具体问题具体分析</p><h2 id="count-查询优化"><a href="#count-查询优化" class="headerlink" title="count(*)查询优化"></a><strong>count(*)查询优化</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">-- 临时关闭mysql查询缓存，为了查看sql多次执行的真实时间<br>mysql&gt; set global query_cache_size=0;<br>mysql&gt; set global query_cache_type=0;<br><br>mysql&gt; EXPLAIN select count(1) from employees;<br>mysql&gt; EXPLAIN select count(id) from employees;<br>mysql&gt; EXPLAIN select count(name) from employees;<br>mysql&gt; EXPLAIN select count(*) from employees;<br></code></pre></td></tr></table></figure><p><strong>注意：以上4条sql只有根据某个字段count不会统计字段为null值的数据行</strong></p><p><img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100116" alt="0"></p><p><strong>四个sql的执行计划一样，说明这四个sql执行效率应该差不多</strong></p><p><strong>字段有索引：count(*)≈count(1)&gt;count(字段)&gt;count(主键 id)    &#x2F;&#x2F;字段有索引，count(字段)统计走二级索引，二级索引存储数据比主键索引少，所以count(字段)&gt;count(主键 id)</strong> </p><p><strong>字段无索引：count(*)≈count(1)&gt;count(主键 id)&gt;count(字段)    &#x2F;&#x2F;字段没有索引count(字段)统计走不了索引，count(主键 id)还可以走主键索引，所以count(主键 id)&gt;count(字段)</strong></p><p>count(1)跟count(字段)执行过程类似，不过count(1)不需要取出字段统计，就用常量1做统计，count(字段)还需要取出字段，所以理论上count(1)比count(字段)会快一点。</p><p>count(<em>) 是例外，mysql并不会把全部字段取出来，而是专门做了优化，不取值，按行累加，效率很高，所以不需要用count(列名)或count(常量)来替代 count(</em>)。</p><p>为什么对于count(id)，mysql最终选择辅助索引而不是主键聚集索引？因为二级索引相对主键索引存储数据更少，检索性能应该更高，mysql内部做了点优化(应该是在5.7版本才优化)。</p><h1 id="常见优化方法"><a href="#常见优化方法" class="headerlink" title="常见优化方法"></a><strong>常见优化方法</strong></h1><h2 id="1、查询mysql自己维护的总行数"><a href="#1、查询mysql自己维护的总行数" class="headerlink" title="1、查询mysql自己维护的总行数"></a><strong>1、查询mysql自己维护的总行数</strong></h2><p>对于<strong>myisam存储引擎</strong>的表做不带where条件的count查询性能是很高的，因为myisam存储引擎的表的总行数会被mysql存储在磁盘上，查询不需要计算</p><p>​    <img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100114" alt="0"></p><p>对于<strong>innodb存储引擎</strong>的表mysql不会存储表的总记录行数(因为有MVCC机制，后面会讲)，查询count需要实时计算</p><h2 id="2、show-table-status"><a href="#2、show-table-status" class="headerlink" title="2、show table status"></a><strong>2、show table status</strong></h2><p>如果只需要知道表总行数的估计值可以用如下sql查询，性能很高</p><p>​    <img src="/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%982/100115" alt="0"></p><h2 id="3、将总数维护到Redis里"><a href="#3、将总数维护到Redis里" class="headerlink" title="3、将总数维护到Redis里"></a><strong>3、将总数维护到Redis里</strong></h2><p>插入或删除表数据行的时候同时维护redis里的表总行数key的计数值(用incr或decr命令)，但是这种方式可能不准，很难保证表操作和redis操作的事务一致性</p><h2 id="4、增加数据库计数表"><a href="#4、增加数据库计数表" class="headerlink" title="4、增加数据库计数表"></a><strong>4、增加数据库计数表</strong></h2><p>插入或删除表数据行的时候同时维护计数表，让他们在同一个事务里操作</p><h1 id="阿里巴巴Mysql规范解读"><a href="#阿里巴巴Mysql规范解读" class="headerlink" title="阿里巴巴Mysql规范解读"></a><strong>阿里巴巴Mysql规范解读</strong></h1><p><strong>补充：MySQL数据类型选择</strong></p><p>在MySQL中，选择正确的数据类型，对于性能至关重要。一般应该遵循下面两步：</p><p>（1）确定合适的大类型：数字、字符串、时间、二进制；</p><p>（2）确定具体的类型：有无符号、取值范围、变长定长等。</p><p>在MySQL数据类型设置方面，尽量用更小的数据类型，因为它们通常有更好的性能，花费更少的硬件资源。并且，尽量把字段定义为NOT NULL，避免使用NULL。</p><h2 id="1、数值类型"><a href="#1、数值类型" class="headerlink" title="1、数值类型"></a><strong>1、数值类型</strong></h2><table><thead><tr><th>类型</th><th>大小</th><th>范围（有符号）</th><th>范围（无符号）</th><th>用途</th></tr></thead><tbody><tr><td>TINYINT</td><td>1 字节</td><td>(-128, 127)</td><td>(0, 255)</td><td>小整数值</td></tr><tr><td>SMALLINT</td><td>2 字节</td><td>(-32 768, 32 767)</td><td>(0, 65 535)</td><td>大整数值</td></tr><tr><td>MEDIUMINT</td><td>3 字节</td><td>(-8 388 608, 8 388 607)</td><td>(0, 16 777 215)</td><td>大整数值</td></tr><tr><td>INT或INTEGER</td><td>4 字节</td><td>(-2 147 483 648, 2 147 483 647)</td><td>(0, 4 294 967 295)</td><td>大整数值</td></tr><tr><td>BIGINT</td><td>8 字节</td><td>(-9 233 372 036 854 775 808, 9 223 372 036 854 775 807)</td><td>(0, 18 446 744 073 709 551 615)</td><td>极大整数值</td></tr><tr><td>FLOAT</td><td>4 字节</td><td>(-3.402 823 466 E+38, 1.175 494 351 E-38)，0，(1.175 494 351 E-38，3.402 823 466 351 E+38)</td><td>0, (1.175 494 351 E-38, 3.402 823 466 E+38)</td><td>单精度浮点数值</td></tr><tr><td>DOUBLE</td><td>8 字节</td><td>(1.797 693 134 862 315 7 E+308, 2.225 073 858 507 201 4 E-308), 0, (2.225 073 858 507 201 4 E-308, 1.797 693 134 862 315 7 E+308)</td><td>0, (2.225 073 858 507 201 4 E-308, 1.797 693 134 862 315 7 E+308)</td><td>双精度浮点数值</td></tr><tr><td>DECIMAL</td><td>对DECIMAL(M,D) ，如果M&gt;D，为M+2否则为D+2</td><td>依赖于M和D的值</td><td>依赖于M和D的值</td><td>小数值</td></tr></tbody></table><h2 id="优化建议"><a href="#优化建议" class="headerlink" title="优化建议"></a><strong>优化建议</strong></h2><ol><li>如果整形数据没有负数，如ID号，建议指定为UNSIGNED无符号类型，容量可以扩大一倍。</li><li>建议使用TINYINT代替ENUM、BITENUM、SET。</li><li>避免使用整数的显示宽度(参看文档最后)，也就是说，不要用INT(10)类似的方法指定字段显示宽度，直接用INT。</li><li>DECIMAL最适合保存准确度要求高，而且用于计算的数据，比如价格。但是在使用DECIMAL类型的时候，注意长度设置。</li><li>建议使用整形类型来运算和存储实数，方法是，实数乘以相应的倍数后再操作。</li><li>整数通常是最佳的数据类型，因为它速度快，并且能使用AUTO_INCREMENT。</li></ol><h2 id="2、日期和时间"><a href="#2、日期和时间" class="headerlink" title="2、日期和时间"></a><strong>2、日期和时间</strong></h2><table><thead><tr><th>类型</th><th>大小(字节)</th><th>范围</th><th>格式</th><th>用途</th></tr></thead><tbody><tr><td>DATE</td><td>3</td><td>1000-01-01 到 9999-12-31</td><td>YYYY-MM-DD</td><td>日期值</td></tr><tr><td>TIME</td><td>3</td><td>‘-838:59:59’ 到 ‘838:59:59’</td><td>HH:MM:SS</td><td>时间值或持续时间</td></tr><tr><td>YEAR</td><td>1</td><td>1901 到 2155</td><td>YYYY</td><td>年份值</td></tr><tr><td>DATETIME</td><td>8</td><td>1000-01-01 00:00:00 到 9999-12-31 23:59:59</td><td>YYYY-MM-DD HH:MM:SS</td><td>混合日期和时间值</td></tr><tr><td>TIMESTAMP</td><td>4</td><td>1970-01-01 00:00:00 到 2038-01-19 03:14:07</td><td>YYYYMMDDhhmmss</td><td>混合日期和时间值，时间戳</td></tr></tbody></table><h2 id="优化建议-1"><a href="#优化建议-1" class="headerlink" title="优化建议"></a><strong>优化建议</strong></h2><ol><li>MySQL能存储的最小时间粒度为秒。</li><li>建议用DATE数据类型来保存日期。MySQL中默认的日期格式是yyyy-mm-dd。</li><li>用MySQL的内建类型DATE、TIME、DATETIME来存储时间，而不是使用字符串。</li><li>当数据格式为TIMESTAMP和DATETIME时，可以用CURRENT_TIMESTAMP作为默认（MySQL5.6以后），MySQL会自动返回记录插入的确切时间。</li><li>TIMESTAMP是UTC时间戳，与时区相关。</li><li>DATETIME的存储格式是一个YYYYMMDD HH:MM:SS的整数，与时区无关，你存了什么，读出来就是什么。</li><li>除非有特殊需求，一般的公司建议使用TIMESTAMP，它比DATETIME更节约空间，但是像阿里这样的公司一般会用DATETIME，因为不用考虑TIMESTAMP将来的时间上限问题。</li><li>有时人们把Unix的时间戳保存为整数值，但是这通常没有任何好处，这种格式处理起来不太方便，我们并不推荐它。</li></ol><p><strong>3、字符串</strong></p><table><thead><tr><th>类型</th><th>大小</th><th>用途</th></tr></thead><tbody><tr><td>CHAR</td><td>0-255字节</td><td>定长字符串，char(n)当插入的字符数不足n时(n代表字符数)，插入空格进行补充保存。在进行检索时，尾部的空格会被去掉。</td></tr><tr><td>VARCHAR</td><td>0-65535 字节</td><td>变长字符串，varchar(n)中的n代表最大字符数，插入的字符数不足n时不会补充空格</td></tr><tr><td>TINYBLOB</td><td>0-255字节</td><td>不超过 255 个字符的二进制字符串</td></tr><tr><td>TINYTEXT</td><td>0-255字节</td><td>短文本字符串</td></tr><tr><td>BLOB</td><td>0-65 535字节</td><td>二进制形式的长文本数据</td></tr><tr><td>TEXT</td><td>0-65 535字节</td><td>长文本数据</td></tr><tr><td>MEDIUMBLOB</td><td>0-16 777 215字节</td><td>二进制形式的中等长度文本数据</td></tr><tr><td>MEDIUMTEXT</td><td>0-16 777 215字节</td><td>中等长度文本数据</td></tr><tr><td>LONGBLOB</td><td>0-4 294 967 295字节</td><td>二进制形式的极大文本数据</td></tr><tr><td>LONGTEXT</td><td>0-4 294 967 295字节</td><td>极大文本数据</td></tr></tbody></table><h2 id="优化建议-2"><a href="#优化建议-2" class="headerlink" title="优化建议"></a><strong>优化建议</strong></h2><ol><li>字符串的长度相差较大用VARCHAR；字符串短，且所有值都接近一个长度用CHAR。</li><li>CHAR和VARCHAR适用于包括人名、邮政编码、电话号码和不超过255个字符长度的任意字母数字组合。那些要用来计算的数字不要用VARCHAR类型保存，因为可能会导致一些与计算相关的问题。换句话说，可能影响到计算的准确性和完整性。</li><li>尽量少用BLOB和TEXT，如果实在要用可以考虑将BLOB和TEXT字段单独存一张表，用id关联。</li><li>BLOB系列存储二进制字符串，与字符集无关。TEXT系列存储非二进制字符串，与字符集相关。</li><li>BLOB和TEXT都不能有默认值。</li></ol><p><strong>PS：INT显示宽度</strong></p><p>我们经常会使用命令来创建数据表，而且同时会指定一个长度，如下。但是，这里的长度并非是TINYINT类型存储的最大长度，而是显示的最大长度。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE `user`(    `id` TINYINT(2) UNSIGNED );  <br></code></pre></td></tr></table></figure><p>这里表示user表的id字段的类型是TINYINT，可以存储的最大数值是255。所以，在存储数据时，如果存入值小于等于255，如200，虽然超过2位，但是没有超出TINYINT类型长度，所以可以正常保存；如果存入值大于255，如500，那么MySQL会自动保存为TINYINT类型的最大值255。</p><p>在查询数据时，不管查询结果为何值，都按实际输出。这里TINYINT(2)中2的作用就是，当需要在查询结果前填充0时，命令中加上ZEROFILL就可以实现，如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">`id` TINYINT(2) UNSIGNED ZEROFILL <br></code></pre></td></tr></table></figure><p>这样，查询结果如果是5，那输出就是05。如果指定TINYINT(5)，那输出就是00005，其实实际存储的值还是5，而且存储的数据不会超过255，只是MySQL输出数据时在前面填充了0。</p><p>换句话说，在MySQL命令中，字段的类型长度TINYINT(2)、INT(11)不会影响数据的插入，只会在使用ZEROFILL时有用，让查询结果前填充0。</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>MySQL性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql慢查询(附件)</title>
    <link href="/2023/06/13/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/mysql%E6%85%A2%E6%9F%A5%E8%AF%A2(%E9%99%84%E4%BB%B6)/"/>
    <url>/2023/06/13/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/mysql%E6%85%A2%E6%9F%A5%E8%AF%A2(%E9%99%84%E4%BB%B6)/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a><strong>1 概念</strong></h1><p>MySQL的慢查询，全名是<strong>慢查询日志</strong>，是MySQL提供的一种日志记录，用来记录在MySQL中<strong>响应时间超过阀值</strong>的语句。</p><p>具体环境中，运行时间超过long_query_time值的SQL语句，则会被记录到慢查询日志中。</p><p>long_query_time的默认值为10，意思是记录运行10秒以上的语句。</p><p>默认情况下，MySQL数据库并不启动慢查询日志，需要手动来设置这个参数。</p><p>当然，<strong>如果不是调优需要的话，一般不建议启动该参数</strong>，因为开启慢查询日志会或多或少带来一定的性能影响。</p><p>慢查询日志支持将日志记录写入文件和数据库表。</p><p>官方文档，关于慢查询的日志介绍如下（部分资料，具体参考官方相关链接）：</p><h1 id="2-参数"><a href="#2-参数" class="headerlink" title="2 参数"></a><strong>2 参数</strong></h1><p>MySQL 慢查询的相关参数解释：</p><p>slow_query_log：是否开启慢查询日志，<strong>1表示开启，0表示关闭</strong>。</p><p>log-slow-queries ：旧版（5.6以下版本）MySQL数据库慢查询日志存储路径。可以不设置该参数，系统则会默认给一个缺省的文件host_name-slow.log</p><p>slow-query-log-file：新版（5.6及以上版本）MySQL数据库慢查询日志存储路径。可以不设置该参数，系统则会默认给一个缺省的文件host_name-slow.log</p><p>long_query_time：慢查询阈值，当查询时间多于设定的阈值时，记录日志。</p><p>log_queries_not_using_indexes：未使用索引的查询也被记录到慢查询日志中（可选项）。</p><p>log_output：日志存储方式。log_output&#x3D;’FILE’表示将日志存入文件，默认值是’FILE’。log_output&#x3D;’TABLE’表示将日志存入数据库。</p><h1 id="3-配置"><a href="#3-配置" class="headerlink" title="3 配置"></a><strong>3 配置</strong></h1><h2 id="3-1-slow-query-log"><a href="#3-1-slow-query-log" class="headerlink" title="3.1 slow_query_log"></a><strong>3.1 slow_query_log</strong></h2><p>默认情况下slow_query_log的值为OFF，表示慢查询日志是禁用的，可以通过设置slow_query_log的值来开启，如下所示：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show variables  like <span class="hljs-string">&#x27;%slow_query_log%&#x27;</span>;</span> <br>+---------------------+-----------------------------------------------+ <br>| Variable_name       | Value                                         | <br>+---------------------+-----------------------------------------------+ <br>| slow_query_log      | OFF                                           | <br>| slow_query_log_file | /home/WDPM/MysqlData/mysql/DB-Server-slow.log | <br>+---------------------+-----------------------------------------------+ <br>2 rows in set (0.00 sec)  mysql&gt; set global slow_query_log=1; <br>Query OK, 0 rows affected (0.09 sec)         <br></code></pre></td></tr></table></figure><p>​     </p><p>使用set global slow_query_log&#x3D;1开启了慢查询日志只对当前数据库生效，MySQL重启后则会失效。</p><p>如果要永久生效，就必须修改配置文件my.cnf（其它系统变量也是如此）。</p><p>my.cnf要增加或修改参数slow_query_log 和slow_query_log_file，如下所示</p><p>slow_query_log &#x3D; 1</p><p>slow_query_log_file &#x3D; &#x2F;tmp&#x2F;mysql_slow.log</p><p>然后重启MySQL服务器。</p><h2 id="3-2-slow-query-log-file"><a href="#3-2-slow-query-log-file" class="headerlink" title="3.2 slow_query_log_file"></a><strong>3.2 slow_query_log_file</strong></h2><p>这个参数用于指定慢查询日志的存放路径，缺省情况是host_name-slow.log文件，</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show variables like <span class="hljs-string">&#x27;slow_query_log_file&#x27;</span>;</span><br> +---------------------+-----------------------------------------------+<br> | Variable_name       | Value                                         |<br> +---------------------+-----------------------------------------------+<br> | slow_query_log_file | /home/WDPM/MysqlData/mysql/DB-Server-slow.log |<br> +---------------------+-----------------------------------------------+<br> 1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><p>​        </p><h2 id="3-3-long-query-time"><a href="#3-3-long-query-time" class="headerlink" title="3.3 long_query_time"></a><strong>3.3 long_query_time</strong></h2><p>开启了慢查询日志后，什么样的SQL才会记录到慢查询日志里面呢？</p><p>这个是由参数long_query_time控制，默认情况下long_query_time的值为10秒，可以使用命令修改，也可以在my.cnf参数里面修改。</p><p>关于运行时间正好等于long_query_time的情况，并不会被记录下来。</p><p>也就是说，在mysql源码里是判断大于long_query_time，而非大于等于。</p><p>从MySQL 5.1开始，long_query_time开始以微秒记录SQL语句运行时间，之前仅用秒为单位记录。</p><p>如果记录到表里面，只会记录整数部分，不会记录微秒部分。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show variables like <span class="hljs-string">&#x27;long_query_time%&#x27;</span>;</span><br> +-----------------+-----------+<br> | Variable_name   | Value     |<br> +-----------------+-----------+<br> | long_query_time | 10.000000 |<br> +-----------------+-----------+<br> 1 row in set (0.00 sec)<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash"><span class="hljs-built_in">set</span> global long_query_time=4;</span><br> Query OK, 0 rows affected (0.00 sec)<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show variables like <span class="hljs-string">&#x27;long_query_time&#x27;</span>;</span><br> +-----------------+-----------+<br> | Variable_name   | Value     |<br> +-----------------+-----------+<br> | long_query_time | 10.000000 |<br> +-----------------+-----------+<br> 1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><p>​        </p><p>如上所示，我修改了变量long_query_time，但是查询变量long_query_time的值还是10，难道没有修改到呢？</p><p>注意：使用命令 set global long_query_time&#x3D;4修改后，需要重新连接或新开一个会话才能看到修改值。</p><p>用show variables like ‘long_query_time’查看是当前会话的变量值。</p><p>也可以不用重新连接会话，而是用show global variables like ‘long_query_time’;。</p><h2 id="3-4-log-output"><a href="#3-4-log-output" class="headerlink" title="3.4 log_output"></a><strong>3.4 log_output</strong></h2><p>log_output参数指定日志的存储方式。</p><p>log_output&#x3D;’FILE’表示将日志存入文件，默认值也是’FILE’。</p><p>log_output&#x3D;’TABLE’表示将日志存入数据库，这样日志信息就会被写入到mysql.slow_log表中。</p><p>同时也支持两种日志存储方式，配置的时候以逗号隔开即可，如：log_output&#x3D;’FILE,TABLE’。</p><p>日志记录到系统的专用日志表中，要比记录到文件耗费更多的系统资源。</p><p>因此对于需要启用慢查询日志，又需要能够获得更高的系统性能，那么<strong>建议优先记录到文件</strong>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show variables like <span class="hljs-string">&#x27;%log_output%&#x27;</span>;</span><br> +---------------+-------+<br> | Variable_name | Value |<br> +---------------+-------+<br> | log_output    | FILE  |<br> +---------------+-------+<br> 1 row in set (0.00 sec)<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash"><span class="hljs-built_in">set</span> global log_output=<span class="hljs-string">&#x27;TABLE&#x27;</span>;</span><br> Query OK, 0 rows affected (0.00 sec)<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show variables like <span class="hljs-string">&#x27;%log_output%&#x27;</span>;</span><br> +---------------+-------+<br> | Variable_name | Value |<br> +---------------+-------+<br> | log_output    | TABLE |<br> +---------------+-------+<br> 1 row in set (0.00 sec)<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">select <span class="hljs-built_in">sleep</span>(5) ;</span><br> +----------+<br> | sleep(5) |<br> +----------+<br> |        0 |<br> +----------+<br> 1 row in set (5.00 sec)<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">mysql&gt;</span><span class="language-bash"></span><br><span class="language-bash"></span><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">select * from mysql.slow_log;</span><br> +---------------------+---------------------------+------------+-----------+-----------+---------------+----+----------------+-----------+-----------+-----------------+-----------+<br> | start_time          | user_host                 | query_time | lock_time | rows_sent | rows_examined | db | last_insert_id | insert_id | server_id | sql_text        | thread_id |<br> +---------------------+---------------------------+------------+-----------+-----------+---------------+----+----------------+-----------+-----------+-----------------+-----------+<br> | 2016-06-16 17:37:53 | root[root] @ localhost [] | 00:00:03   | 00:00:00  |         1 |             0 |    |              0 |         0 |         1 | select sleep(3) |         5 |<br> | 2016-06-16 21:45:23 | root[root] @ localhost [] | 00:00:05   | 00:00:00  |         1 |             0 |    |              0 |         0 |         1 | select sleep(5) |         2 |<br> +---------------------+---------------------------+------------+-----------+-----------+---------------+----+----------------+-----------+-----------+-----------------+-----------+<br> 2 rows in set (0.00 sec)<br></code></pre></td></tr></table></figure><p>​        </p><h2 id="3-5-log-queries-not-using-indexes"><a href="#3-5-log-queries-not-using-indexes" class="headerlink" title="3.5 log-queries-not-using-indexes"></a><strong>3.5 log-queries-not-using-indexes</strong></h2><p>该系统变量指定<strong>未使用索引的查询</strong>也被记录到慢查询日志中（可选项）。</p><p>如果调优的话，建议开启这个选项。</p><p>另外，开启了这个参数，其实使用full index scan的SQL也会被记录到慢查询日志。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show variables like <span class="hljs-string">&#x27;log_queries_not_using_indexes&#x27;</span>;</span><br> +-------------------------------+-------+<br> | Variable_name                 | Value |<br> +-------------------------------+-------+<br> | log_queries_not_using_indexes | OFF   |<br> +-------------------------------+-------+<br> 1 row in set (0.00 sec)<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash"><span class="hljs-built_in">set</span> global log_queries_not_using_indexes=1;</span><br> Query OK, 0 rows affected (0.00 sec)<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show variables like <span class="hljs-string">&#x27;log_queries_not_using_indexes&#x27;</span>;</span><br> +-------------------------------+-------+<br> | Variable_name                 | Value |<br> +-------------------------------+-------+<br> | log_queries_not_using_indexes | ON    |<br> +-------------------------------+-------+<br> 1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><p>​         </p><h2 id="3-6-log-slow-admin-statements"><a href="#3-6-log-slow-admin-statements" class="headerlink" title="3.6 log_slow_admin_statements"></a><strong>3.6 log_slow_admin_statements</strong></h2><p>这个系统变量表示，是否将慢管理语句例如ANALYZE TABLE和ALTER TABLE等记入慢查询日志。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show variables like <span class="hljs-string">&#x27;log_slow_admin_statements&#x27;</span>;</span><br> +---------------------------+-------+<br> | Variable_name             | Value |<br> +---------------------------+-------+<br> | log_slow_admin_statements | OFF   |<br> +---------------------------+-------+<br> 1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><h2 id="3-7-Slow-queries"><a href="#3-7-Slow-queries" class="headerlink" title="3.7 Slow_queries"></a><strong>3.7 Slow_queries</strong></h2><p>如果你想查询有多少条慢查询记录，可以使用Slow_queries系统变量。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show global status like <span class="hljs-string">&#x27;%Slow_queries%&#x27;</span>;</span><br> +---------------+-------+<br> | Variable_name | Value |<br> +---------------+-------+<br> | Slow_queries  | 2104  |<br> +---------------+-------+<br> 1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><p>另外，还有log_slow_slave_statements 和 –log-short-format 参数，可到MySQL网站了解。</p><h1 id="4-mysqldumpslow工具"><a href="#4-mysqldumpslow工具" class="headerlink" title="4 mysqldumpslow工具"></a><strong>4 mysqldumpslow工具</strong></h1><p>在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活。</p><p>MySQL提供了日志分析工具mysqldumpslow</p><p>查看mysqldumpslow的帮助信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@DB-Server ~]# mysqldumpslow --help<br> Usage: mysqldumpslow [ OPTS... ] [ LOGS... ]<br> <br>Parse and summarize the MySQL slow query log. Options are<br> <br>  --verbose    verbose<br>  --debug      debug<br>  --help       write this text to standard output<br> <br>  -v           verbose<br>  -d           debug<br>  -s ORDER     what to sort by (al, at, ar, c, l, r, t), &#x27;at&#x27; is default（排序方式）<br>                 al: average lock time（平均锁定时间）<br>                 ar: average rows sent（平均返回记录数）<br>                 at: average query time（平均查询时间）<br>                  c: count（访问计数）<br>                  l: lock time（锁定时间）<br>                  r: rows sent（返回记录）<br>                  t: query time（查询时间）<br>   -r           reverse the sort order (largest last instead of first)<br>   -t NUM       just show the top n queries（返回前面n条数据）<br>   -a           don&#x27;t abstract all numbers to N and strings to &#x27;S&#x27;<br>   -n NUM       abstract numbers with at least n digits within names<br>   -g PATTERN   grep: only consider stmts that include this string（正则匹配模式，大小写不敏感）<br>   -h HOSTNAME  hostname of db server for *-slow.log filename (can be wildcard),<br>                default is &#x27;*&#x27;, i.e. match all<br>   -i NAME      name of server instance (if using mysql.server startup script)<br>   -l           don&#x27;t subtract lock time from total time<br> <br></code></pre></td></tr></table></figure><p>比如，得到返回记录集最多的10个SQL。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mysqldumpslow -s r -t 10 /database/mysql/mysql06_slow.log      <br></code></pre></td></tr></table></figure><p>​        </p><p>得到访问次数最多的10个SQL</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mysqldumpslow -s c -t 10 /database/mysql/mysql06_slow.log           <br></code></pre></td></tr></table></figure><p>得到按照时间排序的前10条里面含有左连接的查询语句。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mysqldumpslow -s t -t 10 -g “left join” /database/mysql/mysql06_slow.log<br></code></pre></td></tr></table></figure><p>​       </p><p>另外建议在使用这些命令时结合 | 和more 使用 ，否则有可能出现刷屏的情况。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mysqldumpslow -s r -t 20 /mysqldata/mysql/mysql06-slow.log | more<br></code></pre></td></tr></table></figure><p>​        </p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>MySQL性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>8、高性能业务表结构设计和索引知识深化</title>
    <link href="/2023/06/12/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/8%E3%80%81%E9%AB%98%E6%80%A7%E8%83%BD%E4%B8%9A%E5%8A%A1%E8%A1%A8%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%92%8C%E7%B4%A2%E5%BC%95%E7%9F%A5%E8%AF%86%E6%B7%B1%E5%8C%96/"/>
    <url>/2023/06/12/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/8%E3%80%81%E9%AB%98%E6%80%A7%E8%83%BD%E4%B8%9A%E5%8A%A1%E8%A1%A8%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%92%8C%E7%B4%A2%E5%BC%95%E7%9F%A5%E8%AF%86%E6%B7%B1%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>MySQL性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>7、深入理解MVCC与BufferPool缓存机制</title>
    <link href="/2023/06/12/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/7%E3%80%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3MVCC%E4%B8%8EBufferPool%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/"/>
    <url>/2023/06/12/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/7%E3%80%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3MVCC%E4%B8%8EBufferPool%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>MySQL性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6、深入理解Mysql事务隔离级别与锁机制</title>
    <link href="/2023/06/12/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/6%E3%80%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Mysql%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/"/>
    <url>/2023/06/12/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/6%E3%80%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Mysql%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8E%E9%94%81%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>MySQL性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>3、MySQL索引优化实战</title>
    <link href="/2023/06/12/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/"/>
    <url>/2023/06/12/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/4%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>MySQL性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2、Explain详解与索引最佳实践</title>
    <link href="/2023/06/12/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/2%E3%80%81Explain%E8%AF%A6%E8%A7%A3%E4%B8%8E%E7%B4%A2%E5%BC%95%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"/>
    <url>/2023/06/12/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/2%E3%80%81Explain%E8%AF%A6%E8%A7%A3%E4%B8%8E%E7%B4%A2%E5%BC%95%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h1 id="Explain工具介绍"><a href="#Explain工具介绍" class="headerlink" title="Explain工具介绍"></a>Explain工具介绍</h1><p>使用EXPLAIN关键字可以模拟优化器执行SQL语句，分析你的查询语句或是结构的性能瓶颈<br>在 select 语句之前增加 explain 关键字，MySQL 会在查询上设置一个标记，执行查询会返回执行计划的信息，而不是<br>执行这条SQL<br>注意：如果 from 中包含子查询，仍会执行该子查询，将结果放入临时表中</p><h2 id="Explain分析示例"><a href="#Explain分析示例" class="headerlink" title="Explain分析示例"></a>Explain分析示例</h2><p>参考官方文档：<a href="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html">https://dev.mysql.com/doc/refman/5.7/en/explain-output.html</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs mysql">示例表：<br>DROP TABLE IF EXISTS `actor`;<br>CREATE TABLE `actor` (<br>`id` int(11) NOT NULL,<br>    `name` varchar(45) DEFAULT NULL,<br>    PRIMARY KEY(`id`),<br>    KEY `idx_name` (`name`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf-8;<br><br>INSERT INTO `file` (`id`,`name`) VALUES (3,&#x27;film0&#x27;),(1,&#x27;film1&#x27;),(2,&#x27;film2&#x27;);<br><br>DROP TABLE IF EXISTS `film` ;<br>CREATE TABLE `film` (<br>`id` int(11) NOT NULL AUTO_ INCREMENT ,<br>`name` varchar(10) DEFAULT NULL,<br>PRIMARY KEY (`id`),<br>KEY `idx_name` (`name`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br><br>INSERT INTO `film`(`id`,`name`) VALUES (3,&#x27;fi1mB&#x27;),(1,&#x27;fi1m1&#x27;),(2,&#x27;film2&#x27;); <br><br>DROP TABLE IF EXISTS `film actor`;<br>CREATE TABLE `film_ actor` (<br>`id` int(11) NOT NULL,<br>`film_id` int(11) NOT NULL,<br>`actor_ id` int(11) NOT NULL,<br>`remark` varchar(255) DEFAULT NULL,<br>PRIMARY KEY (`id`),<br>KEY `idx_ film actor_id` (`film_id`, `actor_id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br><br>INSERT INTO `fi1m_ actor` (`id`,`film_id`,<br>`actor_ id`) VALUES (1,1,1),(2,1,2),(3,2,1);<br></code></pre></td></tr></table></figure><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">mysql&gt; <span class="hljs-keyword">explain</span> extended <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> actor;<br></code></pre></td></tr></table></figure><p><img src="/2%E3%80%81Explain%E8%AF%A6%E8%A7%A3%E4%B8%8E%E7%B4%A2%E5%BC%95%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/image-20230612145725856.png" alt="image-20230612145725856"></p><p>在查询中的每个表会输出一行，如果有两个表通过 join 连接查询，那么会输出两行</p><h2 id="explain-两个变种"><a href="#explain-两个变种" class="headerlink" title="explain 两个变种"></a><strong>explain 两个变种</strong></h2><p>1）<strong>explain extended</strong>：会在 explain 的基础上额外提供一些查询优化的信息。紧随其后通过 show warnings 命令可以得到优化后的查询语句，从而看出优化器优化了什么。额外还有 filtered 列，是一个半分比的值，rows * filtered&#x2F;100 可以估算出将要和 explain 中前一个表进行连接的行数（前一个表指 explain 中的id值比当前表id值小的表）。</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">mysql&gt; <span class="hljs-keyword">explain</span> extended <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> film <span class="hljs-keyword">where</span> id = <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p><img src="/2%E3%80%81Explain%E8%AF%A6%E8%A7%A3%E4%B8%8E%E7%B4%A2%E5%BC%95%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/image-20230612153755294.png" alt="image-20230612153755294"></p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">mysql&gt; <span class="hljs-built_in">show</span> <span class="hljs-built_in">warnings</span>;<br></code></pre></td></tr></table></figure><p><img src="/2%E3%80%81Explain%E8%AF%A6%E8%A7%A3%E4%B8%8E%E7%B4%A2%E5%BC%95%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/image-20230612153841090.png" alt="image-20230612153841090"></p><p>2）<strong>explain partitions</strong>：相比 explain 多了个 partitions 字段，如果查询是基于分区表的话，会显示查询将访问的分<br>区。</p><h2 id="explain中的列"><a href="#explain中的列" class="headerlink" title="explain中的列"></a>explain中的列</h2><p>接下来我们将展示 explain 中每个列的信息。</p><ol><li><p><strong>id列</strong><br>id列的编号是 select 的序列号，有几个 select 就有几个id，并且id的顺序是按 select 出现的顺序增长的。<br>id列越大执行优先级越高，id相同则从上往下执行，id为NULL最后执行。</p></li><li><p><strong>select_type列</strong><br>select_type 表示对应行是简单还是复杂的查询。</p><ol><li><p>simple：简单查询。查询不包含子查询和union</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">mysql&gt; <span class="hljs-keyword">explain</span> <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> film <span class="hljs-keyword">where</span> id = <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure><p><img src="/2%E3%80%81Explain%E8%AF%A6%E8%A7%A3%E4%B8%8E%E7%B4%A2%E5%BC%95%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/image-20230612160801603.png" alt="image-20230612160801603"></p></li></ol></li></ol><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>MySQL性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>1、深入理解MySQL索引底层数据结构与算法</title>
    <link href="/2023/06/12/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/1%E3%80%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3MySQL%E7%B4%A2%E5%BC%95%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    <url>/2023/06/12/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MySQL%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/1%E3%80%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3MySQL%E7%B4%A2%E5%BC%95%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之性能调优</category>
      
      <category>MySQL性能调优</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>23、SpringMVC中的转发和重定向</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/23%E3%80%81SpringMVC%E4%B8%AD%E7%9A%84%E8%BD%AC%E5%8F%91%E5%92%8C%E9%87%8D%E5%AE%9A%E5%90%91/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/23%E3%80%81SpringMVC%E4%B8%AD%E7%9A%84%E8%BD%AC%E5%8F%91%E5%92%8C%E9%87%8D%E5%AE%9A%E5%90%91/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>22、SpringMVC中不常用注解使用</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/22%E3%80%81SpringMVC%E4%B8%AD%E4%B8%8D%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/22%E3%80%81SpringMVC%E4%B8%AD%E4%B8%8D%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>21、SpringBoot启动过程源码解析</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/21%E3%80%81SpringBoot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/21%E3%80%81SpringBoot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>20、SpringBoot自动配置底层源码解析</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/20%E3%80%81SpringBoot%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/20%E3%80%81SpringBoot%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>19、手写模拟SpringBoot核心流程</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/19%E3%80%81%E6%89%8B%E5%86%99%E6%A8%A1%E6%8B%9FSpringBoot%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/19%E3%80%81%E6%89%8B%E5%86%99%E6%A8%A1%E6%8B%9FSpringBoot%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>18、SpringMVC重点功能底层源码解析</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/18%E3%80%81SpringMVC%E9%87%8D%E7%82%B9%E5%8A%9F%E8%83%BD%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/18%E3%80%81SpringMVC%E9%87%8D%E7%82%B9%E5%8A%9F%E8%83%BD%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>17、SpringMVC启动与请求处理流程解析</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/17%E3%80%81SpringMVC%E5%90%AF%E5%8A%A8%E4%B8%8E%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/17%E3%80%81SpringMVC%E5%90%AF%E5%8A%A8%E4%B8%8E%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>16、Spring6.0及SpringBoot3.0新特性解析</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/16%E3%80%81Spring6.0%E5%8F%8ASpringBoot3.0%E6%96%B0%E7%89%B9%E6%80%A7%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/16%E3%80%81Spring6.0%E5%8F%8ASpringBoot3.0%E6%96%B0%E7%89%B9%E6%80%A7%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>15、Spring之事务底层源码解析</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/15%E3%80%81Spring%E4%B9%8B%E4%BA%8B%E5%8A%A1%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/15%E3%80%81Spring%E4%B9%8B%E4%BA%8B%E5%8A%A1%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>14、Spring之AOP底层源码解析(下)</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/14%E3%80%81Spring%E4%B9%8BAOP%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%8B)/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/14%E3%80%81Spring%E4%B9%8BAOP%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%8B)/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>13、Spring之AOP底层源码解析(上)</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/13%E3%80%81Spring%E4%B9%8BAOP%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%8A)/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/13%E3%80%81Spring%E4%B9%8BAOP%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%8A)/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>12、Spring之整合Mybatis底层源码解析</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/12%E3%80%81Spring%E4%B9%8B%E6%95%B4%E5%90%88Mybatis%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/12%E3%80%81Spring%E4%B9%8B%E6%95%B4%E5%90%88Mybatis%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>11、Spring之配置类解析源码解析</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/11%E3%80%81Spring%E4%B9%8B%E9%85%8D%E7%BD%AE%E7%B1%BB%E8%A7%A3%E6%9E%90%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/11%E3%80%81Spring%E4%B9%8B%E9%85%8D%E7%BD%AE%E7%B1%BB%E8%A7%A3%E6%9E%90%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>10、Spring之启动过程源码解析</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/10%E3%80%81Spring%E4%B9%8B%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/10%E3%80%81Spring%E4%B9%8B%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="前言分析"><a href="#前言分析" class="headerlink" title="前言分析"></a>前言分析</h2><p>通常，我们说的Spring启动，就是构造ApplicationContext对象以及调用refresh()方法的过程。</p><p>首先，Spring启动过程主要做了这么几件事情：</p><ol><li><p>构造一个BeanFactory对象</p></li><li><p>解析配置类，得到BeanDefinition，并注册到BeanFactory中</p></li><li><ol><li>解析@ComponentScan，此时就会完成扫描</li><li>解析@Import</li><li>解析@Bean</li><li>…</li></ol></li><li><p>因为ApplicationContext还支持国际化，所以还需要初始化MessageSource对象</p></li><li><p>因为ApplicationContext还支持事件机制，所以还需要初始化ApplicationEventMulticaster对象</p></li><li><p>把用户定义的ApplicationListener对象添加到ApplicationContext中，等Spring启动完了就要发布事件了</p></li><li><p>创建<strong>非懒加载的单例</strong>Bean对象，并存在BeanFactory的单例池中。</p></li><li><p>调用Lifecycle Bean的start()方法</p></li><li><p>发布<strong>ContextRefreshedEvent</strong>事件</p></li></ol><p>由于Spring启动过程中要创建非懒加载的单例Bean对象，那么就需要用到BeanPostProcessor，所以Spring在启动过程中就需要做两件事：</p><ol><li><p>生成默认的BeanPostProcessor对象，并添加到BeanFactory中</p></li><li><ol><li>AutowiredAnnotationBeanPostProcessor：处理@Autowired、@Value</li><li>CommonAnnotationBeanPostProcessor：处理@Resource、@PostConstruct、@PreDestroy</li><li>ApplicationContextAwareProcessor：处理ApplicationContextAware等回调</li></ol></li><li><p>找到外部用户所定义的BeanPostProcessor对象（类型为BeanPostProcessor的Bean对象），并添加到BeanFactory中</p></li></ol><h2 id="BeanFactoryPostProcessor"><a href="#BeanFactoryPostProcessor" class="headerlink" title="BeanFactoryPostProcessor"></a>BeanFactoryPostProcessor</h2><p>BeanPostProcessor表示Bean的后置处理器，是用来对Bean进行加工的，类似的，BeanFactoryPostProcessor理解为BeanFactory的后置处理器，用来用对BeanFactory进行加工的。</p><p>Spring支持用户定义BeanFactoryPostProcessor的实现类Bean，来对BeanFactory进行加工，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZhouyuBeanFactoryPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanFactoryPostProcessor</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> beanFactory.getBeanDefinition(<span class="hljs-string">&quot;userService&quot;</span>);<br>beanDefinition.setAutowireCandidate(<span class="hljs-literal">false</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>以上代码，就利用了BeanFactoryPostProcessor来拿到BeanFactory，然后获取BeanFactory内的某个BeanDefinition对象并进行修改，注意这一步是发生在Spring启动时，创建单例Bean之前的，所以此时对BeanDefinition就行修改是会生效的。</p><p>注意：在ApplicationContext内部有一个核心的DefaultListableBeanFactory，它实现了ConfigurableListableBeanFactory和BeanDefinitionRegistry接口，所以ApplicationContext和DefaultListableBeanFactory是可以注册BeanDefinition的，但是ConfigurableListableBeanFactory是不能注册BeanDefinition的，只能获取BeanDefinition，然后做修改。</p><p>所以Spring还提供了一个BeanFactoryPostProcessor的子接口：<strong>BeanDefinitionRegistryPostProcessor</strong></p><h2 id="BeanDefinitionRegistryPostProcessor"><a href="#BeanDefinitionRegistryPostProcessor" class="headerlink" title="BeanDefinitionRegistryPostProcessor"></a>BeanDefinitionRegistryPostProcessor</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanDefinitionRegistryPostProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BeanFactoryPostProcessor</span> &#123;<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> <span class="hljs-keyword">throws</span> BeansException;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>我们可以看到BeanDefinitionRegistryPostProcessor继承了BeanFactoryPostProcessor接口，并新增了一个方法，注意方法的参数为BeanDefinitionRegistry，所以如果我们提供一个类来实现BeanDefinitionRegistryPostProcessor，那么在postProcessBeanDefinitionRegistry()方法中就可以注册BeanDefinition了。比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZhouyuBeanDefinitionRegistryPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanDefinitionRegistryPostProcessor</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-type">AbstractBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.genericBeanDefinition().getBeanDefinition();<br>beanDefinition.setBeanClass(User.class);<br>registry.registerBeanDefinition(<span class="hljs-string">&quot;user&quot;</span>, beanDefinition);<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> beanFactory.getBeanDefinition(<span class="hljs-string">&quot;userService&quot;</span>);<br>beanDefinition.setAutowireCandidate(<span class="hljs-literal">false</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="如何理解refresh-？"><a href="#如何理解refresh-？" class="headerlink" title="如何理解refresh()？"></a>如何理解refresh()？</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Load or refresh the persistent representation of the configuration,</span><br><span class="hljs-comment"> * which might an XML file, properties file, or relational database schema.</span><br><span class="hljs-comment"> * &lt;p&gt;As this is a startup method, it should destroy already created singletons</span><br><span class="hljs-comment"> * if it fails, to avoid dangling resources. In other words, after invocation</span><br><span class="hljs-comment"> * of that method, either all or no singletons at all should be instantiated.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> BeansException if the bean factory could not be initialized</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> IllegalStateException if already initialized and multiple refresh</span><br><span class="hljs-comment"> * attempts are not supported</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException;<br></code></pre></td></tr></table></figure><p>这是ConfigurableApplicationContext接口上refresh()方法的注释，意思是：加载或刷新持久化的配置，可能是XML文件、属性文件或关系数据库中存储的。由于这是一个启动方法，如果失败，它应该销毁已经创建的单例，以避免暂用资源。换句话说，在调用该方法之后，应该实例化所有的单例，或者根本不实例化单例 。</p><p>有个理念需要注意：<strong>ApplicationContext关闭之后不代表JVM也关闭了，ApplicationContext是属于JVM的，说白了ApplicationContext也是JVM中的一个对象。</strong></p><p>在Spring的设计中，也提供可以刷新的ApplicationContext和不可以刷新的ApplicationContext。比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">AbstractRefreshableApplicationContext <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractApplicationContext</span><br></code></pre></td></tr></table></figure><p>就是可以刷新的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">GenericApplicationContext <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractApplicationContext</span><br></code></pre></td></tr></table></figure><p>就是不可以刷新的。</p><p>AnnotationConfigApplicationContext继承的是GenericApplicationContext，所以它是不能刷新的。</p><p>AnnotationConfigWebApplicationContext继承的是AbstractRefreshableWebApplicationContext，所以它是可以刷的。</p><p>上面说的<strong>不能刷新是指不能重复刷新，只能调用一次refresh方法，第二次时会报错。</strong></p><h2 id="refresh-底层原理流程"><a href="#refresh-底层原理流程" class="headerlink" title="refresh()底层原理流程"></a>refresh()底层原理流程</h2><p>底层原理流程图：<a href="https://www.processon.com/view/link/5f60a7d71e08531edf26a919">https://www.processon.com/view/link/5f60a7d71e08531edf26a919</a></p><p>下面以AnnotationConfigApplicationContext为例子，来介绍refresh的底层原理。</p><p>下面以AnnotationConfigApplicationContext为例子，来介绍refresh的底层原理。</p><ol><li><p>在调用AnnotationConfigApplicationContext的构造方法之前，会调用父类GenericApplicationContext的无参构造方法，会构造一个BeanFactory，为<strong>DefaultListableBeanFactory</strong>。</p></li><li><p>构造AnnotatedBeanDefinitionReader（<strong>主要作用添加一些基础的PostProcessor，同时可以通过reader进行BeanDefinition的注册</strong>），同时对BeanFactory进行设置和添加<strong>PostProcessor</strong>（后置处理器）</p></li><li><ol><li>设置dependencyComparator：AnnotationAwareOrderComparator，它是一个Comparator，是用来进行排序的，会获取某个对象上的<strong>Order注解</strong>或者通过实现<strong>Ordered接口</strong>所定义的值进行排序，在日常开发中可以利用这个类来进行排序。</li><li>设置autowireCandidateResolver：ContextAnnotationAutowireCandidateResolver，用来解析某个Bean能不能进行自动注入，比如某个Bean的autowireCandidate属性是否等于true</li><li>向BeanFactory中添加<strong>ConfigurationClassPostProcessor</strong>对应的BeanDefinition，它是一个BeanDefinitionRegistryPostProcessor，并且实现了PriorityOrdered接口</li><li>向BeanFactory中添加<strong>AutowiredAnnotationBeanPostProcessor</strong>对应的BeanDefinition，它是一个InstantiationAwareBeanPostProcessorAdapter，MergedBeanDefinitionPostProcessor</li><li>向BeanFactory中添加CommonAnnotationBeanPostProcessor对应的BeanDefinition，它是一个InstantiationAwareBeanPostProcessor，InitDestroyAnnotationBeanPostProcessor</li><li>向BeanFactory中添加EventListenerMethodProcessor对应的BeanDefinition，它是一个BeanFactoryPostProcessor，SmartInitializingSingleton</li><li>向BeanFactory中添加DefaultEventListenerFactory对应的BeanDefinition，它是一个EventListenerFactory</li></ol></li><li><p>构造ClassPathBeanDefinitionScanner（<strong>主要作用可以用来扫描得到并注册BeanDefinition</strong>），同时进行设置：</p></li><li><ol><li>设置<strong>this.includeFilters &#x3D; AnnotationTypeFilter(<strong><strong>Component</strong></strong>.class)</strong></li><li>设置environment</li><li>设置resourceLoader</li></ol></li><li><p>利用reader注册AppConfig为BeanDefinition，类型为AnnotatedGenericBeanDefinition</p></li><li><p><strong>接下来就是调用refresh方法</strong></p></li><li><p>prepareRefresh()：</p></li><li><ol><li>记录启动时间</li><li>可以允许子容器设置一些内容到Environment中</li><li>验证Environment中是否包括了必须要有的属性</li></ol></li><li><p>obtainFreshBeanFactory()：进行BeanFactory的refresh，在这里会去调用子类的refreshBeanFactory方法，具体子类是怎么刷新的得看子类，然后再调用子类的getBeanFactory方法，重新得到一个BeanFactory</p></li><li><p>prepareBeanFactory(beanFactory)：</p></li><li><ol><li>设置beanFactory的类加载器</li><li>设置表达式解析器：StandardBeanExpressionResolver，用来解析Spring中的表达式</li><li>添加PropertyEditorRegistrar：ResourceEditorRegistrar，PropertyEditor类型转化器注册器，用来注册一些默认的PropertyEditor</li><li>添加一个Bean的后置处理器：ApplicationContextAwareProcessor，是一个BeanPostProcessor，用来执行EnvironmentAware、ApplicationEventPublisherAware等回调方法</li><li>添加<strong>ignoredDependencyInterface</strong>：可以向这个属性中添加一些接口，如果某个类实现了这个接口，并且这个类中的某些set方法在接口中也存在，那么这个set方法在自动注入的时候是不会执行的，比如EnvironmentAware这个接口，如果某个类实现了这个接口，那么就必须实现它的setEnvironment方法，而这是一个set方法，和Spring中的autowire是冲突的，那么Spring在自动注入时是不会调用setEnvironment方法的，而是等到回调Aware接口时再来调用（注意，这个功能仅限于xml的autowire，@Autowired注解是忽略这个属性的）</li></ol></li><li><ol><li><ol><li>EnvironmentAware</li><li>EmbeddedValueResolverAware</li><li>ResourceLoaderAware</li><li>ApplicationEventPublisherAware</li><li>MessageSourceAware</li><li>ApplicationContextAware</li><li>另外其实在构造BeanFactory的时候就已经提前添加了另外三个：</li><li>BeanNameAware</li><li>BeanClassLoaderAware</li><li>BeanFactoryAware</li></ol></li></ol></li><li><ol><li>添加<strong>resolvableDependencies</strong>：在byType进行依赖注入时，会先从这个属性中根据类型找bean</li></ol></li><li><ol><li><ol><li>BeanFactory.class：当前BeanFactory对象</li><li>ResourceLoader.class：当前ApplicationContext对象</li><li>ApplicationEventPublisher.class：当前ApplicationContext对象</li><li>ApplicationContext.class：当前ApplicationContext对象</li></ol></li></ol></li><li><ol><li>添加一个Bean的后置处理器：ApplicationListenerDetector，是一个BeanPostProcessor，用来判断某个Bean是不是ApplicationListener，如果是则把这个Bean添加到ApplicationContext中去，注意一个ApplicationListener只能是单例的</li><li>添加一个Bean的后置处理器：LoadTimeWeaverAwareProcessor，是一个BeanPostProcessor，用来判断某个Bean是不是实现了LoadTimeWeaverAware接口，如果实现了则把ApplicationContext中的loadTimeWeaver回调setLoadTimeWeaver方法设置给该Bean。</li><li>添加一些单例bean到单例池：</li></ol></li><li><ol><li><ol><li>“environment”：Environment对象</li><li>“systemProperties”：System.getProperties()返回的Map对象</li><li>“systemEnvironment”：System.getenv()返回的Map对象</li></ol></li></ol></li><li><p>postProcessBeanFactory(beanFactory) ： 提供给AbstractApplicationContext的子类进行扩展，具体的子类，可以继续向BeanFactory中再添加一些东西</p></li><li><p>invokeBeanFactoryPostProcessors(beanFactory)：<strong>执行BeanFactoryPostProcessor</strong></p></li><li><ol><li>此时在BeanFactory中会存在一个BeanFactoryPostProcessor：<strong>ConfigurationClassPostProcessor</strong>，它也是一个<strong>BeanDefinitionRegistryPostProcessor</strong></li><li><strong>第一阶段</strong></li><li>从BeanFactory中找到类型为BeanDefinitionRegistryPostProcessor的beanName，也就是<strong>ConfigurationClassPostProcessor</strong>， 然后调用BeanFactory的getBean方法得到实例对象</li><li>执行*<em>ConfigurationClassPostProcessor的</em>***postProcessBeanDefinitionRegistry()**方法:</li></ol></li><li><ol><li><ol><li>解析AppConfig类</li><li>扫描得到BeanDefinition并注册</li><li>解析@Import，@Bean等注解得到BeanDefinition并注册</li><li>详细的看另外的笔记，专门分析了<strong>ConfigurationClassPostProcessor是如何工作的</strong></li><li>在这里，我们只需要知道在这一步会去得到BeanDefinition，而这些BeanDefinition中可能存在BeanFactoryPostProcessor和BeanDefinitionRegistryPostProcessor，所以执行完ConfigurationClassPostProcessor的postProcessBeanDefinitionRegistry()方法后，还需要继续执行其他BeanDefinitionRegistryPostProcessor的postProcessBeanDefinitionRegistry()方法</li></ol></li></ol></li><li><ol><li>执行其他BeanDefinitionRegistryPostProcessor的**postProcessBeanDefinitionRegistry()**方法</li><li>执行所有BeanDefinitionRegistryPostProcessor的**postProcessBeanFactory()**方法</li><li><strong>第二阶段</strong></li><li>从BeanFactory中找到类型为BeanFactoryPostProcessor的beanName，而这些BeanFactoryPostProcessor包括了上面的BeanDefinitionRegistryPostProcessor</li><li>执行还没有执行过的BeanFactoryPostProcessor的**postProcessBeanFactory()**方法</li></ol></li><li><p>到此，所有的BeanFactoryPostProcessor的逻辑都执行完了，主要做的事情就是得到BeanDefinition并注册到BeanFactory中</p></li><li><p>registerBeanPostProcessors(beanFactory)：因为上面的步骤完成了扫描，这个过程中程序员可能自己定义了一些BeanPostProcessor，在这一步就会把BeanFactory中所有的BeanPostProcessor找出来并实例化得到一个对象，并添加到BeanFactory中去（属性<strong>beanPostProcessors</strong>），最后再重新添加一个ApplicationListenerDetector对象（之前其实就添加了过，这里是为了把ApplicationListenerDetector移动到最后）</p></li><li><p>initMessageSource()：如果BeanFactory中存在一个叫做”<strong>messageSource</strong>“的BeanDefinition，那么就会把这个Bean对象创建出来并赋值给ApplicationContext的messageSource属性，让ApplicationContext拥有<strong>国际化</strong>的功能</p></li><li><p>initApplicationEventMulticaster()：如果BeanFactory中存在一个叫做”<strong>applicationEventMulticaster</strong>“的BeanDefinition，那么就会把这个Bean对象创建出来并赋值给ApplicationContext的applicationEventMulticaster属性，让ApplicationContext拥有<strong>事件发布</strong>的功能</p></li><li><p>onRefresh()：提供给AbstractApplicationContext的子类进行扩展，没用</p></li><li><p>registerListeners()：从BeanFactory中获取ApplicationListener类型的beanName，然后添加到ApplicationContext中的事件广播器<strong>applicationEventMulticaster</strong>中去，到这一步因为FactoryBean还没有调用getObject()方法生成Bean对象，所以这里要在根据类型找一下ApplicationListener，记录一下对应的beanName</p></li><li><p>finishBeanFactoryInitialization(beanFactory)：完成BeanFactory的初始化，主要就是<strong>实例化非懒加载的单例Bean</strong>，单独的笔记去讲。</p></li><li><p>finishRefresh()：BeanFactory的初始化完后，就到了Spring启动的最后一步了</p></li><li><ol><li>设置ApplicationContext的lifecycleProcessor，默认情况下设置的是DefaultLifecycleProcessor</li><li>调用lifecycleProcessor的onRefresh()方法，如果是DefaultLifecycleProcessor，那么会获取所有类型为Lifecycle的Bean对象，然后调用它的start()方法，这就是ApplicationContext的生命周期扩展机制</li><li>发布<strong>ContextRefreshedEvent</strong>事件</li></ol></li></ol><h2 id="执行BeanFactoryPostProcessor"><a href="#执行BeanFactoryPostProcessor" class="headerlink" title="执行BeanFactoryPostProcessor"></a>执行BeanFactoryPostProcessor</h2><ol><li>执行通过ApplicationContext添加进来的BeanDefinitionRegistryPostProcessor的postProcessBeanDefinitionRegistry()方法</li><li>执行BeanFactory中实现了PriorityOrdered接口的BeanDefinitionRegistryPostProcessor的postProcessBeanDefinitionRegistry()方法</li><li>执行BeanFactory中实现了Ordered接口的BeanDefinitionRegistryPostProcessor的postProcessBeanDefinitionRegistry()方法</li><li>执行BeanFactory中其他的BeanDefinitionRegistryPostProcessor的postProcessBeanDefinitionRegistry()方法</li><li>执行上面所有的BeanDefinitionRegistryPostProcessor的postProcessBeanFactory()方法</li><li>执行通过ApplicationContext添加进来的BeanFactoryPostProcessor的postProcessBeanFactory()方法</li><li>执行BeanFactory中实现了PriorityOrdered接口的BeanFactoryPostProcessor的postProcessBeanFactory()方法</li><li>执行BeanFactory中实现了Ordered接口的BeanFactoryPostProcessor的postProcessBeanFactory()方法</li><li>执行BeanFactory中其他的BeanFactoryPostProcessor的postProcessBeanFactory()方法</li></ol><h2 id="Lifecycle的使用"><a href="#Lifecycle的使用" class="headerlink" title="Lifecycle的使用"></a>Lifecycle的使用</h2><p>Lifecycle表示的是ApplicationContext的生命周期，可以定义一个SmartLifecycle来监听ApplicationContext的启动和关闭：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZhouyuLifecycle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SmartLifecycle</span> &#123;<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isRunning</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> &#123;<br>System.out.println(<span class="hljs-string">&quot;启动&quot;</span>);<br>isRunning = <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 要触发stop()，要调用context.close()，或者注册关闭钩子（context.registerShutdownHook();）</span><br>System.out.println(<span class="hljs-string">&quot;停止&quot;</span>);<br>isRunning = <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isRunning</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> isRunning;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>9、Spring之推断构造方法源码解析</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/9%E3%80%81Spring%E4%B9%8B%E6%8E%A8%E6%96%AD%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/9%E3%80%81Spring%E4%B9%8B%E6%8E%A8%E6%96%AD%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p><strong>推断构造方法流程图</strong>：<img src="/9%E3%80%81Spring%E4%B9%8B%E6%8E%A8%E6%96%AD%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20230611170712182.png" alt="image-20230611170712182"></p><p>AutowiredAnnotationBeanPostProcessor中推断构造方法不同情况思维脑图：<img src="/9%E3%80%81Spring%E4%B9%8B%E6%8E%A8%E6%96%AD%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20230611170726681.png" alt="image-20230611170726681"></p><p>Spring中的一个bean，需要实例化得到一个对象，而实例化就需要用到构造方法。</p><p>一般情况下，一个类只有一个构造方法：</p><ol><li>要么是无参的构造方法</li><li>要么是有参的构造方法</li></ol><p>如果只有<strong>一个无参</strong>的构造方法，那么实例化就只能使用这个构造方法了。</p><p>如果只有<strong>一个有参</strong>的构造方法，那么实例化时能使用这个构造方法吗？要分情况讨论：</p><ol><li>使用AnnotationConfigApplicationContext，会使用这个构造方法进行实例化，那么Spring会根据构造方法的参数信息去寻找bean，然后传给构造方法</li><li>使用ClassPathXmlApplicationContext，表示使用XML的方式来使用bean，要么在XML中指定构造方法的参数值(手动指定)，要么配置<strong>autowire&#x3D;constructor</strong>让Spring<strong>自动</strong>去寻找bean做为构造方法参数值。</li></ol><p>上面是只有一个构造方法的情况，那么如果有多个构造方法呢？</p><p>又分为两种情况，多个构造方法中存不存在无参的构造方法。</p><p>分析：一个类存在多个构造方法，那么Spring进行实例化之前，该如何去确定到底用哪个构造方法呢？</p><ol><li>如果开发者指定了想要使用的构造方法，那么就用这个构造方法</li><li>如果开发者没有指定想要使用的构造方法，则看开发者有没有让Spring自动去选择构造方法</li><li>如果开发者也没有让Spring自动去选择构造方法，则Spring利用无参构造方法，如果没有无参构造方法，则报错</li></ol><p>针对第一点，开发者可以通过什么方式来指定使用哪个构造方法呢？</p><ol><li>xml中的<constructor-arg>标签，这个标签表示构造方法参数，所以可以根据这个确定想要使用的构造方法的参数个数，从而确定想要使用的构造方法</li><li>通过@Autowired注解，@Autowired注解可以写在构造方法上，所以哪个构造方法上写了@Autowired注解，表示开发者想使用哪个构造方法，当然，它和第一个方式的不同点是，通过xml的方式，我们直接指定了构造方法的参数值，而通过@Autowired注解的方式，需要Spring通过byType+byName的方式去找到符合条件的bean作为构造方法的参数值</li></ol><p>再来看第二点，如果开发者没有指定想要使用的构造方法，则看开发者有没有让Spring自动去选择构造方法，对于这一点，只能用在ClassPathXmlApplicationContext，因为通过AnnotationConfigApplicationContext没有办法去指定某个bean可以自动去选择构造方法，而通过ClassPathXmlApplicationContext可以在xml中指定某个bean的autowire为constructor，虽然这个属性表示通过构造方法自动注入，所以需要自动的去选择一个构造方法进行自动注入，因为是构造方法，所以顺便是进行实例化。</p><p>当然，还有一种情况，就是多个构造方法上写了@Autowired注解，那么此时Spring会报错。</p><p>但是，因为@Autowired还有一个属性required，默认为ture，所以一个类中，只有能一个构造方法标注了@Autowired或@Autowired（required&#x3D;true），有多个会报错。但是可以有多个@Autowired（required&#x3D;false）,这种情况下，需要Spring从这些构造方法中去自动选择一个构造方法。</p><h2 id="课上总结："><a href="#课上总结：" class="headerlink" title="课上总结："></a>课上总结：</h2><p>1、 默认情况，用无参构造方法，或者只有一个构造方法就用那一个</p><p>2、 程序员指定了构造方法入参值，通过getBean()或者BeanDefinition.getConstructorArgumentValues()指定，那就用所匹配的构造方法</p><p>3、 程序员想让Spring自动选择构造方法以及构造方法的入参值， autowire&#x3D;”constructor”</p><p>4、 程序员通过@Autowired注解指定了某个构造方法，但是希望Spring自动找该构造方法的入参值</p><h2 id="源码思路"><a href="#源码思路" class="headerlink" title="源码思路"></a>源码思路</h2><ol><li>AbstractAutowireCapableBeanFactory类中的createBeanInstance()方法会去创建一个Bean实例</li><li>根据BeanDefinition加载类得到Class对象</li><li>如果BeanDefinition绑定了一个Supplier，那就调用Supplier的get方法得到一个对象并直接返回</li><li>如果BeanDefinition中存在<strong>factoryMethodName</strong>，那么就<strong>调用该工厂方法</strong>得到一个bean对象并返回</li><li>如果BeanDefinition已经自动构造过了，那就调用autowireConstructor()自动构造一个对象</li><li>调用SmartInstantiationAwareBeanPostProcessor的determineCandidateConstructors()方法得到哪些构造方法是可以用的</li><li>如果存在可用得构造方法，或者当前BeanDefinition的autowired是AUTOWIRE_CONSTRUCTOR，或者BeanDefinition中指定了构造方法参数值，或者创建Bean的时候指定了构造方法参数值，那么就调用**autowireConstructor()**方法自动构造一个对象</li><li>最后，如果不是上述情况，就根据无参的构造方法实例化一个对象</li></ol><h3 id="autowireConstructor"><a href="#autowireConstructor" class="headerlink" title="autowireConstructor()"></a><strong>autowireConstructor()</strong></h3><ol><li><p>先检查是否指定了具体的构造方法和构造方法参数值，或者在BeanDefinition中缓存了具体的构造方法或构造方法参数值，如果存在那么则直接使用该构造方法进行实例化</p></li><li><p>如果没有确定的构造方法或构造方法参数值，那么</p></li><li><ol><li>如果没有确定的构造方法，那么则找出类中所有的构造方法</li><li>如果只有一个无参的构造方法，那么直接使用无参的构造方法进行实例化</li><li>如果有多个可用的构造方法或者当前Bean需要自动通过构造方法注入</li><li>根据所指定的构造方法参数值，确定所需要的最少的构造方法参数值的个数</li><li>对所有的构造方法进行排序，参数个数多的在前面</li><li>遍历每个构造方法</li><li>如果不是调用getBean方法时所指定的构造方法参数值，那么则根据构造方法参数类型找值</li><li>如果时调用getBean方法时所指定的构造方法参数值，就直接利用这些值</li><li>如果根据当前构造方法找到了对应的构造方法参数值，那么这个构造方法就是可用的，但是不一定这个构造方法就是最佳的，所以这里会涉及到是否有多个构造方法匹配了同样的值，这个时候就会用值和构造方法类型进行匹配程度的打分，找到一个最匹配的</li></ol></li></ol><h2 id="为什么分越少优先级越高？"><a href="#为什么分越少优先级越高？" class="headerlink" title="为什么分越少优先级越高？"></a>为什么分越少优先级越高？</h2><p>主要是计算找到的bean和构造方法参数类型匹配程度有多高。</p><p>假设bean的类型为A，A的父类是B，B的父类是C，同时A实现了接口D</p><p>如果构造方法的参数类型为A，那么完全匹配，得分为0</p><p>如果构造方法的参数类型为B，那么得分为2</p><p>如果构造方法的参数类型为C，那么得分为4</p><p>如果构造方法的参数类型为D，那么得分为1</p><p>可以直接使用如下代码进行测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">Object[] objects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">A</span>()&#125;;<br><br><span class="hljs-comment">// 0</span><br>System.out.println(MethodInvoker.getTypeDifferenceWeight(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;A.class&#125;, objects));<br><br><span class="hljs-comment">// 2</span><br>System.out.println(MethodInvoker.getTypeDifferenceWeight(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;B.class&#125;, objects));<br><br><span class="hljs-comment">// 4</span><br>System.out.println(MethodInvoker.getTypeDifferenceWeight(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;C.class&#125;, objects));<br><br><span class="hljs-comment">// 1</span><br>System.out.println(MethodInvoker.getTypeDifferenceWeight(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;D.class&#125;, objects));<br></code></pre></td></tr></table></figure><p>所以，我们可以发现，越匹配分数越低。</p><h2 id="Bean的情况"><a href="#Bean的情况" class="headerlink" title="@Bean的情况"></a>@Bean的情况</h2><p>首先，Spring会把@Bean修饰的方法解析成BeanDefinition：</p><ol><li><p>如果方法不是static的，那么解析出来的BeanDefinition中：</p></li><li><ol><li>factoryBeanName为AppConfig所对应的beanName，比如”appConfig”</li><li>factoryMethodName为对应的方法名，比如”aService”</li><li>factoryClass为AppConfig.class</li></ol></li><li><p>如果方法是static的，那么解析出来的BeanDefinition中：</p></li><li><ol><li>factoryBeanName为null</li><li>factoryMethodName为对应的方法名，比如”aService”</li><li>factoryClass也为AppConfig.class</li></ol></li></ol><p>在由@Bean生成的BeanDefinition中，有一个重要的属性isFactoryMethodUnique，表示factoryMethod是不是唯一的，在普通情况下@Bean生成的BeanDefinition的isFactoryMethodUnique为true，但是如果出现了方法重载，那么就是特殊的情况，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AService <span class="hljs-title function_">aService</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AService</span>();<br>&#125;<br><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> AService <span class="hljs-title function_">aService</span><span class="hljs-params">(BService bService)</span>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AService</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>虽然有两个@Bean，但是肯定只会生成一个aService的Bean，那么Spring在处理@Bean时，也只会生成一个aService的BeanDefinition，比如Spring先解析到第一个@Bean，会生成一个BeanDefinition，此时isFactoryMethodUnique为true，但是解析到第二个@Bean时，会判断出来beanDefinitionMap中已经存在一个aService的BeanDefinition了，那么会把之前的这个BeanDefinition的isFactoryMethodUnique修改为false，并且不会生成新的BeanDefinition了。</p><p>并且后续在根据BeanDefinition创建Bean时，会根据isFactoryMethodUnique来操作，如果为true，那就表示当前BeanDefinition只对应了一个方法，那也就是只能用这个方法来创建Bean了，但是如果isFactoryMethodUnique为false，那就表示当前BeanDefition对应了多个方法，需要和推断构造方法的逻辑一样，去选择用哪个方法来创建Bean。</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>8、Spring之循环依赖底层源码解析</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/8%E3%80%81Spring%E4%B9%8B%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/8%E3%80%81Spring%E4%B9%8B%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="什么是循环依赖？"><a href="#什么是循环依赖？" class="headerlink" title="什么是循环依赖？"></a>什么是循环依赖？</h2><p>很简单，就是A对象依赖了B对象，B对象依赖了A对象。</p><p>比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// A依赖了B</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>&#123;<br><span class="hljs-keyword">public</span> B b;<br>&#125;<br><br><span class="hljs-comment">// B依赖了A</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span>&#123;<br><span class="hljs-keyword">public</span> A a;<br>&#125;<br></code></pre></td></tr></table></figure><p>那么循环依赖是个问题吗？</p><p>如果不考虑Spring，循环依赖并不是问题，因为对象之间相互依赖是很正常的事情。</p><p>比如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">A</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">A</span>();<br><span class="hljs-type">B</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">B</span>();<br><br>a.b = b;<br>b.a = a;<br></code></pre></td></tr></table></figure><p>这样，A,B就依赖上了。</p><p>但是，在Spring中循环依赖就是一个问题了，为什么？</p><p>因为，在Spring中，一个对象并不是简单new出来了，而是会经过一系列的Bean的生命周期，就是因为Bean的生命周期所以才会出现循环依赖问题。当然，在Spring中，出现循环依赖的场景很多，有的场景Spring自动帮我们解决了，而有的场景则需要程序员来解决，下文详细来说。</p><p>要明白Spring中的循环依赖，得先明白Spring中Bean的生命周期。</p><h2 id="Bean的生命周期"><a href="#Bean的生命周期" class="headerlink" title="Bean的生命周期"></a>Bean的生命周期</h2><p>这里不会对Bean的生命周期进行详细的描述，只描述一下大概的过程。</p><p>Bean的生命周期指的就是：在Spring中，Bean是如何生成的？</p><p>被Spring管理的对象叫做Bean。Bean的生成步骤如下：</p><ol><li>Spring扫描class得到BeanDefinition</li><li>根据得到的BeanDefinition去生成bean</li><li>首先根据class推断构造方法</li><li>根据推断出来的构造方法，反射，得到一个对象（暂时叫做原始对象）</li><li>填充原始对象中的属性（依赖注入）</li><li>如果原始对象中的某个方法被AOP了，那么则需要根据原始对象生成一个代理对象</li><li>把最终生成的代理对象放入单例池（源码中叫做singletonObjects）中，下次getBean时就直接从单例池拿即可</li></ol><p>可以看到，对于Spring中的Bean的生成过程，步骤还是很多的，并且不仅仅只有上面的7步，还有很多很多，比如Aware回调、初始化等等，这里不详细讨论。</p><p>可以发现，在Spring中，构造一个Bean，包括了new这个步骤（第4步构造方法反射）。</p><p>得到一个原始对象后，Spring需要给对象中的属性进行依赖注入，那么这个注入过程是怎样的？</p><p>比如上文说的A类，A类中存在一个B类的b属性，所以，当A类生成了一个原始对象之后，就会去给b属性去赋值，此时就会根据b属性的类型和属性名去BeanFactory中去获取B类所对应的单例bean。如果此时BeanFactory中存在B对应的Bean，那么直接拿来赋值给b属性；如果此时BeanFactory中不存在B对应的Bean，则需要生成一个B对应的Bean，然后赋值给b属性。</p><p>问题就出现在第二种情况，如果此时B类在BeanFactory中还没有生成对应的Bean，那么就需要去生成，就会经过B的Bean的生命周期。</p><p>那么在创建B类的Bean的过程中，如果B类中存在一个A类的a属性，那么在创建B的Bean的过程中就需要A类对应的Bean，但是，触发B类Bean的创建的条件是A类Bean在创建过程中的依赖注入，所以这里就出现了循环依赖：</p><p>ABean创建–&gt;依赖了B属性–&gt;触发BBean创建—&gt;B依赖了A属性—&gt;需要ABean（但ABean还在创建过程中）</p><p>从而导致ABean创建不出来，BBean也创建不出来。</p><p>这是循环依赖的场景，但是上文说了，在Spring中，通过某些机制帮开发者解决了部分循环依赖的问题，这个机制就是<strong>三级缓存</strong>。</p><h2 id="三级缓存"><a href="#三级缓存" class="headerlink" title="三级缓存"></a>三级缓存</h2><p>三级缓存是通用的叫法。</p><p>一级缓存为：<strong>singletonObjects</strong></p><p>二级缓存为：<strong>earlySingletonObjects</strong></p><p>三级缓存为<strong>：****singletonFactories</strong></p><p><strong>先稍微解释一下这三个缓存的作用，后面详细分析：</strong></p><ul><li><strong>singletonObjects</strong>中缓存的是已经经历了完整生命周期的bean对象。</li><li><strong>earlySingletonObjects</strong>比singletonObjects多了一个early，表示缓存的是早期的bean对象。早期是什么意思？表示Bean的生命周期还没走完就把这个Bean放入了earlySingletonObjects。</li><li><strong>singletonFactories</strong>中缓存的是ObjectFactory，表示对象工厂，表示用来创建早期bean对象的工厂。</li></ul><h2 id="解决循环依赖思路分析"><a href="#解决循环依赖思路分析" class="headerlink" title="解决循环依赖思路分析"></a>解决循环依赖思路分析</h2><p>先来分析为什么缓存能解决循环依赖。</p><p>上文分析得到，之所以产生循环依赖的问题，主要是：</p><p>A创建时—&gt;需要B—-&gt;B去创建—&gt;需要A，从而产生了循环</p><p><img src="/8%E3%80%81Spring%E4%B9%8B%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/1592471211638-86636131-146d-46c3-8775-421ef3322cc3.png" alt="img"></p><p>那么如何打破这个循环，加个中间人（缓存）</p><p><img src="/8%E3%80%81Spring%E4%B9%8B%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/1592471597769-3e23cc26-2b1d-4742-8c74-cea46327ada7.png" alt="img"></p><p>A的Bean在创建过程中，在进行依赖注入之前，先把A的原始Bean放入缓存（提早暴露，只要放到缓存了，其他Bean需要时就可以从缓存中拿了），放入缓存后，再进行依赖注入，此时A的Bean依赖了B的Bean，如果B的Bean不存在，则需要创建B的Bean，而创建B的Bean的过程和A一样，也是先创建一个B的原始对象，然后把B的原始对象提早暴露出来放入缓存中，然后在对B的原始对象进行依赖注入A，此时能从缓存中拿到A的原始对象（虽然是A的原始对象，还不是最终的Bean），B的原始对象依赖注入完了之后，B的生命周期结束，那么A的生命周期也能结束。</p><p>因为整个过程中，都只有一个A原始对象，所以对于B而言，就算在属性注入时，注入的是A原始对象，也没有关系，因为A原始对象在后续的生命周期中在堆中没有发生变化。</p><p>从上面这个分析过程中可以得出，只需要一个缓存就能解决循环依赖了，那么为什么Spring中还需要<strong>singletonFactories</strong>呢？</p><p>这是难点，基于上面的场景想一个问题：如果A的原始对象注入给B的属性之后，A的原始对象进行了AOP产生了一个代理对象，此时就会出现，对于A而言，它的Bean对象其实应该是AOP之后的代理对象，而B的a属性对应的并不是AOP之后的代理对象，这就产生了冲突。</p><p><strong>B依赖的A和最终的A不是同一个对象</strong>。</p><p>AOP就是通过一个BeanPostProcessor来实现的，这个BeanPostProcessor就是AnnotationAwareAspectJAutoProxyCreator，它的父类是AbstractAutoProxyCreator，而在Spring中AOP利用的要么是JDK动态代理，要么CGLib的动态代理，所以如果给一个类中的某个方法设置了切面，那么这个类最终就需要生成一个代理对象。</p><p>一般过程就是：A类—&gt;生成一个普通对象–&gt;属性注入–&gt;基于切面生成一个代理对象–&gt;把代理对象放入singletonObjects单例池中。</p><p>而AOP可以说是Spring中除开IOC的另外一大功能，而循环依赖又是属于IOC范畴的，所以这两大功能想要并存，Spring需要特殊处理。</p><p>如何处理的，就是利用了第三级缓存<strong>singletonFactories</strong>。</p><p>首先，singletonFactories中存的是某个beanName对应的ObjectFactory，在bean的生命周期中，生成完原始对象之后，就会构造一个ObjectFactory存入singletonFactories中。这个ObjectFactory是一个函数式接口，所以支持Lambda表达式：**() -&gt; getEarlyBeanReference(<strong><strong>beanName</strong></strong>,** <strong>mbd</strong><strong>,</strong> <strong>bean</strong><strong>)</strong></p><p>上面的Lambda表达式就是一个ObjectFactory，执行该Lambda表达式就会去执行getEarlyBeanReference方法，而该方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getEarlyBeanReference</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, Object bean)</span> &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">exposedObject</span> <span class="hljs-operator">=</span> bean;<br><span class="hljs-keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;<br><span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;<br><span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> SmartInstantiationAwareBeanPostProcessor) &#123;<br><span class="hljs-type">SmartInstantiationAwareBeanPostProcessor</span> <span class="hljs-variable">ibp</span> <span class="hljs-operator">=</span> (SmartInstantiationAwareBeanPostProcessor) bp;<br>exposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> exposedObject;<br>&#125;<br></code></pre></td></tr></table></figure><p>该方法会去执行SmartInstantiationAwareBeanPostProcessor中的getEarlyBeanReference方法，而这个接口下的实现类中只有两个类实现了这个方法，一个是AbstractAutoProxyCreator，一个是InstantiationAwareBeanPostProcessorAdapter，它的实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// InstantiationAwareBeanPostProcessorAdapter</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getEarlyBeanReference</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// AbstractAutoProxyCreator</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getEarlyBeanReference</span><span class="hljs-params">(Object bean, String beanName)</span> &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> getCacheKey(bean.getClass(), beanName);<br><span class="hljs-built_in">this</span>.earlyProxyReferences.put(cacheKey, bean);<br><span class="hljs-keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);<br>&#125;<br></code></pre></td></tr></table></figure><p>在整个Spring中，默认就只有AbstractAutoProxyCreator真正意义上实现了getEarlyBeanReference方法，而该类就是用来进行AOP的。上文提到的AnnotationAwareAspectJAutoProxyCreator的父类就是AbstractAutoProxyCreator。</p><p>那么getEarlyBeanReference方法到底在干什么？</p><p>首先得到一个cachekey，cachekey就是beanName。</p><p>然后把beanName和bean（这是原始对象）存入earlyProxyReferences中</p><p>调用wrapIfNecessary进行AOP，得到一个代理对象。</p><p>那么，什么时候会调用getEarlyBeanReference方法呢？回到循环依赖的场景中</p><img src="8%E3%80%81Spring%E4%B9%8B%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/1592539097062-7912a20c-f209-47bd-bdc0-d6d4485ab395.png" alt="img" style="zoom: 200%;" /><p><strong>左边文字</strong>：</p><p>这个ObjectFactory就是上文说的labmda表达式，中间有getEarlyBeanReference方法，注意存入singletonFactories时并不会执行lambda表达式，也就是不会执行getEarlyBeanReference方法</p><p><strong>右边文字</strong>：</p><p>从singletonFactories根据beanName得到一个ObjectFactory，然后执行ObjectFactory，也就是执行getEarlyBeanReference方法，此时会得到一个A原始对象经过AOP之后的代理对象，然后把该代理对象放入earlySingletonObjects中，注意此时并没有把代理对象放入singletonObjects中，那什么时候放入到singletonObjects中呢？</p><p>我们这个时候得来理解一下earlySingletonObjects的作用，此时，我们只得到了A原始对象的代理对象，这个对象还不完整，因为A原始对象还没有进行属性填充，所以此时不能直接把A的代理对象放入singletonObjects中，所以只能把代理对象放入earlySingletonObjects，假设现在有其他对象依赖了A，那么则可以从earlySingletonObjects中得到A原始对象的代理对象了，并且是A的同一个代理对象。</p><p>当B创建完了之后，A继续进行生命周期，而A在完成属性注入后，会按照它本身的逻辑去进行AOP，而此时我们知道A原始对象已经经历过了AOP，所以对于A本身而言，不会再去进行AOP了，那么怎么判断一个对象是否经历过了AOP呢？会利用上文提到的earlyProxyReferences，在AbstractAutoProxyCreator的postProcessAfterInitialization方法中，会去判断当前beanName是否在earlyProxyReferences，如果在则表示已经提前进行过AOP了，无需再次进行AOP。</p><p>对于A而言，进行了AOP的判断后，以及BeanPostProcessor的执行之后，就需要把A对应的对象放入singletonObjects中了，但是我们知道，应该是要把A的代理对象放入singletonObjects中，所以此时需要从earlySingletonObjects中得到代理对象，然后入singletonObjects中。</p><p><strong>整个循环依赖解决完毕。</strong></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此，总结一下三级缓存：</p><ol><li><strong>singletonObjects</strong>：缓存经过了<strong>完整生命周期</strong>的bean</li><li><strong>earlySingletonObjects</strong>：缓存<strong>未经过完整生命周期的bean</strong>，如果某个bean出现了循环依赖，就会<strong>提前</strong>把这个暂时未经过完整生命周期的bean放入earlySingletonObjects中，这个bean如果要经过AOP，那么就会把代理对象放入earlySingletonObjects中，否则就是把原始对象放入earlySingletonObjects，但是不管怎么样，就是是代理对象，代理对象所代理的原始对象也是没有经过完整生命周期的，所以放入earlySingletonObjects我们就可以统一认为是<strong>未经过完整生命周期的bean。</strong></li><li><strong>singletonFactories</strong>：缓存的是一个ObjectFactory，也就是一个Lambda表达式。在每个Bean的生成过程中，经过<strong>实例化</strong>得到一个原始对象后，都会提前基于原始对象暴露一个Lambda表达式，并保存到三级缓存中，这个Lambda表达式<strong>可能用到，也可能用不到</strong>，如果当前Bean没有出现循环依赖，那么这个Lambda表达式没用，当前bean按照自己的生命周期正常执行，执行完后直接把当前bean放入singletonObjects中，如果当前bean在依赖注入时发现出现了循环依赖（当前正在创建的bean被其他bean依赖了），则从三级缓存中拿到Lambda表达式，并执行Lambda表达式得到一个对象，并把得到的对象放入二级缓存（(如果当前Bean需要AOP，那么执行lambda表达式，得到就是对应的代理对象，如果无需AOP，则直接得到一个原始对象)）。</li><li>其实还要一个缓存，就是<strong>earlyProxyReferences</strong>，它用来记录某个原始对象是否进行过AOP了。</li></ol><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="反向分析一下singletonFactories"><a href="#反向分析一下singletonFactories" class="headerlink" title="反向分析一下singletonFactories"></a>反向分析一下singletonFactories</h3><p>为什么需要<strong>singletonFactories</strong>？假设没有<strong>singletonFactories</strong>，只有<strong>earlySingletonObjects</strong>，earlySingletonObjects是二级缓存，它内部存储的是为经过完整生命周期的bean对象，Spring原有的流程是出现了循环依赖的情况下：</p><ol><li>先从singletonFactories中拿到lambda表达式，这里肯定是能拿到的，因为每个bean<strong>实例化之后</strong>，<strong>依赖注入之前</strong>，就会生成一个lambda表示放入singletonFactories中</li><li>执行lambda表达式，得到结果，将结果放入earlySingletonObjects中</li></ol><p>那如果没有singletonFactories，该如何把原始对象或AOP之后的代理对象放入earlySingletonObjects中呢？何时放入呢？</p><p>首先，将原始对象或AOP之后的代理对象放入earlySingletonObjects中的有两种：</p><ol><li>实例化之后，依赖注入之前：如果是这样，那么对于每个bean而言，都是在依赖注入之前会去进行AOP，这是不符合bean生命周期步骤的设计的。</li><li>真正发现某个bean出现了循环依赖时：按现在Spring源码的流程来说，就是getSingleton(String beanName, boolean allowEarlyReference)中，是在这个方法中判断出来了当前获取的这个bean在创建中，就表示获取的这个bean出现了循环依赖，那在这个方法中该如何拿到原始对象呢？更加重要的是，该如何拿到AOP之后的代理对象呢？难道在这个方法中去循环调用BeanPostProcessor的初始化后的方法吗？不是做不到，不太合适，代码太丑。<strong>最关键的是在这个方法中该如何拿到原始对象呢？</strong>还是得需要一个Map，预习把这个Bean实例化后的对象存在这个Map中，那这样的话还不如直接用第一种方案，但是第一种又直接打破了Bean生命周期的设计。</li></ol><p>所以，我们可以发现，现在Spring所用的singletonFactories，为了调和不同的情况，在singletonFactories中存的是lambda表达式，这样的话，只有在出现了循环依赖的情况，才会执行lambda表达式，才会进行AOP，也就说只有在出现了循环依赖的情况下才会打破Bean生命周期的设计，如果一个Bean没有出现循环依赖，那么它还是遵守了Bean的生命周期的设计的。</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>7、Spring之依赖注入源码解析(下)</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/7%E3%80%81Spring%E4%B9%8B%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%8B)/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/7%E3%80%81Spring%E4%B9%8B%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%8B)/</url>
    
    <content type="html"><![CDATA[<p>上节课我们讲了Spring中的自动注入(byName,byType)和@Autowired注解的工作原理以及源码分析，那么今天这节课，我们来分析还没讲完的，剩下的核心的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br>Object <span class="hljs-title function_">resolveDependency</span><span class="hljs-params">(DependencyDescriptor descriptor, <span class="hljs-meta">@Nullable</span> String requestingBeanName,</span><br><span class="hljs-params"><span class="hljs-meta">@Nullable</span> Set&lt;String&gt; autowiredBeanNames, <span class="hljs-meta">@Nullable</span> TypeConverter typeConverter)</span> <span class="hljs-keyword">throws</span> BeansException;<br></code></pre></td></tr></table></figure><p>该方法表示，传入一个依赖描述（DependencyDescriptor），该方法会根据该依赖描述从BeanFactory中找出对应的唯一的一个Bean对象。</p><p>下面来分析一下<strong>DefaultListableBeanFactory</strong>中<strong>resolveDependency()<strong>方法的具体实现，</strong>具体流程图</strong>：</p><p><a href="https://www.processon.com/view/link/5f8d3c895653bb06ef076688">https://www.processon.com/view/link/5f8d3c895653bb06ef076688</a></p><h2 id="findAutowireCandidates-实现"><a href="#findAutowireCandidates-实现" class="headerlink" title="findAutowireCandidates()实现"></a>findAutowireCandidates()实现</h2><p><strong>根据类型找beanName的底层流程</strong>：<a href="https://www.processon.com/view/link/6135bb430e3e7412ecd5d1f2">https://www.processon.com/view/link/6135bb430e3e7412ecd5d1f2</a></p><p><strong>对应执行流程图为</strong>：<a href="https://www.processon.com/view/link/5f8fdfa8e401fd06fd984f20">https://www.processon.com/view/link/5f8fdfa8e401fd06fd984f20</a></p><ol><li>找出BeanFactory中类型为type的所有的Bean的名字，注意是名字，而不是Bean对象，因为我们可以根据BeanDefinition就能判断和当前type是不是匹配，不用生成Bean对象</li><li>把resolvableDependencies中key为type的对象找出来并添加到result中</li><li>遍历根据type找出的beanName，判断当前beanName对应的Bean是不是能够被自动注入</li><li>先判断beanName对应的BeanDefinition中的autowireCandidate属性，如果为false，表示不能用来进行自动注入，如果为true则继续进行判断</li><li>判断当前type是不是泛型，如果是泛型是会把容器中所有的beanName找出来的，如果是这种情况，那么在这一步中就要获取到泛型的真正类型，然后进行匹配，如果当前beanName和当前泛型对应的真实类型匹配，那么则继续判断</li><li>如果当前DependencyDescriptor上存在@Qualifier注解，那么则要判断当前beanName上是否定义了Qualifier，并且是否和当前DependencyDescriptor上的Qualifier相等，相等则匹配</li><li>经过上述验证之后，当前beanName才能成为一个可注入的，添加到result中</li></ol><h2 id="关于依赖注入中泛型注入的实现"><a href="#关于依赖注入中泛型注入的实现" class="headerlink" title="关于依赖注入中泛型注入的实现"></a>关于依赖注入中泛型注入的实现</h2><p>首先在Java反射中，有一个Type接口，表示类型，具体分类为：</p><ol><li><p>raw types：也就是普通Class</p></li><li><p>parameterized types：对应ParameterizedType接口，泛型类型</p></li><li><p>array types：对应GenericArrayType，泛型数组</p></li><li><p>type variables：对应TypeVariable接口，表示类型变量，也就是所定义的泛型，比如T、K</p></li><li><p>primitive types：基本类型，int、boolean</p></li></ol><p>大家可以好好看看下面代码所打印的结果：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeTest</span>&lt;T&gt; &#123;<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> i;<br><span class="hljs-keyword">private</span> Integer it;<br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] iarray;<br><span class="hljs-keyword">private</span> List list;<br><span class="hljs-keyword">private</span> List&lt;String&gt; slist;<br><span class="hljs-keyword">private</span> List&lt;T&gt; tlist;<br><span class="hljs-keyword">private</span> T t;<br><span class="hljs-keyword">private</span> T[] tarray;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException &#123;<br><br>test(TypeTest.class.getDeclaredField(<span class="hljs-string">&quot;i&quot;</span>));<br>System.out.println(<span class="hljs-string">&quot;=======&quot;</span>);<br>test(TypeTest.class.getDeclaredField(<span class="hljs-string">&quot;it&quot;</span>));<br>System.out.println(<span class="hljs-string">&quot;=======&quot;</span>);<br>test(TypeTest.class.getDeclaredField(<span class="hljs-string">&quot;iarray&quot;</span>));<br>System.out.println(<span class="hljs-string">&quot;=======&quot;</span>);<br>test(TypeTest.class.getDeclaredField(<span class="hljs-string">&quot;list&quot;</span>));<br>System.out.println(<span class="hljs-string">&quot;=======&quot;</span>);<br>test(TypeTest.class.getDeclaredField(<span class="hljs-string">&quot;slist&quot;</span>));<br>System.out.println(<span class="hljs-string">&quot;=======&quot;</span>);<br>test(TypeTest.class.getDeclaredField(<span class="hljs-string">&quot;tlist&quot;</span>));<br>System.out.println(<span class="hljs-string">&quot;=======&quot;</span>);<br>test(TypeTest.class.getDeclaredField(<span class="hljs-string">&quot;t&quot;</span>));<br>System.out.println(<span class="hljs-string">&quot;=======&quot;</span>);<br>test(TypeTest.class.getDeclaredField(<span class="hljs-string">&quot;tarray&quot;</span>));<br><br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(Field field)</span> &#123;<br><br><span class="hljs-keyword">if</span> (field.getType().isPrimitive()) &#123;<br>System.out.println(field.getName() + <span class="hljs-string">&quot;是基本数据类型&quot;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>System.out.println(field.getName() + <span class="hljs-string">&quot;不是基本数据类型&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (field.getGenericType() <span class="hljs-keyword">instanceof</span> ParameterizedType) &#123;<br>System.out.println(field.getName() + <span class="hljs-string">&quot;是泛型类型&quot;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>System.out.println(field.getName() + <span class="hljs-string">&quot;不是泛型类型&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (field.getType().isArray()) &#123;<br>System.out.println(field.getName() + <span class="hljs-string">&quot;是普通数组&quot;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>System.out.println(field.getName() + <span class="hljs-string">&quot;不是普通数组&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (field.getGenericType() <span class="hljs-keyword">instanceof</span> GenericArrayType) &#123;<br>System.out.println(field.getName() + <span class="hljs-string">&quot;是泛型数组&quot;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>System.out.println(field.getName() + <span class="hljs-string">&quot;不是泛型数组&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (field.getGenericType() <span class="hljs-keyword">instanceof</span> TypeVariable) &#123;<br>System.out.println(field.getName() + <span class="hljs-string">&quot;是泛型变量&quot;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>System.out.println(field.getName() + <span class="hljs-string">&quot;不是泛型变量&quot;</span>);<br>&#125;<br><br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>Spring中，但注入点是一个泛型时，也是会进行处理的，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseService</span>&lt;OrderService, StockService&gt; &#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>System.out.println(o);<br>&#125;<br><br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseService</span>&lt;O, S&gt; &#123;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">protected</span> O o;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">protected</span> S s;<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>Spring扫描时发现UserService是一个Bean</li><li>那就取出注入点，也就是BaseService中的两个属性o、s</li><li>接下来需要按注入点类型进行注入，但是o和s都是泛型，所以Spring需要确定o和s的具体类型。</li><li>因为当前正在创建的是UserService的Bean，所以可以通过<code>userService.getClass().getGenericSuperclass().getTypeName()</code>获取到具体的泛型信息，比如<code>com.zhouyu.service.BaseService&lt;com.zhouyu.service.OrderService, com.zhouyu.service.StockService&gt;</code></li><li>然后再拿到UserService的父类BaseService的泛型变量：<code> for (TypeVariable&lt;? extends Class&lt;?&gt;&gt; typeParameter : userService.getClass().getSuperclass().getTypeParameters()) &#123;   System.*out*.println(typeParameter.getName());&#125;</code></li><li>通过上面两段代码，就能知道，o对应的具体就是OrderService，s对应的具体类型就是StockService</li><li>然后再调用<code>oField.getGenericType()</code>就知道当前field使用的是哪个泛型，就能知道具体类型了</li></ol><h2 id="Qualifier的使用"><a href="#Qualifier的使用" class="headerlink" title="@Qualifier的使用"></a>@Qualifier的使用</h2><p>定义两个注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(&#123;ElementType.TYPE, ElementType.FIELD&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Qualifier(&quot;random&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Random &#123;<br>&#125;<br><span class="hljs-meta">@Target(&#123;ElementType.TYPE, ElementType.FIELD&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Qualifier(&quot;roundRobin&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> RoundRobin &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义一个接口和两个实现类，表示负载均衡：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LoadBalance</span> &#123;<br>String <span class="hljs-title function_">select</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Random</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RandomStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LoadBalance</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">select</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@RoundRobin</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoundRobinStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LoadBalance</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">select</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>使用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span>  &#123;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-meta">@RoundRobin</span><br><span class="hljs-keyword">private</span> LoadBalance loadBalance;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>System.out.println(loadBalance);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Resource"><a href="#Resource" class="headerlink" title="@Resource"></a>@Resource</h2><p>@Resource注解底层工作流程图：<img src="/7%E3%80%81Spring%E4%B9%8B%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%8B)/image-20230611170518356.png" alt="image-20230611170518356"></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6、Spring之依赖注入源码解析</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/6%E3%80%81Spring%E4%B9%8B%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%8A)/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/6%E3%80%81Spring%E4%B9%8B%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%8A)/</url>
    
    <content type="html"><![CDATA[<p>依赖注入底层原理流程图：<img src="/6%E3%80%81Spring%E4%B9%8B%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%8A)/image-20230611170400579.png" alt="image-20230611170400579"></p><h2 id="Spring中到底有几种依赖注入的方式？"><a href="#Spring中到底有几种依赖注入的方式？" class="headerlink" title="Spring中到底有几种依赖注入的方式？"></a>Spring中到底有几种依赖注入的方式？</h2><p>首先分两种：</p><ol><li>手动注入</li><li>自动注入</li></ol><h3 id="手动注入"><a href="#手动注入" class="headerlink" title="手动注入"></a>手动注入</h3><p>在XML中定义Bean时，就是手动注入，因为是<strong>程序员<strong><strong>手动</strong></strong>给某个属性指定了值</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;bean name=<span class="hljs-string">&quot;userService&quot;</span> class=<span class="hljs-string">&quot;com.luban.service.UserService&quot;</span>&gt;<br>&lt;property name=<span class="hljs-string">&quot;orderService&quot;</span> ref=<span class="hljs-string">&quot;orderService&quot;</span>/&gt;<br>&lt;/bean&gt;<br></code></pre></td></tr></table></figure><p>上面这种底层是通过<strong>set方法</strong>进行注入。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;bean name=<span class="hljs-string">&quot;userService&quot;</span> class=<span class="hljs-string">&quot;com.luban.service.UserService&quot;</span>&gt;<br>&lt;constructor-arg index=<span class="hljs-string">&quot;0&quot;</span> ref=<span class="hljs-string">&quot;orderService&quot;</span>/&gt;<br>&lt;/bean&gt;<br></code></pre></td></tr></table></figure><p>上面这种底层是通过<strong>构造方法</strong>进行注入。</p><p>所以手动注入的底层也就是分为两种：</p><ol><li>set方法注入</li><li>构造方法注入</li></ol><h3 id="自动注入"><a href="#自动注入" class="headerlink" title="自动注入"></a>自动注入</h3><p>自动注入又分为两种：</p><ol><li>XML的autowire自动注入</li><li>@Autowired注解的自动注入</li></ol><h3 id="XML的autowire自动注入"><a href="#XML的autowire自动注入" class="headerlink" title="XML的autowire自动注入"></a>XML的autowire自动注入</h3><p>在XML中，我们可以在定义一个Bean时去指定这个Bean的自动注入模式：</p><ol><li>byType</li><li>byName</li><li>constructor</li><li>default</li><li>no</li></ol><p>比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;bean id=<span class="hljs-string">&quot;userService&quot;</span> class=<span class="hljs-string">&quot;com.luban.service.UserService&quot;</span> autowire=<span class="hljs-string">&quot;byType&quot;</span>/&gt;<br></code></pre></td></tr></table></figure><p>这么写，表示Spring会自动的给userService中所有的属性自动赋值（<strong>不需要</strong>这个属性上有@Autowired注解，但需要这个属性有对应的<strong>set方法</strong>）。</p><p>在创建Bean的过程中，在填充属性时，Spring会去解析当前类，把<strong>当前类的所有****方法</strong>都解析出来，Spring会去解析每个方法得到对应的PropertyDescriptor对象，PropertyDescriptor中有几个属性：</p><ol><li><p><strong>name：这个name并不是方法的名字，而是拿方法名字进过处理后的名字</strong></p></li><li><ol><li><strong>如果方法名字以“get”开头，比如“getXXX”,那么name&#x3D;XXX</strong></li><li><strong>如果方法名字以“is”开头，比如“isXXX”,那么name&#x3D;XXX</strong></li><li><strong>如果方法名字以“set”开头，比如“setXXX”,那么name&#x3D;XXX</strong></li></ol></li><li><p><strong>readMethodRef：表示get方法的Method对象的引用</strong></p></li><li><p><strong>readMethodName：表示get方法的名字</strong></p></li><li><p><strong>writeMethodRef：****表示set方法的Method对象的引用</strong></p></li><li><p><strong>writeMethodName：****表示set方法的名字</strong></p></li><li><p><strong>propertyTypeRef：如果有get方法那么对应的就是返回值的类型，如果是set方法那么对应的就是set方法中唯一参数的类型</strong></p></li></ol><p><strong>get方法的定义是：</strong> 方法参数个数为0个，并且 （方法名字以”get”开头 或者 方法名字以”is”开头并且方法的返回类型为boolean）</p><p><strong>set方法的定义是：</strong>方法参数个数为1个，并且 （方法名字以”set”开头并且方法返回类型为void）</p><p>所以，Spring在通过byName的自动填充属性时流程是：</p><ol><li>找到所有set方法所对应的XXX部分的名字</li><li>根据XXX部分的名字去获取bean</li></ol><p>Spring在通过byType的自动填充属性时流程是：</p><ol><li>获取到set方法中的唯一参数的参数类型，并且根据该类型去容器中获取bean</li><li>如果找到多个，会报错。</li></ol><p>以上，分析了autowire的byType和byName情况，那么接下来分析constructor，constructor表示通过构造方法注入，其实这种情况就比较简单了，没有byType和byName那么复杂。</p><p>如果是constructor，那么就可以不写set方法了，当某个bean是通过构造方法来注入时，spring利用构造方法的参数信息从Spring容器中去找bean，找到bean之后作为参数传给构造方法，从而实例化得到一个bean对象，并完成属性赋值（属性赋值的代码得程序员来写）。</p><p>我们这里先不考虑一个类有多个构造方法的情况，后面单独讲<strong>推断构造方法</strong>。我们这里只考虑只有一个有参构造方法。</p><p>其实构造方法注入相当于byType+byName，普通的byType是根据set方法中的参数类型去找bean，找到多个会报错，而constructor就是通过构造方法中的参数类型去找bean，如果找到多个会根据参数名确定。</p><p>另外两个：</p><ol><li>no，表示关闭autowire</li><li>default，表示默认值，我们一直演示的某个bean的autowire，而也可以直接在<beans>标签中设置autowire，如果设置了，那么<bean>标签中设置的autowire如果为default，那么则会用<beans>标签中设置的autowire。</li></ol><p>可以发现XML中的自动注入是挺强大的，那么问题来了，<strong>为什么我们平时都是用的@Autowired注解呢？而没有用上文说的这种自动注入方式呢？</strong></p><p>@Autowired注解相当于XML中的autowire属性的<strong>注解方式的替代</strong>。这是在官网上有提到的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Essentially, the <span class="hljs-meta">@Autowired</span> annotation provides the same capabilities as described in Autowiring Collaborators but with more fine-grained control and wider applicability<br></code></pre></td></tr></table></figure><p>翻译一下：</p><p>从本质上讲，@Autowired注解提供了与autowire相同的功能，但是拥有更细粒度的控制和更广泛的适用性。</p><p>注意：<strong>更细粒度的控制</strong>。</p><p>XML中的autowire控制的是整个bean的所有属性，而@Autowired注解是直接写在某个属性、某个set方法、某个构造方法上的。</p><p>再举个例子，如果一个类有多个构造方法，那么如果用XML的autowire&#x3D;constructor，你无法控制到底用哪个构造方法，而你可以用@Autowired注解来直接指定你想用哪个构造方法。</p><p>同时，用@Autowired注解，还可以控制，哪些属性想被自动注入，哪些属性不想，这也是细粒度的控制。</p><p>但是@Autowired无法区分byType和byName，@Autowired是先byType，如果找到多个则byName。</p><p>那么XML的自动注入底层其实也就是:</p><ol><li>set方法注入</li><li>构造方法注入</li></ol><h3 id="Autowired注解的自动注入"><a href="#Autowired注解的自动注入" class="headerlink" title="@Autowired注解的自动注入"></a>@Autowired注解的自动注入</h3><p>上文说了@Autowired注解，是byType和byName的结合。</p><p>@Autowired注解可以写在：</p><ol><li>属性上：先根据<strong>属性类型</strong>去找Bean，如果找到多个再根据<strong>属性名</strong>确定一个</li><li>构造方法上：先根据方法<strong>参数类型</strong>去找Bean，如果找到多个再根据<strong>参数名</strong>确定一个</li><li>set方法上：先根据方法<strong>参数类型</strong>去找Bean，如果找到多个再根据<strong>参数名</strong>确定一个</li></ol><p>而这种底层到了：</p><ol><li>属性注入</li><li>set方法注入</li><li>构造方法注入</li></ol><h2 id="寻找注入点"><a href="#寻找注入点" class="headerlink" title="寻找注入点"></a>寻找注入点</h2><p>在创建一个Bean的过程中，Spring会利用AutowiredAnnotationBeanPostProcessor的**postProcessMergedBeanDefinition()**找出注入点并缓存，找注入点的流程为：</p><ol><li>遍历当前类的所有的属性字段Field</li><li>查看字段上是否存在@Autowired、@Value、@Inject中的其中任意一个，存在则认为该字段是一个注入点</li><li>如果字段是static的，则不进行注入</li><li>获取@Autowired中的required属性的值</li><li>将字段信息构造成一个<strong>AutowiredFieldElement对象</strong>，作为一个<strong>注入点对象</strong>添加到currElements集合中。</li><li>遍历当前类的所有方法Method</li><li>判断当前Method是否是<strong>桥接方法</strong>，如果是找到原方法</li><li>查看方法上是否存在@Autowired、@Value、@Inject中的其中任意一个，存在则认为该方法是一个注入点</li><li>如果方法是static的，则不进行注入</li><li>获取@Autowired中的required属性的值</li><li>将方法信息构造成一个<strong>AutowiredMethodElement对象</strong>，作为一个<strong>注入点对象</strong>添加到currElements集合中。</li><li>遍历完当前类的字段和方法后，将<strong>遍历父类</strong>的，直到没有父类。</li><li>最后将currElements集合封装成一个InjectionMetadata对象，作为当前Bean对于的注入点集合对象，并缓存。</li></ol><h3 id="static的字段或方法为什么不支持"><a href="#static的字段或方法为什么不支持" class="headerlink" title="static的字段或方法为什么不支持"></a>static的字段或方法为什么不支持</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Scope(&quot;prototype&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> &#123;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Scope(&quot;prototype&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span>  &#123;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> OrderService orderService;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>System.out.println(<span class="hljs-string">&quot;test123&quot;</span>);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>看上面代码，UserService和OrderService都是原型Bean，假设Spring支持static字段进行自动注入，那么现在调用两次</p><ol><li>UserService userService1 &#x3D; context.getBean(“userService”)</li><li>UserService userService2 &#x3D; context.getBean(“userService”)</li></ol><p>问此时，userService1的orderService值是什么？还是它自己注入的值吗？</p><p>答案是不是，一旦userService2 创建好了之后，static orderService字段的值就发生了修改了，从而出现bug。</p><h3 id="桥接方法"><a href="#桥接方法" class="headerlink" title="桥接方法"></a>桥接方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserInterface</span>&lt;T&gt; &#123;<br><span class="hljs-keyword">void</span> <span class="hljs-title function_">setOrderService</span><span class="hljs-params">(T t)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserInterface</span>&lt;OrderService&gt; &#123;<br><br><span class="hljs-keyword">private</span> OrderService orderService;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setOrderService</span><span class="hljs-params">(OrderService orderService)</span> &#123;<br><span class="hljs-built_in">this</span>.orderService = orderService;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>System.out.println(<span class="hljs-string">&quot;test123&quot;</span>);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>UserService对应的字节码为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// class version 52.0 (52)</span><br><span class="hljs-comment">// access flags 0x21</span><br><span class="hljs-comment">// signature Ljava/lang/Object;Lcom/zhouyu/service/UserInterface&lt;Lcom/zhouyu/service/OrderService;&gt;;</span><br><span class="hljs-comment">// declaration: com/zhouyu/service/UserService implements com.zhouyu.service.UserInterface&lt;com.zhouyu.service.OrderService&gt;</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">com</span>/zhouyu/service/UserService <span class="hljs-keyword">implements</span> <span class="hljs-title class_">com</span>/zhouyu/service/UserInterface &#123;<br><br>  <span class="hljs-comment">// compiled from: UserService.java</span><br><br>  <span class="hljs-meta">@Lorg</span>/springframework/stereotype/Component;()<br><br>  <span class="hljs-comment">// access flags 0x2</span><br>  <span class="hljs-keyword">private</span> Lcom/zhouyu/service/OrderService; orderService<br><br>  <span class="hljs-comment">// access flags 0x1</span><br>  <span class="hljs-keyword">public</span> &lt;init&gt;()V<br>   L0<br>    LINENUMBER <span class="hljs-number">12</span> L0<br>    ALOAD <span class="hljs-number">0</span><br>    INVOKESPECIAL java/lang/Object.&lt;init&gt; ()V<br>    RETURN<br>   L1<br>    LOCALVARIABLE <span class="hljs-built_in">this</span> Lcom/zhouyu/service/UserService; L0 L1 <span class="hljs-number">0</span><br>    MAXSTACK = <span class="hljs-number">1</span><br>    MAXLOCALS = <span class="hljs-number">1</span><br><br>  <span class="hljs-comment">// access flags 0x1</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setOrderService</span><span class="hljs-params">(Lcom/zhouyu/service/OrderService;)</span>V<br>  <span class="hljs-meta">@Lorg</span>/springframework/beans/factory/annotation/Autowired;()<br>   L0<br>    LINENUMBER <span class="hljs-number">19</span> L0<br>    ALOAD <span class="hljs-number">0</span><br>    ALOAD <span class="hljs-number">1</span><br>    PUTFIELD com/zhouyu/service/UserService.orderService : Lcom/zhouyu/service/OrderService;<br>   L1<br>    LINENUMBER <span class="hljs-number">20</span> L1<br>    RETURN<br>   L2<br>    LOCALVARIABLE <span class="hljs-built_in">this</span> Lcom/zhouyu/service/UserService; L0 L2 <span class="hljs-number">0</span><br>    LOCALVARIABLE orderService Lcom/zhouyu/service/OrderService; L0 L2 <span class="hljs-number">1</span><br>    MAXSTACK = <span class="hljs-number">2</span><br>    MAXLOCALS = <span class="hljs-number">2</span><br><br>  <span class="hljs-comment">// access flags 0x1</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span>V<br>   L0<br>    LINENUMBER <span class="hljs-number">23</span> L0<br>    GETSTATIC java/lang/System.out : Ljava/io/PrintStream;<br>    LDC <span class="hljs-string">&quot;test123&quot;</span><br>    INVOKEVIRTUAL java/io/PrintStream.println (Ljava/lang/String;)V<br>   L1<br>    LINENUMBER <span class="hljs-number">24</span> L1<br>    RETURN<br>   L2<br>    LOCALVARIABLE <span class="hljs-built_in">this</span> Lcom/zhouyu/service/UserService; L0 L2 <span class="hljs-number">0</span><br>    MAXSTACK = <span class="hljs-number">2</span><br>    MAXLOCALS = <span class="hljs-number">1</span><br><br>  <span class="hljs-comment">// access flags 0x1041</span><br>  <span class="hljs-keyword">public</span> synthetic bridge <span class="hljs-title function_">setOrderService</span><span class="hljs-params">(Ljava/lang/Object;)</span>V<br>  <span class="hljs-meta">@Lorg</span>/springframework/beans/factory/annotation/Autowired;()<br>   L0<br>    LINENUMBER <span class="hljs-number">11</span> L0<br>    ALOAD <span class="hljs-number">0</span><br>    ALOAD <span class="hljs-number">1</span><br>    CHECKCAST com/zhouyu/service/OrderService<br>    INVOKEVIRTUAL com/zhouyu/service/UserService.setOrderService (Lcom/zhouyu/service/OrderService;)V<br>    RETURN<br>   L1<br>    LOCALVARIABLE <span class="hljs-built_in">this</span> Lcom/zhouyu/service/UserService; L0 L1 <span class="hljs-number">0</span><br>    MAXSTACK = <span class="hljs-number">2</span><br>    MAXLOCALS = <span class="hljs-number">2</span><br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到在UserSerivce的字节码中有两个setOrderService方法：</p><ol><li>public setOrderService(Lcom&#x2F;zhouyu&#x2F;service&#x2F;OrderService;)V</li><li>public synthetic bridge setOrderService(Ljava&#x2F;lang&#x2F;Object;)V</li></ol><p>并且都是存在@Autowired注解的。</p><p>所以在Spring中需要处理这种情况，当遍历到桥接方法时，得找到原方法。</p><h2 id="注入点进行注入"><a href="#注入点进行注入" class="headerlink" title="注入点进行注入"></a>注入点进行注入</h2><p>Spring在AutowiredAnnotationBeanPostProcessor的**postProcessProperties()**方法中，会遍历所找到的注入点依次进行注入。</p><h3 id="字段注入"><a href="#字段注入" class="headerlink" title="字段注入"></a>字段注入</h3><ol><li>遍历所有的<strong>AutowiredFieldElement对象。</strong></li><li>将对应的字段封装为<strong>DependencyDescriptor对象</strong>。</li><li>调用BeanFactory的resolveDependency()方法，传入<strong>DependencyDescriptor对象</strong>，进行依赖查找，找到当前字段所匹配的Bean对象。</li><li>将<strong>DependencyDescriptor对象</strong>和所找到的<strong>结果对象beanName</strong>封装成一个<strong>ShortcutDependencyDescriptor对象</strong>作为缓存，比如如果当前Bean是原型Bean，那么下次再来创建该Bean时，就可以直接拿缓存的结果对象beanName去BeanFactory中去那bean对象了，不用再次进行查找了</li><li>利用反射将结果对象赋值给字段。</li></ol><h3 id="Set方法注入"><a href="#Set方法注入" class="headerlink" title="Set方法注入"></a>Set方法注入</h3><ol><li>遍历所有的<strong>AutowiredMethodElement对象</strong></li><li>遍历将对应的方法的参数，将每个参数封装成<strong>MethodParameter对象</strong></li><li>将<strong>MethodParameter对象</strong>封装为<strong>DependencyDescriptor对象</strong></li><li>调用BeanFactory的resolveDependency()方法，传入<strong>DependencyDescriptor对象</strong>，进行依赖查找，找到当前方法参数所匹配的Bean对象。</li><li>将<strong>DependencyDescriptor对象</strong>和所找到的<strong>结果对象beanName</strong>封装成一个<strong>ShortcutDependencyDescriptor对象</strong>作为缓存，比如如果当前Bean是原型Bean，那么下次再来创建该Bean时，就可以直接拿缓存的结果对象beanName去BeanFactory中去那bean对象了，不用再次进行查找了</li><li>利用反射将找到的所有结果对象传给当前方法，并执行。</li></ol><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>5、Spring之Bean生命周期源码解析(Bean的销毁过程)</title>
    <link href="/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/5%E3%80%81Spring%E4%B9%8BBean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(Bean%E7%9A%84%E9%94%80%E6%AF%81%E8%BF%87%E7%A8%8B)/"/>
    <url>/2023/06/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/5%E3%80%81Spring%E4%B9%8BBean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(Bean%E7%9A%84%E9%94%80%E6%AF%81%E8%BF%87%E7%A8%8B)/</url>
    
    <content type="html"><![CDATA[<h2 id="Bean的销毁过程"><a href="#Bean的销毁过程" class="headerlink" title="Bean的销毁过程"></a>Bean的销毁过程</h2><p>Bean销毁是发送在Spring容器关闭过程中的。</p><p>在Spring容器关闭时，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(AppConfig.class);<br><span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> (UserService) context.getBean(<span class="hljs-string">&quot;userService&quot;</span>);<br>userService.test();<br><br><span class="hljs-comment">// 容器关闭</span><br>context.close();<br></code></pre></td></tr></table></figure><p>在Bean创建过程中，在最后（初始化之后），有一个步骤会去判断当前创建的Bean是不是DisposableBean：</p><ol><li><p>当前Bean是否实现了DisposableBean接口</p></li><li><p>或者，当前Bean是否实现了AutoCloseable接口</p></li><li><p>BeanDefinition中是否指定了destroyMethod</p></li><li><p>调用DestructionAwareBeanPostProcessor.requiresDestruction(bean)进行判断</p></li><li><ol><li>ApplicationListenerDetector中直接使得ApplicationListener是DisposableBean</li><li>InitDestroyAnnotationBeanPostProcessor中使得拥有@PreDestroy注解了的方法就是DisposableBean</li></ol></li><li><p>把符合上述任意一个条件的Bean适配成DisposableBeanAdapter对象，并存入disposableBeans中（一个LinkedHashMap）</p></li></ol><p>在Spring容器关闭过程时：</p><ol><li><p>首先发布ContextClosedEvent事件</p></li><li><p>调用lifecycleProcessor的onCloese()方法</p></li><li><p>销毁单例Bean</p></li><li><ol><li>遍历disposableBeans</li></ol></li><li><ol><li><ol><li>把每个disposableBean从单例池中移除</li><li>调用disposableBean的destroy()</li><li>如果这个disposableBean还被其他Bean依赖了，那么也得销毁其他Bean</li><li>如果这个disposableBean还包含了inner beans，将这些Bean从单例池中移除掉 (inner bean参考<a href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/core.html#beans-inner-beans">https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/core.html#beans-inner-beans</a>)</li></ol></li></ol></li><li><ol><li>清空manualSingletonNames，是一个Set，存的是用户手动注册的单例Bean的beanName</li><li>清空allBeanNamesByType，是一个Map，key是bean类型，value是该类型所有的beanName数组</li><li>清空singletonBeanNamesByType，和allBeanNamesByType类似，只不过只存了单例Bean</li></ol></li></ol><p>这里涉及到一个设计模式：<strong>适配器模式</strong></p><p>在销毁时，Spring会找出实现了DisposableBean接口的Bean。</p><p>但是我们在定义一个Bean时，如果这个Bean实现了DisposableBean接口，或者实现了AutoCloseable接口，或者在BeanDefinition中指定了destroyMethodName，那么这个Bean都属于“DisposableBean”，这些Bean在容器关闭时都要调用相应的销毁方法。</p><p>所以，这里就需要进行适配，将实现了DisposableBean接口、或者AutoCloseable接口等适配成实现了DisposableBean接口，所以就用到了DisposableBeanAdapter。</p><p>会把实现了AutoCloseable接口的类封装成DisposableBeanAdapter，而DisposableBeanAdapter实现了DisposableBean接口。</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>数据库原理</title>
    <link href="/2023/05/31/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86/"/>
    <url>/2023/05/31/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>4、Spring之Bean生命周期源码解析(Bean的创建过程)</title>
    <link href="/2023/05/30/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/4%E3%80%81Spring%E4%B9%8BBean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(Bean%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B)/"/>
    <url>/2023/05/30/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/4%E3%80%81Spring%E4%B9%8BBean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(Bean%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B)/</url>
    
    <content type="html"><![CDATA[<p>Spring最重要的功能就是帮助程序员创建对象（也就是IOC），而启动Spring就是为创建Bean对象做准备，所以我们先明白Spring到底是怎么去创建Bean的，也就是先弄明白Bean的生命周期。</p><p>Bean的生命周期就是指：<strong>在Spring中，一个Bean是如何生成的，如何销毁的</strong></p><p>Bean生命周期流程图：<img src="/4%E3%80%81Spring%E4%B9%8BBean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(Bean%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B)/image-20230610150323059.png" alt="image-20230610150323059"></p><h2 id="Bean的生成过程"><a href="#Bean的生成过程" class="headerlink" title="Bean的生成过程"></a>Bean的生成过程</h2><h3 id="1-生成BeanDefinition"><a href="#1-生成BeanDefinition" class="headerlink" title="1. 生成BeanDefinition"></a>1. 生成BeanDefinition</h3><p>Spring启动的时候会进行扫描，会先调用<code>org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider#scanCandidateComponents(String basePackage)</code></p><p>扫描某个包路径，并得到BeanDefinition的Set集合。</p><p><strong>关于Spring启动流程，后续会细说，这里先讲一下Spring扫描的底层实现：</strong></p><p>Spring扫描底层流程：<img src="/4%E3%80%81Spring%E4%B9%8BBean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(Bean%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B)/image-20230610150526008.png" alt="image-20230610150526008"></p><ol><li>首先，通过ResourcePatternResolver获得指定包路径下的所有<code>.class</code>文件（Spring源码中将此文件包装成了Resource对象）</li><li>遍历每个Resource对象</li><li>利用MetadataReaderFactory解析Resource对象得到MetadataReader（在Spring源码中MetadataReaderFactory具体的实现类为CachingMetadataReaderFactory，MetadataReader的具体实现类为SimpleMetadataReader）</li><li>利用MetadataReader进行excludeFilters和includeFilters，以及条件注解@Conditional的筛选（条件注解并不能理解：某个类上是否存在@Conditional注解，如果存在则调用注解中所指定的类的match方法进行匹配，匹配成功则通过筛选，匹配失败则pass掉。）</li><li>筛选通过后，基于metadataReader生成ScannedGenericBeanDefinition</li><li>再基于metadataReader判断是不是对应的类是不是接口或抽象类</li><li>如果筛选通过，那么就表示扫描到了一个Bean，将ScannedGenericBeanDefinition加入结果集</li></ol><p>MetadataReader表示类的元数据读取器，主要包含了一个AnnotationMetadata，功能有</p><ol><li>获取类的名字、</li><li>获取父类的名字</li><li>获取所实现的所有接口名</li><li>获取所有内部类的名字</li><li>判断是不是抽象类</li><li>判断是不是接口</li><li>判断是不是一个注解</li><li>获取拥有某个注解的方法集合</li><li>获取类上添加的所有注解信息</li><li>获取类上添加的所有注解类型集合</li></ol><p>值得注意的是，CachingMetadataReaderFactory解析某个.class文件得到MetadataReader对象是利用的<strong>ASM</strong>技术，并没有加载这个类到JVM。并且，最终得到的ScannedGenericBeanDefinition对象，<strong>beanClass属性存储的是当前类的名字，而不是class对象</strong>。（beanClass属性的类型是Object，它即可以存储类的名字，也可以存储class对象）</p><p>最后，上面是说的通过扫描得到BeanDefinition对象，我们还可以通过直接定义BeanDefinition，或解析spring.xml文件的<bean/>，或者@Bean注解得到BeanDefinition对象。（后续课程会分析@Bean注解是怎么生成BeanDefinition的）。</p><h3 id="2-合并BeanDefinition"><a href="#2-合并BeanDefinition" class="headerlink" title="2. 合并BeanDefinition"></a>2. 合并BeanDefinition</h3><p>通过扫描得到所有BeanDefinition之后，就可以根据BeanDefinition创建Bean对象了，但是在Spring中支持父子BeanDefinition，和Java父子类类似，但是完全不是一回事。</p><p>父子BeanDefinition实际用的比较少，使用是这样的，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;bean id=<span class="hljs-string">&quot;parent&quot;</span> class=<span class="hljs-string">&quot;com.zhouyu.service.Parent&quot;</span> scope=<span class="hljs-string">&quot;prototype&quot;</span>/&gt;<br>&lt;bean id=<span class="hljs-string">&quot;child&quot;</span> class=<span class="hljs-string">&quot;com.zhouyu.service.Child&quot;</span>/&gt;<br></code></pre></td></tr></table></figure><p>这么定义的情况下，child是单例Bean。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;bean id=<span class="hljs-string">&quot;parent&quot;</span> class=<span class="hljs-string">&quot;com.zhouyu.service.Parent&quot;</span> scope=<span class="hljs-string">&quot;prototype&quot;</span>/&gt;<br>&lt;bean id=<span class="hljs-string">&quot;child&quot;</span> class=<span class="hljs-string">&quot;com.zhouyu.service.Child&quot;</span> parent=<span class="hljs-string">&quot;parent&quot;</span>/&gt;<br></code></pre></td></tr></table></figure><p>但是这么定义的情况下，child就是原型Bean了。</p><p>因为child的父BeanDefinition是parent，所以会继承parent上所定义的scope属性。</p><p>而在根据child来生成Bean对象之前，需要进行BeanDefinition的合并，得到完整的child的BeanDefinition。</p><h3 id="3-加载类"><a href="#3-加载类" class="headerlink" title="3. 加载类"></a>3. 加载类</h3><p>BeanDefinition合并之后，就可以去创建Bean对象了，而创建Bean就必须实例化对象，而实例化就必须先加载当前BeanDefinition所对应的class，在AbstractAutowireCapableBeanFactory类的createBean()方法中，一开始就会调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);<br></code></pre></td></tr></table></figure><p>这行代码就是去加载类，该方法是这么实现的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (mbd.hasBeanClass()) &#123;<br><span class="hljs-keyword">return</span> mbd.getBeanClass();<br>&#125;<br><span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> AccessController.doPrivileged((PrivilegedExceptionAction&lt;Class&lt;?&gt;&gt;) () -&gt;<br>doResolveBeanClass(mbd, typesToMatch), getAccessControlContext());<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> doResolveBeanClass(mbd, typesToMatch);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasBeanClass</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> (<span class="hljs-built_in">this</span>.beanClass <span class="hljs-keyword">instanceof</span> Class);<br>&#125;<br></code></pre></td></tr></table></figure><p>如果beanClass属性的类型是Class，那么就直接返回，如果不是，则会根据类名进行加载（doResolveBeanClass方法所做的事情）</p><p>会利用BeanFactory所设置的类加载器来加载类，如果没有设置，则默认使用**ClassUtils.getDefaultClassLoader()**所返回的类加载器来加载。</p><h4 id="ClassUtils-getDefaultClassLoader"><a href="#ClassUtils-getDefaultClassLoader" class="headerlink" title="ClassUtils.getDefaultClassLoader()"></a><strong>ClassUtils.getDefaultClassLoader()</strong></h4><ol><li>优先返回当前线程中的ClassLoader</li><li>线程中类加载器为null的情况下，返回ClassUtils类的类加载器</li><li>如果ClassUtils类的类加载器为空，那么则表示是Bootstrap类加载器加载的ClassUtils类，那么则返回系统类加载器</li></ol><h3 id="4-实例化前"><a href="#4-实例化前" class="headerlink" title="4. 实例化前"></a>4. 实例化前</h3><p>当前BeanDefinition对应的类成功加载后，就可以实例化对象了，但是…</p><p>在Spring中，实例化对象之前，Spring提供了一个扩展点，允许用户来控制是否在某个或某些Bean实例化之前做一些启动动作。这个扩展点叫**InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation()**。比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZhouyuBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InstantiationAwareBeanPostProcessor</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInstantiation</span><span class="hljs-params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;userService&quot;</span>.equals(beanName)) &#123;<br>System.out.println(<span class="hljs-string">&quot;实例化前&quot;</span>);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>如上代码会导致，在userService这个Bean实例化前，会进行打印。</p><p>值得注意的是，postProcessBeforeInstantiation()是有返回值的，如果这么实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZhouyuBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InstantiationAwareBeanPostProcessor</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInstantiation</span><span class="hljs-params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;userService&quot;</span>.equals(beanName)) &#123;<br>System.out.println(<span class="hljs-string">&quot;实例化前&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>userService这个Bean，在实例化前会直接返回一个由我们所定义的UserService对象。如果是这样，表示不需要Spring来实例化了，并且后续的Spring依赖注入也不会进行了，会跳过一些步骤，直接执行初始化后这一步。</p><h3 id="5-实例化"><a href="#5-实例化" class="headerlink" title="5. 实例化"></a>5. 实例化</h3><p>在这个步骤中就会根据BeanDefinition去创建一个对象了。</p><h3 id="5-1-Supplier创建对象"><a href="#5-1-Supplier创建对象" class="headerlink" title="5.1 Supplier创建对象"></a>5.1 Supplier创建对象</h3><p>首先判断BeanDefinition中是否设置了Supplier，如果设置了则调用Supplier的get()得到对象。</p><p>得直接使用BeanDefinition对象来设置Supplier，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AbstractBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.genericBeanDefinition().getBeanDefinition();<br>beanDefinition.setInstanceSupplier(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Supplier</span>&lt;Object&gt;() &#123;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();<br>&#125;<br>&#125;);<br>context.registerBeanDefinition(<span class="hljs-string">&quot;userService&quot;</span>, beanDefinition);<br></code></pre></td></tr></table></figure><h3 id="5-2-工厂方法创建对象"><a href="#5-2-工厂方法创建对象" class="headerlink" title="5.2 工厂方法创建对象"></a>5.2 工厂方法创建对象</h3><p>如果没有设置Supplier，则检查BeanDefinition中是否设置了factoryMethod，也就是工厂方法，有两种方式可以设置factoryMethod，比如：</p><p>方式一：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;bean id=<span class="hljs-string">&quot;userService&quot;</span> class=<span class="hljs-string">&quot;com.zhouyu.service.UserService&quot;</span> factory-method=<span class="hljs-string">&quot;createUserService&quot;</span> /&gt;<br></code></pre></td></tr></table></figure><p>对应的UserService类为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UserService <span class="hljs-title function_">createUserService</span><span class="hljs-params">()</span> &#123;<br>System.out.println(<span class="hljs-string">&quot;执行createUserService()&quot;</span>);<br><span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();<br><span class="hljs-keyword">return</span> userService;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>System.out.println(<span class="hljs-string">&quot;test&quot;</span>);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>方式二：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;bean id=<span class="hljs-string">&quot;commonService&quot;</span> class=<span class="hljs-string">&quot;com.zhouyu.service.CommonService&quot;</span>/&gt;<br>&lt;bean id=<span class="hljs-string">&quot;userService1&quot;</span> factory-bean=<span class="hljs-string">&quot;commonService&quot;</span> factory-method=<span class="hljs-string">&quot;createUserService&quot;</span> /&gt;<br></code></pre></td></tr></table></figure><p>对应的CommonService的类为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonService</span> &#123;<br><br><span class="hljs-keyword">public</span> UserService <span class="hljs-title function_">createUserService</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Spring发现当前BeanDefinition方法设置了工厂方法后，就会区分这两种方式，然后调用工厂方法得到对象。</p><p>值得注意的是，我们通过@Bean所定义的BeanDefinition，是存在factoryMethod和factoryBean的，也就是和上面的方式二非常类似，@Bean所注解的方法就是factoryMethod，AppConfig对象就是factoryBean。如果@Bean所所注解的方法是static的，那么对应的就是方式一。</p><h3 id="5-3-推断构造方法"><a href="#5-3-推断构造方法" class="headerlink" title="5.3 推断构造方法"></a>5.3 推断构造方法</h3><p>第一节已经讲过一遍大概原理了，后面有一节课单独分析源码实现。推断完构造方法后，就会使用构造方法来进行实例化了。</p><p>额外的，在推断构造方法逻辑中除开会去选择构造方法以及查找入参对象意外，会还判断是否在对应的类中是否存在使用**@Lookup注解**了方法。如果存在则把该方法封装为LookupOverride对象并添加到BeanDefinition中。</p><p>在实例化时，如果判断出来当前BeanDefinition中没有LookupOverride，那就直接用构造方法反射得到一个实例对象。如果存在LookupOverride对象，也就是类中存在@Lookup注解了的方法，那就会生成一个代理对象。</p><p>@Lookup注解就是<strong>方法注入</strong>，使用demo如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br><br><span class="hljs-keyword">private</span> OrderService orderService;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-type">OrderService</span> <span class="hljs-variable">orderService</span> <span class="hljs-operator">=</span> createOrderService();<br>System.out.println(orderService);<br>&#125;<br><br><span class="hljs-meta">@Lookup(&quot;orderService&quot;)</span><br><span class="hljs-keyword">public</span> OrderService <span class="hljs-title function_">createOrderService</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-BeanDefinition的后置处理"><a href="#6-BeanDefinition的后置处理" class="headerlink" title="6. BeanDefinition的后置处理"></a>6. BeanDefinition的后置处理</h3><p>Bean对象实例化出来之后，接下来就应该给对象的属性赋值了。在真正给属性赋值之前，Spring又提供了一个扩展点**MergedBeanDefinitionPostProcessor.postProcessMergedBeanDefinition()**，可以对此时的BeanDefinition进行加工，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZhouyuMergedBeanDefinitionPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MergedBeanDefinitionPostProcessor</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessMergedBeanDefinition</span><span class="hljs-params">(RootBeanDefinition beanDefinition, Class&lt;?&gt; beanType, String beanName)</span> &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;userService&quot;</span>.equals(beanName)) &#123;<br>beanDefinition.getPropertyValues().add(<span class="hljs-string">&quot;orderService&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderService</span>());<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在Spring源码中，AutowiredAnnotationBeanPostProcessor就是一个MergedBeanDefinitionPostProcessor，它的postProcessMergedBeanDefinition()中会去查找注入点，并缓存在AutowiredAnnotationBeanPostProcessor对象的一个Map中（injectionMetadataCache）。</p><h3 id="7-实例化后"><a href="#7-实例化后" class="headerlink" title="7. 实例化后"></a>7. 实例化后</h3><p>在处理完BeanDefinition后，Spring又设计了一个扩展点：**InstantiationAwareBeanPostProcessor.postProcessAfterInstantiation()**，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZhouyuInstantiationAwareBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InstantiationAwareBeanPostProcessor</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">postProcessAfterInstantiation</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;userService&quot;</span>.equals(beanName)) &#123;<br><span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> (UserService) bean;<br>userService.test();<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>上述代码就是对userService所实例化出来的对象进行处理。</p><p>这个扩展点，在Spring源码中基本没有怎么使用。</p><h3 id="8-自动注入"><a href="#8-自动注入" class="headerlink" title="8. 自动注入"></a>8. 自动注入</h3><p>这里的自动注入指的是Spring的自动注入，后续依赖注入课程中单独细讲</p><h3 id="9-处理属性"><a href="#9-处理属性" class="headerlink" title="9. 处理属性"></a>9. 处理属性</h3><p>这个步骤中，就会处理@Autowired、@Resource、@Value等注解，也是通过**InstantiationAwareBeanPostProcessor.postProcessProperties()**扩展点来实现的，比如我们甚至可以实现一个自己的自动注入功能，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZhouyuInstantiationAwareBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InstantiationAwareBeanPostProcessor</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> PropertyValues <span class="hljs-title function_">postProcessProperties</span><span class="hljs-params">(PropertyValues pvs, Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;userService&quot;</span>.equals(beanName)) &#123;<br><span class="hljs-keyword">for</span> (Field field : bean.getClass().getFields()) &#123;<br><span class="hljs-keyword">if</span> (field.isAnnotationPresent(ZhouyuInject.class)) &#123;<br>field.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-keyword">try</span> &#123;<br>field.set(bean, <span class="hljs-string">&quot;123&quot;</span>);<br>&#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>e.printStackTrace();<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> pvs;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>关于@Autowired、@Resource、@Value的底层源码，会在后续的依赖注入课程中详解。</p><h3 id="10-执行Aware"><a href="#10-执行Aware" class="headerlink" title="10. 执行Aware"></a>10. 执行Aware</h3><p>完成了属性赋值之后，Spring会执行一些回调，包括：</p><ol><li>BeanNameAware：回传beanName给bean对象。</li><li>BeanClassLoaderAware：回传classLoader给bean对象。</li><li>BeanFactoryAware：回传beanFactory给对象。</li></ol><h3 id="11-初始化前"><a href="#11-初始化前" class="headerlink" title="11. 初始化前"></a>11. 初始化前</h3><p>初始化前，也是Spring提供的一个扩展点：**BeanPostProcessor.postProcessBeforeInitialization()**，比如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZhouyuBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;userService&quot;</span>.equals(beanName)) &#123;<br>System.out.println(<span class="hljs-string">&quot;初始化前&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> bean;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>利用初始化前，可以对进行了依赖注入的Bean进行处理。</p><p>在Spring源码中：</p><ol><li><p>InitDestroyAnnotationBeanPostProcessor会在初始化前这个步骤中执行@PostConstruct的方法，</p></li><li><p>ApplicationContextAwareProcessor会在初始化前这个步骤中进行其他Aware的回调：</p></li><li><ol><li>EnvironmentAware：回传环境变量</li><li>EmbeddedValueResolverAware：回传占位符解析器</li><li>ResourceLoaderAware：回传资源加载器</li><li>ApplicationEventPublisherAware：回传事件发布器</li><li>MessageSourceAware：回传国际化资源</li><li>ApplicationStartupAware：回传应用其他监听对象，可忽略</li><li>ApplicationContextAware：回传Spring容器ApplicationContext</li></ol></li></ol><h3 id="12-初始化"><a href="#12-初始化" class="headerlink" title="12. 初始化"></a>12. 初始化</h3><ol><li>查看当前Bean对象是否实现了InitializingBean接口，如果实现了就调用其afterPropertiesSet()方法</li><li>执行BeanDefinition中指定的初始化方法</li></ol><h3 id="13-初始化后"><a href="#13-初始化后" class="headerlink" title="13. 初始化后"></a>13. 初始化后</h3><p>这是Bean创建生命周期中的最后一个步骤，也是Spring提供的一个扩展点：**BeanPostProcessor.postProcessAfterInitialization()**，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZhouyuBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;userService&quot;</span>.equals(beanName)) &#123;<br>System.out.println(<span class="hljs-string">&quot;初始化后&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> bean;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以在这个步骤中，对Bean最终进行处理，Spring中的<strong>AOP就是基于初始化后实现</strong>的，<strong>初始化后返回的对象才是最终的Bean对象</strong>。</p><h3 id="总结BeanPostProcessor"><a href="#总结BeanPostProcessor" class="headerlink" title="总结BeanPostProcessor"></a>总结BeanPostProcessor</h3><ol><li>InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation()</li><li>实例化</li><li>MergedBeanDefinitionPostProcessor.postProcessMergedBeanDefinition()</li><li>InstantiationAwareBeanPostProcessor.postProcessAfterInstantiation()</li><li>自动注入</li><li>InstantiationAwareBeanPostProcessor.postProcessProperties()</li><li>Aware对象</li><li>BeanPostProcessor.postProcessBeforeInitialization()</li><li>初始化</li><li>BeanPostProcessor.postProcessAfterInitialization()</li></ol><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>3、Spring底层架构核心概念解析</title>
    <link href="/2023/05/30/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/3%E3%80%81Spring%E5%BA%95%E5%B1%82%E6%9E%B6%E6%9E%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/05/30/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/3%E3%80%81Spring%E5%BA%95%E5%B1%82%E6%9E%B6%E6%9E%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="BeanDefinition"><a href="#BeanDefinition" class="headerlink" title="BeanDefinition"></a>BeanDefinition</h2><p>BeanDefinition表示Bean定义，BeanDefinition中存在很多属性用来描述一个Bean的特点。比如：</p><ul><li>class，表示Bean类型</li><li>scope，表示Bean作用域，单例或原型等</li><li>lazyInit：表示Bean是否是懒加载</li><li>initMethodName：表示Bean初始化时要执行的方法</li><li>destroyMethodName：表示Bean销毁时要执行的方法</li><li>还有很多…</li></ul><p>在Spring中，我们经常会通过以下几种方式来定义Bean：</p><ol><li><bean/>标签</li><li>@Bean</li><li>@Component(@Service,@Controller)</li></ol><p>这些，我们可以称之<strong>申明式定义Bean</strong>。</p><p>我们还可以<strong>编程式定义Bean</strong>，那就是直接通过BeanDefinition，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(AppConfig.class);<br><br><span class="hljs-comment">// 生成一个BeanDefinition对象，并设置beanClass为User.class，并注册到ApplicationContext中</span><br><span class="hljs-type">AbstractBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.genericBeanDefinition().getBeanDefinition();<br>beanDefinition.setBeanClass(User.class);<br>context.registerBeanDefinition(<span class="hljs-string">&quot;user&quot;</span>, beanDefinition);<br><br>System.out.println(context.getBean(<span class="hljs-string">&quot;user&quot;</span>));<br></code></pre></td></tr></table></figure><p>我们还可以通过BeanDefinition设置一个Bean的其他属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">beanDefinition.setScope(<span class="hljs-string">&quot;prototype&quot;</span>); <span class="hljs-comment">// 设置作用域</span><br>beanDefinition.setInitMethodName(<span class="hljs-string">&quot;init&quot;</span>); <span class="hljs-comment">// 设置初始化方法</span><br>beanDefinition.setLazyInit(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 设置懒加载</span><br></code></pre></td></tr></table></figure><p>和申明式事务、编程式事务类似，通过<bean/>，@Bean，@Component等申明式方式所定义的Bean，最终都会被Spring解析为对应的BeanDefinition对象，并放入Spring容器中。</p><h2 id="BeanDefinitionReader"><a href="#BeanDefinitionReader" class="headerlink" title="BeanDefinitionReader"></a>BeanDefinitionReader</h2><p>接下来，我们来介绍几种在Spring源码中所提供的BeanDefinition读取器（BeanDefinitionReader），这些BeanDefinitionReader在我们使用Spring时用得少，但在Spring源码中用得多，相当于Spring源码的基础设施。</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="AnnotatedBeanDefinitionReader"><a href="#AnnotatedBeanDefinitionReader" class="headerlink" title="AnnotatedBeanDefinitionReader"></a>AnnotatedBeanDefinitionReader</h3><p>可以直接把某个类转换为BeanDefinition，并且会解析该类上的注解，比如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(AppConfig.class);<br><br><span class="hljs-type">AnnotatedBeanDefinitionReader</span> <span class="hljs-variable">annotatedBeanDefinitionReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotatedBeanDefinitionReader</span>(context);<br><br><span class="hljs-comment">// 将User.class解析为BeanDefinition</span><br>annotatedBeanDefinitionReader.register(User.class);<br><br>System.out.println(context.getBean(<span class="hljs-string">&quot;user&quot;</span>));<br></code></pre></td></tr></table></figure><p>注意：它能解析的注解是：@Conditional，**@Scope**、@Lazy、@Primary、@DependsOn、@Role、@Description</p><h3 id="XmlBeanDefinitionReader"><a href="#XmlBeanDefinitionReader" class="headerlink" title="XmlBeanDefinitionReader"></a>XmlBeanDefinitionReader</h3><p>可以解析<bean/>标签</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(AppConfig.class);<br><br><span class="hljs-type">XmlBeanDefinitionReader</span> <span class="hljs-variable">xmlBeanDefinitionReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XmlBeanDefinitionReader</span>(context);<br><span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> xmlBeanDefinitionReader.loadBeanDefinitions(<span class="hljs-string">&quot;spring.xml&quot;</span>);<br><br>System.out.println(context.getBean(<span class="hljs-string">&quot;user&quot;</span>));<br></code></pre></td></tr></table></figure><h3 id="ClassPathBeanDefinitionScanner"><a href="#ClassPathBeanDefinitionScanner" class="headerlink" title="ClassPathBeanDefinitionScanner"></a>ClassPathBeanDefinitionScanner</h3><p>ClassPathBeanDefinitionScanner是扫描器，但是它的作用和BeanDefinitionReader类似，它可以进行扫描，扫描某个包路径，对扫描到的类进行解析，比如，扫描到的类上如果存在@Component注解，那么就会把这个类解析为一个BeanDefinition，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>();<br>context.refresh();<br><br><span class="hljs-type">ClassPathBeanDefinitionScanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathBeanDefinitionScanner</span>(context);<br>scanner.scan(<span class="hljs-string">&quot;com.zhouyu&quot;</span>);<br><br>System.out.println(context.getBean(<span class="hljs-string">&quot;userService&quot;</span>));<br></code></pre></td></tr></table></figure><h2 id="BeanFactory"><a href="#BeanFactory" class="headerlink" title="BeanFactory"></a>BeanFactory</h2><p>BeanFactory表示Bean<strong>工厂</strong>，所以很明显，BeanFactory会负责创建Bean，并且提供获取Bean的API。</p><p>而ApplicationContext是BeanFactory的一种，在Spring源码中，是这么定义的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">EnvironmentCapable</span>, ListableBeanFactory, HierarchicalBeanFactory,<br>MessageSource, ApplicationEventPublisher, ResourcePatternResolver &#123;<br><br>            ...<br>&#125;<br></code></pre></td></tr></table></figure><p>首先，在Java中，接口是可以<strong>多继承</strong>的，我们发现ApplicationContext继承了ListableBeanFactory和HierarchicalBeanFactory，而ListableBeanFactory和HierarchicalBeanFactory都继承至BeanFactory，所以我们可以认为ApplicationContext继承了BeanFactory，相当于苹果继承水果，宝马继承汽车一样，ApplicationContext也是BeanFactory的一种，拥有BeanFactory支持的所有功能，不过ApplicationContext比BeanFactory更加强大，ApplicationContext还基础了其他接口，也就表示ApplicationContext还拥有其他功能，比如MessageSource表示国际化，ApplicationEventPublisher表示事件发布，EnvironmentCapable表示获取环境变量，等等，关于ApplicationContext后面再详细讨论。</p><p>在Spring的源码实现中，当我们new一个ApplicationContext时，其底层会new一个BeanFactory出来，当使用ApplicationContext的某些方法时，比如getBean()，底层调用的是BeanFactory的getBean()方法。</p><p>在Spring源码中，BeanFactory接口存在一个非常重要的实现类是：<strong>DefaultListableBeanFactory，也是非常核心的。</strong>具体重要性，随着后续课程会感受更深。</p><p>所以，我们可以直接来使用<strong>DefaultListableBeanFactory</strong>，而不用使用ApplicationContext的某个实现类，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">DefaultListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultListableBeanFactory</span>();<br><br><span class="hljs-type">AbstractBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.genericBeanDefinition().getBeanDefinition();<br>beanDefinition.setBeanClass(User.class);<br><br>beanFactory.registerBeanDefinition(<span class="hljs-string">&quot;user&quot;</span>, beanDefinition);<br><br>System.out.println(beanFactory.getBean(<span class="hljs-string">&quot;user&quot;</span>));<br></code></pre></td></tr></table></figure><p><strong>DefaultListableBeanFactory是非常强大的，支持很多功能，可以通过查看DefaultListableBeanFactory的类继承实现结构来看</strong></p><p><img src="/3%E3%80%81Spring%E5%BA%95%E5%B1%82%E6%9E%B6%E6%9E%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E8%A7%A3%E6%9E%90/1602053031607-fd00a145-67fa-4231-8cca-9186db5f2b00.png" alt="img"></p><p><strong>这部分现在看不懂没关系，源码熟悉一点后回来再来看都可以。</strong></p><p>它实现了很多接口，表示，它拥有很多功能：</p><ol><li>AliasRegistry：支持别名功能，一个名字可以对应多个别名</li><li>BeanDefinitionRegistry：可以注册、保存、移除、获取某个BeanDefinition</li><li>BeanFactory：Bean工厂，可以根据某个bean的名字、或类型、或别名获取某个Bean对象</li><li>SingletonBeanRegistry：可以直接注册、获取某个<strong>单例</strong>Bean</li><li>SimpleAliasRegistry：它是一个类，实现了AliasRegistry接口中所定义的功能，支持别名功能</li><li>ListableBeanFactory：在BeanFactory的基础上，增加了其他功能，可以获取所有BeanDefinition的beanNames，可以根据某个类型获取对应的beanNames，可以根据某个类型获取{类型：对应的Bean}的映射关系</li><li>HierarchicalBeanFactory：在BeanFactory的基础上，添加了获取父BeanFactory的功能</li><li>DefaultSingletonBeanRegistry：它是一个类，实现了SingletonBeanRegistry接口，拥有了直接注册、获取某个<strong>单例</strong>Bean的功能</li><li>ConfigurableBeanFactory：在HierarchicalBeanFactory和SingletonBeanRegistry的基础上，添加了设置父BeanFactory、类加载器（表示可以指定某个类加载器进行类的加载）、设置Spring EL表达式解析器（表示该BeanFactory可以解析EL表达式）、设置类型转化服务（表示该BeanFactory可以进行类型转化）、可以添加BeanPostProcessor（表示该BeanFactory支持Bean的后置处理器），可以合并BeanDefinition，可以销毁某个Bean等等功能</li><li>FactoryBeanRegistrySupport：支持了FactoryBean的功能</li><li>AutowireCapableBeanFactory：是直接继承了BeanFactory，在BeanFactory的基础上，支持在创建Bean的过程中能对Bean进行自动装配</li><li>AbstractBeanFactory：实现了ConfigurableBeanFactory接口，继承了FactoryBeanRegistrySupport，这个BeanFactory的功能已经很全面了，但是不能自动装配和获取beanNames</li><li>ConfigurableListableBeanFactory：继承了ListableBeanFactory、AutowireCapableBeanFactory、ConfigurableBeanFactory</li><li>AbstractAutowireCapableBeanFactory：继承了AbstractBeanFactory，实现了AutowireCapableBeanFactory，拥有了自动装配的功能</li><li>DefaultListableBeanFactory：继承了AbstractAutowireCapableBeanFactory，实现了ConfigurableListableBeanFactory接口和BeanDefinitionRegistry接口，所以DefaultListableBeanFactory的功能很强大</li></ol><h2 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h2><p>上面有分析到，ApplicationContext是个接口，实际上也是一个BeanFactory，不过比BeanFactory更加强大，比如：</p><ol><li>HierarchicalBeanFactory：拥有获取父BeanFactory的功能</li><li>ListableBeanFactory：拥有获取beanNames的功能</li><li>ResourcePatternResolver：资源加载器，可以一次性获取多个资源（文件资源等等）</li><li>EnvironmentCapable：可以获取运行时环境（没有设置运行时环境功能）</li><li>ApplicationEventPublisher：拥有广播事件的功能（没有添加事件监听器的功能）</li><li>MessageSource：拥有国际化功能</li></ol><p>具体的功能演示，后面会有。</p><p>我们先来看ApplicationContext两个比较重要的实现类：</p><ol><li>AnnotationConfigApplicationContext</li><li>ClassPathXmlApplicationContext</li></ol><h3 id="AnnotationConfigApplicationContext"><a href="#AnnotationConfigApplicationContext" class="headerlink" title="AnnotationConfigApplicationContext"></a>AnnotationConfigApplicationContext</h3><p><img src="/3%E3%80%81Spring%E5%BA%95%E5%B1%82%E6%9E%B6%E6%9E%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E8%A7%A3%E6%9E%90/1602055860352-0925b046-b88e-4085-b872-b1ec5aeb8fee.png" alt="img"></p><p><strong>这部分现在看不懂没关系，源码熟悉一点后回来再来看都可以。</strong></p><ol><li>ConfigurableApplicationContext：继承了ApplicationContext接口，增加了，添加事件监听器、添加BeanFactoryPostProcessor、设置Environment，获取ConfigurableListableBeanFactory等功能</li><li>AbstractApplicationContext：实现了ConfigurableApplicationContext接口</li><li>GenericApplicationContext：继承了AbstractApplicationContext，实现了BeanDefinitionRegistry接口，拥有了所有ApplicationContext的功能，并且可以注册BeanDefinition，注意这个类中有一个属性(DefaultListableBeanFactory <strong>beanFactory</strong>)</li><li>AnnotationConfigRegistry：可以单独注册某个为类为BeanDefinition（可以处理该类上的**@Configuration注解<strong>，已经可以处理</strong>@Bean注解**），同时可以扫描</li><li>AnnotationConfigApplicationContext：继承了GenericApplicationContext，实现了AnnotationConfigRegistry接口，拥有了以上所有的功能</li></ol><h3 id="ClassPathXmlApplicationContext"><a href="#ClassPathXmlApplicationContext" class="headerlink" title="ClassPathXmlApplicationContext"></a>ClassPathXmlApplicationContext</h3><p><img src="/3%E3%80%81Spring%E5%BA%95%E5%B1%82%E6%9E%B6%E6%9E%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E8%A7%A3%E6%9E%90/1602056629659-0bb9b513-834c-4e57-9120-55dc40fd8674.png" alt="img"></p><p>它也是继承了AbstractApplicationContext，但是相对于AnnotationConfigApplicationContext而言，功能没有AnnotationConfigApplicationContext强大，比如不能注册BeanDefinition</p><h3 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h3><p>先定义一个MessageSource:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> MessageSource <span class="hljs-title function_">messageSource</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-type">ResourceBundleMessageSource</span> <span class="hljs-variable">messageSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceBundleMessageSource</span>();<br>messageSource.setBasename(<span class="hljs-string">&quot;messages&quot;</span>);<br><span class="hljs-keyword">return</span> messageSource;<br>&#125;<br></code></pre></td></tr></table></figure><p>有了这个Bean，你可以在你任意想要进行国际化的地方使用该MessageSource。</p><p>同时，因为ApplicationContext也拥有国家化的功能，所以可以直接这么用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">context.getMessage(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Locale</span>(<span class="hljs-string">&quot;en_CN&quot;</span>))<br></code></pre></td></tr></table></figure><h3 id="资源加载"><a href="#资源加载" class="headerlink" title="资源加载"></a>资源加载</h3><p>ApplicationContext还拥有资源加载的功能，比如，可以直接利用ApplicationContext获取某个文件的内容：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(AppConfig.class);<br><br><span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> context.getResource(<span class="hljs-string">&quot;file://D:\\IdeaProjects\\spring-framework-5.3.10\\tuling\\src\\main\\java\\com\\zhouyu\\service\\UserService.java&quot;</span>);<br>System.out.println(resource.contentLength());<br></code></pre></td></tr></table></figure><p>你可以想想，如果你不使用ApplicationContext，而是自己来实现这个功能，就比较费时间了。</p><p>还比如你可以：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(AppConfig.class);<br><br><span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> context.getResource(<span class="hljs-string">&quot;file://D:\\IdeaProjects\\spring-framework-5.3.10\\tuling\\src\\main\\java\\com\\zhouyu\\service\\UserService.java&quot;</span>);<br>System.out.println(resource.contentLength());<br>System.out.println(resource.getFilename());<br><br><span class="hljs-type">Resource</span> <span class="hljs-variable">resource1</span> <span class="hljs-operator">=</span> context.getResource(<span class="hljs-string">&quot;https://www.baidu.com&quot;</span>);<br>System.out.println(resource1.contentLength());<br>System.out.println(resource1.getURL());<br><br><span class="hljs-type">Resource</span> <span class="hljs-variable">resource2</span> <span class="hljs-operator">=</span> context.getResource(<span class="hljs-string">&quot;classpath:spring.xml&quot;</span>);<br>System.out.println(resource2.contentLength());<br>System.out.println(resource2.getURL());<br></code></pre></td></tr></table></figure><p>还可以一次性获取多个：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Resource[] resources = context.getResources(<span class="hljs-string">&quot;classpath:com/zhouyu/*.class&quot;</span>);<br><span class="hljs-keyword">for</span> (Resource resource : resources) &#123;<br>System.out.println(resource.contentLength());<br>System.out.println(resource.getFilename());<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="获取运行时环境"><a href="#获取运行时环境" class="headerlink" title="获取运行时环境"></a>获取运行时环境</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(AppConfig.class);<br><br>Map&lt;String, Object&gt; systemEnvironment = context.getEnvironment().getSystemEnvironment();<br>System.out.println(systemEnvironment);<br><br>System.out.println(<span class="hljs-string">&quot;=======&quot;</span>);<br><br>Map&lt;String, Object&gt; systemProperties = context.getEnvironment().getSystemProperties();<br>System.out.println(systemProperties);<br><br>System.out.println(<span class="hljs-string">&quot;=======&quot;</span>);<br><br><span class="hljs-type">MutablePropertySources</span> <span class="hljs-variable">propertySources</span> <span class="hljs-operator">=</span> context.getEnvironment().getPropertySources();<br>System.out.println(propertySources);<br><br>System.out.println(<span class="hljs-string">&quot;=======&quot;</span>);<br><br>System.out.println(context.getEnvironment().getProperty(<span class="hljs-string">&quot;NO_PROXY&quot;</span>));<br>System.out.println(context.getEnvironment().getProperty(<span class="hljs-string">&quot;sun.jnu.encoding&quot;</span>));<br>System.out.println(context.getEnvironment().getProperty(<span class="hljs-string">&quot;zhouyu&quot;</span>));<br></code></pre></td></tr></table></figure><p>注意，可以利用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PropertySource(&quot;classpath:spring.properties&quot;)</span><br></code></pre></td></tr></table></figure><p>来使得某个properties文件中的参数添加到运行时环境中</p><h3 id="事件发布"><a href="#事件发布" class="headerlink" title="事件发布"></a>事件发布</h3><p>先定义一个事件监听器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> ApplicationListener <span class="hljs-title function_">applicationListener</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationListener</span>() &#123;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEvent</span><span class="hljs-params">(ApplicationEvent event)</span> &#123;<br>System.out.println(<span class="hljs-string">&quot;接收到了一个事件&quot;</span>);<br>&#125;<br>&#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后发布一个事件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">applicationEventPublisher.publishEvent(<span class="hljs-string">&quot;kkk&quot;</span>);<br>或<br>applicationContext.publishEvent(<span class="hljs-string">&quot;kkk&quot;</span>);<span class="hljs-comment">//底层就是用的applicationEventPublisher</span><br></code></pre></td></tr></table></figure><h2 id="类型转化"><a href="#类型转化" class="headerlink" title="类型转化"></a>类型转化</h2><p>在Spring源码中，有可能需要把String转成其他类型，所以在Spring源码中提供了一些技术来更方便的做对象的类型转化，关于类型转化的应用场景， 后续看源码的过程中会遇到很多。</p><h3 id="PropertyEditor"><a href="#PropertyEditor" class="headerlink" title="PropertyEditor"></a>PropertyEditor</h3><p>这其实是<strong>JDK</strong>中提供的类型转化工具类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringToUserPropertyEditor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PropertyEditorSupport</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PropertyEditor</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAsText</span><span class="hljs-params">(String text)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException &#123;<br>        <span class="hljs-comment">//这里可以将某个类型转换为目标对象类型</span><br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>user.setName(text);<br><span class="hljs-built_in">this</span>.setValue(user);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">StringToUserPropertyEditor</span> <span class="hljs-variable">propertyEditor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringToUserPropertyEditor</span>();<br>propertyEditor.setAsText(<span class="hljs-string">&quot;1&quot;</span>);<br><span class="hljs-type">User</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (User) propertyEditor.getValue();<br>System.out.println(value);<br></code></pre></td></tr></table></figure><p>如何向Spring中注册PropertyEditor：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> CustomEditorConfigurer <span class="hljs-title function_">customEditorConfigurer</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-type">CustomEditorConfigurer</span> <span class="hljs-variable">customEditorConfigurer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEditorConfigurer</span>();<br>Map&lt;Class&lt;?&gt;, Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PropertyEditor</span>&gt;&gt; propertyEditorMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    <br>    <span class="hljs-comment">// 表示StringToUserPropertyEditor可以将String转化成User类型，在Spring源码中，如果发现当前对象是String，而需要的类型是User，就会使用该PropertyEditor来做类型转化</span><br>propertyEditorMap.put(User.class, StringToUserPropertyEditor.class);<br>customEditorConfigurer.setCustomEditors(propertyEditorMap);<br><span class="hljs-keyword">return</span> customEditorConfigurer;<br>&#125;<br></code></pre></td></tr></table></figure><p>假设现在有如下Bean:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br><br><span class="hljs-meta">@Value(&quot;xxx&quot;)</span><br><span class="hljs-keyword">private</span> User user;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>System.out.println(user);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>那么test属性就能正常的完成属性赋值</p><h3 id="ConversionService"><a href="#ConversionService" class="headerlink" title="ConversionService"></a>ConversionService</h3><p><strong>Spring</strong>中提供的类型转化服务，它比PropertyEditor更强大</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringToUserConverter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConditionalGenericConverter</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(TypeDescriptor sourceType, TypeDescriptor targetType)</span> &#123;<br><span class="hljs-keyword">return</span> sourceType.getType().equals(String.class) &amp;&amp; targetType.getType().equals(User.class);<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Set&lt;ConvertiblePair&gt; <span class="hljs-title function_">getConvertibleTypes</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> Collections.singleton(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConvertiblePair</span>(String.class, User.class));<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">convert</span><span class="hljs-params">(Object source, TypeDescriptor sourceType, TypeDescriptor targetType)</span> &#123;<br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>user.setName((String)source);<br><span class="hljs-keyword">return</span> user;<br>&#125;<br>&#125;<br><span class="hljs-type">DefaultConversionService</span> <span class="hljs-variable">conversionService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConversionService</span>();<br>conversionService.addConverter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringToUserConverter</span>());<br><span class="hljs-type">User</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> conversionService.convert(<span class="hljs-string">&quot;1&quot;</span>, User.class);<br>System.out.println(value);<br></code></pre></td></tr></table></figure><p>如何向Spring中注册ConversionService：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> ConversionServiceFactoryBean <span class="hljs-title function_">conversionService</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-type">ConversionServiceFactoryBean</span> <span class="hljs-variable">conversionServiceFactoryBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConversionServiceFactoryBean</span>();<br>conversionServiceFactoryBean.setConverters(Collections.singleton(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringToUserConverter</span>()));<br><br><span class="hljs-keyword">return</span> conversionServiceFactoryBean;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="TypeConverter"><a href="#TypeConverter" class="headerlink" title="TypeConverter"></a>TypeConverter</h3><p>整合了PropertyEditor和ConversionService的功能，是Spring内部用的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">SimpleTypeConverter</span> <span class="hljs-variable">typeConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleTypeConverter</span>();<br>typeConverter.registerCustomEditor(User.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringToUserPropertyEditor</span>());<br><span class="hljs-comment">//typeConverter.setConversionService(conversionService);</span><br><span class="hljs-type">User</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> typeConverter.convertIfNecessary(<span class="hljs-string">&quot;1&quot;</span>, User.class);<br>System.out.println(value);<br></code></pre></td></tr></table></figure><h2 id="OrderComparator"><a href="#OrderComparator" class="headerlink" title="OrderComparator"></a>OrderComparator</h2><p>OrderComparator是Spring所提供的一种比较器，可以用来根据@Order注解或实现Ordered接口来执行值进行笔记，从而可以进行排序。</p><p>比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Ordered</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getClass().getSimpleName();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Ordered</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getClass().getSimpleName();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><span class="hljs-type">A</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">A</span>(); <span class="hljs-comment">// order=3</span><br><span class="hljs-type">B</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">B</span>(); <span class="hljs-comment">// order=2</span><br><br><span class="hljs-type">OrderComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderComparator</span>();<br>System.out.println(comparator.compare(a, b));  <span class="hljs-comment">// 1</span><br><br><span class="hljs-type">List</span> <span class="hljs-variable">list</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>list.add(a);<br>list.add(b);<br><br><span class="hljs-comment">// 按order值升序排序</span><br>list.sort(comparator);<br><br>System.out.println(list);  <span class="hljs-comment">// B，A</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>另外，Spring中还提供了一个OrderComparator的子类：<strong>AnnotationAwareOrderComparator</strong>，它支持用@Order来指定order值。比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Order(3)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getClass().getSimpleName();<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Order(2)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getClass().getSimpleName();<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><span class="hljs-type">A</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">A</span>(); <span class="hljs-comment">// order=3</span><br><span class="hljs-type">B</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">B</span>(); <span class="hljs-comment">// order=2</span><br><br><span class="hljs-type">AnnotationAwareOrderComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationAwareOrderComparator</span>();<br>System.out.println(comparator.compare(a, b)); <span class="hljs-comment">// 1</span><br><br><span class="hljs-type">List</span> <span class="hljs-variable">list</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>list.add(a);<br>list.add(b);<br><br><span class="hljs-comment">// 按order值升序排序</span><br>list.sort(comparator);<br><br>System.out.println(list); <span class="hljs-comment">// B，A</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="BeanPostProcessor"><a href="#BeanPostProcessor" class="headerlink" title="BeanPostProcessor"></a>BeanPostProcessor</h2><p>BeanPostProcess表示Bean的后置处理器，我们可以定义一个或多个BeanPostProcessor，比如通过一下代码定义一个BeanPostProcessor：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZhouyuBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;userService&quot;</span>.equals(beanName)) &#123;<br>System.out.println(<span class="hljs-string">&quot;初始化前&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> bean;<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;userService&quot;</span>.equals(beanName)) &#123;<br>System.out.println(<span class="hljs-string">&quot;初始化后&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> bean;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>一个BeanPostProcessor可以在<strong>任意一个Bean</strong>的<strong>初始化之前</strong>以及<strong>初始化之后</strong>去额外的做一些用户自定义的逻辑，当然，我们可以通过判断beanName来进行针对性处理（针对某个Bean，或某部分Bean）。</p><p>我们可以通过定义BeanPostProcessor来干涉Spring创建Bean的过程。</p><h2 id="BeanFactoryPostProcessor"><a href="#BeanFactoryPostProcessor" class="headerlink" title="BeanFactoryPostProcessor"></a>BeanFactoryPostProcessor</h2><p>BeanFactoryPostProcessor表示Bean工厂的后置处理器，其实和BeanPostProcessor类似，BeanPostProcessor是干涉Bean的创建过程，BeanFactoryPostProcessor是干涉BeanFactory的创建过程。比如，我们可以这样定义一个BeanFactoryPostProcessor：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZhouyuBeanFactoryPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanFactoryPostProcessor</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>System.out.println(<span class="hljs-string">&quot;加工beanFactory&quot;</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们可以在postProcessBeanFactory()方法中对BeanFactory进行加工。</p><h2 id="FactoryBean"><a href="#FactoryBean" class="headerlink" title="FactoryBean"></a>FactoryBean</h2><p>上面提到，我们可以通过BeanPostPorcessor来干涉Spring创建Bean的过程，但是如果我们想一个Bean完完全全由我们来创造，也是可以的，比如通过FactoryBean：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZhouyuFactoryBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();<br><br><span class="hljs-keyword">return</span> userService;<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Class&lt;?&gt; getObjectType() &#123;<br><span class="hljs-keyword">return</span> UserService.class;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>通过上面这段代码，我们自己创造了一个UserService对象，并且它将成为Bean。但是通过这种方式创造出来的UserService的Bean，<strong>只会经过****初始化后</strong>，其他Spring的生命周期步骤是不会经过的，比如依赖注入。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">context.getBean(<span class="hljs-string">&quot;zhouyuFactoryBean&quot;</span>)<span class="hljs-regexp">//</span>返回的是userService对象<br>context.getBean(<span class="hljs-string">&quot;&amp;zhouyuFactoryBean&quot;</span>)<span class="hljs-regexp">//</span>返回的是zhouyuFactoryBean对象<br></code></pre></td></tr></table></figure><p>有同学可能会想到，通过@Bean也可以自己生成一个对象作为Bean，那么和FactoryBean的区别是什么呢？其实在很多场景下他俩是可以替换的，但是站在原理层面来说的，区别很明显，**@Bean定义的Bean是会经过完整的Bean生命周期的**。</p><h2 id="ExcludeFilter和IncludeFilter"><a href="#ExcludeFilter和IncludeFilter" class="headerlink" title="ExcludeFilter和IncludeFilter"></a>ExcludeFilter和IncludeFilter</h2><p>这两个Filter是Spring扫描过程中用来过滤的。ExcludeFilter表示<strong>排除过滤器</strong>，IncludeFilter表示<strong>包含过滤器</strong>。</p><p>比如以下配置，表示扫描com.zhouyu这个包下面的所有类，但是排除UserService类，也就是就算它上面有@Component注解也不会成为Bean。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ComponentScan(value = &quot;com.zhouyu&quot;,</span><br><span class="hljs-meta">excludeFilters = &#123;@ComponentScan.Filter(</span><br><span class="hljs-meta">            type = FilterType.ASSIGNABLE_TYPE, </span><br><span class="hljs-meta">            classes = UserService.class)&#125;.)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>再比如以下配置，就算UserService类上没有@Component注解，它也会被扫描成为一个Bean。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ComponentScan(value = &quot;com.zhouyu&quot;,</span><br><span class="hljs-meta">includeFilters = &#123;@ComponentScan.Filter(</span><br><span class="hljs-meta">            type = FilterType.ASSIGNABLE_TYPE, </span><br><span class="hljs-meta">            classes = UserService.class)&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>FilterType分为：</p><ol><li>ANNOTATION：表示是否包含某个注解</li><li>ASSIGNABLE_TYPE：表示是否是某个类</li><li>ASPECTJ：表示否是符合某个Aspectj表达式</li><li>REGEX：表示是否符合某个正则表达式</li><li>CUSTOM：自定义</li></ol><p>在Spring的扫描逻辑中，默认会添加一个AnnotationTypeFilter给includeFilters，表示默认情况下Spring扫描过程中会认为类上有@Component注解的就是Bean。</p><h2 id="MetadataReader、ClassMetadata、AnnotationMetadata"><a href="#MetadataReader、ClassMetadata、AnnotationMetadata" class="headerlink" title="MetadataReader、ClassMetadata、AnnotationMetadata"></a>MetadataReader、ClassMetadata、AnnotationMetadata</h2><p>在Spring中需要去解析类的信息，比如类名、类中的方法、类上的注解，这些都可以称之为类的元数据，所以Spring中对类的元数据做了抽象，并提供了一些工具类。</p><p>MetadataReader表示类的元数据读取器，默认实现类为<strong>SimpleMetadataReader</strong>。比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><span class="hljs-type">SimpleMetadataReaderFactory</span> <span class="hljs-variable">simpleMetadataReaderFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMetadataReaderFactory</span>();<br><br>        <span class="hljs-comment">// 构造一个MetadataReader</span><br>        <span class="hljs-type">MetadataReader</span> <span class="hljs-variable">metadataReader</span> <span class="hljs-operator">=</span> simpleMetadataReaderFactory.getMetadataReader(<span class="hljs-string">&quot;com.zhouyu.service.UserService&quot;</span>);<br><br>        <span class="hljs-comment">// 得到一个ClassMetadata，并获取了类名</span><br>        <span class="hljs-type">ClassMetadata</span> <span class="hljs-variable">classMetadata</span> <span class="hljs-operator">=</span> metadataReader.getClassMetadata();<br><br>        System.out.println(classMetadata.getClassName());<br>        <br>        <span class="hljs-comment">// 获取一个AnnotationMetadata，并获取类上的注解信息</span><br>        <span class="hljs-type">AnnotationMetadata</span> <span class="hljs-variable">annotationMetadata</span> <span class="hljs-operator">=</span> metadataReader.getAnnotationMetadata();<br><span class="hljs-keyword">for</span> (String annotationType : annotationMetadata.getAnnotationTypes()) &#123;<br>System.out.println(annotationType);<br>&#125;<br><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>需要注意的是，SimpleMetadataReader去解析类时，使用的<strong>ASM技术</strong>。</p><p>为什么要使用ASM技术，Spring启动的时候需要去扫描，如果指定的包路径比较宽泛，那么扫描的类是非常多的，那如果在Spring启动时就把这些类全部加载进JVM了，这样不太好，所以使用了ASM技术。</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2、手写模拟Spring底层原理</title>
    <link href="/2023/05/30/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/2%E3%80%81%E6%89%8B%E5%86%99%E6%A8%A1%E6%8B%9FSpring%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/"/>
    <url>/2023/05/30/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/2%E3%80%81%E6%89%8B%E5%86%99%E6%A8%A1%E6%8B%9FSpring%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<p>1、Spring的底层源码启动过程</p><p>2、BeanDefinition、BeanPostProcessor的概念</p><p>3、Spring解析配置类等底层源码工作流程</p><p>4、依赖注入、Aware回调等底层源码工作流程</p><p>5、Spring AOP的底层源码工作流程</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>架构之项目实战</title>
    <link href="/2023/05/11/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/"/>
    <url>/2023/05/11/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
    </categories>
    
    
    <tags>
      
      <tag>架构之项目实战</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>架构之微服务</title>
    <link href="/2023/05/11/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    <url>/2023/05/11/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E5%BE%AE%E6%9C%8D%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
    </categories>
    
    
    <tags>
      
      <tag>架构之微服务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>架构之分布式框架</title>
    <link href="/2023/05/11/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6/"/>
    <url>/2023/05/11/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
    </categories>
    
    
    <tags>
      
      <tag>架构之分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>架构之并发编程</title>
    <link href="/2023/05/11/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    <url>/2023/05/11/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
    </categories>
    
    
    <tags>
      
      <tag>架构之并发编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>1、Spring底层核心原理解析</title>
    <link href="/2023/05/11/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/1%E3%80%81Spring%E5%BA%95%E5%B1%82%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/05/11/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E6%9E%B6%E6%9E%84%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/1%E3%80%81Spring%E5%BA%95%E5%B1%82%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>对Spring的底层有一个整体的大致了解：</p><ol><li>Bean的生命周期(创建和销毁)底层原理</li><li>依赖注入底层原理</li><li>初始化底层原理</li><li>推断构造方法底层原理</li><li>AOP底层原理</li><li>Spring事务底层原理</li></ol><p>后续将针对每个流程详细深入的讲解并分析源码实现</p><p><strong>UserService.class —&gt; 无参构造方法 —&gt; 对象 —&gt; 依赖注入(给有@Autowired属性赋值) —&gt;初始化前(@PostContract注解)—&gt;初始化(Implement InitializingBean)—&gt;初始化后(AOP)—&gt;代理对象—&gt;Bean</strong></p><p>首先分析入门使用的Spring代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ClassPathXmlApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;spring.xml&quot;</span>);<br><span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> (UserService) context.getBean(<span class="hljs-string">&quot;userService&quot;</span>);<br>userService.test();<br></code></pre></td></tr></table></figure><p>对于这三行代码应该，大部分同学应该都是比较熟悉，这是学习Spring的hello world。可是，这三行代码底层都做了什么，比如：</p><ol><li>第一行代码，会构造一个ClassPathXmlApplicationContext对象，ClassPathXmlApplicationContext该如何理解，调用该构造方法除开会实例化得到一个对象，还会做哪些事情？</li><li>第二行代码，会调用ClassPathXmlApplicationContext的getBean方法，会得到一个UserService对象，getBean()是如何实现的？返回的UserService对象和我们自己直接new的UserService对象有区别吗？</li><li>第三行代码，就是简单的调用UserService的test()方法，不难理解。</li></ol><p>光看这三行代码，其实<strong>并不能体现出来Spring的强大之处</strong>，也不能理解为什么需要ClassPathXmlApplicationContext和getBean()方法，随着课程的深入将会改变你此时的观念，而对于上面的这些疑问，也会随着课程深入逐步得到解决。对于这三行代码，你现在可以认为：如果你要用Spring，你就得这么写。就像你要用Mybatis，你就得写各种Mapper接口。</p><p>但是用ClassPathXmlApplicationContext其实已经过时了，在新版的Spring MVC和Spring Boot的底层主要用的都是<strong>AnnotationConfigApplicationContext</strong>，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(AppConfig.class);<br><span class="hljs-comment">//ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(&quot;spring.xml&quot;);</span><br><span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> (UserService) context.getBean(<span class="hljs-string">&quot;userService&quot;</span>);<br>userService.test();<br></code></pre></td></tr></table></figure><p>可以看到AnnotationConfigApplicationContext的用法和ClassPathXmlApplicationContext是非常类似的，只不过需要传入的是一个class，而不是一个xml文件。</p><p>而AppConfig.class和spring.xml一样，表示Spring的配置，比如可以指定扫描路径，可以直接定义Bean，比如：</p><p>spring.xml中的内容为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;context:component-scan base-<span class="hljs-keyword">package</span>=<span class="hljs-string">&quot;com.zhouyu&quot;</span>/&gt;<br>&lt;bean id=<span class="hljs-string">&quot;userService&quot;</span> class=<span class="hljs-string">&quot;com.zhouyu.service.UserService&quot;</span>/&gt;<br></code></pre></td></tr></table></figure><p>AppConfig中的内容为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ComponentScan(&quot;com.zhouyu&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> UserService <span class="hljs-title function_">userService</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>所以spring.xml和AppConfig.class本质上是一样的。</p><p>目前，我们基本很少直接使用上面这种方式来用Spring，而是使用Spring MVC，或者Spring Boot，但是它们都是基于上面这种方式的，都需要在内部去创建一个ApplicationContext的，只不过：</p><ol><li>Spring MVC创建的是<strong>XmlWebApplicationContext</strong>，和<strong>ClassPathXmlApplicationContext</strong>类似，都是基于XML配置的</li><li>Spring Boot创建的是<strong>AnnotationConfigApplicationContext</strong></li></ol><p>因为AnnotationConfigApplicationContext是比较重要的，并且AnnotationConfigApplicationContext和ClassPathXmlApplicationContext大部分底层都是共同的，后续课程我们会着重将AnnotationConfigApplicationContext的底层实现，对于ClassPathXmlApplicationContext，同学们可以在课程结束后作为作业，业余时间看看相关源码即可。</p><h2 id="Spring中是如何创建一个对象？"><a href="#Spring中是如何创建一个对象？" class="headerlink" title="Spring中是如何创建一个对象？"></a>Spring中是如何创建一个对象？</h2><p>其实不管是AnnotationConfigApplicationContext还是ClassPathXmlApplicationContext，目前，我们都可以简单的将它们理解为就是用来创建Java对象的，比如调用getBean()就会去创建对象（此处不严谨，getBean可能也不会去创建对象，后续课程详解）。</p><p>在Java语言中，肯定是根据某个类来创建一个对象的。我们在看一下实例代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(AppConfig.class);<br><span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> (UserService) context.getBean(<span class="hljs-string">&quot;userService&quot;</span>);<br>userService.test();<br></code></pre></td></tr></table></figure><p>当我们调用context.getBean(“userService”)时，就会去创建一个对象，但是getBean方法内部怎么知道”userService”对应的是UserService类呢？</p><p>所以，我们就可以分析出来，在调用AnnotationConfigApplicationContext的构造方法时，也就是第一行代码，会去做一些事情：</p><ol><li>解析AppConfig.class，得到扫描路径</li><li>遍历扫描路径下的所有Java类，如果发现某个类上存在@Component、@Service等注解，那么Spring就把这个类记录下来，存在一个Map中，比如Map&lt;String, Class&gt;。（<strong>实际上，Spring源码中确实存在类似的这么一个Map，叫做BeanDefinitionMap，后续课程会讲到</strong>）</li><li>Spring会根据某个规则生成当前类对应的beanName，作为key存入Map，当前类作为value</li></ol><p>这样，但调用context.getBean(“userService”)时，就可以根据”userService”找到UserService类，从而就可以去创建对象了。</p><h2 id="Bean的创建过程"><a href="#Bean的创建过程" class="headerlink" title="Bean的创建过程"></a>Bean的创建过程</h2><p>那么Spring到底是如何来创建一个Bean的呢，这个就是Bean创建的生命周期，大致过程如下</p><ol><li>利用该类的构造方法来实例化得到一个对象（但是如何一个类中有多个构造方法，Spring则会进行选择，这个叫做<strong>推断构造方法</strong>）</li><li>得到一个对象后，Spring会判断该对象中是否存在被@Autowired注解了的属性，把这些属性找出来并由Spring进行赋值（<strong>依赖注入</strong>）</li><li>依赖注入后，Spring会判断该对象是否实现了BeanNameAware接口、BeanClassLoaderAware接口、BeanFactoryAware接口，如果实现了，就表示当前对象必须实现该接口中所定义的setBeanName()、setBeanClassLoader()、setBeanFactory()方法，那Spring就会调用这些方法并传入相应的参数（<strong>Aware回调</strong>）</li><li>Aware回调后，Spring会判断该对象中是否存在某个方法被@PostConstruct注解了，如果存在，Spring会调用当前对象的此方法（<strong>初始化前</strong>）</li><li>紧接着，Spring会判断该对象是否实现了InitializingBean接口，如果实现了，就表示当前对象必须实现该接口中的afterPropertiesSet()方法，那Spring就会调用当前对象中的afterPropertiesSet()方法（<strong>初始化</strong>）</li><li>最后，Spring会判断当前对象需不需要进行AOP，如果不需要那么Bean就创建完了，如果需要进行AOP，则会进行动态代理并生成一个代理对象做为Bean（<strong>初始化后</strong>）</li></ol><p>通过最后一步，我们可以发现，当Spring根据UserService类来创建一个Bean时：</p><ol><li>如果不用进行AOP，那么Bean就是UserService类的构造方法所得到的对象。</li><li>如果需要进行AOP，那么Bean就是UserService的代理类所实例化得到的对象，而不是UserService本身所得到的对象。</li></ol><p>Bean对象创建出来后：</p><ol><li>如果当前Bean是单例Bean，那么会把该Bean对象存入一个Map&lt;String, Object&gt;，Map的key为beanName，value为Bean对象。这样下次getBean时就可以直接从Map中拿到对应的Bean对象了。（实际上，在Spring源码中，这个Map就是<strong>单例池</strong>）</li><li>如果当前Bean是原型Bean，那么后续没有其他动作，不会存入一个Map，下次getBean时会再次执行上述创建过程，得到一个新的Bean对象。</li></ol><h2 id="推断构造方法"><a href="#推断构造方法" class="headerlink" title="推断构造方法"></a>推断构造方法</h2><p>Spring在基于某个类生成Bean的过程中，需要利用该类的构造方法来实例化得到一个对象，但是<strong>如果一个类存在多个构造方法，Spring会使用哪个呢？</strong></p><p>Spring的判断逻辑如下：</p><ol><li><p>如果一个类只存在一个构造方法，不管该构造方法是无参构造方法，还是有参构造方法，Spring都会用这个构造方法</p></li><li><p>如果一个类存在多个构造方法</p></li><li><ol><li>这些构造方法中，存在一个无参的构造方法，那么Spring就会用这个无参的构造方法</li><li>这些构造方法中，不存在一个无参的构造方法，那么Spring就会<strong>报错</strong></li></ol></li></ol><p>Spring的设计思想是这样的：</p><ol><li><p>如果一个类只有一个构造方法，那么没得选择，只能用这个构造方法</p></li><li><p>如果一个类存在多个构造方法，Spring不知道如何选择，就会看是否有无参的构造方法，因为无参构造方法本身表示了一种默认的意义</p></li><li><p>不过如果某个构造方法上加了@Autowired注解，那就表示程序员告诉Spring就用这个加了注解的方法，那Spring就会用这个加了@Autowired注解构造方法了</p></li></ol><p>需要重视的是，如果Spring选择了一个有参的构造方法，Spring在调用这个有参构造方法时，需要传入参数，那这个参数是怎么来的呢？</p><p>Spring会根据入参的类型和入参的名字去Spring中找Bean对象（以单例Bean为例，Spring会从单例池那个Map中去找）：</p><ol><li>先根据入参类型找，如果只找到一个，那就直接用来作为入参</li><li>如果根据类型找到多个，则再根据入参名字来确定唯一一个</li><li>最终如果没有找到，则会报错，无法创建当前Bean对象</li></ol><p>确定用哪个构造方法，确定入参的Bean对象，这个过程就叫做<strong>推断构造方法</strong>。</p><h2 id="AOP大致流程"><a href="#AOP大致流程" class="headerlink" title="AOP大致流程"></a>AOP大致流程</h2><p>AOP就是进行动态代理，在创建一个Bean的过程中，Spring在最后一步会去判断当前正在创建的这个Bean是不是需要进行AOP，如果需要则会进行动态代理。</p><p>如何判断当前Bean对象需不需要进行AOP:</p><ol><li>找出所有的切面Bean</li><li>遍历切面中的每个方法，看是否写了@Before、@After等注解</li><li>如果写了，则判断所对应的Pointcut是否和当前Bean对象的类是否匹配</li><li>如果匹配则表示当前Bean对象有匹配的的Pointcut，表示需要进行AOP</li></ol><p>利用cglib进行AOP的大致流程：</p><ol><li><p>生成代理类UserServiceProxy，代理类继承UserService</p></li><li><p>代理类中重写了父类的方法，比如UserService中的test()方法</p></li><li><p>代理类中还会有一个target属性，该属性的值为被代理对象（也就是通过UserService类推断构造方法实例化出来的对象，进行了依赖注入、初始化等步骤的对象）</p></li><li><p>代理类中的test()方法被执行时的逻辑如下：</p></li><li><ol><li>执行切面逻辑（@Before）</li><li>调用target.test()</li></ol></li></ol><p>当我们从Spring容器得到UserService的Bean对象时，拿到的就是UserServiceProxy所生成的对象，也就是代理对象。</p><p>UserService代理对象.test()—&gt;执行切面逻辑—&gt;target.test()，注意target对象不是代理对象，而是被代理对象。</p><h2 id="Spring事务"><a href="#Spring事务" class="headerlink" title="Spring事务"></a>Spring事务</h2><p>当我们在某个方法上加了@Transactional注解后，就表示该方法在调用时会开启Spring事务，而这个方法所在的类所对应的Bean对象会是该类的代理对象。</p><p>Spring事务的代理对象执行某个方法时的步骤：</p><ol><li>判断当前执行的方法是否存在@Transactional注解</li><li>如果存在，则利用事务管理器（TransactionMananger）新建一个数据库连接</li><li>修改数据库连接的autocommit为false</li><li>执行target.test()，执行程序员所写的业务逻辑代码，也就是执行sql</li><li>执行完了之后如果没有出现异常，则提交，否则回滚</li></ol><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
      <category>架构之源码解析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM指令手册</title>
    <link href="/2023/05/11/Java%20Virtual%20Machine/JVM%E6%8C%87%E4%BB%A4%E6%89%8B%E5%86%8C/"/>
    <url>/2023/05/11/Java%20Virtual%20Machine/JVM%E6%8C%87%E4%BB%A4%E6%89%8B%E5%86%8C/</url>
    
    <content type="html"><![CDATA[<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">0x00</span>nop什么都不做。<br><span class="hljs-number">0x01</span>aconst_null将 <span class="hljs-literal">null</span> 推送至栈顶。<br><span class="hljs-number">0x02</span>iconst_m1将 <span class="hljs-type">int</span> 型-<span class="hljs-number">1</span> 推送至栈顶。<br><span class="hljs-number">0x03</span>iconst_0将 <span class="hljs-type">int</span> 型 <span class="hljs-number">0</span> 推送至栈顶。<br><span class="hljs-number">0x04</span>iconst_1将 <span class="hljs-type">int</span> 型 <span class="hljs-number">1</span> 推送至栈顶<br><span class="hljs-number">0x05</span>iconst_2将 <span class="hljs-type">int</span> 型 <span class="hljs-number">2</span> 推送至栈顶<br><span class="hljs-number">0x06</span>iconst_3将 <span class="hljs-type">int</span> 型 <span class="hljs-number">3</span> 推送至栈顶<br><span class="hljs-number">0x07</span>iconst_4将 <span class="hljs-type">int</span> 型 <span class="hljs-number">4</span> 推送至栈顶<br><span class="hljs-number">0x08</span>iconst_5将 <span class="hljs-type">int</span> 型 <span class="hljs-number">5</span> 推送至栈顶<br><span class="hljs-number">0x09</span>lconst_0将 <span class="hljs-type">long</span> 型 <span class="hljs-number">0</span> 推送至栈顶<br><span class="hljs-number">0x0a</span>lconst_1将 <span class="hljs-type">long</span> 型 <span class="hljs-number">1</span> 推送至栈顶<br><span class="hljs-number">0x0b</span>fconst_0将 <span class="hljs-type">float</span> 型 <span class="hljs-number">0</span> 推送至栈顶<br><span class="hljs-number">0x0c</span>fconst_1将 <span class="hljs-type">float</span> 型 <span class="hljs-number">1</span> 推送至栈顶<br><span class="hljs-number">0x0d</span>fconst_2将 <span class="hljs-type">float</span> 型 <span class="hljs-number">2</span> 推送至栈顶<br><span class="hljs-number">0x0e</span>dconst_0将 <span class="hljs-type">double</span> 型 <span class="hljs-number">0</span> 推送至栈顶<br><span class="hljs-number">0x0f</span>dconst_1将 <span class="hljs-type">double</span> 型 <span class="hljs-number">1</span> 推送至栈顶<br><span class="hljs-number">0x10</span>bipush    将单字节的常量值（-<span class="hljs-number">128</span>~<span class="hljs-number">127</span>）推送至栈顶<br><span class="hljs-number">0x11</span>sipush    将一个短整型常量值（-<span class="hljs-number">32768</span>~<span class="hljs-number">32767</span>）推送至栈顶<br><span class="hljs-number">0x12</span>ldc        将 <span class="hljs-type">int</span>，<span class="hljs-type">float</span> 或 String 型常量值从常量池中推送至栈顶<br><span class="hljs-number">0x13</span>ldc_w    将 <span class="hljs-type">int</span>，<span class="hljs-type">float</span> 或 String 型常量值从常量池中推送至栈顶（宽 索引）<br><span class="hljs-number">0x14</span>ldc2_w    将 <span class="hljs-type">long</span> 或 <span class="hljs-type">double</span> 型常量值从常量池中推送至栈顶（宽索引）<br><span class="hljs-number">0x15</span>iload    将指定的 <span class="hljs-type">int</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x16</span>lload    将指定的 <span class="hljs-type">long</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x17</span>fload    将指定的 <span class="hljs-type">float</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x18</span>dload    将指定的 <span class="hljs-type">double</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x19</span>aload    将指定的引用类型局部变量推送至栈顶<br><span class="hljs-number">0x1a</span>iload_0    将第一个 <span class="hljs-type">int</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x1b</span>iload_1    将第二个 <span class="hljs-type">int</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x1c</span>iload_2    将第三个 <span class="hljs-type">int</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x1d</span>iload_3    将第四个 <span class="hljs-type">int</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x1e</span>lload_0    将第一个 <span class="hljs-type">long</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x1f</span>lload_1    将第二个 <span class="hljs-type">long</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x20</span>lload_2    将第三个 <span class="hljs-type">long</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x21</span>lload_3    将第四个 <span class="hljs-type">long</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x22</span>fload_0    将第一个 <span class="hljs-type">float</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x23</span>fload_1    将第二个 <span class="hljs-type">float</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x24</span>fload_2    将第三个 <span class="hljs-type">float</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x25</span>fload_3    将第四个 <span class="hljs-type">float</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x26</span>dload_0    将第一个 <span class="hljs-type">double</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x27</span>dload_1    将第二个 <span class="hljs-type">double</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x28</span>dload_2    将第三个 <span class="hljs-type">double</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x29</span>dload_3    将第四个 <span class="hljs-type">double</span> 型局部变量推送至栈顶<br><span class="hljs-number">0x2a</span>aload_0    将第一个引用类型局部变量推送至栈顶<br><span class="hljs-number">0x2b</span>aload_1    将第二个引用类型局部变量推送至栈顶<br><span class="hljs-number">0x2c</span>aload_2    将第三个引用类型局部变量推送至栈顶<br><span class="hljs-number">0x2d</span>aload_3    将第四个引用类型局部变量推送至栈顶<br><span class="hljs-number">0x2e</span>iaload    将 <span class="hljs-type">int</span> 型数组指定索引的值推送至栈顶<br><span class="hljs-number">0x2f</span>laload    将 <span class="hljs-type">long</span> 型数组指定索引的值推送至栈顶<br><span class="hljs-number">0x30</span>faload    将 <span class="hljs-type">float</span> 型数组指定索引的值推送至栈顶<br><span class="hljs-number">0x31</span>daload    将 <span class="hljs-type">double</span> 型数组指定索引的值推送至栈顶<br><span class="hljs-number">0x32</span>aaload    将引用型数组指定索引的值推送至栈顶<br><span class="hljs-number">0x33</span>baload    将 <span class="hljs-type">boolean</span> 或 <span class="hljs-type">byte</span> 型数组指定索引的值推送至栈顶<br><span class="hljs-number">0x34</span>caload    将 <span class="hljs-type">char</span> 型数组指定索引的值推送至栈顶<br><span class="hljs-number">0x35</span>saload    将 <span class="hljs-type">short</span> 型数组指定索引的值推送至栈顶<br><span class="hljs-number">0x36</span>istore    将栈顶 <span class="hljs-type">int</span> 型数值存入指定局部变量<br><span class="hljs-number">0x37</span>lstore    将栈顶 <span class="hljs-type">long</span> 型数值存入指定局部变量<br><span class="hljs-number">0x38</span>fstore    将栈顶 <span class="hljs-type">float</span> 型数值存入指定局部变量<br><span class="hljs-number">0x39</span>dstore    将栈顶 <span class="hljs-type">double</span> 型数值存入指定局部变量<br><span class="hljs-number">0x3a</span>astore    将栈顶引用型数值存入指定局部变量<br><span class="hljs-number">0x3b</span>istore_0将栈顶 <span class="hljs-type">int</span> 型数值存入第一个局部变量<br><span class="hljs-number">0x3c</span>istore_1将栈顶 <span class="hljs-type">int</span> 型数值存入第二个局部变量<br><span class="hljs-number">0x3d</span>istore_2将栈顶 <span class="hljs-type">int</span> 型数值存入第三个局部变量<br><span class="hljs-number">0x3e</span>istore_3将栈顶 <span class="hljs-type">int</span> 型数值存入第四个局部变量<br><span class="hljs-number">0x3f</span>lstore_0将栈顶 <span class="hljs-type">long</span> 型数值存入第一个局部变量<br><span class="hljs-number">0x40</span>lstore_1将栈顶 <span class="hljs-type">long</span> 型数值存入第二个局部变量<br><span class="hljs-number">0x41</span>lstore_2将栈顶 <span class="hljs-type">long</span> 型数值存入第三个局部变量<br><span class="hljs-number">0x42</span>lstore_3将栈顶 <span class="hljs-type">long</span> 型数值存入第四个局部变量<br><span class="hljs-number">0x43</span>fstore_0将栈顶 <span class="hljs-type">float</span> 型数值存入第一个局部变量<br><span class="hljs-number">0x44</span>fstore_1将栈顶 <span class="hljs-type">float</span> 型数值存入第二个局部变量<br><span class="hljs-number">0x45</span>fstore_2将栈顶 <span class="hljs-type">float</span> 型数值存入第三个局部变量<br><span class="hljs-number">0x46</span>fstore_3将栈顶 <span class="hljs-type">float</span> 型数值存入第四个局部变量<br><span class="hljs-number">0x47</span>dstore_0将栈顶 <span class="hljs-type">double</span> 型数值存入第一个局部变量<br><span class="hljs-number">0x48</span>dstore_1将栈顶 <span class="hljs-type">double</span> 型数值存入第二个局部变量<br><span class="hljs-number">0x49</span>dstore_2将栈顶 <span class="hljs-type">double</span> 型数值存入第三个局部变量<br><span class="hljs-number">0x4a</span>dstore_3将栈顶 <span class="hljs-type">double</span> 型数值存入第四个局部变量<br><span class="hljs-number">0x4b</span>astore_0将栈顶引用型数值存入第一个局部变量<br><span class="hljs-number">0x4c</span>astore_1将栈顶引用型数值存入第二个局部变量<br><span class="hljs-number">0x4d</span>astore_2将栈顶引用型数值存入第三个局部变量<br><span class="hljs-number">0x4e</span>astore_3将栈顶引用型数值存入第四个局部变量<br><span class="hljs-number">0x4f</span>iastore    将栈顶 <span class="hljs-type">int</span> 型数值存入指定数组的指定索引位置<br><span class="hljs-number">0x50</span>lastore    将栈顶 <span class="hljs-type">long</span> 型数值存入指定数组的指定索引位置<br><span class="hljs-number">0x51</span>fastore    将栈顶 <span class="hljs-type">float</span> 型数值存入指定数组的指定索引位置<br><span class="hljs-number">0x52</span>dastore    将栈顶 <span class="hljs-type">double</span> 型数值存入指定数组的指定索引位置<br><span class="hljs-number">0x53</span>aastore    将栈顶引用型数值存入指定数组的指定索引位置<br><span class="hljs-number">0x54</span>bastore    将栈顶 <span class="hljs-type">boolean</span> 或 <span class="hljs-type">byte</span> 型数值存入指定数组的指定索引位置<br><span class="hljs-number">0x55</span>castore    将栈顶 <span class="hljs-type">char</span> 型数值存入指定数组的指定索引位置<br><span class="hljs-number">0x56</span>sastore    将栈顶 <span class="hljs-type">short</span> 型数值存入指定数组的指定索引位置<br><span class="hljs-number">0x57</span>pop        将栈顶数值弹出（数值不能是 <span class="hljs-type">long</span> 或 <span class="hljs-type">double</span> 类型的）<br><span class="hljs-number">0x58</span>pop2    将栈顶的一个（<span class="hljs-type">long</span> 或 <span class="hljs-type">double</span> 类型的）或两个数值弹出（其 它）<br><span class="hljs-number">0x59</span>dup        复制栈顶数值并将复制值压入栈顶<br><span class="hljs-number">0x5a</span>dup_x1    复制栈顶数值并将两个复制值压入栈顶<br><span class="hljs-number">0x5b</span>dup_x2    复制栈顶数值并将三个（或两个）复制值压入栈顶<br><span class="hljs-number">0x5c</span>dup2    复制栈顶一个（<span class="hljs-type">long</span> 或 <span class="hljs-type">double</span> 类型的)或两个（其它）数值并 将复制值压入栈顶<br><span class="hljs-number">0x5d</span>dup2_x1    dup_x1 指令的双倍版本<br><span class="hljs-number">0x5e</span>dup2_x2    dup_x2 指令的双倍版本<br><span class="hljs-number">0x5f</span>swap    将栈最顶端的两个数值互换（数值不能是 <span class="hljs-type">long</span> 或 <span class="hljs-type">double</span> 类型 的）<br><span class="hljs-number">0x60</span>iadd    将栈顶两 <span class="hljs-type">int</span> 型数值相加并将结果压入栈顶<br><span class="hljs-number">0x61</span>ladd    将栈顶两 <span class="hljs-type">long</span> 型数值相加并将结果压入栈顶<br><span class="hljs-number">0x62</span>fadd    将栈顶两 <span class="hljs-type">float</span> 型数值相加并将结果压入栈顶<br><span class="hljs-number">0x63</span>dadd    将栈顶两 <span class="hljs-type">double</span> 型数值相加并将结果压入栈顶<br><span class="hljs-number">0x64</span>isub    将栈顶两 <span class="hljs-type">int</span> 型数值相减并将结果压入栈顶<br><span class="hljs-number">0x65</span>lsub    将栈顶两 <span class="hljs-type">long</span> 型数值相减并将结果压入栈顶<br><span class="hljs-number">0x66</span>fsub    将栈顶两 <span class="hljs-type">float</span> 型数值相减并将结果压入栈顶<br><span class="hljs-number">0x67</span>dsub    将栈顶两 <span class="hljs-type">double</span> 型数值相减并将结果压入栈顶<br><span class="hljs-number">0x68</span>imul    将栈顶两 <span class="hljs-type">int</span> 型数值相乘并将结果压入栈顶。<br><span class="hljs-number">0x69</span>lmul    将栈顶两 <span class="hljs-type">long</span> 型数值相乘并将结果压入栈顶<br><span class="hljs-number">0x6a</span>fmul    将栈顶两 <span class="hljs-type">float</span> 型数值相乘并将结果压入栈顶<br><span class="hljs-number">0x6b</span>dmul    将栈顶两 <span class="hljs-type">double</span> 型数值相乘并将结果压入栈顶<br><span class="hljs-number">0x6c</span>idiv    将栈顶两 <span class="hljs-type">int</span> 型数值相除并将结果压入栈顶<br><span class="hljs-number">0x6d</span>ldiv    将栈顶两 <span class="hljs-type">long</span> 型数值相除并将结果压入栈顶<br><span class="hljs-number">0x6e</span>fdiv    将栈顶两 <span class="hljs-type">float</span> 型数值相除并将结果压入栈顶<br><span class="hljs-number">0x6f</span>ddiv    将栈顶两 <span class="hljs-type">double</span> 型数值相除并将结果压入栈顶<br><span class="hljs-number">0x70</span>irem    将栈顶两 <span class="hljs-type">int</span> 型数值作取模运算并将结果压入栈顶<br><span class="hljs-number">0x71</span>lrem    将栈顶两 <span class="hljs-type">long</span> 型数值作取模运算并将结果压入栈顶<br><span class="hljs-number">0x72</span>frem    将栈顶两 <span class="hljs-type">float</span> 型数值作取模运算并将结果压入栈顶<br><span class="hljs-number">0x73</span>drem    将栈顶两 <span class="hljs-type">double</span> 型数值作取模运算并将结果压入栈顶<br><span class="hljs-number">0x74</span>ineg    将栈顶 <span class="hljs-type">int</span> 型数值取负并将结果压入栈顶<br><span class="hljs-number">0x75</span>lneg    将栈顶 <span class="hljs-type">long</span> 型数值取负并将结果压入栈顶<br><span class="hljs-number">0x76</span>fneg    将栈顶 <span class="hljs-type">float</span> 型数值取负并将结果压入栈顶<br><span class="hljs-number">0x77</span>dneg    将栈顶 <span class="hljs-type">double</span> 型数值取负并将结果压入栈顶<br><span class="hljs-number">0x78</span>ishl    将 <span class="hljs-type">int</span> 型数值左移位指定位数并将结果压入栈顶<br><span class="hljs-number">0x79</span>lshl    将 <span class="hljs-type">long</span> 型数值左移位指定位数并将结果压入栈顶<br><span class="hljs-number">0x7a</span>ishr    将 <span class="hljs-type">int</span> 型数值右（有符号）移位指定位数并将结果压入栈顶<br><span class="hljs-number">0x7b</span>lshr    将 <span class="hljs-type">long</span> 型数值右（有符号）移位指定位数并将结果压入栈顶<br><span class="hljs-number">0x7c</span>iushr    将 <span class="hljs-type">int</span> 型数值右（无符号）移位指定位数并将结果压入栈顶<br><span class="hljs-number">0x7d</span>lushr    将 <span class="hljs-type">long</span> 型数值右（无符号）移位指定位数并将结果压入栈顶<br><span class="hljs-number">0x7e</span>iand    将栈顶两 <span class="hljs-type">int</span> 型数值作“按位与”并将结果压入栈顶<br><span class="hljs-number">0x7f</span>land    将栈顶两 <span class="hljs-type">long</span> 型数值作“按位与”并将结果压入栈顶<br><span class="hljs-number">0x80</span>ior        将栈顶两 <span class="hljs-type">int</span> 型数值作“按位或”并将结果压入栈顶<br><span class="hljs-number">0x81</span>lor        将栈顶两 <span class="hljs-type">long</span> 型数值作“按位或”并将结果压入栈顶<br><span class="hljs-number">0x82</span>ixor    将栈顶两 <span class="hljs-type">int</span> 型数值作“按位异或”并将结果压入栈顶<br><span class="hljs-number">0x83</span>lxor    将栈顶两 <span class="hljs-type">long</span> 型数值作“按位异或”并将结果压入栈顶<br><span class="hljs-number">0x84</span>iinc    将指定 <span class="hljs-type">int</span> 型变量增加指定值<br><span class="hljs-number">0x85</span>i2l        将栈顶 <span class="hljs-type">int</span> 型数值强制转换成 <span class="hljs-type">long</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x86</span>i2f        将栈顶 <span class="hljs-type">int</span> 型数值强制转换成 <span class="hljs-type">float</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x87</span>i2d        将栈顶 <span class="hljs-type">int</span> 型数值强制转换成 <span class="hljs-type">double</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x88</span>l2i        将栈顶 <span class="hljs-type">long</span> 型数值强制转换成 <span class="hljs-type">int</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x89</span>l2f      将栈顶 <span class="hljs-type">long</span> 型数值强制转换成 <span class="hljs-type">float</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x8a</span>l2d        将栈顶 <span class="hljs-type">long</span> 型数值强制转换成 <span class="hljs-type">double</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x8b</span>f2i        将栈顶 <span class="hljs-type">float</span> 型数值强制转换成 <span class="hljs-type">int</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x8c</span>f2l        将栈顶 <span class="hljs-type">float</span> 型数值强制转换成 <span class="hljs-type">long</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x8d</span>f2d        将栈顶 <span class="hljs-type">float</span> 型数值强制转换成 <span class="hljs-type">double</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x8e</span>d2i        将栈顶 <span class="hljs-type">double</span> 型数值强制转换成 <span class="hljs-type">int</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x8f</span>d2l        将栈顶 <span class="hljs-type">double</span> 型数值强制转换成 <span class="hljs-type">long</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x90</span>d2f        将栈顶 <span class="hljs-type">double</span> 型数值强制转换成 <span class="hljs-type">float</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x91</span>i2b        将栈顶 <span class="hljs-type">int</span> 型数值强制转换成 <span class="hljs-type">byte</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x92</span>i2c        将栈顶 <span class="hljs-type">int</span> 型数值强制转换成 <span class="hljs-type">char</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x93</span>i2s        将栈顶 <span class="hljs-type">int</span> 型数值强制转换成 <span class="hljs-type">short</span> 型数值并将结果压入栈顶<br><span class="hljs-number">0x94</span>lcmp    比较栈顶两 <span class="hljs-type">long</span> 型数值大小，并将结果（<span class="hljs-number">1</span>，<span class="hljs-number">0</span>，-<span class="hljs-number">1</span>）压入栈顶<br><span class="hljs-number">0x95</span>fcmpl    比较栈顶两 <span class="hljs-type">float</span> 型数值大小，并将结果（<span class="hljs-number">1</span>，<span class="hljs-number">0</span>，-<span class="hljs-number">1</span>）压入栈顶；当其中一个数值为“NaN”时，将-<span class="hljs-number">1</span>压入栈顶<br><span class="hljs-number">0x96</span>fcmpg    比较栈顶两 <span class="hljs-type">float</span> 型数值大小，并将结果（<span class="hljs-number">1</span>，<span class="hljs-number">0</span>，-<span class="hljs-number">1</span>）压入栈 顶；当其中一个数值为“NaN”时，将 <span class="hljs-number">1</span> 压入栈顶<br><span class="hljs-number">0x97</span>dcmpl    比较栈顶两 <span class="hljs-type">double</span>型数值大小，并将结果（<span class="hljs-number">1</span>，<span class="hljs-number">0</span>，-<span class="hljs-number">1</span>）压入栈顶；当其中一个数值为“NaN”时，将-<span class="hljs-number">1</span>压入栈顶<br><span class="hljs-number">0x98</span>dcmpg    比较栈顶两 <span class="hljs-type">double</span> 型数值大小，并将结果（<span class="hljs-number">1</span>，<span class="hljs-number">0</span>，-<span class="hljs-number">1</span>）压入栈顶；当其中一个数值为“NaN”时，将<span class="hljs-number">1</span>压入栈顶<br><span class="hljs-number">0x99</span>ifeq    当栈顶 <span class="hljs-type">int</span> 型数值等于 <span class="hljs-number">0</span> 时跳转<br><span class="hljs-number">0x9a</span>ifne    当栈顶 <span class="hljs-type">int</span> 型数值不等于 <span class="hljs-number">0</span> 时跳转<br><span class="hljs-number">0x9b</span>iflt    当栈顶 <span class="hljs-type">int</span> 型数值小于 <span class="hljs-number">0</span> 时跳转<br><span class="hljs-number">0x9c</span>ifge    当栈顶 <span class="hljs-type">int</span> 型数值大于等于 <span class="hljs-number">0</span> 时跳转<br><span class="hljs-number">0x9d</span>ifgt    当栈顶 <span class="hljs-type">int</span> 型数值大于 <span class="hljs-number">0</span> 时跳转<br><span class="hljs-number">0x9e</span>ifle    当栈顶 <span class="hljs-type">int</span> 型数值小于等于 <span class="hljs-number">0</span> 时跳转<br><span class="hljs-number">0x9f</span>if_icmpeq比较栈顶两 <span class="hljs-type">int</span> 型数值大小，当结果等于 <span class="hljs-number">0</span> 时跳转<br><span class="hljs-number">0xa0</span>if_icmpne比较栈顶两 <span class="hljs-type">int</span> 型数值大小，当结果不等于 <span class="hljs-number">0</span> 时跳转<br><span class="hljs-number">0xa1</span>if_icmplt比较栈顶两 <span class="hljs-type">int</span> 型数值大小，当结果小于 <span class="hljs-number">0</span> 时跳转<br><span class="hljs-number">0xa2</span>if_icmpge比较栈顶两 <span class="hljs-type">int</span> 型数值大小，当结果大于等于 <span class="hljs-number">0</span> 时跳转<br><span class="hljs-number">0xa3</span>if_icmpgt比较栈顶两 <span class="hljs-type">int</span> 型数值大小，当结果大于 <span class="hljs-number">0</span> 时跳转<br><span class="hljs-number">0xa4</span>if_icmple比较栈顶两 <span class="hljs-type">int</span> 型数值大小，当结果小于等于 <span class="hljs-number">0</span> 时跳转<br><span class="hljs-number">0xa5</span>if_acmpeq比较栈顶两引用型数值，当结果相等时跳转<br><span class="hljs-number">0xa6</span>if_acmpne比较栈顶两引用型数值，当结果不相等时跳转<br><span class="hljs-number">0xa7</span>goto    无条件跳转<br><span class="hljs-number">0xa8</span>jsr        跳转至指定 <span class="hljs-number">16</span> 位 offset 位置，并将 jsr 下一条指令地址压入栈顶<br><span class="hljs-number">0xa9</span>ret        返回至局部变量指定的 index 的指令位置（一般与 jsr，jsr_w联合使用）<br><span class="hljs-number">0xaa</span>tableswitch用于 <span class="hljs-keyword">switch</span> 条件跳转，<span class="hljs-keyword">case</span> 值连续（可变长度指令）<br><span class="hljs-number">0xab</span>lookupswitch 用于 <span class="hljs-keyword">switch</span> 条件跳转，<span class="hljs-keyword">case</span> 值不连续（可变长度指令）<br><span class="hljs-number">0xac</span>ireturn    从当前方法返回 <span class="hljs-type">int</span><br><span class="hljs-number">0xad</span>lreturn    从当前方法返回 <span class="hljs-type">long</span><br><span class="hljs-number">0xae</span>freturn    从当前方法返回 <span class="hljs-type">float</span><br><span class="hljs-number">0xaf</span>dreturn    从当前方法返回 <span class="hljs-type">double</span><br><span class="hljs-number">0xb0</span>areturn    从当前方法返回对象引用<br><span class="hljs-number">0xb1</span><span class="hljs-keyword">return</span>    从当前方法返回 <span class="hljs-keyword">void</span><br><span class="hljs-number">0xb2</span>getstatic获取指定类的静态域，并将其值压入栈顶<br><span class="hljs-number">0xb3</span>putstatic为指定的类的静态域赋值<br><span class="hljs-number">0xb4</span>getfield获取指定类的实例域，并将其值压入栈顶<br><span class="hljs-number">0xb5</span>putfield为指定的类的实例域赋值<br><span class="hljs-number">0xb6</span>invokevirtual调用实例方法<br><span class="hljs-number">0xb7</span>invokespecial调用超类构造方法，实例初始化方法，私有方法<br><span class="hljs-number">0xb8</span>invokestatic调用静态方法<br><span class="hljs-number">0xb9</span>invokeinterface调用接口方法<br><span class="hljs-number">0xba</span>invokedynamic调用动态链接方法<br><span class="hljs-number">0xbb</span><span class="hljs-keyword">new</span>            创建一个对象，并将其引用值压入栈顶<br><span class="hljs-number">0xbc</span>newarray 创建一个指定原始类型（如  <span class="hljs-type">int</span>、<span class="hljs-type">float</span>、<span class="hljs-type">char</span>„„）的数组， 并将其引用值压入栈顶<br><span class="hljs-number">0xbd</span>anewarray创建一个引用型（如类，接口，数组）的数组，并将其引用值压 入栈顶<br><span class="hljs-number">0xbe</span>arraylength获得数组的长度值并压入栈顶<br><span class="hljs-number">0xbf</span>athrow    将栈顶的异常抛出<br><span class="hljs-number">0xc0</span>checkcast检验类型转换，检验未通过将抛出 ClassCastException<br><span class="hljs-number">0xc1</span><span class="hljs-keyword">instanceof</span>检验对象是否是指定的类的实例，如果是将 <span class="hljs-number">1</span> 压入栈顶，否则将<span class="hljs-number">0</span> 压入栈顶<br><span class="hljs-number">0xc2</span>monitorenter 获得对象的 monitor，用于同步方法或同步块<br><span class="hljs-number">0xc3</span>monitorexit释放对象的 monitor，用于同步方法或同步块<br><span class="hljs-number">0xc4</span>wide    扩展访问局部变量表的索引宽度<br><span class="hljs-number">0xc5</span>multianewarray创建指定类型和指定维度的多维数组（执行该指令时，操作栈中必须包含各维度的长度值），并将其引用值压入栈顶<br><span class="hljs-number">0xc6</span>ifnull     为 <span class="hljs-literal">null</span> 时跳转<br><span class="hljs-number">0xc7</span>ifnonnull不为 <span class="hljs-literal">null</span> 时跳转<br><span class="hljs-number">0xc8</span>goto_w    无条件跳转（宽索引）<br><span class="hljs-number">0xc9</span>jsr_w       跳转至指定 <span class="hljs-number">32</span> 位地址偏移量位置，并将 jsr_w 下一条指令地址 压入栈顶<br><span class="hljs-number">0xca</span>breakpoint调试时的断点标志<br><span class="hljs-number">0xfe</span>impdep1用于在特定硬件中使用的语言后门<br></code></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Java Virtual Machine</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM指令手册</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kubernetes</title>
    <link href="/2023/05/10/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Kubernetes/"/>
    <url>/2023/05/10/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Kubernetes/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>容器化技术</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kubernetes</tag>
      
      <tag>K8S</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Jenkins</title>
    <link href="/2023/05/10/%E4%B8%AD%E9%97%B4%E4%BB%B6/Jenkins/"/>
    <url>/2023/05/10/%E4%B8%AD%E9%97%B4%E4%BB%B6/Jenkins/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>中间件</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>软考中级笔记</title>
    <link href="/2023/04/24/%E8%BD%AF%E8%80%83%E4%B8%AD%E7%BA%A7%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/04/24/%E8%BD%AF%E8%80%83%E4%B8%AD%E7%BA%A7%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>软考中级</category>
      
    </categories>
    
    
    <tags>
      
      <tag>软考</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>计算机网络</title>
    <link href="/2023/04/12/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    <url>/2023/04/12/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>408</category>
      
    </categories>
    
    
    <tags>
      
      <tag>408</tag>
      
      <tag>计算机网络</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>操作系统</title>
    <link href="/2023/04/12/408/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    <url>/2023/04/12/408/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>408</category>
      
    </categories>
    
    
    <tags>
      
      <tag>408</tag>
      
      <tag>计算机网络</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>计算机组成原理</title>
    <link href="/2023/04/12/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/"/>
    <url>/2023/04/12/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>408</category>
      
    </categories>
    
    
    <tags>
      
      <tag>408</tag>
      
      <tag>计算机组成原理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>各类数据库的区分</title>
    <link href="/2023/03/28/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%90%84%E7%B1%BB%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%8C%BA%E5%88%86/"/>
    <url>/2023/03/28/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%90%84%E7%B1%BB%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%8C%BA%E5%88%86/</url>
    
    <content type="html"><![CDATA[<h2 id="1-关系型数据库"><a href="#1-关系型数据库" class="headerlink" title="1. 关系型数据库"></a>1. 关系型数据库</h2><p><strong>1.1什么是关系型数据库</strong></p><p><strong>关系数据库（Relational database），是创建在关系模型基础上的数据库，借助于集合代数等数学概念和方法来处理数据库中的数据。</strong>现实世界中的各种实体以及实体之间的各种联系均用关系模型来表示。</p><ul><li><strong>数据库</strong>：包括一个或多个表</li><li><strong>表（关系 Relation）</strong>：是以列和行的形式组织起来的数据的集合</li><li><strong>列（属性 Attribute）</strong>：在数据库中经常被称为字段</li><li><strong>行（值组 Tuple）</strong>：在数据库中经常被称为记录</li></ul><p>我们可以理解为：系型数据库，是指采用了关系模型来组织数据的数据库。</p><p>例如，可能有一个有关作者信息的名为 authors 的表（关系 Relation）。每列（值组 Tuple）都包含特定类型的信息，如作者的姓氏。每行（属性 Attribute）都包含有关特定作者的所有信息：姓、名、住址等等。</p><p><strong>在关系型数据库当中一个表就是一个关系，一个关系数据库可以包含多个表。</strong></p><p>关系型数据库的主要代表：SQL Server，Oracle，MySQL，PostgreSQL。</p><p><strong>1.2 关系型数据库优点</strong></p><ul><li><strong>事务一致性</strong>：通过事务处理保持数据的一致性</li><li><strong>复杂查询</strong>：支持SQL，可以进行 JOIN 等复杂查询</li><li><strong>容易理解</strong>：二维表结构是非常贴近逻辑世界的一个概念，关系模型相对网状、层次等其他模型来说更容易理解</li><li><strong>使用方便</strong>：通用的 SQL 语言使得操作关系型数据库非常方便</li><li><strong>易于维护</strong>：丰富的完整性(实体完整性、参照完整性和用户定义的完整性)大大减低了数据冗余和数据不一致的概率</li></ul><p><strong>1.3 关系型数据库缺点</strong></p><ul><li><strong>读写性能</strong>：在数据量达到一定规模时，由于关系型数据库的系统逻辑非常复杂，为了维护一致性，使得其非常容易发生死锁等的并发问题，所以导致其读写速度下滑非常严重</li><li><strong>表结构更新</strong>：表结构可以在被定义之后更新，但是如果有比较大的结构变更的话就会变得比较复杂</li><li><strong>高并发</strong>：网站的用户并发性非常高，往往达到每秒上万次读写请求，对于传统关系型数据库来说，硬盘I&#x2F;O是一个很大的瓶颈</li><li><strong>海量数据</strong>：对于关系型数据库来说，在一张包含海量数据的表中查询，效率是非常低的</li></ul><h2 id="2-非关系型数据库"><a href="#2-非关系型数据库" class="headerlink" title="2. 非关系型数据库"></a>2. 非关系型数据库</h2><p><strong>2.1 什么是非关系型数据库</strong></p><p><strong>非关系型数据库（NoSQL）是对不同于传统的关系数据库的数据库管理系统的统称。</strong></p><p>当代典型的关系数据库在一些数据敏感的应用中表现了糟糕的性能，例如为巨量文档创建索引、高流量网站的网页服务，以及发送流式媒体。关系型数据库的典型实现主要被调整用于执行规模小而读写频繁，或者大批量极少写访问的事务。</p><p>NoSQL 的结构通常提供弱一致性的保证，如最终一致性，或交易仅限于单个的数据项。</p><p>NoSQL 提出另一种理念，例如，以键值对存储，且结构不固定，每一个元组可以有不一样的字段，每个元组可以根据需要增加一些自己的键值对，这样就不会局限于固定的结构，可以减少一些时间和空间的开销。</p><p>NoSQL 与 SQL 存在许多显著的不同点，其中最重要的是 NoSQL 不使用 SQL 作为查询语言。其数据存储可以不需要固定的表格模式，也经常会避免使用 SQL 的 JOIN 操作，一般有水平可扩展性的特征。</p><p>非关系型数据库包括：</p><p>临时性键值存储：memcached、Redis&#x3D;</p><p>永久性键值存储：ROMA、Redis</p><p>面向文档的数据库：MongoDB、CouchDB</p><p>面向列的数据库：Cassandra、HBase</p><p>主要代表：MongoDB，Redis，CouchDB</p><p><strong>2.2 非关系型数据库分类</strong></p><p>由于非关系型数据库本身天然的多样性，以及出现的时间较短，相比关系型数据库，非关系型数据库非常多，并且大部分都是开源的。</p><p>非关系型数据库严格上不是一种数据库，应该是一种数据结构化存储方法的集合。依据结构化方法以及应用场合的不同，主要分为以下几类：</p><ul><li><strong>面向高性能并发读写的 key-value 数据库</strong>：key-value数据库的主要特点即使具有极高的并发读写性能，Redis，Tokyo Cabinet，Flare 就是这类的代表</li><li><strong>面向海量数据访问的面向文档数据库</strong>：这类数据库的特点是，可以在海量的数据中快速的查询数据，典型代表为 MongoDB 以及 CouchDB</li><li><strong>面向可扩展性的分布式数据库</strong>：这类数据库想解决的问题就是传统数据库存在可扩展性上的缺陷，这类数据库可以适应数据量的增加以及数据结构的变化</li></ul><p><strong>2.3 非关系型数据库优点</strong></p><p>非关系型数据库的出现，多是源于关系型数据库的性能不足，故非关系型数据库的优点也很明显：</p><ul><li><strong>读写性能</strong>：无需经过 SQL 层的解析，读写性能很高。主要例子有Redis，由于其逻辑简单，而且纯内存操作，使得其性能非常出色，单节点每秒可以处理超过10万次读写操作；</li><li><strong>简单的扩展</strong>：基于键值对，数据没有耦合性，容易扩展。典型例子是 Cassandra，由于其架构是类似于经典的 P2P，所以能通过轻松地添加新的节点来扩展这个集群；</li><li><strong>存储格式多</strong>：支持key-value形式、文档形式、图片形式，而关系型数据库则只支持基础类型；</li><li><strong>低廉的成本</strong>：这是大多数分布式数据库共有的特点，因为主要都是开源软件，没有昂贵的License成本；</li></ul><p><strong>2.4 非关系型数据库缺点</strong></p><ul><li><strong>不提供对 SQL 的支持</strong>：如果不支持 SQL 这样的工业标准，将会对用户产生一定的学习和应用迁移成本</li><li><strong>支持的特性不够丰富</strong>：现有产品所提供的功能都比较有限，大多数 NoSQL 数据库都不支持事务，也不像 MS SQL Server 和 Oracle 那样能提供各种附加功能，比如 BI 和报表等</li><li><strong>现有产品的不够成熟</strong>：大多数产品都还处于初创期，和关系型数据库几十年的完善不可同日而语</li></ul><h2 id="3-关系型数据库与-NoSQL"><a href="#3-关系型数据库与-NoSQL" class="headerlink" title="3. 关系型数据库与 NoSQL"></a><strong>3. 关系型数据库与 NoSQL</strong></h2><p><strong>3.1 NoSQL 使用场景</strong></p><p>并不是任何场景，NoSQL 都要优于关系型数据库。NoSQL 使用场景常见如下：</p><p><strong>数据库表 schema 经常变化</strong><br>比如在线商城，维护产品的属性经常要增加字段，这就意味着 ORMapping 层的代码和配置要改，如果该表的数据量过百万，新增字段会带来额外开销（重建索引等）。</p><p><strong>数据库表字段是复杂数据类型</strong><br>对于复杂数据类型，比如 SQL Sever 提供了可扩展性的支持，像 xml 类型的字段。DB 层对 xml 字段很难建高效索引，应用层又要做从字符流到 dom 的解析转换。NoSQL 以 json 方式存储，提供了原生态的支持，在效率方便远远高于传统关系型数据库。</p><p><strong>高并发数据库请求</strong><br>此类应用常见于 web2.0 的网站，很多应用对于数据一致性要求很低，而关系型数据库的事务以及大表 JOIN 反而成了”性能杀手”。</p><p><strong>海量数据的分布式存储</strong><br>海量数据的存储如果选用大型商用数据，如 Oracle，那么整个解决方案的成本是非常高的，要花很多钱在软硬件上。NoSQL 分布式存储，可以部署在廉价的硬件上，是一个性价比非常高的解决方案。</p><p><strong>3.2 NoSQL 和关系数据库结合</strong></p><p><strong>一般把 NoSQL 和关系数据库进行结合使用，各取所长，需要使用关系特性的时候我们使用关系数据库，需要使用 NoSQL 特性的时候我们使用 NoSQL 数据库，各得其所</strong>。NoSQL 数据库是关系数据库在某些方面（性能，扩展）的一个弥补。</p><p>举个简单的例子吧，比如用户评论的存储，评论大概有主键 id、评论的对象 aid、评论内容 content、用户 uid 等字段。我们能确定的是评论内容 content 肯定不会在数据库中用 where content&#x3D;’’ 查询，评论内容也是一个大文本字段。那么我们可以把主键 id、评论对象 aid、用户 id 存储在数据库，评论内容存储在 NoSQL，这样数据库就节省了存储 content 占用的磁盘空间，从而节省大量 IO，对 content 也更容易做 Cache。</p><p>另外，<strong>可使用 NoSQL 作为缓存服务器</strong>。MySQL + Memcached 的架构中，Memcached 这类内存缓存服务器缓存的数据大小受限于内存大小，如果用 NoSQL 来代替 Memcached 来缓存数据库的话，就可以不再受限于内存大小。虽然可能有少量的磁盘IO读写，可能比 Memcached 慢一点，但是完全可以用来缓存数据库的查询操作。</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>各类数据库的区分</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NoSQL</title>
    <link href="/2023/03/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NoSQL/"/>
    <url>/2023/03/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NoSQL/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>NoSQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>数据结构</title>
    <link href="/2023/03/27/408/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    <url>/2023/03/27/408/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>408</category>
      
    </categories>
    
    
    <tags>
      
      <tag>408</tag>
      
      <tag>计算机网络</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6种基础算法</title>
    <link href="/2023/03/27/6%E7%A7%8D%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/"/>
    <url>/2023/03/27/6%E7%A7%8D%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="1、递归算法"><a href="#1、递归算法" class="headerlink" title="1、递归算法"></a>1、递归算法</h1><h1 id="2、枚举算法"><a href="#2、枚举算法" class="headerlink" title="2、枚举算法"></a>2、枚举算法</h1><h1 id="3、贪心算法"><a href="#3、贪心算法" class="headerlink" title="3、贪心算法"></a>3、贪心算法</h1><h1 id="4、回溯算法"><a href="#4、回溯算法" class="headerlink" title="4、回溯算法"></a>4、回溯算法</h1><h1 id="5、分治算法"><a href="#5、分治算法" class="headerlink" title="5、分治算法"></a>5、分治算法</h1><h1 id="6、动态规划"><a href="#6、动态规划" class="headerlink" title="6、动态规划"></a>6、动态规划</h1><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
    </categories>
    
    
    <tags>
      
      <tag>6种基础算法</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SQL语句关键词大全</title>
    <link href="/2023/03/25/%E6%95%B0%E6%8D%AE%E5%BA%93/SQL%E8%AF%AD%E5%8F%A5%E5%85%B3%E9%94%AE%E8%AF%8D%E5%A4%A7%E5%85%A8/"/>
    <url>/2023/03/25/%E6%95%B0%E6%8D%AE%E5%BA%93/SQL%E8%AF%AD%E5%8F%A5%E5%85%B3%E9%94%AE%E8%AF%8D%E5%A4%A7%E5%85%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="SQL语句的基本类型SQL语句的基本类型"><a href="#SQL语句的基本类型SQL语句的基本类型" class="headerlink" title="*SQL语句的基本类型SQL语句的基本类型*"></a><em><strong>*SQL语句的基本类型SQL语句的基本类型*</strong></em></h2><table><thead><tr><th>类型</th><th>含义</th></tr></thead><tbody><tr><td>char(n)</td><td>存放固定长度的字符串，用户指定长度为n。如果没有使用n个长度则会在末尾添加空格。</td></tr><tr><td>varchar(n)</td><td>可变长度的字符串，用户指定最大长度n。char的改进版，大多数情况下我们最好使用varchar。</td></tr><tr><td>int</td><td>整数类型</td></tr><tr><td>smallint</td><td>小整数类型</td></tr><tr><td>numeric(p,d)</td><td>定点数，精度由用户指定。这个数有p位数字（包括一个符号位）d位在小数点右边。</td></tr><tr><td>real ,double precision</td><td>浮点数和双精度浮点数。</td></tr><tr><td>float(n)</td><td>精度至少位n位的浮点数</td></tr></tbody></table><h2 id="特殊关键字特殊关键字"><a href="#特殊关键字特殊关键字" class="headerlink" title="*特殊关键字特殊关键字*"></a><em><strong>*特殊关键字特殊关键字*</strong></em></h2><table><thead><tr><th>类型</th><th>含义</th><th>实例</th></tr></thead><tbody><tr><td>primary key</td><td>主键</td><td>primary key（student_id）</td></tr><tr><td>foreign key references</td><td>外键，括号中为外键，references后为外键的表</td><td>foreign key(course_id) references Course</td></tr><tr><td>not null</td><td>不为空，前面为属性的定义</td><td>name varchar(10) not null</td></tr></tbody></table><h2 id="创建-x2F-插入-x2F-删除-x2F-修改创建-x2F-插入-x2F-删除-x2F-修改"><a href="#创建-x2F-插入-x2F-删除-x2F-修改创建-x2F-插入-x2F-删除-x2F-修改" class="headerlink" title="*创建&#x2F;插入&#x2F;删除&#x2F;修改创建&#x2F;插入&#x2F;删除&#x2F;修改*"></a><em><strong>*创建&#x2F;插入&#x2F;删除&#x2F;修改创建&#x2F;插入&#x2F;删除&#x2F;修改*</strong></em></h2><table><thead><tr><th>类型</th><th>含义</th></tr></thead><tbody><tr><td>create table</td><td>创建一张表</td></tr><tr><td>insert into…values</td><td>向表中插入一条信息</td></tr><tr><td>delete from</td><td>从表中删除一条信息</td></tr><tr><td>update…set…where</td><td>在where的位置，更新内容为set的值</td></tr><tr><td>drop table</td><td>删除表</td></tr><tr><td>alter table…add</td><td>向表中添加某个属性</td></tr><tr><td>alter table…drop</td><td>删除某个属性</td></tr><tr><td>truncate</td><td>清空内容</td></tr></tbody></table><h2 id="SQL查询语句−单表查询SQL查询语句−单表查询"><a href="#SQL查询语句−单表查询SQL查询语句−单表查询" class="headerlink" title="*SQL查询语句−单表查询SQL查询语句−单表查询*"></a><em><strong>*SQL查询语句−单表查询SQL查询语句−单表查询*</strong></em></h2><table><thead><tr><th>类型</th><th>含义</th></tr></thead><tbody><tr><td>select</td><td>表示要查找表所含有的属性</td></tr><tr><td>from</td><td>表示要操作的表</td></tr><tr><td>where</td><td>判断条件，根据该判断条件选择信息</td></tr><tr><td>distinct</td><td>表示将结果去重</td></tr><tr><td>all</td><td>表示不去重</td></tr><tr><td>and</td><td>在where后使用and表示将判断条件连接起来</td></tr><tr><td>or</td><td>在where中使用or表示判断条件多选一</td></tr><tr><td>not</td><td>在where中使用not表示判断条件相反</td></tr></tbody></table><h2 id="SQL查询语句−多表查询SQL查询语句−多表查询"><a href="#SQL查询语句−多表查询SQL查询语句−多表查询" class="headerlink" title="*SQL查询语句−多表查询SQL查询语句−多表查询*"></a><em><strong>*SQL查询语句−多表查询SQL查询语句−多表查询*</strong></em></h2><table><thead><tr><th>类型</th><th>含义</th></tr></thead><tbody><tr><td>A,B</td><td>在from后面通过逗号连接多张表，表示将这些表进行笛卡尔积运算</td></tr><tr><td>natural join</td><td>将natural join关键字前后的两张表进行自然连接运算</td></tr><tr><td>left outer join</td><td>左外连接，以左边为基准进行连接，右边没有的用NULL代替</td></tr><tr><td>right outer join</td><td>右外连接，以右边为基准进行连接，左边没有的用NULL代替</td></tr><tr><td>full join</td><td>全然外连接，将两表完全合并，没有的用NULL代替</td></tr><tr><td>join&#x2F;inner join</td><td>内连接，只连接两表皆有，其他删除</td></tr><tr><td>corss join</td><td>交叉连接，结果为两表的笛卡尔积</td></tr><tr><td>A join B using(c)</td><td>将A和B通过c属性自然连接</td></tr></tbody></table><h2 id="附加运算关键字附加运算关键字"><a href="#附加运算关键字附加运算关键字" class="headerlink" title="*附加运算关键字附加运算关键字*"></a><em><strong>*附加运算关键字附加运算关键字*</strong></em></h2><table><thead><tr><th>类型</th><th>含义</th></tr></thead><tbody><tr><td>as</td><td>将as前的关系起一个别名，在此语句中可以用别名来代指这个表</td></tr><tr><td>*</td><td>在select中表示找出这个表所有的属性</td></tr><tr><td>order by</td><td>让查询结果中的信息按照给定的属性排序（默认升序，上小下大）</td></tr><tr><td>desc</td><td>在排序后使用，表示采用降序</td></tr><tr><td>asc</td><td>在排序后使用，表示采用升序</td></tr><tr><td>between</td><td>在where中使用between表示一个数在两个数值之间取值</td></tr><tr><td>not between</td><td>between的反义词，在两个数之外取值</td></tr><tr><td>union&#x2F;union all</td><td>将连个SQL语句做并运算，并且自动去重，添加all表示不去重</td></tr><tr><td>intersect&#x2F;intersect all</td><td>将两个SQL语句做交运算，并自动去重，添加all表示不去重</td></tr><tr><td>except&#x2F;except all</td><td>将两个SQL语句做差运算，并且自动去重，添加all表示不去重</td></tr><tr><td>is null</td><td>在where中使用is null表示这个值是空值</td></tr><tr><td>is not null</td><td>在where中使用is not null表示这个值不是空值</td></tr></tbody></table><h2 id="聚集函数运算聚集函数运算"><a href="#聚集函数运算聚集函数运算" class="headerlink" title="*聚集函数运算聚集函数运算*"></a><em><strong>*聚集函数运算聚集函数运算*</strong></em></h2><table><thead><tr><th>类型</th><th>含义</th></tr></thead><tbody><tr><td>avg</td><td>平均值</td></tr><tr><td>min</td><td>最小值</td></tr><tr><td>max</td><td>最大值</td></tr><tr><td>sum</td><td>总和</td></tr><tr><td>count</td><td>计数</td></tr><tr><td>distinct</td><td>表示将后面的属性去重</td></tr><tr><td>group by</td><td>将在group by上取值相同的信息分在一个组</td></tr><tr><td>having</td><td>对group by产生的分组进行筛选，可以使用聚集函数</td></tr></tbody></table><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>MySQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL50题</title>
    <link href="/2023/03/25/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL50%E9%A2%98/"/>
    <url>/2023/03/25/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL50%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p><strong>#1、查询“001”课程比“002”课程成绩高的所有学生的学号；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select distinct s1.SID<br>from score s1<br>where<br>(select s2.score<br>from score s2<br>where s2.CID=&quot;001&quot; and s1.SID=s2.SID)<br>(select s3.score<br>from score s3<br>where s3.CID=&quot;002&quot; and s1.SID=s3.SID);<br></code></pre></td></tr></table></figure><p><strong>#2、查询平均成绩大于60分的同学的学号和平均成绩；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select sid,avg(score) as a<br>from score<br>group by score.sid<br>having a&gt;60<br>order by a desc;<br></code></pre></td></tr></table></figure><p><strong>#3、查询所有同学的学号、姓名、选课数、总成绩；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select s.SID,s.Sname,count(1),sum(score)<br>from student as s<br>left join score as sc<br>on s.SID=sc.SID<br>left join course as c<br>on sc.CID=c.CID<br>group by s.SID;<br></code></pre></td></tr></table></figure><p><strong>#4、查询姓“李”的老师的个数；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select count(1)<br>from teacher as t<br>where t.Tname like &quot;李%&quot;;<br></code></pre></td></tr></table></figure><p><strong>#5、查询没学过“叶平”老师课的同学的学号、姓名；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select student.SID,student.Sname<br>from student<br>where student.Sname not in<br>(<br>select distinct s.Sname<br>from student as s<br>left join score as sc<br>on s.SID=sc.SID<br>left join course as c<br>on sc.CID=c.CID<br>left join teacher as t<br>on c.TID=t.TID<br>where t.Tname=&#x27;叶平&#x27;<br>);<br></code></pre></td></tr></table></figure><p><strong>#6、查询学过“001”并且也学过编号“002”课程的同学的学号、姓名</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select s.SID,s.Sname<br>from student as s<br>where s.SID in (<br>select sc1.SID<br>from score sc1,score sc2<br>where sc1.SID=sc2.SID and sc1.CID=001 and sc2.CID=002<br>);<br></code></pre></td></tr></table></figure><p><strong>#7、查询学过“叶平”老师所教的所有课的同学的学号、姓名；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT sid,sname FROM Student s WHERE NOT EXISTS<br>(<br>SELECT cid<br>FROM Course c<br>INNER JOIN Teacher t<br>ON c.TID=t.TID<br>WHERE t.TName=&#x27;叶平&#x27; AND CID NOT IN<br>(SELECT CID FROM score WHERE SID=s.SID)<br>);<br></code></pre></td></tr></table></figure><p><strong>#8、查询课程编号“002”的成绩比课程编号“001”课程低的所有同学的学号、姓名；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select DISTINCT s.SID,s.Sname<br>from score s1<br>left join student s<br>on s.SID=s1.SID<br>where<br>(select s2.score<br>from score s2<br>where s2.CID=&quot;001&quot; and s1.SID=s2.SID)<br>(select s3.score<br>from score s3<br>where s3.CID=&quot;002&quot; and s1.SID=s3.SID);<br></code></pre></td></tr></table></figure><p><strong>#9、查询所有课程成绩小于60分的同学的学号、姓名；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select a.SID,a.Sname<br>from student as a<br>where a.SID not in(<br>select distinct s.SID<br>from student as s<br>left join score as sc<br>on s.SID=sc.SID<br>where sc.score&gt;=60<br>order by s.SID asc<br>)<br>order by a.SID asc;<br></code></pre></td></tr></table></figure><p><strong>#10、查询没有学全所有课的同学的学号、姓名；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select s.SID,s.Sname<br>from student as s<br>where<br>(select count() from score as sc where s.SID=sc.SID)&lt;(select count() from course);<br></code></pre></td></tr></table></figure><p><strong>#11、查询至少有一门课与学号为“1001”的同学所学相同的同学的学号和姓名；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select distinct a.SID,a.Sname<br>from student as a<br>left join score as b<br>on a.SID=b.SID<br>where b.CID in(<br>select score.CID<br>from score<br>where score.SID=1001<br>);<br></code></pre></td></tr></table></figure><p><strong>#12、查询没有学过学号为“1001”同学所有门课的其他同学学号和姓名；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select distinct s.SID,s.Sname<br>from student as s<br>left join score as sc1<br>on sc1.SID=s.SID<br>where s.SID not in (<br>select  sc.SID<br>from score as sc<br>where sc.CID in (<br>select CID from score where SID=1001<br>)<br>group by sc.SID<br>);<br></code></pre></td></tr></table></figure><p><strong>#13、把“SC”表中“叶平”老师教的课的成绩都更改为此课程的平均成绩；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mysql">update score s1<br>inner join(<br>select CID,avg(score) as ascore from score where CID in<br>(<br>select c.CID<br>from course as c,teacher as t<br>where c.TID=t.TID and t.Tname=&#x27;叶平&#x27;<br>)<br>group by CID<br>) as s2<br>set s1.score=s2.ascore where s1.CID=s2.CID;<br></code></pre></td></tr></table></figure><p><strong>#14、查询和“1002”号的同学学习的课程完全相同的其他同学学号和姓名；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select s.SID &#x27;学号&#x27;,s.Sname &#x27;姓名&#x27;<br>from student as s ,score as sc1,<br>(select SID as si,COUNT(1) as co<br>from score<br>group by SID<br>)as a<br>where  s.SID=sc1.SID<br>and a.si=sc1.SID<br>and  sc1.cid in<br>(<br>select sc.CID<br>from score as sc<br>where sc.sID=1001<br>)<br>and a.co= (select COUNT(1) from score where SID=1001)<br>group by s.SID<br>having COUNT(1)=(select COUNT(1) from score where SID=1001);<br></code></pre></td></tr></table></figure><p><strong>#15、删除学习“叶平”老师课的SC表记录;</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">delete from score as sc<br>where sc.CID in(<br>select c.CID<br>from course as c<br>left join teacher as t<br>on c.TID=t.TID<br>where t.Tname=&#x27;叶平&#x27;<br>);<br></code></pre></td></tr></table></figure><p><strong>#16、向SC表中插入一些记录，这些记录要求符合以下条件：没有上过编号“003”课程的同学学号的2号课的平均成绩；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs mysql">insert score<br>select distinct sc2.SID,2,ascore.a<br>from score as sc2, (<br>select avg(sc.score) as a<br>from score as sc<br>where sc.CID=002<br>)  as ascore<br>where sc2.SID not  in(<br>(select sc.SID<br>from score as sc<br>where sc.CID=003<br>)<br>)<br>group by sc2.SID<br></code></pre></td></tr></table></figure><p><strong>#17、按平均成绩从高到低显示所有学生的“数据库”、“企业管理”、“英语”三门的课程成绩，按如下形式显示： 学生ID,数据库,企业管理,英语,有效课程数,有效平均分</strong></p><p>&#x2F;&#x2F;?????????????????????????????</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT distinct sid &#x27;学生ID&#x27;,<br>(SELECT score FROM score a,course b WHERE a.cid=b.cid AND b.cname=&#x27;数据库&#x27; AND a.sid=c.sid)&#x27;数据库&#x27;,<br>(SELECT score FROM score a,course b WHERE a.cid=b.cid AND b.cname=&#x27;企业管理&#x27; AND a.sid=c.sid)&#x27;企业管理&#x27;,<br>(SELECT score FROM score a,course b WHERE a.cid=b.cid AND b.cname=&#x27;英语&#x27; AND a.sid=c.sid)&#x27;英语&#x27;,<br>(SELECT COUNT(1) FROM score a,course b WHERE a.cid=b.cid AND (b.cname=&#x27;数据库&#x27; OR b.cname=&#x27;企业管理&#x27;OR b.cname=&#x27;英语&#x27;  )AND a.sid=c.sid)&#x27;有效课程数&#x27;,<br>(SELECT AVG(score) FROM score a,course b WHERE a.cid=b.cid AND (b.cname=&#x27;数据库&#x27; OR b.cname=&#x27;企业管理&#x27;OR b.cname=&#x27;英语&#x27;  ) AND a.sid=c.sid) 有效平均分<br>FROM score c<br>ORDER BY 有效平均分 DESC;<br></code></pre></td></tr></table></figure><p><strong>#18、查询各科成绩最高和最低的分：以如下形式显示：课程ID，最高分，最低分</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select sc.CID,max(sc.score),min(sc.score)<br>from score as sc<br>group by sc.CID<br>order by sc.CID asc;<br></code></pre></td></tr></table></figure><p><strong>#19、按各科平均成绩从低到高和及格率的百分数从高到低顺序</strong></p><p>#case when then else</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select sc.CID,avg(sc.score) as &#x27;平均成绩&#x27;,100**sum(case when sc.score&gt;=60 then 1 else 0 end)/count(1) as 及格率from score as scgroup by sc.CIDorder by avg(sc.score) asc,及格率 desc;#20、查询如下课程平均成绩和及格率的百分数(用&quot;1行&quot;显示): 企业管理（001），马克思（002），OO&amp;UML （003），数据库（004）selectsum(case when sc.CID=001 then sc.score else 0 end)/sum(case when sc.CID=001 then 1 else 0 end) as &#x27;企业管理平均成绩&#x27;,100**sum(case when sc.CID=001 and sc.score&gt;=60 then 1 else 0 end)/sum(case when sc.CID=001 then 1 else 0 end)as &#x27;企业管理及格率&#x27;,<br>sum(case when sc.CID=002 then sc.score else 0 end)/sum(case when sc.CID=002 then 1 else 0 end) as &#x27;马克思平均成绩&#x27;,<br>100**sum(case when sc.CID=002 and sc.score&gt;=60 then 1 else 0 end)/sum(case when sc.CID=002 then 1 else 0 end)as &#x27;马克思及格率&#x27;,sum(case when sc.CID=003 then sc.score else 0 end)/sum(case when sc.CID=003 then 1 else 0 end) as &#x27;UML平均成绩&#x27;,100**sum(case when sc.CID=003 and sc.score&gt;=60 then 1 else 0 end)/sum(case when sc.CID=003 then 1 else 0 end)as &#x27;UML及格率&#x27;,<br>sum(case when sc.CID=004 then sc.score else 0 end)/sum(case when sc.CID=004 then 1 else 0 end) as &#x27;数据库平均成绩&#x27;,<br>100*sum(case when sc.CID=004 and sc.score&gt;=60 then 1 else 0 end)/sum(case when sc.CID=004 then 1 else 0 end)as &#x27;数据库及格率&#x27;<br>from score as sc;<br></code></pre></td></tr></table></figure><p>**&#x2F;<em>21、查询不同老师所教不同课程平均分从高到低显示</em>*</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT max(Z.TID) AS 教师ID,MAX(Z.Tname) AS 教师姓名,C.CID AS 课程ＩＤ,MAX(C.Cname) AS 课程名称,AVG(Score) AS 平均成绩 */<br>SELECT t.TID AS &#x27;教师ID&#x27;,t.Tname AS &#x27;教师姓名&#x27;,c.CID AS &#x27;课程ID&#x27;,C.Cname AS &#x27;课程名称&#x27;,avg(sc.score) AS &#x27;平均成绩&#x27;<br>from score as sc<br>left join course as c<br>on sc.CID=c.CID<br>left join teacher as t<br>on c.TID=t.TID<br>group by c.TID,c.CID<br>order by avg(sc.score) desc;<br></code></pre></td></tr></table></figure><p><strong>#22、查询如下课程成绩第 3 名到第 6 名的学生成绩单：企业管理（001），马克思（002），UML （003），数据库（004）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT DISTINCT s.cid,<br>(SELECT s1.score FROM score s1 WHERE s1.cid = s.cid ORDER BY s1.score DESC LIMIT 2,1)&#x27;3&#x27;,<br>(SELECT s1.score FROM score s1 WHERE s1.cid = s.cid ORDER BY s1.score DESC LIMIT 3,1)&#x27;4&#x27;,<br>(SELECT s1.score FROM score s1 WHERE s1.cid = s.cid ORDER BY s1.score DESC LIMIT 4,1)&#x27;5&#x27;,<br>(SELECT s1.score FROM score s1 WHERE s1.cid = s.cid ORDER BY s1.score DESC LIMIT 5,1)&#x27;6&#x27;<br>FROM score s<br>WHERE s.cid IN (1,2,3,4)<br>order by s.cid<br>select t1.SID,<br>(select sname from student as stu where stu.SID=t1.SID) as 姓名,<br>(select Cname from Course as co where co.CID=t1.CID) as 课程名,<br>t1.score  as 成绩<br>from score t1<br>where (select count(1) from score where CID=t1.CID and score&gt;=t1.score) between 2 and 5<br>and CID in (&#x27;1&#x27;,&#x27;2&#x27;,&#x27;3&#x27;,&#x27;4&#x27;)<br>order by CID,t1.score desc<br></code></pre></td></tr></table></figure><p><strong>#23、统计列印各科成绩,各分数段人数:课程ID,课程名称,[100-85],[85-70],[70-60],[ &lt;60]</strong></p><p><strong>#case when between 小数 and 大数 then 1 else 0 end</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select<br>sc.CID as &#x27;课程ID&#x27;,<br>c.Cname as &#x27;课程名称&#x27;,<br>sum(case when sc.score BETWEEN 85 and 100 then 1 else 0 end) as &#x27;[100-85]&#x27;,<br>sum(case when sc.score BETWEEN 70 and 85 then 1 else 0 end) as &#x27;[85-70]&#x27;,<br>sum(case when sc.score BETWEEN 60 and 70 then 1 else 0 end) as &#x27;[70-60]&#x27;,<br>sum(case when sc.score BETWEEN 0 and 60 then 1 else 0 end) as &#x27;[60-0]&#x27;<br>from score as sc,course as c<br>where sc.CID=c.CID<br>group by sc.CID<br>order by sc.CID asc;<br></code></pre></td></tr></table></figure><p><strong>#24、查询学生平均成绩及其名次</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set @n=0;<br>select a.SID,a.ascore,(@n:=@n+1) as 排名<br>from(<br>select SID,avg(score) as ascore<br>from score<br>group by SID<br>order by ascore desc<br>)as a<br></code></pre></td></tr></table></figure><p><strong>#25、查询各科成绩前三名的记录:(不考虑成绩并列情况)</strong></p><p>&#x2F;&#x2F;??????????????????????????????????????????</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select CID,score<br>from score as sc<br>where (select count(1) from score as sc1 where sc.CID=sc1.CID and sc.score<br>order by CID,score;<br></code></pre></td></tr></table></figure><p><strong>#26、查询每门课程被选修的学生数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select sc.CID,c.Cname,sum(case when sc.score then 1 else 0 end) as 选修的学生数<br>from score as sc,course as c<br>where sc.CID=c.CID<br>group by sc.CID<br>order by sc.CID<br></code></pre></td></tr></table></figure><p><strong>#27、查询出只选修了一门课程的全部学生的学号和姓名</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select s.SID,s.Sname,sum(case when sc.CID then 1 else 0 end) as 每个人选修的课程数<br>from student as s,score as sc<br>where s.SID=sc.SID<br>group by s.SID<br>having 每个人选修的课程数=1;<br></code></pre></td></tr></table></figure><p><strong>#28、查询男生、女生人数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select sum(case when s.Ssex=&#x27;男&#x27; then 1 else 0 end) as 男生人数,sum(case when s.Ssex=&#x27;女&#x27; then 1 else 0 end) as 女生人数<br>from student as s<br></code></pre></td></tr></table></figure><p><strong>#29、查询姓“张”的学生名单</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select *<br>from student as s<br>where s.Sname like &#x27;张%&#x27;;<br></code></pre></td></tr></table></figure><p><strong>#30、查询同名同性学生名单，并统计同名人数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select *,count(1)<br>from student as s1,student as s2<br>where s1.SID!=s2.SID and s1.Sname=s2.Sname<br>insert student values (9999,&#x27;张无忌&#x27;,22,&#x27;男&#x27;);<br></code></pre></td></tr></table></figure><p><strong>#31、1981年出生的学生名单(注：Student表中Sage列的类型是datetime)</strong></p><p>#运行时将student.Sage类型改为datetime类型</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select *<br>from student as s<br>where YEAR(s.Sage)=1981;<br></code></pre></td></tr></table></figure><p><strong>#32、查询每门课程的平均成绩，结果按平均成绩升序排列，平均成绩相同时，按课程号降序列</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select sc.CID as 课程号,avg(sc.score) as 平均成绩<br>from score as sc<br>group by sc.CID<br>order by 平均成绩 desc,课程号 asc;<br></code></pre></td></tr></table></figure><p><strong>#33、查询平均成绩大于85的所有学生的学号、姓名和平均成绩</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">select</span> s.SID,s.Sname,<span class="hljs-built_in">avg</span>(sc.score) <span class="hljs-keyword">as</span> 个人平均成绩<br><span class="hljs-keyword">from</span> student <span class="hljs-keyword">as</span> s<br><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> score <span class="hljs-keyword">as</span> sc<br><span class="hljs-keyword">on</span> s.SID=sc.SID<br><span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> sc.SID<br><span class="hljs-keyword">having</span> 个人平均成绩&gt;<span class="hljs-number">85</span><br><span class="hljs-keyword">insert</span> score <span class="hljs-keyword">values</span>(<span class="hljs-number">9999</span>,<span class="hljs-number">1</span>,<span class="hljs-number">95</span>),(<span class="hljs-number">9999</span>,<span class="hljs-number">2</span>,<span class="hljs-number">85</span>);<br><span class="hljs-keyword">insert</span> student <span class="hljs-keyword">values</span>(<span class="hljs-number">9999</span>,<span class="hljs-string">&#x27;刘红舸&#x27;</span>,<span class="hljs-number">22</span>,<span class="hljs-string">&#x27;男&#x27;</span>);<br></code></pre></td></tr></table></figure><p><strong>#34、查询课程名称为“数据库”，且分数低于60的学生姓名和分数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select s.Sname,sc.score<br>from student as s<br>left join score as sc<br>on s.SID=sc.SID<br>left join course as c<br>on sc.CID=c.CID<br>where c.Cname=&#x27;数据库&#x27; and sc.score&lt;60;<br></code></pre></td></tr></table></figure><p><strong>#35、查询所有学生的选课情况；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select distinct s.Sname,sc.CID,c.Cname<br>from student as s<br>left join score as sc<br>on s.SID=sc.SID<br>left join course as c<br>on sc.CID=c.CID<br>order by c.CID asc;<br></code></pre></td></tr></table></figure><p><strong>#36、查询任何一门课程成绩在70分以上的姓名、课程名称和分数；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT s.SID, s.Sname,c.cname,sc1.score<br>FROM score AS sc1, course c ,student s<br>WHERE sc1.sid=s.SID<br>AND c.cid=sc1.cid<br>AND s.SID NOT in<br>(<br>SELECT sc.SID<br>FROM score as sc<br>WHERE sc.score&lt;70<br>);<br></code></pre></td></tr></table></figure><p><strong>#37、查询不及格的课程，并按课程号从大到小排列</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select s.Sname,Cname,sc.score<br>from student as s<br>left join score as sc<br>on s.SID=sc.SID<br>left join course as c<br>on sc.CID=c.CID<br>where sc.score&lt;60<br>order by sc.CID desc;<br></code></pre></td></tr></table></figure><p><strong>#38、查询课程编号为003且课程成绩在80分以上的学生的学号和姓名；</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select s.Sname,sc.CID,s.SID,sc.score<br>from student as s<br>left join score as sc<br>on s.SID=sc.SID<br>where sc.CID=003 and sc.score&gt;80;<br></code></pre></td></tr></table></figure><p><strong>#39、求选了课程的学生人数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select count(1) 选了课的学生人数<br>from(<br>select 1<br>from score<br>group by SID) as a;<br></code></pre></td></tr></table></figure><p><strong>#40、查询选修“叶平”老师所授课程的学生中，成绩最高的学生姓名及其成绩</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT *<br>FROM score as sc<br>LEFT JOIN student s ON sc.sid = s.sid<br>LEFT JOIN course c ON sc.cid = c.cid<br>LEFT JOIN teacher t ON c.tid = t.tid<br>WHERE t.tname = &#x27;叶平&#x27;<br>AND sc.score = (SELECT MAX(score) FROM score s1 WHERE sc.cid = s1.cid)<br></code></pre></td></tr></table></figure><p><strong>#41、查询各个课程及相应的选修人数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select c.Cname,sum(case when sc.CID then 1 else 0 end) as 选修人数<br>from score as sc<br>left join course as c<br>on sc.CID=c.CID<br>group by sc.CID;<br></code></pre></td></tr></table></figure><p><strong>#42、查询不同课程成绩相同的学生的学号、课程号、学生成绩</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select distinct sc.SID,sc.CID,sc.score<br>from score as sc,score as sc1<br>where sc.CID!=sc1.CID and sc.score=sc1.score<br>order by sc.score desc;<br></code></pre></td></tr></table></figure><p><strong>#43、查询每门功成绩最好的前两名</strong></p><p>&#x2F;&#x2F;??????????????????????????????????????????</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select CID,score<br>from score as sc<br>where (select count(1) from score as sc1 where sc.CID=sc1.CID and sc.score<br>order by CID,score;<br></code></pre></td></tr></table></figure><p><strong>#44、统计每门课程的学生选修人数（超过10人的课程才统计）。要求输出课程号和选修人数，查询结果按人数降序排列，若人数相同，按课程号升序排列</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select sc.CID,sum(case when sc.CID then 1 else 0 end) as 选修人数<br>from score as sc<br>inner join course as c<br>on sc.CID=c.CID<br>group by c.CID<br>having 选修人数&gt;=5<br>order by 选修人数 desc,c.CID asc;<br></code></pre></td></tr></table></figure><p><strong>#45、检索至少选修两门课程的学生学号</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select sc.SID,count(1)<br>from score as sc<br>group by sc.SID<br>having count(1)&gt;=2<br></code></pre></td></tr></table></figure><p><strong>#46、查询全部学生都选修的课程的课程号和课程名</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT a.cid,a.cname FROM course a<br>WHERE  NOT EXISTS<br>(<br>SELECT *<br>FROM student<br>WHERE sid not  IN(<br>SELECT sid<br>FROM score<br>WHERE cid=a.cid<br>)<br>);<br>SELECT a.课程号,COUNT(1) AS &#x27;被选的人数&#x27;<br>FROM(<br>SELECT s.SID SID,s.Sname Sname,sc.CID 课程号,COUNT(sc.CID)<br>FROM student s<br>LEFT JOIN score as sc<br>ON s.SID = sc.SID<br>GROUP BY s.SID,sc.CID<br>ORDER BY s.SID<br>)AS a<br>GROUP BY a.课程号<br>HAVING COUNT(1)=(SELECT COUNT(1) FROM student)<br>insert score VALUES (1001,1,80)<br></code></pre></td></tr></table></figure><p><strong>#47、查询没学过“叶平”老师讲授的任一门课程的学生姓名</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">select</span> s.SID,s.Sname<br><span class="hljs-keyword">from</span> student <span class="hljs-keyword">as</span> s<br><span class="hljs-keyword">where</span> s.SID <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> (<br><span class="hljs-keyword">select</span> sc.SID<br><span class="hljs-keyword">from</span> score <span class="hljs-keyword">as</span> sc<br><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> course <span class="hljs-keyword">as</span> c<br><span class="hljs-keyword">on</span> sc.CID=c.CID<br><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> teacher <span class="hljs-keyword">as</span> t<br><span class="hljs-keyword">on</span> c.TID=t.TID<br><span class="hljs-keyword">where</span> t.Tname=<span class="hljs-string">&#x27;叶平&#x27;</span><br>);<br></code></pre></td></tr></table></figure><p><strong>#48、查询两门以上不及格课程的同学的学号及其平均成绩</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select sc.SID,avg(sc.score),sum(case when sc.score&lt;=60 then 1 else 0 end) as 不及格门数<br>from score as sc<br>group by sc.SID<br>having 不及格门数&gt;=2<br></code></pre></td></tr></table></figure><p><strong>#49、检索“004”课程分数小于60，按分数降序排列的同学学号</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select sc.SID,sc.score<br>from score as sc<br>where sc.CID=004 and sc.score&lt;60<br>order by sc.score desc;<br></code></pre></td></tr></table></figure><p><strong>#50、删除“002”同学的“001”课程的成绩</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">delete from score as sc<br>where sc.SID=002 and sc.CID=001;<br></code></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>MySQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>定时任务分析</title>
    <link href="/2023/03/11/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%88%86%E6%9E%90/"/>
    <url>/2023/03/11/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="了解需求"><a href="#了解需求" class="headerlink" title="了解需求"></a>了解需求</h2><p>在开发中，往往会遇到一些关于延时任务的需求。</p><p>例如</p><ul><li>生成订单 30 分钟未支付，则自动取消</li><li>生成订单 60 秒后,给用户发短信</li></ul><p>对上述的任务，我们给一个专业的名字来形容，那就是延时任务。那么这里就会产生一个问题，这个延时任务和定时任务的区别究竟在哪里呢？一共有如下几点区别</p><p>定时任务有明确的触发时间，延时任务没有</p><p>定时任务有执行周期，而延时任务在某事件触发后一段时间内执行，没有执行周期</p><p>定时任务一般执行的是批处理操作是多个任务，而延时任务一般是单个任务</p><p>下面，我们以判断订单是否超时为例，进行方案分析</p><h2 id="方案-1：数据库轮询"><a href="#方案-1：数据库轮询" class="headerlink" title="方案 1：数据库轮询"></a>方案 1：数据库轮询</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>该方案通常是在小型项目中使用，即通过一个线程定时的去扫描数据库，通过订单时间来判断是否有超时的订单，然后进行 update 或 delete 等操作</p><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>可以用 quartz 来实现的，简单介绍一下</p><p>maven 项目引入一个依赖如下所示</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.quartz-scheduler<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>quartz<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>复制代码<br></code></pre></td></tr></table></figure><p>调用 Demo 类 MyJob 如下所示</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.rjzheng.delay1;<br><br><span class="hljs-keyword">import</span> org.quartz.*;<br><span class="hljs-keyword">import</span> org.quartz.impl.StdSchedulerFactory;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyJob</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Job</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(JobExecutionContext context)</span> <span class="hljs-keyword">throws</span> JobExecutionException &#123;<br>        System.out.println(<span class="hljs-string">&quot;要去数据库扫描啦。。。&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 创建任务</span><br>        <span class="hljs-type">JobDetail</span> <span class="hljs-variable">jobDetail</span> <span class="hljs-operator">=</span> JobBuilder.newJob(MyJob.class)<br>                .withIdentity(<span class="hljs-string">&quot;job1&quot;</span>, <span class="hljs-string">&quot;group1&quot;</span>).build();<br>        <span class="hljs-comment">// 创建触发器 每3秒钟执行一次</span><br>        <span class="hljs-type">Trigger</span> <span class="hljs-variable">trigger</span> <span class="hljs-operator">=</span> TriggerBuilder<br>                .newTrigger()<br>                .withIdentity(<span class="hljs-string">&quot;trigger1&quot;</span>, <span class="hljs-string">&quot;group3&quot;</span>)<br>                .withSchedule(<br>                        SimpleScheduleBuilder<br>                                .simpleSchedule()<br>                                .withIntervalInSeconds(<span class="hljs-number">3</span>).<br>                                repeatForever())<br>                .build();<br>        <span class="hljs-type">Scheduler</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StdSchedulerFactory</span>().getScheduler();<br>        <span class="hljs-comment">// 将任务及其触发器放入调度器</span><br>        scheduler.scheduleJob(jobDetail, trigger);<br>        <span class="hljs-comment">// 调度器开始调度任务</span><br>        scheduler.start();<br>    &#125;<br><br>&#125;<br>复制代码<br></code></pre></td></tr></table></figure><p>运行代码，可发现每隔 3 秒，输出如下</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">要去数据库扫描啦。。。<br>复制代码<br></code></pre></td></tr></table></figure><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><p>简单易行，支持集群操作</p><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul><li>对服务器内存消耗大</li><li>存在延迟，比如你每隔 3 分钟扫描一次，那最坏的延迟时间就是 3 分钟</li><li>假设你的订单有几千万条，每隔几分钟这样扫描一次，数据库损耗极大</li></ul><h2 id="方案-2：JDK-的延迟队列"><a href="#方案-2：JDK-的延迟队列" class="headerlink" title="方案 2：JDK 的延迟队列"></a>方案 2：JDK 的延迟队列</h2><h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><p>该方案是利用 JDK 自带的 DelayQueue 来实现，这是一个无界阻塞队列，该队列只有在延迟期满的时候才能从中获取元素，放入 DelayQueue 中的对象，是必须实现 Delayed 接口的。</p><p>DelayedQueue 实现工作流程如下图所示</p><p><img src="/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%88%86%E6%9E%90/e63cf7f9fa0a4f5c84cf47cd50aa443etplv-k3u1fbpfcp-zoom-in-crop-mark4536000.awebp" alt="img"></p><p>其中 Poll():获取并移除队列的超时元素，没有则返回空</p><p>take():获取并移除队列的超时元素，如果没有则 wait 当前线程，直到有元素满足超时条件，返回结果。</p><h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><p>定义一个类 OrderDelay 实现 Delayed，代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.rjzheng.delay2;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.Delayed;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderDelay</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Delayed</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String orderId;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> timeout;<br><br>    OrderDelay(String orderId, <span class="hljs-type">long</span> timeout) &#123;<br>        <span class="hljs-built_in">this</span>.orderId = orderId;<br>        <span class="hljs-built_in">this</span>.timeout = timeout + System.nanoTime();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compareTo</span><span class="hljs-params">(Delayed other)</span> &#123;<br>        <span class="hljs-keyword">if</span> (other == <span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-type">OrderDelay</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> (OrderDelay) other;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> (getDelay(TimeUnit.NANOSECONDS) - t.getDelay(TimeUnit.NANOSECONDS));<br>        <span class="hljs-keyword">return</span> (d == <span class="hljs-number">0</span>) ? <span class="hljs-number">0</span> : ((d &lt; <span class="hljs-number">0</span>) ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 返回距离你自定义的超时时间还有多少</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getDelay</span><span class="hljs-params">(TimeUnit unit)</span> &#123;<br>        <span class="hljs-keyword">return</span> unit.convert(timeout - System.nanoTime(), TimeUnit.NANOSECONDS);<br>    &#125;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">print</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(orderId + <span class="hljs-string">&quot;编号的订单要删除啦。。。。&quot;</span>);<br>    &#125;<br><br>&#125;<br>复制代码<br></code></pre></td></tr></table></figure><p>运行的测试 Demo 为，我们设定延迟时间为 3 秒</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.rjzheng.delay2;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.DelayQueue;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayQueueDemo</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>        list.add(<span class="hljs-string">&quot;00000001&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;00000002&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;00000003&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;00000004&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;00000005&quot;</span>);<br><br>        DelayQueue&lt;OrderDelay&gt; queue = newDelayQueue &lt; OrderDelay &gt; ();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-comment">//延迟三秒取出</span><br>            queue.put(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDelay</span>(list.get(i), TimeUnit.NANOSECONDS.convert(<span class="hljs-number">3</span>, TimeUnit.SECONDS)));<br>            <span class="hljs-keyword">try</span> &#123;<br>                queue.take().print();<br>                System.out.println(<span class="hljs-string">&quot;After &quot;</span> + (System.currentTimeMillis() - start) + <span class="hljs-string">&quot; MilliSeconds&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>&#125;<br>复制代码<br></code></pre></td></tr></table></figure><p>输出如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-number">00000001</span><span class="hljs-string">编号的订单要删除啦。。。。</span><br><span class="hljs-string">After</span> <span class="hljs-number">3003 </span><span class="hljs-string">MilliSeconds</span><br><span class="hljs-number">00000002</span><span class="hljs-string">编号的订单要删除啦。。。。</span><br><span class="hljs-string">After</span> <span class="hljs-number">6006 </span><span class="hljs-string">MilliSeconds</span><br><span class="hljs-number">00000003</span><span class="hljs-string">编号的订单要删除啦。。。。</span><br><span class="hljs-string">After</span> <span class="hljs-number">9006 </span><span class="hljs-string">MilliSeconds</span><br><span class="hljs-number">00000004</span><span class="hljs-string">编号的订单要删除啦。。。。</span><br><span class="hljs-string">After</span> <span class="hljs-number">12008</span> <span class="hljs-string">MilliSeconds</span><br><span class="hljs-number">00000005</span><span class="hljs-string">编号的订单要删除啦。。。。</span><br><span class="hljs-string">After</span> <span class="hljs-number">15009</span> <span class="hljs-string">MilliSeconds</span><br><span class="hljs-string">复制代码</span><br></code></pre></td></tr></table></figure><p>可以看到都是延迟 3 秒，订单被删除</p><h3 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h3><p>效率高,任务触发时间延迟低。</p><h3 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h3><ul><li>服务器重启后，数据全部消失，怕宕机</li><li>集群扩展相当麻烦</li><li>因为内存条件限制的原因，比如下单未付款的订单数太多，那么很容易就出现 OOM 异常</li><li>代码复杂度较高</li></ul><h2 id="方案-3：时间轮算法"><a href="#方案-3：时间轮算法" class="headerlink" title="方案 3：时间轮算法"></a>方案 3：时间轮算法</h2><h3 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h3><p>先上一张时间轮的图(这图到处都是啦)</p><p><img src="/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%88%86%E6%9E%90/507fc4e23c5649d4bd1cf4be7e53b791tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.awebp" alt="img"></p><p>时间轮算法可以类比于时钟，如上图箭头（指针）按某一个方向按固定频率轮动，每一次跳动称为一个 tick。这样可以看出定时轮由个 3 个重要的属性参数，ticksPerWheel（一轮的 tick 数），tickDuration（一个 tick 的持续时间）以及 timeUnit（时间单位），例如当 ticksPerWheel&#x3D;60，tickDuration&#x3D;1，timeUnit&#x3D;秒，这就和现实中的始终的秒针走动完全类似了。</p><p>如果当前指针指在 1 上面，我有一个任务需要 4 秒以后执行，那么这个执行的线程回调或者消息将会被放在 5 上。那如果需要在 20 秒之后执行怎么办，由于这个环形结构槽数只到 8，如果要 20 秒，指针需要多转 2 圈。位置是在 2 圈之后的 5 上面（20 % 8 + 1）</p><h3 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h3><p>我们用 Netty 的 HashedWheelTimer 来实现</p><p>给 Pom 加上下面的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.netty<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>netty-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.24.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>复制代码<br></code></pre></td></tr></table></figure><p>测试代码 HashedWheelTimerTest 如下所示</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.rjzheng.delay3;<br><br><span class="hljs-keyword">import</span> io.netty.util.HashedWheelTimer;<br><span class="hljs-keyword">import</span> io.netty.util.Timeout;<br><span class="hljs-keyword">import</span> io.netty.util.Timer;<br><span class="hljs-keyword">import</span> io.netty.util.TimerTask;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashedWheelTimerTest</span> &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTimerTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TimerTask</span> &#123;<br><br>        <span class="hljs-type">boolean</span> flag;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyTimerTask</span><span class="hljs-params">(<span class="hljs-type">boolean</span> flag)</span> &#123;<br>            <span class="hljs-built_in">this</span>.flag = flag;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(Timeout timeout)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            System.out.println(<span class="hljs-string">&quot;要去数据库删除订单了。。。。&quot;</span>);<br>            <span class="hljs-built_in">this</span>.flag = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] argv)</span> &#123;<br>        <span class="hljs-type">MyTimerTask</span> <span class="hljs-variable">timerTask</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTimerTask</span>(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Timer</span> <span class="hljs-variable">timer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashedWheelTimer</span>();<br>        timer.newTimeout(timerTask, <span class="hljs-number">5</span>, TimeUnit.SECONDS);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span> (timerTask.flag) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            System.out.println(i + <span class="hljs-string">&quot;秒过去了&quot;</span>);<br>            i++;<br>        &#125;<br>    &#125;<br><br>&#125;<br>复制代码<br></code></pre></td></tr></table></figure><p>输出如下</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs">1秒过去了<br>2秒过去了<br>3秒过去了<br>4秒过去了<br>5秒过去了<br>要去数据库删除订单了。。。。<br>6秒过去了<br>复制代码<br></code></pre></td></tr></table></figure><h3 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h3><p>效率高,任务触发时间延迟时间比 delayQueue 低，代码复杂度比 delayQueue 低。</p><h3 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h3><ul><li>服务器重启后，数据全部消失，怕宕机</li><li>集群扩展相当麻烦</li><li>因为内存条件限制的原因，比如下单未付款的订单数太多，那么很容易就出现 OOM 异常</li></ul><h2 id="方案-4：redis-缓存"><a href="#方案-4：redis-缓存" class="headerlink" title="方案 4：redis 缓存"></a>方案 4：redis 缓存</h2><h3 id="思路一"><a href="#思路一" class="headerlink" title="思路一"></a>思路一</h3><p>利用 redis 的 zset,zset 是一个有序集合，每一个元素(member)都关联了一个 score,通过 score 排序来取集合中的值</p><p>添加元素:ZADD key score member [<a href="#">score member</a> …]</p><p>按顺序查询元素:ZRANGE key start stop [WITHSCORES]</p><p>查询元素 score:ZSCORE key member</p><p>移除元素:ZREM key member [member …]</p><p>测试如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">添加单个元素<br>redis&gt; ZADD page_rank 10 google.com<br>(<span class="hljs-built_in">integer</span>) 1<br><br>添加多个元素<br>redis&gt; ZADD page_rank 9 baidu.com 8 bing.com<br>(<span class="hljs-built_in">integer</span>) 2<br><br>redis&gt; ZRANGE page_rank 0 -1 WITHSCORES<br>1) <span class="hljs-string">&quot;bing.com&quot;</span><br>2) <span class="hljs-string">&quot;8&quot;</span><br>3) <span class="hljs-string">&quot;baidu.com&quot;</span><br>4) <span class="hljs-string">&quot;9&quot;</span><br>5) <span class="hljs-string">&quot;google.com&quot;</span><br>6) <span class="hljs-string">&quot;10&quot;</span><br><br>查询元素的score值<br>redis&gt; ZSCORE page_rank bing.com<br><span class="hljs-string">&quot;8&quot;</span><br><br>移除单个元素<br>redis&gt; ZREM page_rank google.com<br>(<span class="hljs-built_in">integer</span>) 1<br><br>redis&gt; ZRANGE page_rank 0 -1 WITHSCORES<br>1) <span class="hljs-string">&quot;bing.com&quot;</span><br>2) <span class="hljs-string">&quot;8&quot;</span><br>3) <span class="hljs-string">&quot;baidu.com&quot;</span><br>4) <span class="hljs-string">&quot;9&quot;</span><br>复制代码<br></code></pre></td></tr></table></figure><p>那么如何实现呢？我们将订单超时时间戳与订单号分别设置为 score 和 member,系统扫描第一个元素判断是否超时，具体如下图所示</p><p><img src="/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%88%86%E6%9E%90/6d279053962141eab843645ee02fc920tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.awebp" alt="img"></p><h3 id="实现一"><a href="#实现一" class="headerlink" title="实现一"></a>实现一</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.rjzheng.delay4;<br><br><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><span class="hljs-keyword">import</span> redis.clients.jedis.Tuple;<br><br><span class="hljs-keyword">import</span> java.util.Calendar;<br><span class="hljs-keyword">import</span> java.util.Set;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppTest</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ADDR</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PORT</span> <span class="hljs-operator">=</span> <span class="hljs-number">6379</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">JedisPool</span> <span class="hljs-variable">jedisPool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPool</span>(ADDR, PORT);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Jedis <span class="hljs-title function_">getJedis</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> jedisPool.getResource();<br>    &#125;<br><br>    <span class="hljs-comment">//生产者,生成5个订单放进去</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">productionDelayMessage</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-comment">//延迟3秒</span><br>            <span class="hljs-type">Calendar</span> <span class="hljs-variable">cal1</span> <span class="hljs-operator">=</span> Calendar.getInstance();<br>            cal1.add(Calendar.SECOND, <span class="hljs-number">3</span>);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">second3later</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (cal1.getTimeInMillis() / <span class="hljs-number">1000</span>);<br>            AppTest.getJedis().zadd(<span class="hljs-string">&quot;OrderId&quot;</span>, second3later, <span class="hljs-string">&quot;OID0000001&quot;</span> + i);<br>            System.out.println(System.currentTimeMillis() + <span class="hljs-string">&quot;ms:redis生成了一个订单任务：订单ID为&quot;</span> + <span class="hljs-string">&quot;OID0000001&quot;</span> + i);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//消费者，取订单</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">consumerDelayMessage</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> AppTest.getJedis();<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            Set&lt;Tuple&gt; items = jedis.zrangeWithScores(<span class="hljs-string">&quot;OrderId&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">if</span> (items == <span class="hljs-literal">null</span> || items.isEmpty()) &#123;<br>                System.out.println(<span class="hljs-string">&quot;当前没有等待的任务&quot;</span>);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">500</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) ((Tuple) items.toArray()[<span class="hljs-number">0</span>]).getScore();<br>            <span class="hljs-type">Calendar</span> <span class="hljs-variable">cal</span> <span class="hljs-operator">=</span> Calendar.getInstance();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">nowSecond</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (cal.getTimeInMillis() / <span class="hljs-number">1000</span>);<br>            <span class="hljs-keyword">if</span> (nowSecond &gt;= score) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> ((Tuple) items.toArray()[<span class="hljs-number">0</span>]).getElement();<br>                jedis.zrem(<span class="hljs-string">&quot;OrderId&quot;</span>, orderId);<br>                System.out.println(System.currentTimeMillis() + <span class="hljs-string">&quot;ms:redis消费了一个任务：消费的订单OrderId为&quot;</span> + orderId);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AppTest</span> <span class="hljs-variable">appTest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppTest</span>();<br>        appTest.productionDelayMessage();<br>        appTest.consumerDelayMessage();<br>    &#125;<br><br>&#125;<br>复制代码<br></code></pre></td></tr></table></figure><p>此时对应输出如下</p><p><img src="/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%88%86%E6%9E%90/f6c7caa3148e47a3a194ac30c8ed47e0tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.awebp" alt="img"></p><p>可以看到，几乎都是 3 秒之后，消费订单。</p><p>然而，这一版存在一个致命的硬伤，在高并发条件下，多消费者会取到同一个订单号，我们上测试代码 ThreadTest</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.rjzheng.delay4;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.CountDownLatch;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadTest</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">threadNum</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">cdl</span> <span class="hljs-operator">=</span> newCountDownLatch(threadNum);<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayMessage</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                cdl.await();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            <span class="hljs-type">AppTest</span> <span class="hljs-variable">appTest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppTest</span>();<br>            appTest.consumerDelayMessage();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AppTest</span> <span class="hljs-variable">appTest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppTest</span>();<br>        appTest.productionDelayMessage();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; threadNum; i++) &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayMessage</span>()).start();<br>            cdl.countDown();<br>        &#125;<br>    &#125;<br><br>&#125;<br>复制代码<br></code></pre></td></tr></table></figure><p>输出如下所示</p><p><img src="/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%88%86%E6%9E%90/6b767d8ffb5b4431ada4f31debc5942etplv-k3u1fbpfcp-zoom-in-crop-mark4536000.awebp" alt="img"></p><p>显然，出现了多个线程消费同一个资源的情况。</p><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>(1)用分布式锁，但是用分布式锁，性能下降了，该方案不细说。</p><p>(2)对 ZREM 的返回值进行判断，只有大于 0 的时候，才消费数据，于是将 consumerDelayMessage()方法里的</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">if</span>(nowSecond &gt;= score)&#123;<br>    String orderId = ((Tuple)items<span class="hljs-selector-class">.toArray</span>()<span class="hljs-selector-attr">[0]</span>)<span class="hljs-selector-class">.getElement</span>();<br>    jedis<span class="hljs-selector-class">.zrem</span>(&quot;OrderId&quot;, orderId);<br>    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(System.currentTimeMillis()+&quot;ms:redis消费了一个任务：消费的订单OrderId为<span class="hljs-string">&quot;+orderId);</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">复制代码</span><br></code></pre></td></tr></table></figure><p>修改为</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs erlang"><span class="hljs-function"><span class="hljs-title">if</span> <span class="hljs-params">(nowSecond &gt;= score)</span> &#123;</span><br><span class="hljs-function">    S<span class="hljs-title">tring</span> <span class="hljs-title">orderId</span> = <span class="hljs-params">((Tuple)</span> <span class="hljs-title">items</span>.<span class="hljs-title">toArray</span><span class="hljs-params">()</span>[0]).<span class="hljs-title">getElement</span><span class="hljs-params">()</span>;</span><br><span class="hljs-function">    L<span class="hljs-title">ong</span> <span class="hljs-title">num</span> = <span class="hljs-title">jedis</span>.<span class="hljs-title">zrem</span><span class="hljs-params">(<span class="hljs-string">&quot;OrderId&quot;</span>, orderId)</span>;</span><br><span class="hljs-function">    <span class="hljs-title">if</span> <span class="hljs-params">(num != null &amp;&amp; num &gt; <span class="hljs-number">0</span>)</span> &#123;</span><br><span class="hljs-function">        S<span class="hljs-title">ystem</span>.<span class="hljs-title">out</span>.<span class="hljs-title">println</span><span class="hljs-params">(System.currentTimeMillis() + <span class="hljs-string">&quot;ms:redis消费了一个任务：消费的订单OrderId为&quot;</span> + orderId)</span>;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">&#125;</span><br><span class="hljs-function">复制代码</span><br></code></pre></td></tr></table></figure><p>在这种修改后，重新运行 ThreadTest 类，发现输出正常了</p><h3 id="思路二"><a href="#思路二" class="headerlink" title="思路二"></a>思路二</h3><p>该方案使用 redis 的 Keyspace Notifications，中文翻译就是键空间机制，就是利用该机制可以在 key 失效之后，提供一个回调，实际上是 redis 会给客户端发送一个消息。是需要 redis 版本 2.8 以上。</p><h3 id="实现二"><a href="#实现二" class="headerlink" title="实现二"></a>实现二</h3><p>在 redis.conf 中，加入一条配置</p><p>notify-keyspace-events Ex</p><p>运行代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.rjzheng.delay5;<br><br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPubSub;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisTest</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ADDR</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PORT</span> <span class="hljs-operator">=</span> <span class="hljs-number">6379</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">JedisPool</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPool</span>(ADDR, PORT);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">RedisSub</span> <span class="hljs-variable">sub</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisSub</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                jedis.getResource().subscribe(sub, <span class="hljs-string">&quot;__keyevent@0__:expired&quot;</span>);<br>            &#125;<br>        &#125;).start();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        init();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;OID000000&quot;</span> + i;<br>            jedis.getResource().setex(orderId, <span class="hljs-number">3</span>, orderId);<br>            System.out.println(System.currentTimeMillis() + <span class="hljs-string">&quot;ms:&quot;</span> + orderId + <span class="hljs-string">&quot;订单生成&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisSub</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JedisPubSub</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String channel, String message)</span> &#123;<br>            System.out.println(System.currentTimeMillis() + <span class="hljs-string">&quot;ms:&quot;</span> + message + <span class="hljs-string">&quot;订单取消&quot;</span>);<br><br>        &#125;<br>    &#125;<br>&#125;<br>复制代码<br></code></pre></td></tr></table></figure><p>输出如下</p><p><img src="/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%88%86%E6%9E%90/f2d1f7a9a66f404880201ffa365d7b56tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.awebp" alt="img"></p><p>可以明显看到 3 秒过后，订单取消了</p><p>ps:redis 的 pub&#x2F;sub 机制存在一个硬伤，官网内容如下</p><p>原:Because Redis Pub&#x2F;Sub is fire and forget currently there is no way to use this feature if your application demands reliable notification of events, that is, if your Pub&#x2F;Sub client disconnects, and reconnects later, all the events delivered during the time the client was disconnected are lost.</p><p>翻: Redis 的发布&#x2F;订阅目前是即发即弃(fire and forget)模式的，因此无法实现事件的可靠通知。也就是说，如果发布&#x2F;订阅的客户端断链之后又重连，则在客户端断链期间的所有事件都丢失了。因此，方案二不是太推荐。当然，如果你对可靠性要求不高，可以使用。</p><h3 id="优点-3"><a href="#优点-3" class="headerlink" title="优点"></a>优点</h3><p>(1) 由于使用 Redis 作为消息通道，消息都存储在 Redis 中。如果发送程序或者任务处理程序挂了，重启之后，还有重新处理数据的可能性。</p><p>(2) 做集群扩展相当方便</p><p>(3) 时间准确度高</p><h3 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h3><p>需要额外进行 redis 维护</p><h2 id="方案-5：使用消息队列"><a href="#方案-5：使用消息队列" class="headerlink" title="方案 5：使用消息队列"></a>方案 5：使用消息队列</h2><h3 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h3><p>我们可以采用 rabbitMQ 的延时队列。RabbitMQ 具有以下两个特性，可以实现延迟队列</p><p>RabbitMQ 可以针对 Queue 和 Message 设置 x-message-tt，来控制消息的生存时间，如果超时，则消息变为 dead letter</p><p>lRabbitMQ 的 Queue 可以配置 x-dead-letter-exchange 和 x-dead-letter-routing-key（可选）两个参数，用来控制队列内出现了 deadletter，则按照这两个参数重新路由。结合以上两个特性，就可以模拟出延迟消息的功能,具体的，我改天再写一篇文章，这里再讲下去，篇幅太长。</p><h3 id="优点-4"><a href="#优点-4" class="headerlink" title="优点"></a>优点</h3><p>高效,可以利用 rabbitmq 的分布式特性轻易的进行横向扩展,消息支持持久化增加了可靠性。</p><h3 id="缺点-4"><a href="#缺点-4" class="headerlink" title="缺点"></a>缺点</h3><p>本身的易用度要依赖于 rabbitMq 的运维.因为要引用 rabbitMq,所以复杂度和成本变高。</p><p>作者：程序员大彬<br>链接：<a href="https://juejin.cn/post/7181297729979547705">https://juejin.cn/post/7181297729979547705</a><br>来源：稀土掘金<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>中间件</category>
      
    </categories>
    
    
    <tags>
      
      <tag>定时任务框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java工具方法之解析地址</title>
    <link href="/2023/03/08/Java/Java%E5%B7%A5%E5%85%B7%E6%96%B9%E6%B3%95%E4%B9%8B%E8%A7%A3%E6%9E%90%E5%9C%B0%E5%9D%80/"/>
    <url>/2023/03/08/Java/Java%E5%B7%A5%E5%85%B7%E6%96%B9%E6%B3%95%E4%B9%8B%E8%A7%A3%E6%9E%90%E5%9C%B0%E5%9D%80/</url>
    
    <content type="html"><![CDATA[<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yonyou.jst.Utils;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.LinkedHashMap;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.regex.Matcher;<br><span class="hljs-keyword">import</span> java.util.regex.Pattern;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddressResolutionUtil</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 解析地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> lin</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> address</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, String&gt; <span class="hljs-title function_">addressResolution</span><span class="hljs-params">(String address)</span>&#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">regex</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;(?&lt;province&gt;[^省]+^自治区|.*?自治区|.*?省|.*?行政区|.*?市|北京|重庆|天津|上海)(?&lt;city&gt;上海城区|北京城区|天津城区|重庆城区|重庆郊县|[^市]+自治州|.*?地区|.*?行政单位|.+盟|市辖区|香港岛|九龙|新界|澳门半岛|离岛|.*?市|.*?县)&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">countyRegex</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;(?&lt;county&gt;121团炮台镇|井陉县|正定县|行唐县|灵寿县|高邑县|深泽县|赞皇县|无极县|平山县|元氏县|赵县|辛集市|晋州市|新乐市|滦县|滦南县|乐亭县|迁西县|玉田县|遵化市|迁安市|青龙满族自治县|昌黎县|卢龙县|临漳县|成安县|大名县|涉县|磁县|邱县|鸡泽县|广平县|馆陶县|魏县|曲周县|武安市|邢台县|临城县|内丘县|柏乡县|隆尧县|任县|南和县|宁晋县|巨鹿县|新河县|广宗县|平乡县|威县|清河县|临西县|南宫市|沙河市|涞水县|阜平县|定兴县|唐县|高阳县|容城县|涞源县|望都县|安新县|易县|曲阳县|蠡县|顺平县|博野县|雄县|涿州市|定州市|安国市|高碑店市|张北县|康保县|沽源县|尚义县|蔚县|阳原县|怀安县|怀来县|涿鹿县|赤城县|承德县|兴隆县|滦平县|隆化县|丰宁满族自治县|宽城满族自治县|围场满族蒙古族自治县|平泉市|沧县|青县|东光县|海兴县|盐山县|肃宁县|南皮县|吴桥县|献县|孟村回族自治县|泊头市|任丘市|黄骅市|河间市|固安县|永清县|香河县|大城县|文安县|大厂回族自治县|霸州市|三河市|枣强县|武邑县|武强县|饶阳县|安平县|故城县|景县|阜城县|深州市|清徐县|阳曲县|娄烦县|古交市|阳高县|天镇县|广灵县|灵丘县|浑源县|左云县|大同县|平定县|盂县|长治县|襄垣县|屯留县|平顺县|黎城县|壶关县|长子县|武乡县|沁县|沁源县|潞城市|沁水县|阳城县|陵川县|泽州县|高平市|山阴县|应县|右玉县|怀仁县|榆社县|左权县|和顺县|昔阳县|寿阳县|太谷县|祁县|平遥县|灵石县|介休市|临猗县|万荣县|闻喜县|稷山县|新绛县|绛县|垣曲县|夏县|平陆县|芮城县|永济市|河津市|定襄县|五台县|代县|繁峙县|宁武县|静乐县|神池县|五寨县|岢岚县|河曲县|保德县|偏关县|原平市|曲沃县|翼城县|襄汾县|洪洞县|古县|安泽县|浮山县|吉县|乡宁县|大宁县|隰县|永和县|蒲县|汾西县|侯马市|霍州市|文水县|交城县|兴县|临县|柳林县|石楼县|岚县|方山县|中阳县|交口县|孝义市|汾阳市|土默特左旗|托克托县|和林格尔县|清水河县|武川县|土默特右旗|固阳县|达尔罕茂明安联合旗|阿鲁科尔沁旗|巴林左旗|巴林右旗|林西县|克什克腾旗|翁牛特旗|喀喇沁旗|宁城县|敖汉旗|科尔沁左翼中旗|科尔沁左翼后旗|开鲁县|库伦旗|奈曼旗|扎鲁特旗|霍林郭勒市|达拉特旗|准格尔旗|鄂托克前旗|鄂托克旗|杭锦旗|乌审旗|伊金霍洛旗|阿荣旗|莫力达瓦达斡尔族自治旗|鄂伦春自治旗|鄂温克族自治旗|陈巴尔虎旗|新巴尔虎左旗|新巴尔虎右旗|满洲里市|牙克石市|扎兰屯市|额尔古纳市|根河市|五原县|磴口县|乌拉特前旗|乌拉特中旗|乌拉特后旗|杭锦后旗|卓资县|化德县|商都县|兴和县|凉城县|察哈尔右翼前旗|察哈尔右翼中旗|察哈尔右翼后旗|四子王旗|丰镇市|乌兰浩特市|阿尔山市|科尔沁右翼前旗|科尔沁右翼中旗|扎赉特旗|突泉县|二连浩特市|锡林浩特市|阿巴嘎旗|苏尼特左旗|苏尼特右旗|东乌珠穆沁旗|西乌珠穆沁旗|太仆寺旗|镶黄旗|正镶白旗|正蓝旗|多伦县|阿拉善左旗|阿拉善右旗|额济纳旗|康平县|法库县|新民市|长海县|瓦房店市|庄河市|台安县|岫岩满族自治县|海城市|抚顺县|新宾满族自治县|清原满族自治县|本溪满族自治县|桓仁满族自治县|宽甸满族自治县|东港市|凤城市|黑山县|义县|凌海市|北镇市|盖州市|大石桥市|阜新蒙古族自治县|彰武县|辽阳县|灯塔市|盘山县|铁岭县|西丰县|昌图县|调兵山市|开原市|朝阳县|建平县|喀喇沁左翼蒙古族自治县|北票市|凌源市|绥中县|建昌县|兴城市|农安县|榆树市|德惠市|永吉县|蛟河市|桦甸市|舒兰市|磐石市|梨树县|伊通满族自治县|公主岭市|双辽市|东丰县|东辽县|通化县|辉南县|柳河县|梅河口市|集安市|抚松县|靖宇县|长白朝鲜族自治县|临江市|前郭尔罗斯蒙古族自治县|长岭县|乾安县|扶余市|镇赉县|通榆县|洮南市|大安市|延吉市|图们市|敦化市|珲春市|龙井市|和龙市|汪清县|安图县|依兰县|方正县|宾县|巴彦县|木兰县|通河县|延寿县|尚志市|五常市|龙江县|依安县|泰来县|甘南县|富裕县|克山县|克东县|拜泉县|讷河市|鸡东县|虎林市|密山市|萝北县|绥滨县|集贤县|友谊县|宝清县|饶河县|肇州县|肇源县|林甸县|杜尔伯特蒙古族自治县|嘉荫县|铁力市|桦南县|桦川县|汤原县|同江市|富锦市|抚远市|勃利县|林口县|绥芬河市|海林市|宁安市|穆棱市|东宁市|嫩江县|逊克县|孙吴县|北安市|五大连池市|望奎县|兰西县|青冈县|庆安县|明水县|绥棱县|安达市|肇东市|海伦市|呼玛县|塔河县|漠河县|江阴市|宜兴市|丰县|沛县|睢宁县|新沂市|邳州市|溧阳市|常熟市|张家港市|昆山市|太仓市|海安县|如东县|启东市|如皋市|海门市|东海县|灌云县|灌南县|涟水县|盱眙县|金湖县|响水县|滨海县|阜宁县|射阳县|建湖县|东台市|宝应县|仪征市|高邮市|丹阳市|扬中市|句容市|兴化市|靖江市|泰兴市|沭阳县|泗阳县|泗洪县|桐庐县|淳安县|建德市|象山县|宁海县|余姚市|慈溪市|永嘉县|平阳县|苍南县|文成县|泰顺县|瑞安市|乐清市|嘉善县|海盐县|海宁市|平湖市|桐乡市|德清县|长兴县|安吉县|新昌县|诸暨市|嵊州市|武义县|浦江县|磐安县|兰溪市|义乌市|东阳市|永康市|常山县|开化县|龙游县|江山市|岱山县|嵊泗县|三门县|天台县|仙居县|温岭市|临海市|玉环市|青田县|缙云县|遂昌县|松阳县|云和县|庆元县|景宁畲族自治县|龙泉市|长丰县|肥东县|肥西县|庐江县|巢湖市|芜湖县|繁昌县|南陵县|无为县|怀远县|五河县|固镇县|凤台县|寿县|当涂县|含山县|和县|濉溪县|枞阳县|怀宁县|潜山县|太湖县|宿松县|望江县|岳西县|桐城市|歙县|休宁县|黟县|祁门县|来安县|全椒县|定远县|凤阳县|天长市|明光市|临泉县|太和县|阜南县|颍上县|界首市|砀山县|萧县|灵璧县|泗县|霍邱县|舒城县|金寨县|霍山县|涡阳县|蒙城县|利辛县|东至县|石台县|青阳县|郎溪县|广德县|泾县|绩溪县|旌德县|宁国市|闽侯县|连江县|罗源县|闽清县|永泰县|平潭县|福清市|仙游县|明溪县|清流县|宁化县|大田县|尤溪县|沙县|将乐县|泰宁县|建宁县|永安市|惠安县|安溪县|永春县|德化县|金门县|石狮市|晋江市|南安市|云霄县|漳浦县|诏安县|长泰县|东山县|南靖县|平和县|华安县|龙海市|顺昌县|浦城县|光泽县|松溪县|政和县|邵武市|武夷山市|建瓯市|长汀县|上杭县|武平县|连城县|漳平市|霞浦县|古田县|屏南县|寿宁县|周宁县|柘荣县|福安市|福鼎市|南昌县|安义县|进贤县|浮梁县|乐平市|莲花县|上栗县|芦溪县|武宁县|修水县|永修县|德安县|都昌县|湖口县|彭泽县|瑞昌市|共青城市|庐山市|分宜县|余江县|贵溪市|信丰县|大余县|上犹县|崇义县|安远县|龙南县|定南县|全南县|宁都县|于都县|兴国县|会昌县|寻乌县|石城县|瑞金市|吉安县|吉水县|峡江县|新干县|永丰县|泰和县|遂川县|万安县|安福县|永新县|井冈山市|奉新县|万载县|上高县|宜丰县|靖安县|铜鼓县|丰城市|樟树市|高安市|南城县|黎川县|南丰县|崇仁县|乐安县|宜黄县|金溪县|资溪县|广昌县|玉山县|铅山县|横峰县|弋阳县|余干县|鄱阳县|万年县|婺源县|德兴市|平阴县|济阳县|商河县|胶州市|平度市|莱西市|桓台县|高青县|沂源县|滕州市|利津县|广饶县|长岛县|龙口市|莱阳市|莱州市|蓬莱市|招远市|栖霞市|海阳市|临朐县|昌乐县|青州市|诸城市|寿光市|安丘市|高密市|昌邑市|微山县|鱼台县|金乡县|嘉祥县|汶上县|泗水县|梁山县|曲阜市|邹城市|宁阳县|东平县|新泰市|肥城市|荣成市|乳山市|五莲县|莒县|沂南县|郯城县|沂水县|兰陵县|费县|平邑县|莒南县|蒙阴县|临沭县|宁津县|庆云县|临邑县|齐河县|平原县|夏津县|武城县|乐陵市|禹城市|阳谷县|莘县|茌平县|东阿县|冠县|高唐县|临清市|惠民县|阳信县|无棣县|博兴县|邹平县|曹县|单县|成武县|巨野县|郓城县|鄄城县|东明县|中牟县|巩义市|荥阳市|新密市|新郑市|登封市|杞县|通许县|尉氏县|兰考县|孟津县|新安县|栾川县|嵩县|汝阳县|宜阳县|洛宁县|伊川县|偃师市|宝丰县|叶县|鲁山县|郏县|舞钢市|汝州市|安阳县|汤阴县|滑县|内黄县|林州市|浚县|淇县|新乡县|获嘉县|原阳县|延津县|封丘县|长垣县|卫辉市|辉县市|修武县|博爱县|武陟县|温县|沁阳市|孟州市|清丰县|南乐县|范县|台前县|濮阳县|鄢陵县|襄城县|禹州市|长葛市|舞阳县|临颍县|渑池县|卢氏县|义马市|灵宝市|南召县|方城县|西峡县|镇平县|内乡县|淅川县|社旗县|唐河县|新野县|桐柏县|邓州市|民权县|睢县|宁陵县|柘城县|虞城县|夏邑县|永城市|罗山县|光山县|新县|商城县|固始县|潢川县|淮滨县|息县|扶沟县|西华县|商水县|沈丘县|郸城县|淮阳县|太康县|鹿邑县|项城市|西平县|上蔡县|平舆县|正阳县|确山县|泌阳县|汝南县|遂平县|新蔡县|阳新县|大冶市|郧西县|竹山县|竹溪县|房县|丹江口市|远安县|兴山县|秭归县|长阳土家族自治县|五峰土家族自治县|宜都市|当阳市|枝江市|南漳县|谷城县|保康县|老河口市|枣阳市|宜城市|京山县|沙洋县|钟祥市|孝昌县|大悟县|云梦县|应城市|安陆市|汉川市|公安县|监利县|江陵县|石首市|洪湖市|松滋市|团风县|红安县|罗田县|英山县|浠水县|蕲春县|黄梅县|麻城市|武穴市|嘉鱼县|通城县|崇阳县|通山县|赤壁市|随县|广水市|恩施市|利川市|建始县|巴东县|宣恩县|咸丰县|来凤县|鹤峰县|长沙县|浏阳市|宁乡市|宁乡县|株洲县|攸县|茶陵县|炎陵县|醴陵市|湘潭县|湘乡市|韶山市|衡阳县|衡南县|衡山县|衡东县|祁东县|耒阳市|常宁市|邵东县|新邵县|邵阳县|隆回县|洞口县|绥宁县|新宁县|城步苗族自治县|武冈市|岳阳县|华容县|湘阴县|平江县|汨罗市|临湘市|安乡县|汉寿县|澧县|临澧县|桃源县|石门县|津市市|慈利县|桑植县|南县|桃江县|安化县|沅江市|桂阳县|宜章县|永兴县|嘉禾县|临武县|汝城县|桂东县|安仁县|资兴市|祁阳县|东安县|双牌县|道县|江永县|宁远县|蓝山县|新田县|江华瑶族自治县|中方县|沅陵县|辰溪县|溆浦县|会同县|麻阳苗族自治县|新晃侗族自治县|芷江侗族自治县|靖州苗族侗族自治县|通道侗族自治县|洪江市|双峰县|新化县|冷水江市|涟源市|吉首市|泸溪县|凤凰县|花垣县|保靖县|古丈县|永顺县|龙山县|始兴县|仁化县|翁源县|乳源瑶族自治县|新丰县|乐昌市|南雄市|澳门大学横琴校区(由澳门管辖)|南澳县|台山市|开平市|鹤山市|恩平市|遂溪县|徐闻县|廉江市|雷州市|吴川市|高州市|化州市|信宜市|广宁县|怀集县|封开县|德庆县|四会市|博罗县|惠东县|龙门县|大埔县|丰顺县|五华县|平远县|蕉岭县|兴宁市|海丰县|陆河县|陆丰市|紫金县|龙川县|连平县|和平县|东源县|阳西县|阳春市|佛冈县|阳山县|连山壮族瑶族自治县|连南瑶族自治县|英德市|连州市|饶平县|揭西县|惠来县|普宁市|新兴县|郁南县|罗定市|隆安县|马山县|上林县|宾阳县|横县|柳城县|鹿寨县|融安县|融水苗族自治县|三江侗族自治县|阳朔县|灵川县|全州县|兴安县|永福县|灌阳县|龙胜各族自治县|资源县|平乐县|荔浦县|恭城瑶族自治县|苍梧县|藤县|蒙山县|岑溪市|合浦县|上思县|东兴市|灵山县|浦北县|平南县|桂平市|容县|陆川县|博白县|兴业县|北流市|田东县|平果县|德保县|那坡县|凌云县|乐业县|田林县|西林县|隆林各族自治县|靖西市|昭平县|钟山县|富川瑶族自治县|南丹县|天峨县|凤山县|东兰县|罗城仫佬族自治县|环江毛南族自治县|巴马瑶族自治县|都安瑶族自治县|大化瑶族自治县|忻城县|象州县|武宣县|金秀瑶族自治县|合山市|扶绥县|宁明县|龙州县|大新县|天等县|凭祥市|西沙群岛|南沙群岛|中沙群岛的岛礁及其海域|城口县|丰都县|垫江县|忠县|云阳县|奉节县|巫山县|巫溪县|石柱土家族自治县|秀山土家族苗族自治县|酉阳土家族苗族自治县|彭水苗族土家族自治县|金堂县|大邑县|蒲江县|新津县|都江堰市|彭州市|邛崃市|崇州市|简阳市|荣县|富顺县|米易县|盐边县|泸县|合江县|叙永县|古蔺县|中江县|广汉市|什邡市|绵竹市|三台县|盐亭县|梓潼县|北川羌族自治县|平武县|江油市|旺苍县|青川县|剑阁县|苍溪县|蓬溪县|射洪县|大英县|威远县|资中县|隆昌市|犍为县|井研县|夹江县|沐川县|峨边彝族自治县|马边彝族自治县|峨眉山市|南部县|营山县|蓬安县|仪陇县|西充县|阆中市|仁寿县|洪雅县|丹棱县|青神县|宜宾县|江安县|长宁县|高县|珙县|筠连县|兴文县|屏山县|岳池县|武胜县|邻水县|华蓥市|宣汉县|开江县|大竹县|渠县|万源市|荥经县|汉源县|石棉县|天全县|芦山县|宝兴县|通江县|南江县|平昌县|安岳县|乐至县|马尔康市|汶川县|理县|茂县|松潘县|九寨沟市|金川县|小金县|黑水县|壤塘县|阿坝县|若尔盖县|红原县|康定市|泸定县|丹巴县|九龙县|雅江县|道孚县|炉霍县|甘孜县|新龙县|德格县|白玉县|石渠县|色达县|理塘县|巴塘县|乡城县|稻城县|得荣县|西昌市|木里藏族自治县|盐源县|德昌县|会理县|会东县|宁南县|普格县|布拖县|金阳县|昭觉县|喜德县|冕宁县|越西县|甘洛县|美姑县|雷波县|开阳县|息烽县|修文县|清镇市|水城县|盘州市|桐梓县|绥阳县|正安县|道真仡佬族苗族自治县|务川仡佬族苗族自治县|凤冈县|湄潭县|余庆县|习水县|赤水市|仁怀市|普定县|镇宁布依族苗族自治县|关岭布依族苗族自治县|紫云苗族布依族自治县|大方县|黔西县|金沙县|织金县|纳雍县|威宁彝族回族苗族自治县|赫章县|江口县|玉屏侗族自治县|石阡县|思南县|印江土家族苗族自治县|德江县|沿河土家族自治县|松桃苗族自治县|兴义市|兴仁县|普安县|晴隆县|贞丰县|望谟县|册亨县|安龙县|凯里市|黄平县|施秉县|三穗县|镇远县|岑巩县|天柱县|锦屏县|剑河县|台江县|黎平县|榕江县|从江县|雷山县|麻江县|丹寨县|都匀市|福泉市|荔波县|贵定县|瓮安县|独山县|平塘县|罗甸县|长顺县|龙里县|惠水县|三都水族自治县|富民县|宜良县|石林彝族自治县|嵩明县|禄劝彝族苗族自治县|寻甸回族彝族自治县|安宁市|马龙县|陆良县|师宗县|罗平县|富源县|会泽县|宣威市|澄江县|通海县|华宁县|易门县|峨山彝族自治县|新平彝族傣族自治县|元江哈尼族彝族傣族自治县|施甸县|龙陵县|昌宁县|腾冲市|鲁甸县|巧家县|盐津县|大关县|永善县|绥江县|镇雄县|彝良县|威信县|水富县|玉龙纳西族自治县|永胜县|华坪县|宁蒗彝族自治县|宁洱哈尼族彝族自治县|墨江哈尼族自治县|景东彝族自治县|景谷傣族彝族自治县|镇沅彝族哈尼族拉祜族自治县|江城哈尼族彝族自治县|孟连傣族拉祜族佤族自治县|澜沧拉祜族自治县|西盟佤族自治县|凤庆县|云县|永德县|镇康县|双江拉祜族佤族布朗族傣族自治县|耿马傣族佤族自治县|沧源佤族自治县|楚雄市|双柏县|牟定县|南华县|姚安县|大姚县|永仁县|元谋县|武定县|禄丰县|个旧市|开远市|蒙自市|弥勒市|屏边苗族自治县|建水县|石屏县|泸西县|元阳县|红河县|金平苗族瑶族傣族自治县|绿春县|河口瑶族自治县|文山市|砚山县|西畴县|麻栗坡县|马关县|丘北县|广南县|富宁县|景洪市|勐海县|勐腊县|大理市|漾濞彝族自治县|祥云县|宾川县|弥渡县|南涧彝族自治县|巍山彝族回族自治县|永平县|云龙县|洱源县|剑川县|鹤庆县|瑞丽市|芒市|梁河县|盈江县|陇川县|泸水市|福贡县|贡山独龙族怒族自治县|兰坪白族普米族自治县|香格里拉市|德钦县|维西傈僳族自治县|林周县|当雄县|尼木县|曲水县|墨竹工卡县|南木林县|江孜县|定日县|萨迦县|拉孜县|昂仁县|谢通门县|白朗县|仁布县|康马县|定结县|仲巴县|亚东县|吉隆县|聂拉木县|萨嘎县|岗巴县|江达县|贡觉县|类乌齐县|丁青县|察雅县|八宿县|左贡县|芒康县|洛隆县|边坝县|工布江达县|米林县|墨脱县|波密县|察隅县|朗县|扎囊县|贡嘎县|桑日县|琼结县|曲松县|措美县|洛扎县|加查县|隆子县|错那县|浪卡子县|嘉黎县|比如县|聂荣县|安多县|申扎县|索县|班戈县|巴青县|尼玛县|双湖县|普兰县|札达县|噶尔县|日土县|革吉县|改则县|措勤县|蓝田县|周至县|宜君县|凤翔县|岐山县|扶风县|眉县|陇县|千阳县|麟游县|凤县|太白县|三原县|泾阳县|乾县|礼泉县|永寿县|彬县|长武县|旬邑县|淳化县|武功县|兴平市|潼关县|大荔县|合阳县|澄城县|蒲城县|白水县|富平县|韩城市|华阴市|延长县|延川县|子长县|志丹县|吴起县|甘泉县|富县|洛川县|宜川县|黄龙县|黄陵县|城固县|洋县|西乡县|勉县|宁强县|略阳县|镇巴县|留坝县|佛坪县|府谷县|靖边县|定边县|绥德县|米脂县|佳县|吴堡县|清涧县|子洲县|神木市|汉阴县|石泉县|宁陕县|紫阳县|岚皋县|平利县|镇坪县|旬阳县|白河县|洛南县|丹凤县|商南县|山阳县|镇安县|柞水县|永登县|皋兰县|榆中县|永昌县|靖远县|会宁县|景泰县|清水县|秦安县|甘谷县|武山县|张家川回族自治县|民勤县|古浪县|天祝藏族自治县|肃南裕固族自治县|民乐县|临泽县|高台县|山丹县|泾川县|灵台县|崇信县|华亭县|庄浪县|静宁县|金塔县|瓜州县|肃北蒙古族自治县|阿克塞哈萨克族自治县|玉门市|敦煌市|庆城县|环县|华池县|合水县|正宁县|宁县|镇原县|通渭县|陇西县|渭源县|临洮县|漳县|岷县|成县|文县|宕昌县|康县|西和县|礼县|徽县|两当县|临夏市|临夏县|康乐县|永靖县|广河县|和政县|东乡族自治县|积石山保安族东乡族撒拉族自治县|合作市|临潭县|卓尼县|舟曲县|迭部县|玛曲县|碌曲县|夏河县|大通回族土族自治县|湟中县|湟源县|民和回族土族自治县|互助土族自治县|化隆回族自治县|循化撒拉族自治县|门源回族自治县|祁连县|海晏县|刚察县|同仁县|尖扎县|泽库县|河南蒙古族自治县|共和县|同德县|贵德县|兴海县|贵南县|玛沁县|班玛县|甘德县|达日县|久治县|玛多县|玉树市|杂多县|称多县|治多县|囊谦县|曲麻莱县|格尔木市|德令哈市|乌兰县|都兰县|天峻县|海西蒙古族藏族自治州直辖|永宁县|贺兰县|灵武市|平罗县|盐池县|同心县|青铜峡市|西吉县|隆德县|泾源县|彭阳县|中宁县|海原县|乌鲁木齐县|鄯善县|托克逊县|巴里坤哈萨克自治县|伊吾县|昌吉市|阜康市|呼图壁县|玛纳斯县|奇台县|吉木萨尔县|木垒哈萨克自治县|博乐市|阿拉山口市|精河县|温泉县|库尔勒市|轮台县|尉犁县|若羌县|且末县|焉耆回族自治县|和静县|和硕县|博湖县|阿克苏市|温宿县|库车县|沙雅县|新和县|拜城县|乌什县|阿瓦提县|柯坪县|阿图什市|阿克陶县|阿合奇县|乌恰县|喀什市|疏附县|疏勒县|英吉沙县|泽普县|莎车县|叶城县|麦盖提县|岳普湖县|伽师县|巴楚县|塔什库尔干塔吉克自治县|和田市|和田县|墨玉县|皮山县|洛浦县|策勒县|于田县|民丰县|伊宁市|奎屯市|霍尔果斯市|伊宁县|察布查尔锡伯自治县|霍城县|巩留县|新源县|昭苏县|特克斯县|尼勒克县|塔城市|乌苏市|额敏县|沙湾县|托里县|裕民县|和布克赛尔蒙古自治县|阿勒泰市|布尔津县|富蕴县|福海县|哈巴河县|青河县|吉木乃县|喀尔交镇|恰勒什海乡|托普铁热克镇|别斯铁热克乡|吉木乃镇|托斯特乡|兵团一八六团|乌拉斯特镇|兵团一五二团|向阳街道|红山街道|东城街道|石河子乡|老街街道|北泉镇|新城街道|阿拉尔农场|幸福路街道|兵团第一师幸福农场|兵团七团|兵团十一团|兵团第一师水利水电工程处|青松路街道|托喀依乡|兵团八团|中心监狱|兵团第一师塔里木灌区水利管理处|兵团十四团|兵团十二团|兵团十三团|金银川路街道|兵团十六团|兵团十团|南口街道|兵团四十九团|兵团图木舒克市永安坝|兵团五十一团|前海街道|兵团图木舒克市喀拉拜勒镇|永安坝街道|齐干却勒街道|兵团五十团|兵团五十三团|兵团四十四团|兵团一零二团|军垦路街道|人民路街道|兵团一零一团|兵团一零三团|青湖路街道|兵团二十九团|农二师三十团|兵团六十八团|都拉塔口岸|兵团六十六团|兵团六十三团|兵团六十七团|兵团六十四团|乌尔其乡|普恰克其乡|兵团皮山农场|兵团二二四团|兵团四十七团|博斯坦乡|喀拉喀什镇|阔依其乡|兵团一牧场|乌鲁克萨依乡|奴尔乡|兵团一零三|坡头镇|梨林镇|思礼镇|大峪镇|五龙口镇|王屋镇|玉泉街道|轵城镇|济水街道|沁园街道|下冶镇|天坛街道|克井镇|邵原镇|北海街道|承留镇|沙湖镇|工业园区|畜禽良种场|豆河镇|通海口镇|胡场镇|长倘口镇|五湖渔场|杨林尾镇|干河街道|西流河镇|赵西垸林场|九合垸原种场|彭场镇|沔城回族镇|龙华山街道|沙湖原种场|陈场镇|郭河镇|排湖风景区|郑场镇|沙嘴街道|张沟镇|毛嘴镇|三伏潭镇|积玉口镇|广华街道|泰丰街道|潜江经济开发区|周矶管理区|周矶街道|总口管理区|高场街道|王场镇|运粮湖管理区|园林街道|白鹭湖管理区|竹根滩镇|渔洋镇|熊口镇|后湖管理区|熊口管理区|江汉石油管理局|张金镇|杨市街道|老新镇|龙湾镇|浩口原种场|浩口镇|高石碑镇|胡市镇|多祥镇|黄潭镇|沉湖管委会|横林镇|马湾镇|干驿镇|蒋湖农场|小板镇|多宝镇|岳口镇|蒋场镇|石家河镇|彭市镇|竟陵街道|九真镇|佛子山镇|侨乡街道开发区|麻洋镇|杨林街道|白茅湖农场|汪场镇|渔薪镇|净潭乡|卢市镇|皂市镇|拖市镇|张港镇|下谷坪土家族乡|木鱼镇|新华镇|九湖镇|宋洛乡|松柏镇|红坪镇|阳日镇|常平镇|莞城街道|望牛墩镇|大朗镇|麻涌镇|黄江镇|凤岗镇|樟木头镇|东莞生态园|松山湖管委会|桥头镇|石龙镇|寮步镇|高埗镇|塘厦镇|厚街镇|谢岗镇|虎门镇|南城街道|虎门港管委会|横沥镇|企石镇|东坑镇|东城街道|石排镇|洪梅镇|沙田镇|长安镇|道滘镇|大岭山镇|清溪镇|茶山镇|中堂镇|万江街道|石碣镇|横栏镇|三角镇|五桂山街道|东升镇|神湾镇|火炬开发区街道|小榄镇|南朗镇|古镇镇|民众镇|港口镇|三乡镇|石岐区街道|大涌镇|南头镇|黄圃镇|东区街道|阜沙镇|板芙镇|西区街道|坦洲镇|南区街道|沙溪镇|东凤镇|洋浦经济开发区|光村镇|兰洋镇|海头镇|和庆镇|华南热作学院|国营蓝洋农场|中和镇|王五镇|木棠镇|东成镇|新州镇|南丰镇|排浦镇|国营西培农场|雅星镇|国营八一农场|国营西联农场|白马井镇|那大镇|峨蔓镇|大成镇|三都镇|南圣镇|毛阳镇|国营畅好农场|番阳镇|水满乡|通什镇|畅好乡|毛道乡|嘉积镇|会山镇|国营东升农场|国营东太农场|彬村山华侨农场|万泉镇|大路镇|潭门镇|国营东红农场|中原镇|长坡镇|龙江镇|塔洋镇|博鳌镇|阳江镇|石壁镇|东阁镇|国营罗豆农场|文教镇|会文镇|锦山镇|翁田镇|东郊镇|国营东路农场|铺前镇|龙楼镇|冯坡镇|国营南阳农场|昌洒镇|公坡镇|蓬莱镇|抱罗镇|潭牛镇|东路镇|文城镇|重兴镇|礼纪镇|国营东兴农场|后安镇|国营东和农场|万城镇|和乐镇|大茂镇|山根镇|龙滚镇|兴隆华侨农场|三更罗镇|北大镇|长丰镇|地方国营六连林场|国营新中农场|南桥镇|东澳镇|东方华侨农场|新龙镇|江边乡|国营广坝农场|天安乡|东河镇|感城镇|三家镇|四更镇|大田镇|板桥镇|八所镇|黄竹镇|新竹镇|国营中瑞农场|富文镇|岭口镇|定城镇|雷鸣镇|翰林镇|国营南海农场|龙河镇|国营金鸡岭农场|龙湖镇|龙门镇|国营中建农场|屯城镇|南吕镇|坡心镇|新兴镇|国营中坤农场|西昌镇|枫木镇|南坤镇|乌坡镇|永发镇|福山镇|中兴镇|桥头镇|金江镇|老城镇|文儒镇|国营红岗农场|瑞溪镇|国营红光农场|大丰镇|加乐镇|国营昆仑农场|国营金安农场|国营西达农场|国营和岭农场|仁兴镇|南宝镇|博厚镇|和舍镇|东英镇|调楼镇|波莲镇|多文镇|国营加来农场|新盈镇|临城镇|皇桐镇|国营红华农场|七坊镇|金波乡|南开乡|荣邦乡|青松乡|国营龙江农场|邦溪镇|元门乡|国营白沙农场|牙叉镇|细水乡|打安镇|阜龙乡|国营邦溪农场|国营霸王岭林场|十月田镇|石碌镇|海南矿业联合有限公司|七叉镇|乌烈镇|叉河镇|王下乡|海尾镇|国营红林农场|昌化镇|国营山荣农场|莺歌海镇|国营乐光农场|万冲镇|利国镇|国营保国农场|抱由镇|九所镇|国营莺歌海盐场|黄流镇|大安镇|佛罗镇|尖峰镇|千家镇|志仲镇|国营尖峰岭林业公司|椰林镇|黎安镇|群英乡|新村镇|国营吊罗山林业公司|本号镇|光坡镇|文罗镇|国营南平农场|隆广镇|提蒙乡|三才镇|国营岭门农场|英州镇|海南保亭热带作物研究所|新政镇|加茂镇|国营新星农场|保城镇|国营金江农场|南林乡|国营三道农场|毛感乡|响水镇|什玲镇|三道镇|六弓乡|吊罗山乡|国营加钗农场|和平镇|国营乌石农场|什运乡|湾岭镇|国营阳江农场|国营黎母山林业公司|营根镇|上安乡|中平镇|黎母山镇|国营长征农场|红毛镇|长征镇|峪泉镇|新城镇|文殊镇|雄关区|镜铁区|长城区|[^区]+区)&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">detailAddress</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;?(?&lt;detail&gt;.*)&quot;</span>;<br>        <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> Pattern.compile(regex+countyRegex+detailAddress).matcher(address);<br>        String province, city, county,detail;<br>        Map&lt;String, String&gt; row  = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span> &lt;&gt;(<span class="hljs-number">3</span>);<br>        <span class="hljs-keyword">while</span> (matcher.find()) &#123;<br>            province = matcher.group(<span class="hljs-string">&quot;province&quot;</span>);<br>            row.put(<span class="hljs-string">&quot;province&quot;</span>, province==<span class="hljs-literal">null</span>?<span class="hljs-literal">null</span>:province.trim());<br>            city = matcher.group(<span class="hljs-string">&quot;city&quot;</span>);<br>            row.put(<span class="hljs-string">&quot;city&quot;</span>, city==<span class="hljs-literal">null</span>?<span class="hljs-literal">null</span>:city.trim());<br>            <span class="hljs-keyword">if</span> (row.get(<span class="hljs-string">&quot;city&quot;</span>).equals(<span class="hljs-string">&quot;市&quot;</span>))&#123;<br>                row.put(<span class="hljs-string">&quot;city&quot;</span>,row.get(<span class="hljs-string">&quot;province&quot;</span>)+row.get(<span class="hljs-string">&quot;city&quot;</span>));<br>            &#125;<br>            county = matcher.group(<span class="hljs-string">&quot;county&quot;</span>);<br>            row.put(<span class="hljs-string">&quot;county&quot;</span>, county==<span class="hljs-literal">null</span>?<span class="hljs-literal">null</span>:county.trim());<br>            detail = matcher.group(<span class="hljs-string">&quot;detail&quot;</span>);<br>            row.put(<span class="hljs-string">&quot;detail&quot;</span>, detail==<span class="hljs-literal">null</span>?<span class="hljs-string">&quot;&quot;</span>:detail.trim());<br>        &#125;<br>        <span class="hljs-keyword">return</span> row;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Java解析地址</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java中常见的各类锁</title>
    <link href="/2023/03/06/Java/Java%E4%B8%AD%E5%B8%B8%E8%A7%81%E7%9A%84%E5%90%84%E7%B1%BB%E9%94%81/"/>
    <url>/2023/03/06/Java/Java%E4%B8%AD%E5%B8%B8%E8%A7%81%E7%9A%84%E5%90%84%E7%B1%BB%E9%94%81/</url>
    
    <content type="html"><![CDATA[<h1 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h1><h1 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h1><h1 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h1><h1 id="Synchronized同步锁"><a href="#Synchronized同步锁" class="headerlink" title="Synchronized同步锁"></a>Synchronized同步锁</h1><h1 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h1><h1 id="非公平锁"><a href="#非公平锁" class="headerlink" title="非公平锁"></a>非公平锁</h1><h1 id="公平锁"><a href="#公平锁" class="headerlink" title="公平锁"></a>公平锁</h1><h1 id="可重入锁-递归锁"><a href="#可重入锁-递归锁" class="headerlink" title="可重入锁(递归锁)"></a>可重入锁(递归锁)</h1><h1 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h1><h1 id="独占锁共享锁"><a href="#独占锁共享锁" class="headerlink" title="独占锁共享锁"></a>独占锁共享锁</h1><h2 id="独占锁"><a href="#独占锁" class="headerlink" title="独占锁"></a>独占锁</h2><h2 id="共享锁"><a href="#共享锁" class="headerlink" title="共享锁"></a>共享锁</h2><h1 id="锁状态"><a href="#锁状态" class="headerlink" title="锁状态"></a>锁状态</h1><h2 id="重量级锁-Mutex-Lock"><a href="#重量级锁-Mutex-Lock" class="headerlink" title="重量级锁(Mutex Lock)"></a>重量级锁(Mutex Lock)</h2><h2 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h2><h2 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h2><h2 id="锁升级"><a href="#锁升级" class="headerlink" title="锁升级"></a>锁升级</h2><h2 id="分段锁"><a href="#分段锁" class="headerlink" title="分段锁"></a>分段锁</h2><h1 id="同步锁与死锁"><a href="#同步锁与死锁" class="headerlink" title="同步锁与死锁"></a>同步锁与死锁</h1><h2 id="同步锁"><a href="#同步锁" class="headerlink" title="同步锁"></a>同步锁</h2><h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><h2 id="锁优化思路"><a href="#锁优化思路" class="headerlink" title="锁优化思路"></a>锁优化思路</h2><h1 id="Condition类和Object类锁方法"><a href="#Condition类和Object类锁方法" class="headerlink" title="Condition类和Object类锁方法"></a>Condition类和Object类锁方法</h1><p>参考文档：<a href="https://blog.csdn.net/xingchensuiyue/article/details/108716466">https://blog.csdn.net/xingchensuiyue/article/details/108716466</a></p><p>参考文档：<a href="https://www.cnblogs.com/jyroy/p/11365935.html">https://www.cnblogs.com/jyroy/p/11365935.html</a></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>锁</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>分布式架构</title>
    <link href="/2023/03/02/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/"/>
    <url>/2023/03/02/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<p>要理解分布式系统，主要需要明白一下2个方面：</p><ol><li>分布式系统一定是由多个节点组成的系统。其中，节点指的是计算机服务器，而且这些节点一般不是孤立的，而是互通的。</li><li>这些连通的节点上部署了我们的节点，并且相互的操作会有协同。</li></ol><p>不同的业务模块部署在不同的服务器上或者同一个业务模块分拆多个子业务，部署在不同的服务器上，解决高并发的问题，提供可扩展性以及高可用性，业务中使用分布式的场景主要有分布式存储以及分布式计算。分布式存储中可以将数据分片到多个节点上，不仅可以提高性能（可扩展性），同时也可以使用多个节点对同一份数据进行备份。</p><p><strong>分布式环境的特点</strong></p><ol><li>分布性：服务部署空间具有多样性</li><li>并发性：程序运行过程中，并发性操作是很常见的。比如同一个分布式系统中的多个节点，同时访问一个共享资源。数据库、分布式存储</li><li>无序性：进程之间的消息通信，会出现顺序不一致问题</li></ol><p><strong>分布式环境下面临的问题</strong></p><ol><li>网络通信：网络本身的不可靠性，因此会涉及到一些网络通信问题</li><li>网络分区(脑裂)：当网络发生异常导致分布式系统中部分节点之间的网络延时不断增大，最终导致组成分布式架构的所有节点，只有部分节点能够正常通信</li><li>三态：在分布式架构里面多了个状态：超时，所以有三态： 成功、失败、超时</li><li>分布式事务：ACID(原子性、一致性、隔离性、持久性)</li><li>中心化和去中心化：冷备或者热备</li></ol><p>分布式架构里面，很多的架构思想采用的是：当集群发生故障的时候，集群中的人群会自动“选举”出一个新的领导。</p><p>最典型的是： zookeeper &#x2F; etcd</p><p>经典的CAP&#x2F;BASE理论</p><p><strong>CAP理论</strong></p><p><img src="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/20210916125034.png" alt="CAP理论"></p><p>1998年，加州大学的计算机科学家 Eric Brewer 提出，分布式系统有三个指标。</p><ul><li>Consistency</li><li>Availability</li><li>Partition tolerance</li></ul><p>它们的第一个字母分别是 C、A、P。</p><p>Eric Brewer 说，这三个指标不可能同时做到。这个结论就叫做 CAP 定理。</p><p>1、分区容错 （Partition-tolerance）</p><p>先看 Partition tolerance，中文叫做”分区容错”。</p><p>大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区（partition）。分区容错的意思是，区间通信可能失败。比如，一台服务器放在中国，另一台服务器放在美国，这就是两个区，它们之间可能无法通信。</p><p><img src="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/v2-8ff16b034b62b5092d159a920f8aa226_720w.webp" alt="img"></p><p>上图中，G1 和 G2 是两台跨区的服务器。G1 向 G2 发送一条消息，G2 可能无法收到。系统设计的时候，必须考虑到这种情况。</p><p>一般来说，分区容错无法避免，因此可以认为 CAP 的 P 总是成立。CAP 定理告诉我们，剩下的 C 和 A 无法同时做到。</p><p>2、一致性（Consistency）</p><p>Consistency 中文叫做”一致性”。意思是，写操作之后的读操作，必须返回该值。举例来说，某条记录是 v0，用户向 G1 发起一个写操作，将其改为 v1。</p><p><img src="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/v2-d534c2d294701d340343ecc68034d218_720w.webp" alt="img"></p><p>接下来，用户的读操作就会得到 v1。这就叫一致性。</p><p><img src="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/v2-032d7fac4aa7fe3fddf888f5d482b464_720w.webp" alt="img"></p><p>问题是，用户有可能向 G2 发起读操作，由于 G2 的值没有发生变化，因此返回的是 v0。G1 和 G2 读操作的结果不一致，这就不满足一致性了。</p><p><img src="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/v2-8a1a4743d6eb4a2bc1447dafa1da1ace_720w.webp" alt="img"></p><p>为了让 G2 也能变为 v1，就要在 G1 写操作的时候，让 G1 向 G2 发送一条消息，要求 G2 也改成 v1。</p><p><img src="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/v2-b461a588b8e11f5374971e15668d5d03_720w.webp" alt="img"></p><p>这样的话，用户向 G2 发起读操作，也能得到 v1。</p><p><img src="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/v2-64a08fc33176af5b8a09821306091965_720w.webp" alt="img"></p><p>3、可用性（Availability）</p><p>Availability 中文叫做”可用性”，意思是只要收到用户的请求，服务器就必须给出回应。</p><p>用户可以选择向 G1 或 G2 发起读操作。不管是哪台服务器，只要收到请求，就必须告诉用户，到底是 v0 还是 v1，否则就不满足可用性。</p><p>4、Consistency 和 Availability 的矛盾</p><p>一致性和可用性，为什么不可能同时成立？答案很简单，因为可能通信失败（即出现分区容错）。</p><p>如果保证 G2 的一致性，那么 G1 必须在写操作时，锁定 G2 的读操作和写操作。只有数据同步后，才能重新开放读写。锁定期间，G2 不能读写，没有可用性不。</p><p>如果保证 G2 的可用性，那么势必不能锁定 G2，所以一致性不成立。</p><p>综上所述，G2 无法同时做到一致性和可用性。系统设计时只能选择一个目标。如果追求一致性，那么无法保证所有节点的可用性；如果追求所有节点的可用性，那就没法做到一致性。</p><p><strong>BASE</strong></p><p>基于CAP理论，CAP理论并不适用于数据库事务（因为更新一些错误的数据而导致数据出现紊乱，无论什么样的数据库高可用方案都是徒劳） ，虽然XA事务可以保证数据库在分布式系统下的ACID特性，但是会带来性能方面的影响；</p><p>eBay尝试了一种完全不同的套路，放宽了对事务ACID的要求。提出了BASE理论</p><p>Basically available ： 数据库采用分片模式， 把100W的用户数据分布在5个实例上。如果破坏了其中一个实例，仍然可以保证</p><p>80%的用户可用</p><p>soft-state： 在基于client-server模式的系统中，server端是否有状态，决定了系统是否具备良好的水平扩展、负载均衡、故障恢复等特性。</p><p>Server端承诺会维护client端状态数据，这个状态仅仅维持一小段时间, 这段时间以后，server端就会丢弃这个状态，恢复正常状态</p><p>Eventually consistent：数据的最终一致性</p><p>集群与分布式区别</p><p>集群：复制模式，每台机器做一样的事。</p><p>分布式：两台机器分工合作，每台机器做的不一样。</p><p>常见的分布式系统</p><p><img src="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/v2-e7fc4b1bec180e4d65230035e7444bb5_720w.webp" alt="img"></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式</tag>
      
      <tag>架构</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>XXL-JOB</title>
    <link href="/2023/03/02/%E4%B8%AD%E9%97%B4%E4%BB%B6/XXL-JOB/"/>
    <url>/2023/03/02/%E4%B8%AD%E9%97%B4%E4%BB%B6/XXL-JOB/</url>
    
    <content type="html"><![CDATA[<h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><h2 id="1-1-概述"><a href="#1-1-概述" class="headerlink" title="1.1 概述"></a>1.1 概述</h2><p>XXL-JOB是一个分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并介入多家公司上线产品，开箱即用。</p><h2 id="1-2-社区交流"><a href="#1-2-社区交流" class="headerlink" title="1.2 社区交流"></a>1.2 社区交流</h2><p><a href="https://www.xuxueli.com/page/community.html">社区交流</a></p><h2 id="1-3-特性"><a href="#1-3-特性" class="headerlink" title="1.3 特性"></a>1.3 特性</h2><p>1、简单：支持通过Web页面对任务进行CRUD操作，操作简单，一分钟上手；</p><p>2、动态：支持动态修改任务状态、启动&#x2F;停止任务，以及终止运行中任务，即时生效；</p><p>3、调度中心HA（中心式）：调度采用中心式设计，“调度中心”自研调度组件并支持集群部署，可保证调度中心HA；</p><p>4、执行器HA（分布式）：任务分布式执行，任务”执行器”支持集群部署，可保证任务执行HA；</p><p>5、注册中心: 执行器会周期性自动注册任务, 调度中心将会自动发现注册的任务并触发执行。同时，也支持手动录入执行器地址；</p><p>6、弹性扩容缩容：一旦有新执行器机器上线或者下线，下次调度时将会重新分配任务；</p><p>7、触发策略：提供丰富的任务触发策略，包括：Cron触发、固定间隔触发、固定延时触发、API（事件）触发、人工触发、父子任务触发；</p><p>8、调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等；</p><p>9、阻塞处理策略：调度过于密集执行器来不及处理时的处理策略，策略包括：单机串行（默认）、丢弃后续调度、覆盖之前调度；</p><p>10、任务超时控制：支持自定义任务超时时间，任务运行超时将会主动中断任务；</p><p>11、任务失败重试：支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；其中分片任务支持分片粒度的失败重试；</p><p>12、任务失败告警；默认提供邮件方式失败告警，同时预留扩展接口，可方便的扩展短信、钉钉等告警方式；</p><p>13、路由策略：执行器集群部署时提供丰富的路由策略，包括：第一个、最后一个、轮询、随机、一致性HASH、最不经常使用、最近最久未使用、故障转移、忙碌转移等；</p><p>14、分片广播任务：执行器集群部署时，任务路由策略选择”分片广播”情况下，一次任务调度将会广播触发集群中所有执行器执行一次任务，可根据分片参数开发分片任务；</p><p>15、动态分片：分片广播任务以执行器为维度进行分片，支持动态扩容执行器集群从而动态增加分片数量，协同进行业务处理；在进行大数据量业务操作时可显著提升任务处理能力和速度。</p><p>16、故障转移：任务路由策略选择”故障转移”情况下，如果执行器集群中某一台机器故障，将会自动Failover切换到一台正常的执行器发送调度请求。</p><p>17、任务进度监控：支持实时监控任务进度；</p><p>18、Rolling实时日志：支持在线查看调度结果，并且支持以Rolling方式实时查看执行器输出的完整的执行日志；</p><p>19、GLUE：提供Web IDE，支持在线开发任务逻辑代码，动态发布，实时编译生效，省略部署上线的过程。支持30个版本的历史版本回溯。</p><p>20、脚本任务：支持以GLUE模式开发和运行脚本任务，包括Shell、Python、NodeJS、PHP、PowerShell等类型脚本;</p><p>21、命令行任务：原生提供通用命令行任务Handler（Bean任务，”CommandJobHandler”）；业务方只需要提供命令行即可；</p><p>22、任务依赖：支持配置子任务依赖，当父任务执行结束且执行成功后将会主动触发一次子任务的执行, 多个子任务用逗号分隔；</p><p>23、一致性：“调度中心”通过DB锁保证集群分布式调度的一致性, 一次任务调度只会触发一次执行；</p><p>24、自定义任务参数：支持在线配置调度任务入参，即时生效；</p><p>25、调度线程池：调度系统多线程触发调度运行，确保调度精确执行，不被堵塞；</p><p>26、数据加密：调度中心和执行器之间的通讯进行数据加密，提升调度信息安全性；</p><p>27、邮件报警：任务失败时支持邮件报警，支持配置多邮件地址群发报警邮件；</p><p>28、推送maven中央仓库: 将会把最新稳定版推送到maven中央仓库, 方便用户接入和使用;</p><p>29、运行报表：支持实时查看运行数据，如任务数量、调度次数、执行器数量等；以及调度报表，如调度日期分布图，调度成功分布图等；</p><p>30、全异步：任务调度流程全异步化设计实现，如异步调度、异步运行、异步回调等，有效对密集调度进行流量削峰，理论上支持任意时长任务的运行；</p><p>31、跨语言：调度中心与执行器提供语言无关的 RESTful API 服务，第三方任意语言可据此对接调度中心或者实现执行器。除此之外，还提供了 “多任务模式”和“httpJobHandler”等其他跨语言方案；</p><p>32、国际化：调度中心支持国际化设置，提供中文、英文两种可选语言，默认为中文；</p><p>33、容器化：提供官方docker镜像，并实时更新推送dockerhub，进一步实现产品开箱即用；</p><p>34、线程池隔离：调度线程池进行隔离拆分，慢任务自动降级进入”Slow”线程池，避免耗尽调度线程，提高系统稳定性；</p><p>35、用户管理：支持在线管理系统用户，存在管理员、普通用户两种角色；</p><p>36、权限控制：执行器维度进行权限控制，管理员拥有全量权限，普通用户需要分配执行器权限后才允许相关操作；</p><h2 id="1-4-发展"><a href="#1-4-发展" class="headerlink" title="1.4  发展"></a>1.4  发展</h2><p>略</p><h2 id="1-5-下载"><a href="#1-5-下载" class="headerlink" title="1.5 下载"></a>1.5 下载</h2><h4 id="文档地址"><a href="#文档地址" class="headerlink" title="文档地址"></a>文档地址</h4><p>​<a href="https://www.xuxueli.com/xxl-job/">中文文档</a></p><p>​<a href="https://www.xuxueli.com/xxl-job/en/">English Documentation</a></p><h4 id="源码仓库地址"><a href="#源码仓库地址" class="headerlink" title="源码仓库地址"></a>源码仓库地址</h4><table><thead><tr><th align="left">源码仓库地址</th><th align="left">Release Download</th></tr></thead><tbody><tr><td align="left"><a href="https://github.com/xuxueli/xxl-job">https://github.com/xuxueli/xxl-job</a></td><td align="left"><a href="https://github.com/xuxueli/xxl-job/releases">Download</a></td></tr><tr><td align="left"><a href="http://gitee.com/xuxueli0323/xxl-job">http://gitee.com/xuxueli0323/xxl-job</a></td><td align="left"><a href="http://gitee.com/xuxueli0323/xxl-job/releases">Download</a></td></tr></tbody></table><h4 id="中央仓库地址"><a href="#中央仓库地址" class="headerlink" title="中央仓库地址"></a>中央仓库地址</h4><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-comment">&lt;!-- http://repo1.maven.org/maven2/com/xuxueli/xxl-job-core/ --&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuxueli<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xxl-job-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$</span><span class="hljs-template-variable">&#123;最新稳定版本&#125;</span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br></code></pre></td></tr></table></figure><h3 id="1-6-环境"><a href="#1-6-环境" class="headerlink" title="1.6 环境"></a>1.6 环境</h3><p>​Maven3+</p><p>​Jdk1.8+</p><p>​Mysql5.7+</p><h1 id="二、快速入门"><a href="#二、快速入门" class="headerlink" title="二、快速入门"></a>二、快速入门</h1><h2 id="2-1-初始化“调度数据库”"><a href="#2-1-初始化“调度数据库”" class="headerlink" title="2.1 初始化“调度数据库”"></a>2.1 初始化“调度数据库”</h2><p>请下载项目源码并解压，获取 “调度数据库初始化SQL脚本” 并执行即可。</p><p>“调度数据库初始化SQL脚本” 位置为:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/xxl-job/</span>doc<span class="hljs-regexp">/db/</span>tables_xxl_job.sql<br></code></pre></td></tr></table></figure><p>调度中心支持集群部署，集群情况下各节点务必连接同一个mysql实例;</p><p>如果mysql做主从,调度中心集群节点务必强制走主库;</p><h2 id="2-2-编译源码"><a href="#2-2-编译源码" class="headerlink" title="2.2 编译源码"></a>2.2 编译源码</h2><p>解压源码,按照maven格式将源码导入IDE, 使用maven进行编译即可，源码结构如下：</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cos">xxl-<span class="hljs-keyword">job</span>-admin：调度中心<br>xxl-<span class="hljs-keyword">job</span>-core：公共依赖<br>xxl-<span class="hljs-keyword">job</span>-executor-samples：执行器Sample示例（选择合适的版本执行器，可直接使用，也可以参考其并将现有项目改造成执行器）<br>：xxl-<span class="hljs-keyword">job</span>-executor-sample-springboot：Springboot版本，通过Springboot管理执行器，推荐这种方式；<br>    ：xxl-<span class="hljs-keyword">job</span>-executor-sample-frameless：无框架版本；<br></code></pre></td></tr></table></figure><h2 id="2-3-配置部署“调度中心”"><a href="#2-3-配置部署“调度中心”" class="headerlink" title="2.3 配置部署“调度中心”"></a>2.3 配置部署“调度中心”</h2><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cos">调度中心项目：xxl-<span class="hljs-keyword">job</span>-admin<br>作用：统一管理任务调度平台上调度任务，负责触发调度执行，并且提供任务管理平台。<br></code></pre></td></tr></table></figure><h3 id="步骤一：调度中心配置："><a href="#步骤一：调度中心配置：" class="headerlink" title="步骤一：调度中心配置："></a>步骤一：调度中心配置：</h3><p>调度中心配置文件地址：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/xxl-job/</span>xxl-job-admin<span class="hljs-regexp">/src/m</span>ain<span class="hljs-regexp">/resources/</span>application.properties<br></code></pre></td></tr></table></figure><p>调度中心配置内容说明：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">### 调度中心JDBC链接：链接地址请保持和 2.1章节 所创建的调度数据库的地址一致</span><br>spring.datasource.<span class="hljs-attribute">url</span>=jdbc:mysql://127.0.0.1:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai<br>spring.datasource.<span class="hljs-attribute">username</span>=root<br>spring.datasource.<span class="hljs-attribute">password</span>=root_pwd<br>spring.datasource.<span class="hljs-attribute">driver-class-name</span>=com.mysql.jdbc.Driver<br><br><span class="hljs-comment">### 报警邮箱</span><br>spring.mail.<span class="hljs-attribute">host</span>=smtp.qq.com<br>spring.mail.<span class="hljs-attribute">port</span>=25<br>spring.mail.<span class="hljs-attribute">username</span>=xxx@qq.com<br>spring.mail.<span class="hljs-attribute">password</span>=xxx<br>spring.mail.properties.mail.smtp.<span class="hljs-attribute">auth</span>=<span class="hljs-literal">true</span><br>spring.mail.properties.mail.smtp.starttls.<span class="hljs-attribute">enable</span>=<span class="hljs-literal">true</span><br>spring.mail.properties.mail.smtp.starttls.<span class="hljs-attribute">required</span>=<span class="hljs-literal">true</span><br>spring.mail.properties.mail.smtp.socketFactory.<span class="hljs-attribute">class</span>=javax.net.ssl.SSLSocketFactory<br><br><span class="hljs-comment">### 调度中心通讯TOKEN [选填]：非空时启用；</span><br>xxl.job.accessToken=<br><br><span class="hljs-comment">### 调度中心国际化配置 [必填]： 默认为 &quot;zh_CN&quot;/中文简体, 可选范围为 &quot;zh_CN&quot;/中文简体, &quot;zh_TC&quot;/中文繁体 and &quot;en&quot;/英文；</span><br>xxl.job.<span class="hljs-attribute">i18n</span>=zh_CN<br><br><span class="hljs-comment">## 调度线程池最大线程配置【必填】</span><br>xxl.job.triggerpool.fast.<span class="hljs-attribute">max</span>=200<br>xxl.job.triggerpool.slow.<span class="hljs-attribute">max</span>=100<br><br><span class="hljs-comment">### 调度中心日志表数据保存天数 [必填]：过期日志自动清理；限制大于等于7时生效，否则, 如-1，关闭自动清理功能；</span><br>xxl.job.<span class="hljs-attribute">logretentiondays</span>=30<br></code></pre></td></tr></table></figure><h3 id="步骤二：部署项目："><a href="#步骤二：部署项目：" class="headerlink" title="步骤二：部署项目："></a>步骤二：部署项目：</h3><p>如果已经正确进行上述配置，可将项目编译打包部署。</p><p>调度中心访问地址：<a href="http://localhost:8080/xxl-job-admin">http://localhost:8080/xxl-job-admin</a> (该地址执行器将会使用到，作为回调地址)</p><p>默认登录账号 “admin&#x2F;123456”, 登录后运行界面如下图所示。</p><p><img src="/XXL-JOB/image-20221130133254085.png" alt="image-20221130133254085"></p><p>至此“调度中心”项目已经部署成功。</p><h3 id="步骤三：调度中心集群（可选）："><a href="#步骤三：调度中心集群（可选）：" class="headerlink" title="步骤三：调度中心集群（可选）："></a>步骤三：调度中心集群（可选）：</h3><p>调度中心支持集群部署，提升调度系统容灾和可用性。</p><p>调度中心集群部署时，几点要求和建议：</p><ul><li>DB配置保持一致；</li><li>集群机器时钟保持一致（单机集群忽视）；</li><li>建议：推荐通过nginx为调度中心集群做负载均衡，分配域名。调度中心访问、执行器回调配置、调用API服务等操作均通过该域名进行。</li></ul><h4 id="其他：Docker-镜像方式搭建调度中心："><a href="#其他：Docker-镜像方式搭建调度中心：" class="headerlink" title="其他：Docker 镜像方式搭建调度中心："></a>其他：Docker 镜像方式搭建调度中心：</h4><ul><li>下载镜像</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> Docker地址：https:<span class="hljs-regexp">//</span>hub.docker.com<span class="hljs-regexp">/r/</span>xuxueli<span class="hljs-regexp">/xxl-job-admin/</span>     (建议指定版本号)<br>docker pull xuxueli/xxl-job-admin<br></code></pre></td></tr></table></figure><ul><li>创建容器并运行</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker run -p <span class="hljs-number">8080</span>:<span class="hljs-number">8080</span> -v <span class="hljs-regexp">/tmp:/</span>data<span class="hljs-regexp">/applogs --name xxl-job-admin  -d xuxueli/</span>xxl-job-admin:&#123;指定版本&#125;<br>/**<br>* 如需自定义 mysql 等配置，可通过 <span class="hljs-string">&quot;-e PARAMS&quot;</span> 指定，参数格式 PARAMS=<span class="hljs-string">&quot;--key=value  --key2=value2&quot;</span> ;<br>* 配置项参考文件：<span class="hljs-regexp">/xxl-job/</span>xxl-job-admin<span class="hljs-regexp">/src/m</span>ain<span class="hljs-regexp">/resources/</span>application.properties<br>* 如需自定义 JVM内存参数 等配置，可通过 <span class="hljs-string">&quot;-e JAVA_OPTS&quot;</span> 指定，参数格式 JAVA_OPTS=<span class="hljs-string">&quot;-Xmx512m&quot;</span> ;<br>*/<br>docker run -e PARAMS=<span class="hljs-string">&quot;--spring.datasource.url=jdbc:mysql://127.0.0.1:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai&quot;</span> -p <span class="hljs-number">8080</span>:<span class="hljs-number">8080</span> -v <span class="hljs-regexp">/tmp:/</span>data<span class="hljs-regexp">/applogs --name xxl-job-admin  -d xuxueli/</span>xxl-job-admin:&#123;指定版本&#125;<br></code></pre></td></tr></table></figure><h2 id="2-4-配置部署“执行器项目”"><a href="#2-4-配置部署“执行器项目”" class="headerlink" title="2.4 配置部署“执行器项目”"></a>2.4 配置部署“执行器项目”</h2><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cos">“执行器”项目：xxl-<span class="hljs-keyword">job</span>-executor-sample-springboot (提供多种版本执行器供选择，现以 springboot 版本为例，可直接使用，也可以参考其并将现有项目改造成执行器)<br>作用：负责接收“调度中心”的调度并执行；可直接部署执行器，也可以将执行器集成到现有业务项目中。<br></code></pre></td></tr></table></figure><h3 id="步骤一：maven依赖"><a href="#步骤一：maven依赖" class="headerlink" title="步骤一：maven依赖"></a>步骤一：maven依赖</h3><p>确认pom文件中引入了 “xxl-job-core” 的maven依赖；</p><h3 id="步骤二：执行器配置"><a href="#步骤二：执行器配置" class="headerlink" title="步骤二：执行器配置"></a>步骤二：执行器配置</h3><p>执行器配置，配置文件地址：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/xxl-job/</span>xxl-job-executor-samples<span class="hljs-regexp">/xxl-job-executor-sample-springboot/</span>src<span class="hljs-regexp">/main/</span>resources/application.properties<br></code></pre></td></tr></table></figure><p>执行器配置，配置内容说明：</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs clean">### 调度中心部署根地址 [选填]：如调度中心集群部署存在多个地址则用逗号分隔。执行器将会使用该地址进行<span class="hljs-string">&quot;执行器心跳注册&quot;</span>和<span class="hljs-string">&quot;任务结果回调&quot;</span>；为空则关闭自动注册；xxl.job.admin.addresses=http:<span class="hljs-comment">//127.0.0.1:8080/xxl-job-admin</span><br><br>### 执行器通讯TOKEN [选填]：非空时启用；<br>xxl.job.accessToken=<br><br>### 执行器AppName [选填]：执行器心跳注册分组依据；为空则关闭自动注册<br>xxl.job.executor.appname=xxl-job-executor-sample<br>### 执行器注册 [选填]：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题。<br>xxl.job.executor.address=<br>### 执行器IP [选填]：默认为空表示自动获取IP，多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 <span class="hljs-string">&quot;执行器注册&quot;</span> 和 <span class="hljs-string">&quot;调度中心请求并触发任务&quot;</span>；<br>xxl.job.executor.ip=<br>### 执行器端口号 [选填]：小于等于<span class="hljs-number">0</span>则自动获取；默认端口为<span class="hljs-number">9999</span>，单机部署多个执行器时，注意要配置不同执行器端口；xxl.job.executor.port=<span class="hljs-number">9999</span><br>### 执行器运行日志文件存储磁盘路径 [选填] ：需要对该路径拥有读写权限；为空则使用默认路径；xxl.job.executor.logpath=/data/applogs/xxl-job/jobhandler<br>### 执行器日志文件保存天数 [选填] ： 过期日志自动清理, 限制值大于等于<span class="hljs-number">3</span>时生效; 否则, 如<span class="hljs-number">-1</span>, 关闭自动清理功能；<br>xxl.job.executor.logretentiondays=<span class="hljs-number">30</span><br></code></pre></td></tr></table></figure><h3 id="步骤三：执行器组件配置"><a href="#步骤三：执行器组件配置" class="headerlink" title="步骤三：执行器组件配置"></a>步骤三：执行器组件配置</h3><p>执行器组件，配置文件地址：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/xxl-job/</span>xxl-job-executor-samples<span class="hljs-regexp">/xxl-job-executor-sample-springboot/</span>src<span class="hljs-regexp">/main/</span>java<span class="hljs-regexp">/com/</span>xxl<span class="hljs-regexp">/job/</span>executor<span class="hljs-regexp">/core/</span>config/XxlJobConfig.java<br></code></pre></td></tr></table></figure><p>执行器组件，配置内容说明：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">@Bean<br>public XxlJobSpringExecutor xxl<span class="hljs-constructor">JobExecutor()</span> &#123;<br>logger.info(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);    <br>XxlJobSpringExecutor xxlJobSpringExecutor = <span class="hljs-keyword">new</span> <span class="hljs-constructor">XxlJobSpringExecutor()</span>; <br>xxlJobSpringExecutor.set<span class="hljs-constructor">AdminAddresses(<span class="hljs-params">adminAddresses</span>)</span>;    <br>xxlJobSpringExecutor.set<span class="hljs-constructor">Appname(<span class="hljs-params">appname</span>)</span>;    <br>xxlJobSpringExecutor.set<span class="hljs-constructor">Ip(<span class="hljs-params">ip</span>)</span>;    <br>xxlJobSpringExecutor.set<span class="hljs-constructor">Port(<span class="hljs-params">port</span>)</span>;    <br>xxlJobSpringExecutor.set<span class="hljs-constructor">AccessToken(<span class="hljs-params">accessToken</span>)</span>;    <br>xxlJobSpringExecutor.set<span class="hljs-constructor">LogPath(<span class="hljs-params">logPath</span>)</span>;    <br>xxlJobSpringExecutor.set<span class="hljs-constructor">LogRetentionDays(<span class="hljs-params">logRetentionDays</span>)</span>; <br>    <br>return xxlJobSpringExecutor;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="步骤四：部署执行器项目："><a href="#步骤四：部署执行器项目：" class="headerlink" title="步骤四：部署执行器项目："></a>步骤四：部署执行器项目：</h3><p>如果已经正确进行上述配置，可将执行器项目编译打部署，系统提供多种执行器Sample示例项目，选择其中一个即可，各自的部署方式如下。</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cos">xxl-<span class="hljs-keyword">job</span>-executor-sample-springboot：项目编译打包成springboot类型的可执行JAR包，命令启动即可；<br>xxl-<span class="hljs-keyword">job</span>-executor-sample-frameless：项目编译打包成JAR包，命令启动即可；<br></code></pre></td></tr></table></figure><p>至此“执行器”项目已经部署结束。</p><h3 id="步骤五：执行器集群（可选）："><a href="#步骤五：执行器集群（可选）：" class="headerlink" title="步骤五：执行器集群（可选）："></a>步骤五：执行器集群（可选）：</h3><p>执行器支持集群部署，提升调度系统可用性，同时提升任务处理能力。</p><p>执行器集群部署时，几点要求和建议：</p><ul><li>执行器回调地址（xxl.job.admin.addresses）需要保持一致；执行器根据该配置进行执行器自动注册等操作。</li><li>同一个执行器集群内AppName（xxl.job.executor.appname）需要保持一致；调度中心根据该配置动态发现不同集群的在线执行器列表。</li></ul><h2 id="2-5-开发第一个任务“Hello-World”"><a href="#2-5-开发第一个任务“Hello-World”" class="headerlink" title="2.5 开发第一个任务“Hello World”"></a>2.5 开发第一个任务“Hello World”</h2><p>本示例以新建一个 “GLUE模式(Java)” 运行模式的任务为例。更多有关任务的详细配置，请查看“章节三：任务详解”。<br>（ “GLUE模式(Java)”的执行代码托管到调度中心在线维护，相比“Bean模式任务”需要在执行器项目开发部署上线，更加简便轻量）</p><blockquote><p>前提：请确认“调度中心”和“执行器”项目已经成功部署并启动；</p></blockquote><h3 id="步骤一：新建任务："><a href="#步骤一：新建任务：" class="headerlink" title="步骤一：新建任务："></a>步骤一：新建任务：</h3><p>登录调度中心，点击下图所示“新建任务”按钮，新建示例任务。然后，参考下面截图中任务的参数配置，点击保存。</p><p><img src="/XXL-JOB/image-20221130133224429.png" alt="image-20221130133224429"></p><p><img src="/XXL-JOB/image-20221130133234268.png" alt="image-20221130133234268"></p><h3 id="步骤二：“GLUE模式-Java-”-任务开发："><a href="#步骤二：“GLUE模式-Java-”-任务开发：" class="headerlink" title="步骤二：“GLUE模式(Java)” 任务开发："></a>步骤二：“GLUE模式(Java)” 任务开发：</h3><p>请点击任务右侧 “GLUE” 按钮，进入 “GLUE编辑器开发界面” ，见下图。“GLUE模式(Java)” 运行模式的任务默认已经初始化了示例任务代码，即打印Hello World。<br>（ “GLUE模式(Java)” 运行模式的任务实际上是一段继承自IJobHandler的Java类代码，它在执行器项目中运行，可使用<a href="https://github.com/Resource">@Resource</a>&#x2F;<a href="https://github.com/Autowire">@Autowire</a>注入执行器里中的其他服务，详细介绍请查看第三章节）</p><p><img src="/XXL-JOB/image-20221130134312376.png" alt="image-20221130134312376"><img src="/XXL-JOB/image-20221130134320833.png" alt="image-20221130134320833"></p><h3 id="步骤三：触发执行："><a href="#步骤三：触发执行：" class="headerlink" title="步骤三：触发执行："></a>步骤三：触发执行：</h3><p>请点击任务右侧 “执行” 按钮，可手动触发一次任务执行（通常情况下，通过配置Cron表达式进行任务调度触发）。</p><h3 id="步骤四：查看日志："><a href="#步骤四：查看日志：" class="headerlink" title="步骤四：查看日志："></a>步骤四：查看日志：</h3><p>请点击任务右侧 “日志” 按钮，可前往任务日志界面查看任务日志。<br>在任务日志界面中，可查看该任务的历史调度记录以及每一次调度的任务调度信息、执行参数和执行信息。运行中的任务点击右侧的“执行日志”按钮，可进入日志控制台查看实时执行日志。</p><p><strong><img src="/XXL-JOB/image-20221130134415020.png" alt="image-20221130134415020"></strong></p><p>在日志控制台，可以Rolling方式实时查看任务在执行器一侧运行输出的日志信息，实时监控任务进度；</p><p><img src="/XXL-JOB/image-20221130134439008.png" alt="image-20221130134439008"></p><h1 id="三、任务详解"><a href="#三、任务详解" class="headerlink" title="三、任务详解"></a>三、任务详解</h1><h3 id="配置属性详细说明："><a href="#配置属性详细说明：" class="headerlink" title="配置属性详细说明："></a>配置属性详细说明：</h3><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext">基础配置：    <br><span class="hljs-bullet">-</span> <span class="hljs-string">执行器：任务的绑定的执行器，任务触发调度时将会自动发现注册成功的执行器, 实现任务自动发现功能; 另一方面也可以方便的进行任务分组。每个任务必须绑定一个执行器, 可在 &quot;执行器管理&quot; 进行设置;    </span><br><span class="hljs-bullet">-</span> <span class="hljs-string">任务描述：任务的描述信息，便于任务管理；    </span><br><span class="hljs-bullet">-</span> <span class="hljs-string">负责人：任务的负责人；    </span><br><span class="hljs-bullet">-</span> <span class="hljs-string">报警邮件：任务调度失败时邮件通知的邮箱地址，支持配置多邮箱地址，配置多个邮箱地址时用逗号分隔；</span><br><br>触发配置：    <br><span class="hljs-bullet">-</span> <span class="hljs-string">调度类型：        </span><br>无：该类型不会主动触发调度；        <br>CRON：该类型将会通过CRON，触发任务调度；        <br>固定速度：该类型将会以固定速度，触发任务调度；按照固定的间隔时间，周期性触发；        <br>固定延迟：该类型将会以固定延迟，触发任务调度；按照固定的延迟时间，从上次调度结束后开始计算延迟时间，到达延迟时间后触发下次调度；    <br><span class="hljs-bullet">-</span> <span class="hljs-string">CRON：触发任务执行的Cron表达式；    </span><br><span class="hljs-bullet">-</span> <span class="hljs-string">固定速度：固定速度的时间间隔，单位为秒；    </span><br><span class="hljs-bullet">-</span> <span class="hljs-string">固定延迟：固定延迟的时间间隔，单位为秒；</span><br><br>任务配置：    <br><span class="hljs-bullet">-</span> <span class="hljs-string">运行模式：        </span><br>BEAN模式：任务以JobHandler方式维护在执行器端；需要结合 &quot;JobHandler&quot; 属性匹配执行器中任务；        <br>GLUE模式(Java)：任务以源码方式维护在调度中心；该模式的任务实际上是一段继承自IJobHandler的Java类代码并 &quot;groovy&quot; 源码方式维护，它在执行器项目中运行，可使用@Resource/@Autowire注入执行器里中的其他服务；        <br>GLUE模式(Shell)：任务以源码方式维护在调度中心；该模式的任务实际上是一段 &quot;shell&quot; 脚本；        <br>GLUE模式(Python)：任务以源码方式维护在调度中心；该模式的任务实际上是一段 &quot;python&quot; 脚本；        <br>GLUE模式(PHP)：任务以源码方式维护在调度中心；该模式的任务实际上是一段 &quot;php&quot; 脚本；        <br>GLUE模式(NodeJS)：任务以源码方式维护在调度中心；该模式的任务实际上是一段 &quot;nodejs&quot; 脚本；        <br>GLUE模式(PowerShell)：任务以源码方式维护在调度中心；该模式的任务实际上是一段 &quot;PowerShell&quot; 脚本；    <br><span class="hljs-bullet">-</span> <span class="hljs-string">JobHandler：运行模式为 &quot;BEAN模式&quot; 时生效，对应执行器中新开发的JobHandler类“@JobHandler”注解自定义的value值；    </span><br><span class="hljs-bullet">-</span> <span class="hljs-string">执行参数：任务执行所需的参数；     </span><br><br>高级配置：    <br><span class="hljs-bullet">-</span> <span class="hljs-string">路由策略：当执行器集群部署时，提供丰富的路由策略，包括；        </span><br>FIRST（第一个）：固定选择第一个机器；        <br>LAST（最后一个）：固定选择最后一个机器；        <br>ROUND（轮询）：；        <br>RANDOM（随机）：随机选择在线的机器；        <br>CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。        <br>LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；        <br>LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；        <br>FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；        <br>BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；        <br>SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；    <br><span class="hljs-bullet">-</span> <span class="hljs-string">子任务：每个任务都拥有一个唯一的任务ID(任务ID可以从任务列表获取)，当本任务执行结束并且执行成功时，将会触发子任务ID所对应的任务的一次主动调度。    </span><br><span class="hljs-bullet">-</span> <span class="hljs-string">调度过期策略：        </span><br><span class="hljs-bullet">-</span> <span class="hljs-string">忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；        </span><br><span class="hljs-bullet">-</span> <span class="hljs-string">立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；    </span><br><span class="hljs-bullet">-</span> <span class="hljs-string">阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；        </span><br>单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；        <br>丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；        <br>覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；    <br><span class="hljs-bullet">-</span> <span class="hljs-string">任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；    </span><br><span class="hljs-bullet">-</span> <span class="hljs-string">失败重试次数；支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</span><br></code></pre></td></tr></table></figure><h3 id="3-1-BEAN模式（类形式）"><a href="#3-1-BEAN模式（类形式）" class="headerlink" title="3.1 BEAN模式（类形式）"></a>3.1 BEAN模式（类形式）</h3><p>Bean模式任务，支持基于类的开发方式，每个任务对应一个Java类。</p><ul><li>优点：不限制项目环境，兼容性好。即使是无框架项目，如main方法直接启动的项目也可以提供支持，可以参考示例项目 “xxl-job-executor-sample-frameless”；</li><li>缺点：<ul><li>每个任务需要占用一个Java类，造成类的浪费；</li><li>不支持自动扫描任务并注入到执行器容器，需要手动注入。</li></ul></li></ul><h4 id="步骤一：执行器项目中，开发Job类："><a href="#步骤一：执行器项目中，开发Job类：" class="headerlink" title="步骤一：执行器项目中，开发Job类："></a>步骤一：执行器项目中，开发Job类：</h4><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><span class="hljs-number">1</span>、开发一个继承自<span class="hljs-string">&quot;com.xxl.job.core.handler.IJobHandler&quot;</span>的JobHandler类，实现其中任务方法。<br><span class="hljs-number">2</span>、手动通过如下方式注入到执行器容器。<br>```<br>XxlJobExecutor.registJobHandler(<span class="hljs-string">&quot;demoJobHandler&quot;</span>, <span class="hljs-keyword">new</span> DemoJobHandler())<span class="hljs-comment">;</span><br>```<br></code></pre></td></tr></table></figure><h4 id="步骤二：调度中心，新建调度任务"><a href="#步骤二：调度中心，新建调度任务" class="headerlink" title="步骤二：调度中心，新建调度任务"></a>步骤二：调度中心，新建调度任务</h4><p>后续步骤和 “3.2 BEAN模式（方法形式）”一致，可以前往参考。</p><h3 id="3-2-BEAN模式（方法形式）"><a href="#3-2-BEAN模式（方法形式）" class="headerlink" title="3.2 BEAN模式（方法形式）"></a>3.2 BEAN模式（方法形式）</h3><p>Bean模式任务，支持基于方法的开发方式，每个任务对应一个方法。</p><ul><li>优点：<ul><li>每个任务只需要开发一个方法，并添加”<a href="https://github.com/XxlJob">@XxlJob</a>”注解即可，更加方便、快速。</li><li>支持自动扫描任务并注入到执行器容器。</li></ul></li><li>缺点：要求Spring容器环境；</li></ul><blockquote><p>基于方法开发的任务，底层会生成JobHandler代理，和基于类的方式一样，任务也会以JobHandler的形式存在于执行器任务容器中。</p></blockquote><h4 id="步骤一：执行器项目中，开发Job方法："><a href="#步骤一：执行器项目中，开发Job方法：" class="headerlink" title="步骤一：执行器项目中，开发Job方法："></a>步骤一：执行器项目中，开发Job方法：</h4><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cos"><span class="hljs-number">1</span>、任务开发：在Spring Bean实例中，开发<span class="hljs-keyword">Job</span>方法；<br><span class="hljs-number">2</span>、注解配置：为<span class="hljs-keyword">Job</span>方法添加注解 <span class="hljs-string">&quot;@XxlJob(value=&quot;</span>自定义jobhandler名称<span class="hljs-string">&quot;, init = &quot;</span>JobHandler初始化方法<span class="hljs-string">&quot;, destroy = &quot;</span>JobHandler销毁方法<span class="hljs-string">&quot;)&quot;</span>，注解value值对应的是调度中心新建任务的JobHandler属性的值。<br><span class="hljs-number">3</span>、执行日志：需要通过 <span class="hljs-string">&quot;XxlJobHelper.log&quot;</span> 打印执行日志；<br><span class="hljs-number">4</span>、任务结果：默认任务结果为 <span class="hljs-string">&quot;成功&quot;</span> 状态，不需要主动设置；如有诉求，比如设置任务结果为失败，可以通过 <span class="hljs-string">&quot;XxlJobHelper.handleFail/handleSuccess&quot;</span> 自主设置任务结果；<br></code></pre></td></tr></table></figure><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">// 可参考Sample示例执行器中的 &quot;com.xxl.job.executor.service.jobhandler.SampleXxlJob&quot; ，如下：@XxlJob(&quot;demoJobHandler&quot;)<br><span class="hljs-built_in">public</span> <span class="hljs-type">void</span> demoJobHandler() throws <span class="hljs-keyword">Exception</span> &#123;    <br>XxlJobHelper.log(&quot;XXL-JOB, Hello World.&quot;);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="步骤二：调度中心，新建调度任务-1"><a href="#步骤二：调度中心，新建调度任务-1" class="headerlink" title="步骤二：调度中心，新建调度任务"></a>步骤二：调度中心，新建调度任务</h4><p>参考上文“配置属性详细说明”对新建的任务进行参数配置，运行模式选中 “BEAN模式”，JobHandler属性填写任务注解“<a href="https://github.com/XxlJob">@XxlJob</a>”中定义的值；</p><p><img src="/XXL-JOB/image-20221130135053370.png" alt="image-20221130135053370"></p><h4 id="原生内置Bean模式任务"><a href="#原生内置Bean模式任务" class="headerlink" title="原生内置Bean模式任务"></a>原生内置Bean模式任务</h4><p>为方便用户参考与快速实用，示例执行器内原生提供多个Bean模式任务Handler，可以直接配置实用，如下：</p><ul><li><p>demoJobHandler：简单示例任务，任务内部模拟耗时任务逻辑，用户可在线体验Rolling Log等功能；</p></li><li><p>shardingJobHandler：分片示例任务，任务内部模拟处理分片参数，可参考熟悉分片任务；</p></li><li><p>httpJobHandler：通用HTTP任务Handler；业务方只需要提供HTTP链接等信息即可，不限制语言、平台。示例任务入参如下：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">url: <span class="hljs-keyword">http</span>://www.xxx.com  method: <span class="hljs-built_in">get</span> 或 <span class="hljs-built_in">post</span>  data: <span class="hljs-built_in">post</span>-data<br></code></pre></td></tr></table></figure></li><li><p>commandJobHandler：通用命令行任务Handler；业务方只需要提供命令行即可；如 “pwd”命令；</p></li></ul><h3 id="3-3-GLUE模式-Java"><a href="#3-3-GLUE模式-Java" class="headerlink" title="3.3 GLUE模式(Java)"></a>3.3 GLUE模式(Java)</h3><p>任务以源码方式维护在调度中心，支持通过Web IDE在线更新，实时编译和生效，因此不需要指定JobHandler。开发流程如下：</p><h4 id="步骤一：调度中心，新建调度任务："><a href="#步骤一：调度中心，新建调度任务：" class="headerlink" title="步骤一：调度中心，新建调度任务："></a>步骤一：调度中心，新建调度任务：</h4><p>参考上文“配置属性详细说明”对新建的任务进行参数配置，运行模式选中 “GLUE模式(Java)”；</p><p><img src="/XXL-JOB/image-20221130135153730.png" alt="image-20221130135153730"></p><h4 id="步骤二：开发任务代码："><a href="#步骤二：开发任务代码：" class="headerlink" title="步骤二：开发任务代码："></a>步骤二：开发任务代码：</h4><p>选中指定任务，点击该任务右侧“GLUE”按钮，将会前往GLUE任务的Web IDE界面，在该界面支持对任务代码进行开发（也可以在IDE中开发完成后，复制粘贴到编辑中）。</p><p>版本回溯功能（支持30个版本的版本回溯）：在GLUE任务的Web IDE界面，选择右上角下拉框“版本回溯”，会列出该GLUE的更新历史，选择相应版本即可显示该版本代码，保存后GLUE代码即回退到对应的历史版本</p><p><img src="/XXL-JOB/image-20221130135210550.png" alt="image-20221130135210550"></p><h3 id="3-4-GLUE模式-Shell"><a href="#3-4-GLUE模式-Shell" class="headerlink" title="3.4 GLUE模式(Shell)"></a>3.4 GLUE模式(Shell)</h3><h4 id="步骤一：调度中心，新建调度任务"><a href="#步骤一：调度中心，新建调度任务" class="headerlink" title="步骤一：调度中心，新建调度任务"></a>步骤一：调度中心，新建调度任务</h4><p>参考上文“配置属性详细说明”对新建的任务进行参数配置，运行模式选中 “GLUE模式(Shell)”；</p><h4 id="步骤二：开发任务代码：-1"><a href="#步骤二：开发任务代码：-1" class="headerlink" title="步骤二：开发任务代码："></a>步骤二：开发任务代码：</h4><p>选中指定任务，点击该任务右侧“GLUE”按钮，将会前往GLUE任务的Web IDE界面，在该界面支持对任务代码进行开发（也可以在IDE中开发完成后，复制粘贴到编辑中）。</p><p>该模式的任务实际上是一段 “shell” 脚本；</p><p><img src="/XXL-JOB/image-20221130135226920.png" alt="image-20221130135226920"></p><h3 id="3-4-GLUE模式-Python"><a href="#3-4-GLUE模式-Python" class="headerlink" title="3.4 GLUE模式(Python)"></a>3.4 GLUE模式(Python)</h3><h4 id="步骤一：调度中心，新建调度任务-1"><a href="#步骤一：调度中心，新建调度任务-1" class="headerlink" title="步骤一：调度中心，新建调度任务"></a>步骤一：调度中心，新建调度任务</h4><p>参考上文“配置属性详细说明”对新建的任务进行参数配置，运行模式选中 “GLUE模式(Python)”；</p><h4 id="步骤二：开发任务代码：-2"><a href="#步骤二：开发任务代码：-2" class="headerlink" title="步骤二：开发任务代码："></a>步骤二：开发任务代码：</h4><p>选中指定任务，点击该任务右侧“GLUE”按钮，将会前往GLUE任务的Web IDE界面，在该界面支持对任务代码进行开发（也可以在IDE中开发完成后，复制粘贴到编辑中）。</p><p>该模式的任务实际上是一段 “python” 脚本；</p><p><img src="/XXL-JOB/image-20221130135243634.png" alt="image-20221130135243634"></p><h3 id="3-5-GLUE模式-NodeJS"><a href="#3-5-GLUE模式-NodeJS" class="headerlink" title="3.5 GLUE模式(NodeJS)"></a>3.5 GLUE模式(NodeJS)</h3><h4 id="步骤一：调度中心，新建调度任务-2"><a href="#步骤一：调度中心，新建调度任务-2" class="headerlink" title="步骤一：调度中心，新建调度任务"></a>步骤一：调度中心，新建调度任务</h4><p>参考上文“配置属性详细说明”对新建的任务进行参数配置，运行模式选中 “GLUE模式(NodeJS)”；</p><h4 id="步骤二：开发任务代码：-3"><a href="#步骤二：开发任务代码：-3" class="headerlink" title="步骤二：开发任务代码："></a>步骤二：开发任务代码：</h4><p>选中指定任务，点击该任务右侧“GLUE”按钮，将会前往GLUE任务的Web IDE界面，在该界面支持对任务代码进行开发（也可以在IDE中开发完成后，复制粘贴到编辑中）。</p><p>该模式的任务实际上是一段 “nodeJS” 脚本；</p><h3 id="3-6-GLUE模式-PHP"><a href="#3-6-GLUE模式-PHP" class="headerlink" title="3.6 GLUE模式(PHP)"></a>3.6 GLUE模式(PHP)</h3><p>同上</p><h3 id="3-7-GLUE模式-PowerShell"><a href="#3-7-GLUE模式-PowerShell" class="headerlink" title="3.7 GLUE模式(PowerShell)"></a>3.7 GLUE模式(PowerShell)</h3><p>同上</p><h2 id="四、操作指南"><a href="#四、操作指南" class="headerlink" title="四、操作指南"></a>四、操作指南</h2><h3 id="4-1-配置执行器"><a href="#4-1-配置执行器" class="headerlink" title="4.1 配置执行器"></a>4.1 配置执行器</h3><p>点击进入”执行器管理”界面, 如下图:</p><p><img src="/XXL-JOB/image-20221130135353613.png" alt="image-20221130135353613"></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-number">1</span>、<span class="hljs-string">&quot;调度中心OnLine:&quot;</span>右侧显示在线的<span class="hljs-string">&quot;调度中心&quot;</span>列表, 任务执行结束后, 将会以failover的模式进行回调调度中心通知执行结果, 避免回调的单点风险;<br><span class="hljs-number">2</span>、<span class="hljs-string">&quot;执行器列表&quot;</span> 中显示在线的执行器列表, 可通过<span class="hljs-string">&quot;OnLine 机器&quot;</span>查看对应执行器的集群机器。<br></code></pre></td></tr></table></figure><p>点击按钮 “+新增执行器” 弹框如下图, 可新增执行器配置:</p><p><img src="/XXL-JOB/image-20221130135422797.png" alt="image-20221130135422797"></p><p>执行器属性说明</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">AppName: 是每个执行器集群的唯一标示AppName, 执行器会周期性以AppName为对象进行自动注册。可通过该配置自动发现注册成功的执行器, 供任务调度时使用;</span><br><span class="hljs-section">名称: 执行器的名称, 因为AppName限制字母数字等组成,可读性不强, 名称为了提高执行器的可读性;</span><br><span class="hljs-section">排序: 执行器的排序, 系统中需要执行器的地方,如任务新增, 将会按照该排序读取可用的执行器列表;</span><br>注册方式：调度中心获取执行器地址的方式；<br>自动注册：执行器自动进行执行器注册，调度中心通过底层注册表可以动态发现执行器机器地址；<br>    手动录入：人工手动录入执行器的地址信息，多地址逗号分隔，供调度中心使用；<br>机器地址：<span class="hljs-string">&quot;注册方式&quot;</span>为<span class="hljs-string">&quot;手动录入&quot;</span>时有效，支持人工维护执行器的地址信息；<br></code></pre></td></tr></table></figure><h3 id="4-2-新建任务"><a href="#4-2-新建任务" class="headerlink" title="4.2 新建任务"></a>4.2 新建任务</h3><p>进入任务管理界面，点击“新增任务”按钮，在弹出的“新增任务”界面配置任务属性后保存即可。详情页参考章节 “三、任务详解”。</p><h3 id="4-3-编辑任务"><a href="#4-3-编辑任务" class="headerlink" title="4.3 编辑任务"></a>4.3 编辑任务</h3><p>进入任务管理界面，选中指定任务。点击该任务右侧“编辑”按钮，在弹出的“编辑任务”界面更新任务属性后保存即可，可以修改设置的任务属性信息：</p><h3 id="4-4-编辑GLUE代码"><a href="#4-4-编辑GLUE代码" class="headerlink" title="4.4 编辑GLUE代码"></a>4.4 编辑GLUE代码</h3><p>该操作仅针对GLUE任务。</p><p>选中指定任务，点击该任务右侧“GLUE”按钮，将会前往GLUE任务的Web IDE界面，在该界面支持对任务代码进行开发。可参考章节 “3.3 GLUE模式(Java)”。</p><h3 id="4-5-启动-x2F-停止任务"><a href="#4-5-启动-x2F-停止任务" class="headerlink" title="4.5 启动&#x2F;停止任务"></a>4.5 启动&#x2F;停止任务</h3><p>可对任务进行“启动”和“停止”操作。<br>需要注意的是，此处的启动&#x2F;停止仅针对任务的后续调度触发行为，不会影响到已经触发的调度任务，如需终止已经触发的调度任务，可查看“4.9 终止运行中的任务”</p><p><img src="/XXL-JOB/image-20221130135815134.png" alt="image-20221130135815134"></p><h3 id="4-6-手动触发一次调度"><a href="#4-6-手动触发一次调度" class="headerlink" title="4.6 手动触发一次调度"></a>4.6 手动触发一次调度</h3><p>点击“执行”按钮，可手动触发一次任务调度，不影响原有调度规则。</p><p><img src="/XXL-JOB/image-20221130135838852.png" alt="image-20221130135838852"></p><h3 id="4-7-查看调度日志"><a href="#4-7-查看调度日志" class="headerlink" title="4.7 查看调度日志"></a>4.7 查看调度日志</h3><p>点击“日志”按钮，可以查看任务历史调度日志。在历史调入日志界面可查看每次任务调度的调度结果、执行结果等，点击“执行日志”按钮可查看执行器完整日志。</p><p><img src="/XXL-JOB/image-20221130135852061.png" alt="image-20221130135852061"></p><p><img src="/XXL-JOB/image-20221130135909121.png" alt="image-20221130135909121"></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs 1c">调度时间：<span class="hljs-string">&quot;调度中心&quot;</span>触发本次调度并向<span class="hljs-string">&quot;执行器&quot;</span>发送任务执行信号的时间；<br>调度结果：<span class="hljs-string">&quot;调度中心&quot;</span>触发本次调度的结果，<span class="hljs-number">200</span>表示成功，<span class="hljs-number">500</span>或其他表示失败；<br>调度备注：<span class="hljs-string">&quot;调度中心&quot;</span>触发本次调度的日志信息；<br>执行器地址：本次任务执行的机器地址<br>运行模式：触发调度时任务的运行模式，运行模式可参考章节 <span class="hljs-string">&quot;三、任务详解&quot;</span>；<br>任务参数：本地任务执行的入参<br>执行时间：<span class="hljs-string">&quot;执行器&quot;</span>中本次任务执行结束后回调的时间；<br>执行结果：<span class="hljs-string">&quot;执行器&quot;</span>中本次任务执行的结果，<span class="hljs-number">200</span>表示成功，<span class="hljs-number">500</span>或其他表示失败；<br>执行备注：<span class="hljs-string">&quot;执行器&quot;</span>中本次任务执行的日志信息；<br>操作：<br>    <span class="hljs-string">&quot;执行日志&quot;</span>按钮：点击可查看本地任务执行的详细日志信息；详见“<span class="hljs-number">4.8</span> 查看执行日志”；<br>    <span class="hljs-string">&quot;终止任务&quot;</span>按钮：点击可终止本地调度对应执行器上本任务的执行线程，包括未执行的阻塞任务一并被终止；<br></code></pre></td></tr></table></figure><h3 id="4-8-查看执行日志"><a href="#4-8-查看执行日志" class="headerlink" title="4.8 查看执行日志"></a>4.8 查看执行日志</h3><p>点击执行日志右侧的 “执行日志” 按钮，可跳转至执行日志界面，可以查看业务代码中打印的完整日志，如下图；</p><p><img src="/XXL-JOB/image-20221130140003583.png" alt="image-20221130140003583"></p><h3 id="4-9-终止运行中的任务"><a href="#4-9-终止运行中的任务" class="headerlink" title="4.9 终止运行中的任务"></a>4.9 终止运行中的任务</h3><p>仅针对执行中的任务。<br>在任务日志界面，点击右侧的“终止任务”按钮，将会向本次任务对应的执行器发送任务终止请求，将会终止掉本次任务，同时会清空掉整个任务执行队列。</p><p><img src="/XXL-JOB/image-20221130140114835.png" alt="image-20221130140114835"></p><p>任务终止时通过 “interrupt” 执行线程的方式实现, 将会触发 “InterruptedException” 异常。因此如果JobHandler内部catch到了该异常并消化掉的话, 任务终止功能将不可用。</p><p>因此, 如果遇到上述任务终止不可用的情况, 需要在JobHandler中应该针对 “InterruptedException” 异常进行特殊处理 (向上抛出) , 正确逻辑如下:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">try</span>&#123;    <br><span class="hljs-comment">// do something</span><br>&#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;    <br><span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> InterruptedException) &#123;<br>    <span class="hljs-keyword">throw</span> e;<br>    &#125;    <br>    logger.<span class="hljs-title function_ invoke__">warn</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, e);<br>&#125;<br></code></pre></td></tr></table></figure><p>而且，在JobHandler中开启子线程时，子线程也不可catch处理”InterruptedException”，应该主动向上抛出。</p><p>任务终止时会执行对应JobHandler的”destroy()”方法，可以借助该方法处理一些资源回收的逻辑。</p><h3 id="4-10-删除执行日志"><a href="#4-10-删除执行日志" class="headerlink" title="4.10 删除执行日志"></a>4.10 删除执行日志</h3><p>在任务日志界面，选中执行器和任务之后，点击右侧的”删除”按钮将会出现”日志清理”弹框，弹框中支持选择不同类型的日志清理策略，选中后点击”确定”按钮即可进行日志清理操作；</p><p><img src="/XXL-JOB/image-20221130140216563.png" alt="image-20221130140216563"></p><p><img src="/XXL-JOB/image-20221130140227816.png" alt="image-20221130140227816"></p><h3 id="4-11-删除任务"><a href="#4-11-删除任务" class="headerlink" title="4.11 删除任务"></a>4.11 删除任务</h3><p>点击删除按钮，可以删除对应任务。</p><p><img src="/XXL-JOB/image-20221130140239533.png" alt="image-20221130140239533"></p><h3 id="4-12-用户管理"><a href="#4-12-用户管理" class="headerlink" title="4.12 用户管理"></a>4.12 用户管理</h3><p>进入 “用户管理” 界面，可查看和管理用户信息；</p><p>目前用户分为两种角色：</p><ul><li>管理员：拥有全量权限，支持在线管理用户信息，为用户分配权限，权限分配粒度为执行器；</li><li>普通用户：仅拥有被分配权限的执行器，及相关任务的操作权限；</li></ul><p><img src="/XXL-JOB/image-20221130140252659.png" alt="image-20221130140252659"></p><p><img src="/XXL-JOB/image-20221130140304820.png" alt="image-20221130140304820"></p><h2 id="五、总体设计"><a href="#五、总体设计" class="headerlink" title="五、总体设计"></a>五、总体设计</h2><h3 id="5-1-源码目录介绍"><a href="#5-1-源码目录介绍" class="headerlink" title="5.1 源码目录介绍"></a>5.1 源码目录介绍</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-bullet">- </span>/doc :文档资料<br><span class="hljs-bullet">- </span>/db :“调度数据库”建表脚本<br><span class="hljs-bullet">- </span>/xxl-job-admin :调度中心，项目源码<br><span class="hljs-bullet">- </span>/xxl-job-core :公共Jar依赖<br><span class="hljs-bullet">- </span>/xxl-job-executor-samples :执行器，Sample示例项目（大家可以在该项目上进行开发，也可以将现有项目改造生成执行器项目）<br></code></pre></td></tr></table></figure><h3 id="5-2-“调度数据库”配置"><a href="#5-2-“调度数据库”配置" class="headerlink" title="5.2 “调度数据库”配置"></a>5.2 “调度数据库”配置</h3><p>XXL-JOB调度模块基于自研调度组件并支持集群部署，调度数据库表说明如下：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">- xxl_job_lock：任务调度锁表；</span><br><span class="hljs-deletion">- xxl_job_group：执行器信息表，维护任务执行器信息；</span><br><span class="hljs-deletion">- xxl_job_info：调度扩展信息表： 用于保存XXL-JOB调度任务的扩展信息，如任务分组、任务名、机器地址、执行器、执行入参和报警邮件等等；</span><br><span class="hljs-deletion">- xxl_job_log：调度日志表： 用于保存XXL-JOB任务调度的历史信息，如调度结果、执行结果、调度入参、调度机器和执行器等等；</span><br><span class="hljs-deletion">- xxl_job_log_report：调度日志报表：用户存储XXL-JOB任务调度日志的报表，调度中心报表功能页面会用到；</span><br><span class="hljs-deletion">- xxl_job_logglue：任务GLUE日志：用于保存GLUE更新历史，用于支持GLUE的版本回溯功能；</span><br><span class="hljs-deletion">- xxl_job_registry：执行器注册表，维护在线的执行器和调度中心机器地址信息；</span><br><span class="hljs-deletion">- xxl_job_user：系统用户表；</span><br></code></pre></td></tr></table></figure><h3 id="5-3-架构设计"><a href="#5-3-架构设计" class="headerlink" title="5.3 架构设计"></a>5.3 架构设计</h3><h4 id="5-3-1-设计思想"><a href="#5-3-1-设计思想" class="headerlink" title="5.3.1 设计思想"></a>5.3.1 设计思想</h4><p>将调度行为抽象形成“调度中心”公共平台，而平台自身并不承担业务逻辑，“调度中心”负责发起调度请求。</p><p>将任务抽象成分散的JobHandler，交由“执行器”统一管理，“执行器”负责接收调度请求并执行对应的JobHandler中业务逻辑。</p><p>因此，“调度”和“任务”两部分可以相互解耦，提高系统整体稳定性和扩展性；</p><h4 id="5-3-2-系统组成"><a href="#5-3-2-系统组成" class="headerlink" title="5.3.2 系统组成"></a>5.3.2 系统组成</h4><ul><li><strong>调度模块（调度中心）</strong>：<br>负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码。调度系统与任务解耦，提高了系统可用性和稳定性，同时调度系统性能不再受限于任务模块；<br>支持可视化、简单且动态的管理调度信息，包括任务新建，更新，删除，GLUE开发和任务报警等，所有上述操作都会实时生效，同时支持监控调度结果以及执行日志，支持执行器Failover。</li><li><strong>执行模块（执行器）</strong>：<br>负责接收调度请求并执行任务逻辑。任务模块专注于任务的执行等操作，开发和维护更加简单和高效；<br>接收“调度中心”的执行请求、终止请求和日志请求等。</li></ul><h4 id="5-3-3-架构图"><a href="#5-3-3-架构图" class="headerlink" title="5.3.3 架构图"></a>5.3.3 架构图</h4><p><img src="/XXL-JOB/image-20221130140454104.png" alt="XXL-JOB架构图 v2.1.0"></p><h3 id="5-4-调度模块剖析"><a href="#5-4-调度模块剖析" class="headerlink" title="5.4 调度模块剖析"></a>5.4 调度模块剖析</h3><h4 id="5-4-1-quartz的不足"><a href="#5-4-1-quartz的不足" class="headerlink" title="5.4.1 quartz的不足"></a>5.4.1 quartz的不足</h4><p>Quartz作为开源作业调度中的佼佼者，是作业调度的首选。但是集群环境中Quartz采用API的方式对任务进行管理，从而可以避免上述问题，但是同样存在以下问题：</p><ul><li>问题一：调用API的的方式操作任务，不人性化；</li><li>问题二：需要持久化业务QuartzJobBean到底层数据表中，系统侵入性相当严重。</li><li>问题三：调度逻辑和QuartzJobBean耦合在同一个项目中，这将导致一个问题，在调度任务数量逐渐增多，同时调度任务逻辑逐渐加重的情况下，此时调度系统的性能将大大受限于业务；</li><li>问题四：quartz底层以“抢占式”获取DB锁并由抢占成功节点负责运行任务，会导致节点负载悬殊非常大；而XXL-JOB通过执行器实现“协同分配式”运行任务，充分发挥集群优势，负载各节点均衡。</li></ul><p>XXL-JOB弥补了quartz的上述不足之处。</p><h4 id="5-4-2-自研调度模块"><a href="#5-4-2-自研调度模块" class="headerlink" title="5.4.2 自研调度模块"></a>5.4.2 自研调度模块</h4><p>XXL-JOB最终选择自研调度组件（早期调度组件基于Quartz）；一方面是为了精简系统降低冗余依赖，另一方面是为了提供系统的可控度与稳定性；</p><p>XXL-JOB中“调度模块”和“任务模块”完全解耦，调度模块进行任务调度时，将会解析不同的任务参数发起远程调用，调用各自的远程执行器服务。这种调用模型类似RPC调用，调度中心提供调用代理的功能，而执行器提供远程服务的功能。</p><h4 id="5-4-3-调度中心HA（集群）"><a href="#5-4-3-调度中心HA（集群）" class="headerlink" title="5.4.3 调度中心HA（集群）"></a>5.4.3 调度中心HA（集群）</h4><p>基于数据库的集群方案，数据库选用Mysql；集群分布式并发环境中进行定时任务调度时，会在各个节点会上报任务，存到数据库中，执行时会从数据库中取出触发器来执行，如果触发器的名称和执行时间相同，则只有一个节点去执行此任务。</p><h4 id="5-4-4-调度线程池"><a href="#5-4-4-调度线程池" class="headerlink" title="5.4.4 调度线程池"></a>5.4.4 调度线程池</h4><p>调度采用线程池方式实现，避免单线程因阻塞而引起任务调度延迟。</p><h4 id="5-4-5-并行调度"><a href="#5-4-5-并行调度" class="headerlink" title="5.4.5 并行调度"></a>5.4.5 并行调度</h4><p>XXL-JOB调度模块默认采用并行机制，在多线程调度的情况下，调度模块被阻塞的几率很低，大大提高了调度系统的承载量。</p><p>XXL-JOB的不同任务之间并行调度、并行执行。<br>XXL-JOB的单个任务，针对多个执行器是并行运行的，针对单个执行器是串行执行的。同时支持任务终止。</p><h4 id="5-4-6-过期处理策略"><a href="#5-4-6-过期处理策略" class="headerlink" title="5.4.6 过期处理策略"></a>5.4.6 过期处理策略</h4><p>任务调度错过触发时间时的处理策略：</p><ul><li>可能原因：服务重启；调度线程被阻塞，线程被耗尽；上次调度持续阻塞，下次调度被错过；</li><li>处理策略：<ul><li>过期超5s：本次忽略，当前时间开始计算下次触发时间</li><li>过期5s内：立即触发一次，当前时间开始计算下次触发时间</li></ul></li></ul><h4 id="5-4-7-日志回调服务"><a href="#5-4-7-日志回调服务" class="headerlink" title="5.4.7 日志回调服务"></a>5.4.7 日志回调服务</h4><p>调度模块的“调度中心”作为Web服务部署时，一方面承担调度中心功能，另一方面也为执行器提供API服务。</p><p>调度中心提供的”日志回调服务API服务”代码位置如下：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">xxl-job-admin<span class="hljs-selector-id">#com</span><span class="hljs-selector-class">.xxl</span><span class="hljs-selector-class">.job</span><span class="hljs-selector-class">.admin</span><span class="hljs-selector-class">.controller</span><span class="hljs-selector-class">.JobApiController</span>.callback<br></code></pre></td></tr></table></figure><p>“执行器”在接收到任务执行请求后，执行任务，在执行结束之后会将执行结果回调通知“调度中心”：</p><h4 id="5-4-8-任务HA（Failover）"><a href="#5-4-8-任务HA（Failover）" class="headerlink" title="5.4.8 任务HA（Failover）"></a>5.4.8 任务HA（Failover）</h4><p>执行器如若集群部署，调度中心将会感知到在线的所有执行器，如“127.0.0.1:9997, 127.0.0.1:9998, 127.0.0.1:9999”。</p><p>当任务”路由策略”选择”故障转移(FAILOVER)”时，当调度中心每次发起调度请求时，会按照顺序对执行器发出心跳检测请求，第一个检测为存活状态的执行器将会被选定并发送调度请求。</p><p>调度成功后，可在日志监控界面查看“调度备注”，如下；</p><p><img src="/XXL-JOB/img_jrdI.png" alt="输入图片说明"></p><p>调度备注”可以看出本地调度运行轨迹，执行器的”注册方式”、”地址列表”和任务的”路由策略”。”故障转移(FAILOVER)”路由策略下，调度中心首先对第一个地址进行心跳检测，心跳失败因此自动跳过，第二个依然心跳检测失败……<br>直至心跳检测第三个地址“127.0.0.1:9999”成功，选定为“目标执行器”；然后对“目标执行器”发送调度请求，调度流程结束，等待执行器回调执行结果。</p><h4 id="5-4-9-调度日志"><a href="#5-4-9-调度日志" class="headerlink" title="5.4.9 调度日志"></a>5.4.9 调度日志</h4><p>调度中心每次进行任务调度，都会记录一条任务日志，任务日志主要包括以下三部分内容：</p><ul><li>任务信息：包括“执行器地址”、“JobHandler”和“执行参数”等属性，点击任务ID按钮可查看，根据这些参数，可以精确的定位任务执行的具体机器和任务代码；</li><li>调度信息：包括“调度时间”、“调度结果”和“调度日志”等，根据这些参数，可以了解“调度中心”发起调度请求时具体情况。</li><li>执行信息：包括“执行时间”、“执行结果”和“执行日志”等，根据这些参数，可以了解在“执行器”端任务执行的具体情况；</li></ul><p>调度日志，针对单次调度，属性说明如下：</p><ul><li>执行器地址：任务执行的机器地址；</li><li>JobHandler：Bean模式表示任务执行的JobHandler名称；</li><li>任务参数：任务执行的入参；</li><li>调度时间：调度中心，发起调度的时间；</li><li>调度结果：调度中心，发起调度的结果，SUCCESS或FAIL；</li><li>调度备注：调度中心，发起调度的备注信息，如地址心跳检测日志等；</li><li>执行时间：执行器，任务执行结束后回调的时间；</li><li>执行结果：执行器，任务执行的结果，SUCCESS或FAIL；</li><li>执行备注：执行器，任务执行的备注信息，如异常日志等；</li><li>执行日志：任务执行过程中，业务代码中打印的完整执行日志，见“4.8 查看执行日志”；</li></ul><h4 id="5-4-10-任务依赖"><a href="#5-4-10-任务依赖" class="headerlink" title="5.4.10 任务依赖"></a>5.4.10 任务依赖</h4><p>原理：XXL-JOB中每个任务都对应有一个任务ID，同时，每个任务支持设置属性“子任务ID”，因此，通过“任务ID”可以匹配任务依赖关系。</p><p>当父任务执行结束并且执行成功时，将会根据“子任务ID”匹配子任务依赖，如果匹配到子任务，将会主动触发一次子任务的执行。</p><p>在任务日志界面，点击任务的“执行备注”的“查看”按钮，可以看到匹配子任务以及触发子任务执行的日志信息，如无信息则表示未触发子任务执行，可参考下图。</p><p><img src="/XXL-JOB/image-20221130140720853.png" alt="image-20221130140720853"></p><p><img src="/XXL-JOB/image-20221130140730088.png" alt="image-20221130140730088"></p><h4 id="5-4-11-全异步化-amp-轻量级"><a href="#5-4-11-全异步化-amp-轻量级" class="headerlink" title="5.4.11 全异步化 &amp; 轻量级"></a>5.4.11 全异步化 &amp; 轻量级</h4><ul><li>全异步化设计：XXL-JOB系统中业务逻辑在远程执行器执行，触发流程全异步化设计。相比直接在调度中心内部执行业务逻辑，极大的降低了调度线程占用时间；<ul><li>异步调度：调度中心每次任务触发时仅发送一次调度请求，该调度请求首先推送“异步调度队列”，然后异步推送给远程执行器</li><li>异步执行：执行器会将请求存入“异步执行队列”并且立即响应调度中心，异步运行。</li></ul></li><li>轻量级设计：XXL-JOB调度中心中每个JOB逻辑非常 “轻”，在全异步化的基础上，单个JOB一次运行平均耗时基本在 “10ms” 之内（基本为一次请求的网络开销）；因此，可以保证使用有限的线程支撑大量的JOB并发运行；</li></ul><p>得益于上述两点优化，理论上默认配置下的调度中心，单机能够支撑 5000 任务并发运行稳定运行；</p><p>实际场景中，由于调度中心与执行器网络ping延迟不同、DB读写耗时不同、任务调度密集程度不同，会导致任务量上限会上下波动。</p><p>如若需要支撑更多的任务量，可以通过 “调大调度线程数” 、”降低调度中心与执行器ping延迟” 和 “提升机器配置” 几种方式优化。</p><h4 id="5-4-12-均衡调度"><a href="#5-4-12-均衡调度" class="headerlink" title="5.4.12 均衡调度"></a>5.4.12 均衡调度</h4><p>调度中心在集群部署时会自动进行任务平均分配，触发组件每次获取与线程池数量（调度中心支持自定义调度线程池大小）相关数量的任务，避免大量任务集中在单个调度中心集群节点；</p><h3 id="5-5-任务-“运行模式”-剖析"><a href="#5-5-任务-“运行模式”-剖析" class="headerlink" title="5.5 任务 “运行模式” 剖析"></a>5.5 任务 “运行模式” 剖析</h3><h4 id="5-5-1-“Bean模式”-任务"><a href="#5-5-1-“Bean模式”-任务" class="headerlink" title="5.5.1 “Bean模式” 任务"></a>5.5.1 “Bean模式” 任务</h4><p>开发步骤：可参考 “章节三” ；<br>原理：每个Bean模式任务都是一个Spring的Bean类实例，它被维护在“执行器”项目的Spring容器中。任务类需要加“<a href="https://github.com/JobHandler">@JobHandler</a>(value&#x3D;”名称”)”注解，因为“执行器”会根据该注解识别Spring容器中的任务。任务类需要继承统一接口“IJobHandler”，任务逻辑在execute方法中开发，因为“执行器”在接收到调度中心的调度请求时，将会调用“IJobHandler”的execute方法，执行任务逻辑。</p><h4 id="5-5-2-“GLUE模式-Java-”-任务"><a href="#5-5-2-“GLUE模式-Java-”-任务" class="headerlink" title="5.5.2 “GLUE模式(Java)” 任务"></a>5.5.2 “GLUE模式(Java)” 任务</h4><p>开发步骤：可参考 “章节三” ；<br>原理：每个 “GLUE模式(Java)” 任务的代码，实际上是“一个继承自“IJobHandler”的实现类的类代码”，“执行器”接收到“调度中心”的调度请求时，会通过Groovy类加载器加载此代码，实例化成Java对象，同时注入此代码中声明的Spring服务（请确保Glue代码中的服务和类引用在“执行器”项目中存在），然后调用该对象的execute方法，执行任务逻辑。</p><h4 id="5-5-3-GLUE模式-Shell-GLUE模式-Python-GLUE模式-PHP-GLUE模式-NodeJS-GLUE模式-Powershell"><a href="#5-5-3-GLUE模式-Shell-GLUE模式-Python-GLUE模式-PHP-GLUE模式-NodeJS-GLUE模式-Powershell" class="headerlink" title="5.5.3 GLUE模式(Shell) + GLUE模式(Python) + GLUE模式(PHP) + GLUE模式(NodeJS) + GLUE模式(Powershell)"></a>5.5.3 GLUE模式(Shell) + GLUE模式(Python) + GLUE模式(PHP) + GLUE模式(NodeJS) + GLUE模式(Powershell)</h4><p>开发步骤：可参考 “章节三” ；<br>原理：脚本任务的源码托管在调度中心，脚本逻辑在执行器运行。当触发脚本任务时，执行器会加载脚本源码在执行器机器上生成一份脚本文件，然后通过Java代码调用该脚本；并且实时将脚本输出日志写到任务日志文件中，从而在调度中心可以实时监控脚本运行情况；</p><p>目前支持的脚本类型如下：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs vim">- <span class="hljs-keyword">shell</span>脚本：任务运行模式选择为 <span class="hljs-string">&quot;GLUE模式(Shell)&quot;</span>时支持 <span class="hljs-string">&quot;Shell&quot;</span> 脚本任务；<br>- <span class="hljs-keyword">python</span>脚本：任务运行模式选择为 <span class="hljs-string">&quot;GLUE模式(Python)&quot;</span>时支持 <span class="hljs-string">&quot;Python&quot;</span> 脚本任务；<br>- php脚本：任务运行模式选择为 <span class="hljs-string">&quot;GLUE模式(PHP)&quot;</span>时支持 <span class="hljs-string">&quot;PHP&quot;</span> 脚本任务；<br>- nodejs脚本：任务运行模式选择为 <span class="hljs-string">&quot;GLUE模式(NodeJS)&quot;</span>时支持 <span class="hljs-string">&quot;NodeJS&quot;</span> 脚本任务；<br>- powershell：任务运行模式选择为 <span class="hljs-string">&quot;GLUE模式(PowerShell)&quot;</span>时支持 <span class="hljs-string">&quot;PowerShell&quot;</span> 脚本任务；<br></code></pre></td></tr></table></figure><p>脚本任务通过 Exit Code 判断任务执行结果，状态码可参考章节 “5.15 任务执行结果说明”；</p><h4 id="5-5-4-执行器"><a href="#5-5-4-执行器" class="headerlink" title="5.5.4 执行器"></a>5.5.4 执行器</h4><p>执行器实际上是一个内嵌的Server，默认端口9999（配置项：xxl.job.executor.port）。</p><p>在项目启动时，执行器会通过“<a href="https://github.com/JobHandler">@JobHandler</a>”识别Spring容器中“Bean模式任务”，以注解的value属性为key管理起来。</p><p>“执行器”接收到“调度中心”的调度请求时，如果任务类型为“Bean模式”，将会匹配Spring容器中的“Bean模式任务”，然后调用其execute方法，执行任务逻辑。如果任务类型为“GLUE模式”，将会加载GLue代码，实例化Java对象，注入依赖的Spring服务（注意：Glue代码中注入的Spring服务，必须存在与该“执行器”项目的Spring容器中），然后调用execute方法，执行任务逻辑。</p><h4 id="5-5-5-任务日志"><a href="#5-5-5-任务日志" class="headerlink" title="5.5.5 任务日志"></a>5.5.5 任务日志</h4><p>XXL-JOB会为每次调度请求生成一个单独的日志文件，需要通过 “XxlJobHelper.log” 打印执行日志，“调度中心”查看执行日志时将会加载对应的日志文件。</p><p>(历史版本通过重写LOG4J的Appender实现，存在依赖限制，该方式在新版本已经被抛弃)</p><p>日志文件存放的位置可在“执行器”配置文件进行自定义，默认目录格式为：&#x2F;data&#x2F;applogs&#x2F;xxl-job&#x2F;jobhandler&#x2F;“格式化日期”&#x2F;“数据库调度日志记录的主键ID.log”。</p><p>在JobHandler中开启子线程时，子线程将会把日志打印在父线程即JobHandler的执行日志中，方便日志追踪。</p><h3 id="5-6-通讯模块剖析"><a href="#5-6-通讯模块剖析" class="headerlink" title="5.6 通讯模块剖析"></a>5.6 通讯模块剖析</h3><h4 id="5-6-1-一次完整的任务调度通讯流程"><a href="#5-6-1-一次完整的任务调度通讯流程" class="headerlink" title="5.6.1 一次完整的任务调度通讯流程"></a>5.6.1 一次完整的任务调度通讯流程</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-bullet">- </span>1、“调度中心”向“执行器”发送http调度请求: “执行器”中接收请求的服务，实际上是一台内嵌Server，默认端口9999;<br><span class="hljs-bullet">- </span>2、“执行器”执行任务逻辑；<br><span class="hljs-bullet">- </span>3、“执行器”http回调“调度中心”调度结果: “调度中心”中接收回调的服务，是针对执行器开放一套API服务;<br></code></pre></td></tr></table></figure><h4 id="5-6-2-通讯数据加密"><a href="#5-6-2-通讯数据加密" class="headerlink" title="5.6.2 通讯数据加密"></a>5.6.2 通讯数据加密</h4><p>调度中心向执行器发送的调度请求时使用RequestModel和ResponseModel两个对象封装调度请求参数和响应数据, 在进行通讯之前底层会将上述两个对象对象序列化，并进行数据协议以及时间戳检验,从而达到数据加密的功能;</p><h3 id="5-7-任务注册-任务自动发现"><a href="#5-7-任务注册-任务自动发现" class="headerlink" title="5.7 任务注册, 任务自动发现"></a>5.7 任务注册, 任务自动发现</h3><p>自v1.5版本之后, 任务取消了”任务执行机器”属性, 改为通过任务注册和自动发现的方式, 动态获取远程执行器地址并执行。</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-symbol">AppName:</span> 每个执行器机器集群的唯一标示, 任务注册以 <span class="hljs-string">&quot;执行器&quot;</span> 为最小粒度进行注册<span class="hljs-comment">; 每个任务通过其绑定的执行器可感知对应的执行器机器列表;</span><br>注册表: 见<span class="hljs-string">&quot;xxl_job_registry&quot;</span>表, <span class="hljs-string">&quot;执行器&quot;</span> 在进行任务注册时将会周期性维护一条注册记录，即机器地址和AppName的绑定关系<span class="hljs-comment">;&quot;调度中心&quot; 从而可以动态感知每个AppName在线的机器列表;</span><br>执行器注册: 任务注册<span class="hljs-keyword">Beat周期默认30s; </span>执行器以一倍<span class="hljs-keyword">Beat进行执行器注册, </span>调度中心以一倍<span class="hljs-keyword">Beat进行动态任务发现; </span>注册信息的失效时间为三倍<span class="hljs-keyword">Beat; </span><br>执行器注册摘除：执行器销毁时，将会主动上报调度中心并摘除对应的执行器机器信息，提高心跳注册的实时性；<br></code></pre></td></tr></table></figure><p>为保证系统”轻量级”并且降低学习部署成本，没有采用Zookeeper作为注册中心，采用DB方式进行任务注册发现；</p><h3 id="5-8-任务执行结果"><a href="#5-8-任务执行结果" class="headerlink" title="5.8 任务执行结果"></a>5.8 任务执行结果</h3><p>自v1.6.2之后，任务执行结果通过 “IJobHandler” 的返回值 “ReturnT” 进行判断；<br>当返回值符合 “ReturnT.code &#x3D;&#x3D; ReturnT.SUCCESS_CODE” 时表示任务执行成功，否则表示任务执行失败，而且可以通过 “ReturnT.msg” 回调错误信息给调度中心；<br>从而，在任务逻辑中可以方便的控制任务执行结果；</p><h3 id="5-9-分片广播-amp-动态分片"><a href="#5-9-分片广播-amp-动态分片" class="headerlink" title="5.9 分片广播 &amp; 动态分片"></a>5.9 分片广播 &amp; 动态分片</h3><p>执行器集群部署时，任务路由策略选择”分片广播”情况下，一次任务调度将会广播触发对应集群中所有执行器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；</p><p>“分片广播” 以执行器为维度进行分片，支持动态扩容执行器集群从而动态增加分片数量，协同进行业务处理；在进行大数据量业务操作时可显著提升任务处理能力和速度。</p><p>“分片广播” 和普通任务开发流程一致，不同之处在于可以获取分片参数，获取分片参数进行分片业务处理。</p><ul><li><p>Java语言任务获取分片参数方式：BEAN、GLUE模式(Java)</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// 可参考Sample示例执行器中的示例任务&quot;ShardingJobHandler&quot;了解试用 </span><br><span class="hljs-built_in">int</span> shardIndex = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">XxlJobHelper</span>.</span></span>get<span class="hljs-constructor">ShardIndex()</span>;<br><span class="hljs-built_in">int</span> shardTotal = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">XxlJobHelper</span>.</span></span>get<span class="hljs-constructor">ShardTotal()</span>;<br></code></pre></td></tr></table></figure></li><li><p>脚本语言任务获取分片参数方式：GLUE模式(Shell)、GLUE模式(Python)、GLUE模式(Nodejs)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// 脚本任务入参固定为三个，依次为：任务传参、分片序号、分片总数。以Shell模式任务为例，获取分片参数代码如下</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;分片序号 index = <span class="hljs-subst">$2</span>&quot;</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;分片总数 total = <span class="hljs-subst">$3</span>&quot;</span><br></code></pre></td></tr></table></figure></li></ul><p>分片参数属性说明：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">index</span>：当前分片序号(从<span class="hljs-number">0</span>开始)，执行器集群列表中当前执行器的序号；<br><span class="hljs-attribute">total</span>：总分片数，执行器集群的总机器数量；<br></code></pre></td></tr></table></figure><p>该特性适用场景如：</p><p>1、分片任务场景：10个执行器的集群来处理10w条数据，每台机器只需要处理1w条数据，耗时降低10倍；</p><p>2、广播任务场景：广播执行器机器运行shell脚本、广播集群节点进行缓存更新等</p><h3 id="5-10-访问令牌（AccessToken）"><a href="#5-10-访问令牌（AccessToken）" class="headerlink" title="5.10 访问令牌（AccessToken）"></a>5.10 访问令牌（AccessToken）</h3><p>为提升系统安全性，调度中心和执行器进行安全性校验，双方AccessToken匹配才允许通讯；</p><p>调度中心和执行器，可通过配置项 “xxl.job.accessToken” 进行AccessToken的设置。</p><p>调度中心和执行器，如果需要正常通讯，只有两种设置；</p><ul><li>设置一：调度中心和执行器，均不设置AccessToken；关闭安全性校验；</li><li>设置二：调度中心和执行器，设置了相同的AccessToken；</li></ul><h3 id="5-11-故障转移-amp-失败重试"><a href="#5-11-故障转移-amp-失败重试" class="headerlink" title="5.11 故障转移 &amp; 失败重试"></a>5.11 故障转移 &amp; 失败重试</h3><p>一次完整任务流程包括”调度（调度中心） + 执行（执行器）”两个阶段。</p><ul><li>“故障转移”发生在调度阶段，在执行器集群部署时，如果某一台执行器发生故障，该策略支持自动进行Failover切换到一台正常的执行器机器并且完成调度请求流程。</li><li>“失败重试”发生在”调度 + 执行”两个阶段，支持通过自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</li></ul><h3 id="5-12-执行器灰度上线"><a href="#5-12-执行器灰度上线" class="headerlink" title="5.12 执行器灰度上线"></a>5.12 执行器灰度上线</h3><p>调度中心与业务解耦，只需部署一次后常年不需要维护。但是，执行器中托管运行着业务作业，作业上线和变更需要重启执行器，尤其是Bean模式任务。<br>执行器重启可能会中断运行中的任务。但是，XXL-JOB得益于自建执行器与自建注册中心，可以通过灰度上线的方式，避免因重启导致的任务中断的问题。</p><p>步骤如下：</p><p>1、执行器改为手动注册，下线一半机器列表（A组），线上运行另一半机器列表（B组）；</p><p>2、等待A组机器任务运行结束并编译上线；执行器注册地址替换为A组；</p><p>3、等待B组机器任务运行结束并编译上线；执行器注册地址替换为A组+B组；<br>操作结束；</p><h3 id="5-13-任务执行结果说明"><a href="#5-13-任务执行结果说明" class="headerlink" title="5.13 任务执行结果说明"></a>5.13 任务执行结果说明</h3><p>系统根据以下标准判断任务执行结果，可参考之。</p><table><thead><tr><th align="left">—</th><th align="left">Bean&#x2F;Glue(Java)</th><th align="left">Glue(Shell) 等脚本任务</th></tr></thead><tbody><tr><td align="left">成功</td><td align="left">IJobHandler.SUCCESS</td><td align="left">0</td></tr><tr><td align="left">失败</td><td align="left">IJobHandler.FAIL</td><td align="left">-1（非0状态码）</td></tr></tbody></table><h3 id="5-14-任务超时控制"><a href="#5-14-任务超时控制" class="headerlink" title="5.14 任务超时控制"></a>5.14 任务超时控制</h3><p>支持设置任务超时时间，任务运行超时的情况下，将会主动中断任务；</p><p>需要注意的是，任务超时中断时与任务终止机制（可查看“4.9 终止运行中的任务”）类似，也是通过 “interrupt” 中断任务，因此业务代码需要将 “InterruptedException” 外抛，否则功能不可用。</p><h3 id="5-15-跨语言"><a href="#5-15-跨语言" class="headerlink" title="5.15 跨语言"></a>5.15 跨语言</h3><p>XXL-JOB是一个跨语言的任务调度平台，主要体现在如下几个方面：</p><p>1、RESTful API：调度中心与执行器提供语言无关的 RESTful API 服务，第三方任意语言可据此对接调度中心或者实现执行器。（可参考章节 “调度中心&#x2F;执行器 RESTful API” ）</p><p>2、多任务模式：提供Java、Python、PHP……等十来种任务模式，可参考章节 “5.5 任务 “运行模式” ”；理论上可扩展任意语言任务模式；</p><p>2、提供基于HTTP的任务Handler（Bean任务，JobHandler&#x3D;”httpJobHandler”）；业务方只需要提供HTTP链接等相关信息即可，不限制语言、平台；（可参考章节 “原生内置Bean模式任务” ）</p><h3 id="5-16-任务失败告警"><a href="#5-16-任务失败告警" class="headerlink" title="5.16 任务失败告警"></a>5.16 任务失败告警</h3><p>默认提供邮件失败告警，可扩展短信、钉钉等方式。如果需要新增一种告警方式，只需要新增一个实现 “com.xxl.job.admin.core.alarm.JobAlarm” 接口的告警实现即可。可以参考默认提供邮箱告警实现 “EmailJobAlarm”。</p><h3 id="5-17-调度中心Docker镜像构建"><a href="#5-17-调度中心Docker镜像构建" class="headerlink" title="5.17 调度中心Docker镜像构建"></a>5.17 调度中心Docker镜像构建</h3><p>可以通过以下命令快速构建调度中心，并启动运行；</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sqf">mvn clean packagedocker <br>build -t xuxueli/xxl-job-<span class="hljs-built_in">admin</span> ./xxl-job-<span class="hljs-built_in">admin</span><br>docker run --<span class="hljs-built_in">name</span> xxl-job-<span class="hljs-built_in">admin</span> -p <span class="hljs-number">8080</span>:<span class="hljs-number">8080</span> -d xuxueli/xxl-job-<span class="hljs-built_in">admin</span><br></code></pre></td></tr></table></figure><h3 id="5-20-避免任务重复执行"><a href="#5-20-避免任务重复执行" class="headerlink" title="5.20 避免任务重复执行"></a>5.20 避免任务重复执行</h3><p>调度密集或者耗时任务可能会导致任务阻塞，集群情况下调度组件小概率情况下会重复触发；<br>针对上述情况，可以通过结合 “单机路由策略（如：第一台、一致性哈希）” + “阻塞策略（如：单机串行、丢弃后续调度）” 来规避，最终避免任务重复执行。</p><h3 id="5-21-命令行任务"><a href="#5-21-命令行任务" class="headerlink" title="5.21 命令行任务"></a>5.21 命令行任务</h3><p>原生提供通用命令行任务Handler（Bean任务，”CommandJobHandler”）；业务方只需要提供命令行即可；<br>如任务参数 “pwd” 将会执行命令并输出数据；</p><h3 id="5-22-日志自动清理"><a href="#5-22-日志自动清理" class="headerlink" title="5.22 日志自动清理"></a>5.22 日志自动清理</h3><p>XXL-JOB日志主要包含如下两部分，均支持日志自动清理，说明如下：</p><ul><li>调度中心日志表数据：可借助配置项 “xxl.job.logretentiondays” 设置日志表数据保存天数，过期日志自动清理；详情可查看上文配置说明；</li><li>执行器日志文件数据：可借助配置项 “xxl.job.executor.logretentiondays” 设置日志文件数据保存天数，过期日志自动清理；详情可查看上文配置说明；</li></ul><h3 id="5-23-调度结果丢失处理"><a href="#5-23-调度结果丢失处理" class="headerlink" title="5.23 调度结果丢失处理"></a>5.23 调度结果丢失处理</h3><p>执行器因网络抖动回调失败或宕机等异常情况，会导致任务调度结果丢失。由于调度中心依赖执行器回调来感知调度结果，因此会导致调度日志永远处于 “运行中” 状态。</p><p>针对该问题，调度中心提供内置组件进行处理，逻辑为：调度记录停留在 “运行中” 状态超过10min，且对应执行器心跳注册失败不在线，则将本地调度主动标记失败；</p><h2 id="六、调度中心-x2F-执行器-RESTful-API"><a href="#六、调度中心-x2F-执行器-RESTful-API" class="headerlink" title="六、调度中心&#x2F;执行器 RESTful API"></a>六、调度中心&#x2F;执行器 RESTful API</h2><p>XXL-JOB 目标是一种跨平台、跨语言的任务调度规范和协议。</p><p>针对Java应用，可以直接通过官方提供的调度中心与执行器，方便快速的接入和使用调度中心，可以参考上文 “快速入门” 章节。</p><p>针对非Java应用，可借助 XXL-JOB 的标准 RESTful API 方便的实现多语言支持。</p><ul><li>调度中心 RESTful API：<ul><li>说明：调度中心提供给执行器使用的API；不局限于官方执行器使用，第三方可使用该API来实现执行器；</li><li>API列表：执行器注册、任务结果回调等；</li></ul></li><li>执行器 RESTful API ：<ul><li>说明：执行器提供给调度中心使用的API；官方执行器默认已实现，第三方执行器需要实现并对接提供给调度中心；</li><li>API列表：任务触发、任务终止、任务日志查询……等；</li></ul></li></ul><p>此处 RESTful API 主要用于非Java语言定制个性化执行器使用，实现跨语言。除此之外，如果有需要通过API操作调度中心，可以个性化扩展 “调度中心 RESTful API” 并使用。</p><h3 id="6-1-调度中心-RESTful-API"><a href="#6-1-调度中心-RESTful-API" class="headerlink" title="6.1 调度中心 RESTful API"></a>6.1 调度中心 RESTful API</h3><p>API服务位置：com.xxl.job.core.biz.AdminBiz （ com.xxl.job.admin.controller.JobApiController ）<br>API服务请求参考代码：com.xxl.job.adminbiz.AdminBizTest</p><h4 id="a、任务回调"><a href="#a、任务回调" class="headerlink" title="a、任务回调"></a>a、任务回调</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk">说明：执行器执行完任务后，回调任务结果时使用<br><br>------<br><br>地址格式：&#123;调度中心根地址&#125;<span class="hljs-regexp">/api/</span>callback<br><br>Header：<br>XXL-JOB-ACCESS-TOKEN : &#123;请求令牌&#125;<br><br>请求数据格式如下，放置在 RequestBody 中，JSON格式：    <br>[&#123;        <br><span class="hljs-string">&quot;logId&quot;</span>:<span class="hljs-number">1</span>,              <span class="hljs-regexp">//</span> 本次调度日志ID        <br><span class="hljs-string">&quot;logDateTim&quot;</span>:<span class="hljs-number">0</span>,         <span class="hljs-regexp">//</span> 本次调度日志时间        <br><span class="hljs-string">&quot;handleCode&quot;</span>:<span class="hljs-number">200</span>,       <span class="hljs-regexp">//</span> <span class="hljs-number">200</span> 表示任务执行正常，<span class="hljs-number">500</span>表示失败        <br><span class="hljs-string">&quot;handleMsg&quot;</span>: null        <br>&#125;    <br>&#125;]<br><br>响应数据格式：    <br>&#123;      <br><span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-number">200</span>,      <span class="hljs-regexp">//</span> <span class="hljs-number">200</span> 表示正常、其他失败      <br><span class="hljs-string">&quot;msg&quot;</span>: null      <span class="hljs-regexp">//</span> 错误提示消息    <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="b、执行器注册"><a href="#b、执行器注册" class="headerlink" title="b、执行器注册"></a>b、执行器注册</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs awk">说明：执行器注册时使用，调度中心会实时感知注册成功的执行器并发起任务调度<br><br>------<br><br>地址格式：&#123;调度中心根地址&#125;<span class="hljs-regexp">/api/</span>registry<br><br>Header：   <br>XXL-JOB-ACCESS-TOKEN : &#123;请求令牌&#125;<br><br>请求数据格式如下，放置在 RequestBody 中，JSON格式：<br>&#123;        <br><span class="hljs-string">&quot;registryGroup&quot;</span>:<span class="hljs-string">&quot;EXECUTOR&quot;</span>,                     <span class="hljs-regexp">//</span> 固定值        <br><span class="hljs-string">&quot;registryKey&quot;</span>:<span class="hljs-string">&quot;xxl-job-executor-example&quot;</span>,       <span class="hljs-regexp">//</span> 执行器AppName        <br><span class="hljs-string">&quot;registryValue&quot;</span>:<span class="hljs-string">&quot;http://127.0.0.1:9999/&quot;</span>        <span class="hljs-regexp">//</span> 执行器地址，内置服务跟地址    <br>&#125;<br><br>响应数据格式：    <br>&#123;      <br><span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-number">200</span>,      <span class="hljs-regexp">//</span> <span class="hljs-number">200</span> 表示正常、其他失败      <br><span class="hljs-string">&quot;msg&quot;</span>: null      <span class="hljs-regexp">//</span> 错误提示消息    <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="c、执行器注册摘除"><a href="#c、执行器注册摘除" class="headerlink" title="c、执行器注册摘除"></a>c、执行器注册摘除</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">说明：执行器注册摘除时使用，注册摘除后的执行器不参与任务调度与执行------地址格式：&#123;调度中心根地址&#125;<span class="hljs-regexp">/api/</span>registryRemoveHeader：    XXL-JOB-ACCESS-TOKEN : &#123;请求令牌&#125;请求数据格式如下，放置在 RequestBody 中，JSON格式：    &#123;        <span class="hljs-string">&quot;registryGroup&quot;</span>:<span class="hljs-string">&quot;EXECUTOR&quot;</span>,                     <span class="hljs-regexp">//</span> 固定值        <span class="hljs-string">&quot;registryKey&quot;</span>:<span class="hljs-string">&quot;xxl-job-executor-example&quot;</span>,       <span class="hljs-regexp">//</span> 执行器AppName        <span class="hljs-string">&quot;registryValue&quot;</span>:<span class="hljs-string">&quot;http://127.0.0.1:9999/&quot;</span>        <span class="hljs-regexp">//</span> 执行器地址，内置服务跟地址    &#125;响应数据格式：    &#123;      <span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-number">200</span>,      <span class="hljs-regexp">//</span> <span class="hljs-number">200</span> 表示正常、其他失败      <span class="hljs-string">&quot;msg&quot;</span>: null      <span class="hljs-regexp">//</span> 错误提示消息    &#125;<br></code></pre></td></tr></table></figure><h3 id="6-2-执行器-RESTful-API"><a href="#6-2-执行器-RESTful-API" class="headerlink" title="6.2 执行器 RESTful API"></a>6.2 执行器 RESTful API</h3><p>API服务位置：com.xxl.job.core.biz.ExecutorBiz<br>API服务请求参考代码：com.xxl.job.executorbiz.ExecutorBizTest</p><h4 id="a、心跳检测"><a href="#a、心跳检测" class="headerlink" title="a、心跳检测"></a>a、心跳检测</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">说明：调度中心检测执行器是否在线时使用<br><br><span class="hljs-comment">------</span><br><br>地址格式：&#123;执行器内嵌服务根地址&#125;/beat<br><br><span class="hljs-keyword">Header</span>：    <br>XXL-JOB-<span class="hljs-keyword">ACCESS</span>-TOKEN : &#123;请求令牌&#125;<br><br>请求数据格式如下，放置在 RequestBody 中，<span class="hljs-type">JSON</span>格式：<br><br>响应数据格式：    <br>&#123;      <br>&quot;code&quot;: <span class="hljs-number">200</span>,      // <span class="hljs-number">200</span> 表示正常、其他失败      <br>&quot;msg&quot;: <span class="hljs-keyword">null</span>       // 错误提示消息    <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="b、忙碌检测"><a href="#b、忙碌检测" class="headerlink" title="b、忙碌检测"></a>b、忙碌检测</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs awk">说明：调度中心检测指定执行器上指定任务是否忙碌（运行中）时使用<br><br>------<br><br>地址格式：&#123;执行器内嵌服务根地址&#125;/idleBeat<br><br>Header：    <br>XXL-JOB-ACCESS-TOKEN : &#123;请求令牌&#125;<br><br>请求数据格式如下，放置在 RequestBody 中，JSON格式：    <br>&#123;        <br><span class="hljs-string">&quot;jobId&quot;</span>:<span class="hljs-number">1</span>       <span class="hljs-regexp">//</span> 任务ID    <br>&#125;<br><br>响应数据格式：    <br>&#123;      <br><span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-number">200</span>,      <span class="hljs-regexp">//</span> <span class="hljs-number">200</span> 表示正常、其他失败      <br><span class="hljs-string">&quot;msg&quot;</span>: null       <span class="hljs-regexp">//</span> 错误提示消息    <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="c、触发任务"><a href="#c、触发任务" class="headerlink" title="c、触发任务"></a>c、触发任务</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs awk">说明：触发任务执行<br><br>------<br><br>地址格式：&#123;执行器内嵌服务根地址&#125;/run<br><br>Header：    <br>XXL-JOB-ACCESS-TOKEN : &#123;请求令牌&#125;<br><br>请求数据格式如下，放置在 RequestBody 中，JSON格式：    <br>&#123;        <br><span class="hljs-string">&quot;jobId&quot;</span>:<span class="hljs-number">1</span>,                                  <span class="hljs-regexp">//</span> 任务ID        <br><span class="hljs-string">&quot;executorHandler&quot;</span>:<span class="hljs-string">&quot;demoJobHandler&quot;</span>,         <span class="hljs-regexp">//</span> 任务标识        <br><span class="hljs-string">&quot;executorParams&quot;</span>:<span class="hljs-string">&quot;demoJobHandler&quot;</span>,          <span class="hljs-regexp">//</span> 任务参数        <br><span class="hljs-string">&quot;executorBlockStrategy&quot;</span>:<span class="hljs-string">&quot;COVER_EARLY&quot;</span>,      <span class="hljs-regexp">//</span> 任务阻塞策略，可选值参考 com.xxl.job.core.enums.ExecutorBlockStrategyEnum        <br><span class="hljs-string">&quot;executorTimeout&quot;</span>:<span class="hljs-number">0</span>,                        <span class="hljs-regexp">//</span> 任务超时时间，单位秒，大于零时生效        <br><span class="hljs-string">&quot;logId&quot;</span>:<span class="hljs-number">1</span>,                                  <span class="hljs-regexp">//</span> 本次调度日志ID        <br><span class="hljs-string">&quot;logDateTime&quot;</span>:<span class="hljs-number">1586629003729</span>,                <span class="hljs-regexp">//</span> 本次调度日志时间        <br><span class="hljs-string">&quot;glueType&quot;</span>:<span class="hljs-string">&quot;BEAN&quot;</span>,                          <span class="hljs-regexp">//</span> 任务模式，可选值参考 com.xxl.job.core.glue.GlueTypeEnum         <span class="hljs-string">&quot;glueSource&quot;</span>:<span class="hljs-string">&quot;xxx&quot;</span>,                         <span class="hljs-regexp">//</span> GLUE脚本代码        <br><span class="hljs-string">&quot;glueUpdatetime&quot;</span>:<span class="hljs-number">1586629003727</span>,             <span class="hljs-regexp">//</span> GLUE脚本更新时间，用于判定脚本是否变更以及是否需要刷新        <br><span class="hljs-string">&quot;broadcastIndex&quot;</span>:<span class="hljs-number">0</span>,                         <span class="hljs-regexp">//</span> 分片参数：当前分片        <span class="hljs-string">&quot;broadcastTotal&quot;</span>:<span class="hljs-number">0</span>                          <span class="hljs-regexp">//</span> 分片参数：总分片    <br>&#125;<br><br>响应数据格式：    <br>&#123;      <br><span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-number">200</span>,      <span class="hljs-regexp">//</span> <span class="hljs-number">200</span> 表示正常、其他失败      <br><span class="hljs-string">&quot;msg&quot;</span>: null       <span class="hljs-regexp">//</span> 错误提示消息    <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="f、终止任务"><a href="#f、终止任务" class="headerlink" title="f、终止任务"></a>f、终止任务</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs awk">说明：终止任务<br><br>------<br><br>地址格式：&#123;执行器内嵌服务根地址&#125;/kill<br><br>Header：    <br>XXL-JOB-ACCESS-TOKEN : &#123;请求令牌&#125;<br><br>请求数据格式如下，放置在 RequestBody 中，JSON格式：<br>&#123;        <br><span class="hljs-string">&quot;jobId&quot;</span>:<span class="hljs-number">1</span>       <span class="hljs-regexp">//</span> 任务ID    <br>&#125;<br><br>响应数据格式：    <br>&#123;      <br><span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-number">200</span>,      <span class="hljs-regexp">//</span> <span class="hljs-number">200</span> 表示正常、其他失败      <br><span class="hljs-string">&quot;msg&quot;</span>: null       <span class="hljs-regexp">//</span> 错误提示消息    <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="d、查看执行日志"><a href="#d、查看执行日志" class="headerlink" title="d、查看执行日志"></a>d、查看执行日志</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs awk">说明：终止任务，滚动方式加载<br><br>------<br><br>地址格式：&#123;执行器内嵌服务根地址&#125;/log<br><br>Header：    <br>XXL-JOB-ACCESS-TOKEN : &#123;请求令牌&#125;<br><br>请求数据格式如下，放置在 RequestBody 中，JSON格式：    <br>&#123;        <br><span class="hljs-string">&quot;logDateTim&quot;</span>:<span class="hljs-number">0</span>,     <span class="hljs-regexp">//</span> 本次调度日志时间        <br><span class="hljs-string">&quot;logId&quot;</span>:<span class="hljs-number">0</span>,          <span class="hljs-regexp">//</span> 本次调度日志ID        <br><span class="hljs-string">&quot;fromLineNum&quot;</span>:<span class="hljs-number">0</span>     <span class="hljs-regexp">//</span> 日志开始行号，滚动加载日志    <br>&#125;<br><br>响应数据格式：    <br>&#123;        <br><span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-number">200</span>,         <span class="hljs-regexp">//</span> <span class="hljs-number">200</span> 表示正常、其他失败        <br><span class="hljs-string">&quot;msg&quot;</span>: null         <span class="hljs-regexp">//</span> 错误提示消息        <br><span class="hljs-string">&quot;content&quot;</span>:&#123;            <br><span class="hljs-string">&quot;fromLineNum&quot;</span>:<span class="hljs-number">0</span>,        <span class="hljs-regexp">//</span> 本次请求，日志开始行数            <br><span class="hljs-string">&quot;toLineNum&quot;</span>:<span class="hljs-number">100</span>,        <span class="hljs-regexp">//</span> 本次请求，日志结束行号            <br><span class="hljs-string">&quot;logContent&quot;</span>:<span class="hljs-string">&quot;xxx&quot;</span>,     <span class="hljs-regexp">//</span> 本次请求日志内容            <br><span class="hljs-string">&quot;isEnd&quot;</span>:true            <span class="hljs-regexp">//</span> 日志是否全部加载完        <br>&#125;    <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="七、版本更新日志"><a href="#七、版本更新日志" class="headerlink" title="七、版本更新日志"></a>七、版本更新日志</h2><h3 id="7-1-版本-V1-1-x，新特性-2015-12-05"><a href="#7-1-版本-V1-1-x，新特性-2015-12-05" class="headerlink" title="7.1 版本 V1.1.x，新特性[2015-12-05]"></a>7.1 版本 V1.1.x，新特性[2015-12-05]</h3><p><strong>【于V1.1.x版本，XXL-JOB正式应用于我司，内部定制别名为 “Ferrari”，新接入应用推荐使用最新版本】</strong></p><p>1、简单：支持通过Web页面对任务进行CRUD操作，操作简单，一分钟上手；</p><p>2、动态：支持动态修改任务状态，动态暂停&#x2F;恢复任务，即时生效；</p><p>3、服务HA：任务信息持久化到mysql中，Job服务天然支持集群，保证服务HA；</p><p>4、任务HA：某台Job服务挂掉，任务会平滑分配给其他的某一台存活服务，即使所有服务挂掉，重启时或补偿执行丢失任务；</p><p>5、一个任务只会在其中一台服务器上执行；</p><p>6、任务串行执行；</p><p>7、支持自定义参数；</p><p>8、支持远程任务执行终止；</p><h3 id="7-2-版本-V1-2-x，新特性-2016-01-17"><a href="#7-2-版本-V1-2-x，新特性-2016-01-17" class="headerlink" title="7.2 版本 V1.2.x，新特性[2016-01-17]"></a>7.2 版本 V1.2.x，新特性[2016-01-17]</h3><p>1、支持任务分组；</p><p>2、支持“本地任务”、“远程任务”；</p><p>3、底层通讯支持两种方式，Servlet方式 + JETTY方式；</p><p>4、支持“任务日志”；</p><p>5、支持“串行执行”，并行执行；</p><p>说明：V1.2版本将系统架构按功能拆分为：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-bullet">- </span>调度模块（调度中心）：负责管理调度信息，按照调度配置发出调度请求；- 执行模块（执行器）：负责接收调度请求并执行任务逻辑；- 通讯模块：负责调度模块和任务模块之间的信息通讯；<br></code></pre></td></tr></table></figure><p>优点：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-bullet">- </span>解耦：任务模块提供任务接口，调度模块维护调度信息，业务相互独立；- 高扩展性；- 稳定性；<br></code></pre></td></tr></table></figure><h3 id="7-3-版本-V1-3-0，新特性-2016-05-19"><a href="#7-3-版本-V1-3-0，新特性-2016-05-19" class="headerlink" title="7.3 版本 V1.3.0，新特性[2016-05-19]"></a>7.3 版本 V1.3.0，新特性[2016-05-19]</h3><p>1、遗弃“本地任务”模式，推荐使用“远程任务”，易于系统解耦，任务对应的JobHandler统称为“执行器”；</p><p>2、遗弃“servlet”方式底层系统通讯，推荐使用JETTY方式，调度+回调双向通讯，重构通讯逻辑；</p><p>3、UI交互优化：左侧菜单展开状态优化，菜单项选中状态优化，任务列表打开表格有压缩优化；</p><p>4、【重要】“执行器”细分为：BEAN、GLUE两种开发模式，简介见下文：</p><p>“执行器” 模式简介：</p><ul><li>BEAN模式执行器：每个执行器都是Spring的一个Bean实例，XXL-JOB通过注解<a href="https://github.com/JobHandler">@JobHandler</a>识别和调度执行器；<br>-GLUE模式执行器：每个执行器对应一段代码，在线Web编辑和维护，动态编译生效，执行器负责加载GLUE代码和执行；</li></ul><h3 id="7-4-版本-V1-3-1，新特性-2016-05-23"><a href="#7-4-版本-V1-3-1，新特性-2016-05-23" class="headerlink" title="7.4 版本 V1.3.1，新特性[2016-05-23]"></a>7.4 版本 V1.3.1，新特性[2016-05-23]</h3><p>1、更新项目目录结构：</p><ul><li>&#x2F;xxl-job-admin —————————— 【调度中心】：负责管理调度信息，按照调度配置发出调度请求；</li><li>&#x2F;xxl-job-core ———————————- 公共依赖</li><li>&#x2F;xxl-job-executor-example ——— 【执行器】：负责接收调度请求并执行任务逻辑；</li><li>&#x2F;db ————————————————— 建表脚本</li><li>&#x2F;doc ————————————————- 用户手册</li></ul><p>2、在新的目录结构上，升级了用户手册；</p><p>3、优化了一些交互和UI；</p><h3 id="7-5-版本-V1-3-2，新特性-2016-05-28"><a href="#7-5-版本-V1-3-2，新特性-2016-05-28" class="headerlink" title="7.5 版本 V1.3.2，新特性[2016-05-28]"></a>7.5 版本 V1.3.2，新特性[2016-05-28]</h3><p>1、调度逻辑进行事务包裹；</p><p>2、执行器异步回调执行日志；</p><p>3、【重要】在 “调度中心” 支持HA的基础上，扩展执行器的Failover支持，支持配置多执行期地址；</p><h3 id="7-6-版本-V1-4-0-新特性-2016-07-24"><a href="#7-6-版本-V1-4-0-新特性-2016-07-24" class="headerlink" title="7.6 版本 V1.4.0 新特性[2016-07-24]"></a>7.6 版本 V1.4.0 新特性[2016-07-24]</h3><p>1、任务依赖: 通过事件触发方式实现, 任务执行成功并回调时会主动触发一次子任务的调度, 多个子任务用逗号分隔;</p><p>2、执行器底层实现代码进行重度重构, 优化底层建表脚本;</p><p>3、执行器中任务线程分组逻辑优化: 之前根据执行器JobHandler进行线程分组,当多个任务复用Jobhanlder会导致相互阻塞。现改为根据调度中心任务进行任务线程分组,任务与任务执行相互隔离;</p><p>4、执行器调度通讯方案优化, 通过Hex + HC实现建议RPC通讯协议, 优化了通讯参数的维护和解析流程;</p><p>5、调度中心, 新建&#x2F;编辑任务, 界面属性调整:</p><ul><li>5.1、任务新增&#x2F;编辑界面中去除 “任务名JobName”属性 ,该属性改为系统自动生成: 该字段之前主要用于在 “调度中心” 唯一标示一个任务, 现实意义不大, 因此计划淡化掉该字段,改为系统生成UUID,从而简化任务新建的操作;</li><li>5.2、任务新增&#x2F;编辑界面中去除 “GLUE模式” 复选框位置调整, 改为贴近”JobHandler”输入框右侧;</li><li>5.3、任务新增&#x2F;编辑界面中去除 “报警阈值” 属性;</li><li>5.4、任务新增&#x2F;编辑界面中去除 “子任务Key” 属性, 每个任务全局任务Key可以从任务列表获取, 当本任务执行结束且成功后, 将会根据子任务Key匹配子任务并主动触发一次子任务执行;</li></ul><p>6、问题修复:</p><p>6.1、执行器jetty关闭优化,解决一处可能导致jetty无法关闭的问题;</p><p>6.2、执行器任务终止时,执行队列回调优化,解决一处导致任务无法回调的问题；</p><p>6.3、调度中心中列表分页参数优化,解决一处因服务器限制post长度而引起的问题;</p><p>6.4、执行器Jobhandler注解优化,解决一处因事务代理导致的容器无法加载JobHandler的问题;</p><p>6.5、远程调度优化,禁用retry策略,解决一处可能导致重复调用的问题;</p><p>Tips: 历史版本(V1.3.x)目前已经Release至稳定版本, 进入维护阶段, 地址见分支 <a href="https://github.com/xuxueli/xxl-job/tree/v1.3">V1.3</a> 。新特性将会在master分支持续更新。</p><h3 id="7-7-版本-V1-4-1-新特性-2016-09-06"><a href="#7-7-版本-V1-4-1-新特性-2016-09-06" class="headerlink" title="7.7 版本 V1.4.1 新特性[2016-09-06]"></a>7.7 版本 V1.4.1 新特性[2016-09-06]</h3><p>1、项目成功推送maven中央仓库, 中央仓库地址以及依赖如下:</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-comment">&lt;!-- http://repo1.maven.org/maven2/com/xuxueli/xxl-job-core/ --&gt;</span>  </span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>      </span><br><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuxueli<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>      </span><br><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xxl-job-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>      </span><br><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$</span><span class="hljs-template-variable">&#123;最新稳定版&#125;</span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  </span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p>2、为适配中央仓库规则, 项目groupId从com.xxl改为com.xuxueli。</p><p>3、系统版本不在维护在项目跟pom中,各个子模块单独配置版本配置,解决子模块无法单独编译的问题;</p><p>4、底层RPC通讯,传输数据的字节长度统计规则优化,可节省50%数据传输量;</p><p>5、IJobHandler取消任务返回值,原通过返回值判断执行状态,逻辑改为:默认任务执行成功,仅在捕获异常时认定任务执行失败。</p><p>6、系统公共弹框功能,插件化;</p><p>7、底层表结构,表明统一大写;</p><p>8、调度中心,异常处理器JSON响应的ContentType修改,修复浏览器不识别的问题;</p><h3 id="7-8-版本-V1-4-2-新特性-2016-09-29"><a href="#7-8-版本-V1-4-2-新特性-2016-09-29" class="headerlink" title="7.8 版本 V1.4.2 新特性[2016-09-29]"></a>7.8 版本 V1.4.2 新特性[2016-09-29]</h3><p>1、推送新版本 V1.4.2 至中央仓库, 大版本 V1.4 进入维护阶段;</p><p>2、任务新增时,任务列表偏移问题修复;</p><p>3、修复一处因bootstrap不支持模态框重叠而导致的样式错乱的问题, 在任务编辑时会出现该问题;</p><p>4、调度超时和Handler匹配不到时,调度状态优化;</p><p>5、因catch异常,导致任务不可终止的问题,给出解决方案, 见文档;</p><h3 id="7-9-版本-V1-5-0-特性-2016-11-13"><a href="#7-9-版本-V1-5-0-特性-2016-11-13" class="headerlink" title="7.9 版本 V1.5.0 特性[2016-11-13]"></a>7.9 版本 V1.5.0 特性[2016-11-13]</h3><p>1、任务注册: 执行器会周期性自动注册任务, 调度中心将会自动发现注册的任务并触发执行。</p><p>2、”执行器” 新增参数 “AppName” : 是每个执行器集群的唯一标示AppName, 并周期性以AppName为对象进行自动注册。</p><p>3、调度中心新增栏目 “执行器管理” : 管理在线的执行器, 通过属性AppName自动发现注册的执行器。只有被管理的执行器才允许被使用;</p><p>4、”任务组”属性改为”执行器”: 每个任务需要绑定指定的执行器, 调度地址通过绑定的执行器获取;</p><p>5、抛弃”任务机器”属性: 通过任务绑定的执行器, 自动发现注册的远程执行器地址并触发调度请求。</p><p>6、”公共依赖”中新增DBGlueLoader,基于原生jdbc实现GLUE源码的加载器,减少第三方依赖(mybatis,spring-orm等);精简和优化执行器测配置(针对GLUE任务),降低上手难度;</p><p>7、表结构调整,底层重构优化;</p><p>8、”调度中心”自动注册和发现,failover: 调度中心周期性自动注册, 任务回调时可以感知在线的所有调度中心地址, 通过failover的方式进行任务回调,避免回调单点风险。</p><h3 id="7-10-版本-V1-5-1-特性-2016-11-13"><a href="#7-10-版本-V1-5-1-特性-2016-11-13" class="headerlink" title="7.10 版本 V1.5.1 特性[2016-11-13]"></a>7.10 版本 V1.5.1 特性[2016-11-13]</h3><p>1、底层代码重构和逻辑优化，POM清理以及CleanCode；</p><p>2、Servlet&#x2F;JSP Spec设定为3.0&#x2F;2.2</p><p>3、Spring升级至3.2.17.RELEASE版本；</p><p>4、Jetty升级版本至8.2.0.v20160908；</p><p>5、已推送V1.5.0和V1.5.1至Maven中央仓库；</p><h3 id="7-11-版本-V1-5-2-特性-2017-02-28"><a href="#7-11-版本-V1-5-2-特性-2017-02-28" class="headerlink" title="7.11 版本 V1.5.2 特性[2017-02-28]"></a>7.11 版本 V1.5.2 特性[2017-02-28]</h3><p>1、IP工具类获取IP逻辑优化，IP静态缓存；</p><p>2、执行器、调度中心，均支持自定义注册IP地址；解决机器多网卡时错误网卡注册的情况；</p><p>3、任务跨天执行时生成多份日志文件的问题修复；</p><p>4、底层日志底层日志调整，非敏感日志level调整为debug；</p><p>5、升级数据库连接池c3p0版本；</p><p>6、执行器log4j配置优化，去除无效属性；</p><p>7、底层代码重构和逻辑优化以及CleanCode；</p><p>8、GLUE依赖注入逻辑优化，支持别名注入；</p><h3 id="7-12-版本-V1-6-0-特性-2017-03-13"><a href="#7-12-版本-V1-6-0-特性-2017-03-13" class="headerlink" title="7.12 版本 V1.6.0 特性[2017-03-13]"></a>7.12 版本 V1.6.0 特性[2017-03-13]</h3><p>1、通讯方案升级，原基于HEX的通讯模型调整为基于HTTP的B-RPC的通讯模型；</p><p>2、执行器支持手动设置执行地址列表，提供开关切换使用注册地址还是手动设置的地址；</p><p>3、执行器路由规则：第一个、最后一个、轮询、随机、一致性HASH、最不经常使用、最近最久未使用、故障转移；</p><p>4、规范线程模型统一，统一线程销毁方案(通过listener或stop方法，容器销毁时销毁线程；Daemon方式有时不太理想)；</p><p>5、规范系统配置数据，通过配置文件统一管理；</p><p>6、CleanCode，清理无效的历史参数；</p><p>7、底层扩展数据结构以及相关表结构调整；</p><p>8、新建任务默认为非运行状态；</p><p>9、GLUE模式任务实例更新逻辑优化，原根据超时时间更新改为根据版本号更新，源码变动版本号加一；</p><h3 id="7-13-版本-V1-6-1-特性-2017-03-25"><a href="#7-13-版本-V1-6-1-特性-2017-03-25" class="headerlink" title="7.13 版本 V1.6.1 特性[2017-03-25]"></a>7.13 版本 V1.6.1 特性[2017-03-25]</h3><p>1、Rolling日志；</p><p>2、WebIDE交互重构；</p><p>3、通讯增强校验，有效过滤非正常请求；</p><p>4、权限增强校验，采用动态登录TOKEN（推荐接入内部SSO）；</p><p>5、数据库配置优化，解决乱码问题；</p><h3 id="7-14-版本-V1-6-2-特性-2017-04-25"><a href="#7-14-版本-V1-6-2-特性-2017-04-25" class="headerlink" title="7.14 版本 V1.6.2 特性[2017-04-25]"></a>7.14 版本 V1.6.2 特性[2017-04-25]</h3><p>1、运行报表：支持实时查看运行数据，如任务数量、调度次数、执行器数量等；以及调度报表，如调度日期分布图，调度成功分布图等；</p><p>2、JobHandler支持设置任务返回值，在任务逻辑中可以方便的控制任务执行结果；</p><p>3、资源路径包含空格或中文时资源文件无法加载时，无法准确查看异常信息的问题处理。</p><p>4、路由策越优化：循环和LFU路由策略计数器自增无上限问题和首次路由压力集中在首台机器的问题修复；</p><h3 id="7-15-版本-V1-7-0-特性-2017-05-02"><a href="#7-15-版本-V1-7-0-特性-2017-05-02" class="headerlink" title="7.15 版本 V1.7.0 特性[2017-05-02]"></a>7.15 版本 V1.7.0 特性[2017-05-02]</h3><p>1、脚本任务：支持以GLUE模式开发和运行脚本任务，包括Shell、Python和Groovy等类型脚本;</p><p>2、新增spring-boot类型执行器example项目；</p><p>3、升级jetty版本至9.2；</p><p>4、任务运行日志移除log4j组件依赖，改为底层自主实现，从而取消了对日志组件的依赖限制；</p><p>5、执行器移除GlueLoader依赖，改为推送方式实现，从而GLUE源码加载不再依赖JDBC；</p><p>6、登录拦截Redirect时获取项目名，解决非根据目录发布时跳转404问题；</p><h3 id="7-16-版本-V1-7-1-特性-2017-05-08"><a href="#7-16-版本-V1-7-1-特性-2017-05-08" class="headerlink" title="7.16 版本 V1.7.1 特性[2017-05-08]"></a>7.16 版本 V1.7.1 特性[2017-05-08]</h3><p>1、运行日志读写编码统一为UTF-8，解决windows环境下日志乱码问题；</p><p>2、通讯超时时间限定为10s，避免异常情况下调度线程占用；</p><p>3、执行器，server启动、销毁和注册逻辑调整；</p><p>4、JettyServer关闭逻辑优化，修复执行器无法正常关闭导致端口占用和频繁打印c3p0日志的问题；</p><p>5、JobHandler中开启子线程时，支持子线程输出执行日志并通过Rolling查看。</p><p>6、任务日志清理功能；</p><p>7、弹框组件统一替换为layer；</p><p>8、升级quartz版本至2.3.0；</p><h3 id="7-17-版本-V1-7-2-特性-2017-05-17"><a href="#7-17-版本-V1-7-2-特性-2017-05-17" class="headerlink" title="7.17 版本 V1.7.2 特性[2017-05-17]"></a>7.17 版本 V1.7.2 特性[2017-05-17]</h3><p>1、阻塞处理策略：调度过于密集执行器来不及处理时的处理策略，策略包括：单机串行（默认）、丢弃后续调度、覆盖之前调度；</p><p>2、失败处理策略；调度失败时的处理策略，策略包括：失败告警（默认）、失败重试；</p><p>3、通讯时间戳超时时间调整为180s；</p><p>4、执行器与数据库彻底解耦，但是执行器需要配置调度中心集群地址。调度中心提供API供执行器回调和心跳注册服务，取消调度中心内部jetty，心跳周期调整为30s，心跳失效为三倍心跳；</p><p>5、执行参数编辑时丢失问题修复；</p><p>6、新增任务测试Demo，方便在开发时进行任务逻辑测试；</p><h3 id="7-18-版本-V1-8-0-特性-2017-07-17"><a href="#7-18-版本-V1-8-0-特性-2017-07-17" class="headerlink" title="7.18 版本 V1.8.0 特性[2017-07-17]"></a>7.18 版本 V1.8.0 特性[2017-07-17]</h3><p>1、任务Cron更新逻辑优化，改为rescheduleJob，同时防止cron重复设置；</p><p>2、API回调服务失败状态码优化，方便问题排查；</p><p>3、XxlJobLogger的日志多参数支持；</p><p>4、路由策略新增 “忙碌转移” 模式：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；</p><p>5、路由策略代码重构；</p><p>6、执行器重复注册问题修复；</p><p>7、任务线程轮空30次后自动销毁，降低低频任务的无效线程消耗。</p><p>8、执行器任务执行结果批量回调，降低回调频率提升执行器性能；</p><p>9、springboot版本执行器，取消XML配置，改为类配置方式；</p><p>10、执行日志，支持根据运行 “状态” 筛选日志；</p><p>11、调度中心任务注册检测逻辑优化；</p><h3 id="7-19-版本-V1-8-1-特性-2017-07-30"><a href="#7-19-版本-V1-8-1-特性-2017-07-30" class="headerlink" title="7.19 版本 V1.8.1 特性[2017-07-30]"></a>7.19 版本 V1.8.1 特性[2017-07-30]</h3><p>1、分片广播任务：执行器集群部署时，任务路由策略选择”分片广播”情况下，一次任务调度将会广播触发集群中所有执行器执行一次任务，可根据分片参数处理分片任务；</p><p>2、动态分片：分片广播任务以执行器为维度进行分片，支持动态扩容执行器集群从而动态增加分片数量，协同进行业务处理；在进行大数据量业务操作时可显著提升任务处理能力和速度。</p><p>3、执行器JobHandler禁止命名冲突；</p><p>4、执行器集群地址列表进行自然排序；</p><p>5、调度中心，DAO层代码精简优化并且新增测试用例覆盖；</p><p>6、调度中心API服务改为自研RPC形式，统一底层通讯模型；</p><p>7、新增调度中心API服务测试Demo，方便在调度中心API扩展和测试；</p><p>8、任务列表页交互优化，更换执行器分组时自动刷新任务列表，新建任务时默认定位在当前执行器位置；</p><p>9、访问令牌（accessToken）：为提升系统安全性，调度中心和执行器进行安全性校验，双方AccessToken匹配才允许通讯；</p><p>10、springboot版本执行器，升级至1.5.6.RELEASE版本；</p><p>11、统一maven依赖版本管理；</p><h3 id="7-20-版本-V1-8-2-特性-2017-09-04"><a href="#7-20-版本-V1-8-2-特性-2017-09-04" class="headerlink" title="7.20 版本 V1.8.2 特性[2017-09-04]"></a>7.20 版本 V1.8.2 特性[2017-09-04]</h3><p>1、项目主页搭建：提供中英文文档：<a href="https://www.xuxueli.com/xxl-job">https://www.xuxueli.com/xxl-job</a></p><p>2、JFinal执行器Sample示例项目；</p><p>3、事件触发：除了”Cron方式”和”任务依赖方式”触发任务执行之外，支持基于事件的触发任务方式。调度中心提供触发任务单次执行的API服务，可根据业务事件灵活触发。</p><p>4、执行器摘除：执行器销毁时，主动通知调度中心并摘除对应执行器节点，提高执行器状态感知的时效性。</p><p>5、执行器手动设置IP时将会绑定Host；</p><p>6、规范项目目录，方便扩展多执行器；</p><p>7、解决执行器回调URL不支持配置HTTPS时问题；</p><p>8、执行器回调线程销毁前, 批量回调队列中数据，防止任务结果丢失；</p><p>9、调度中心任务监控线程销毁时，批量对失败任务告警，防止告警信息丢失；</p><p>10、任务日志文件路径时间戳格式化时SimpleDateFormat并发问题解决；</p><h3 id="7-21-版本-V1-9-0-特性-2017-12-29"><a href="#7-21-版本-V1-9-0-特性-2017-12-29" class="headerlink" title="7.21 版本 V1.9.0 特性[2017-12-29]"></a>7.21 版本 V1.9.0 特性[2017-12-29]</h3><p>1、新增Nutz执行器Sample示例项目；</p><p>2、新增任务运行模式 “GLUE模式(NodeJS) “，支持NodeJS脚本任务；</p><p>3、脚本任务Shell、Python和Nodejs等支持获取分片参数；</p><p>4、失败重试，完整支持：调度中心调度失败且启用”失败重试”策略时，将会自动重试一次；执行器执行失败且回调失败重试状态（新增失败重试状态返回值）时，也将会自动重试一次；</p><p>5、失败告警策略扩展：默认提供邮件失败告警，可扩展短信等，扩展代码位置为 “JobFailMonitorHelper.failAlarm”；</p><p>6、执行器端口支持自动生成(小于等于0时)，避免端口定义冲突；</p><p>7、调度报表优化，支持时间区间筛选；</p><p>8、Log组件支持输出异常栈信息，底层实现优化；</p><p>9、告警邮件样式优化，调整为表格形式，邮件组件调整为commons-email简化邮件操作；</p><p>10、项目依赖全量升级至较新稳定版本，如spring、jackson等等；</p><p>11、任务日志，记录发起调度的机器信息；</p><p>12、交互优化，如登录注销；</p><p>13、任务Cron长度扩展支持至128位，支持负责类型Cron设置；</p><p>14、执行器地址录入交互优化，地址长度扩展支持至512位，支持大规模执行器集群配置；</p><p>15、任务参数“IJobHandler.execute”入参改为“String params”，增强入参通用性。</p><p>16、IJobHandler提供init&#x2F;destroy方法，支持在相应任务线程初始化和销毁时进行附加操作；</p><p>17、任务注解调整为 “<a href="https://github.com/JobHandler">@JobHandler</a>”，与任务抽象接口统一；</p><p>18、修复任务监控线程被耗时任务阻塞的问题；</p><p>19、修复任务监控线程无法监控任务触发和执行状态均未0的问题；</p><p>20、执行器动态代理对象，拦截非业务方法的执行；</p><p>21、修复JobThread捕获Error错误不更新JobLog的问题；</p><p>22、修复任务列表界面左侧菜单合并时样式错乱问题；</p><p>23、调度中心项目日志配置改为xml文件格式；</p><p>24、Log地址格式兼容，支持非”&#x2F;“结尾路径配置；</p><p>25、底层系统日志级别规范调整，清理遗留代码；</p><p>26、建表SQL优化，支持同步创建制定编码的库和表；</p><p>27、系统安全性优化，登录Token写Cookie时进行MD5加密，同时Cookie启用HttpOnly；</p><p>28、新增”任务ID”属性，移除”JobKey”属性，前者承担所有功能，方便后续增强任务依赖功能。</p><p>29、任务循环依赖问题修复，避免子任务与父任务重复导致的调度死循环；</p><p>30、任务列表新增筛选条件 “任务描述”，快速检索任务；</p><p>31、执行器Log文件定期清理功能：执行器新增配置项（”xxl.job.executor.logretentiondays”）日志保存天数，日志文件过期自动删除。</p><h3 id="7-22-版本-V1-9-1-特性-2018-02-22"><a href="#7-22-版本-V1-9-1-特性-2018-02-22" class="headerlink" title="7.22 版本 V1.9.1 特性[2018-02-22]"></a>7.22 版本 V1.9.1 特性[2018-02-22]</h3><p>1、国际化：调度中心实现国际化，支持中文、英文两种语言，默认为中文。</p><p>2、调度报表新增”运行中”中状态项；</p><p>3、调度报表优化，报表SQL调优并且新增LocalCache缓存（缓存时间60s），提高大数据量下报表加载速度；</p><p>4、修复打包部署时资源文件乱码问题；</p><p>5、修复新版本chrome滚动到顶部失效问题；</p><p>6、调度中心配置加载优化，取消对配置文件名的强依赖，支持加载磁盘配置；</p><p>7、修复脚本任务Log文件未正常close的问题；</p><p>8、项目依赖全量升级至较新稳定版本，如spring、jackson等等；</p><h3 id="7-23-版本-V1-9-2-特性-2018-10-05"><a href="#7-23-版本-V1-9-2-特性-2018-10-05" class="headerlink" title="7.23 版本 V1.9.2 特性[2018-10-05]"></a>7.23 版本 V1.9.2 特性[2018-10-05]</h3><p>1、任务超时控制：新增任务属性 “任务超时时间”，并支持自定义，任务运行超时将会主动中断任务；</p><p>2、任务失败重试次数：新增任务属性 “失败重试次数”，并支持自定义，当任务失败时将会按照预设的失败重试次数主动进行重试；同时收敛废弃其他失败重试策略，如调度失败、执行失败、状态码失败等；</p><p>3、新增任务运行模式 “GLUE模式(PHP) “，支持php脚本任务；</p><p>4、新增任务运行模式 “GLUE模式(PowerShell) “，支持PowerShell脚本任务；</p><p>5、调度全异步处理：任务触发之后，推送到调度队列，多线程并发处理调度请求，提高任务调度速率的同时，避免因网络问题导致quartz调度线程阻塞的问题；</p><p>6、执行器任务结果落盘优化：执行器回调失败时将任务结果写磁盘，待重启或网络恢复时重试回调任务结果，防止任务执行结果丢失；</p><p>7、任务日志查询速度大幅提升：百万级别数据量搜索速度提升1000倍；</p><p>8、调度中心提供API服务，支持通过API服务对任务进行查询、新增、更新、启停等操作；</p><p>9、底层自研Log组件参数占位符改为”{}”，并修复打印有参日志时参数不匹配导致报错的问题；</p><p>10、任务回调结果优化，支持展示在Rolling log中，方便问题排查；</p><p>11、底层LocalCache组件兼容性优化，支持jdk9、jdk10及以上版本编译部署；</p><p>12、告警邮件固定使用 UTF-8 编码格式，修复由机器编码导致的邮件乱码问题；</p><p>13、告警邮件中展示失败告警信息；</p><p>14、告警邮箱支持SSL配置；</p><p>15、Window机器下File.separator不兼容问题修复；</p><p>16、脚本任务异常Log输出优化；</p><p>17、任务线程停止变量修饰符优化；</p><p>18、脚本任务Log文件流关闭优化；</p><p>19、任务报表成功、失败和进行中统计问题修复；</p><p>20、核心依赖Core内部国际化处理；</p><p>21、默认Quartz线程数调整为50；</p><p>22、新增左侧菜单”运行报表”；</p><p>23、执行器手动设置IP时取消绑定Host的操作，该IP仅供执行器注册使用；修复指定外网IP时无法绑定执行器Host的问题；</p><p>24、取消父子任务不可重复的限制，支持循环任务触发等特殊场景；</p><p>25、任务调度备注中标注任务触发类型，如Cron触发、父任务触发、API触发等等，方便排查调度日志；</p><p>26、底层日志组件SimpleDateFormat线程安全问题修复；</p><p>27、执行器通讯线程优化，corePoolSize从256降低至32；</p><p>28、任务日志表状态字段类型优化；</p><p>29、GLUE脚本文件自动清理功能，及时清理过期脚本文件；</p><p>30、执行器注册方式切换优化，切换自动注册时主动同步在线机器，避免执行器为空的问题；</p><p>31、跨平台：除了提供Java、Python、PHP等十来种任务模式之外，新增提供基于HTTP的任务模式；</p><p>32、底层RPC序列化协议调整为hessian2；</p><p>33、修复表字段 “t.order”与数据库关键字冲突查询失败的问题，</p><p>34、任务属性枚举 “任务模式、阻塞策略” 国际化优化；</p><p>35、分片任务失败重试优化，仅重试当前失败的分片；</p><p>36、任务触发时支持动态传参，调度中心与API服务均提供提供动态参数功能；</p><p>37、任务执行日志、调度日志字段类型调整，改为text类型并取消字数限制；</p><p>38、GLUE任务脚本字段类型调整，改为mediumtext类型，提高GLUE长度上限；</p><p>39、任务监控线程Log输出优化，运行中任务的监控Log改为debug级别，减少非核心日志量；</p><p>40、项目依赖全量升级至较新稳定版本，如spring、Jackson、groovy等等；</p><p>41、docker支持：调度中心提供 Dockerfile 方便快速构建docker镜像；</p><h3 id="7-24-版本-V2-0-0-Release-Notes-2018-11-04"><a href="#7-24-版本-V2-0-0-Release-Notes-2018-11-04" class="headerlink" title="7.24 版本 V2.0.0 Release Notes[2018-11-04]"></a>7.24 版本 V2.0.0 Release Notes[2018-11-04]</h3><p>1、调度中心迁移到 springboot；</p><p>2、底层通讯组件迁移至 xxl-rpc；</p><p>3、容器化：提供官方docker镜像，并实时更新推送dockerhub（docker pull xuxueli&#x2F;xxl-job-admin），进一步实现产品开箱即用；</p><p>4、新增无框架执行器Sample示例项目 “xxl-job-executor-sample-frameless”。不依赖第三方框架，只需main方法即可启动运行执行器；</p><p>5、命令行任务：原生提供通用命令行任务Handler（Bean任务，”CommandJobHandler”）；业务方只需要提供命令行即可；</p><p>6、任务状态优化，仅运行状态”NORMAL”任务关联至quartz，降低quartz底层数据存储与调度压力；</p><p>7、任务状态规范：新增任务默认停止状态，任务更新时保持任务状态不变；</p><p>8、IP获取逻辑优化，优先遍历网卡来获取可用IP；</p><p>9、任务新增的API服务接口返回任务ID，方便调用方实用；</p><p>10、组件化优化，移除对 spring 的依赖：非spring应用选用 “XxlJobExecutor” 、spring应用选用 “XxlJobSpringExecutor” 作为执行器组件；</p><p>11、任务RollingLog展示逻辑优化，修复超时任务无法查看的问题；</p><p>12、多项UI组件升级到最新版本，如：CodeMirror、Echarts、Jquery 等；</p><p>13、项目依赖升级 groovy 至较新稳定版本；pom清理；</p><p>14、子任务失败重试重试逻辑优化，子任务失败时将会按照其预设的失败重试次数主动进行重试</p><h3 id="7-25-版本-v2-0-1-Release-Notes-2018-11-09"><a href="#7-25-版本-v2-0-1-Release-Notes-2018-11-09" class="headerlink" title="7.25 版本 v2.0.1 Release Notes[2018-11-09]"></a>7.25 版本 v2.0.1 Release Notes[2018-11-09]</h3><p>1、左侧菜单折叠动画问题修复；</p><p>2、调度报表日期分布图默认值统一；</p><p>3、freemarker对数字默认加千分位问题修复，解决日志ID被分隔导致查看日志失败问题；</p><p>4、底层通讯组件升级，修复通讯异常时无效等待的问题；</p><p>5、执行器启动之后jetty停止的问题修复；</p><h3 id="7-26-版本-v2-0-2-Release-Notes-2019-04-20"><a href="#7-26-版本-v2-0-2-Release-Notes-2019-04-20" class="headerlink" title="7.26 版本 v2.0.2 Release Notes[2019-04-20]"></a>7.26 版本 v2.0.2 Release Notes[2019-04-20]</h3><p>1、底层通讯方案优化：升级较新版本xxl-rpc，由”JETTY”方案调整为”NETTY_HTTP”方案，执行器内嵌netty-http-server提供服务，调度中心复用容器端口提供服务；</p><p>2、任务告警逻辑调整，改为通过扫描失败日志方式触发。一方面精确扫描失败任务，降低扫描范围；另一方面取消内存队列，降低线程内存消耗；</p><p>3、Quartz触发线程池废弃并替换为 “XxlJobThreadPool”，降低线程切换、内存占用带来的消耗，提高调度性能；</p><p>4、调度线程池隔离，拆分为”Fast”和”Slow”两个线程池，1分钟窗口期内任务耗时达500ms超过10次，该窗口期内判定为慢任务，慢任务自动降级进入”Slow”线程池，避免耗尽调度线程，提高系统稳定性；</p><p>5、执行器热部署时JobHandler重新初始化，修复由此导致的 “jobhandler naming conflicts.” 问题；</p><p>6、新增Class的加载缓存，解决频繁加载Class会使jvm的方法区空间不足导致OOM的问题；</p><p>7、任务支持更换绑定执行器，方便任务分组转移和管理；</p><p>8、调度中心告警邮件发送组件改为 “spring-boot-starter-mail”；</p><p>9、记住密码功能优化，选中时永久记住；非选中时关闭浏览器即登出；</p><p>10、项目依赖升级至较新稳定版本，如quartz、spring、jackson、groovy、xxl-rpc等等；</p><p>11、精简项目，取消第三方依赖，如 commons-collections4、commons-lang3 ;</p><p>12、执行器回调日志落盘方案复用RPC序列化方案，并移除Jackson依赖；</p><p>13、底层Log调优，应用正常终止取消异常栈信息打印；</p><p>14、交互优化，尽量避免新开页面窗口；仅WebIDE支持新开页，并提供窗口快速关闭按钮；任务启、停、删除、触发等轻操作提示改为toast方式，</p><p>15、任务暂停、删除优化，避免quartz delete不完整导致任务脏数据；</p><p>16、任务回调、心跳注册成功日志优化，非核心常规日志调整为debug级别，降低冗余日志输出；</p><p>17、调整首页报表默认区间为本周，避免日志量太大查询缓慢；</p><p>18、LRU路由更新不及时问题修复；</p><p>19、任务失败告警邮件发送逻辑优化；</p><p>20、调度日志排序逻辑调整为按照调度时间倒序，兼容TIDB等主键不连续日志存储组件；</p><p>21、执行器优雅停机优化；</p><p>22、连接池配置优化，增强连接有效性验证；</p><p>23、JobHandler#msg长度限制，修复异常情况下日志超长导致内存溢出的问题；</p><p>24、升级xxl-rpc至较新版本，修复springboot 2.x版本兼容性问题；</p><h3 id="7-27-版本-v2-1-0-Release-Notes-2019-07-07"><a href="#7-27-版本-v2-1-0-Release-Notes-2019-07-07" class="headerlink" title="7.27 版本 v2.1.0 Release Notes[2019-07-07]"></a>7.27 版本 v2.1.0 Release Notes[2019-07-07]</h3><p>1、自研调度组件，移除quartz依赖：一方面是为了精简系统降低冗余依赖，另一方面是为了提供系统的可控度与稳定性；</p><ul><li>触发：单节点周期性触发，运行事件如delayqueue；</li><li>调度：集群竞争，负载方式协同处理，锁竞争-更新触发信息-推送时间轮-锁释放-锁竞争；</li></ul><p>2、底层表结构重构：移除11张quartz相关表，并对现有表结构优化梳理；</p><p>3、任务日志主键调整为long数据类型，防止海量日志情况下数据溢出；</p><p>4、底层线程模型重构：移除Quartz线程池，降低系统线程与内存开销；</p><p>5、用户管理：支持在线管理系统用户，存在管理员、普通用户两种角色；</p><p>6、权限管理：执行器维度进行权限控制，管理员拥有全量权限，普通用户需要分配执行器权限后才允许相关操作；</p><p>7、调度线程池参数调优；</p><p>8、注册表索引优化，缓解锁表问题；</p><p>9、新增Jboot执行器Sample示例项目；</p><p>10、任务列表优化，支持根据 “任务状态”、”负责人” 属性筛选任务；</p><p>11、任务日志列表交互优化，操作按钮合并为分割按钮；</p><p>12、项目依赖升级至较新稳定版本，如spring、springboot、groovy、xxl-rpc等等；并清理冗余POM；</p><p>13、升级xxl-rpc至较新版本，修复代理服务初始化时远程服务不可用导致长连冗余创建的问题;</p><p>14、首页调度报表的日期排序在TIDB下乱序问题修复；</p><p>15、调度中心与执行器双向通讯超时时间调整为3s；</p><p>16、调度组件销毁流程优化，先停止调度线程，然后等待时间轮内存量任务处理完成，最终销毁时间轮线程；</p><p>17、执行器回调线程优化，回调地址为空时销毁问题修复；</p><p>18、HttpJobHandler优化，响应数据指定UTF-8格式，避免中文乱码；</p><p>19、代码优化，ConcurrentHashMap变量类型改为ConcurrentMap，避免因不同版本实现不同导致的兼容性问题；</p><h3 id="7-28-版本-v2-1-1-Release-Notes-2019-11-24"><a href="#7-28-版本-v2-1-1-Release-Notes-2019-11-24" class="headerlink" title="7.28 版本 v2.1.1 Release Notes[2019-11-24]"></a>7.28 版本 v2.1.1 Release Notes[2019-11-24]</h3><p>1、 调度中心日志自动清理功能（至此，调度中心&#x2F;执行器均支持日志自动清理，过期天数均默认设置为30天）：调度中心新增配置项（”xxl.job.logretentiondays”）日志保存天数，过期日志自动清理；解决海量日志情况下日志表慢SQL问题；限制大于等于7时生效，否则关闭清理功能，默认为30；</p><p>2、 调度报表优化：新增日志报表的存储表，三天内的任务日志会以每分钟一次的频率异步同步至报表中；任务报表仅读取报表数据，极大提升加载速度；</p><p>3、 Cron在线生成工具：任务新增、编辑框通过组件在线生成Cron表达式；</p><p>4、 Cron下次执行时间查询：支持通过界面在线查看后续连续5次执行时间；</p><p>5、 调度中心新增应用健康检查功能，借助“spring-boot-starter-actuator”，相对地址 “&#x2F;actuator&#x2F;health”；</p><p>6、 DB脚本默认编码改为utf8mb4，修复字符乱码问题(建议Mysql版本5.7+)；</p><p>7、 调度中心任务平均分配，触发组件每次获取与线程池数量相关数量的任务，避免大量任务集中在单个调度中心集群节点；</p><p>8、 任务触发组件优化，预加载频率正常1s一次，当预加载轮空时主动休眠一个加载周期，动态降低加载频率从而降低DB压力；</p><p>9、 调度组件优化：针对永远不会触发的Cron禁止配置和启动；任务Cron最后一次触发后再也不会触发时，比如一次性任务，主动停止相关任务；</p><p>10、DB重连优化，修复DB宕机重连后任务调度停止的问题，重连后自动加入调度集群触发任务调度；</p><p>11、注册监控线程优化，降低死锁几率；</p><p>12、调度中心日志删除优化，改为分页获取ID并根据ID删除的方式，避免批量删除海量日志导致死锁问题；</p><p>13、任务重试时参数丢失的问题修复；</p><p>14、调度中心移除SQL中的 “now()” 函数；集群部署时不再依赖DB时钟，仅需要保证调度中心应用节点时钟一致即可；</p><p>15、任务触发组件加载顺序调整，避免小概率情况下组件随机加载顺序导致的I18N的NPE问题;</p><p>16、JobThread自销毁优化，避免并发触发导致triggerQueue中任务丢失问题；</p><p>17、调度中心密码限制18位，修复修改密码超过18位无法登录的问题；</p><p>18、任务告警组件分页参数无效问题修复；</p><p>19、升级xxl-rpc版本：服务端线程优化，降低线程内存开销；IpUtil优化：增加连通性校，过滤明确非法的网卡；</p><p>20、调度中心回调API服务改为restful方式；</p><p>21、UI优化，任务列表和日志列表数据表格宽度比例调整，避免数据换行提升体验；</p><p>22、登录界面取消默认填写的登录账号密码；</p><p>23、执行器表属性调整，”顺序” 属性调整为整型，解决执行器数据较多时无法正确排序的问题；</p><p>24、任务列表交互优化，支持查看任务所属执行器的注册节点；</p><p>25、项目依赖升级至较新稳定版本，如spring、spring-boot、mybatis、slf4j、groovy等等；</p><p>26、日志组件优化：调度中心支持控制每次请求最大加载行数，日志量太大时分批请求，避免单次加载日志量太大阻塞页面；</p><h3 id="7-29-版本-v2-1-2-Release-Notes-2019-12-12"><a href="#7-29-版本-v2-1-2-Release-Notes-2019-12-12" class="headerlink" title="7.29 版本 v2.1.2 Release Notes[2019-12-12]"></a>7.29 版本 v2.1.2 Release Notes[2019-12-12]</h3><p>1、方法任务支持：由原来基于JobHandler类任务开发方式，优化为支持基于方法的任务开发方式；因此，可以支持单个类中开发多个任务方法，进行类复用</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@XxlJob</span>(<span class="hljs-string">&quot;demoJobHandler&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-title class_">ReturnT</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">execute</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> param</span>) &#123;  <br><span class="hljs-title class_">XxlJobLogger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;hello world&quot;</span>);  <br><span class="hljs-keyword">return</span> <span class="hljs-title class_">ReturnT</span>.<span class="hljs-property">SUCCESS</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>2、移除commons-exec，采用原生方式实现，降低第三方依赖；</p><p>3、执行器回调乱码问题修复；</p><p>4、调度中心dispatcher servlet加载顺序优化；</p><p>5、执行器回调地址https兼容支持；</p><p>6、多个项目依赖升级至较新稳定版本；</p><p>注意：最新版本 “XxlJobSpringExecutor” 逻辑有调整，历史项目中该组件的配置方式请参考Sample示例项目进行调整，尤其注意需要移除组件的init和destroy方法；</p><h3 id="7-30-版本-v2-2-0-Release-Notes-2020-04-14"><a href="#7-30-版本-v2-2-0-Release-Notes-2020-04-14" class="headerlink" title="7.30 版本 v2.2.0 Release Notes[2020-04-14]"></a>7.30 版本 v2.2.0 Release Notes[2020-04-14]</h3><p>1、RESTful API：调度中心与执行器提供语言无关的 RESTful API 服务，第三方任意语言可据此对接调度中心或者实现执行器。</p><p>2、任务复制功能：点击复制是弹出新建任务弹框，并初始化被复制任务信息；</p><p>3、任务手动执行一次的时候，支持指定本次执行的机器地址，为空则从执行器获取；</p><p>4、任务结果丢失处理：调度记录停留在 “运行中” 状态超过10min，且对应执行器心跳注册失败不在线，则将本地调度主动标记失败；</p><p>5、调度中心升级springboot2.x；因此，系统要求JDK8+；</p><p>6、XxlJob注解扫描方式优化，支持查找父类以及接口和基于类代理等常见情况；修复任务为空时小概率NPE问题；</p><p>7、移除旧类注解JobHandler，推荐使用基于方法注解 “<a href="https://github.com/XxlJob">@XxlJob</a>” 的方式进行任务开发；(如需保留类注解JobHandler使用方式，可以参考旧版逻辑定制开发);</p><p>8、任务告警组件模块化：如果需要新增一种告警方式，只需要新增一个实现 “com.xxl.job.admin.core.alarm.JobAlarm” 接口的告警实现即可，更加灵活、方便定制；</p><p>9、调度中心国际化完善：新增 “中文繁体” 支持。默认为 “zh_CN”&#x2F;中文简体, 可选范围为 “zh_CN”&#x2F;中文简体, “zh_TC”&#x2F;中文繁体 and “en”&#x2F;英文；</p><p>10、执行器注册逻辑优化：新增配置项 ”注册地址 &#x2F; xxl.job.executor.address“，优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题。</p><p>11、默认数据库连接池调整为hikari，移除tomcat-jdbc依赖；</p><p>12、多个项目依赖升级至较新稳定版本，如mybatis、groovy和mysql驱动等；</p><p>13、执行器优雅停机优化，修复任务线程中断未join导致回调丢失的问题；</p><p>14、一致性哈希路由策略优化：默认虚拟节点数量调整为100，提高路由的均衡性；</p><p>15、通用HTTP任务Handler（httpJobHandler）优化，扩展自定义参数信息，示例参数如下；</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">url: <span class="hljs-keyword">http</span>://www.xxx.commethod: <span class="hljs-built_in">get</span> 或 postdata: <span class="hljs-built_in">post</span>-data<br></code></pre></td></tr></table></figure><p>16、SQL脚本编码默认utf8mb4执行，避免小概率下容器环境中乱码问题；</p><p>17、Web IDE交互问题修复：输入源码备注之后按回车跳转error问题处理；</p><p>18、执行器初始化逻辑优化：修复懒加载的Bean被提前初始化问题；</p><p>19、执行器注册默认值优化；</p><p>20、修复bootstrap.min.css.map 404问题；</p><p>21、执行器UI交互优化,移除冗余order属性；</p><p>22、执行备注消息长度限制，修复数据超长无法存储导致导致回调失败的问题；<br>注意：XxlJobSpringExecutor组件个别字段调整：“appName” 调整为 “appname” ，升级时该组件时需要注意；</p><h3 id="7-31-版本-v2-3-0-Release-Notes-2021-02-09"><a href="#7-31-版本-v2-3-0-Release-Notes-2021-02-09" class="headerlink" title="7.31 版本 v2.3.0 Release Notes[2021-02-09]"></a>7.31 版本 v2.3.0 Release Notes[2021-02-09]</h3><p>1、【新增】调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等；</p><p>2、【新增】触发策略：除了常规Cron、API、父子任务触发方式外，新增提供 “固定间隔触发、（固定延时触发，实验中）” 新触发方式；</p><p>3、【新增】新增任务辅助工具 “XxlJobHelper”：提供统一任务辅助能力，包括：任务上下文信息维护获取（任务参数、任务ID、分片参数）、日志输出、任务结果设置……等；</p><ul><li>3.1、”ShardingUtil” 组件废弃：改用 “XxlJobHelper.getShardIndex()&#x2F;getShardTotal();” 获取分片参数；</li><li>3.2、”XxlJobLogger” 组件废弃：改用 “XxlJobHelper.log” 进行日志输出；</li></ul><p>4、【优化】任务核心类 “IJobHandler” 的 “execute” 方法取消出入参设计。改为通过 “XxlJobHelper.getJobParam” 获取任务参数并替代方法入参，通过 “XxlJobHelper.handleSuccess&#x2F;handleFail” 设置任务结果并替代方法出参，示例代码如下；</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@XxlJob</span>(<span class="hljs-string">&quot;demoJobHandler&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params"></span>) &#123;<br><span class="hljs-title class_">String</span> param = <span class="hljs-title class_">XxlJobHelper</span>.<span class="hljs-title function_">getJobParam</span>();    <span class="hljs-comment">// 获取参数</span><br><span class="hljs-title class_">XxlJobHelper</span>.<span class="hljs-title function_">handleSuccess</span>();                 <span class="hljs-comment">// 设置任务结果</span><br>&#125;<br></code></pre></td></tr></table></figure><p>5、【优化】Cron编辑器增强：Cron编辑器修改cron时可实时查看最近运行时间;</p><p>6、【优化】执行器示例项目规范整理；</p><p>7、【优化】任务调度生命周期重构：调度（schedule）、触发(trigger)、执行（handle）、回调(callback)、结束（complete）；</p><p>8、【优化】执行器注册组件优化：注册逻辑调整为异步方式，提高注册性能；</p><p>9、【优化】执行器鉴权校验：执行器启动时主动校验accessToken，为空则主动Warn告警；（已规划安全强化：AccessToken动态生成、动态启停等）</p><p>10、【优化】邮箱告警配置优化：将”spring.mail.from”与”spring.mail.username”属性拆分开，更加灵活的支持一些无密码邮箱服务；</p><p>11、【优化】多个项目依赖升级至较新稳定版本，如netty、groovy、spring、springboot、mybatis等；</p><p>12、【优化】UI组件常规升级，提升组件稳定性；</p><p>13、【优化】调度中心页面交互优化：用户管理模块密码列取消；多处表达autocomplete取消；执行器管理模块XSS拦截校验等；</p><p>14、【优化】调度中心任务状态探测慢SQL问题优化；</p><p>15、【修复】GLUE-Java模式任务，init&#x2F;destroy无法执行问题修复；</p><p>16、【修复】Cron编辑器问题修复：修复小概率情况下cron单个字段修改时导致其他字段被重置问题；</p><p>17、【修复】通用HTTP任务Handler（httpJobHandler）优化：修复 “setDoOutput(true)” 导致任务请求GetMethod失效问题；</p><p>18、【修复】执行器Commandhandler示例任务优化，修复极端情况下脚本进程挂起问题；</p><p>19、【修复】调度通讯组件优化，修复RestFul方式调用 DotNet 版本执行器时心跳检测失败问题；</p><p>20、【修复】调度中心远程执行日志查询乱码问题修复；</p><p>21、【修复】调度中心组件加载顺序优化，修复极端情况下调度组件初始慢导致的调度失败问题；</p><p>22、【修复】执行器注册线程优化，修复极端情况下初始化失败时导致NPE问题；</p><p>23、【修复】调度线程连接池优化，修复连接有效性校验超时问题；</p><p>24、【修复】执行器注册表字段优化，解决执行器注册节点过多导致注册信息存储和更新失败的问题；</p><p>25、【修复】轮训路由策略优化，修复小概率下并发问题；</p><p>26、【修复】页面redirect跳转后https变为http问题修复；</p><p>27、【修复】执行器日志清理优化，修复小概率下日志文件为空导致清理异常问题；</p><h3 id="7-32-版本-v2-3-1-Release-Notes-2022-05-21"><a href="#7-32-版本-v2-3-1-Release-Notes-2022-05-21" class="headerlink" title="7.32 版本 v2.3.1 Release Notes[2022-05-21]"></a>7.32 版本 v2.3.1 Release Notes[2022-05-21]</h3><p>1、【修复】修复风险漏洞，升级问题低版本项目依赖：CVE-2021-2471、CVE-2022-22965等。</p><p>2、【修复】修复故障告警逻辑，邮箱校验逻辑下放至EmailJobAlarm中，避免对其他告警方式的干扰。</p><p>3、【优化】调度通讯默认启用accessToken，提升系统安全性（建议生产环境自定义accessToken）。</p><p>4、【优化】合并多项PR，项目代码结构、健壮性优化：PR-2833、PR-2812、PR-2541、PR-2537、PR-2514、PR-2509、PR-2591。</p><p>5、【优化】任务线程名优化，提升可读性与问题定位效率(ISSUE-2527)。</p><h3 id="7-33-版本-v2-4-0-Release-Notes-规划中"><a href="#7-33-版本-v2-4-0-Release-Notes-规划中" class="headerlink" title="7.33 版本 v2.4.0 Release Notes[规划中]"></a>7.33 版本 v2.4.0 Release Notes[规划中]</h3><p>1、【优化】执行器任务Bean扫描逻辑优化：解决懒加载注解失效问题。</p><p>2、【优化】[规划中]任务日志重构：一次调度只记录一条主任务，维护起止时间和状态。</p><ul><li>普通任务：只记录一条主任务；</li><li>广播任务：记录一条主任务，每个分片任务记录一条次任务，关联在主任务上；</li><li>重试任务：失败时，新增主任务。所有调度记录，包括入口调度和重试调度，均挂载主任务上。</li></ul><p>3、【优化】[规划中]分片任务：全部完成后才会出发后置节点；</p><h3 id="7-34-新版本规划-规划中"><a href="#7-34-新版本规划-规划中" class="headerlink" title="7.34 新版本规划 [规划中]"></a>7.34 新版本规划 [规划中]</h3><p>1、[规划中]DAG流程任务</p><ul><li>DAG任务：支持参数传递，共享数据：DAG任务创建、管理，DAG任务日志查看、操作；</li><li>子任务：废弃</li></ul><p>2、[规划中]多数据库支持，DAO层通过JPA实现，不限制数据库类型；</p><p>3、[规划中]告警增强：邮件告警 + webhook告警；</p><p>4、[规划中]安全强化：AccessToken动态生成、动态启停；控制调度、回调；</p><p>5、[规划中]任务导入导出工具，灵活支持版本升级、迁移等场景。</p><h3 id="TODO-LIST"><a href="#TODO-LIST" class="headerlink" title="TODO LIST"></a>TODO LIST</h3><p>1、任务分片路由：分片采用一致性Hash算法计算出尽量稳定的分片顺序，即使注册机器存在波动也不会引起分批分片顺序大的波动；目前采用IP自然排序，可以满足需求，待定；</p><p>2、调度隔离：调度中心针对不同执行器，各自维护不同的调度和远程触发组件。</p><p>3、调度任务优先级；</p><p>4、多数据库支持，DAO层通过JPA实现，不限制数据库类型；</p><p>5、执行器Log清理功能：调度中心Log删除时同步删除执行器中的Log文件；</p><p>6、延时任务：API触发，支持”动态传参、延时消费”；该功能与 XXL-MQ 冲突，该场景建议用后者；</p><p>7、调度线程池改为协程方式实现，大幅降低系统内存消耗；</p><p>8、任务、执行器数据全量本地缓存；新增消息表广播通知；</p><p>9、忙碌转移优化，全部机器忙碌时不再直接失败；</p><p>10、任务触发参数优化：支持选择 “Cron触发”、”固定间隔时间触发”、”指定时间点触发”、”不选择” 等；</p><p>11、调度日志列表加上执行时长列，并支持排序；</p><p>12、DAG流程任务：</p><ul><li>替换子任务，支持参数传递，共享数据：</li><li>配置并列的”a-b、b-c”路径列表，构成串行、并行、dag任务流程，”dagre-d3”绘图；任务依赖，流程图，子任务+会签任务，各节点日志；支持根据成功、失败选择分支；</li><li>分片任务：全部完成后才会出发后置节点；</li></ul><p>13、日期过滤：支持多个时间段排除；</p><p>14、告警增强：</p><ul><li>邮件告警：支持自定义标题、模板格式；</li><li>webhook告警：支持自定义告警URL、请求体格式；</li></ul><p>15、新增任务运行模式 “GLUE模式(GO) “，支持GO任务；</p><p>16、GLUE 模式 Web Ide 版本对比功能；</p><p>17、注册中心优化，实时性注册发现：心跳注册间隔10s，refresh失败则首次注册并立即更新注册信息，心跳类似；30s过期销毁；</p><p>18、提供执行器Docker镜像；</p><p>19、脚本任务，支持数据参数，新版本仅支持单参数不支持需要兼容；</p><p>20、批量调度：调度请求入queue，调度线程批量获取调度请求并发起远程调度；提高线程效率；</p><p>21、执行器端口复用，复用容器端口提供通讯服务；</p><p>22、分片任务全部成功后触发子任务；</p><p>23、新增执行器描述属性；任务名称属性；</p><p>24、自定义失败重试时间间隔；</p><p>25、任务标签：方便搜索；</p><p>26、执行器：dag执行器，不需要注册机器；</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">package</span> com.xxl.job.service.handler;<br><br><span class="hljs-keyword">import</span> org.slf4j.<span class="hljs-type">Logger</span>;<br><span class="hljs-keyword">import</span> org.slf4j.<span class="hljs-type">LoggerFactory</span>;<br><br><span class="hljs-keyword">import</span> com.xxl.job.core.biz.model.<span class="hljs-type">ReturnT</span>;<br><span class="hljs-keyword">import</span> com.xxl.job.core.context.<span class="hljs-type">XxlJobHelper</span>;<br><span class="hljs-keyword">import</span> com.xxl.job.core.handler.<span class="hljs-type">IJobHandler</span>;<br><br>public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DemoGlueJobHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IJobHandler</span> </span>&#123;<br>  <br>  <span class="hljs-keyword">private</span> static transient <span class="hljs-type">Logger</span> logger = <span class="hljs-type">LoggerFactory</span>.getLogger(<span class="hljs-type">DemoGlueJobHandler</span>.<span class="hljs-keyword">class</span>);<br>   <br>  <span class="hljs-meta">@Override</span><br>public <span class="hljs-type">ReturnT</span>&lt;<span class="hljs-type">String</span>&gt; execute(<span class="hljs-type">String</span> params) <span class="hljs-keyword">throws</span> <span class="hljs-type">Exception</span> &#123;<br><span class="hljs-type">XxlJobHelper</span>.log(<span class="hljs-string">&quot;XXL-JOB, Hello World.&quot;</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-type">ReturnT</span>.<span class="hljs-type">SUCCESS</span>;<br>&#125;<br> <br><span class="hljs-meta">@Override</span><br>public void execute() <span class="hljs-keyword">throws</span> <span class="hljs-type">Exception</span> &#123;<br><span class="hljs-type">XxlJobHelper</span>.log(<span class="hljs-string">&quot;XXL-JOB, Hello World.&quot;</span>);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>中间件</category>
      
    </categories>
    
    
    <tags>
      
      <tag>定时任务框架</tag>
      
      <tag>XXL-JOB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>OpenFeign与负载均衡</title>
    <link href="/2023/03/01/%E5%BE%AE%E6%9C%8D%E5%8A%A1/OpenFeign%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    <url>/2023/03/01/%E5%BE%AE%E6%9C%8D%E5%8A%A1/OpenFeign%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</url>
    
    <content type="html"><![CDATA[<h2 id="一、Ribbon与OpenFeign关系"><a href="#一、Ribbon与OpenFeign关系" class="headerlink" title="一、Ribbon与OpenFeign关系"></a>一、Ribbon与OpenFeign关系</h2><p>　　说到 OpenFeign就不得不提 Ribbon，OpenFeign默认将Ribbon作为负载均衡器，直接内置了 Ribbon。在导入OpenFeign 依赖后无需专门导入Ribbon 依赖。</p><p>　　Ribbon 是 Netflix 公司的一个开源的负载均衡项目，一个客户端负载均衡器，运行在消费者端。简单来说就是在消费者端配置对提供者的负载均衡器。这点与 Dubbo略有不同，Dubbo 在消费者端与提供者端均可配置负载均衡器。</p><h2 id="二、声明式Rest客户端OpenFeign案例"><a href="#二、声明式Rest客户端OpenFeign案例" class="headerlink" title="二、声明式Rest客户端OpenFeign案例"></a>二、声明式Rest客户端OpenFeign案例</h2><h3 id="（一）消费端配置"><a href="#（一）消费端配置" class="headerlink" title="（一）消费端配置"></a>（一）消费端配置</h3><p>　　1、添加openfeign依赖</p><p>　　　　注意， 这里使用的是 spring-cloud-starter-openfeign 依赖，而非 spring-cloud-starter-feign依赖。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--feign依赖--&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.3.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>　　2、定义feign接口</p><p>　　　　使用@FeignClient设置需要调用的项目名称，同时使用RequestMapping进行调用，调用地址要和服务提供者的地址保持一致。</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@FeignClient</span>(value = <span class="hljs-string">&quot;provider01-depart&quot;</span>)<span class="hljs-comment">//注解作用：声明当前为Feign客户端接口</span><br><span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">&quot;/provider/depart&quot;</span>)<span class="hljs-comment">// 参数为要调用的提供者相应的uri，抽取所有方法的公有uri地址</span><br>public interface DepartService &#123;<span class="hljs-comment">//更加符合面向接口api调用习惯</span><br>    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">&quot;/save&quot;</span>)<br>    boolean <span class="hljs-built_in">saveDepart</span>(<span class="hljs-variable">@RequestBody</span> Depart depart);<br>    <span class="hljs-variable">@DeleteMapping</span>(<span class="hljs-string">&quot;/del/&#123;id&#125;&quot;</span>)<br>    boolean <span class="hljs-built_in">removeDepartById</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">&quot;id&quot;</span>) int id);<br>    <span class="hljs-variable">@PutMapping</span>(<span class="hljs-string">&quot;/update&quot;</span>)<br>    boolean <span class="hljs-built_in">modifyDepart</span>(<span class="hljs-variable">@RequestBody</span> Depart depart);<br>    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">&quot;/get/&#123;id&#125;&quot;</span>)<br>    Depart <span class="hljs-built_in">getDepartById</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">&quot;id&quot;</span>) int id);<br>    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">&quot;/list&quot;</span>)<br>    List&lt;Depart&gt; <span class="hljs-built_in">listAllDeparts</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>　　3、处理器注入Feign客户端对象</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@RestController</span><br><span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">&quot;/feign/consumer/depart&quot;</span>)<br>public class DepartFeignController &#123;<br>    <span class="hljs-variable">@Autowired</span><br>    private DepartService departService;<span class="hljs-comment">//跨服务根据id查询</span><br>    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">&quot;/get/&#123;id&#125;&quot;</span>)<br>    public Depart <span class="hljs-built_in">getHandle</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">&quot;id&quot;</span>) int id) &#123;<br>        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">departService</span><span class="hljs-selector-class">.getDepartById</span>(id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>　　4、修改启动类</p><p>　　　　使用@EnableFeignClients来打开对Feign客户端的支持，同时设置客户端扫描的包。</p><p>　　　　由于直接使用了Feign Client，因此就不再使用RestTemplate进行处理了。</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@SpringBootApplication</span><br><span class="hljs-variable">@EnableFeignClients</span>(basePackages = <span class="hljs-string">&quot;com.lcl.cloud.alibaba.consumer02.service&quot;</span>)<span class="hljs-comment">//开启当前服务支持Feign客户端，作用扫描所有客户端接口</span><br>public class Consumer02Application &#123;<br><br>    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) &#123;<br>        <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(Consumer02Application.class, args);<br>    &#125;<br><br><span class="hljs-comment">//    @Bean</span><br><span class="hljs-comment">//    @LoadBalanced</span><br><span class="hljs-comment">//    public RestTemplate restTemplate() &#123;</span><br><span class="hljs-comment">//        return new RestTemplate();</span><br><span class="hljs-comment">//    &#125;</span><br><br>&#125;<br></code></pre></td></tr></table></figure><p>　　5、需要注意的一点，就是Feign的服务名称不能使用下划线和横线，否则会报 Service id not legal hostname (provider02_nacosconfig) 的错误。</p><p><img src="/OpenFeign%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/1782729-20211014215359284-507267638.png" alt="img"></p><h3 id="（二）超时配置"><a href="#（二）超时配置" class="headerlink" title="（二）超时配置"></a>（二）超时配置</h3><p>　　1、客户端的超时配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span><br>        <span class="hljs-comment">#连接超时时间</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">5000</span><br>        <span class="hljs-comment">#数据读取超时是时间</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">5000</span><br></code></pre></td></tr></table></figure><p> 　2、服务端模拟超时　　</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public Depart get<span class="hljs-constructor">DepartById(<span class="hljs-params">int</span> <span class="hljs-params">id</span>)</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TimeUnit</span>.</span><span class="hljs-module"><span class="hljs-identifier">SECONDS</span>.</span></span>sleep(<span class="hljs-number">6</span>);<br>      &#125; catch (InterruptedException e) &#123;<br>          e.print<span class="hljs-constructor">StackTrace()</span>;<br>      &#125;<br>      <span class="hljs-keyword">if</span>(repository.exists<span class="hljs-constructor">ById(<span class="hljs-params">id</span>)</span>) &#123;<br>          return repository.get<span class="hljs-constructor">One(<span class="hljs-params">id</span>)</span>;<br>      &#125;<br>      Depart depart = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Depart()</span>;<br>      depart.set<span class="hljs-constructor">Name(<span class="hljs-params">departName</span>)</span>;<br>      return depart;<br>  &#125;<br></code></pre></td></tr></table></figure><p>　　3、验证结果</p><p><img src="/OpenFeign%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/1782729-20211014220110841-1283013534.png" alt="img"></p><h3 id="（三）Gzip压缩设置"><a href="#（三）Gzip压缩设置" class="headerlink" title="（三）Gzip压缩设置"></a>（三）Gzip压缩设置</h3><p>　　Feign 支持对请求和响应进行 Gzip 压缩以提高通信效率。注意，这里的请求是指 Feign向提供者所提交的请求，响应是指 Feign 向客户端作出的响应。</p><p><img src="/OpenFeign%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/1782729-20211014220305776-594987007.png" alt="img"></p><p>　　配置在官网中可以查看：<a href="https://docs.spring.io/spring-cloud-openfeign/docs/2.2.5.RELEASE/reference/html/#feign-requestresponse-compression">https://docs.spring.io/spring-cloud-openfeign/docs/2.2.5.RELEASE/reference/html/#feign-requestresponse-compression</a></p><p>　　参数如下所示：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">feign.compression.request.enabled</span>=<span class="hljs-literal">true</span><br><span class="hljs-attr">feign.compression.response.enabled</span>=<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h2 id="三、更换负载均衡策略"><a href="#三、更换负载均衡策略" class="headerlink" title="三、更换负载均衡策略"></a>三、更换负载均衡策略</h2><h3 id="（一）更换内置策略"><a href="#（一）更换内置策略" class="headerlink" title="（一）更换内置策略"></a>（一）更换内置策略</h3><p>　　若要更换负载均衡策略，则首先要了解负载均衡策略的定义接口 IRule。Ribbon 默认采用的是 RoundRobinRule，即轮询策略。但通过修改消费者工程的配置文件，或修改消费者的启动类或 JavaConfig 类可以实现更换负载均衡策略的目的。</p><p>　　1、修改配置文件</p><p>　　　　修改配置文件，在其中添加如下内容，指定要使用的负载均衡策略 <clientName>. <clientConfigNameSpace>.NFLoadBalancerRuleClassName。</p><p>　　　　该方式的好处是，可以为不同的微服务指定相应的负载均衡策略。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">provider02Nacosconfig:</span><br><span class="hljs-symbol">  ribbon:</span><br><span class="hljs-symbol">    NFLoadBalancerRuleClassName:</span> com.netflix.loadbalancer.RandomRule<br></code></pre></td></tr></table></figure><p>　　2、修改JavaConfig类</p><p>　　　　在 JavaConfig 类中添加负载 Bean 方法。全局所有feign对应服务都可以生效。 </p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignConfiguration</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 配置随机的负载均衡策略</span><br><span class="hljs-comment">     * 特点：对所有的服务都生效</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">IRule</span> <span class="hljs-title function_">loadBalancedRule</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomRule</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="（二）自定义负载均衡策略"><a href="#（二）自定义负载均衡策略" class="headerlink" title="（二）自定义负载均衡策略"></a>（二）自定义负载均衡策略</h3><p>　　1、定义一个负载均衡策略</p><p>　　　　该负载均衡策略的思路是：从所有可用的 provider 中排除掉指定端口号的provider，剩余 provider 进行随机选择。 </p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义负载均衡算法</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomRule</span> implements IRule &#123;<br>    <span class="hljs-keyword">private</span> ILoadBalancer lb;<br>    <span class="hljs-keyword">private</span> List&lt;Integer&gt; excludePorts;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomRule</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomRule</span><span class="hljs-params">(List&lt;Integer&gt; excludePorts)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.excludePorts = excludePorts;<br>    &#125;<br><br>    @<span class="hljs-function">Override</span><br><span class="hljs-function">    <span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">setLoadBalancer</span><span class="hljs-params">(ILoadBalancer lb)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.lb = lb;<br>    &#125;<br><br>    @<span class="hljs-function">Override</span><br><span class="hljs-function">    <span class="hljs-keyword">public</span> ILoadBalancer <span class="hljs-title">getLoadBalancer</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> lb;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 目标：自定义负载均衡策略：从所有可用的provider中排除掉指定端口号的provider，剩余provider进行随机选择</span><br><span class="hljs-comment">     * 实现步骤：</span><br><span class="hljs-comment">     * 1.获取到所有Server</span><br><span class="hljs-comment">     * 2.从所有Server中排除掉指定端口的Server后，剩余的Server</span><br><span class="hljs-comment">     * 3.从剩余Server中随机选择一个Server</span><br><span class="hljs-comment">     */</span><br>    @<span class="hljs-function">Override</span><br><span class="hljs-function">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">Server</span> <span class="hljs-title">choose</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>        <span class="hljs-comment">// 1.获取到所有Server</span><br>        List&lt;<span class="hljs-built_in">Server</span>&gt; servers = lb.<span class="hljs-built_in">getReachableServers</span>();<br>        <span class="hljs-comment">// 2.从所有Server中排除掉指定端口的Server后，剩余的Server</span><br>        List&lt;<span class="hljs-built_in">Server</span>&gt; availableServers = <span class="hljs-keyword">this</span>.<span class="hljs-built_in">getAvailableServers</span>(servers);<br>        <span class="hljs-comment">// 3.从剩余Server中随机选择一个Server</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-built_in">getAvailableRandomServers</span>(availableServers);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> List&lt;<span class="hljs-built_in">Server</span>&gt; <span class="hljs-title">getAvailableServers</span><span class="hljs-params">(List&lt;<span class="hljs-built_in">Server</span>&gt; servers)</span> </span>&#123;<br>        <span class="hljs-comment">// 若没有指定要排除的port，则返回所有Server</span><br>        <span class="hljs-keyword">if</span>(excludePorts == null || excludePorts.<span class="hljs-built_in">size</span>() == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> servers;<br>        &#125;<br>        List&lt;<span class="hljs-built_in">Server</span>&gt; aservers = servers.<span class="hljs-built_in">stream</span>()<br>                <span class="hljs-comment">// filter()</span><br>                <span class="hljs-comment">// noneMatch() 只有当流中所有元素都没有匹配上时，才返回true，只要有一个匹配上了，则返回false</span><br>                .<span class="hljs-built_in">filter</span>(server -&gt; excludePorts.<span class="hljs-built_in">stream</span>().<span class="hljs-built_in">noneMatch</span>(port -&gt; server.<span class="hljs-built_in">getPort</span>() == port))<br>                .<span class="hljs-built_in">collect</span>(Collectors.<span class="hljs-built_in">toList</span>());<br><br>        <span class="hljs-keyword">return</span> aservers;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">Server</span> <span class="hljs-title">getAvailableRandomServers</span><span class="hljs-params">(List&lt;<span class="hljs-built_in">Server</span>&gt; availableServers)</span> </span>&#123;<br>        <span class="hljs-comment">// 获取一个[0,availableServers.size())的随机数</span><br>        <span class="hljs-type">int</span> index = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Random</span>().<span class="hljs-built_in">nextInt</span>(availableServers.<span class="hljs-built_in">size</span>());<br>        <span class="hljs-keyword">return</span> availableServers.<span class="hljs-built_in">get</span>(index);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>　　2、修改JavaConfig类，使用自定义的负载均衡策略</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignConfiguration</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">IRule</span> <span class="hljs-title function_">loadBalancedRule</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Integer</span>&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        list.<span class="hljs-title function_">add</span>(<span class="hljs-number">8081</span>);<span class="hljs-comment">//排除访问端口</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomRule</span>(list);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="（三）Ribbon内置负载均衡算法"><a href="#（三）Ribbon内置负载均衡算法" class="headerlink" title="（三）Ribbon内置负载均衡算法"></a>（三）Ribbon内置负载均衡算法</h3><p>　　1、 RoundRobinRule</p><p>　　　　轮询策略：Ribbon 默认采用的策略。若经过一轮轮询没有找到可用的provider，其最多轮询 10 轮（代码中写死的，不能修改）。若还未找到，则返回 null。</p><p>　　2、RandomRule</p><p>　　　　随机策略：从所有可用的 provider 中随机选择一个。</p><p>　　3、RetryRule</p><p>　　　　重试策略：先按照 RoundRobinRule 策略获取 server，若获取失败，则在指定的时限内重试。默认的时限为 500 毫秒。</p><p>　　4、BestAvailableRule</p><p>　　　　最可用策略：选择并发量最小的 provider，即连接的消费者数量最少的provider。其会遍历服务列表中的每一个server，选择当前连接数量minimalConcurrentConnections 最小的server。</p><p>　　5、AvailabilityFilteringRule</p><p>　　　　可用过滤算法：该算法规则是过滤掉处于熔断状态的 server 与已经超过连接极限的server，对剩余 server 采用轮询策略。 </p><h2 id="四、负载均衡器SpringCloudLoadBalancer"><a href="#四、负载均衡器SpringCloudLoadBalancer" class="headerlink" title="四、负载均衡器SpringCloudLoadBalancer"></a>四、负载均衡器SpringCloudLoadBalancer</h2><p>　　由于 Netflix 对于 Ribbon 的维护已经暂停，所以 Spring Cloud 对于负载均衡建议使用由其自己定义的 Spring Cloud LoadBalancer。对于Spring Cloud LoadBalancer 的使用非常简单。</p><p>　　1、关闭Ribbon的负载均衡器</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">consumer01-depart</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">loadbalancer:</span><br>      <span class="hljs-comment"># 关闭Ribbon的负载均衡器</span><br>      <span class="hljs-attr">ribbon:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><p>　　2、pom中添加LoadBalancer依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--spring cloud loadbalancer 依赖--&gt;</span> <br>      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span> <br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span> <br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.3.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>OpenFeign</tag>
      
      <tag>负载均衡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Typora设置图片保存到文档对应目录下</title>
    <link href="/2023/02/28/Typora%E8%AE%BE%E7%BD%AE%E5%9B%BE%E7%89%87%E4%BF%9D%E5%AD%98%E5%88%B0%E6%96%87%E6%A1%A3%E5%AF%B9%E5%BA%94%E7%9B%AE%E5%BD%95%E4%B8%8B/"/>
    <url>/2023/02/28/Typora%E8%AE%BE%E7%BD%AE%E5%9B%BE%E7%89%87%E4%BF%9D%E5%AD%98%E5%88%B0%E6%96%87%E6%A1%A3%E5%AF%B9%E5%BA%94%E7%9B%AE%E5%BD%95%E4%B8%8B/</url>
    
    <content type="html"><![CDATA[<p>1、打开Typora偏好设置</p><p><img src="/Typora%E8%AE%BE%E7%BD%AE%E5%9B%BE%E7%89%87%E4%BF%9D%E5%AD%98%E5%88%B0%E6%96%87%E6%A1%A3%E5%AF%B9%E5%BA%94%E7%9B%AE%E5%BD%95%E4%B8%8B/20200511205529952.png" alt="在这里插入图片描述"></p><p>2、选择图像设置、并设置图片存储的相对路径</p><p><img src="/Typora%E8%AE%BE%E7%BD%AE%E5%9B%BE%E7%89%87%E4%BF%9D%E5%AD%98%E5%88%B0%E6%96%87%E6%A1%A3%E5%AF%B9%E5%BA%94%E7%9B%AE%E5%BD%95%E4%B8%8B/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JpY2lueQ==,size_16,color_FFFFFF,t_70.png" alt="在这里插入图片描述"></p><p>PS：图片保存的位置可自定义（相对路径表示相对于当前文档路径创建文件夹；绝对路径表示每次存储的文件路径都是同一个；推荐使用相对路径！在拷贝文档时需要连同拷贝图片文件夹）</p><p>3、格式中设置图片属性</p><p><img src="/Typora%E8%AE%BE%E7%BD%AE%E5%9B%BE%E7%89%87%E4%BF%9D%E5%AD%98%E5%88%B0%E6%96%87%E6%A1%A3%E5%AF%B9%E5%BA%94%E7%9B%AE%E5%BD%95%E4%B8%8B/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JpY2lueQ==,size_16,color_FFFFFF,t_70-16775514728844.png" alt="在这里插入图片描述"></p><p>PS：如果想将图片统一存放到指定文件夹，可设置该属性</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Typroa</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Typroa</tag>
      
      <tag>Typora工具文档设置</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java自定义注解封装</title>
    <link href="/2023/02/28/JavaWeb+SSM+SpringBoot/Spring%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3%E5%B0%81%E8%A3%85/"/>
    <url>/2023/02/28/JavaWeb+SSM+SpringBoot/Spring%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3%E5%B0%81%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h1 id="1-注解的概念"><a href="#1-注解的概念" class="headerlink" title="1 注解的概念"></a>1 注解的概念</h1><h2 id="1-1-注解的官方定义"><a href="#1-1-注解的官方定义" class="headerlink" title="1.1 注解的官方定义"></a>1.1 注解的官方定义</h2><p>官方对注解的描述</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">An annotation <span class="hljs-keyword">is</span> <span class="hljs-keyword">a</span> form of metadata, that can <span class="hljs-keyword">be</span> added <span class="hljs-keyword">to</span> Java <span class="hljs-keyword">source</span> code. Classes, methods, variables, parameters <span class="hljs-built_in">and</span> packages may <span class="hljs-keyword">be</span> annotated. Annotations have <span class="hljs-keyword">no</span> direct effect <span class="hljs-keyword">on</span> the operation of the code they annotate.<br></code></pre></td></tr></table></figure><p>注解是一种能被添加到java代码中的元数据，类、方法、变量、参数和包都可以用注解来修饰。注解对于它所修饰的代码并没有直接的影响。</p><p>故:</p><ol><li>注解是一种元数据形式。即注解是属于Java的一种数据类型，和类、接口、数组、枚举类似。</li><li>注解用来修饰类、方法、变量、参数、包。</li><li>注解不会对所修饰的代码产生直接的影响。</li></ol><h2 id="1-2-注解的使用范围"><a href="#1-2-注解的使用范围" class="headerlink" title="1.2 注解的使用范围"></a>1.2 注解的使用范围</h2><p>官方对注解的适用范围的描述</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">Annotations have <span class="hljs-keyword">a</span> <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> uses, <span class="hljs-keyword">among</span> them:Information <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> complier - Annotations can be used <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> compiler <span class="hljs-built_in">to</span> detect errors <span class="hljs-keyword">or</span> suppress warnings.Compiler-<span class="hljs-built_in">time</span> <span class="hljs-keyword">and</span> deployment-<span class="hljs-built_in">time</span> processing - Software tools can <span class="hljs-built_in">process</span> annotation information <span class="hljs-built_in">to</span> generate code, XML <span class="hljs-built_in">files</span>, <span class="hljs-keyword">and</span> so forth.Runtime processing - Some annotations are available <span class="hljs-built_in">to</span> be examined <span class="hljs-keyword">at</span> runtime.<br></code></pre></td></tr></table></figure><p>注解又许多用法，其中有：<strong>为编译器提供信息</strong> - 注解能被编译器检测到错误或抑制警告。<strong>编译时和部署时的处理</strong> - 软件工具能处理注解信息从而生成代码，XML文件等等。<strong>运行时的处理</strong> - 有些注解在运行时能被检测到。</p><h1 id="2-如何自定义注解"><a href="#2-如何自定义注解" class="headerlink" title="2 如何自定义注解"></a>2 如何自定义注解</h1><p>基于上一节，已对注解有了一个基本的认识：<strong>注解其实就是一种标记，可以在程序代码中的关键节点(类、方法、变量、参数、包)上打上这些标记，然后程序在编译时或运行时可以检测到这些标记从而执行一些特殊操作</strong>。因此可以得出自定义注解使用的基本流程：</p><ul><li><strong>第一步，定义注解——相当于定义标记。</strong></li><li><strong>第二步，配置注解——把标记打在需要用到的程序代码中。</strong></li><li><strong>第三步，解释注解——在编译期或与运行时检测到标记，并进行特殊操作。</strong></li></ul><p><img src="/Spring%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3%E5%B0%81%E8%A3%85/image-20230228100026091-16775511049171.png" alt="image-20230228100026091"></p><h2 id="2-1-基本语法"><a href="#2-1-基本语法" class="headerlink" title="2.1 基本语法"></a>2.1 基本语法</h2><p>注解类型的声明部分：</p><p>注解在Java中，与类、接口、枚举类似，因此其声明语法基本一致，只是所使用的关键字有所不同**@interface<strong>。</strong>在底层实现上，所有定义的注解都会自动继承java.lang.annotation.Annotation接口**</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">public</span> @<span class="hljs-keyword">interface</span> <span class="hljs-symbol">CherryAnnotation</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>注解类型的实现部分：</p><p>根据我们在自定义类的经验，在类的实现部分无非就是书写构造、属性或方法。但是，在自定义注解中，其实现部分只能定义一个东西：注解类型元素(annotation type element)。咱们来看看其语法：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> @interface CherryAnnotation &#123;<br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">name</span>()</span>;<br><span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">age</span>()</span>;<br><span class="hljs-function"><span class="hljs-built_in">int</span>[] <span class="hljs-title">array</span>()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>也许你会认为这不就是接口中定义抽象方法的语法嘛？那继续看看下边这个：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> @interface CherryAnnotation &#123;<br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">name</span>()</span>;<br><span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">age</span>() <span class="hljs-literal">default</span> 18</span>;<br><span class="hljs-function"><span class="hljs-built_in">int</span>[] <span class="hljs-title">array</span>()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>看到关键字default了吗？还觉得是抽象方法吗？</p><p>注解里面定义的是：注解类型元素！</p><p>定义注解类型元素时需要注意如下几点：</p><ol><li>访问修饰符必须为public，不写默认为public；</li><li>该元素的类型只能是基本数据类型、String、Class、枚举类型、注解类型（体现了注解的嵌套效果）以及上述类型的一位数组；</li><li>该元素的名称一般定义为名词，如果注解中只有一个元素，请把名字起为value（后面使用会带来便利操作）；</li><li>()不是定义方法参数的地方，也不能在括号中定义任何参数，仅仅只是一个特殊的语法；</li><li>default代表默认值，值必须和第2点定义的类型一致；</li><li>如果没有默认值，代表后续使用注解时必须给该类型元素赋值。</li></ol><p>可以看出，注解类型元素的语法非常奇怪即又有属性的特征（可以赋值）,又有方法的特征（打上了一对括号）。但是这么设计是有道理的，我们在后面的章节中可以看到：注解在定义好了以后，<strong>使用的时候操作元素类型像在操作属性，解析的时候操作元素类型像在操作方法</strong>。</p><h2 id="2-2-常用的元注解"><a href="#2-2-常用的元注解" class="headerlink" title="2.2 常用的元注解"></a>2.2 常用的元注解</h2><p>一个最最基本的注解定义就只包括了上面的两部分内容：1、注解的名字；2、注解包含的类型元素。但是，我们在使用JDK自带注解的时候发现，有些注解只能写在方法上面（比如@Override）；有些却可以写在类的上面（比如@Deprecated）。当然除此以外还有很多细节性的定义，那么这些定义该如何做呢？接下来就该元注解出场了！<br><strong>元注解：专门修饰注解的注解。</strong>它们都是为了更好的设计自定义注解的细节而专门设计的。我们为大家一个个来做介绍。</p><h3 id="2-2-1-Target"><a href="#2-2-1-Target" class="headerlink" title="2.2.1 @Target"></a>2.2.1 @Target</h3><p>@Target注解，是专门用来限定某个自定义注解能够被应用在哪些Java元素上面的。它使用一个枚举类型定义如下：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs awk">public enum ElementType &#123;<br>    <span class="hljs-regexp">/** 类，接口（包括注解类型）或枚举的声明 */</span><br>    TYPE,<br><br>    <span class="hljs-regexp">/** 属性的声明 */</span><br>    FIELD,<br><br>    <span class="hljs-regexp">/** 方法的声明 */</span><br>    METHOD,<br><br>    <span class="hljs-regexp">/** 方法形式参数声明 */</span><br>    PARAMETER,<br><br>    <span class="hljs-regexp">/** 构造方法的声明 */</span><br>    CONSTRUCTOR,<br><br>    <span class="hljs-regexp">/** 局部变量声明 */</span><br>    LOCAL_VARIABLE,<br><br>    <span class="hljs-regexp">/** 注解类型声明 */</span><br>    ANNOTATION_TYPE,<br><br>    <span class="hljs-regexp">/** 包的声明 */</span><br>    PACKAGE<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-comment">//@CherryAnnotation被限定只能使用在类、接口或方法上面</span><br><span class="hljs-variable">@Target</span>(value = &#123;ElementType.TYPE,ElementType.METHOD&#125;)<br>public <span class="hljs-variable">@interface</span> CherryAnnotation &#123;<br>    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">name</span>();<br>    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">age</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-number">18</span>;<br>    <span class="hljs-selector-tag">int</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">array</span>();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-2-Retention"><a href="#2-2-2-Retention" class="headerlink" title="2.2.2 @Retention"></a>2.2.2 @Retention</h3><p>@Retention注解，翻译为持久力、保持力。即用来修饰自定义注解的生命力。<br>注解的生命周期有三个阶段：1、Java源文件阶段；2、编译到class文件阶段；3、运行期阶段。同样使用了RetentionPolicy枚举类型定义了三个阶段：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs applescript">public enum RetentionPolicy &#123;<br>    /**<br>     * Annotations are <span class="hljs-keyword">to</span> be discarded <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> compiler.<br>     * （注解将被编译器忽略掉）<br>     */<br>    SOURCE,<br><br>    /**<br>     * Annotations are <span class="hljs-keyword">to</span> be recorded <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> <span class="hljs-built_in">class</span> <span class="hljs-built_in">file</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> compiler<br>     * <span class="hljs-keyword">but</span> need <span class="hljs-keyword">not</span> be retained <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> VM <span class="hljs-keyword">at</span> <span class="hljs-built_in">run</span> <span class="hljs-built_in">time</span>.  This <span class="hljs-keyword">is</span> <span class="hljs-keyword">the</span> default<br>     * behavior.<br>     * （注解将被编译器记录在<span class="hljs-built_in">class</span>文件中，但在运行时不会被虚拟机保留，这是一个默认的行为）<br>     */<br>    CLASS,<br><br>    /**<br>     * Annotations are <span class="hljs-keyword">to</span> be recorded <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> <span class="hljs-built_in">class</span> <span class="hljs-built_in">file</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> compiler <span class="hljs-keyword">and</span><br>     * retained <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> VM <span class="hljs-keyword">at</span> <span class="hljs-built_in">run</span> <span class="hljs-built_in">time</span>, so they may be <span class="hljs-built_in">read</span> reflectively.<br>     * （注解将被编译器记录在<span class="hljs-built_in">class</span>文件中，而且在运行时会被虚拟机保留，因此它们能通过反射被读取到）<br>     * @see java.lang.reflect.AnnotatedElement<br>     */<br>    RUNTIME<br>&#125;<br></code></pre></td></tr></table></figure><p>我们再详解一下：</p><ol><li>如果一个注解被定义为RetentionPolicy.SOURCE，则它将被限定在Java源文件中，那么这个注解即不会参与编译也不会在运行期起任何作用，这个注解就和一个注释是一样的效果，只能被阅读Java文件的人看到；</li><li>如果一个注解被定义为RetentionPolicy.CLASS，则它将被编译到Class文件中，那么编译器可以在编译时根据注解做一些处理动作，但是运行时JVM（Java虚拟机）会忽略它，我们在运行期也不能读取到；</li><li>如果一个注解被定义为RetentionPolicy.RUNTIME，那么这个注解可以在运行期的加载阶段被加载到Class对象中。那么在程序运行阶段，我们可以通过反射得到这个注解，并通过判断是否有这个注解或这个注解中属性的值，从而执行不同的程序代码段。我们实际开发中的自定义注解几乎都是使用的RetentionPolicy.RUNTIME；</li><li>在默认的情况下，自定义注解是使用的RetentionPolicy.CLASS。</li></ol><h3 id="2-2-3-Documented"><a href="#2-2-3-Documented" class="headerlink" title="2.2.3 @Documented"></a>2.2.3 @Documented</h3><p>@Documented注解，是被用来指定自定义注解是否能随着被定义的java文件生成到JavaDoc文档当中。</p><h3 id="2-2-4-Inherited"><a href="#2-2-4-Inherited" class="headerlink" title="2.2.4 @Inherited"></a>2.2.4 @Inherited</h3><p>@Inherited注解，是指定某个自定义注解如果写在了父类的声明部分，那么子类的声明部分也能自动拥有该注解。@Inherited注解只对那些@Target被定义为ElementType.TYPE的自定义注解起作用。</p><h1 id="3-自定义注解的配置使用"><a href="#3-自定义注解的配置使用" class="headerlink" title="3 自定义注解的配置使用"></a>3 自定义注解的配置使用</h1><p>回顾一下注解的使用流程：</p><ul><li><strong>第一步，定义注解——相当于定义标记；</strong></li><li><strong>第二步，配置注解——把标记打在需要用到的程序代码中；</strong></li><li><strong>第三步，解析注解——在编译期或运行时检测到标记，并进行特殊操作。</strong></li></ul><p>到目前为止我们只是完成了第一步，接下来我们就来学习第二步，配置注解，如何在另一个类当中配置它。</p><h2 id="3-1-在具体的Java类上使用注解"><a href="#3-1-在具体的Java类上使用注解" class="headerlink" title="3.1 在具体的Java类上使用注解"></a>3.1 在具体的Java类上使用注解</h2><p>首先，定义一个注解、和一个供注解修饰的简单Java类</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)<br><span class="hljs-variable">@Target</span>(value = &#123;ElementType.METHOD&#125;)<br><span class="hljs-variable">@Documented</span><br>public <span class="hljs-variable">@interface</span> CherryAnnotation &#123;<br>    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">name</span>();<br>    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">age</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-number">18</span>;<br>    <span class="hljs-selector-tag">int</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">score</span>();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> Student&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> study(<span class="hljs-keyword">int</span> <span class="hljs-keyword">times</span>)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">times</span>; i++)&#123;<br>            System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;Good Good Study, Day Day Up!&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>简单分析下：</p><ol><li>CherryAnnotation的@Target定义为ElementType.METHOD，那么它书写的位置应该在方法定义的上方，即：public void study(int times)之上；</li><li>由于我们在CherryAnnotation中定义的有注解类型元素，而且有些元素是没有默认值的，这要求我们在使用的时候必须在标记名后面打上()，并且在()内以“元素名&#x3D;元素值“的形式挨个填上所有没有默认值的注解类型元素（有默认值的也可以填上重新赋值），中间用“,”号分割；</li></ol><p>所以最终书写形式如下：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> Student &#123;<br>    @CherryAnnotation(name = <span class="hljs-string">&quot;cherry-peng&quot;</span>,age = <span class="hljs-number">23</span>,score = &#123;<span class="hljs-number">99</span>,<span class="hljs-number">66</span>,<span class="hljs-number">77</span>&#125;)<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> study(<span class="hljs-keyword">int</span> <span class="hljs-keyword">times</span>)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">times</span>; i++)&#123;<br>            System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;Good Good Study, Day Day Up!&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-2-特殊语法"><a href="#3-2-特殊语法" class="headerlink" title="3.2 特殊语法"></a>3.2 特殊语法</h2><p>特殊语法一：</p><p><strong>如果注解本身没有注解类型元素，那么在使用注解的时候可以省略()，直接写为：@注解名，它和标准语法@注解名()等效！</strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)<br><span class="hljs-variable">@Target</span>(value = &#123;ElementType.TYPE&#125;)<br><span class="hljs-variable">@Documented</span><br>public <span class="hljs-variable">@interface</span> FirstAnnotation &#123;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//等效于@FirstAnnotation()</span><br><span class="hljs-meta">@FirstAnnotation</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaBean</span>&#123;<br><span class="hljs-comment">//省略实现部分</span><br>&#125;<br></code></pre></td></tr></table></figure><p>特殊语法二：</p><p><strong>如果注解本本身只有一个注解类型元素，而且命名为value，那么在使用注解的时候可以直接使用：@注解名(注解值)，其等效于：@注解名(value &#x3D; 注解值)</strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)<br><span class="hljs-variable">@Target</span>(value = &#123;ElementType.TYPE&#125;)<br><span class="hljs-variable">@Documented</span><br>public <span class="hljs-variable">@interface</span> SecondAnnotation &#123;<br><span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">value</span>();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//等效于@ SecondAnnotation(value = &quot;this is second annotation&quot;)</span><br><span class="hljs-meta">@SecondAnnotation(<span class="hljs-string">&quot;this is annotation&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaBean</span>&#123;<br><span class="hljs-comment">//省略实现部分</span><br>&#125;<br></code></pre></td></tr></table></figure><p>特殊用法三：</p><p><strong>如果注解中的某个注解类型元素是一个数组类型，在使用时又出现只需要填入一个值的情况，那么在使用注解时可以直接写为：@注解名(类型名 &#x3D; 类型值)，它和标准写法：@注解名(类型名 &#x3D; {类型值})等效！</strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)<br><span class="hljs-variable">@Target</span>(value = &#123;ElementType.TYPE&#125;)<br><span class="hljs-variable">@Documented</span><br>public <span class="hljs-variable">@interface</span> ThirdAnnotation &#123;<br><span class="hljs-selector-tag">String</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">name</span>();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>等效于@ ThirdAnnotation(name = &#123;<span class="hljs-string">&quot;this is third annotation&quot;</span>&#125;)<br>@ ThirdAnnotation(name = <span class="hljs-string">&quot;this is third annotation&quot;</span>)<br>public class JavaBean&#123;<br><span class="hljs-regexp">//</span>省略实现部分<br>&#125;<br></code></pre></td></tr></table></figure><p>特殊用法四：</p><p><strong>如果一个注解的@Target是定义为Element.PACKAGE，那么这个注解是配置在package-info.java中的，而不能直接在某个类的package代码上面配置。</strong></p><h1 id="4-自定义注解的运行时解析"><a href="#4-自定义注解的运行时解析" class="headerlink" title="4 自定义注解的运行时解析"></a>4 自定义注解的运行时解析</h1><p>这一章是使用注解的核心，读完此章即可明白，如何<strong>在程序运行时检测到注解，并进行一系列特殊操作</strong>！</p><h2 id="4-1-回顾注解的保持力"><a href="#4-1-回顾注解的保持力" class="headerlink" title="4.1 回顾注解的保持力"></a>4.1 回顾注解的保持力</h2><p>首先回顾一下，之前自定义的注解@CherryAnnotation，并把它配置在了类Student上，代码如下：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)<br><span class="hljs-variable">@Target</span>(value = &#123;ElementType.METHOD&#125;)<br><span class="hljs-variable">@Documented</span><br>public <span class="hljs-variable">@interface</span> CherryAnnotation &#123;<br>    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">name</span>();<br>    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">age</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-number">18</span>;<br>    <span class="hljs-selector-tag">int</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">score</span>();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">package</span> pojos;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> Student &#123;<br>    @CherryAnnotation(name = <span class="hljs-string">&quot;cherry-peng&quot;</span>,age = <span class="hljs-number">23</span>,score = &#123;<span class="hljs-number">99</span>,<span class="hljs-number">66</span>,<span class="hljs-number">77</span>&#125;)<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> study(<span class="hljs-keyword">int</span> <span class="hljs-keyword">times</span>)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">times</span>; i++)&#123;<br>            System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;Good Good Study, Day Day Up!&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>注解保持力的三个阶段：</p><ol><li>Java源文件阶段；</li><li>编译到class文件阶段；</li><li>运行期阶段。</li></ol><p>只有当注解的保持力处于运行阶段，即使用<code>@Retention(RetentionPolicy.RUNTIME)</code>修饰注解时，才能在JVM运行时，检测到注解，并进行一系列特殊操作。</p><h2 id="4-2-反射操作获取注解"><a href="#4-2-反射操作获取注解" class="headerlink" title="4.2 反射操作获取注解"></a>4.2 反射操作获取注解</h2><p>因此，明确我们的目标：<strong>在运行期探究和使用编译期的内容（编译期配置的注解），要用到Java中的灵魂技术——反射！</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-built_in">public</span> <span class="hljs-keyword">class</span> TestAnnotation &#123;<br>    <span class="hljs-built_in">public</span> static <span class="hljs-type">void</span> main(String[] args)&#123;<br>        try &#123;<br>            //获取Student的<span class="hljs-keyword">Class</span>对象<br>            <span class="hljs-keyword">Class</span> stuClass = <span class="hljs-keyword">Class</span>.forName(&quot;pojos.Student&quot;);<br><br>            //说明一下，这里形参不能写成<span class="hljs-type">Integer</span>.<span class="hljs-keyword">class</span>，应写为<span class="hljs-type">int</span>.<span class="hljs-keyword">class</span><br>            <span class="hljs-keyword">Method</span> stuMethod = stuClass.getMethod(&quot;study&quot;,<span class="hljs-type">int</span>.<span class="hljs-keyword">class</span>);<br><br>            <span class="hljs-keyword">if</span>(stuMethod.isAnnotationPresent(CherryAnnotation.<span class="hljs-keyword">class</span>))&#123;<br>                <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;Student类上配置了CherryAnnotation注解！&quot;);<br>                //获取该元素上指定类型的注解<br>                CherryAnnotation cherryAnnotation = stuMethod.getAnnotation(CherryAnnotation.<span class="hljs-keyword">class</span>);<br>                <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;name: &quot; + cherryAnnotation.name() + &quot;, age: &quot; + cherryAnnotation.age()<br>                    + &quot;, score: &quot; + cherryAnnotation.score()[<span class="hljs-number">0</span>]);<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;Student类上没有配置CherryAnnotation注解！&quot;);<br>            &#125;<br>        &#125; catch (ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125; catch (NoSuchMethodException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>解释一下：</p><ol><li>如果我们要获得的注解是配置在方法上的，那么我们要从Method对象上获取；如果是配置在属性上，就需要从该属性对应的Field对象上去获取，如果是配置在类型上，需要从Class对象上去获取。总之在谁身上，就从谁身上去获取！</li><li>isAnnotationPresent(Class&lt;? extends Annotation&gt; annotationClass)方法是专门判断该元素上是否配置有某个指定的注解；</li><li>getAnnotation(Class<A> annotationClass)方法是获取该元素上指定的注解。之后再调用该注解的注解类型元素方法就可以获得配置时的值数据；</li><li>反射对象上还有一个方法getAnnotations()，该方法可以获得该对象身上配置的所有的注解。它会返回给我们一个注解数组，需要注意的是该数组的类型是Annotation类型，这个Annotation是一个来自于java.lang.annotation包的接口。</li></ol><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>JavaWeb+SSM+SpringBoot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java自定义注解封装</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>微服务框架（三）</title>
    <link href="/2023/02/27/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/"/>
    <url>/2023/02/27/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/</url>
    
    <content type="html"><![CDATA[<h1 id="微服务框架（三）"><a href="#微服务框架（三）" class="headerlink" title="微服务框架（三）"></a>微服务框架（三）</h1><h2 id="一、RabbitMQ"><a href="#一、RabbitMQ" class="headerlink" title="一、RabbitMQ"></a>一、<strong>RabbitMQ</strong></h2><h3 id="同步通讯"><a href="#同步通讯" class="headerlink" title="同步通讯"></a><strong>同步通讯</strong></h3><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230112103315060.png" alt="微服务框架-三/image-20230112103315060"></p><p>优点：</p><ul><li>时效性较强，可以立即得到结果</li></ul><p>缺点：</p><ul><li>耦合度高：每次加入新的需求，都要修改原来的代码</li><li>性能下降：调用者需要等待服务提供者响应，如果调用链过长则响应时间等于每次调用的时间之和。</li><li>资源浪费：调用链中的每个服务在等待响应过程中，不能释放请求占用的资源，高并发场景下会极度浪费系统资源</li><li>级联失败：如果服务提供者出现问题，所有调用方都会跟着出问题，如同多米诺骨牌一样，迅速导致整个微服务群故障</li></ul><h3 id="异步通讯"><a href="#异步通讯" class="headerlink" title="异步通讯"></a><strong>异步通讯</strong></h3><p>异步调用常见实现就是事件驱动模式</p><p>异步通信的优点：</p><ul><li>耦合度低</li><li>吞吐量提升</li><li>故障隔离</li><li>流量削峰</li></ul><p>异步通信的缺点：</p><ul><li>依赖于Broker的可靠性、安全性、吞吐能力</li><li>架构复杂了，业务没有明显的流程线，不好追踪管理</li></ul><h3 id="什么是MQ"><a href="#什么是MQ" class="headerlink" title="什么是MQ"></a><strong>什么是MQ</strong></h3><p>MQ（MessageQueue），消息队列，字面来看就是存放消息的队列。也就是事件驱动架构中的Broker</p><p><strong>MQ常见框架</strong></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230112103411953.png" alt="微服务框架-三/image-20230112103411953"></p><h3 id="RabbitMQ概述和安装"><a href="#RabbitMQ概述和安装" class="headerlink" title="RabbitMQ概述和安装"></a><strong>RabbitMQ概述和安装</strong></h3><p><strong>RabbitMQ的结构和概念</strong></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230112103447854.png" alt="微服务框架-三/image-20230112103447854"></p><p><strong>总结</strong></p><p>RabbitMQ中的几个概念：</p><ul><li>channel：操作MQ的工具</li><li>exchange：路由消息到队列中</li><li>queue：缓存消息</li><li>virtual host：虚拟主机，是对queue、exchange等资源的逻辑分组</li></ul><p><strong>五种常见的消息模型</strong></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230112103507805.png" alt="微服务框架-三/image-20230112103507805"></p><p>官方的BasicQueue是基于最基础的消息队列模型来实现的，只包括三个角色：</p><ul><li>publisher：消息发布这，将消息发送到队列queue</li><li>queue：消息队列，负责接受并缓存消息</li><li>consumer：订阅队列，处理队列中的消息</li></ul><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230112103521290.png" alt="微服务框架-三/image-20230112103521290"></p><p>实现步骤：</p><ul><li>导入课前资料中的demo工程</li><li><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230112103536203.png" alt="微服务框架-三/image-20230112103536203"></li><li>运行publisher服务中的测试类PublisherTest中的测试方法testSendMessage()</li><li>查看RabbitMQ控制台的消息</li><li>启动consumer服务，查看是否能接收消息</li></ul><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>基本消息队列的消息发送流程：</p><p>1.建立connection</p><p>2.创建channel</p><p>3.利用channel声明队列</p><p>4.利用channel向队列发送消息</p><p>基本消息队列的消息接收流程：</p><p>1.建立connection</p><p>2.创建channel</p><p>3.利用channel声明队列</p><p>4.定义consumer的消费行为handleDelivery()</p><p>5.利用channel将消费者与队列绑定</p><h2 id="二、SpringAMQP"><a href="#二、SpringAMQP" class="headerlink" title="二、SpringAMQP"></a>二、SpringAMQP</h2><h3 id="什么是SpringAMQP"><a href="#什么是SpringAMQP" class="headerlink" title="什么是SpringAMQP"></a><strong>什么是SpringAMQP</strong></h3><p>SpringAmqp的官方地址：<a href="https://spring.io/projects/spring-amqp">https://spring.io/projects/spring-amqp</a></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230112103039235.png" alt="微服务框架-三/image-20230112103039235"></p><h4 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h4><p>什么是AMQP？</p><ul><li>应用间消息通信的一种协议，与语言和平台无关。</li></ul><p>SpringAMQP如何发送消息？</p><ul><li>引入amqp的starter依赖</li><li>配置RabbitMQ地址</li><li>利用RabbitTemplate的convertAndSend方法</li></ul><h3 id="1、Basic-Queue简单队列模型"><a href="#1、Basic-Queue简单队列模型" class="headerlink" title="1、Basic Queue简单队列模型"></a>1、Basic Queue简单队列模型</h3><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116095803429.png" alt="微服务框架-三/image-20230116095803429"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116101927231.png" alt="微服务框架-三/image-20230116101927231"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116101940820.png" alt="微服务框架-三/image-20230116101940820"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116101959441.png" alt="微服务框架-三/image-20230116101959441"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116102014424.png" alt="微服务框架-三/image-20230116102014424"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116102040986.png" alt="微服务框架-三/image-20230116102040986"></p><h4 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h4><p>SpringAMQP如何接收消息？</p><ul><li>引入amqp的starter依赖</li><li>配置RabbitMQ地址</li><li>定义类，添加@Component注解</li><li>类中声明方法，添加@RabbitListener注解，方法参数就时消息</li></ul><p>注意：消息一旦消费就会从队列删除，RabbitMQ没有消息回溯功能</p><h3 id="2、Work-Queue工作队列模型"><a href="#2、Work-Queue工作队列模型" class="headerlink" title="2、Work Queue工作队列模型"></a>2、Work Queue工作队列模型</h3><p>Work queue，工作队列，可以提高消息处理速度，避免队列消息堆积</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116103028593.png" alt="微服务框架-三/image-20230116103028593"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116103233570.png" alt="微服务框架-三/image-20230116103233570"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116114103013.png" alt="微服务框架-三/image-20230116114103013"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116114124372.png" alt="微服务框架-三/image-20230116114124372"></p><p>观测结果为：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs dns">消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">0】10:38:08</span>.<span class="hljs-number">378</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">1】10:38:08</span>.<span class="hljs-number">402</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">2】10:38:08</span>.<span class="hljs-number">433</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">4】10:38:08</span>.<span class="hljs-number">496</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">6】10:38:08</span>.<span class="hljs-number">559</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">3】10:38:08</span>.<span class="hljs-number">617</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">8】10:38:08</span>.<span class="hljs-number">620</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">10】10:38:08</span>.<span class="hljs-number">681</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">12】10:38:08</span>.<span class="hljs-number">744</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">14】10:38:08</span>.<span class="hljs-number">807</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">5】10:38:08</span>.<span class="hljs-number">821</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">16】10:38:08</span>.<span class="hljs-number">868</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">18】10:38:08</span>.<span class="hljs-number">930</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">20】10:38:08</span>.<span class="hljs-number">994</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">7】10:38:09</span>.<span class="hljs-number">024</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">22】10:38:09</span>.<span class="hljs-number">056</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">24】10:38:09</span>.<span class="hljs-number">118</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">26】10:38:09</span>.<span class="hljs-number">180</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">9】10:38:09</span>.<span class="hljs-number">226</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">28】10:38:09</span>.<span class="hljs-number">243</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">30】10:38:09</span>.<span class="hljs-number">306</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">32】10:38:09</span>.<span class="hljs-number">368</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">11】10:38:09</span>.<span class="hljs-number">429</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">34】10:38:09</span>.<span class="hljs-number">430</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">36】10:38:09</span>.<span class="hljs-number">496</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">38】10:38:09</span>.<span class="hljs-number">557</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">40】10:38:09</span>.<span class="hljs-number">619</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">13】10:38:09</span>.<span class="hljs-number">634</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">42】10:38:09</span>.<span class="hljs-number">682</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">44】10:38:09</span>.<span class="hljs-number">745</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">46】10:38:09</span>.<span class="hljs-number">807</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">15】10:38:09</span>.<span class="hljs-number">836</span><br>消费者<span class="hljs-number">1</span>接收到消息：【hello,message__!<span class="hljs-number">48】10:38:09</span>.<span class="hljs-number">870</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">17】10:38:10</span>.<span class="hljs-number">037</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">19】10:38:10</span>.<span class="hljs-number">244</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">21】10:38:10</span>.<span class="hljs-number">451</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">23】10:38:10</span>.<span class="hljs-number">657</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">25】10:38:10</span>.<span class="hljs-number">865</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">27】10:38:11</span>.<span class="hljs-number">069</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">29】10:38:11</span>.<span class="hljs-number">270</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">31】10:38:11</span>.<span class="hljs-number">475</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">33】10:38:11</span>.<span class="hljs-number">681</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">35】10:38:11</span>.<span class="hljs-number">885</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">37】10:38:12</span>.<span class="hljs-number">091</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">39】10:38:12</span>.<span class="hljs-number">296</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">41】10:38:12</span>.<span class="hljs-number">501</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">43】10:38:12</span>.<span class="hljs-number">704</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">45】10:38:12</span>.<span class="hljs-number">909</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">47】10:38:13</span>.<span class="hljs-number">115</span><br>消费者<span class="hljs-number">2</span>........接收到消息：【hello,message__!<span class="hljs-number">49】10:38:13</span>.<span class="hljs-number">318</span><br><br></code></pre></td></tr></table></figure><h4 id="消费预取限制"><a href="#消费预取限制" class="headerlink" title="消费预取限制"></a>消费预取限制</h4><p>修改application.yml文件，设置preFetch这个值，可以控制预取消息的上限：</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116114235425.png" alt="微服务框架-三/image-20230116114235425"></p><h4 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h4><p>Work模型的使用：</p><ul><li><p>多个消费者绑定到一个队列，同一条消息只会被一个消费者处理</p></li><li><p>通过设置prefetch来控制消费者预取的消息数量</p></li></ul><h3 id="发布（Publish）、订阅（Subscribe）"><a href="#发布（Publish）、订阅（Subscribe）" class="headerlink" title="发布（Publish）、订阅（Subscribe）"></a>发布（Publish）、订阅（Subscribe）</h3><p>发布订阅模式与之前案例的区别就是允许将同一消息发送给多个消费者。实现方式是加入了exchange（交换机）。</p><p>常见exchange类型包括：</p><ul><li>Fanout：广播</li><li>Direct：路由</li><li>Topic：话题</li></ul><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116115254501.png" alt="微服务框架-三/image-20230116115254501"></p><p><strong>注意</strong>：exchange负责消息路由，而不是存储，路由失败则消息丢失</p><h3 id="3、发布、订阅模型-Fanout"><a href="#3、发布、订阅模型-Fanout" class="headerlink" title="3、发布、订阅模型-Fanout"></a>3、发布、订阅模型-Fanout</h3><p><strong>Fanout Exchange</strong> 会将接收到的消息广播到<strong>每一个</strong>跟其绑定的queue****</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116115444115.png" alt="微服务框架-三/image-20230116115444115"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116115510992.png" alt="微服务框架-三/image-20230116115510992"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116115523769.png" alt="微服务框架-三/image-20230116115523769"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230127193714513.png" alt="微服务框架-三/image-20230127193714513"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116115552283.png" alt="微服务框架-三/image-20230116115552283"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230116115600083.png" alt="微服务框架-三/image-20230116115600083"></p><h4 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h4><p>交换机的作用是什么？</p><ul><li>接收publisher发送的消息</li><li>将消息按照规则路由到与之绑定的队列</li><li>交换机不能缓存消息，如果路由失败，消息将会丢失</li><li>FanoutExchange会将消息路由到每个绑定的队列</li></ul><p>声明队列、交换机、绑定关系的Bean是什么？</p><ul><li>Queue</li><li>FanoutExchange</li><li>Binding</li></ul><h3 id="4、发布、订阅模型-Direct"><a href="#4、发布、订阅模型-Direct" class="headerlink" title="4、发布、订阅模型-Direct"></a>4、发布、订阅模型-Direct</h3><p><strong>Direct Exchange</strong> 会将接收到的消息根据规则路由到<strong>指定的Queue</strong>，因此称为路由模式（routes）。</p><ul><li>每一个Queue都与Exchange设置一个BindingKey</li><li>发布者发送消息时，指定消息的RoutingKey</li><li>Exchange将消息路由到BindingKey与消息RoutingKey一致的队列</li></ul><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230127193520315.png" alt="微服务框架-三/image-20230127193520315"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230127193620183.png" alt="微服务框架-三/image-20230127193620183"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230127193732249.png" alt="微服务框架-三/image-20230127193732249"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230127193741518.png" alt="微服务框架-三/image-20230127193741518"></p><h4 id="总结-5"><a href="#总结-5" class="headerlink" title="总结"></a>总结</h4><p>描述下Direct交换机与Fanout交换机的差异？</p><ul><li>Fanout交换机将消息路由给每一个与之绑定的队列</li><li>Direct交换机根据RoutingKey判断路由给哪个队列</li><li>如果多个队列具有相同的RoutingKey，则与Fanout功能类似</li></ul><p>基于@RabbitListener注解声明队列和交换机有哪些常见注解？</p><ul><li>@Queue</li><li>@Exchange</li></ul><h3 id="5、发布、订阅模型-Topic"><a href="#5、发布、订阅模型-Topic" class="headerlink" title="5、发布、订阅模型-Topic"></a>5、发布、订阅模型-Topic</h3><p><strong>TopicExchange</strong>与<strong>DirectExchange</strong>类似，区别在于<strong>routingKey</strong>必须是多个单词的列表，并且以 <strong>.</strong> 分割。</p><p>Queue与Exchange指定BindingKey时可以使用通配符：</p><p>#：代指0个或多个单词</p><p>*：代指一个单词</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230127230042757.png" alt="微服务框架-三/image-20230127230042757"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230127230103786.png" alt="微服务框架-三/image-20230127230103786"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230127230120951.png" alt="微服务框架-三/image-20230127230120951"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230127230137543.png" alt="微服务框架-三/image-20230127230137543"></p><h4 id="总结-6"><a href="#总结-6" class="headerlink" title="总结"></a>总结</h4><p>描述下Direct交换机与Topic交换机的差异？</p><p>•Topic交换机接收的消息RoutingKey必须是多个单词，以 <strong>.</strong> 分割</p><p>•Topic交换机与队列绑定时的bindingKey可以指定通配符</p><p>•#：代表0个或多个词</p><p>•*：代表1个词</p><h3 id="消息转换器"><a href="#消息转换器" class="headerlink" title="消息转换器"></a>消息转换器</h3><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230127231401622.png" alt="微服务框架-三/image-20230127231401622"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230127231431066.png" alt="微服务框架-三/image-20230127231431066"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%89/image-20230127231445728.png" alt="微服务框架-三/image-20230127231445728"></p><h4 id="总结-7"><a href="#总结-7" class="headerlink" title="总结"></a>总结</h4><p>SpringAMQP中消息的序列化和反序列化是怎么实现的？</p><ul><li>利用MessageConverter实现的，默认是JDK的序列化</li><li>注意发送方与接收方必须使用相同的MessageConverter</li></ul><h2 id="三、分布式搜索-elasticsearch"><a href="#三、分布式搜索-elasticsearch" class="headerlink" title="三、分布式搜索-elasticsearch"></a>三、分布式搜索-elasticsearch</h2><p>1、初识elasticsearch</p><p>2、索引库操作</p><p>3、文档操作</p><p>4、RestAPI</p><h1 id="RestClient"><a href="#RestClient" class="headerlink" title="RestClient"></a><strong>RestClient</strong></h1><h1 id="DSL查询语法"><a href="#DSL查询语法" class="headerlink" title="DSL查询语法"></a><strong>DSL查询语法</strong></h1><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>设计模式</title>
    <link href="/2022/11/04/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    <url>/2022/11/04/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="设计模式简介"><a href="#设计模式简介" class="headerlink" title="设计模式简介"></a>设计模式简介</h1><h2 id="设计模式的类型"><a href="#设计模式的类型" class="headerlink" title="设计模式的类型"></a>设计模式的类型</h2><p>根据设计模式的参考书 <strong>Design Patterns - Elements of Reusable Object-Oriented Software（中文译名：设计模式 - 可复用的面向对象软件元素）</strong> 中所提到的，总共有 23 种设计模式。这些模式可以分为三大类：创建型模式（Creational Patterns）、结构型模式（Structural Patterns）、行为型模式（Behavioral Patterns）。当然，我们还会讨论另一类设计模式：<strong>J2EE 设计模式</strong></p><table><thead><tr><th align="left">序号</th><th align="left">模式 &amp; 描述</th><th align="left">包括</th></tr></thead><tbody><tr><td align="left">1</td><td align="left"><strong>创建型模式</strong> 这些设计模式提供了一种在创建对象<br />的同时隐藏创建逻辑的方式，而不是使用 new 运<br />算符直接实例化对象。这使得程序在判断针对某<br />个给定实例需要创建哪些对象时更加灵活。</td><td align="left">工厂模式（Factory Pattern）<br />抽象工厂模式（Abstract Factory Pattern）<br />单例模式（Singleton Pattern）<br />建造者模式（Builder Pattern）<br />原型模式（Prototype Pattern）</td></tr><tr><td align="left">2</td><td align="left"><strong>结构型模式</strong> 这些设计模式关注类和对象的组合。<br />继承的概念被用来组合接口和定义组合对象获得<br />新功能的方式。</td><td align="left">适配器模式（Adapter Pattern）<br />桥接模式（Bridge Pattern）<br />过滤器模式（Filter、Criteria Pattern）<br />组合模式（Composite Pattern）<br />装饰器模式（Decorator Pattern）<br />外观模式（Facade Pattern）<br />享元模式（Flyweight Pattern）<br />代理模式（Proxy Pattern）</td></tr><tr><td align="left">3</td><td align="left"><strong>行为型模式</strong> 这些设计模式特别关注对象之间的<br />通信。</td><td align="left">责任链模式（Chain of Responsibility Pattern）<br />命令模式（Command Pattern）<br />解释器模式（Interpreter Pattern）<br />迭代器模式（Iterator Pattern）<br />中介者模式（Mediator Pattern）<br />备忘录模式（Memento Pattern）<br />观察者模式（Observer Pattern）<br />状态模式（State Pattern）<br />空对象模式（Null Object Pattern）<br />策略模式（Strategy Pattern）<br />模板模式（Template Pattern）<br />访问者模式（Visitor Pattern）</td></tr><tr><td align="left">4</td><td align="left"><strong>J2EE 模式</strong> 这些设计模式特别关注表示层。这些<br />模式是由 Sun Java Center 鉴定的。</td><td align="left">MVC 模式（MVC Pattern）<br />业务代表模式（Business Delegate Pattern）<br />组合实体模式（Composite Entity Pattern）<br />数据访问对象模式（Data Access Object Pattern）<br />前端控制器模式（Front Controller Pattern）<br />拦截过滤器模式（Intercepting Filter Pattern）<br />服务定位器模式（Service Locator Pattern）<br />传输对象模式（Transfer Object Pattern）</td></tr></tbody></table><p>设计模式之间的关系如下图所示：</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/the-relationship-between-design-patterns.jpg" alt="设计模式之间的关系"></p><h2 id="设计模式的六大原则"><a href="#设计模式的六大原则" class="headerlink" title="设计模式的六大原则"></a>设计模式的六大原则</h2><p><strong>1、开闭原则（Open Close Principle）</strong></p><p>开闭原则的意思是：<strong>对扩展开放，对修改关闭</strong>。在程序需要进行拓展的时候，不能去修改原有的代码，实现一个热插拔的效果。简言之，是为了使程序的扩展性好，易于维护和升级。想要达到这样的效果，我们需要使用接口和抽象类，后面的具体设计中我们会提到这点。</p><p><strong>2、里氏代换原则（Liskov Substitution Principle）</strong></p><p>里氏代换原则是面向对象设计的基本原则之一。 里氏代换原则中说，任何基类可以出现的地方，子类一定可以出现。LSP 是继承复用的基石，只有当派生类可以替换掉基类，且软件单位的功能不受到影响时，基类才能真正被复用，而派生类也能够在基类的基础上增加新的行为。里氏代换原则是对开闭原则的补充。实现开闭原则的关键步骤就是抽象化，而基类与子类的继承关系就是抽象化的具体实现，所以里氏代换原则是对实现抽象化的具体步骤的规范。</p><p><strong>3、依赖倒转原则（Dependence Inversion Principle）</strong></p><p>这个原则是开闭原则的基础，具体内容：针对接口编程，依赖于抽象而不依赖于具体。</p><p><strong>4、接口隔离原则（Interface Segregation Principle）</strong></p><p>这个原则的意思是：使用多个隔离的接口，比使用单个接口要好。它还有另外一个意思是：降低类之间的耦合度。由此可见，其实设计模式就是从大型软件架构出发、便于升级和维护的软件设计思想，它强调降低依赖，降低耦合。</p><p><strong>5、迪米特法则，又称最少知道原则（Demeter Principle）</strong></p><p>最少知道原则是指：一个实体应当尽量少地与其他实体之间发生相互作用，使得系统功能模块相对独立。</p><p><strong>6、合成复用原则（Composite Reuse Principle）</strong></p><p>合成复用原则是指：尽量使用合成&#x2F;聚合的方式，而不是使用继承</p><h1 id="1，设计模式概述"><a href="#1，设计模式概述" class="headerlink" title="1，设计模式概述"></a>1，设计模式概述</h1><h2 id="1-1-软件设计模式的产生背景"><a href="#1-1-软件设计模式的产生背景" class="headerlink" title="1.1 软件设计模式的产生背景"></a>1.1 软件设计模式的产生背景</h2><p>“设计模式”最初并不是出现在软件设计中，而是被用于建筑领域的设计中。</p><p>1977年美国著名建筑大师、加利福尼亚大学伯克利分校环境结构中心主任<code>克里斯托夫·亚历山大（Christopher Alexander）</code>在他的著作《建筑模式语言：城镇、建筑、构造》中描述了一些常见的建筑设计问题，并提出了 253 种关于对城镇、邻里、住宅、花园和房间等进行设计的基本模式。</p><p>1990年软件工程界开始研讨设计模式的话题，后来召开了多次关于设计模式的研讨会。直到1995 年，艾瑞克·伽马（ErichGamma）、理査德·海尔姆（Richard Helm）、拉尔夫·约翰森（Ralph Johnson）、约翰·威利斯迪斯（John Vlissides）等 4 位作者合作出版了《设计模式：可复用面向对象软件的基础》一书，在此书中收录了 23 个设计模式，这是设计模式领域里程碑的事件，导致了软件设计模式的突破。这 4 位作者在软件开发领域里也以他们的“四人组”（Gang of Four，GoF）著称。  </p><h2 id="1-2-软件设计模式的概念"><a href="#1-2-软件设计模式的概念" class="headerlink" title="1.2 软件设计模式的概念"></a>1.2 软件设计模式的概念</h2><p>软件设计模式（Software Design Pattern），又称设计模式，是一套被反复使用、多数人知晓的、经过分类编目的、代码设计经验的总结。它描述了在软件设计过程中的一些不断重复发生的问题，以及该问题的解决方案。也就是说，它是解决特定问题的一系列套路，是前辈们的代码设计经验的总结，具有一定的普遍性，可以反复使用。</p><h2 id="1-3-学习设计模式的必要性"><a href="#1-3-学习设计模式的必要性" class="headerlink" title="1.3 学习设计模式的必要性"></a>1.3 学习设计模式的必要性</h2><p>设计模式的本质是面向对象设计原则的实际运用，是对类的封装性、继承性和多态性以及类的关联关系和组合关系的充分理解。</p><p>正确使用设计模式具有以下优点。</p><ul><li>可以提高程序员的思维能力、编程能力和设计能力。</li><li>使程序设计更加标准化、代码编制更加工程化，使软件开发效率大大提高，从而缩短软件的开发周期。</li><li>使设计的代码可重用性高、可读性强、可靠性高、灵活性好、可维护性强。</li></ul><h2 id="1-4-设计模式分类"><a href="#1-4-设计模式分类" class="headerlink" title="1.4 设计模式分类"></a>1.4 设计模式分类</h2><ul><li><p><strong>创建型模式</strong></p><p>用于描述“怎样创建对象”，它的主要特点是“将对象的创建与使用分离”。GoF（四人组）书中提供了单例、原型、工厂方法、抽象工厂、建造者等 5 种创建型模式。</p></li><li><p><strong>结构型模式</strong></p><p>用于描述如何将类或对象按某种布局组成更大的结构，GoF（四人组）书中提供了代理、适配器、桥接、装饰、外观、享元、组合等 7 种结构型模式。</p></li><li><p><strong>行为型模式</strong></p><p>用于描述类或对象之间怎样相互协作共同完成单个对象无法单独完成的任务，以及怎样分配职责。GoF（四人组）书中提供了模板方法、策略、命令、职责链、状态、观察者、中介者、迭代器、访问者、备忘录、解释器等 11 种行为型模式。</p></li></ul><h1 id="2，UML图"><a href="#2，UML图" class="headerlink" title="2，UML图"></a>2，UML图</h1><p>统一建模语言（Unified Modeling Language，UML）是用来设计软件的可视化建模语言。它的特点是简单、统一、图形化、能表达软件设计中的动态与静态信息。</p><p>UML 从目标系统的不同角度出发，定义了用例图、类图、对象图、状态图、活动图、时序图、协作图、构件图、部署图等 9 种图。</p><h2 id="2-1-类图概述"><a href="#2-1-类图概述" class="headerlink" title="2.1 类图概述"></a>2.1 类图概述</h2><p>类图(Class diagram)是显示了模型的静态结构，特别是模型中存在的类、类的内部结构以及它们与其他类的关系等。类图不显示暂时性的信息。类图是面向对象建模的主要组成部分。</p><h2 id="2-2-类图的作用"><a href="#2-2-类图的作用" class="headerlink" title="2.2 类图的作用"></a>2.2 类图的作用</h2><ul><li>在软件工程中，类图是一种静态的结构图，描述了系统的类的集合，类的属性和类之间的关系，可以简化了人们对系统的理解；</li><li>类图是系统分析和设计阶段的重要产物，是系统编码和测试的重要模型。</li></ul><h2 id="2-3-类图表示法"><a href="#2-3-类图表示法" class="headerlink" title="2.3 类图表示法"></a>2.3 类图表示法</h2><h3 id="2-3-1-类的表示方式"><a href="#2-3-1-类的表示方式" class="headerlink" title="2.3.1 类的表示方式"></a>2.3.1 类的表示方式</h3><p>在UML类图中，类使用包含类名、属性(field) 和方法(method) 且带有分割线的矩形来表示，比如下图表示一个Employee类，它包含name,age和address这3个属性，以及work()方法。 </p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Employee.jpg"></p><p>属性&#x2F;方法名称前加的加号和减号表示了这个属性&#x2F;方法的可见性，UML类图中表示可见性的符号有三种：</p><ul><li><p>+：表示public</p></li><li><p>-：表示private</p></li><li><p>#：表示protected</p></li></ul><p>属性的完整表示方式是： <strong>可见性  名称 ：类型 [ &#x3D; 缺省值]</strong>  </p><p>方法的完整表示方式是： <strong>可见性  名称(参数列表) [ ： 返回类型]</strong></p><blockquote><p>注意：</p><p>​1，中括号中的内容表示是可选的</p><p>​2，也有将类型放在变量名前面，返回值类型放在方法名前面</p></blockquote><p><strong>举个栗子：</strong></p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/demo.png"></p><p>上图Demo类定义了三个方法：</p><ul><li>method()方法：修饰符为public，没有参数，没有返回值。</li><li>method1()方法：修饰符为private，没有参数，返回值类型为String。</li><li>method2()方法：修饰符为protected，接收两个参数，第一个参数类型为int，第二个参数类型为String，返回值类型是int。</li></ul><h3 id="2-3-2-类与类之间关系的表示方式"><a href="#2-3-2-类与类之间关系的表示方式" class="headerlink" title="2.3.2 类与类之间关系的表示方式"></a>2.3.2 类与类之间关系的表示方式</h3><h4 id="2-3-2-1-关联关系"><a href="#2-3-2-1-关联关系" class="headerlink" title="2.3.2.1 关联关系"></a>2.3.2.1 关联关系</h4><p>关联关系是对象之间的一种引用关系，用于表示一类对象与另一类对象之间的联系，如老师和学生、师傅和徒弟、丈夫和妻子等。<strong>关联关系是类与类之间最常用的一种关系</strong>，分为<strong>一般关联关系</strong>、<strong>聚合关系</strong>和<strong>组合关系</strong>。我们先介绍一般关联。</p><p>关联又可以分为单向关联，双向关联，自关联。</p><p><strong>1，单向关联</strong></p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/customer_address.png"></p><p>在UML类图中单向关联用一个带箭头的实线表示。上图表示每个顾客都有一个地址，这通过让Customer类持有一个类型为Address的成员变量类实现。</p><p><strong>2，双向关联</strong></p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/customer_product.png"></p><p>从上图中我们很容易看出，所谓的双向关联就是双方各自持有对方类型的成员变量。</p><p>在UML类图中，双向关联用一个不带箭头的直线表示。上图中在Customer类中维护一个List&lt;Product&gt;，表示一个顾客可以购买多个商品；在Product类中维护一个Customer类型的成员变量表示这个产品被哪个顾客所购买。</p><p><strong>3，自关联</strong></p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/node.png"></p><p>自关联在UML类图中用一个带有箭头且指向自身的线表示。上图的意思就是Node类包含类型为Node的成员变量，也就是“自己包含自己”。</p><h4 id="2-3-2-2-聚合关系"><a href="#2-3-2-2-聚合关系" class="headerlink" title="2.3.2.2 聚合关系"></a>2.3.2.2 聚合关系</h4><p>聚合关系是关联关系的一种，是强关联关系，是整体和部分之间的关系。</p><p>聚合关系也是通过成员对象来实现的，其中成员对象是整体对象的一部分，但是成员对象可以脱离整体对象而独立存在。例如，学校与老师的关系，学校包含老师，但如果学校停办了，老师依然存在。</p><p>在 UML 类图中，聚合关系可以用带空心菱形的实线来表示，菱形指向整体。下图所示是大学和教师的关系图：</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20191229173422328.png"></p><h4 id="2-3-2-3-组合关系"><a href="#2-3-2-3-组合关系" class="headerlink" title="2.3.2.3 组合关系"></a>2.3.2.3 组合关系</h4><p>组合表示类之间的整体与部分的关系，但它是一种更强烈的聚合关系。</p><p>在组合关系中，整体对象可以控制部分对象的生命周期，一旦整体对象不存在，部分对象也将不存在，部分对象不能脱离整体对象而存在。例如，头和嘴的关系，没有了头，嘴也就不存在了。</p><p>在 UML 类图中，组合关系用带实心菱形的实线来表示，菱形指向整体。下图所示是头和嘴的关系图：</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20191229173455149.png"></p><h4 id="2-3-2-4-依赖关系"><a href="#2-3-2-4-依赖关系" class="headerlink" title="2.3.2.4 依赖关系"></a>2.3.2.4 依赖关系</h4><p>依赖关系是一种使用关系，它是对象之间耦合度最弱的一种关联方式，是临时性的关联。在代码中，某个类的方法通过局部变量、方法的参数或者对静态方法的调用来访问另一个类（被依赖类）中的某些方法来完成一些职责。</p><p>在 UML 类图中，依赖关系使用带箭头的虚线来表示，箭头从使用类指向被依赖的类。下图所示是司机和汽车的关系图，司机驾驶汽车：</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20191229173518926.png"></p><h4 id="2-3-2-5-继承关系"><a href="#2-3-2-5-继承关系" class="headerlink" title="2.3.2.5 继承关系"></a>2.3.2.5 继承关系</h4><p>继承关系是对象之间耦合度最大的一种关系，表示一般与特殊的关系，是父类与子类之间的关系，是一种继承关系。</p><p>在 UML 类图中，泛化关系（继承关系）用带空心三角箭头的实线来表示，箭头从子类指向父类。在代码实现时，使用面向对象的继承机制来实现泛化关系。例如，Student 类和 Teacher 类都是 Person 类的子类，其类图如下图所示：</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20191229173539838.png"></p><h4 id="2-3-2-6-实现关系"><a href="#2-3-2-6-实现关系" class="headerlink" title="2.3.2.6 实现关系"></a>2.3.2.6 实现关系</h4><p>实现关系是接口与实现类之间的关系。在这种关系中，类实现了接口，类中的操作实现了接口中所声明的所有的抽象操作。</p><p>在 UML 类图中，实现关系使用带空心三角箭头的虚线来表示，箭头从实现类指向接口。例如，汽车和船实现了交通工具，其类图如图 9 所示。</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20191229173554296.png"></p><h1 id="3，软件设计原则"><a href="#3，软件设计原则" class="headerlink" title="3，软件设计原则"></a>3，软件设计原则</h1><p>在软件开发中，为了提高软件系统的可维护性和可复用性，增加软件的可扩展性和灵活性，程序员要尽量根据6条原则来开发程序，从而提高软件开发效率、节约软件开发成本和维护成本。</p><h2 id="3-1-开闭原则"><a href="#3-1-开闭原则" class="headerlink" title="3.1 开闭原则"></a>3.1 开闭原则</h2><p><strong>对扩展开放，对修改关闭</strong>。在程序需要进行拓展的时候，不能去修改原有的代码，实现一个热插拔的效果。简言之，是为了使程序的扩展性好，易于维护和升级。</p><p>想要达到这样的效果，我们需要使用接口和抽象类。</p><p>因为抽象灵活性好，适应性广，只要抽象的合理，可以基本保持软件架构的稳定。而软件中易变的细节可以从抽象派生来的实现类来进行扩展，当软件需要发生变化时，只需要根据需求重新派生一个实现类来扩展就可以了。</p><p>下面以 <code>搜狗输入法</code> 的皮肤为例介绍开闭原则的应用。</p><p>【例】<code>搜狗输入法</code> 的皮肤设计。</p><p>分析：<code>搜狗输入法</code> 的皮肤是输入法背景图片、窗口颜色和声音等元素的组合。用户可以根据自己的喜爱更换自己的输入法的皮肤，也可以从网上下载新的皮肤。这些皮肤有共同的特点，可以为其定义一个抽象类（AbstractSkin），而每个具体的皮肤（DefaultSpecificSkin和HeimaSpecificSkin）是其子类。用户窗体可以根据需要选择或者增加新的主题，而不需要修改原代码，所以它是满足开闭原则的。</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/open-close.png"></p><h2 id="3-2-里氏代换原则"><a href="#3-2-里氏代换原则" class="headerlink" title="3.2 里氏代换原则"></a>3.2 里氏代换原则</h2><p>里氏代换原则是面向对象设计的基本原则之一。</p><p>里氏代换原则：任何基类可以出现的地方，子类一定可以出现。通俗理解：<strong>子类可以扩展父类的功能，但不能改变父类原有的功能。</strong>换句话说，子类继承父类时，除添加新的方法完成新增功能外，尽量不要重写父类的方法。</p><p>如果通过重写父类的方法来完成新的功能，这样写起来虽然简单，但是整个继承体系的可复用性会比较差，特别是运用多态比较频繁时，程序运行出错的概率会非常大。</p><p>下面看一个里氏替换原则中经典的一个例子</p><p>【例】正方形不是长方形。</p><p>在数学领域里，正方形毫无疑问是长方形，它是一个长宽相等的长方形。所以，我们开发的一个与几何图形相关的软件系统，就可以顺理成章的让正方形继承自长方形。</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%AD%A3%E6%96%B9%E5%BD%A2%E4%B8%8D%E6%98%AF%E9%95%BF%E6%96%B9%E5%BD%A2.png"></p><p>代码如下：</p><p><strong>长方形类（Rectangle）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> length;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> width;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getLength</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> length;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLength</span><span class="hljs-params">(<span class="hljs-type">double</span> length)</span> &#123;<br>        <span class="hljs-built_in">this</span>.length = length;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getWidth</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> width;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWidth</span><span class="hljs-params">(<span class="hljs-type">double</span> width)</span> &#123;<br>        <span class="hljs-built_in">this</span>.width = width;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>正方形（Square）：</strong></p><p>由于正方形的长和宽相同，所以在方法setLength和setWidth中，对长度和宽度都需要赋相同值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Square</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Rectangle</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWidth</span><span class="hljs-params">(<span class="hljs-type">double</span> width)</span> &#123;<br>        <span class="hljs-built_in">super</span>.setLength(width);<br>        <span class="hljs-built_in">super</span>.setWidth(width);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLength</span><span class="hljs-params">(<span class="hljs-type">double</span> length)</span> &#123;<br>        <span class="hljs-built_in">super</span>.setLength(length);<br>        <span class="hljs-built_in">super</span>.setWidth(length);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>类RectangleDemo是我们的软件系统中的一个组件，它有一个resize方法依赖基类Rectangle，resize方法是RectandleDemo类中的一个方法，用来实现宽度逐渐增长的效果。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RectangleDemo</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resize</span><span class="hljs-params">(Rectangle rectangle)</span> &#123;<br>        <span class="hljs-keyword">while</span> (rectangle.getWidth() &lt;= rectangle.getLength()) &#123;<br>            rectangle.setWidth(rectangle.getWidth() + <span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//打印长方形的长和宽</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printLengthAndWidth</span><span class="hljs-params">(Rectangle rectangle)</span> &#123;<br>        System.out.println(rectangle.getLength());<br>        System.out.println(rectangle.getWidth());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Rectangle</span> <span class="hljs-variable">rectangle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rectangle</span>();<br>        rectangle.setLength(<span class="hljs-number">20</span>);<br>        rectangle.setWidth(<span class="hljs-number">10</span>);<br>        resize(rectangle);<br>        printLengthAndWidth(rectangle);<br><br>        System.out.println(<span class="hljs-string">&quot;============&quot;</span>);<br><br>        <span class="hljs-type">Rectangle</span> <span class="hljs-variable">rectangle1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Square</span>();<br>        rectangle1.setLength(<span class="hljs-number">10</span>);<br>        resize(rectangle1);<br>        printLengthAndWidth(rectangle1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们运行一下这段代码就会发现，假如我们把一个普通长方形作为参数传入resize方法，就会看到长方形宽度逐渐增长的效果，当宽度大于长度,代码就会停止，这种行为的结果符合我们的预期；假如我们再把一个正方形作为参数传入resize方法后，就会看到正方形的宽度和长度都在不断增长，代码会一直运行下去，直至系统产生溢出错误。所以，普通的长方形是适合这段代码的，正方形不适合。<br>我们得出结论：在resize方法中，Rectangle类型的参数是不能被Square类型的参数所代替，如果进行了替换就得不到预期结果。因此，Square类和Rectangle类之间的继承关系违反了里氏代换原则，它们之间的继承关系不成立，正方形不是长方形。</p><p>如何改进呢？此时我们需要重新设计他们之间的关系。抽象出来一个四边形接口(Quadrilateral)，让Rectangle类和Square类实现Quadrilateral接口</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%AD%A3%E6%96%B9%E5%BD%A2%E4%B8%8D%E6%98%AF%E9%95%BF%E6%96%B9%E5%BD%A2%E6%94%B9%E8%BF%9B.png" style="zoom:80%;" /><h2 id="3-3-依赖倒转原则"><a href="#3-3-依赖倒转原则" class="headerlink" title="3.3 依赖倒转原则"></a>3.3 依赖倒转原则</h2><p>高层模块不应该依赖低层模块，两者都应该依赖其抽象；抽象不应该依赖细节，细节应该依赖抽象。简单的说就是要求对抽象进行编程，不要对实现进行编程，这样就降低了客户与实现模块间的耦合。</p><p>下面看一个例子来理解依赖倒转原则</p><p>【例】组装电脑</p><p>现要组装一台电脑，需要配件cpu，硬盘，内存条。只有这些配置都有了，计算机才能正常的运行。选择cpu有很多选择，如Intel，AMD等，硬盘可以选择希捷，西数等，内存条可以选择金士顿，海盗船等。</p><p><strong>类图如下：</strong></p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E4%BE%9D%E8%B5%96%E5%80%92%E8%BD%AC%E5%8E%9F%E5%88%99.png" style="zoom:80%;" /><p>代码如下：</p><p><strong>希捷硬盘类（XiJieHardDisk）:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XiJieHardDisk</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HardDisk</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(String data)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;使用希捷硬盘存储数据&quot;</span> + data);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;使用希捷希捷硬盘取数据&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;数据&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Intel处理器（IntelCpu）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntelCpu</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cpu</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;使用Intel处理器&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>金士顿内存条（KingstonMemory）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KingstonMemory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Memory</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;使用金士顿作为内存条&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>电脑（Computer）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Computer</span> &#123;<br><br>    <span class="hljs-keyword">private</span> XiJieHardDisk hardDisk;<br>    <span class="hljs-keyword">private</span> IntelCpu cpu;<br>    <span class="hljs-keyword">private</span> KingstonMemory memory;<br><br>    <span class="hljs-keyword">public</span> IntelCpu <span class="hljs-title function_">getCpu</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> cpu;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCpu</span><span class="hljs-params">(IntelCpu cpu)</span> &#123;<br>        <span class="hljs-built_in">this</span>.cpu = cpu;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> KingstonMemory <span class="hljs-title function_">getMemory</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> memory;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMemory</span><span class="hljs-params">(KingstonMemory memory)</span> &#123;<br>        <span class="hljs-built_in">this</span>.memory = memory;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> XiJieHardDisk <span class="hljs-title function_">getHardDisk</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> hardDisk;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHardDisk</span><span class="hljs-params">(XiJieHardDisk hardDisk)</span> &#123;<br>        <span class="hljs-built_in">this</span>.hardDisk = hardDisk;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;计算机工作&quot;</span>);<br>        cpu.run();<br>        memory.save();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> hardDisk.get();<br>        System.out.println(<span class="hljs-string">&quot;从硬盘中获取的数据为：&quot;</span> + data);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>测试类（TestComputer）：</strong></p><p>测试类用来组装电脑。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestComputer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Computer</span> <span class="hljs-variable">computer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Computer</span>();<br>        computer.setHardDisk(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XiJieHardDisk</span>());<br>        computer.setCpu(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IntelCpu</span>());<br>        computer.setMemory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">KingstonMemory</span>());<br><br>        computer.run();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>上面代码可以看到已经组装了一台电脑，但是似乎组装的电脑的cpu只能是Intel的，内存条只能是金士顿的，硬盘只能是希捷的，这对用户肯定是不友好的，用户有了机箱肯定是想按照自己的喜好，选择自己喜欢的配件。</p><p>根据依赖倒转原则进行改进：</p><p>代码我们只需要修改Computer类，让Computer类依赖抽象（各个配件的接口），而不是依赖于各个组件具体的实现类。</p><p><strong>类图如下：</strong></p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E4%BE%9D%E8%B5%96%E5%80%92%E8%BD%AC%E5%8E%9F%E5%88%99%E6%94%B9%E8%BF%9B.png" alt="image-20191229173554296" style="zoom:70%;" /><p><strong>电脑（Computer）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Computer</span> &#123;<br><br>    <span class="hljs-keyword">private</span> HardDisk hardDisk;<br>    <span class="hljs-keyword">private</span> Cpu cpu;<br>    <span class="hljs-keyword">private</span> Memory memory;<br><br>    <span class="hljs-keyword">public</span> HardDisk <span class="hljs-title function_">getHardDisk</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> hardDisk;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHardDisk</span><span class="hljs-params">(HardDisk hardDisk)</span> &#123;<br>        <span class="hljs-built_in">this</span>.hardDisk = hardDisk;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Cpu <span class="hljs-title function_">getCpu</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> cpu;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCpu</span><span class="hljs-params">(Cpu cpu)</span> &#123;<br>        <span class="hljs-built_in">this</span>.cpu = cpu;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Memory <span class="hljs-title function_">getMemory</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> memory;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMemory</span><span class="hljs-params">(Memory memory)</span> &#123;<br>        <span class="hljs-built_in">this</span>.memory = memory;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;计算机工作&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>面向对象的开发很好的解决了这个问题，一般情况下抽象的变化概率很小，让用户程序依赖于抽象，实现的细节也依赖于抽象。即使实现细节不断变动，只要抽象不变，客户程序就不需要变化。这大大降低了客户程序与实现细节的耦合度。</p><h2 id="3-4-接口隔离原则"><a href="#3-4-接口隔离原则" class="headerlink" title="3.4 接口隔离原则"></a>3.4 接口隔离原则</h2><p>客户端不应该被迫依赖于它不使用的方法；一个类对另一个类的依赖应该建立在最小的接口上。</p><p>下面看一个例子来理解接口隔离原则</p><p>【例】安全门案例</p><p>我们需要创建一个<code>黑马</code>品牌的安全门，该安全门具有防火、防水、防盗的功能。可以将防火，防水，防盗功能提取成一个接口，形成一套规范。类图如下：</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99.png"></p><p>上面的设计我们发现了它存在的问题，黑马品牌的安全门具有防盗，防水，防火的功能。现在如果我们还需要再创建一个传智品牌的安全门，而该安全门只具有防盗、防水功能呢？很显然如果实现SafetyDoor接口就违背了接口隔离原则，那么我们如何进行修改呢？看如下类图：</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%991.png"></p><p>代码如下：</p><p><strong>AntiTheft（接口）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AntiTheft</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">antiTheft</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Fireproof（接口）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Fireproof</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">fireproof</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Waterproof（接口）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Waterproof</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">waterproof</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>HeiMaSafetyDoor（类）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeiMaSafetyDoor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AntiTheft</span>,Fireproof,Waterproof &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">antiTheft</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;防盗&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fireproof</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;防火&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">waterproof</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;防水&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ItcastSafetyDoor（类）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItcastSafetyDoor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AntiTheft</span>,Fireproof &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">antiTheft</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;防盗&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fireproof</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;防火&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-5-迪米特法则"><a href="#3-5-迪米特法则" class="headerlink" title="3.5 迪米特法则"></a>3.5 迪米特法则</h2><p>迪米特法则又叫最少知识原则。</p><p>只和你的直接朋友交谈，不跟“陌生人”说话（Talk only to your immediate friends and not to strangers）。</p><p>其含义是：如果两个软件实体无须直接通信，那么就不应当发生直接的相互调用，可以通过第三方转发该调用。其目的是降低类之间的耦合度，提高模块的相对独立性。</p><p>迪米特法则中的“朋友”是指：当前对象本身、当前对象的成员对象、当前对象所创建的对象、当前对象的方法参数等，这些对象同当前对象存在关联、聚合或组合关系，可以直接访问这些对象的方法。</p><p>下面看一个例子来理解迪米特法则</p><p>【例】明星与经纪人的关系实例</p><p>明星由于全身心投入艺术，所以许多日常事务由经纪人负责处理，如和粉丝的见面会，和媒体公司的业务洽淡等。这里的经纪人是明星的朋友，而粉丝和媒体公司是陌生人，所以适合使用迪米特法则。</p><p>类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%BF%AA%E7%B1%B3%E7%89%B9%E6%B3%95%E5%88%99.png" alt="image-20191229173554296" style="zoom:80%;" /><p>代码如下：</p><p><strong>明星类（Star）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Star</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Star</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name=name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>粉丝类（Fans）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Fans</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Fans</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name=name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>媒体公司类（Company）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Company</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Company</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name=name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>经纪人类（Agent）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Agent</span> &#123;<br>    <span class="hljs-keyword">private</span> Star star;<br>    <span class="hljs-keyword">private</span> Fans fans;<br>    <span class="hljs-keyword">private</span> Company company;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStar</span><span class="hljs-params">(Star star)</span> &#123;<br>        <span class="hljs-built_in">this</span>.star = star;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFans</span><span class="hljs-params">(Fans fans)</span> &#123;<br>        <span class="hljs-built_in">this</span>.fans = fans;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCompany</span><span class="hljs-params">(Company company)</span> &#123;<br>        <span class="hljs-built_in">this</span>.company = company;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">meeting</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(fans.getName() + <span class="hljs-string">&quot;与明星&quot;</span> + star.getName() + <span class="hljs-string">&quot;见面了。&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">business</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(company.getName() + <span class="hljs-string">&quot;与明星&quot;</span> + star.getName() + <span class="hljs-string">&quot;洽淡业务。&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-6-合成复用原则"><a href="#3-6-合成复用原则" class="headerlink" title="3.6 合成复用原则"></a>3.6 合成复用原则</h2><p>合成复用原则是指：尽量先使用组合或者聚合等关联关系来实现，其次才考虑使用继承关系来实现。</p><p>通常类的复用分为继承复用和合成复用两种。</p><p>继承复用虽然有简单和易实现的优点，但它也存在以下缺点：</p><ol><li>继承复用破坏了类的封装性。因为继承会将父类的实现细节暴露给子类，父类对子类是透明的，所以这种复用又称为“白箱”复用。</li><li>子类与父类的耦合度高。父类的实现的任何改变都会导致子类的实现发生变化，这不利于类的扩展与维护。</li><li>它限制了复用的灵活性。从父类继承而来的实现是静态的，在编译时已经定义，所以在运行时不可能发生变化。</li></ol><p>采用组合或聚合复用时，可以将已有对象纳入新对象中，使之成为新对象的一部分，新对象可以调用已有对象的功能，它有以下优点：</p><ol><li>它维持了类的封装性。因为成分对象的内部细节是新对象看不见的，所以这种复用又称为“黑箱”复用。</li><li>对象间的耦合度低。可以在类的成员位置声明抽象。</li><li>复用的灵活性高。这种复用可以在运行时动态进行，新对象可以动态地引用与成分对象类型相同的对象。</li></ol><p>下面看一个例子来理解合成复用原则</p><p>【例】汽车分类管理程序</p><p>汽车按“动力源”划分可分为汽油汽车、电动汽车等；按“颜色”划分可分为白色汽车、黑色汽车和红色汽车等。如果同时考虑这两种分类，其组合就很多。类图如下： </p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%90%88%E6%88%90%E5%A4%8D%E7%94%A8%E5%8E%9F%E5%88%99.png" alt="image-20191229173554296" style="zoom:80%;" /><p>从上面类图我们可以看到使用继承复用产生了很多子类，如果现在又有新的动力源或者新的颜色的话，就需要再定义新的类。我们试着将继承复用改为聚合复用看一下。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%90%88%E6%88%90%E5%A4%8D%E7%94%A8%E5%8E%9F%E5%88%991.png" alt="image-20191229173554296" style="zoom:80%;" /><h1 id="4，创建者模式"><a href="#4，创建者模式" class="headerlink" title="4，创建者模式"></a>4，创建者模式</h1><p>创建型模式的主要关注点是“怎样创建对象？”，它的主要特点是“将对象的创建与使用分离”。</p><p>这样可以降低系统的耦合度，使用者不需要关注对象的创建细节。</p><p>创建型模式分为：</p><ul><li>单例模式</li><li>工厂方法模式</li><li>抽象工程模式</li><li>原型模式</li><li>建造者模式</li></ul><h2 id="4-1-单例设计模式"><a href="#4-1-单例设计模式" class="headerlink" title="4.1 单例设计模式"></a>4.1 单例设计模式</h2><p>单例模式（Singleton Pattern）是 Java 中最简单的设计模式之一。这种类型的设计模式属于创建型模式，它提供了一种创建对象的最佳方式。</p><p>这种模式涉及到一个单一的类，该类负责创建自己的对象，同时确保只有单个对象被创建。这个类提供了一种访问其唯一的对象的方式，可以直接访问，不需要实例化该类的对象。</p><h3 id="4-1-1-单例模式的结构"><a href="#4-1-1-单例模式的结构" class="headerlink" title="4.1.1 单例模式的结构"></a>4.1.1 单例模式的结构</h3><p>单例模式的主要有以下角色：</p><ul><li>单例类。只能创建一个实例的类</li><li>访问类。使用单例类</li></ul><h3 id="4-1-2-单例模式的实现"><a href="#4-1-2-单例模式的实现" class="headerlink" title="4.1.2 单例模式的实现"></a>4.1.2 单例模式的实现</h3><blockquote><p>单例设计模式分类两种：</p><p>​饿汉式：类加载就会导致该单实例对象被创建</p><p>​懒汉式：类加载不会导致该单实例对象被创建，而是首次使用该对象时才会创建</p></blockquote><ol><li><p>饿汉式-方式1（静态变量方式）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 饿汉式</span><br><span class="hljs-comment"> *      静态变量创建类的对象</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    <span class="hljs-comment">//私有构造方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-comment">//在成员位置创建该类的对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br><br>    <span class="hljs-comment">//对外提供静态方法获取该对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><font color='red'>说明：</font></p><p>​该方式在成员位置声明Singleton类型的静态变量，并创建Singleton类的对象instance。instance对象是随着类的加载而创建的。如果该对象足够大的话，而一直没有使用就会造成内存的浪费。</p></li><li><p>饿汉式-方式2（静态代码块方式）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 恶汉式</span><br><span class="hljs-comment"> *      在静态代码块中创建该类对象</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br><br>    <span class="hljs-comment">//私有构造方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-comment">//在成员位置创建该类的对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Singleton instance;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>    &#125;<br><br>    <span class="hljs-comment">//对外提供静态方法获取该对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><font color='red'>说明：</font></p><p>​该方式在成员位置声明Singleton类型的静态变量，而对象的创建是在静态代码块中，也是对着类的加载而创建。所以和饿汉式的方式1基本上一样，当然该方式也存在内存浪费问题。</p></li><li><p>懒汉式-方式1（线程不安全）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 懒汉式</span><br><span class="hljs-comment"> *  线程不安全</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    <span class="hljs-comment">//私有构造方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-comment">//在成员位置创建该类的对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Singleton instance;<br><br>    <span class="hljs-comment">//对外提供静态方法获取该对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-keyword">if</span>(instance == <span class="hljs-literal">null</span>) &#123;<br>            instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><font color='red'>说明：</font></p><p>​从上面代码我们可以看出该方式在成员位置声明Singleton类型的静态变量，并没有进行对象的赋值操作，那么什么时候赋值的呢？当调用getInstance()方法获取Singleton类的对象的时候才创建Singleton类的对象，这样就实现了懒加载的效果。但是，如果是多线程环境，会出现线程安全问题。</p></li><li><p>懒汉式-方式2（线程安全）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 懒汉式</span><br><span class="hljs-comment"> *  线程安全</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    <span class="hljs-comment">//私有构造方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-comment">//在成员位置创建该类的对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Singleton instance;<br><br>    <span class="hljs-comment">//对外提供静态方法获取该对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-keyword">if</span>(instance == <span class="hljs-literal">null</span>) &#123;<br>            instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><font color='red'>说明：</font></p><p>​该方式也实现了懒加载效果，同时又解决了线程安全问题。但是在getInstance()方法上添加了synchronized关键字，导致该方法的执行效果特别低。从上面代码我们可以看出，其实就是在初始化instance的时候才会出现线程安全问题，一旦初始化完成就不存在了。</p></li><li><p>懒汉式-方式3（双重检查锁）</p><p>再来讨论一下懒汉模式中加锁的问题，对于 <code>getInstance()</code> 方法来说，绝大部分的操作都是读操作，读操作是线程安全的，所以我们没必让每个线程必须持有锁才能调用该方法，我们需要调整加锁的时机。由此也产生了一种新的实现模式：双重检查锁模式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 双重检查方式</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123; <br><br>    <span class="hljs-comment">//私有构造方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Singleton instance;<br><br>   <span class="hljs-comment">//对外提供静态方法获取该对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-comment">//第一次判断，如果instance不为null，不进入抢锁阶段，直接返回实例</span><br>        <span class="hljs-keyword">if</span>(instance == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">synchronized</span> (Singleton.class) &#123;<br>                <span class="hljs-comment">//抢到锁之后再次判断是否为null</span><br>                <span class="hljs-keyword">if</span>(instance == <span class="hljs-literal">null</span>) &#123;<br>                    instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>双重检查锁模式是一种非常好的单例实现模式，解决了单例、性能、线程安全问题，上面的双重检测锁模式看上去完美无缺，其实是存在问题，在多线程的情况下，可能会出现空指针问题，出现问题的原因是JVM在实例化对象的时候会进行优化和指令重排序操作。</p><p>要解决双重检查锁模式带来空指针异常的问题，只需要使用 <code>volatile</code> 关键字, <code>volatile</code> 关键字可以保证可见性和有序性。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 双重检查方式</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br><br>    <span class="hljs-comment">//私有构造方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Singleton instance;<br><br>   <span class="hljs-comment">//对外提供静态方法获取该对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-comment">//第一次判断，如果instance不为null，不进入抢锁阶段，直接返回实际</span><br>        <span class="hljs-keyword">if</span>(instance == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">synchronized</span> (Singleton.class) &#123;<br>                <span class="hljs-comment">//抢到锁之后再次判断是否为空</span><br>                <span class="hljs-keyword">if</span>(instance == <span class="hljs-literal">null</span>) &#123;<br>                    instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><font color="red">小结：</font></p><p>添加 <code>volatile</code> 关键字之后的双重检查锁模式是一种比较好的单例实现模式，能够保证在多线程的情况下线程安全也不会有性能问题。</p></li><li><p>懒汉式-方式4（静态内部类方式）</p><p>静态内部类单例模式中实例由内部类创建，由于 JVM 在加载外部类的过程中, 是不会加载静态内部类的, 只有内部类的属性&#x2F;方法被调用时才会被加载, 并初始化其静态属性。静态属性由于被 <code>static</code> 修饰，保证只被实例化一次，并且严格保证实例化顺序。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 静态内部类方式</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br><br>    <span class="hljs-comment">//私有构造方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonHolder</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>    &#125;<br><br>    <span class="hljs-comment">//对外提供静态方法获取该对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> SingletonHolder.INSTANCE;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><font color='red'>说明：</font></p><p>​第一次加载Singleton类时不会去初始化INSTANCE，只有第一次调用getInstance，虚拟机加载SingletonHolder</p><p>并初始化INSTANCE，这样不仅能确保线程安全，也能保证 Singleton 类的唯一性。</p><p><font color="red">小结：</font></p><p>​静态内部类单例模式是一种优秀的单例模式，是开源项目中比较常用的一种单例模式。在没有加任何锁的情况下，保证了多线程下的安全，并且没有任何性能影响和空间的浪费。</p></li><li><p>枚举方式</p><p>枚举类实现单例模式是极力推荐的单例实现模式，因为枚举类型是线程安全的，并且只会装载一次，设计者充分的利用了枚举的这个特性来实现单例模式，枚举的写法非常简单，而且枚举类型是所用单例实现中唯一一种不会被破坏的单例实现模式。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 枚举方式</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    INSTANCE;<br>&#125;<br></code></pre></td></tr></table></figure><p><font color='red'>说明：</font></p><p>​枚举方式属于恶汉式方式。</p></li></ol><h3 id="4-1-3-存在的问题"><a href="#4-1-3-存在的问题" class="headerlink" title="4.1.3 存在的问题"></a>4.1.3 存在的问题</h3><h4 id="4-1-3-1-问题演示"><a href="#4-1-3-1-问题演示" class="headerlink" title="4.1.3.1 问题演示"></a>4.1.3.1 问题演示</h4><p>破坏单例模式：</p><p>使上面定义的单例类（Singleton）可以创建多个对象，枚举方式除外。有两种方式，分别是序列化和反射。</p><ul><li><p>序列化反序列化</p><p><strong>Singleton类：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">//私有构造方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonHolder</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>    &#125;<br><br>    <span class="hljs-comment">//对外提供静态方法获取该对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> SingletonHolder.INSTANCE;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Test类：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//往文件中写对象</span><br>        <span class="hljs-comment">//writeObject2File();</span><br>        <span class="hljs-comment">//从文件中读取对象</span><br>        <span class="hljs-type">Singleton</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> readObjectFromFile();<br>        <span class="hljs-type">Singleton</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> readObjectFromFile();<br><br>        <span class="hljs-comment">//判断两个反序列化后的对象是否是同一个对象</span><br>        System.out.println(s1 == s2);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">readObjectFromFile</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//创建对象输入流对象</span><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;C:\\Users\\Think\\Desktop\\a.txt&quot;</span>));<br>        <span class="hljs-comment">//第一个读取Singleton对象</span><br>        <span class="hljs-type">Singleton</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> (Singleton) ois.readObject();<br><br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeObject2File</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//获取Singleton类的对象</span><br>        <span class="hljs-type">Singleton</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> Singleton.getInstance();<br>        <span class="hljs-comment">//创建对象输出流</span><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;C:\\Users\\Think\\Desktop\\a.txt&quot;</span>));<br>        <span class="hljs-comment">//将instance对象写出到文件中</span><br>        oos.writeObject(instance);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>上面代码运行结果是<code>false</code>，表明序列化和反序列化已经破坏了单例设计模式。</p></blockquote></li><li><p>反射</p><p><strong>Singleton类：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br><br>    <span class="hljs-comment">//私有构造方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;&#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Singleton instance;<br><br>    <span class="hljs-comment">//对外提供静态方法获取该对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-keyword">if</span>(instance != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> instance;<br>        &#125;<br><br>        <span class="hljs-keyword">synchronized</span> (Singleton.class) &#123;<br>            <span class="hljs-keyword">if</span>(instance != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> instance;<br>            &#125;<br>            instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>            <span class="hljs-keyword">return</span> instance;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Test类：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//获取Singleton类的字节码对象</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Singleton.class;<br>        <span class="hljs-comment">//获取Singleton类的私有无参构造方法对象</span><br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor();<br>        <span class="hljs-comment">//取消访问检查</span><br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-comment">//创建Singleton类的对象s1</span><br>        <span class="hljs-type">Singleton</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> (Singleton) constructor.newInstance();<br>        <span class="hljs-comment">//创建Singleton类的对象s2</span><br>        <span class="hljs-type">Singleton</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> (Singleton) constructor.newInstance();<br><br>        <span class="hljs-comment">//判断通过反射创建的两个Singleton对象是否是同一个对象</span><br>        System.out.println(s1 == s2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>上面代码运行结果是<code>false</code>，表明序列化和反序列化已经破坏了单例设计模式</p></blockquote></li></ul><blockquote><p><font color="red">注意：</font>枚举方式不会出现这两个问题。</p></blockquote><h4 id="4-1-3-2-问题的解决"><a href="#4-1-3-2-问题的解决" class="headerlink" title="4.1.3.2 问题的解决"></a>4.1.3.2 问题的解决</h4><ul><li><p>序列化、反序列方式破坏单例模式的解决方法</p><p>在Singleton类中添加<code>readResolve()</code>方法，在反序列化时被反射调用，如果定义了这个方法，就返回这个方法的值，如果没有定义，则返回新new出来的对象。</p><p><strong>Singleton类：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">//私有构造方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonHolder</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>    &#125;<br><br>    <span class="hljs-comment">//对外提供静态方法获取该对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> SingletonHolder.INSTANCE;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 下面是为了解决序列化反序列化破解单例模式</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">readResolve</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> SingletonHolder.INSTANCE;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>源码解析：</strong></p><p>ObjectInputStream类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Object <span class="hljs-title function_">readObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>    ...<br>    <span class="hljs-comment">// if nested read, passHandle contains handle of enclosing object</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">outerHandle</span> <span class="hljs-operator">=</span> passHandle;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> readObject0(<span class="hljs-literal">false</span>);<span class="hljs-comment">//重点查看readObject0方法</span><br>    .....<br>&#125;<br>    <br><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">readObject0</span><span class="hljs-params">(<span class="hljs-type">boolean</span> unshared)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>...<br>    <span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">switch</span> (tc) &#123;<br>...<br><span class="hljs-keyword">case</span> TC_OBJECT:<br><span class="hljs-keyword">return</span> checkResolve(readOrdinaryObject(unshared));<span class="hljs-comment">//重点查看readOrdinaryObject方法</span><br>...<br>        &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        depth--;<br>        bin.setBlockDataMode(oldMode);<br>    &#125;    <br>&#125;<br>    <br><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">readOrdinaryObject</span><span class="hljs-params">(<span class="hljs-type">boolean</span> unshared)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>...<br><span class="hljs-comment">//isInstantiable 返回true，执行 desc.newInstance()，通过反射创建新的单例类，</span><br>    obj = desc.isInstantiable() ? desc.newInstance() : <span class="hljs-literal">null</span>; <br>    ...<br>    <span class="hljs-comment">// 在Singleton类中添加 readResolve 方法后 desc.hasReadResolveMethod() 方法执行结果为true</span><br>    <span class="hljs-keyword">if</span> (obj != <span class="hljs-literal">null</span> &amp;&amp; handles.lookupException(passHandle) == <span class="hljs-literal">null</span> &amp;&amp; desc.hasReadResolveMethod()) &#123;<br>    <span class="hljs-comment">// 通过反射调用 Singleton 类中的 readResolve 方法，将返回值赋值给rep变量</span><br>    <span class="hljs-comment">// 这样多次调用ObjectInputStream类中的readObject方法，继而就会调用我们定义的readResolve方法，所以返回的是同一个对象。</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">rep</span> <span class="hljs-operator">=</span> desc.invokeReadResolve(obj);<br>     ...<br>    &#125;<br>    <span class="hljs-keyword">return</span> obj;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>反射方式破解单例的解决方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br><br>    <span class="hljs-comment">//私有构造方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">           反射破解单例模式需要添加的代码</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-keyword">if</span>(instance != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>();<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Singleton instance;<br><br>    <span class="hljs-comment">//对外提供静态方法获取该对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-keyword">if</span>(instance != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> instance;<br>        &#125;<br><br>        <span class="hljs-keyword">synchronized</span> (Singleton.class) &#123;<br>            <span class="hljs-keyword">if</span>(instance != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> instance;<br>            &#125;<br>            instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>            <span class="hljs-keyword">return</span> instance;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><font color="red">说明:</font></p><p>​这种方式比较好理解。当通过反射方式调用构造方法进行创建创建时，直接抛异常。不运行此中操作。</p></li></ul><h3 id="4-1-4-JDK源码解析-Runtime类"><a href="#4-1-4-JDK源码解析-Runtime类" class="headerlink" title="4.1.4 JDK源码解析-Runtime类"></a>4.1.4 JDK源码解析-Runtime类</h3><p>Runtime类就是使用的单例设计模式。</p><ol><li><p>通过源代码查看使用的是哪儿种单例模式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Runtime</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Runtime</span> <span class="hljs-variable">currentRuntime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runtime</span>();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns the runtime object associated with the current Java application.</span><br><span class="hljs-comment">     * Most of the methods of class &lt;code&gt;Runtime&lt;/code&gt; are instance</span><br><span class="hljs-comment">     * methods and must be invoked with respect to the current runtime object.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>  the &lt;code&gt;Runtime&lt;/code&gt; object associated with the current</span><br><span class="hljs-comment">     *          Java application.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Runtime <span class="hljs-title function_">getRuntime</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> currentRuntime;<br>    &#125;<br><br>    <span class="hljs-comment">/** Don&#x27;t let anyone else instantiate this class */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Runtime</span><span class="hljs-params">()</span> &#123;&#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>从上面源代码中可以看出Runtime类使用的是恶汉式（静态属性）方式来实现单例模式的。</p></li><li><p>使用Runtime类中的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuntimeDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">//获取Runtime类对象</span><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br><br>        <span class="hljs-comment">//返回 Java 虚拟机中的内存总量。</span><br>        System.out.println(runtime.totalMemory());<br>        <span class="hljs-comment">//返回 Java 虚拟机试图使用的最大内存量。</span><br>        System.out.println(runtime.maxMemory());<br><br>        <span class="hljs-comment">//创建一个新的进程执行指定的字符串命令，返回进程对象</span><br>        <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> runtime.exec(<span class="hljs-string">&quot;ipconfig&quot;</span>);<br>        <span class="hljs-comment">//获取命令执行后的结果，通过输入流获取</span><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> process.getInputStream();<br>        <span class="hljs-type">byte</span>[] arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>* <span class="hljs-number">100</span>];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> inputStream.read(arr);<br>        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(arr,<span class="hljs-number">0</span>,b,<span class="hljs-string">&quot;gbk&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h1 id="4，创建型模式"><a href="#4，创建型模式" class="headerlink" title="4，创建型模式"></a>4，创建型模式</h1><h2 id="4-2-工厂模式"><a href="#4-2-工厂模式" class="headerlink" title="4.2 工厂模式"></a>4.2 工厂模式</h2><h3 id="4-2-1-概述"><a href="#4-2-1-概述" class="headerlink" title="4.2.1 概述"></a>4.2.1 概述</h3><p>需求：设计一个咖啡店点餐系统。  </p><p>设计一个咖啡类（Coffee），并定义其两个子类（美式咖啡【AmericanCoffee】和拿铁咖啡【LatteCoffee】）；再设计一个咖啡店类（CoffeeStore），咖啡店具有点咖啡的功能。</p><p>具体类的设计如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%B7%A5%E5%8E%82%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%BC%95%E5%85%A5.png" style="zoom:80%;" /><p>在java中，万物皆对象，这些对象都需要创建，如果创建的时候直接new该对象，就会对该对象耦合严重，假如我们要更换对象，所有new对象的地方都需要修改一遍，这显然违背了软件设计的开闭原则。如果我们使用工厂来生产对象，我们就只和工厂打交道就可以了，彻底和对象解耦，如果要更换对象，直接在工厂里更换该对象即可，达到了与对象解耦的目的；所以说，工厂模式最大的优点就是：<strong>解耦</strong>。</p><p>在本教程中会介绍三种工厂的使用</p><ul><li>简单工厂模式（不属于GOF的23种经典设计模式）</li><li>工厂方法模式</li><li>抽象工厂模式</li></ul><h3 id="4-2-2-简单工厂模式"><a href="#4-2-2-简单工厂模式" class="headerlink" title="4.2.2 简单工厂模式"></a>4.2.2 简单工厂模式</h3><p>简单工厂不是一种设计模式，反而比较像是一种编程习惯。</p><h4 id="4-2-2-1-结构"><a href="#4-2-2-1-结构" class="headerlink" title="4.2.2.1 结构"></a>4.2.2.1 结构</h4><p>简单工厂包含如下角色：</p><ul><li>抽象产品 ：定义了产品的规范，描述了产品的主要特性和功能。</li><li>具体产品 ：实现或者继承抽象产品的子类</li><li>具体工厂 ：提供了创建产品的方法，调用者通过该方法来获取产品。</li></ul><h4 id="4-2-2-2-实现"><a href="#4-2-2-2-实现" class="headerlink" title="4.2.2.2 实现"></a>4.2.2.2 实现</h4><p>现在使用简单工厂对上面案例进行改进，类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F.png" style="zoom:70%;" /><p>工厂类代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleCoffeeFactory</span> &#123;<br><br>    <span class="hljs-keyword">public</span> Coffee <span class="hljs-title function_">createCoffee</span><span class="hljs-params">(String type)</span> &#123;<br>        <span class="hljs-type">Coffee</span> <span class="hljs-variable">coffee</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;americano&quot;</span>.equals(type)) &#123;<br>            coffee = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AmericanoCoffee</span>();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;latte&quot;</span>.equals(type)) &#123;<br>            coffee = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LatteCoffee</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> coffee;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>工厂（factory）处理创建对象的细节，一旦有了SimpleCoffeeFactory，CoffeeStore类中的orderCoffee()就变成此对象的客户，后期如果需要Coffee对象直接从工厂中获取即可。这样也就解除了和Coffee实现类的耦合，同时又产生了新的耦合，CoffeeStore对象和SimpleCoffeeFactory工厂对象的耦合，工厂对象和商品对象的耦合。</p><p>后期如果再加新品种的咖啡，我们势必要需求修改SimpleCoffeeFactory的代码，违反了开闭原则。工厂类的客户端可能有很多，比如创建美团外卖等，这样只需要修改工厂类的代码，省去其他的修改操作。</p><h4 id="4-2-2-4-优缺点"><a href="#4-2-2-4-优缺点" class="headerlink" title="4.2.2.4 优缺点"></a>4.2.2.4 优缺点</h4><p><strong>优点：</strong></p><p>封装了创建对象的过程，可以通过参数直接获取对象。把对象的创建和业务逻辑层分开，这样以后就避免了修改客户代码，如果要实现新产品直接修改工厂类，而不需要在原代码中修改，这样就降低了客户代码修改的可能性，更加容易扩展。</p><p><strong>缺点：</strong></p><p>增加新产品时还是需要修改工厂类的代码，违背了“开闭原则”。</p><h4 id="4-2-2-3-扩展"><a href="#4-2-2-3-扩展" class="headerlink" title="4.2.2.3 扩展"></a>4.2.2.3 扩展</h4><p><strong>静态工厂</strong></p><p>在开发中也有一部分人将工厂类中的创建对象的功能定义为静态的，这个就是静态工厂模式，它也不是23种设计模式中的。代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleCoffeeFactory</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Coffee <span class="hljs-title function_">createCoffee</span><span class="hljs-params">(String type)</span> &#123;<br>        <span class="hljs-type">Coffee</span> <span class="hljs-variable">coffee</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;americano&quot;</span>.equals(type)) &#123;<br>            coffee = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AmericanoCoffee</span>();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;latte&quot;</span>.equals(type)) &#123;<br>            coffee = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LatteCoffee</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> coffe;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-2-3-工厂方法模式"><a href="#4-2-3-工厂方法模式" class="headerlink" title="4.2.3 工厂方法模式"></a>4.2.3 工厂方法模式</h3><p>针对上例中的缺点，使用工厂方法模式就可以完美的解决，完全遵循开闭原则。</p><h4 id="4-2-3-1-概念"><a href="#4-2-3-1-概念" class="headerlink" title="4.2.3.1 概念"></a>4.2.3.1 概念</h4><p>定义一个用于创建对象的接口，让子类决定实例化哪个产品类对象。工厂方法使一个产品类的实例化延迟到其工厂的子类。</p><h4 id="4-2-3-2-结构"><a href="#4-2-3-2-结构" class="headerlink" title="4.2.3.2 结构"></a>4.2.3.2 结构</h4><p>工厂方法模式的主要角色：</p><ul><li>抽象工厂（Abstract Factory）：提供了创建产品的接口，调用者通过它访问具体工厂的工厂方法来创建产品。</li><li>具体工厂（ConcreteFactory）：主要是实现抽象工厂中的抽象方法，完成具体产品的创建。</li><li>抽象产品（Product）：定义了产品的规范，描述了产品的主要特性和功能。</li><li>具体产品（ConcreteProduct）：实现了抽象产品角色所定义的接口，由具体工厂来创建，它同具体工厂之间一一对应。</li></ul><h4 id="4-2-3-3-实现"><a href="#4-2-3-3-实现" class="headerlink" title="4.2.3.3 实现"></a>4.2.3.3 实现</h4><p>使用工厂方法模式对上例进行改进，类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F.png" style="zoom:70%;" /><p>代码如下：</p><p>抽象工厂：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CoffeeFactory</span> &#123;<br><br>    Coffee <span class="hljs-title function_">createCoffee</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>具体工厂：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LatteCoffeeFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CoffeeFactory</span> &#123;<br><br>    <span class="hljs-keyword">public</span> Coffee <span class="hljs-title function_">createCoffee</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LatteCoffee</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AmericanCoffeeFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CoffeeFactory</span> &#123;<br><br>    <span class="hljs-keyword">public</span> Coffee <span class="hljs-title function_">createCoffee</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AmericanCoffee</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>咖啡店类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoffeeStore</span> &#123;<br><br>    <span class="hljs-keyword">private</span> CoffeeFactory factory;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CoffeeStore</span><span class="hljs-params">(CoffeeFactory factory)</span> &#123;<br>        <span class="hljs-built_in">this</span>.factory = factory;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Coffee <span class="hljs-title function_">orderCoffee</span><span class="hljs-params">(String type)</span> &#123;<br>        <span class="hljs-type">Coffee</span> <span class="hljs-variable">coffee</span> <span class="hljs-operator">=</span> factory.createCoffee();<br>        coffee.addMilk();<br>        coffee.addsugar();<br>        <span class="hljs-keyword">return</span> coffee;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>从以上的编写的代码可以看到，要增加产品类时也要相应地增加工厂类，不需要修改工厂类的代码了，这样就解决了简单工厂模式的缺点。</p><p>工厂方法模式是简单工厂模式的进一步抽象。由于使用了多态性，工厂方法模式保持了简单工厂模式的优点，而且克服了它的缺点。</p><h4 id="4-2-3-4-优缺点"><a href="#4-2-3-4-优缺点" class="headerlink" title="4.2.3.4 优缺点"></a>4.2.3.4 优缺点</h4><p><strong>优点：</strong></p><ul><li>用户只需要知道具体工厂的名称就可得到所要的产品，无须知道产品的具体创建过程；</li><li>在系统增加新的产品时只需要添加具体产品类和对应的具体工厂类，无须对原工厂进行任何修改，满足开闭原则；</li></ul><p><strong>缺点：</strong></p><ul><li>每增加一个产品就要增加一个具体产品类和一个对应的具体工厂类，这增加了系统的复杂度。</li></ul><h3 id="4-2-4-抽象工厂模式"><a href="#4-2-4-抽象工厂模式" class="headerlink" title="4.2.4 抽象工厂模式"></a>4.2.4 抽象工厂模式</h3><p>前面介绍的工厂方法模式中考虑的是一类产品的生产，如畜牧场只养动物、电视机厂只生产电视机、传智播客只培养计算机软件专业的学生等。</p><p>这些工厂只生产同种类产品，同种类产品称为同等级产品，也就是说：工厂方法模式只考虑生产同等级的产品，但是在现实生活中许多工厂是综合型的工厂，能生产多等级（种类） 的产品，如电器厂既生产电视机又生产洗衣机或空调，大学既有软件专业又有生物专业等。</p><p>本节要介绍的抽象工厂模式将考虑多等级产品的生产，将同一个具体工厂所生产的位于不同等级的一组产品称为一个产品族，下图所示横轴是产品等级，也就是同一类产品；纵轴是产品族，也就是同一品牌的产品，同一品牌的产品产自同一个工厂。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200401214509176.png" style="zoom:67%;" /><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200401222951963.png" style="zoom:67%;" /><h4 id="4-2-4-1-概念"><a href="#4-2-4-1-概念" class="headerlink" title="4.2.4.1 概念"></a>4.2.4.1 概念</h4><p>是一种为访问类提供一个创建一组相关或相互依赖对象的接口，且访问类无须指定所要产品的具体类就能得到同族的不同等级的产品的模式结构。</p><p>抽象工厂模式是工厂方法模式的升级版本，工厂方法模式只生产一个等级的产品，而抽象工厂模式可生产多个等级的产品。</p><h4 id="4-2-4-2-结构"><a href="#4-2-4-2-结构" class="headerlink" title="4.2.4.2 结构"></a>4.2.4.2 结构</h4><p>抽象工厂模式的主要角色如下：</p><ul><li>抽象工厂（Abstract Factory）：提供了创建产品的接口，它包含多个创建产品的方法，可以创建多个不同等级的产品。</li><li>具体工厂（Concrete Factory）：主要是实现抽象工厂中的多个抽象方法，完成具体产品的创建。</li><li>抽象产品（Product）：定义了产品的规范，描述了产品的主要特性和功能，抽象工厂模式有多个抽象产品。</li><li>具体产品（ConcreteProduct）：实现了抽象产品角色所定义的接口，由具体工厂来创建，它 同具体工厂之间是多对一的关系。</li></ul><h4 id="4-2-4-2-实现"><a href="#4-2-4-2-实现" class="headerlink" title="4.2.4.2 实现"></a>4.2.4.2 实现</h4><p>现咖啡店业务发生改变，不仅要生产咖啡还要生产甜点，如提拉米苏、抹茶慕斯等，要是按照工厂方法模式，需要定义提拉米苏类、抹茶慕斯类、提拉米苏工厂、抹茶慕斯工厂、甜点工厂类，很容易发生类爆炸情况。其中拿铁咖啡、美式咖啡是一个产品等级，都是咖啡；提拉米苏、抹茶慕斯也是一个产品等级；拿铁咖啡和提拉米苏是同一产品族（也就是都属于意大利风味），美式咖啡和抹茶慕斯是同一产品族（也就是都属于美式风味）。所以这个案例可以使用抽象工厂模式实现。类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F.png" style="zoom:67%;" /><p>代码如下：</p><p>抽象工厂：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DessertFactory</span> &#123;<br><br>    Coffee <span class="hljs-title function_">createCoffee</span><span class="hljs-params">()</span>;<br><br>    Dessert <span class="hljs-title function_">createDessert</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>具体工厂：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//美式甜点工厂</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AmericanDessertFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DessertFactory</span> &#123;<br><br>    <span class="hljs-keyword">public</span> Coffee <span class="hljs-title function_">createCoffee</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AmericanCoffee</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Dessert <span class="hljs-title function_">createDessert</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MatchaMousse</span>();<br>    &#125;<br>&#125;<br><span class="hljs-comment">//意大利风味甜点工厂</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItalyDessertFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DessertFactory</span> &#123;<br><br>    <span class="hljs-keyword">public</span> Coffee <span class="hljs-title function_">createCoffee</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LatteCoffee</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Dessert <span class="hljs-title function_">createDessert</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tiramisu</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>如果要加同一个产品族的话，只需要再加一个对应的工厂类即可，不需要修改其他的类。</p><h4 id="4-2-4-3-优缺点"><a href="#4-2-4-3-优缺点" class="headerlink" title="4.2.4.3 优缺点"></a>4.2.4.3 优缺点</h4><p><strong>优点：</strong></p><p>当一个产品族中的多个对象被设计成一起工作时，它能保证客户端始终只使用同一个产品族中的对象。</p><p><strong>缺点：</strong></p><p>当产品族中需要增加一个新的产品时，所有的工厂类都需要进行修改。</p><h4 id="4-2-4-4-使用场景"><a href="#4-2-4-4-使用场景" class="headerlink" title="4.2.4.4 使用场景"></a>4.2.4.4 使用场景</h4><ul><li><p>当需要创建的对象是一系列相互关联或相互依赖的产品族时，如电器工厂中的电视机、洗衣机、空调等。</p></li><li><p>系统中有多个产品族，但每次只使用其中的某一族产品。如有人只喜欢穿某一个品牌的衣服和鞋。</p></li><li><p>系统中提供了产品的类库，且所有产品的接口相同，客户端不依赖产品实例的创建细节和内部结构。</p></li></ul><p>如：输入法换皮肤，一整套一起换。生成不同操作系统的程序。</p><h3 id="4-2-5-模式扩展"><a href="#4-2-5-模式扩展" class="headerlink" title="4.2.5 模式扩展"></a>4.2.5 模式扩展</h3><p><strong>简单工厂+配置文件解除耦合</strong></p><p>可以通过工厂模式+配置文件的方式解除工厂对象和产品对象的耦合。在工厂类中加载配置文件中的全类名，并创建对象进行存储，客户端如果需要对象，直接进行获取即可。</p><p>第一步：定义配置文件</p><p>为了演示方便，我们使用properties文件作为配置文件，名称为bean.properties</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">american</span>=<span class="hljs-string">com.itheima.pattern.factory.config_factory.AmericanCoffee</span><br><span class="hljs-attr">latte</span>=<span class="hljs-string">com.itheima.pattern.factory.config_factory.LatteCoffee</span><br></code></pre></td></tr></table></figure><p>第二步：改进工厂类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoffeeFactory</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String,Coffee&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> CoffeeFactory.class.getClassLoader().getResourceAsStream(<span class="hljs-string">&quot;bean.properties&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            p.load(is);<br>            <span class="hljs-comment">//遍历Properties集合对象</span><br>            Set&lt;Object&gt; keys = p.keySet();<br>            <span class="hljs-keyword">for</span> (Object key : keys) &#123;<br>                <span class="hljs-comment">//根据键获取值（全类名）</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> p.getProperty((String) key);<br>                <span class="hljs-comment">//获取字节码对象</span><br>                <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(className);<br>                <span class="hljs-type">Coffee</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> (Coffee) clazz.newInstance();<br>                map.put((String)key,obj);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Coffee <span class="hljs-title function_">createCoffee</span><span class="hljs-params">(String name)</span> &#123;<br><br>        <span class="hljs-keyword">return</span> map.get(name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>静态成员变量用来存储创建的对象（键存储的是名称，值存储的是对应的对象），而读取配置文件以及创建对象写在静态代码块中，目的就是只需要执行一次。</p><h3 id="4-2-6-JDK源码解析-Collection-iterator方法"><a href="#4-2-6-JDK源码解析-Collection-iterator方法" class="headerlink" title="4.2.6 JDK源码解析-Collection.iterator方法"></a>4.2.6 JDK源码解析-Collection.iterator方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        list.add(<span class="hljs-string">&quot;令狐冲&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;风清扬&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;任我行&quot;</span>);<br><br>        <span class="hljs-comment">//获取迭代器对象</span><br>        Iterator&lt;String&gt; it = list.iterator();<br>        <span class="hljs-comment">//使用迭代器遍历</span><br>        <span class="hljs-keyword">while</span>(it.hasNext()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">ele</span> <span class="hljs-operator">=</span> it.next();<br>            System.out.println(ele);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>对上面的代码大家应该很熟，使用迭代器遍历集合，获取集合中的元素。而单列集合获取迭代器的方法就使用到了工厂方法模式。我们看通过类图看看结构：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/JDK%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.png" style="zoom:75%;" /><p>Collection接口是抽象工厂类，ArrayList是具体的工厂类；Iterator接口是抽象商品类，ArrayList类中的Iter内部类是具体的商品类。在具体的工厂类中iterator()方法创建具体的商品类的对象。</p><blockquote><p>另：</p><p>​1,DateForamt类中的getInstance()方法使用的是工厂模式；</p><p>​2,Calendar类中的getInstance()方法使用的是工厂模式；</p></blockquote><h2 id="4-3-原型模式"><a href="#4-3-原型模式" class="headerlink" title="4.3 原型模式"></a>4.3 原型模式</h2><h3 id="4-3-1-概述"><a href="#4-3-1-概述" class="headerlink" title="4.3.1 概述"></a>4.3.1 概述</h3><p>用一个已经创建的实例作为原型，通过复制该原型对象来创建一个和原型对象相同的新对象。</p><h3 id="4-3-2-结构"><a href="#4-3-2-结构" class="headerlink" title="4.3.2 结构"></a>4.3.2 结构</h3><p>原型模式包含如下角色：</p><ul><li>抽象原型类：规定了具体原型对象必须实现的的 clone() 方法。</li><li>具体原型类：实现抽象原型类的 clone() 方法，它是可被复制的对象。</li><li>访问类：使用具体原型类中的 clone() 方法来复制新的对象。</li></ul><p>接口类图如下：</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F.png"></p><h3 id="4-3-3-实现"><a href="#4-3-3-实现" class="headerlink" title="4.3.3 实现"></a>4.3.3 实现</h3><p>原型模式的克隆分为浅克隆和深克隆。</p><blockquote><p>浅克隆：创建一个新对象，新对象的属性和原来对象完全相同，对于非基本类型属性，仍指向原有属性所指向的对象的内存地址。</p><p>深克隆：创建一个新对象，属性中引用的其他对象也会被克隆，不再指向原有对象地址。</p></blockquote><p>Java中的Object类中提供了 <code>clone()</code> 方法来实现浅克隆。 Cloneable 接口是上面的类图中的抽象原型类，而实现了Cloneable接口的子实现类就是具体的原型类。代码如下：</p><p><strong>Realizetype（具体的原型类）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Realizetype</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cloneable</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Realizetype</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;具体的原型对象创建完成！&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Realizetype <span class="hljs-title function_">clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException &#123;<br>        System.out.println(<span class="hljs-string">&quot;具体原型复制成功！&quot;</span>);<br>        <span class="hljs-keyword">return</span> (Realizetype) <span class="hljs-built_in">super</span>.clone();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>PrototypeTest（测试访问类）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrototypeTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException &#123;<br>        <span class="hljs-type">Realizetype</span> <span class="hljs-variable">r1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Realizetype</span>();<br>        <span class="hljs-type">Realizetype</span> <span class="hljs-variable">r2</span> <span class="hljs-operator">=</span> r1.clone();<br><br>        System.out.println(<span class="hljs-string">&quot;对象r1和r2是同一个对象？&quot;</span> + (r1 == r2));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-3-4-案例"><a href="#4-3-4-案例" class="headerlink" title="4.3.4 案例"></a>4.3.4 案例</h3><p><strong>用原型模式生成“三好学生”奖状</strong></p><p>同一学校的“三好学生”奖状除了获奖人姓名不同，其他都相同，可以使用原型模式复制多个“三好学生”奖状出来，然后在修改奖状上的名字即可。</p><p>类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F1.png" style="zoom:80%;" /><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//奖状类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Citation</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cloneable</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">this</span>.name);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(name + <span class="hljs-string">&quot;同学：在2020学年第一学期中表现优秀，被评为三好学生。特发此状！&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Citation <span class="hljs-title function_">clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException &#123;<br>        <span class="hljs-keyword">return</span> (Citation) <span class="hljs-built_in">super</span>.clone();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试访问类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CitationTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException &#123;<br>        <span class="hljs-type">Citation</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Citation</span>();<br>        c1.setName(<span class="hljs-string">&quot;张三&quot;</span>);<br><br>        <span class="hljs-comment">//复制奖状</span><br>        <span class="hljs-type">Citation</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> c1.clone();<br>        <span class="hljs-comment">//将奖状的名字修改李四</span><br>        c2.setName(<span class="hljs-string">&quot;李四&quot;</span>);<br><br>        c1.show();<br>        c2.show();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-3-5-使用场景"><a href="#4-3-5-使用场景" class="headerlink" title="4.3.5 使用场景"></a>4.3.5 使用场景</h3><ul><li>对象的创建非常复杂，可以使用原型模式快捷的创建对象。</li><li>性能和安全要求比较高。</li></ul><h3 id="4-3-6-扩展（深克隆）"><a href="#4-3-6-扩展（深克隆）" class="headerlink" title="4.3.6 扩展（深克隆）"></a>4.3.6 扩展（深克隆）</h3><p>将上面的“三好学生”奖状的案例中Citation类的name属性修改为Student类型的属性。代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//奖状类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Citation</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cloneable</span> &#123;<br>    <span class="hljs-keyword">private</span> Student stu;<br><br>    <span class="hljs-keyword">public</span> Student <span class="hljs-title function_">getStu</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> stu;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStu</span><span class="hljs-params">(Student stu)</span> &#123;<br>        <span class="hljs-built_in">this</span>.stu = stu;<br>    &#125;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(stu.getName() + <span class="hljs-string">&quot;同学：在2020学年第一学期中表现优秀，被评为三好学生。特发此状！&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Citation <span class="hljs-title function_">clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException &#123;<br>        <span class="hljs-keyword">return</span> (Citation) <span class="hljs-built_in">super</span>.clone();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//学生类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String address;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(String name, String address)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.address = address;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAddress</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> address;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAddress</span><span class="hljs-params">(String address)</span> &#123;<br>        <span class="hljs-built_in">this</span>.address = address;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CitationTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException &#123;<br><br>        <span class="hljs-type">Citation</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Citation</span>();<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">stu</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">&quot;张三&quot;</span>, <span class="hljs-string">&quot;西安&quot;</span>);<br>        c1.setStu(stu);<br><br>        <span class="hljs-comment">//复制奖状</span><br>        <span class="hljs-type">Citation</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> c1.clone();<br>        <span class="hljs-comment">//获取c2奖状所属学生对象</span><br>        <span class="hljs-type">Student</span> <span class="hljs-variable">stu1</span> <span class="hljs-operator">=</span> c2.getStu();<br>        stu1.setName(<span class="hljs-string">&quot;李四&quot;</span>);<br><br>        <span class="hljs-comment">//判断stu对象和stu1对象是否是同一个对象</span><br>        System.out.println(<span class="hljs-string">&quot;stu和stu1是同一个对象？&quot;</span> + (stu == stu1));<br><br>        c1.show();<br>        c2.show();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行结果为：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F2.png" style="zoom:80%;" /><p><font color="red">说明：</font></p><p>​stu对象和stu1对象是同一个对象，就会产生将stu1对象中name属性值改为“李四”，两个Citation（奖状）对象中显示的都是李四。这就是浅克隆的效果，对具体原型类（Citation）中的引用类型的属性进行引用的复制。这种情况需要使用深克隆，而进行深克隆需要使用对象流。代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CitationTest1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Citation</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Citation</span>();<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">stu</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">&quot;张三&quot;</span>, <span class="hljs-string">&quot;西安&quot;</span>);<br>        c1.setStu(stu);<br><br>        <span class="hljs-comment">//创建对象输出流对象</span><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;C:\\Users\\Think\\Desktop\\b.txt&quot;</span>));<br>        <span class="hljs-comment">//将c1对象写出到文件中</span><br>        oos.writeObject(c1);<br>        oos.close();<br><br>        <span class="hljs-comment">//创建对象出入流对象</span><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;C:\\Users\\Think\\Desktop\\b.txt&quot;</span>));<br>        <span class="hljs-comment">//读取对象</span><br>        <span class="hljs-type">Citation</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> (Citation) ois.readObject();<br>        <span class="hljs-comment">//获取c2奖状所属学生对象</span><br>        <span class="hljs-type">Student</span> <span class="hljs-variable">stu1</span> <span class="hljs-operator">=</span> c2.getStu();<br>        stu1.setName(<span class="hljs-string">&quot;李四&quot;</span>);<br><br>        <span class="hljs-comment">//判断stu对象和stu1对象是否是同一个对象</span><br>        System.out.println(<span class="hljs-string">&quot;stu和stu1是同一个对象？&quot;</span> + (stu == stu1));<br><br>        c1.show();<br>        c2.show();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行结果为：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F3.png" style="zoom:80%;" /><blockquote><p>注意：Citation类和Student类必须实现Serializable接口，否则会抛NotSerializableException异常。</p></blockquote><h2 id="4-5-建造者模式"><a href="#4-5-建造者模式" class="headerlink" title="4.5 建造者模式"></a>4.5 建造者模式</h2><h3 id="4-4-1-概述"><a href="#4-4-1-概述" class="headerlink" title="4.4.1 概述"></a>4.4.1 概述</h3><p>将一个复杂对象的构建与表示分离，使得同样的构建过程可以创建不同的表示。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200413225341516.png" style="zoom:60%;" /><ul><li>分离了部件的构造(由Builder来负责)和装配(由Director负责)。 从而可以构造出复杂的对象。这个模式适用于：某个对象的构建过程复杂的情况。</li><li>由于实现了构建和装配的解耦。不同的构建器，相同的装配，也可以做出不同的对象；相同的构建器，不同的装配顺序也可以做出不同的对象。也就是实现了构建算法、装配算法的解耦，实现了更好的复用。</li><li>建造者模式可以将部件和其组装过程分开，一步一步创建一个复杂的对象。用户只需要指定复杂对象的类型就可以得到该对象，而无须知道其内部的具体构造细节。</li></ul><h3 id="4-4-2-结构"><a href="#4-4-2-结构" class="headerlink" title="4.4.2 结构"></a>4.4.2 结构</h3><p>建造者（Builder）模式包含如下角色：</p><ul><li><p>抽象建造者类（Builder）：这个接口规定要实现复杂对象的那些部分的创建，并不涉及具体的部件对象的创建。 </p></li><li><p>具体建造者类（ConcreteBuilder）：实现 Builder 接口，完成复杂产品的各个部件的具体创建方法。在构造过程完成后，提供产品的实例。 </p></li><li><p>产品类（Product）：要创建的复杂对象。</p></li><li><p>指挥者类（Director）：调用具体建造者来创建复杂对象的各个部分，在指导者中不涉及具体产品的信息，只负责保证对象各部分完整创建或按某种顺序创建。</p></li></ul><p>类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F.png" style="zoom:80%;" /><h3 id="4-4-3-实例"><a href="#4-4-3-实例" class="headerlink" title="4.4.3 实例"></a>4.4.3 实例</h3><p><strong>创建共享单车</strong></p><p>生产自行车是一个复杂的过程，它包含了车架，车座等组件的生产。而车架又有碳纤维，铝合金等材质的，车座有橡胶，真皮等材质。对于自行车的生产就可以使用建造者模式。</p><p>这里Bike是产品，包含车架，车座等组件；Builder是抽象建造者，MobikeBuilder和OfoBuilder是具体的建造者；Director是指挥者。类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F1.png" style="zoom:80%;" /><p>具体的代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//自行车类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Bike</span> &#123;<br>    <span class="hljs-keyword">private</span> String frame;<br>    <span class="hljs-keyword">private</span> String seat;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getFrame</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> frame;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFrame</span><span class="hljs-params">(String frame)</span> &#123;<br>        <span class="hljs-built_in">this</span>.frame = frame;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSeat</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> seat;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSeat</span><span class="hljs-params">(String seat)</span> &#123;<br>        <span class="hljs-built_in">this</span>.seat = seat;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 抽象 builder 类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">Bike</span> <span class="hljs-variable">mBike</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bike</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildFrame</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildSeat</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Bike <span class="hljs-title function_">createBike</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-comment">//摩拜单车Builder类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MobikeBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Builder</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildFrame</span><span class="hljs-params">()</span> &#123;<br>        mBike.setFrame(<span class="hljs-string">&quot;铝合金车架&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildSeat</span><span class="hljs-params">()</span> &#123;<br>        mBike.setSeat(<span class="hljs-string">&quot;真皮车座&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Bike <span class="hljs-title function_">createBike</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> mBike;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//ofo单车Builder类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OfoBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Builder</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildFrame</span><span class="hljs-params">()</span> &#123;<br>        mBike.setFrame(<span class="hljs-string">&quot;碳纤维车架&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildSeat</span><span class="hljs-params">()</span> &#123;<br>        mBike.setSeat(<span class="hljs-string">&quot;橡胶车座&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Bike <span class="hljs-title function_">createBike</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> mBike;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//指挥者类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Director</span> &#123;<br>    <span class="hljs-keyword">private</span> Builder mBuilder;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Director</span><span class="hljs-params">(Builder builder)</span> &#123;<br>        mBuilder = builder;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Bike <span class="hljs-title function_">construct</span><span class="hljs-params">()</span> &#123;<br>        mBuilder.buildFrame();<br>        mBuilder.buildSeat();<br>        <span class="hljs-keyword">return</span> mBuilder.createBike();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        showBike(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OfoBuilder</span>());<br>        showBike(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MobikeBuilder</span>());<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showBike</span><span class="hljs-params">(Builder builder)</span> &#123;<br>        <span class="hljs-type">Director</span> <span class="hljs-variable">director</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Director</span>(builder);<br>        <span class="hljs-type">Bike</span> <span class="hljs-variable">bike</span> <span class="hljs-operator">=</span> director.construct();<br>        System.out.println(bike.getFrame());<br>        System.out.println(bike.getSeat());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>注意：</strong></p><p>上面示例是 Builder模式的常规用法，指挥者类 Director 在建造者模式中具有很重要的作用，它用于指导具体构建者如何构建产品，控制调用先后次序，并向调用者返回完整的产品类，但是有些情况下需要简化系统结构，可以把指挥者类和抽象建造者进行结合</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 抽象 builder 类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">Bike</span> <span class="hljs-variable">mBike</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bike</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildFrame</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildSeat</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Bike <span class="hljs-title function_">createBike</span><span class="hljs-params">()</span>;<br>    <br>    <span class="hljs-keyword">public</span> Bike <span class="hljs-title function_">construct</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.buildFrame();<br>        <span class="hljs-built_in">this</span>.BuildSeat();<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.createBike();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>说明：</strong></p><p>这样做确实简化了系统结构，但同时也加重了抽象建造者类的职责，也不是太符合单一职责原则，如果construct() 过于复杂，建议还是封装到 Director 中。</p><h3 id="4-4-4-优缺点"><a href="#4-4-4-优缺点" class="headerlink" title="4.4.4 优缺点"></a>4.4.4 优缺点</h3><p><strong>优点：</strong></p><ul><li>建造者模式的封装性很好。使用建造者模式可以有效的封装变化，在使用建造者模式的场景中，一般产品类和建造者类是比较稳定的，因此，将主要的业务逻辑封装在指挥者类中对整体而言可以取得比较好的稳定性。</li><li>在建造者模式中，客户端不必知道产品内部组成的细节，将产品本身与产品的创建过程解耦，使得相同的创建过程可以创建不同的产品对象。</li><li>可以更加精细地控制产品的创建过程 。将复杂产品的创建步骤分解在不同的方法中，使得创建过程更加清晰，也更方便使用程序来控制创建过程。</li><li>建造者模式很容易进行扩展。如果有新的需求，通过实现一个新的建造者类就可以完成，基本上不用修改之前已经测试通过的代码，因此也就不会对原有功能引入风险。符合开闭原则。</li></ul><p><strong>缺点：</strong></p><p>造者模式所创建的产品一般具有较多的共同点，其组成部分相似，如果产品之间的差异性很大，则不适合使用建造者模式，因此其使用范围受到一定的限制。</p><h3 id="4-4-5-使用场景"><a href="#4-4-5-使用场景" class="headerlink" title="4.4.5 使用场景"></a>4.4.5 使用场景</h3><p>建造者（Builder）模式创建的是复杂对象，其产品的各个部分经常面临着剧烈的变化，但将它们组合在一起的算法却相对稳定，所以它通常在以下场合使用。</p><ul><li>创建的对象较复杂，由多个部件构成，各部件面临着复杂的变化，但构件间的建造顺序是稳定的。</li><li>创建复杂对象的算法独立于该对象的组成部分以及它们的装配方式，即产品的构建过程和最终的表示是独立的。</li></ul><h3 id="4-4-6-模式扩展"><a href="#4-4-6-模式扩展" class="headerlink" title="4.4.6 模式扩展"></a>4.4.6 模式扩展</h3><p>建造者模式除了上面的用途外，在开发中还有一个常用的使用方式，就是当一个类构造器需要传入很多参数时，如果创建这个类的实例，代码可读性会非常差，而且很容易引入错误，此时就可以利用建造者模式进行重构。</p><p>重构前代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Phone</span> &#123;<br>    <span class="hljs-keyword">private</span> String cpu;<br>    <span class="hljs-keyword">private</span> String screen;<br>    <span class="hljs-keyword">private</span> String memory;<br>    <span class="hljs-keyword">private</span> String mainboard;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Phone</span><span class="hljs-params">(String cpu, String screen, String memory, String mainboard)</span> &#123;<br>        <span class="hljs-built_in">this</span>.cpu = cpu;<br>        <span class="hljs-built_in">this</span>.screen = screen;<br>        <span class="hljs-built_in">this</span>.memory = memory;<br>        <span class="hljs-built_in">this</span>.mainboard = mainboard;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCpu</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> cpu;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCpu</span><span class="hljs-params">(String cpu)</span> &#123;<br>        <span class="hljs-built_in">this</span>.cpu = cpu;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getScreen</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> screen;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setScreen</span><span class="hljs-params">(String screen)</span> &#123;<br>        <span class="hljs-built_in">this</span>.screen = screen;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMemory</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> memory;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMemory</span><span class="hljs-params">(String memory)</span> &#123;<br>        <span class="hljs-built_in">this</span>.memory = memory;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMainboard</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> mainboard;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMainboard</span><span class="hljs-params">(String mainboard)</span> &#123;<br>        <span class="hljs-built_in">this</span>.mainboard = mainboard;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Phone&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;cpu=&#x27;&quot;</span> + cpu + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, screen=&#x27;&quot;</span> + screen + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, memory=&#x27;&quot;</span> + memory + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, mainboard=&#x27;&quot;</span> + mainboard + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//构建Phone对象</span><br>        <span class="hljs-type">Phone</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phone</span>(<span class="hljs-string">&quot;intel&quot;</span>,<span class="hljs-string">&quot;三星屏幕&quot;</span>,<span class="hljs-string">&quot;金士顿&quot;</span>,<span class="hljs-string">&quot;华硕&quot;</span>);<br>        System.out.println(phone);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>上面在客户端代码中构建Phone对象，传递了四个参数，如果参数更多呢？代码的可读性及使用的成本就是比较高。</p><p>重构后代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Phone</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String cpu;<br>    <span class="hljs-keyword">private</span> String screen;<br>    <span class="hljs-keyword">private</span> String memory;<br>    <span class="hljs-keyword">private</span> String mainboard;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Phone</span><span class="hljs-params">(Builder builder)</span> &#123;<br>        cpu = builder.cpu;<br>        screen = builder.screen;<br>        memory = builder.memory;<br>        mainboard = builder.mainboard;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> &#123;<br>        <span class="hljs-keyword">private</span> String cpu;<br>        <span class="hljs-keyword">private</span> String screen;<br>        <span class="hljs-keyword">private</span> String memory;<br>        <span class="hljs-keyword">private</span> String mainboard;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">()</span> &#123;&#125;<br><br>        <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">cpu</span><span class="hljs-params">(String val)</span> &#123;<br>            cpu = val;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        &#125;<br>        <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">screen</span><span class="hljs-params">(String val)</span> &#123;<br>            screen = val;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        &#125;<br>        <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">memory</span><span class="hljs-params">(String val)</span> &#123;<br>            memory = val;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        &#125;<br>        <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">mainboard</span><span class="hljs-params">(String val)</span> &#123;<br>            mainboard = val;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        &#125;<br>        <span class="hljs-keyword">public</span> Phone <span class="hljs-title function_">build</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phone</span>(<span class="hljs-built_in">this</span>);&#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Phone&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;cpu=&#x27;&quot;</span> + cpu + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, screen=&#x27;&quot;</span> + screen + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, memory=&#x27;&quot;</span> + memory + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, mainboard=&#x27;&quot;</span> + mainboard + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Phone</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phone</span>.Builder()<br>                .cpu(<span class="hljs-string">&quot;intel&quot;</span>)<br>                .mainboard(<span class="hljs-string">&quot;华硕&quot;</span>)<br>                .memory(<span class="hljs-string">&quot;金士顿&quot;</span>)<br>                .screen(<span class="hljs-string">&quot;三星&quot;</span>)<br>                .build();<br>        System.out.println(phone);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>重构后的代码在使用起来更方便，某种程度上也可以提高开发效率。从软件设计上，对程序员的要求比较高。</p><h2 id="4-6-创建者模式对比"><a href="#4-6-创建者模式对比" class="headerlink" title="4.6 创建者模式对比"></a>4.6 创建者模式对比</h2><h3 id="4-6-1-工厂方法模式VS建造者模式"><a href="#4-6-1-工厂方法模式VS建造者模式" class="headerlink" title="4.6.1 工厂方法模式VS建造者模式"></a>4.6.1 工厂方法模式VS建造者模式</h3><p>工厂方法模式注重的是整体对象的创建方式；而建造者模式注重的是部件构建的过程，意在通过一步一步地精确构造创建出一个复杂的对象。</p><p>我们举个简单例子来说明两者的差异，如要制造一个超人，如果使用工厂方法模式，直接产生出来的就是一个力大无穷、能够飞翔、内裤外穿的超人；而如果使用建造者模式，则需要组装手、头、脚、躯干等部分，然后再把内裤外穿，于是一个超人就诞生了。</p><h3 id="4-6-2-抽象工厂模式VS建造者模式"><a href="#4-6-2-抽象工厂模式VS建造者模式" class="headerlink" title="4.6.2 抽象工厂模式VS建造者模式"></a>4.6.2 抽象工厂模式VS建造者模式</h3><p>抽象工厂模式实现对产品家族的创建，一个产品家族是这样的一系列产品：具有不同分类维度的产品组合，采用抽象工厂模式则是不需要关心构建过程，只关心什么产品由什么工厂生产即可。</p><p>建造者模式则是要求按照指定的蓝图建造产品，它的主要目的是通过组装零配件而产生一个新产品。</p><p>如果将抽象工厂模式看成汽车配件生产工厂，生产一个产品族的产品，那么建造者模式就是一个汽车组装工厂，通过对部件的组装可以返回一辆完整的汽车。</p><h1 id="5，结构型模式"><a href="#5，结构型模式" class="headerlink" title="5，结构型模式"></a>5，结构型模式</h1><p>结构型模式描述如何将类或对象按某种布局组成更大的结构。它分为类结构型模式和对象结构型模式，前者采用继承机制来组织接口和类，后者釆用组合或聚合来组合对象。</p><p>由于组合关系或聚合关系比继承关系耦合度低，满足“合成复用原则”，所以对象结构型模式比类结构型模式具有更大的灵活性。</p><p>结构型模式分为以下 7 种：</p><ul><li>代理模式</li><li>适配器模式</li><li>装饰者模式</li><li>桥接模式</li><li>外观模式</li><li>组合模式</li><li>享元模式</li></ul><h2 id="5-1-代理模式"><a href="#5-1-代理模式" class="headerlink" title="5.1 代理模式"></a>5.1 代理模式</h2><h3 id="5-1-1-概述"><a href="#5-1-1-概述" class="headerlink" title="5.1.1 概述"></a>5.1.1 概述</h3><p>由于某些原因需要给某对象提供一个代理以控制对该对象的访问。这时，访问对象不适合或者不能直接引用目标对象，代理对象作为访问对象和目标对象之间的中介。</p><p>Java中的代理按照代理类生成时机不同又分为静态代理和动态代理。静态代理代理类在编译期就生成，而动态代理代理类则是在Java运行时动态生成。动态代理又有JDK代理和CGLib代理两种。</p><h3 id="5-1-2-结构"><a href="#5-1-2-结构" class="headerlink" title="5.1.2 结构"></a>5.1.2 结构</h3><p>代理（Proxy）模式分为三种角色：</p><ul><li>抽象主题（Subject）类： 通过接口或抽象类声明真实主题和代理对象实现的业务方法。</li><li>真实主题（Real Subject）类： 实现了抽象主题中的具体业务，是代理对象所代表的真实对象，是最终要引用的对象。</li><li>代理（Proxy）类 ： 提供了与真实主题相同的接口，其内部含有对真实主题的引用，它可以访问、控制或扩展真实主题的功能。</li></ul><h3 id="5-1-3-静态代理"><a href="#5-1-3-静态代理" class="headerlink" title="5.1.3 静态代理"></a>5.1.3 静态代理</h3><p>我们通过案例来感受一下静态代理。</p><p>【例】火车站卖票</p><p>如果要买火车票的话，需要去火车站买票，坐车到火车站，排队等一系列的操作，显然比较麻烦。而火车站在多个地方都有代售点，我们去代售点买票就方便很多了。这个例子其实就是典型的代理模式，火车站是目标对象，代售点是代理对象。类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86.png" style="zoom:80%;" /><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//卖票接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SellTickets</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sell</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-comment">//火车站  火车站具有卖票功能，所以需要实现SellTickets接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrainStation</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SellTickets</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sell</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;火车站卖票&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//代售点</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyPoint</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SellTickets</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">TrainStation</span> <span class="hljs-variable">station</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrainStation</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sell</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;代理点收取一些服务费用&quot;</span>);<br>        station.sell();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ProxyPoint</span> <span class="hljs-variable">pp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyPoint</span>();<br>        pp.sell();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>从上面代码中可以看出测试类直接访问的是ProxyPoint类对象，也就是说ProxyPoint作为访问对象和目标对象的中介。同时也对sell方法进行了增强（代理点收取一些服务费用）。</p><h3 id="5-1-4-JDK动态代理"><a href="#5-1-4-JDK动态代理" class="headerlink" title="5.1.4 JDK动态代理"></a>5.1.4 JDK动态代理</h3><p>接下来我们使用动态代理实现上面案例，先说说JDK提供的动态代理。Java中提供了一个动态代理类Proxy，Proxy并不是我们上述所说的代理对象的类，而是提供了一个创建代理对象的静态方法（newProxyInstance方法）来获取代理对象。</p><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//卖票接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SellTickets</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sell</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-comment">//火车站  火车站具有卖票功能，所以需要实现SellTickets接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrainStation</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SellTickets</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sell</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;火车站卖票&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//代理工厂，用来创建代理对象</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyFactory</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">TrainStation</span> <span class="hljs-variable">station</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrainStation</span>();<br><br>    <span class="hljs-keyword">public</span> SellTickets <span class="hljs-title function_">getProxyObject</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//使用Proxy获取代理对象</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">            newProxyInstance()方法参数说明：</span><br><span class="hljs-comment">                ClassLoader loader ： 类加载器，用于加载代理类，使用真实对象的类加载器即可</span><br><span class="hljs-comment">                Class&lt;?&gt;[] interfaces ： 真实对象所实现的接口，代理模式真实对象和代理对象实现相同的接口</span><br><span class="hljs-comment">                InvocationHandler h ： 代理对象的调用处理程序</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">SellTickets</span> <span class="hljs-variable">sellTickets</span> <span class="hljs-operator">=</span> (SellTickets) Proxy.newProxyInstance(station.getClass().getClassLoader(),<br>                station.getClass().getInterfaces(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvocationHandler</span>() &#123;<br>                    <span class="hljs-comment">/*</span><br><span class="hljs-comment">                        InvocationHandler中invoke方法参数说明：</span><br><span class="hljs-comment">                            proxy ： 代理对象</span><br><span class="hljs-comment">                            method ： 对应于在代理对象上调用的接口方法的 Method 实例</span><br><span class="hljs-comment">                            args ： 代理对象调用接口方法时传递的实际参数</span><br><span class="hljs-comment">                     */</span><br>                    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br><br>                        System.out.println(<span class="hljs-string">&quot;代理点收取一些服务费用(JDK动态代理方式)&quot;</span>);<br>                        <span class="hljs-comment">//执行真实对象</span><br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(station, args);<br>                        <span class="hljs-keyword">return</span> result;<br>                    &#125;<br>                &#125;);<br>        <span class="hljs-keyword">return</span> sellTickets;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//获取代理对象</span><br>        <span class="hljs-type">ProxyFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyFactory</span>();<br>        <br>        <span class="hljs-type">SellTickets</span> <span class="hljs-variable">proxyObject</span> <span class="hljs-operator">=</span> factory.getProxyObject();<br>        proxyObject.sell();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><font color="red">使用了动态代理，我们思考下面问题：</font></p><ul><li><p>ProxyFactory是代理类吗？</p><p>ProxyFactory不是代理模式中所说的代理类，而代理类是程序在运行过程中动态的在内存中生成的类。通过阿里巴巴开源的 Java 诊断工具（Arthas【阿尔萨斯】）查看代理类的结构：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sun.proxy;<br><br><span class="hljs-keyword">import</span> com.itheima.proxy.dynamic.jdk.SellTickets;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.lang.reflect.UndeclaredThrowableException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">$Proxy0</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SellTickets</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m1;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m2;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m3;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m0;<br><br>    <span class="hljs-keyword">public</span> $Proxy0(InvocationHandler invocationHandler) &#123;<br>        <span class="hljs-built_in">super</span>(invocationHandler);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            m1 = Class.forName(<span class="hljs-string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="hljs-string">&quot;equals&quot;</span>, Class.forName(<span class="hljs-string">&quot;java.lang.Object&quot;</span>));<br>            m2 = Class.forName(<span class="hljs-string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="hljs-string">&quot;toString&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]);<br>            m3 = Class.forName(<span class="hljs-string">&quot;com.itheima.proxy.dynamic.jdk.SellTickets&quot;</span>).getMethod(<span class="hljs-string">&quot;sell&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]);<br>            m0 = Class.forName(<span class="hljs-string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="hljs-string">&quot;hashCode&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (NoSuchMethodException noSuchMethodException) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchMethodError</span>(noSuchMethodException.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (ClassNotFoundException classNotFoundException) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoClassDefFoundError</span>(classNotFoundException.getMessage());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object object)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> (Boolean)<span class="hljs-built_in">this</span>.h.invoke(<span class="hljs-built_in">this</span>, m1, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;object&#125;);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Error | RuntimeException throwable) &#123;<br>            <span class="hljs-keyword">throw</span> throwable;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Throwable throwable) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndeclaredThrowableException</span>(throwable);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> (String)<span class="hljs-built_in">this</span>.h.invoke(<span class="hljs-built_in">this</span>, m2, <span class="hljs-literal">null</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Error | RuntimeException throwable) &#123;<br>            <span class="hljs-keyword">throw</span> throwable;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Throwable throwable) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndeclaredThrowableException</span>(throwable);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> (Integer)<span class="hljs-built_in">this</span>.h.invoke(<span class="hljs-built_in">this</span>, m0, <span class="hljs-literal">null</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Error | RuntimeException throwable) &#123;<br>            <span class="hljs-keyword">throw</span> throwable;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Throwable throwable) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndeclaredThrowableException</span>(throwable);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sell</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.h.invoke(<span class="hljs-built_in">this</span>, m3, <span class="hljs-literal">null</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Error | RuntimeException throwable) &#123;<br>            <span class="hljs-keyword">throw</span> throwable;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Throwable throwable) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndeclaredThrowableException</span>(throwable);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>从上面的类中，我们可以看到以下几个信息：</p><ul><li>代理类（$Proxy0）实现了SellTickets。这也就印证了我们之前说的真实类和代理类实现同样的接口。</li><li>代理类（$Proxy0）将我们提供了的匿名内部类对象传递给了父类。</li></ul></li><li><p>动态代理的执行流程是什么样？</p><p>下面是摘取的重点代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//程序运行过程中动态生成的代理类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">$Proxy0</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SellTickets</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m3;<br><br>    <span class="hljs-keyword">public</span> $Proxy0(InvocationHandler invocationHandler) &#123;<br>        <span class="hljs-built_in">super</span>(invocationHandler);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        m3 = Class.forName(<span class="hljs-string">&quot;com.itheima.proxy.dynamic.jdk.SellTickets&quot;</span>).getMethod(<span class="hljs-string">&quot;sell&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sell</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.h.invoke(<span class="hljs-built_in">this</span>, m3, <span class="hljs-literal">null</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//Java提供的动态代理相关类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable &#123;<br><span class="hljs-keyword">protected</span> InvocationHandler h;<br> <br><span class="hljs-keyword">protected</span> <span class="hljs-title function_">Proxy</span><span class="hljs-params">(InvocationHandler h)</span> &#123;<br>        <span class="hljs-built_in">this</span>.h = h;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//代理工厂类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyFactory</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">TrainStation</span> <span class="hljs-variable">station</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrainStation</span>();<br><br>    <span class="hljs-keyword">public</span> SellTickets <span class="hljs-title function_">getProxyObject</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">SellTickets</span> <span class="hljs-variable">sellTickets</span> <span class="hljs-operator">=</span> (SellTickets) Proxy.newProxyInstance(station.getClass().getClassLoader(),<br>                station.getClass().getInterfaces(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvocationHandler</span>() &#123;<br>                    <br>                    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br><br>                        System.out.println(<span class="hljs-string">&quot;代理点收取一些服务费用(JDK动态代理方式)&quot;</span>);<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(station, args);<br>                        <span class="hljs-keyword">return</span> result;<br>                    &#125;<br>                &#125;);<br>        <span class="hljs-keyword">return</span> sellTickets;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">//测试访问类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//获取代理对象</span><br>        <span class="hljs-type">ProxyFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyFactory</span>();<br>        <span class="hljs-type">SellTickets</span> <span class="hljs-variable">proxyObject</span> <span class="hljs-operator">=</span> factory.getProxyObject();<br>        proxyObject.sell();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>执行流程如下：</p><pre><code class="hljs">1. 在测试类中通过代理对象调用sell()方法2. 根据多态的特性，执行的是代理类（$Proxy0）中的sell()方法3. 代理类（$Proxy0）中的sell()方法中又调用了InvocationHandler接口的子实现类对象的invoke方法4. invoke方法通过反射执行了真实对象所属类(TrainStation)中的sell()方法</code></pre><h3 id="5-1-5-CGLIB动态代理"><a href="#5-1-5-CGLIB动态代理" class="headerlink" title="5.1.5 CGLIB动态代理"></a>5.1.5 CGLIB动态代理</h3><p>同样是上面的案例，我们再次使用CGLIB代理实现。</p><p>如果没有定义SellTickets接口，只定义了TrainStation(火车站类)。很显然JDK代理是无法使用了，因为JDK动态代理要求必须定义接口，对接口进行代理。</p><p>CGLIB是一个功能强大，高性能的代码生成包。它为没有实现接口的类提供代理，为JDK的动态代理提供了很好的补充。</p><p>CGLIB是第三方提供的包，所以需要引入jar包的坐标：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cglib<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cglib<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//火车站</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrainStation</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sell</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;火车站卖票&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//代理工厂</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">TrainStation</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrainStation</span>();<br><br>    <span class="hljs-keyword">public</span> TrainStation <span class="hljs-title function_">getProxyObject</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//创建Enhancer对象，类似于JDK动态代理的Proxy类，下一步就是设置几个参数</span><br>        <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();<br>        <span class="hljs-comment">//设置父类的字节码对象</span><br>        enhancer.setSuperclass(target.getClass());<br>        <span class="hljs-comment">//设置回调函数</span><br>        enhancer.setCallback(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-comment">//创建代理对象</span><br>        <span class="hljs-type">TrainStation</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> (TrainStation) enhancer.create();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        intercept方法参数说明：</span><br><span class="hljs-comment">            o ： 代理对象</span><br><span class="hljs-comment">            method ： 真实对象中的方法的Method实例</span><br><span class="hljs-comment">            args ： 实际参数</span><br><span class="hljs-comment">            methodProxy ：代理对象中的方法的method实例</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> TrainStation <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object o, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        System.out.println(<span class="hljs-string">&quot;代理点收取一些服务费用(CGLIB动态代理方式)&quot;</span>);<br>        <span class="hljs-type">TrainStation</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (TrainStation) methodProxy.invokeSuper(o, args);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//创建代理工厂对象</span><br>        <span class="hljs-type">ProxyFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyFactory</span>();<br>        <span class="hljs-comment">//获取代理对象</span><br>        <span class="hljs-type">TrainStation</span> <span class="hljs-variable">proxyObject</span> <span class="hljs-operator">=</span> factory.getProxyObject();<br><br>        proxyObject.sell();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-1-6-三种代理的对比"><a href="#5-1-6-三种代理的对比" class="headerlink" title="5.1.6 三种代理的对比"></a>5.1.6 三种代理的对比</h3><ul><li><p>jdk代理和CGLIB代理</p><p>使用CGLib实现动态代理，CGLib底层采用ASM字节码生成框架，使用字节码技术生成代理类，在JDK1.6之前比使用Java反射效率要高。唯一需要注意的是，CGLib不能对声明为final的类或者方法进行代理，因为CGLib原理是动态生成被代理类的子类。</p><p>在JDK1.6、JDK1.7、JDK1.8逐步对JDK动态代理优化之后，在调用次数较少的情况下，JDK代理效率高于CGLib代理效率，只有当进行大量调用的时候，JDK1.6和JDK1.7比CGLib代理效率低一点，但是到JDK1.8的时候，JDK代理效率高于CGLib代理。所以如果有接口使用JDK动态代理，如果没有接口使用CGLIB代理。</p></li><li><p>动态代理和静态代理</p><p>动态代理与静态代理相比较，最大的好处是接口中声明的所有方法都被转移到调用处理器一个集中的方法中处理（InvocationHandler.invoke）。这样，在接口方法数量比较多的时候，我们可以进行灵活处理，而不需要像静态代理那样每一个方法进行中转。</p><p>如果接口增加一个方法，静态代理模式除了所有实现类需要实现这个方法外，所有代理类也需要实现此方法。增加了代码维护的复杂度。而动态代理不会出现该问题</p></li></ul><h3 id="5-1-7-优缺点"><a href="#5-1-7-优缺点" class="headerlink" title="5.1.7 优缺点"></a>5.1.7 优缺点</h3><p><strong>优点：</strong></p><ul><li>代理模式在客户端与目标对象之间起到一个中介作用和保护目标对象的作用；</li><li>代理对象可以扩展目标对象的功能；</li><li>代理模式能将客户端与目标对象分离，在一定程度上降低了系统的耦合度；</li></ul><p><strong>缺点：</strong></p><ul><li>增加了系统的复杂度；</li></ul><h3 id="5-1-8-使用场景"><a href="#5-1-8-使用场景" class="headerlink" title="5.1.8 使用场景"></a>5.1.8 使用场景</h3><ul><li><p>远程（Remote）代理</p><p>本地服务通过网络请求远程服务。为了实现本地到远程的通信，我们需要实现网络通信，处理其中可能的异常。为良好的代码设计和可维护性，我们将网络通信部分隐藏起来，只暴露给本地服务一个接口，通过该接口即可访问远程服务提供的功能，而不必过多关心通信部分的细节。</p></li><li><p>防火墙（Firewall）代理</p><p>当你将浏览器配置成使用代理功能时，防火墙就将你的浏览器的请求转给互联网；当互联网返回响应时，代理服务器再把它转给你的浏览器。</p></li><li><p>保护（Protect or Access）代理</p><p>控制对一个对象的访问，如果需要，可以给不同的用户提供不同级别的使用权限。</p></li></ul><h2 id="5-2-适配器模式"><a href="#5-2-适配器模式" class="headerlink" title="5.2 适配器模式"></a>5.2 适配器模式</h2><h3 id="5-2-1-概述"><a href="#5-2-1-概述" class="headerlink" title="5.2.1 概述"></a>5.2.1 概述</h3><p>如果去欧洲国家去旅游的话，他们的插座如下图最左边，是欧洲标准。而我们使用的插头如下图最右边的。因此我们的笔记本电脑，手机在当地不能直接充电。所以就需要一个插座转换器，转换器第1面插入当地的插座，第2面供我们充电，这样使得我们的插头在当地能使用。生活中这样的例子很多，手机充电器（将220v转换为5v的电压），读卡器等，其实就是使用到了适配器模式。</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%BD%AC%E6%8E%A5%E5%A4%B4.png"></p><p><strong>定义：</strong></p><p>​将一个类的接口转换成客户希望的另外一个接口，使得原本由于接口不兼容而不能一起工作的那些类能一起工作。</p><p>​适配器模式分为类适配器模式和对象适配器模式，前者类之间的耦合度比后者高，且要求程序员了解现有组件库中的相关组件的内部结构，所以应用相对较少些。</p><h3 id="5-2-2-结构"><a href="#5-2-2-结构" class="headerlink" title="5.2.2 结构"></a>5.2.2 结构</h3><p>适配器模式（Adapter）包含以下主要角色：</p><ul><li>目标（Target）接口：当前系统业务所期待的接口，它可以是抽象类或接口。</li><li>适配者（Adaptee）类：它是被访问和适配的现存组件库中的组件接口。</li><li>适配器（Adapter）类：它是一个转换器，通过继承或引用适配者的对象，把适配者接口转换成目标接口，让客户按目标接口的格式访问适配者。</li></ul><h3 id="5-2-3-类适配器模式"><a href="#5-2-3-类适配器模式" class="headerlink" title="5.2.3 类适配器模式"></a>5.2.3 类适配器模式</h3><p>实现方式：定义一个适配器类来实现当前系统的业务接口，同时又继承现有组件库中已经存在的组件。</p><p>【例】读卡器</p><p>现有一台电脑只能读取SD卡，而要读取TF卡中的内容的话就需要使用到适配器模式。创建一个读卡器，将TF卡中的内容读取出来。</p><p>类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F.png" style="zoom:80%;" /><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//SD卡的接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SDCard</span> &#123;<br>    <span class="hljs-comment">//读取SD卡方法</span><br>    String <span class="hljs-title function_">readSD</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">//写入SD卡功能</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeSD</span><span class="hljs-params">(String msg)</span>;<br>&#125;<br><br><span class="hljs-comment">//SD卡实现类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SDCardImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SDCard</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">readSD</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sd card read a msg :hello word SD&quot;</span>;<br>        <span class="hljs-keyword">return</span> msg;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeSD</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;sd card write msg : &quot;</span> + msg);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//电脑类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Computer</span> &#123;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">readSD</span><span class="hljs-params">(SDCard sdCard)</span> &#123;<br>        <span class="hljs-keyword">if</span>(sdCard == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">&quot;sd card null&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> sdCard.readSD();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//TF卡接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TFCard</span> &#123;<br>    <span class="hljs-comment">//读取TF卡方法</span><br>    String <span class="hljs-title function_">readTF</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">//写入TF卡功能</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeTF</span><span class="hljs-params">(String msg)</span>;<br>&#125;<br><br><span class="hljs-comment">//TF卡实现类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TFCardImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TFCard</span> &#123;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">readTF</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;tf card read msg : hello word tf card&quot;</span>;<br>        <span class="hljs-keyword">return</span> msg;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeTF</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;tf card write a msg : &quot;</span> + msg);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//定义适配器类（SD兼容TF）</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SDAdapterTF</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TFCardImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SDCard</span> &#123;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">readSD</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;adapter read tf card &quot;</span>);<br>        <span class="hljs-keyword">return</span> readTF();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeSD</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;adapter write tf card&quot;</span>);<br>        writeTF(msg);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Computer</span> <span class="hljs-variable">computer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Computer</span>();<br>        <span class="hljs-type">SDCard</span> <span class="hljs-variable">sdCard</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SDCardImpl</span>();<br>        System.out.println(computer.readSD(sdCard));<br><br>        System.out.println(<span class="hljs-string">&quot;------------&quot;</span>);<br><br>        <span class="hljs-type">SDAdapterTF</span> <span class="hljs-variable">adapter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SDAdapterTF</span>();<br>        System.out.println(computer.readSD(adapter));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>类适配器模式违背了合成复用原则。类适配器是客户类有一个接口规范的情况下可用，反之不可用。</p><h3 id="5-2-4-对象适配器模式"><a href="#5-2-4-对象适配器模式" class="headerlink" title="5.2.4 对象适配器模式"></a>5.2.4 对象适配器模式</h3><p>实现方式：对象适配器模式可釆用将现有组件库中已经实现的组件引入适配器类中，该类同时实现当前系统的业务接口。</p><p>【例】读卡器</p><p>我们使用对象适配器模式将读卡器的案例进行改写。类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%AF%B9%E8%B1%A1%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F.png" style="zoom:80%;" /><p>代码如下：</p><p>类适配器模式的代码，我们只需要修改适配器类（SDAdapterTF）和测试类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//创建适配器对象（SD兼容TF）</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SDAdapterTF</span>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SDCard</span> &#123;<br><br>    <span class="hljs-keyword">private</span> TFCard tfCard;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SDAdapterTF</span><span class="hljs-params">(TFCard tfCard)</span> &#123;<br>        <span class="hljs-built_in">this</span>.tfCard = tfCard;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">readSD</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;adapter read tf card &quot;</span>);<br>        <span class="hljs-keyword">return</span> tfCard.readTF();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeSD</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;adapter write tf card&quot;</span>);<br>        tfCard.writeTF(msg);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Computer</span> <span class="hljs-variable">computer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Computer</span>();<br>        <span class="hljs-type">SDCard</span> <span class="hljs-variable">sdCard</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SDCardImpl</span>();<br>        System.out.println(computer.readSD(sdCard));<br><br>        System.out.println(<span class="hljs-string">&quot;------------&quot;</span>);<br><br>        <span class="hljs-type">TFCard</span> <span class="hljs-variable">tfCard</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TFCardImpl</span>();<br>        <span class="hljs-type">SDAdapterTF</span> <span class="hljs-variable">adapter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SDAdapterTF</span>(tfCard);<br>        System.out.println(computer.readSD(adapter));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>注意：还有一个适配器模式是接口适配器模式。当不希望实现一个接口中所有的方法时，可以创建一个抽象类Adapter ，实现所有方法。而此时我们只需要继承该抽象类即可。</p></blockquote><h3 id="5-2-5-应用场景"><a href="#5-2-5-应用场景" class="headerlink" title="5.2.5 应用场景"></a>5.2.5 应用场景</h3><ul><li>以前开发的系统存在满足新系统功能需求的类，但其接口同新系统的接口不一致。</li><li>使用第三方提供的组件，但组件接口定义和自己要求的接口定义不同。</li></ul><h3 id="5-2-6-JDK源码解析"><a href="#5-2-6-JDK源码解析" class="headerlink" title="5.2.6 JDK源码解析"></a>5.2.6 JDK源码解析</h3><p>Reader（字符流）、InputStream（字节流）的适配使用的是InputStreamReader。</p><p>InputStreamReader继承自java.io包中的Reader，对他中的抽象的未实现的方法给出实现。如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-keyword">return</span> sd.read();<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read</span><span class="hljs-params">(<span class="hljs-type">char</span> cbuf[], <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> length)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-keyword">return</span> sd.read(cbuf, offset, length);<br>&#125;<br></code></pre></td></tr></table></figure><p>如上代码中的sd（StreamDecoder类对象），在Sun的JDK实现中，实际的方法实现是对sun.nio.cs.StreamDecoder类的同名方法的调用封装。类结构图如下：</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F-jdk%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.png"></p><p>从上图可以看出：</p><ul><li>InputStreamReader是对同样实现了Reader的StreamDecoder的封装。</li><li>StreamDecoder不是Java SE API中的内容，是Sun  JDK给出的自身实现。但我们知道他们对构造方法中的字节流类（InputStream）进行封装，并通过该类进行了字节流和字符流之间的解码转换。</li></ul><p><font color="red">结论：</font></p><p>​从表层来看，InputStreamReader做了InputStream字节流类到Reader字符流之间的转换。而从如上Sun JDK中的实现类关系结构中可以看出，是StreamDecoder的设计实现在实际上采用了适配器模式。</p><h2 id="5-3-装饰者模式"><a href="#5-3-装饰者模式" class="headerlink" title="5.3 装饰者模式"></a>5.3 装饰者模式</h2><h3 id="5-3-1-概述"><a href="#5-3-1-概述" class="headerlink" title="5.3.1 概述"></a>5.3.1 概述</h3><p>我们先来看一个快餐店的例子。</p><p>快餐店有炒面、炒饭这些快餐，可以额外附加鸡蛋、火腿、培根这些配菜，当然加配菜需要额外加钱，每个配菜的价钱通常不太一样，那么计算总价就会显得比较麻烦。</p><img src="D:/传智播客/专题/设计模式/成品/笔记/assets/装饰者模式-使用前.png" style="zoom:80%;" /><p>使用继承的方式存在的问题：</p><ul><li><p>扩展性不好</p><p>如果要再加一种配料（火腿肠），我们就会发现需要给FriedRice和FriedNoodles分别定义一个子类。如果要新增一个快餐品类（炒河粉）的话，就需要定义更多的子类。</p></li><li><p>产生过多的子类</p></li></ul><p><strong>定义：</strong></p><p>​指在不改变现有对象结构的情况下，动态地给该对象增加一些职责（即增加其额外功能）的模式。</p><h3 id="5-3-2-结构"><a href="#5-3-2-结构" class="headerlink" title="5.3.2 结构"></a>5.3.2 结构</h3><p>装饰（Decorator）模式中的角色：</p><ul><li>抽象构件（Component）角色 ：定义一个抽象接口以规范准备接收附加责任的对象。</li><li>具体构件（Concrete  Component）角色 ：实现抽象构件，通过装饰角色为其添加一些职责。</li><li>抽象装饰（Decorator）角色 ： 继承或实现抽象构件，并包含具体构件的实例，可以通过其子类扩展具体构件的功能。</li><li>具体装饰（ConcreteDecorator）角色 ：实现抽象装饰的相关方法，并给具体构件对象添加附加的责任。</li></ul><h3 id="5-3-3-案例"><a href="#5-3-3-案例" class="headerlink" title="5.3.3 案例"></a>5.3.3 案例</h3><p>我们使用装饰者模式对快餐店案例进行改进，体会装饰者模式的精髓。</p><p>类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A3%85%E9%A5%B0%E8%80%85%E6%A8%A1%E5%BC%8F.png" style="zoom:75%;" /><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//快餐接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FastFood</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">float</span> price;<br>    <span class="hljs-keyword">private</span> String desc;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FastFood</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FastFood</span><span class="hljs-params">(<span class="hljs-type">float</span> price, String desc)</span> &#123;<br>        <span class="hljs-built_in">this</span>.price = price;<br>        <span class="hljs-built_in">this</span>.desc = desc;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPrice</span><span class="hljs-params">(<span class="hljs-type">float</span> price)</span> &#123;<br>        <span class="hljs-built_in">this</span>.price = price;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">float</span> <span class="hljs-title function_">getPrice</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> price;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDesc</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> desc;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDesc</span><span class="hljs-params">(String desc)</span> &#123;<br>        <span class="hljs-built_in">this</span>.desc = desc;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">float</span> <span class="hljs-title function_">cost</span><span class="hljs-params">()</span>;  <span class="hljs-comment">//获取价格</span><br>&#125;<br><br><span class="hljs-comment">//炒饭</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FriedRice</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FastFood</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FriedRice</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>(<span class="hljs-number">10</span>, <span class="hljs-string">&quot;炒饭&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">float</span> <span class="hljs-title function_">cost</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> getPrice();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//炒面</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FriedNoodles</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FastFood</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FriedNoodles</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>(<span class="hljs-number">12</span>, <span class="hljs-string">&quot;炒面&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">float</span> <span class="hljs-title function_">cost</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> getPrice();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//配料类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Garnish</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FastFood</span> &#123;<br><br>    <span class="hljs-keyword">private</span> FastFood fastFood;<br><br>    <span class="hljs-keyword">public</span> FastFood <span class="hljs-title function_">getFastFood</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> fastFood;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFastFood</span><span class="hljs-params">(FastFood fastFood)</span> &#123;<br>        <span class="hljs-built_in">this</span>.fastFood = fastFood;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Garnish</span><span class="hljs-params">(FastFood fastFood, <span class="hljs-type">float</span> price, String desc)</span> &#123;<br>        <span class="hljs-built_in">super</span>(price,desc);<br>        <span class="hljs-built_in">this</span>.fastFood = fastFood;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//鸡蛋配料</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Egg</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Garnish</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Egg</span><span class="hljs-params">(FastFood fastFood)</span> &#123;<br>        <span class="hljs-built_in">super</span>(fastFood,<span class="hljs-number">1</span>,<span class="hljs-string">&quot;鸡蛋&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">float</span> <span class="hljs-title function_">cost</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> getPrice() + getFastFood().getPrice();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDesc</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.getDesc() + getFastFood().getDesc();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//培根配料</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Bacon</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Garnish</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Bacon</span><span class="hljs-params">(FastFood fastFood)</span> &#123;<br><br>        <span class="hljs-built_in">super</span>(fastFood,<span class="hljs-number">2</span>,<span class="hljs-string">&quot;培根&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">float</span> <span class="hljs-title function_">cost</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> getPrice() + getFastFood().getPrice();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDesc</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.getDesc() + getFastFood().getDesc();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//点一份炒饭</span><br>        <span class="hljs-type">FastFood</span> <span class="hljs-variable">food</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FriedRice</span>();<br>        <span class="hljs-comment">//花费的价格</span><br>        System.out.println(food.getDesc() + <span class="hljs-string">&quot; &quot;</span> + food.cost() + <span class="hljs-string">&quot;元&quot;</span>);<br><br>        System.out.println(<span class="hljs-string">&quot;========&quot;</span>);<br>        <span class="hljs-comment">//点一份加鸡蛋的炒饭</span><br>        <span class="hljs-type">FastFood</span> <span class="hljs-variable">food1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FriedRice</span>();<br><br>        food1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Egg</span>(food1);<br>        <span class="hljs-comment">//花费的价格</span><br>        System.out.println(food1.getDesc() + <span class="hljs-string">&quot; &quot;</span> + food1.cost() + <span class="hljs-string">&quot;元&quot;</span>);<br><br>        System.out.println(<span class="hljs-string">&quot;========&quot;</span>);<br>        <span class="hljs-comment">//点一份加培根的炒面</span><br>        <span class="hljs-type">FastFood</span> <span class="hljs-variable">food2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FriedNoodles</span>();<br>        food2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bacon</span>(food2);<br>        <span class="hljs-comment">//花费的价格</span><br>        System.out.println(food2.getDesc() + <span class="hljs-string">&quot; &quot;</span> + food2.cost() + <span class="hljs-string">&quot;元&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>好处：</strong></p><ul><li><p>饰者模式可以带来比继承更加灵活性的扩展功能，使用更加方便，可以通过组合不同的装饰者对象来获取具有不同行为状态的多样化的结果。装饰者模式比继承更具良好的扩展性，完美的遵循开闭原则，继承是静态的附加责任，装饰者则是动态的附加责任。</p></li><li><p>装饰类和被装饰类可以独立发展，不会相互耦合，装饰模式是继承的一个替代模式，装饰模式可以动态扩展一个实现类的功能。</p></li></ul><h3 id="5-3-4-使用场景"><a href="#5-3-4-使用场景" class="headerlink" title="5.3.4 使用场景"></a>5.3.4 使用场景</h3><ul><li><p>当不能采用继承的方式对系统进行扩充或者采用继承不利于系统扩展和维护时。</p><p>不能采用继承的情况主要有两类：</p><ul><li>第一类是系统中存在大量独立的扩展，为支持每一种组合将产生大量的子类，使得子类数目呈爆炸性增长；</li><li>第二类是因为类定义不能继承（如final类）</li></ul></li><li><p>在不影响其他对象的情况下，以动态、透明的方式给单个对象添加职责。</p></li><li><p>当对象的功能要求可以动态地添加，也可以再动态地撤销时。</p></li></ul><h3 id="5-3-5-JDK源码解析"><a href="#5-3-5-JDK源码解析" class="headerlink" title="5.3.5 JDK源码解析"></a>5.3.5 JDK源码解析</h3><p>IO流中的包装类使用到了装饰者模式。BufferedInputStream，BufferedOutputStream，BufferedReader，BufferedWriter。</p><p>我们以BufferedWriter举例来说明，先看看如何使用BufferedWriter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//创建BufferedWriter对象</span><br>        <span class="hljs-comment">//创建FileWriter对象</span><br>        <span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">&quot;C:\\Users\\Think\\Desktop\\a.txt&quot;</span>);<br>        <span class="hljs-type">BufferedWriter</span> <span class="hljs-variable">bw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedWriter</span>(fw);<br><br>        <span class="hljs-comment">//写数据</span><br>        bw.write(<span class="hljs-string">&quot;hello Buffered&quot;</span>);<br><br>        bw.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>使用起来感觉确实像是装饰者模式，接下来看它们的结构：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A3%85%E9%A5%B0%E8%80%85%E6%A8%A1%E5%BC%8F-jdk%E6%BA%90%E7%A0%81.png" style="zoom:80%;" /><blockquote><p><font color="red">小结：</font></p><p>​BufferedWriter使用装饰者模式对Writer子实现类进行了增强，添加了缓冲区，提高了写数据的效率。</p></blockquote><h3 id="5-3-6-代理和装饰者的区别"><a href="#5-3-6-代理和装饰者的区别" class="headerlink" title="5.3.6 代理和装饰者的区别"></a>5.3.6 代理和装饰者的区别</h3><p>静态代理和装饰者模式的区别：</p><ul><li>相同点：<ul><li>都要实现与目标类相同的业务接口</li><li>在两个类中都要声明目标对象</li><li>都可以在不修改目标类的前提下增强目标方法</li></ul></li><li>不同点：<ul><li>目的不同<br>装饰者是为了增强目标对象<br>静态代理是为了保护和隐藏目标对象</li><li>获取目标对象构建的地方不同<br>装饰者是由外界传递进来，可以通过构造方法传递<br>静态代理是在代理类内部创建，以此来隐藏目标对象</li></ul></li></ul><h2 id="5-4-桥接模式"><a href="#5-4-桥接模式" class="headerlink" title="5.4 桥接模式"></a>5.4 桥接模式</h2><h3 id="5-4-1-概述"><a href="#5-4-1-概述" class="headerlink" title="5.4.1 概述"></a>5.4.1 概述</h3><p>现在有一个需求，需要创建不同的图形，并且每个图形都有可能会有不同的颜色。我们可以利用继承的方式来设计类的关系：</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200207194617620.png"></p><p>我们可以发现有很多的类，假如我们再增加一个形状或再增加一种颜色，就需要创建更多的类。</p><p>试想，在一个有多种可能会变化的维度的系统中，用继承方式会造成类爆炸，扩展起来不灵活。每次在一个维度上新增一个具体实现都要增加多个子类。为了更加灵活的设计系统，我们此时可以考虑使用桥接模式。</p><p><strong>定义：</strong></p><p>​将抽象与实现分离，使它们可以独立变化。它是用组合关系代替继承关系来实现，从而降低了抽象和实现这两个可变维度的耦合度。</p><h3 id="5-4-2-结构"><a href="#5-4-2-结构" class="headerlink" title="5.4.2 结构"></a>5.4.2 结构</h3><p>桥接（Bridge）模式包含以下主要角色：</p><ul><li>抽象化（Abstraction）角色 ：定义抽象类，并包含一个对实现化对象的引用。</li><li>扩展抽象化（Refined  Abstraction）角色 ：是抽象化角色的子类，实现父类中的业务方法，并通过组合关系调用实现化角色中的业务方法。</li><li>实现化（Implementor）角色 ：定义实现化角色的接口，供扩展抽象化角色调用。</li><li>具体实现化（Concrete Implementor）角色 ：给出实现化角色接口的具体实现。</li></ul><h3 id="5-4-3-案例"><a href="#5-4-3-案例" class="headerlink" title="5.4.3 案例"></a>5.4.3 案例</h3><p>【例】视频播放器</p><p>需要开发一个跨平台视频播放器，可以在不同操作系统平台（如Windows、Mac、Linux等）上播放多种格式的视频文件，常见的视频格式包括RMVB、AVI、WMV等。该播放器包含了两个维度，适合使用桥接模式。</p><p>类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F.png" style="zoom:80%;" /><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//视频文件</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">VideoFile</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">decode</span><span class="hljs-params">(String fileName)</span>;<br>&#125;<br><br><span class="hljs-comment">//avi文件</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AVIFile</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">VideoFile</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decode</span><span class="hljs-params">(String fileName)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;avi视频文件：&quot;</span>+ fileName);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//rmvb文件</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">REVBBFile</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">VideoFile</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decode</span><span class="hljs-params">(String fileName)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;rmvb文件：&quot;</span> + fileName);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//操作系统版本</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperatingSystemVersion</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> VideoFile videoFile;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OperatingSystemVersion</span><span class="hljs-params">(VideoFile videoFile)</span> &#123;<br>        <span class="hljs-built_in">this</span>.videoFile = videoFile;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">play</span><span class="hljs-params">(String fileName)</span>;<br>&#125;<br><br><span class="hljs-comment">//Windows版本</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Windows</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OperatingSystem</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Windows</span><span class="hljs-params">(VideoFile videoFile)</span> &#123;<br>        <span class="hljs-built_in">super</span>(videoFile);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">play</span><span class="hljs-params">(String fileName)</span> &#123;<br>        videoFile.decode(fileName);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//mac版本</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Mac</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OperatingSystemVersion</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Mac</span><span class="hljs-params">(VideoFile videoFile)</span> &#123;<br>        <span class="hljs-built_in">super</span>(videoFile);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">play</span><span class="hljs-params">(String fileName)</span> &#123;<br>videoFile.decode(fileName);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">OperatingSystem</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Windows</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AVIFile</span>());<br>        os.play(<span class="hljs-string">&quot;战狼3&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>好处：</strong></p><ul><li><p>桥接模式提高了系统的可扩充性，在两个变化维度中任意扩展一个维度，都不需要修改原有系统。</p><p>如：如果现在还有一种视频文件类型wmv，我们只需要再定义一个类实现VideoFile接口即可，其他类不需要发生变化。</p></li><li><p>实现细节对客户透明</p></li></ul><h3 id="5-4-4-使用场景"><a href="#5-4-4-使用场景" class="headerlink" title="5.4.4 使用场景"></a>5.4.4 使用场景</h3><ul><li>当一个类存在两个独立变化的维度，且这两个维度都需要进行扩展时。</li><li>当一个系统不希望使用继承或因为多层次继承导致系统类的个数急剧增加时。</li><li>当一个系统需要在构件的抽象化角色和具体化角色之间增加更多的灵活性时。避免在两个层次之间建立静态的继承联系，通过桥接模式可以使它们在抽象层建立一个关联关系。</li></ul><h2 id="5-5-外观模式"><a href="#5-5-外观模式" class="headerlink" title="5.5 外观模式"></a>5.5 外观模式</h2><h3 id="5-5-1-概述"><a href="#5-5-1-概述" class="headerlink" title="5.5.1 概述"></a>5.5.1 概述</h3><p>有些人可能炒过股票，但其实大部分人都不太懂，这种没有足够了解证券知识的情况下做股票是很容易亏钱的，刚开始炒股肯定都会想，如果有个懂行的帮帮手就好，其实基金就是个好帮手，支付宝里就有许多的基金，它将投资者分散的资金集中起来，交由专业的经理人进行管理，投资于股票、债券、外汇等领域，而基金投资的收益归持有者所有，管理机构收取一定比例的托管管理费用。</p><p><strong>定义：</strong></p><p>​又名门面模式，是一种通过为多个复杂的子系统提供一个一致的接口，而使这些子系统更加容易被访问的模式。该模式对外有一个统一接口，外部应用程序不用关心内部子系统的具体的细节，这样会大大降低应用程序的复杂度，提高了程序的可维护性。</p><p>​外观（Facade）模式是“迪米特法则”的典型应用</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F%E5%BC%95%E5%85%A5.jpg"></p><h3 id="5-5-2-结构"><a href="#5-5-2-结构" class="headerlink" title="5.5.2 结构"></a>5.5.2 结构</h3><p>外观（Facade）模式包含以下主要角色：</p><ul><li>外观（Facade）角色：为多个子系统对外提供一个共同的接口。</li><li>子系统（Sub System）角色：实现系统的部分功能，客户可以通过外观角色访问它。</li></ul><h3 id="5-5-3-案例"><a href="#5-5-3-案例" class="headerlink" title="5.5.3 案例"></a>5.5.3 案例</h3><p>【例】智能家电控制</p><p>小明的爷爷已经60岁了，一个人在家生活：每次都需要打开灯、打开电视、打开空调；睡觉时关闭灯、关闭电视、关闭空调；操作起来都比较麻烦。所以小明给爷爷买了智能音箱，可以通过语音直接控制这些智能家电的开启和关闭。类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F.png" style="zoom:80%;" /><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//灯类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Light</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">on</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;打开了灯....&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">off</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;关闭了灯....&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//电视类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TV</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">on</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;打开了电视....&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">off</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;关闭了电视....&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//控制类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AirCondition</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">on</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;打开了空调....&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">off</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;关闭了空调....&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//智能音箱</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartAppliancesFacade</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Light light;<br>    <span class="hljs-keyword">private</span> TV tv;<br>    <span class="hljs-keyword">private</span> AirCondition airCondition;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SmartAppliancesFacade</span><span class="hljs-params">()</span> &#123;<br>        light = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Light</span>();<br>        tv = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TV</span>();<br>        airCondition = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AirCondition</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">say</span><span class="hljs-params">(String message)</span> &#123;<br>        <span class="hljs-keyword">if</span>(message.contains(<span class="hljs-string">&quot;打开&quot;</span>)) &#123;<br>            on();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(message.contains(<span class="hljs-string">&quot;关闭&quot;</span>)) &#123;<br>            off();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;我还听不懂你说的！！！&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//起床后一键开电器</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">on</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;起床了&quot;</span>);<br>        light.on();<br>        tv.on();<br>        airCondition.on();<br>    &#125;<br><br>    <span class="hljs-comment">//睡觉一键关电器</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">off</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;睡觉了&quot;</span>);<br>        light.off();<br>        tv.off();<br>        airCondition.off();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//创建外观对象</span><br>        <span class="hljs-type">SmartAppliancesFacade</span> <span class="hljs-variable">facade</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmartAppliancesFacade</span>();<br>        <span class="hljs-comment">//客户端直接与外观对象进行交互</span><br>        facade.say(<span class="hljs-string">&quot;打开家电&quot;</span>);<br>        facade.say(<span class="hljs-string">&quot;关闭家电&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>好处：</strong></p><ul><li>降低了子系统与客户端之间的耦合度，使得子系统的变化不会影响调用它的客户类。</li><li>对客户屏蔽了子系统组件，减少了客户处理的对象数目，并使得子系统使用起来更加容易。</li></ul><p><strong>缺点：</strong></p><ul><li>不符合开闭原则，修改很麻烦</li></ul><h3 id="5-5-4-使用场景"><a href="#5-5-4-使用场景" class="headerlink" title="5.5.4 使用场景"></a>5.5.4 使用场景</h3><ul><li>对分层结构系统构建时，使用外观模式定义子系统中每层的入口点可以简化子系统之间的依赖关系。</li><li>当一个复杂系统的子系统很多时，外观模式可以为系统设计一个简单的接口供外界访问。</li><li>当客户端与多个子系统之间存在很大的联系时，引入外观模式可将它们分离，从而提高子系统的独立性和可移植性。</li></ul><h3 id="5-5-5-源码解析"><a href="#5-5-5-源码解析" class="headerlink" title="5.5.5 源码解析"></a>5.5.5 源码解析</h3><p>使用tomcat作为web容器时，接收浏览器发送过来的请求，tomcat会将请求信息封装成ServletRequest对象，如下图①处对象。但是大家想想ServletRequest是一个接口，它还有一个子接口HttpServletRequest，而我们知道该request对象肯定是一个HttpServletRequest对象的子实现类对象，到底是哪个类的对象呢？可以通过输出request对象，我们就会发现是一个名为RequestFacade的类的对象。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200207234545691.png" style="zoom:60%;" /><p>RequestFacade类就使用了外观模式。先看结构图：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F-jdk%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.png" style="zoom:70%;" /><p><strong>为什么在此处使用外观模式呢？</strong></p><p>​定义 RequestFacade 类，分别实现 ServletRequest ，同时定义私有成员变量 Request ，并且方法的实现调用 Request  的实现。然后，将 RequestFacade上转为 ServletRequest  传给 servlet 的 service 方法，这样即使在 servlet 中被下转为 RequestFacade ，也不能访问私有成员变量对象中的方法。既用了 Request ，又能防止其中方法被不合理的访问。</p><h1 id="5，结构型模式-1"><a href="#5，结构型模式-1" class="headerlink" title="5，结构型模式"></a>5，结构型模式</h1><h2 id="5-6-组合模式"><a href="#5-6-组合模式" class="headerlink" title="5.6 组合模式"></a>5.6 组合模式</h2><h3 id="5-6-1-概述"><a href="#5-6-1-概述" class="headerlink" title="5.6.1 概述"></a>5.6.1 概述</h3><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200208180417291.png" style="zoom:60%;" /><p>​对于这个图片肯定会非常熟悉，上图我们可以看做是一个文件系统，对于这样的结构我们称之为树形结构。在树形结构中可以通过调用某个方法来遍历整个树，当我们找到某个叶子节点后，就可以对叶子节点进行相关的操作。可以将这颗树理解成一个大的容器，容器里面包含很多的成员对象，这些成员对象即可是容器对象也可以是叶子对象。但是由于容器对象和叶子对象在功能上面的区别，使得我们在使用的过程中必须要区分容器对象和叶子对象，但是这样就会给客户带来不必要的麻烦，作为客户而已，它始终希望能够一致的对待容器对象和叶子对象。</p><p><strong>定义：</strong></p><p>​又名部分整体模式，是用于把一组相似的对象当作一个单一的对象。组合模式依据树形结构来组合对象，用来表示部分以及整体层次。这种类型的设计模式属于结构型模式，它创建了对象组的树形结构。</p><h3 id="5-6-2-结构"><a href="#5-6-2-结构" class="headerlink" title="5.6.2 结构"></a>5.6.2 结构</h3><p>组合模式主要包含三种角色：</p><ul><li>抽象根节点（Component）：定义系统各层次对象的共有方法和属性，可以预先定义一些默认行为和属性。</li><li>树枝节点（Composite）：定义树枝节点的行为，存储子节点，组合树枝节点和叶子节点形成一个树形结构。</li><li>叶子节点（Leaf）：叶子节点对象，其下再无分支，是系统层次遍历的最小单位。</li></ul><h3 id="5-6-3-案例实现"><a href="#5-6-3-案例实现" class="headerlink" title="5.6.3 案例实现"></a>5.6.3 案例实现</h3><p>【例】软件菜单</p><p>如下图，我们在访问别的一些管理系统时，经常可以看到类似的菜单。一个菜单可以包含菜单项（菜单项是指不再包含其他内容的菜单条目），也可以包含带有其他菜单项的菜单，因此使用组合模式描述菜单就很恰当，我们的需求是针对一个菜单，打印出其包含的所有菜单以及菜单项的名称。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200208182322313.png" style="zoom:80%;" /><p>要实现该案例，我们先画出类图：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F.png" style="zoom:80%;" /><p><strong>代码实现：</strong></p><p>不管是菜单还是菜单项，都应该继承自统一的接口，这里姑且将这个统一的接口称为菜单组件。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//菜单组件  不管是菜单还是菜单项，都应该继承该类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MenuComponent</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> String name;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> level;<br><br>    <span class="hljs-comment">//添加菜单</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(MenuComponent menuComponent)</span>&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>    &#125;<br><br>    <span class="hljs-comment">//移除菜单</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(MenuComponent menuComponent)</span>&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>    &#125;<br><br>    <span class="hljs-comment">//获取指定的子菜单</span><br>    <span class="hljs-keyword">public</span> MenuComponent <span class="hljs-title function_">getChild</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>    &#125;<br><br>    <span class="hljs-comment">//获取菜单名称</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">print</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里的MenuComponent定义为抽象类，因为有一些共有的属性和行为要在该类中实现，Menu和MenuItem类就可以只覆盖自己感兴趣的方法，而不用搭理不需要或者不感兴趣的方法，举例来说，Menu类可以包含子菜单，因此需要覆盖add()、remove()、getChild()方法，但是MenuItem就不应该有这些方法。这里给出的默认实现是抛出异常，你也可以根据自己的需要改写默认实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Menu</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MenuComponent</span> &#123;<br><br>    <span class="hljs-keyword">private</span> List&lt;MenuComponent&gt; menuComponentList;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Menu</span><span class="hljs-params">(String name,<span class="hljs-type">int</span> level)</span>&#123;<br>        <span class="hljs-built_in">this</span>.level = level;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        menuComponentList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;MenuComponent&gt;();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(MenuComponent menuComponent)</span> &#123;<br>        menuComponentList.add(menuComponent);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(MenuComponent menuComponent)</span> &#123;<br>        menuComponentList.remove(menuComponent);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> MenuComponent <span class="hljs-title function_">getChild</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> &#123;<br>        <span class="hljs-keyword">return</span> menuComponentList.get(i);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">print</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; level; i++) &#123;<br>            System.out.print(<span class="hljs-string">&quot;--&quot;</span>);<br>        &#125;<br>        System.out.println(name);<br>        <span class="hljs-keyword">for</span> (MenuComponent menuComponent : menuComponentList) &#123;<br>            menuComponent.print();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Menu类已经实现了除了getName方法的其他所有方法，因为Menu类具有添加菜单，移除菜单和获取子菜单的功能。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MenuItem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MenuComponent</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MenuItem</span><span class="hljs-params">(String name,<span class="hljs-type">int</span> level)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.level = level;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">print</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; level; i++) &#123;<br>            System.out.print(<span class="hljs-string">&quot;--&quot;</span>);<br>        &#125;<br>        System.out.println(name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>MenuItem是菜单项，不能再有子菜单，所以添加菜单，移除菜单和获取子菜单的功能并不能实现。</p><h3 id="5-6-4-组合模式的分类"><a href="#5-6-4-组合模式的分类" class="headerlink" title="5.6.4 组合模式的分类"></a>5.6.4 组合模式的分类</h3><p>在使用组合模式时，根据抽象构件类的定义形式，我们可将组合模式分为透明组合模式和安全组合模式两种形式。</p><ul><li><p>透明组合模式</p><p>透明组合模式中，抽象根节点角色中声明了所有用于管理成员对象的方法，比如在示例中 <code>MenuComponent</code> 声明了 <code>add</code>、<code>remove</code> 、<code>getChild</code> 方法，这样做的好处是确保所有的构件类都有相同的接口。透明组合模式也是组合模式的标准形式。</p><p>透明组合模式的缺点是不够安全，因为叶子对象和容器对象在本质上是有区别的，叶子对象不可能有下一个层次的对象，即不可能包含成员对象，因此为其提供 add()、remove() 等方法是没有意义的，这在编译阶段不会出错，但在运行阶段如果调用这些方法可能会出错（如果没有提供相应的错误处理代码）</p></li><li><p>安全组合模式</p><p>在安全组合模式中，在抽象构件角色中没有声明任何用于管理成员对象的方法，而是在树枝节点 <code>Menu</code> 类中声明并实现这些方法。安全组合模式的缺点是不够透明，因为叶子构件和容器构件具有不同的方法，且容器构件中那些用于管理成员对象的方法没有在抽象构件类中定义，因此客户端不能完全针对抽象编程，必须有区别地对待叶子构件和容器构件。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F-%E5%AE%89%E5%85%A8%E6%80%A7.png" style="zoom:80%;" /></li></ul><h3 id="5-6-5-优点"><a href="#5-6-5-优点" class="headerlink" title="5.6.5 优点"></a>5.6.5 优点</h3><ul><li>组合模式可以清楚地定义分层次的复杂对象，表示对象的全部或部分层次，它让客户端忽略了层次的差异，方便对整个层次结构进行控制。</li><li>客户端可以一致地使用一个组合结构或其中单个对象，不必关心处理的是单个对象还是整个组合结构，简化了客户端代码。</li><li>在组合模式中增加新的树枝节点和叶子节点都很方便，无须对现有类库进行任何修改，符合“开闭原则”。</li><li>组合模式为树形结构的面向对象实现提供了一种灵活的解决方案，通过叶子节点和树枝节点的递归组合，可以形成复杂的树形结构，但对树形结构的控制却非常简单。</li></ul><h3 id="5-6-6-使用场景"><a href="#5-6-6-使用场景" class="headerlink" title="5.6.6 使用场景"></a>5.6.6 使用场景</h3><p>组合模式正是应树形结构而生，所以组合模式的使用场景就是出现树形结构的地方。比如：文件目录显示，多级目录呈现等树形结构数据的操作。</p><h2 id="5-7-享元模式"><a href="#5-7-享元模式" class="headerlink" title="5.7 享元模式"></a>5.7 享元模式</h2><h3 id="5-7-1-概述"><a href="#5-7-1-概述" class="headerlink" title="5.7.1 概述"></a>5.7.1 概述</h3><p><strong>定义：</strong></p><p>​运用共享技术来有效地支持大量细粒度对象的复用。它通过共享已经存在的对象来大幅度减少需要创建的对象数量、避免大量相似对象的开销，从而提高系统资源的利用率。</p><h3 id="5-7-2-结构"><a href="#5-7-2-结构" class="headerlink" title="5.7.2 结构"></a>5.7.2 结构</h3><p>享元（Flyweight ）模式中存在以下两种状态：</p><ol><li>内部状态，即不会随着环境的改变而改变的可共享部分。</li><li>外部状态，指随环境改变而改变的不可以共享的部分。享元模式的实现要领就是区分应用中的这两种状态，并将外部状态外部化。</li></ol><p>享元模式的主要有以下角色：</p><ul><li>抽象享元角色（Flyweight）：通常是一个接口或抽象类，在抽象享元类中声明了具体享元类公共的方法，这些方法可以向外界提供享元对象的内部数据（内部状态），同时也可以通过这些方法来设置外部数据（外部状态）。</li><li>具体享元（Concrete Flyweight）角色 ：它实现了抽象享元类，称为享元对象；在具体享元类中为内部状态提供了存储空间。通常我们可以结合单例模式来设计具体享元类，为每一个具体享元类提供唯一的享元对象。</li><li>非享元（Unsharable Flyweight)角色 ：并不是所有的抽象享元类的子类都需要被共享，不能被共享的子类可设计为非共享具体享元类；当需要一个非共享具体享元类的对象时可以直接通过实例化创建。</li><li>享元工厂（Flyweight Factory）角色 ：负责创建和管理享元角色。当客户对象请求一个享元对象时，享元工厂检査系统中是否存在符合要求的享元对象，如果存在则提供给客户；如果不存在的话，则创建一个新的享元对象。</li></ul><h3 id="5-7-3-案例实现"><a href="#5-7-3-案例实现" class="headerlink" title="5.7.3 案例实现"></a>5.7.3 案例实现</h3><p>【例】俄罗斯方块</p><p>下面的图片是众所周知的俄罗斯方块中的一个个方块，如果在俄罗斯方块这个游戏中，每个不同的方块都是一个实例对象，这些对象就要占用很多的内存空间，下面利用享元模式进行实现。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E4%BF%84%E7%BD%97%E6%96%AF%E6%96%B9%E5%9D%97.jpeg" style="zoom:60%;" /><p><strong>先来看类图：</strong></p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F.png" style="zoom:80%;" /><p><strong>代码如下：</strong></p><p>俄罗斯方块有不同的形状，我们可以对这些形状向上抽取出AbstractBox，用来定义共性的属性和行为。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractBox</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">getShape</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">(String color)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;方块形状：&quot;</span> + <span class="hljs-built_in">this</span>.getShape() + <span class="hljs-string">&quot; 颜色：&quot;</span> + color);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>接下来就是定义不同的形状了，IBox类、LBox类、OBox类等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IBox</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractBox</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getShape</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;I&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LBox</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractBox</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getShape</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;L&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OBox</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractBox</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getShape</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;O&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>提供了一个工厂类（BoxFactory），用来管理享元对象（也就是AbstractBox子类对象），该工厂类对象只需要一个，所以可以使用单例模式。并给工厂类提供一个获取形状的方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BoxFactory</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HashMap&lt;String, AbstractBox&gt; map;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">BoxFactory</span><span class="hljs-params">()</span> &#123;<br>        map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, AbstractBox&gt;();<br>        <span class="hljs-type">AbstractBox</span> <span class="hljs-variable">iBox</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IBox</span>();<br>        <span class="hljs-type">AbstractBox</span> <span class="hljs-variable">lBox</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LBox</span>();<br>        <span class="hljs-type">AbstractBox</span> <span class="hljs-variable">oBox</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OBox</span>();<br>        map.put(<span class="hljs-string">&quot;I&quot;</span>, iBox);<br>        map.put(<span class="hljs-string">&quot;L&quot;</span>, lBox);<br>        map.put(<span class="hljs-string">&quot;O&quot;</span>, oBox);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> BoxFactory <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> SingletonHolder.INSTANCE;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonHolder</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">BoxFactory</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BoxFactory</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> AbstractBox <span class="hljs-title function_">getBox</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">return</span> map.get(key);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-7-5-优缺点和使用场景"><a href="#5-7-5-优缺点和使用场景" class="headerlink" title="5.7.5 优缺点和使用场景"></a>5.7.5 优缺点和使用场景</h3><p><strong>1，优点</strong></p><ul><li>极大减少内存中相似或相同对象数量，节约系统资源，提供系统性能</li><li>享元模式中的外部状态相对独立，且不影响内部状态</li></ul><p><strong>2，缺点：</strong></p><p>为了使对象可以共享，需要将享元对象的部分状态外部化，分离内部状态和外部状态，使程序逻辑复杂</p><p><strong>3，使用场景：</strong></p><ul><li>一个系统有大量相同或者相似的对象，造成内存的大量耗费。</li><li>对象的大部分状态都可以外部化，可以将这些外部状态传入对象中。</li><li>在使用享元模式时需要维护一个存储享元对象的享元池，而这需要耗费一定的系统资源，因此，应当在需要多次重复使用享元对象时才值得使用享元模式。</li></ul><h3 id="5-7-6-JDK源码解析"><a href="#5-7-6-JDK源码解析" class="headerlink" title="5.7.6 JDK源码解析"></a>5.7.6 JDK源码解析</h3><p>Integer类使用了享元模式。我们先看下面的例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">i1</span> <span class="hljs-operator">=</span> <span class="hljs-number">127</span>;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">i2</span> <span class="hljs-operator">=</span> <span class="hljs-number">127</span>;<br><br>        System.out.println(<span class="hljs-string">&quot;i1和i2对象是否是同一个对象？&quot;</span> + (i1 == i2));<br><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">i3</span> <span class="hljs-operator">=</span> <span class="hljs-number">128</span>;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">i4</span> <span class="hljs-operator">=</span> <span class="hljs-number">128</span>;<br><br>        System.out.println(<span class="hljs-string">&quot;i3和i4对象是否是同一个对象？&quot;</span> + (i3 == i4));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行上面代码，结果如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200208212930857.png" style="zoom:80%;" /><p>为什么第一个输出语句输出的是true，第二个输出语句输出的是false？通过反编译软件进行反编译，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">i1</span> <span class="hljs-operator">=</span> Integer.valueOf((<span class="hljs-type">int</span>)<span class="hljs-number">127</span>);<br>        Integer i2 Integer.valueOf((<span class="hljs-type">int</span>)<span class="hljs-number">127</span>);<br>        System.out.println((String)<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>().append((String)<span class="hljs-string">&quot;i1\u548ci2\u5bf9\u8c61\u662f\u5426\u662f\u540c\u4e00\u4e2a\u5bf9\u8c61\uff1f&quot;</span>).append((<span class="hljs-type">boolean</span>)(i1 == i2)).toString());<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">i3</span> <span class="hljs-operator">=</span> Integer.valueOf((<span class="hljs-type">int</span>)<span class="hljs-number">128</span>);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">i4</span> <span class="hljs-operator">=</span> Integer.valueOf((<span class="hljs-type">int</span>)<span class="hljs-number">128</span>);<br>        System.out.println((String)<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>().append((String)<span class="hljs-string">&quot;i3\u548ci4\u5bf9\u8c61\u662f\u5426\u662f\u540c\u4e00\u4e2a\u5bf9\u8c61\uff1f&quot;</span>).append((<span class="hljs-type">boolean</span>)(i3 == i4)).toString());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>上面代码可以看到，直接给Integer类型的变量赋值基本数据类型数据的操作底层使用的是 <code>valueOf()</code> ，所以只需要看该方法即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Integer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Number</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparable</span>&lt;Integer&gt; &#123;<br>    <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Integer <span class="hljs-title function_">valueOf</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> &#123;<br>        <span class="hljs-keyword">if</span> (i &gt;= IntegerCache.low &amp;&amp; i &lt;= IntegerCache.high)<br>            <span class="hljs-keyword">return</span> IntegerCache.cache[i + (-IntegerCache.low)];<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(i);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntegerCache</span> &#123;<br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">low</span> <span class="hljs-operator">=</span> -<span class="hljs-number">128</span>;<br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> high;<br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Integer cache[];<br><br>        <span class="hljs-keyword">static</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">127</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">integerCacheHighPropValue</span> <span class="hljs-operator">=</span><br>                sun.misc.VM.getSavedProperty(<span class="hljs-string">&quot;java.lang.Integer.IntegerCache.high&quot;</span>);<br>            <span class="hljs-keyword">if</span> (integerCacheHighPropValue != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> parseInt(integerCacheHighPropValue);<br>                    i = Math.max(i, <span class="hljs-number">127</span>);<br>                    <span class="hljs-comment">// Maximum array size is Integer.MAX_VALUE</span><br>                    h = Math.min(i, Integer.MAX_VALUE - (-low) -<span class="hljs-number">1</span>);<br>                &#125; <span class="hljs-keyword">catch</span>( NumberFormatException nfe) &#123;<br>                &#125;<br>            &#125;<br>            high = h;<br>            cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>[(high - low) + <span class="hljs-number">1</span>];<br>            <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> low;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; k &lt; cache.length; k++)<br>                cache[k] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(j++);<br>            <span class="hljs-comment">// range [-128, 127] must be interned (JLS7 5.1.7)</span><br>            <span class="hljs-keyword">assert</span> IntegerCache.high &gt;= <span class="hljs-number">127</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-title function_">IntegerCache</span><span class="hljs-params">()</span> &#123;&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到 <code>Integer</code> 默认先创建并缓存 <code>-128 ~ 127</code> 之间数的 <code>Integer</code> 对象，当调用 <code>valueOf</code> 时如果参数在 <code>-128 ~ 127</code> 之间则计算下标并从缓存中返回，否则创建一个新的 <code>Integer</code> 对象。</p><h1 id="6，行为型模式"><a href="#6，行为型模式" class="headerlink" title="6，行为型模式"></a>6，行为型模式</h1><p>行为型模式用于描述程序在运行时复杂的流程控制，即描述多个类或对象之间怎样相互协作共同完成单个对象都无法单独完成的任务，它涉及算法与对象间职责的分配。</p><p>行为型模式分为类行为模式和对象行为模式，前者采用继承机制来在类间分派行为，后者采用组合或聚合在对象间分配行为。由于组合关系或聚合关系比继承关系耦合度低，满足“合成复用原则”，所以对象行为模式比类行为模式具有更大的灵活性。</p><p>行为型模式分为：</p><ul><li>模板方法模式</li><li>策略模式</li><li>命令模式</li><li>职责链模式</li><li>状态模式</li><li>观察者模式</li><li>中介者模式</li><li>迭代器模式</li><li>访问者模式</li><li>备忘录模式</li><li>解释器模式</li></ul><p>以上 11 种行为型模式，除了模板方法模式和解释器模式是类行为型模式，其他的全部属于对象行为型模式。</p><h2 id="6-1-模板方法模式"><a href="#6-1-模板方法模式" class="headerlink" title="6.1 模板方法模式"></a>6.1 模板方法模式</h2><h3 id="6-1-1-概述"><a href="#6-1-1-概述" class="headerlink" title="6.1.1 概述"></a>6.1.1 概述</h3><p>在面向对象程序设计过程中，程序员常常会遇到这种情况：设计一个系统时知道了算法所需的关键步骤，而且确定了这些步骤的执行顺序，但某些步骤的具体实现还未知，或者说某些步骤的实现与具体的环境相关。</p><p>例如，去银行办理业务一般要经过以下4个流程：取号、排队、办理具体业务、对银行工作人员进行评分等，其中取号、排队和对银行工作人员进行评分的业务对每个客户是一样的，可以在父类中实现，但是办理具体业务却因人而异，它可能是存款、取款或者转账等，可以延迟到子类中实现。</p><p><strong>定义：</strong></p><p>定义一个操作中的算法骨架，而将算法的一些步骤延迟到子类中，使得子类可以不改变该算法结构的情况下重定义该算法的某些特定步骤。</p><h3 id="6-1-2-结构"><a href="#6-1-2-结构" class="headerlink" title="6.1.2 结构"></a>6.1.2 结构</h3><p>模板方法（Template Method）模式包含以下主要角色：</p><ul><li><p>抽象类（Abstract Class）：负责给出一个算法的轮廓和骨架。它由一个模板方法和若干个基本方法构成。</p><ul><li><p>模板方法：定义了算法的骨架，按某种顺序调用其包含的基本方法。</p></li><li><p>基本方法：是实现算法各个步骤的方法，是模板方法的组成部分。基本方法又可以分为三种：</p><ul><li><p>抽象方法(Abstract Method) ：一个抽象方法由抽象类声明、由其具体子类实现。</p></li><li><p>具体方法(Concrete Method) ：一个具体方法由一个抽象类或具体类声明并实现，其子类可以进行覆盖也可以直接继承。</p></li><li><p>钩子方法(Hook Method) ：在抽象类中已经实现，包括用于判断的逻辑方法和需要子类重写的空方法两种。</p><p>一般钩子方法是用于判断的逻辑方法，这类方法名一般为isXxx，返回值类型为boolean类型。</p></li></ul></li></ul></li><li><p>具体子类（Concrete Class）：实现抽象类中所定义的抽象方法和钩子方法，它们是一个顶级逻辑的组成步骤。</p></li></ul><h3 id="6-1-3-案例实现"><a href="#6-1-3-案例实现" class="headerlink" title="6.1.3 案例实现"></a>6.1.3 案例实现</h3><p>【例】炒菜</p><p>炒菜的步骤是固定的，分为倒油、热油、倒蔬菜、倒调料品、翻炒等步骤。现通过模板方法模式来用代码模拟。类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F.png" style="zoom:80%;" /><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractClass</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cookProcess</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//第一步：倒油</span><br>        <span class="hljs-built_in">this</span>.pourOil();<br>        <span class="hljs-comment">//第二步：热油</span><br>        <span class="hljs-built_in">this</span>.heatOil();<br>        <span class="hljs-comment">//第三步：倒蔬菜</span><br>        <span class="hljs-built_in">this</span>.pourVegetable();<br>        <span class="hljs-comment">//第四步：倒调味料</span><br>        <span class="hljs-built_in">this</span>.pourSauce();<br>        <span class="hljs-comment">//第五步：翻炒</span><br>        <span class="hljs-built_in">this</span>.fry();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pourOil</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;倒油&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//第二步：热油是一样的，所以直接实现</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">heatOil</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;热油&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//第三步：倒蔬菜是不一样的（一个下包菜，一个是下菜心）</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pourVegetable</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">//第四步：倒调味料是不一样</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pourSauce</span><span class="hljs-params">()</span>;<br><br><br>    <span class="hljs-comment">//第五步：翻炒是一样的，所以直接实现</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fry</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;炒啊炒啊炒到熟啊&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteClass_BaoCai</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractClass</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pourVegetable</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;下锅的蔬菜是包菜&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pourSauce</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;下锅的酱料是辣椒&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteClass_CaiXin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractClass</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pourVegetable</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;下锅的蔬菜是菜心&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pourSauce</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;下锅的酱料是蒜蓉&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//炒手撕包菜</span><br>        <span class="hljs-type">ConcreteClass_BaoCai</span> <span class="hljs-variable">baoCai</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcreteClass_BaoCai</span>();<br>        baoCai.cookProcess();<br><br>        <span class="hljs-comment">//炒蒜蓉菜心</span><br>        <span class="hljs-type">ConcreteClass_CaiXin</span> <span class="hljs-variable">caiXin</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcreteClass_CaiXin</span>();<br>        caiXin.cookProcess();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>注意：为防止恶意操作，一般模板方法都加上 final 关键词。</p></blockquote><h3 id="6-1-3-优缺点"><a href="#6-1-3-优缺点" class="headerlink" title="6.1.3 优缺点"></a>6.1.3 优缺点</h3><p><strong>优点：</strong></p><ul><li><p>提高代码复用性</p><p>将相同部分的代码放在抽象的父类中，而将不同的代码放入不同的子类中。</p></li><li><p>实现了反向控制</p><p>通过一个父类调用其子类的操作，通过对子类的具体实现扩展不同的行为，实现了反向控制 ，并符合“开闭原则”。</p></li></ul><p><strong>缺点：</strong></p><ul><li>对每个不同的实现都需要定义一个子类，这会导致类的个数增加，系统更加庞大，设计也更加抽象。</li><li>父类中的抽象方法由子类实现，子类执行的结果会影响父类的结果，这导致一种反向的控制结构，它提高了代码阅读的难度。</li></ul><h3 id="6-1-4-适用场景"><a href="#6-1-4-适用场景" class="headerlink" title="6.1.4 适用场景"></a>6.1.4 适用场景</h3><ul><li>算法的整体步骤很固定，但其中个别部分易变时，这时候可以使用模板方法模式，将容易变的部分抽象出来，供子类实现。</li><li>需要通过子类来决定父类算法中某个步骤是否执行，实现子类对父类的反向控制。</li></ul><h3 id="6-1-5-JDK源码解析"><a href="#6-1-5-JDK源码解析" class="headerlink" title="6.1.5 JDK源码解析"></a>6.1.5 JDK源码解析</h3><p>InputStream类就使用了模板方法模式。在InputStream类中定义了多个 <code>read()</code> 方法，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InputStream</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Closeable</span> &#123;<br>    <span class="hljs-comment">//抽象方法，要求子类必须重写</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read</span><span class="hljs-params">(<span class="hljs-type">byte</span> b[])</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">return</span> read(b, <span class="hljs-number">0</span>, b.length);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read</span><span class="hljs-params">(<span class="hljs-type">byte</span> b[], <span class="hljs-type">int</span> off, <span class="hljs-type">int</span> len)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">if</span> (b == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (off &lt; <span class="hljs-number">0</span> || len &lt; <span class="hljs-number">0</span> || len &gt; b.length - off) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexOutOfBoundsException</span>();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (len == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> read(); <span class="hljs-comment">//调用了无参的read方法，该方法是每次读取一个字节数据</span><br>        <span class="hljs-keyword">if</span> (c == -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>        &#125;<br>        b[off] = (<span class="hljs-type">byte</span>)c;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (; i &lt; len ; i++) &#123;<br>                c = read();<br>                <span class="hljs-keyword">if</span> (c == -<span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                b[off + i] = (<span class="hljs-type">byte</span>)c;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ee) &#123;<br>        &#125;<br>        <span class="hljs-keyword">return</span> i;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>从上面代码可以看到，无参的 <code>read()</code> 方法是抽象方法，要求子类必须实现。而 <code>read(byte b[])</code> 方法调用了 <code>read(byte b[], int off, int len)</code> 方法，所以在此处重点看的方法是带三个参数的方法。 </p><p>在该方法中第18行、27行，可以看到调用了无参的抽象的 <code>read()</code> 方法。</p><p>总结如下： 在InputStream父类中已经定义好了读取一个字节数组数据的方法是每次读取一个字节，并将其存储到数组的第一个索引位置，读取len个字节数据。具体如何读取一个字节数据呢？由子类实现。</p><h2 id="6-2-策略模式"><a href="#6-2-策略模式" class="headerlink" title="6.2 策略模式"></a>6.2 策略模式</h2><h3 id="6-2-1-概述"><a href="#6-2-1-概述" class="headerlink" title="6.2.1 概述"></a>6.2.1 概述</h3><p>先看下面的图片，我们去旅游选择出行模式有很多种，可以骑自行车、可以坐汽车、可以坐火车、可以坐飞机。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200210143039168.png" style="zoom:80%;" /><p>作为一个程序猿，开发需要选择一款开发工具，当然可以进行代码开发的工具有很多，可以选择Idea进行开发，也可以使用eclipse进行开发，也可以使用其他的一些开发工具。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200210144457478.png" style="zoom:70%;" /><p><strong>定义：</strong></p><p>​该模式定义了一系列算法，并将每个算法封装起来，使它们可以相互替换，且算法的变化不会影响使用算法的客户。策略模式属于对象行为模式，它通过对算法进行封装，把使用算法的责任和算法的实现分割开来，并委派给不同的对象对这些算法进行管理。</p><h3 id="6-2-2-结构"><a href="#6-2-2-结构" class="headerlink" title="6.2.2 结构"></a>6.2.2 结构</h3><p>策略模式的主要角色如下：</p><ul><li>抽象策略（Strategy）类：这是一个抽象角色，通常由一个接口或抽象类实现。此角色给出所有的具体策略类所需的接口。</li><li>具体策略（Concrete Strategy）类：实现了抽象策略定义的接口，提供具体的算法实现或行为。</li><li>环境（Context）类：持有一个策略类的引用，最终给客户端调用。</li></ul><h3 id="6-2-3-案例实现"><a href="#6-2-3-案例实现" class="headerlink" title="6.2.3 案例实现"></a>6.2.3 案例实现</h3><p>【例】促销活动</p><p>一家百货公司在定年度的促销活动。针对不同的节日（春节、中秋节、圣诞节）推出不同的促销活动，由促销员将促销活动展示给客户。类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F.png" style="zoom:80%;" /><p>代码如下：</p><p>定义百货公司所有促销活动的共同接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Strategy</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义具体策略角色（Concrete Strategy）：每个节日具体的促销活动</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//为春节准备的促销活动A</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StrategyA</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Strategy</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;买一送一&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//为中秋准备的促销活动B</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StrategyB</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Strategy</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;满200元减50元&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//为圣诞准备的促销活动C</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StrategyC</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Strategy</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;满1000元加一元换购任意200元以下商品&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义环境角色（Context）：用于连接上下文，即把促销活动推销给客户，这里可以理解为销售员</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SalesMan</span> &#123;                        <br>    <span class="hljs-comment">//持有抽象策略角色的引用                              </span><br>    <span class="hljs-keyword">private</span> Strategy strategy;                 <br>                                               <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SalesMan</span><span class="hljs-params">(Strategy strategy)</span> &#123;       <br>        <span class="hljs-built_in">this</span>.strategy = strategy;              <br>    &#125;                                          <br>                                               <br>    <span class="hljs-comment">//向客户展示促销活动                                </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">salesManShow</span><span class="hljs-params">()</span>&#123;                <br>        strategy.show();                       <br>    &#125;                                          <br>&#125;                                              <br></code></pre></td></tr></table></figure><h3 id="6-2-4-优缺点"><a href="#6-2-4-优缺点" class="headerlink" title="6.2.4 优缺点"></a>6.2.4 优缺点</h3><p><strong>1，优点：</strong></p><ul><li><p>策略类之间可以自由切换</p><p>由于策略类都实现同一个接口，所以使它们之间可以自由切换。</p></li><li><p>易于扩展</p><p>增加一个新的策略只需要添加一个具体的策略类即可，基本不需要改变原有的代码，符合“开闭原则“</p></li><li><p>避免使用多重条件选择语句（if else），充分体现面向对象设计思想。</p></li></ul><p><strong>2，缺点：</strong></p><ul><li>客户端必须知道所有的策略类，并自行决定使用哪一个策略类。</li><li>策略模式将造成产生很多策略类，可以通过使用享元模式在一定程度上减少对象的数量。</li></ul><h3 id="6-2-5-使用场景"><a href="#6-2-5-使用场景" class="headerlink" title="6.2.5 使用场景"></a>6.2.5 使用场景</h3><ul><li>一个系统需要动态地在几种算法中选择一种时，可将每个算法封装到策略类中。</li><li>一个类定义了多种行为，并且这些行为在这个类的操作中以多个条件语句的形式出现，可将每个条件分支移入它们各自的策略类中以代替这些条件语句。</li><li>系统中各算法彼此完全独立，且要求对客户隐藏具体算法的实现细节时。</li><li>系统要求使用算法的客户不应该知道其操作的数据时，可使用策略模式来隐藏与算法相关的数据结构。</li><li>多个类只区别在表现行为不同，可以使用策略模式，在运行时动态选择具体要执行的行为。</li></ul><h3 id="6-2-6-JDK源码解析"><a href="#6-2-6-JDK源码解析" class="headerlink" title="6.2.6 JDK源码解析"></a>6.2.6 JDK源码解析</h3><p><code>Comparator</code> 中的策略模式。在Arrays类中有一个 <code>sort()</code> 方法，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Arrays</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">sort</span><span class="hljs-params">(T[] a, Comparator&lt;? <span class="hljs-built_in">super</span> T&gt; c)</span> &#123;<br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>            sort(a);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (LegacyMergeSort.userRequested)<br>                legacyMergeSort(a, c);<br>            <span class="hljs-keyword">else</span><br>                TimSort.sort(a, <span class="hljs-number">0</span>, a.length, c, <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Arrays就是一个环境角色类，这个sort方法可以传一个新策略让Arrays根据这个策略来进行排序。就比如下面的测试类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        Integer[] data = &#123;<span class="hljs-number">12</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>&#125;;<br>        <span class="hljs-comment">// 实现降序排序</span><br>        Arrays.sort(data, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Comparator</span>&lt;Integer&gt;() &#123;<br>            <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Integer o1, Integer o2)</span> &#123;<br>                <span class="hljs-keyword">return</span> o2 - o1;<br>            &#125;<br>        &#125;);<br>        System.out.println(Arrays.toString(data)); <span class="hljs-comment">//[12, 5, 4, 3, 2, 2, 1]</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里我们在调用Arrays的sort方法时，第二个参数传递的是Comparator接口的子实现类对象。所以Comparator充当的是抽象策略角色，而具体的子实现类充当的是具体策略角色。环境角色类（Arrays）应该持有抽象策略的引用来调用。那么，Arrays类的sort方法到底有没有使用Comparator子实现类中的 <code>compare()</code> 方法吗？让我们继续查看TimSort类的 <code>sort()</code> 方法，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TimSort</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">sort</span><span class="hljs-params">(T[] a, <span class="hljs-type">int</span> lo, <span class="hljs-type">int</span> hi, Comparator&lt;? <span class="hljs-built_in">super</span> T&gt; c,</span><br><span class="hljs-params">                         T[] work, <span class="hljs-type">int</span> workBase, <span class="hljs-type">int</span> workLen)</span> &#123;<br>        <span class="hljs-keyword">assert</span> c != <span class="hljs-literal">null</span> &amp;&amp; a != <span class="hljs-literal">null</span> &amp;&amp; lo &gt;= <span class="hljs-number">0</span> &amp;&amp; lo &lt;= hi &amp;&amp; hi &lt;= a.length;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">nRemaining</span>  <span class="hljs-operator">=</span> hi - lo;<br>        <span class="hljs-keyword">if</span> (nRemaining &lt; <span class="hljs-number">2</span>)<br>            <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// Arrays of size 0 and 1 are always sorted</span><br><br>        <span class="hljs-comment">// If array is small, do a &quot;mini-TimSort&quot; with no merges</span><br>        <span class="hljs-keyword">if</span> (nRemaining &lt; MIN_MERGE) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">initRunLen</span> <span class="hljs-operator">=</span> countRunAndMakeAscending(a, lo, hi, c);<br>            binarySort(a, lo, hi, lo + initRunLen, c);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        ...<br>    &#125;   <br>        <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-type">int</span> <span class="hljs-title function_">countRunAndMakeAscending</span><span class="hljs-params">(T[] a, <span class="hljs-type">int</span> lo, <span class="hljs-type">int</span> hi,Comparator&lt;? <span class="hljs-built_in">super</span> T&gt; c)</span> &#123;<br>        <span class="hljs-keyword">assert</span> lo &lt; hi;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">runHi</span> <span class="hljs-operator">=</span> lo + <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (runHi == hi)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br>        <span class="hljs-comment">// Find end of run, and reverse range if descending</span><br>        <span class="hljs-keyword">if</span> (c.compare(a[runHi++], a[lo]) &lt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// Descending</span><br>            <span class="hljs-keyword">while</span> (runHi &lt; hi &amp;&amp; c.compare(a[runHi], a[runHi - <span class="hljs-number">1</span>]) &lt; <span class="hljs-number">0</span>)<br>                runHi++;<br>            reverseRange(a, lo, runHi);<br>        &#125; <span class="hljs-keyword">else</span> &#123;                              <span class="hljs-comment">// Ascending</span><br>            <span class="hljs-keyword">while</span> (runHi &lt; hi &amp;&amp; c.compare(a[runHi], a[runHi - <span class="hljs-number">1</span>]) &gt;= <span class="hljs-number">0</span>)<br>                runHi++;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> runHi - lo;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>上面的代码中最终会跑到 <code>countRunAndMakeAscending()</code> 这个方法中。我们可以看见，只用了compare方法，所以在调用Arrays.sort方法只传具体compare重写方法的类对象就行，这也是Comparator接口中必须要子类实现的一个方法。</p><h2 id="6-3-命令模式"><a href="#6-3-命令模式" class="headerlink" title="6.3 命令模式"></a>6.3 命令模式</h2><h3 id="6-3-1-概述"><a href="#6-3-1-概述" class="headerlink" title="6.3.1 概述"></a>6.3.1 概述</h3><p>日常生活中，我们出去吃饭都会遇到下面的场景。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200211130313251.png" style="zoom:60%;" /><p><strong>定义：</strong></p><p>将一个请求封装为一个对象，使发出请求的责任和执行请求的责任分割开。这样两者之间通过命令对象进行沟通，这样方便将命令对象进行存储、传递、调用、增加与管理。</p><h3 id="6-3-2-结构"><a href="#6-3-2-结构" class="headerlink" title="6.3.2 结构"></a>6.3.2 结构</h3><p>命令模式包含以下主要角色：</p><ul><li>抽象命令类（Command）角色： 定义命令的接口，声明执行的方法。</li><li>具体命令（Concrete  Command）角色：具体的命令，实现命令接口；通常会持有接收者，并调用接收者的功能来完成命令要执行的操作。</li><li>实现者&#x2F;接收者（Receiver）角色： 接收者，真正执行命令的对象。任何类都可能成为一个接收者，只要它能够实现命令要求实现的相应功能。</li><li>调用者&#x2F;请求者（Invoker）角色： 要求命令对象执行请求，通常会持有命令对象，可以持有很多的命令对象。这个是客户端真正触发命令并要求命令执行相应操作的地方，也就是说相当于使用命令对象的入口。</li></ul><h3 id="6-3-3-案例实现"><a href="#6-3-3-案例实现" class="headerlink" title="6.3.3 案例实现"></a>6.3.3 案例实现</h3><p>将上面的案例用代码实现，那我们就需要分析命令模式的角色在该案例中由谁来充当。</p><p>服务员： 就是调用者角色，由她来发起命令。</p><p>资深大厨： 就是接收者角色，真正命令执行的对象。</p><p>订单： 命令中包含订单。</p><p>类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F.png" style="zoom:75%;" /><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Command</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span>;<span class="hljs-comment">//只需要定义一个统一的执行方法</span><br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCommand</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Command</span> &#123;<br><br>    <span class="hljs-comment">//持有接受者对象</span><br>    <span class="hljs-keyword">private</span> SeniorChef receiver;<br>    <span class="hljs-keyword">private</span> Order order;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderCommand</span><span class="hljs-params">(SeniorChef receiver, Order order)</span>&#123;<br>        <span class="hljs-built_in">this</span>.receiver = receiver;<br>        <span class="hljs-built_in">this</span>.order = order;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span>  &#123;<br>        System.out.println(order.getDiningTable() + <span class="hljs-string">&quot;桌的订单：&quot;</span>);<br>        Set&lt;String&gt; keys = order.getFoodDic().keySet();<br>        <span class="hljs-keyword">for</span> (String key : keys) &#123;<br>            receiver.makeFood(order.getFoodDic().get(key),key);<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">100</span>);<span class="hljs-comment">//停顿一下 模拟做饭的过程</span><br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br><br>        System.out.println(order.getDiningTable() + <span class="hljs-string">&quot;桌的饭弄好了&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> &#123;<br>    <span class="hljs-comment">// 餐桌号码</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> diningTable;<br><br>    <span class="hljs-comment">// 用来存储餐名并记录份数</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Integer&gt; foodDic = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Integer&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getDiningTable</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> diningTable;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDiningTable</span><span class="hljs-params">(<span class="hljs-type">int</span> diningTable)</span> &#123;<br>        <span class="hljs-built_in">this</span>.diningTable = diningTable;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Map&lt;String, Integer&gt; <span class="hljs-title function_">getFoodDic</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> foodDic;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFoodDic</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> num)</span> &#123;<br>        foodDic.put(name,num);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 资深大厨类 是命令的Receiver</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeniorChef</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeFood</span><span class="hljs-params">(<span class="hljs-type">int</span> num,String foodName)</span> &#123;<br>        System.out.println(num + <span class="hljs-string">&quot;份&quot;</span> + foodName);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Waitor</span> &#123;<br><br>    <span class="hljs-keyword">private</span> ArrayList&lt;Command&gt; commands;<span class="hljs-comment">//可以持有很多的命令对象</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Waitor</span><span class="hljs-params">()</span> &#123;<br>        commands = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCommand</span><span class="hljs-params">(Command cmd)</span>&#123;<br>        commands.add(cmd);<br>    &#125;<br><br>    <span class="hljs-comment">// 发出命令 喊 订单来了，厨师开始执行</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">orderUp</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;美女服务员：叮咚，大厨，新订单来了.......&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; commands.size(); i++) &#123;<br>            <span class="hljs-type">Command</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> commands.get(i);<br>            <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>                cmd.execute();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//创建2个order</span><br>        <span class="hljs-type">Order</span> <span class="hljs-variable">order1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();<br>        order1.setDiningTable(<span class="hljs-number">1</span>);<br>        order1.getFoodDic().put(<span class="hljs-string">&quot;西红柿鸡蛋面&quot;</span>,<span class="hljs-number">1</span>);<br>        order1.getFoodDic().put(<span class="hljs-string">&quot;小杯可乐&quot;</span>,<span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">Order</span> <span class="hljs-variable">order2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();<br>        order2.setDiningTable(<span class="hljs-number">3</span>);<br>        order2.getFoodDic().put(<span class="hljs-string">&quot;尖椒肉丝盖饭&quot;</span>,<span class="hljs-number">1</span>);<br>        order2.getFoodDic().put(<span class="hljs-string">&quot;小杯雪碧&quot;</span>,<span class="hljs-number">1</span>);<br><br>        <span class="hljs-comment">//创建接收者</span><br>        SeniorChef receiver=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SeniorChef</span>();<br>        <span class="hljs-comment">//将订单和接收者封装成命令对象</span><br>        <span class="hljs-type">OrderCommand</span> <span class="hljs-variable">cmd1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCommand</span>(receiver, order1);<br>        <span class="hljs-type">OrderCommand</span> <span class="hljs-variable">cmd2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCommand</span>(receiver, order2);<br>        <span class="hljs-comment">//创建调用者 waitor</span><br>        <span class="hljs-type">Waitor</span> <span class="hljs-variable">invoker</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Waitor</span>();<br>        invoker.setCommand(cmd1);<br>        invoker.setCommand(cmd2);<br><br>        <span class="hljs-comment">//将订单带到柜台 并向厨师喊 订单来了</span><br>        invoker.orderUp();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-3-4-优缺点"><a href="#6-3-4-优缺点" class="headerlink" title="6.3.4 优缺点"></a>6.3.4 优缺点</h3><p><strong>1，优点：</strong></p><ul><li>降低系统的耦合度。命令模式能将调用操作的对象与实现该操作的对象解耦。</li><li>增加或删除命令非常方便。采用命令模式增加与删除命令不会影响其他类，它满足“开闭原则”，对扩展比较灵活。</li><li>可以实现宏命令。命令模式可以与组合模式结合，将多个命令装配成一个组合命令，即宏命令。</li><li>方便实现 Undo 和 Redo 操作。命令模式可以与后面介绍的备忘录模式结合，实现命令的撤销与恢复。</li></ul><p><strong>2，缺点：</strong></p><ul><li>使用命令模式可能会导致某些系统有过多的具体命令类。</li><li>系统结构更加复杂。</li></ul><h3 id="6-3-5-使用场景"><a href="#6-3-5-使用场景" class="headerlink" title="6.3.5 使用场景"></a>6.3.5 使用场景</h3><ul><li>系统需要将请求调用者和请求接收者解耦，使得调用者和接收者不直接交互。</li><li>系统需要在不同的时间指定请求、将请求排队和执行请求。</li><li>系统需要支持命令的撤销(Undo)操作和恢复(Redo)操作。</li></ul><h3 id="6-3-6-JDK源码解析"><a href="#6-3-6-JDK源码解析" class="headerlink" title="6.3.6 JDK源码解析"></a>6.3.6 JDK源码解析</h3><p>Runable是一个典型命令模式，Runnable担当命令的角色，Thread充当的是调用者，start方法就是其执行方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//命令接口(抽象命令角色)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Runnable</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-comment">//调用者</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Thread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>    <span class="hljs-keyword">private</span> Runnable target;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (threadStatus != <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalThreadStateException</span>();<br><br>        group.add(<span class="hljs-built_in">this</span>);<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">started</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            start0();<br>            started = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (!started) &#123;<br>                    group.threadStartFailed(<span class="hljs-built_in">this</span>);<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable ignore) &#123;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start0</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>会调用一个native方法start0(),调用系统方法，开启一个线程。而接收者是对程序员开放的，可以自己定义接收者。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * jdk Runnable 命令模式</span><br><span class="hljs-comment"> *TurnOffThread ： 属于具体</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TurnOffThread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>&#123;<br>     <span class="hljs-keyword">private</span> Receiver receiver;<br>    <br>     <span class="hljs-keyword">public</span> <span class="hljs-title function_">TurnOffThread</span><span class="hljs-params">(Receiver receiver)</span> &#123;<br>     <span class="hljs-built_in">this</span>.receiver = receiver;<br>     &#125;<br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>     receiver.turnOFF();<br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 测试类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> &#123;<br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>         <span class="hljs-type">Receiver</span> <span class="hljs-variable">receiver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Receiver</span>();<br>         <span class="hljs-type">TurnOffThread</span> <span class="hljs-variable">turnOffThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TurnOffThread</span>(receiver);<br>         <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(turnOffThread);<br>         thread.start();<br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-4-责任链模式"><a href="#6-4-责任链模式" class="headerlink" title="6.4 责任链模式"></a>6.4 责任链模式</h2><h3 id="6-4-1-概述"><a href="#6-4-1-概述" class="headerlink" title="6.4.1 概述"></a>6.4.1 概述</h3><p>在现实生活中，常常会出现这样的事例：一个请求有多个对象可以处理，但每个对象的处理条件或权限不同。例如，公司员工请假，可批假的领导有部门负责人、副总经理、总经理等，但每个领导能批准的天数不同，员工必须根据自己要请假的天数去找不同的领导签名，也就是说员工必须记住每个领导的姓名、电话和地址等信息，这增加了难度。这样的例子还有很多，如找领导出差报销、生活中的“击鼓传花”游戏等。</p><p><strong>定义：</strong></p><p>又名职责链模式，为了避免请求发送者与多个请求处理者耦合在一起，将所有请求的处理者通过前一对象记住其下一个对象的引用而连成一条链；当有请求发生时，可将请求沿着这条链传递，直到有对象处理它为止。</p><h3 id="6-4-2-结构"><a href="#6-4-2-结构" class="headerlink" title="6.4.2 结构"></a>6.4.2 结构</h3><p>职责链模式主要包含以下角色:</p><ul><li>抽象处理者（Handler）角色：定义一个处理请求的接口，包含抽象处理方法和一个后继连接。</li><li>具体处理者（Concrete Handler）角色：实现抽象处理者的处理方法，判断能否处理本次请求，如果可以处理请求则处理，否则将该请求转给它的后继者。</li><li>客户类（Client）角色：创建处理链，并向链头的具体处理者对象提交请求，它不关心处理细节和请求的传递过程。</li></ul><h3 id="6-4-3-案例实现"><a href="#6-4-3-案例实现" class="headerlink" title="6.4.3 案例实现"></a>6.4.3 案例实现</h3><p>现需要开发一个请假流程控制系统。请假一天以下的假只需要小组长同意即可；请假1天到3天的假还需要部门经理同意；请求3天到7天还需要总经理同意才行。</p><p>类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F.png" style="zoom:80%;" /><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//请假条</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LeaveRequest</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<span class="hljs-comment">//姓名</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> num;<span class="hljs-comment">//请假天数</span><br>    <span class="hljs-keyword">private</span> String content;<span class="hljs-comment">//请假内容</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LeaveRequest</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> num, String content)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.num = num;<br>        <span class="hljs-built_in">this</span>.content = content;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getNum</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> num;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> content;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//处理者抽象类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Handler</span> &#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">NUM_ONE</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">NUM_THREE</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">NUM_SEVEN</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span>;<br><br>    <span class="hljs-comment">//该领导处理的请假天数区间</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> numStart;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> numEnd;<br><br>    <span class="hljs-comment">//领导上面还有领导</span><br>    <span class="hljs-keyword">private</span> Handler nextHandler;<br><br>    <span class="hljs-comment">//设置请假天数范围 上不封顶</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Handler</span><span class="hljs-params">(<span class="hljs-type">int</span> numStart)</span> &#123;<br>        <span class="hljs-built_in">this</span>.numStart = numStart;<br>    &#125;<br><br>    <span class="hljs-comment">//设置请假天数范围</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Handler</span><span class="hljs-params">(<span class="hljs-type">int</span> numStart, <span class="hljs-type">int</span> numEnd)</span> &#123;<br>        <span class="hljs-built_in">this</span>.numStart = numStart;<br>        <span class="hljs-built_in">this</span>.numEnd = numEnd;<br>    &#125;<br><br>    <span class="hljs-comment">//设置上级领导</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNextHandler</span><span class="hljs-params">(Handler nextHandler)</span>&#123;<br>        <span class="hljs-built_in">this</span>.nextHandler = nextHandler;<br>    &#125;<br><br>    <span class="hljs-comment">//提交请假条</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">submit</span><span class="hljs-params">(LeaveRequest leave)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> == <span class="hljs-built_in">this</span>.numStart)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//如果请假天数达到该领导者的处理要求</span><br>        <span class="hljs-keyword">if</span>(leave.getNum() &gt;= <span class="hljs-built_in">this</span>.numStart)&#123;<br>            <span class="hljs-built_in">this</span>.handleLeave(leave);<br><br>            <span class="hljs-comment">//如果还有上级 并且请假天数超过了当前领导的处理范围</span><br>            <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> != <span class="hljs-built_in">this</span>.nextHandler &amp;&amp; leave.getNum() &gt; numEnd)&#123;<br>                <span class="hljs-built_in">this</span>.nextHandler.submit(leave);<span class="hljs-comment">//继续提交</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;流程结束&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//各级领导处理请假条方法</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLeave</span><span class="hljs-params">(LeaveRequest leave)</span>;<br>&#125;<br><br><span class="hljs-comment">//小组长</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GroupLeader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">GroupLeader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//小组长处理1-3天的请假</span><br>        <span class="hljs-built_in">super</span>(Handler.NUM_ONE, Handler.NUM_THREE);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLeave</span><span class="hljs-params">(LeaveRequest leave)</span> &#123;<br>        System.out.println(leave.getName() + <span class="hljs-string">&quot;请假&quot;</span> + leave.getNum() + <span class="hljs-string">&quot;天,&quot;</span> + leave.getContent() + <span class="hljs-string">&quot;。&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;小组长审批：同意。&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//部门经理</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Manager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Manager</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//部门经理处理3-7天的请假</span><br>        <span class="hljs-built_in">super</span>(Handler.NUM_THREE, Handler.NUM_SEVEN);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLeave</span><span class="hljs-params">(LeaveRequest leave)</span> &#123;<br>        System.out.println(leave.getName() + <span class="hljs-string">&quot;请假&quot;</span> + leave.getNum() + <span class="hljs-string">&quot;天,&quot;</span> + leave.getContent() + <span class="hljs-string">&quot;。&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;部门经理审批：同意。&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//总经理</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GeneralManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">GeneralManager</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//部门经理处理7天以上的请假</span><br>        <span class="hljs-built_in">super</span>(Handler.NUM_SEVEN);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLeave</span><span class="hljs-params">(LeaveRequest leave)</span> &#123;<br>        System.out.println(leave.getName() + <span class="hljs-string">&quot;请假&quot;</span> + leave.getNum() + <span class="hljs-string">&quot;天,&quot;</span> + leave.getContent() + <span class="hljs-string">&quot;。&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;总经理审批：同意。&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//请假条来一张</span><br>        <span class="hljs-type">LeaveRequest</span> <span class="hljs-variable">leave</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LeaveRequest</span>(<span class="hljs-string">&quot;小花&quot;</span>,<span class="hljs-number">5</span>,<span class="hljs-string">&quot;身体不适&quot;</span>);<br><br>        <span class="hljs-comment">//各位领导</span><br>        <span class="hljs-type">GroupLeader</span> <span class="hljs-variable">groupLeader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GroupLeader</span>();<br>        <span class="hljs-type">Manager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Manager</span>();<br>        <span class="hljs-type">GeneralManager</span> <span class="hljs-variable">generalManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GeneralManager</span>();<br><br>        groupLeader.setNextHandler(manager);<span class="hljs-comment">//小组长的领导是部门经理</span><br>        manager.setNextHandler(generalManager);<span class="hljs-comment">//部门经理的领导是总经理</span><br>        <span class="hljs-comment">//之所以在这里设置上级领导，是因为可以根据实际需求来更改设置，如果实战中上级领导人都是固定的，则可以移到领导实现类中。</span><br><br>        <span class="hljs-comment">//提交申请</span><br>        groupLeader.submit(leave);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-4-4-优缺点"><a href="#6-4-4-优缺点" class="headerlink" title="6.4.4 优缺点"></a>6.4.4 优缺点</h3><p><strong>1，优点：</strong></p><ul><li><p>降低了对象之间的耦合度</p><p>该模式降低了请求发送者和接收者的耦合度。</p></li><li><p>增强了系统的可扩展性</p><p>可以根据需要增加新的请求处理类，满足开闭原则。</p></li><li><p>增强了给对象指派职责的灵活性</p><p>当工作流程发生变化，可以动态地改变链内的成员或者修改它们的次序，也可动态地新增或者删除责任。</p></li><li><p>责任链简化了对象之间的连接</p><p>一个对象只需保持一个指向其后继者的引用，不需保持其他所有处理者的引用，这避免了使用众多的 if 或者 if···else 语句。</p></li><li><p>责任分担</p><p>每个类只需要处理自己该处理的工作，不能处理的传递给下一个对象完成，明确各类的责任范围，符合类的单一职责原则。</p></li></ul><p><strong>2，缺点：</strong></p><ul><li>不能保证每个请求一定被处理。由于一个请求没有明确的接收者，所以不能保证它一定会被处理，该请求可能一直传到链的末端都得不到处理。</li><li>对比较长的职责链，请求的处理可能涉及多个处理对象，系统性能将受到一定影响。</li><li>职责链建立的合理性要靠客户端来保证，增加了客户端的复杂性，可能会由于职责链的错误设置而导致系统出错，如可能会造成循环调用。</li></ul><h3 id="6-4-5-源码解析"><a href="#6-4-5-源码解析" class="headerlink" title="6.4.5 源码解析"></a>6.4.5 源码解析</h3><p>在javaWeb应用开发中，FilterChain是职责链（过滤器）模式的典型应用，以下是Filter的模拟实现分析:</p><ul><li><p>模拟web请求Request以及web响应Response</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Request</span>&#123;<br> <br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Response</span>&#123;<br> <br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>模拟web过滤器Filter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Filter</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(Request req,Response res,FilterChain c)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>模拟实现具体过滤器  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirstFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(Request request, Response response, FilterChain chain)</span> &#123;<br><br>        System.out.println(<span class="hljs-string">&quot;过滤器1 前置处理&quot;</span>);<br><br>        <span class="hljs-comment">// 先执行所有request再倒序执行所有response</span><br>        chain.doFilter(request, response);<br><br>        System.out.println(<span class="hljs-string">&quot;过滤器1 后置处理&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondFilter</span>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(Request request, Response response, FilterChain chain)</span> &#123;<br><br>        System.out.println(<span class="hljs-string">&quot;过滤器2 前置处理&quot;</span>);<br><br>        <span class="hljs-comment">// 先执行所有request再倒序执行所有response</span><br>        chain.doFilter(request, response);<br><br>        System.out.println(<span class="hljs-string">&quot;过滤器2 后置处理&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>模拟实现过滤器链FilterChain  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterChain</span> &#123;<br><br>    <span class="hljs-keyword">private</span> List&lt;Filter&gt; filters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Filter&gt;();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// 链式调用</span><br>    <span class="hljs-keyword">public</span> FilterChain <span class="hljs-title function_">addFilter</span><span class="hljs-params">(Filter filter)</span> &#123;<br>        <span class="hljs-built_in">this</span>.filters.add(filter);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(Request request, Response response)</span> &#123;<br>        <span class="hljs-keyword">if</span> (index == filters.size()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-type">Filter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> filters.get(index);<br>        index++;<br>        filter.doFilter(request, response, <span class="hljs-built_in">this</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Request</span>  <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Response</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span> ;<br><br>        <span class="hljs-type">FilterChain</span> <span class="hljs-variable">filterChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterChain</span>();<br>        filterChain.addFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FirstFilter</span>()).addFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SecondFilter</span>());<br>        filterChain.doFilter(req,res);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h1 id="6，行为型模式-1"><a href="#6，行为型模式-1" class="headerlink" title="6，行为型模式"></a>6，行为型模式</h1><h2 id="6-5-状态模式"><a href="#6-5-状态模式" class="headerlink" title="6.5 状态模式"></a>6.5 状态模式</h2><h3 id="6-5-1-概述"><a href="#6-5-1-概述" class="headerlink" title="6.5.1 概述"></a>6.5.1 概述</h3><p>【例】通过按钮来控制一个电梯的状态，一个电梯有开门状态，关门状态，停止状态，运行状态。每一种状态改变，都有可能要根据其他状态来更新处理。例如，如果电梯门现在处于运行时状态，就不能进行开门操作，而如果电梯门是停止状态，就可以执行开门操作。</p><p>类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F%E5%89%8D.png" style="zoom:80%;" /><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ILift</span> &#123;<br>    <span class="hljs-comment">//电梯的4个状态</span><br>    <span class="hljs-comment">//开门状态</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">OPENING_STATE</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">//关门状态</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">CLOSING_STATE</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>    <span class="hljs-comment">//运行状态</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">RUNNING_STATE</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>    <span class="hljs-comment">//停止状态</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">STOPPING_STATE</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;<br><br>    <span class="hljs-comment">//设置电梯的状态</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setState</span><span class="hljs-params">(<span class="hljs-type">int</span> state)</span>;<br><br>    <span class="hljs-comment">//电梯的动作</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">open</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Lift</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ILift</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> state;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setState</span><span class="hljs-params">(<span class="hljs-type">int</span> state)</span> &#123;<br>        <span class="hljs-built_in">this</span>.state = state;<br>    &#125;<br><br>    <span class="hljs-comment">//执行关门动作</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">this</span>.state) &#123;<br>            <span class="hljs-keyword">case</span> OPENING_STATE:<br>                System.out.println(<span class="hljs-string">&quot;电梯关门了。。。&quot;</span>);<span class="hljs-comment">//只有开门状态可以关闭电梯门，可以对应电梯状态表来看</span><br>                <span class="hljs-built_in">this</span>.setState(CLOSING_STATE);<span class="hljs-comment">//关门之后电梯就是关闭状态了</span><br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> CLOSING_STATE:<br>                <span class="hljs-comment">//do nothing //已经是关门状态，不能关门</span><br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> RUNNING_STATE:<br>                <span class="hljs-comment">//do nothing //运行时电梯门是关着的，不能关门</span><br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> STOPPING_STATE:<br>                <span class="hljs-comment">//do nothing //停止时电梯也是关着的，不能关门</span><br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//执行开门动作</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">open</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">this</span>.state) &#123;<br>            <span class="hljs-keyword">case</span> OPENING_STATE:<span class="hljs-comment">//门已经开了，不能再开门了</span><br>                <span class="hljs-comment">//do nothing</span><br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> CLOSING_STATE:<span class="hljs-comment">//关门状态，门打开:</span><br>                System.out.println(<span class="hljs-string">&quot;电梯门打开了。。。&quot;</span>);<br>                <span class="hljs-built_in">this</span>.setState(OPENING_STATE);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> RUNNING_STATE:<br>                <span class="hljs-comment">//do nothing 运行时电梯不能开门</span><br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> STOPPING_STATE:<br>                System.out.println(<span class="hljs-string">&quot;电梯门开了。。。&quot;</span>);<span class="hljs-comment">//电梯停了，可以开门了</span><br>                <span class="hljs-built_in">this</span>.setState(OPENING_STATE);<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//执行运行动作</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">this</span>.state) &#123;<br>            <span class="hljs-keyword">case</span> OPENING_STATE:<span class="hljs-comment">//电梯不能开着门就走</span><br>                <span class="hljs-comment">//do nothing</span><br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> CLOSING_STATE:<span class="hljs-comment">//门关了，可以运行了</span><br>                System.out.println(<span class="hljs-string">&quot;电梯开始运行了。。。&quot;</span>);<br>                <span class="hljs-built_in">this</span>.setState(RUNNING_STATE);<span class="hljs-comment">//现在是运行状态</span><br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> RUNNING_STATE:<br>                <span class="hljs-comment">//do nothing 已经是运行状态了</span><br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> STOPPING_STATE:<br>                System.out.println(<span class="hljs-string">&quot;电梯开始运行了。。。&quot;</span>);<br>                <span class="hljs-built_in">this</span>.setState(RUNNING_STATE);<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//执行停止动作</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">this</span>.state) &#123;<br>            <span class="hljs-keyword">case</span> OPENING_STATE: <span class="hljs-comment">//开门的电梯已经是是停止的了(正常情况下)</span><br>                <span class="hljs-comment">//do nothing</span><br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> CLOSING_STATE:<span class="hljs-comment">//关门时才可以停止</span><br>                System.out.println(<span class="hljs-string">&quot;电梯停止了。。。&quot;</span>);<br>                <span class="hljs-built_in">this</span>.setState(STOPPING_STATE);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> RUNNING_STATE:<span class="hljs-comment">//运行时当然可以停止了</span><br>                System.out.println(<span class="hljs-string">&quot;电梯停止了。。。&quot;</span>);<br>                <span class="hljs-built_in">this</span>.setState(STOPPING_STATE);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> STOPPING_STATE:<br>                <span class="hljs-comment">//do nothing</span><br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Lift</span> <span class="hljs-variable">lift</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Lift</span>();<br>        lift.setState(ILift.STOPPING_STATE);<span class="hljs-comment">//电梯是停止的</span><br>        lift.open();<span class="hljs-comment">//开门</span><br>        lift.close();<span class="hljs-comment">//关门</span><br>        lift.run();<span class="hljs-comment">//运行</span><br>        lift.stop();<span class="hljs-comment">//停止</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>问题分析：</p><ul><li>使用了大量的switch…case这样的判断（if…else也是一样)，使程序的可阅读性变差。</li><li>扩展性很差。如果新加了断电的状态，我们需要修改上面判断逻辑</li></ul><p><strong>定义：</strong></p><p>对有状态的对象，把复杂的“判断逻辑”提取到不同的状态对象中，允许状态对象在其内部状态发生改变时改变其行为。</p><h3 id="6-5-2-结构"><a href="#6-5-2-结构" class="headerlink" title="6.5.2 结构"></a>6.5.2 结构</h3><p>状态模式包含以下主要角色。</p><ul><li>环境（Context）角色：也称为上下文，它定义了客户程序需要的接口，维护一个当前状态，并将与状态相关的操作委托给当前状态对象来处理。</li><li>抽象状态（State）角色：定义一个接口，用以封装环境对象中的特定状态所对应的行为。</li><li>具体状态（Concrete  State）角色：实现抽象状态所对应的行为。</li></ul><h3 id="6-5-3-案例实现"><a href="#6-5-3-案例实现" class="headerlink" title="6.5.3 案例实现"></a>6.5.3 案例实现</h3><p>对上述电梯的案例使用状态模式进行改进。类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F.png" style="zoom:70%;" /><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//抽象状态类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LiftState</span> &#123;<br>    <span class="hljs-comment">//定义一个环境角色，也就是封装状态的变化引起的功能变化</span><br>    <span class="hljs-keyword">protected</span> Context context;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContext</span><span class="hljs-params">(Context context)</span> &#123;<br>        <span class="hljs-built_in">this</span>.context = context;<br>    &#125;<br><br>    <span class="hljs-comment">//电梯开门动作</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">open</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">//电梯关门动作</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">//电梯运行动作</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">//电梯停止动作</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-comment">//开启状态</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OpenningState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LiftState</span> &#123;<br><br>    <span class="hljs-comment">//开启当然可以关闭了，我就想测试一下电梯门开关功能</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">open</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;电梯门开启...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//状态修改</span><br>        <span class="hljs-built_in">super</span>.context.setLiftState(Context.closeingState);<br>        <span class="hljs-comment">//动作委托为CloseState来执行，也就是委托给了ClosingState子类执行这个动作</span><br>        <span class="hljs-built_in">super</span>.context.getLiftState().close();<br>    &#125;<br><br>    <span class="hljs-comment">//电梯门不能开着就跑，这里什么也不做</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//do nothing</span><br>    &#125;<br><br>    <span class="hljs-comment">//开门状态已经是停止的了</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//do nothing</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//运行状态</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RunningState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LiftState</span> &#123;<br><br>    <span class="hljs-comment">//运行的时候开电梯门？你疯了！电梯不会给你开的</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">open</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//do nothing</span><br>    &#125;<br><br>    <span class="hljs-comment">//电梯门关闭？这是肯定了</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<span class="hljs-comment">//虽然可以关门，但这个动作不归我执行</span><br>        <span class="hljs-comment">//do nothing</span><br>    &#125;<br><br>    <span class="hljs-comment">//这是在运行状态下要实现的方法</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;电梯正在运行...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//这个事绝对是合理的，光运行不停止还有谁敢做这个电梯？！估计只有上帝了</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.context.setLiftState(Context.stoppingState);<br>        <span class="hljs-built_in">super</span>.context.stop();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//停止状态</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StoppingState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LiftState</span> &#123;<br><br>    <span class="hljs-comment">//停止状态，开门，那是要的！</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">open</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//状态修改</span><br>        <span class="hljs-built_in">super</span>.context.setLiftState(Context.openningState);<br>        <span class="hljs-comment">//动作委托为CloseState来执行，也就是委托给了ClosingState子类执行这个动作</span><br>        <span class="hljs-built_in">super</span>.context.getLiftState().open();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<span class="hljs-comment">//虽然可以关门，但这个动作不归我执行</span><br>        <span class="hljs-comment">//状态修改</span><br>        <span class="hljs-built_in">super</span>.context.setLiftState(Context.closeingState);<br>        <span class="hljs-comment">//动作委托为CloseState来执行，也就是委托给了ClosingState子类执行这个动作</span><br>        <span class="hljs-built_in">super</span>.context.getLiftState().close();<br>    &#125;<br><br>    <span class="hljs-comment">//停止状态再跑起来，正常的很</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//状态修改</span><br>        <span class="hljs-built_in">super</span>.context.setLiftState(Context.runningState);<br>        <span class="hljs-comment">//动作委托为CloseState来执行，也就是委托给了ClosingState子类执行这个动作</span><br>        <span class="hljs-built_in">super</span>.context.getLiftState().run();<br>    &#125;<br><br>    <span class="hljs-comment">//停止状态是怎么发生的呢？当然是停止方法执行了</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;电梯停止了...&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//关闭状态</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClosingState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LiftState</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-comment">//电梯门关闭，这是关闭状态要实现的动作</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;电梯门关闭...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//电梯门关了再打开，逗你玩呢，那这个允许呀</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">open</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.context.setLiftState(Context.openningState);<br>        <span class="hljs-built_in">super</span>.context.open();<br>    &#125;<br><br><br>    <span class="hljs-comment">//电梯门关了就跑，这是再正常不过了</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.context.setLiftState(Context.runningState);<br>        <span class="hljs-built_in">super</span>.context.run();<br>    &#125;<br><br>    <span class="hljs-comment">//电梯门关着，我就不按楼层</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.context.setLiftState(Context.stoppingState);<br>        <span class="hljs-built_in">super</span>.context.stop();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//环境角色</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span> &#123;<br>    <span class="hljs-comment">//定义出所有的电梯状态</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">OpenningState</span> <span class="hljs-variable">openningState</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenningState</span>();<span class="hljs-comment">//开门状态，这时候电梯只能关闭</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ClosingState</span> <span class="hljs-variable">closeingState</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClosingState</span>();<span class="hljs-comment">//关闭状态，这时候电梯可以运行、停止和开门</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">RunningState</span> <span class="hljs-variable">runningState</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunningState</span>();<span class="hljs-comment">//运行状态，这时候电梯只能停止</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">StoppingState</span> <span class="hljs-variable">stoppingState</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StoppingState</span>();<span class="hljs-comment">//停止状态，这时候电梯可以开门、运行</span><br><br><br>    <span class="hljs-comment">//定义一个当前电梯状态</span><br>    <span class="hljs-keyword">private</span> LiftState liftState;<br><br>    <span class="hljs-keyword">public</span> LiftState <span class="hljs-title function_">getLiftState</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.liftState;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLiftState</span><span class="hljs-params">(LiftState liftState)</span> &#123;<br>        <span class="hljs-comment">//当前环境改变</span><br>        <span class="hljs-built_in">this</span>.liftState = liftState;<br>        <span class="hljs-comment">//把当前的环境通知到各个实现类中</span><br>        <span class="hljs-built_in">this</span>.liftState.setContext(<span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">open</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.liftState.open();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.liftState.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.liftState.run();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.liftState.stop();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Context</span>();<br>        context.setLiftState(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClosingState</span>());<br><br>        context.open();<br>        context.close();<br>        context.run();<br>        context.stop();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-5-4-优缺点"><a href="#6-5-4-优缺点" class="headerlink" title="6.5.4 优缺点"></a>6.5.4 优缺点</h3><p><strong>1，优点：</strong></p><ul><li>将所有与某个状态有关的行为放到一个类中，并且可以方便地增加新的状态，只需要改变对象状态即可改变对象的行为。</li><li>允许状态转换逻辑与状态对象合成一体，而不是某一个巨大的条件语句块。</li></ul><p><strong>2，缺点：</strong></p><ul><li>状态模式的使用必然会增加系统类和对象的个数。 </li><li>状态模式的结构与实现都较为复杂，如果使用不当将导致程序结构和代码的混乱。</li><li>状态模式对”开闭原则”的支持并不太好。</li></ul><h3 id="6-5-5-使用场景"><a href="#6-5-5-使用场景" class="headerlink" title="6.5.5 使用场景"></a>6.5.5 使用场景</h3><ul><li>当一个对象的行为取决于它的状态，并且它必须在运行时根据状态改变它的行为时，就可以考虑使用状态模式。</li><li>一个操作中含有庞大的分支结构，并且这些分支决定于对象的状态时。</li></ul><h2 id="6-6-观察者模式"><a href="#6-6-观察者模式" class="headerlink" title="6.6 观察者模式"></a>6.6 观察者模式</h2><h3 id="6-6-1-概述"><a href="#6-6-1-概述" class="headerlink" title="6.6.1 概述"></a>6.6.1 概述</h3><p><strong>定义：</strong></p><p>又被称为发布-订阅（Publish&#x2F;Subscribe）模式，它定义了一种一对多的依赖关系，让多个观察者对象同时监听某一个主题对象。这个主题对象在状态变化时，会通知所有的观察者对象，使他们能够自动更新自己。</p><h3 id="6-6-2-结构"><a href="#6-6-2-结构" class="headerlink" title="6.6.2 结构"></a>6.6.2 结构</h3><p>在观察者模式中有如下角色：</p><ul><li>Subject：抽象主题（抽象被观察者），抽象主题角色把所有观察者对象保存在一个集合里，每个主题都可以有任意数量的观察者，抽象主题提供一个接口，可以增加和删除观察者对象。</li><li>ConcreteSubject：具体主题（具体被观察者），该角色将有关状态存入具体观察者对象，在具体主题的内部状态发生改变时，给所有注册过的观察者发送通知。</li><li>Observer：抽象观察者，是观察者的抽象类，它定义了一个更新接口，使得在得到主题更改通知时更新自己。</li><li>ConcrereObserver：具体观察者，实现抽象观察者定义的更新接口，以便在得到主题更改通知时更新自身的状态。</li></ul><h3 id="6-6-3-案例实现"><a href="#6-6-3-案例实现" class="headerlink" title="6.6.3 案例实现"></a>6.6.3 案例实现</h3><p>【例】微信公众号</p><p>在使用微信公众号时，大家都会有这样的体验，当你关注的公众号中有新内容更新的话，它就会推送给关注公众号的微信用户端。我们使用观察者模式来模拟这样的场景，微信用户就是观察者，微信公众号是被观察者，有多个的微信用户关注了程序猿这个公众号。</p><p>类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F.png" style="zoom:80%;" /><p>代码如下：</p><p>定义抽象观察者类，里面定义一个更新的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Observer</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(String message)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义具体观察者类，微信用户是观察者，里面实现了更新的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeixinUser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Observer</span> &#123;<br>    <span class="hljs-comment">// 微信用户名</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WeixinUser</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(String message)</span> &#123;<br>        System.out.println(name + <span class="hljs-string">&quot;-&quot;</span> + message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义抽象主题类，提供了attach、detach、notify三个方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Subject</span> &#123;<br>    <span class="hljs-comment">//增加订阅者</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(Observer observer)</span>;<br><br>    <span class="hljs-comment">//删除订阅者</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">detach</span><span class="hljs-params">(Observer observer)</span>;<br>    <br>    <span class="hljs-comment">//通知订阅者更新消息</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notify</span><span class="hljs-params">(String message)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>微信公众号是具体主题（具体被观察者），里面存储了订阅该公众号的微信用户，并实现了抽象主题中的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubscriptionSubject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Subject</span> &#123;<br>    <span class="hljs-comment">//储存订阅公众号的微信用户</span><br>    <span class="hljs-keyword">private</span> List&lt;Observer&gt; weixinUserlist = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Observer&gt;();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(Observer observer)</span> &#123;<br>        weixinUserlist.add(observer);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">detach</span><span class="hljs-params">(Observer observer)</span> &#123;<br>        weixinUserlist.remove(observer);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notify</span><span class="hljs-params">(String message)</span> &#123;<br>        <span class="hljs-keyword">for</span> (Observer observer : weixinUserlist) &#123;<br>            observer.update(message);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>客户端程序</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SubscriptionSubject mSubscriptionSubject=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SubscriptionSubject</span>();<br>        <span class="hljs-comment">//创建微信用户</span><br>        WeixinUser user1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">WeixinUser</span>(<span class="hljs-string">&quot;孙悟空&quot;</span>);<br>        WeixinUser user2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">WeixinUser</span>(<span class="hljs-string">&quot;猪悟能&quot;</span>);<br>        WeixinUser user3=<span class="hljs-keyword">new</span> <span class="hljs-title class_">WeixinUser</span>(<span class="hljs-string">&quot;沙悟净&quot;</span>);<br>        <span class="hljs-comment">//订阅公众号</span><br>        mSubscriptionSubject.attach(user1);<br>        mSubscriptionSubject.attach(user2);<br>        mSubscriptionSubject.attach(user3);<br>        <span class="hljs-comment">//公众号更新发出消息给订阅的微信用户</span><br>        mSubscriptionSubject.notify(<span class="hljs-string">&quot;传智黑马的专栏更新了&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="6-6-4-优缺点"><a href="#6-6-4-优缺点" class="headerlink" title="6.6.4 优缺点"></a>6.6.4 优缺点</h3><p><strong>1，优点：</strong></p><ul><li>降低了目标与观察者之间的耦合关系，两者之间是抽象耦合关系。</li><li>被观察者发送通知，所有注册的观察者都会收到信息【可以实现广播机制】</li></ul><p><strong>2，缺点：</strong></p><ul><li>如果观察者非常多的话，那么所有的观察者收到被观察者发送的通知会耗时</li><li>如果被观察者有循环依赖的话，那么被观察者发送通知会使观察者循环调用，会导致系统崩溃</li></ul><h3 id="6-6-5-使用场景"><a href="#6-6-5-使用场景" class="headerlink" title="6.6.5 使用场景"></a>6.6.5 使用场景</h3><ul><li>对象间存在一对多关系，一个对象的状态发生改变会影响其他对象。</li><li>当一个抽象模型有两个方面，其中一个方面依赖于另一方面时。</li></ul><h3 id="6-6-6-JDK中提供的实现"><a href="#6-6-6-JDK中提供的实现" class="headerlink" title="6.6.6 JDK中提供的实现"></a>6.6.6 JDK中提供的实现</h3><p>在 Java 中，通过 java.util.Observable 类和 java.util.Observer 接口定义了观察者模式，只要实现它们的子类就可以编写观察者模式实例。</p><p><strong>1，Observable类</strong></p><p>Observable 类是抽象目标类（被观察者），它有一个 Vector 集合成员变量，用于保存所有要通知的观察者对象，下面来介绍它最重要的 3 个方法。</p><ul><li><p>void addObserver(Observer o) 方法：用于将新的观察者对象添加到集合中。</p></li><li><p>void notifyObservers(Object arg) 方法：调用集合中的所有观察者对象的 update方法，通知它们数据发生改变。通常越晚加入集合的观察者越先得到通知。</p></li><li><p>void setChange() 方法：用来设置一个 boolean 类型的内部标志，注明目标对象发生了变化。当它为true时，notifyObservers() 才会通知观察者。</p></li></ul><p><strong>2，Observer 接口</strong></p><p>Observer 接口是抽象观察者，它监视目标对象的变化，当目标对象发生变化时，观察者得到通知，并调用 update 方法，进行相应的工作。</p><p>【例】警察抓小偷</p><p>警察抓小偷也可以使用观察者模式来实现，警察是观察者，小偷是被观察者。代码如下：</p><p>小偷是一个被观察者，所以需要继承Observable类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Thief</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Observable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Thief</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">steal</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;小偷：我偷东西了，有没有人来抓我！！！&quot;</span>);<br>        <span class="hljs-built_in">super</span>.setChanged(); <span class="hljs-comment">//changed  = true</span><br>        <span class="hljs-built_in">super</span>.notifyObservers();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>警察是一个观察者，所以需要让其实现Observer接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Policemen</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Observer</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Policemen</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Observable o, Object arg)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;警察：&quot;</span> + ((Thief) o).getName() + <span class="hljs-string">&quot;，我已经盯你很久了，你可以保持沉默，但你所说的将成为呈堂证供！！！&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>客户端代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//创建小偷对象</span><br>        <span class="hljs-type">Thief</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thief</span>(<span class="hljs-string">&quot;隔壁老王&quot;</span>);<br>        <span class="hljs-comment">//创建警察对象</span><br>        <span class="hljs-type">Policemen</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Policemen</span>(<span class="hljs-string">&quot;小李&quot;</span>);<br>        <span class="hljs-comment">//让警察盯着小偷</span><br>        t.addObserver(p);<br>        <span class="hljs-comment">//小偷偷东西</span><br>        t.steal();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-7-中介者模式"><a href="#6-7-中介者模式" class="headerlink" title="6.7 中介者模式"></a>6.7 中介者模式</h2><h3 id="6-7-1-概述"><a href="#6-7-1-概述" class="headerlink" title="6.7.1 概述"></a>6.7.1 概述</h3><p>一般来说，同事类之间的关系是比较复杂的，多个同事类之间互相关联时，他们之间的关系会呈现为复杂的网状结构，这是一种过度耦合的架构，即不利于类的复用，也不稳定。例如在下左图中，有六个同事类对象，假如对象1发生变化，那么将会有4个对象受到影响。如果对象2发生变化，那么将会有5个对象受到影响。也就是说，同事类之间直接关联的设计是不好的。</p><p>如果引入中介者模式，那么同事类之间的关系将变为星型结构，从下右图中可以看到，任何一个类的变动，只会影响的类本身，以及中介者，这样就减小了系统的耦合。一个好的设计，必定不会把所有的对象关系处理逻辑封装在本类中，而是使用一个专门的类来管理那些不属于自己的行为。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200214110924010.png" style="zoom:60%;" /><p><strong>定义：</strong></p><p>又叫调停模式，定义一个中介角色来封装一系列对象之间的交互，使原有对象之间的耦合松散，且可以独立地改变它们之间的交互。</p><h3 id="6-7-2-结构"><a href="#6-7-2-结构" class="headerlink" title="6.7.2 结构"></a>6.7.2 结构</h3><p>中介者模式包含以下主要角色：</p><ul><li><p>抽象中介者（Mediator）角色：它是中介者的接口，提供了同事对象注册与转发同事对象信息的抽象方法。</p></li><li><p>具体中介者（ConcreteMediator）角色：实现中介者接口，定义一个 List 来管理同事对象，协调各个同事角色之间的交互关系，因此它依赖于同事角色。</p></li><li><p>抽象同事类（Colleague）角色：定义同事类的接口，保存中介者对象，提供同事对象交互的抽象方法，实现所有相互影响的同事类的公共功能。</p></li><li><p>具体同事类（Concrete Colleague）角色：是抽象同事类的实现者，当需要与其他同事对象交互时，由中介者对象负责后续的交互。</p></li></ul><h3 id="6-7-3-案例实现"><a href="#6-7-3-案例实现" class="headerlink" title="6.7.3 案例实现"></a>6.7.3 案例实现</h3><p>【例】租房</p><p>现在租房基本都是通过房屋中介，房主将房屋托管给房屋中介，而租房者从房屋中介获取房屋信息。房屋中介充当租房者与房屋所有者之间的中介者。</p><p>类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E4%B8%AD%E4%BB%8B%E8%80%85%E6%A8%A1%E5%BC%8F.png" style="zoom:70%;" /><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//抽象中介者</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Mediator</span> &#123;<br>    <span class="hljs-comment">//申明一个联络方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">constact</span><span class="hljs-params">(String message,Person person)</span>;<br>&#125;<br><br><span class="hljs-comment">//抽象同事类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">protected</span> String name;<br>    <span class="hljs-keyword">protected</span> Mediator mediator;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name,Mediator mediator)</span>&#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.mediator = mediator;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//具体同事类 房屋拥有者</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HouseOwner</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Person</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HouseOwner</span><span class="hljs-params">(String name, Mediator mediator)</span> &#123;<br>        <span class="hljs-built_in">super</span>(name, mediator);<br>    &#125;<br><br>    <span class="hljs-comment">//与中介者联系</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">constact</span><span class="hljs-params">(String message)</span>&#123;<br>        mediator.constact(message, <span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//获取信息</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getMessage</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;房主&quot;</span> + name +<span class="hljs-string">&quot;获取到的信息：&quot;</span> + message);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//具体同事类 承租人</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Tenant</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Tenant</span><span class="hljs-params">(String name, Mediator mediator)</span> &#123;<br>        <span class="hljs-built_in">super</span>(name, mediator);<br>    &#125;<br><br>    <span class="hljs-comment">//与中介者联系</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">constact</span><span class="hljs-params">(String message)</span>&#123;<br>        mediator.constact(message, <span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//获取信息</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getMessage</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;租房者&quot;</span> + name +<span class="hljs-string">&quot;获取到的信息：&quot;</span> + message);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//中介机构</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediatorStructure</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Mediator</span> &#123;<br>    <span class="hljs-comment">//首先中介结构必须知道所有房主和租房者的信息</span><br>    <span class="hljs-keyword">private</span> HouseOwner houseOwner;<br>    <span class="hljs-keyword">private</span> Tenant tenant;<br><br>    <span class="hljs-keyword">public</span> HouseOwner <span class="hljs-title function_">getHouseOwner</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> houseOwner;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHouseOwner</span><span class="hljs-params">(HouseOwner houseOwner)</span> &#123;<br>        <span class="hljs-built_in">this</span>.houseOwner = houseOwner;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Tenant <span class="hljs-title function_">getTenant</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> tenant;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTenant</span><span class="hljs-params">(Tenant tenant)</span> &#123;<br>        <span class="hljs-built_in">this</span>.tenant = tenant;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">constact</span><span class="hljs-params">(String message, Person person)</span> &#123;<br>        <span class="hljs-keyword">if</span> (person == houseOwner) &#123;          <span class="hljs-comment">//如果是房主，则租房者获得信息</span><br>            tenant.getMessage(message);<br>        &#125; <span class="hljs-keyword">else</span> &#123;       <span class="hljs-comment">//反正则是房主获得信息</span><br>            houseOwner.getMessage(message);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//一个房主、一个租房者、一个中介机构</span><br>        <span class="hljs-type">MediatorStructure</span> <span class="hljs-variable">mediator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediatorStructure</span>();<br><br>        <span class="hljs-comment">//房主和租房者只需要知道中介机构即可</span><br>        <span class="hljs-type">HouseOwner</span> <span class="hljs-variable">houseOwner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HouseOwner</span>(<span class="hljs-string">&quot;张三&quot;</span>, mediator);<br>        <span class="hljs-type">Tenant</span> <span class="hljs-variable">tenant</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tenant</span>(<span class="hljs-string">&quot;李四&quot;</span>, mediator);<br><br>        <span class="hljs-comment">//中介结构要知道房主和租房者</span><br>        mediator.setHouseOwner(houseOwner);<br>        mediator.setTenant(tenant);<br><br>        tenant.constact(<span class="hljs-string">&quot;需要租三室的房子&quot;</span>);<br>        houseOwner.constact(<span class="hljs-string">&quot;我这有三室的房子，你需要租吗？&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-7-4-优缺点"><a href="#6-7-4-优缺点" class="headerlink" title="6.7.4 优缺点"></a>6.7.4 优缺点</h3><p><strong>1，优点：</strong></p><ul><li><p>松散耦合</p><p>中介者模式通过把多个同事对象之间的交互封装到中介者对象里面，从而使得同事对象之间松散耦合，基本上可以做到互补依赖。这样一来，同事对象就可以独立地变化和复用，而不再像以前那样“牵一处而动全身”了。</p></li><li><p>集中控制交互</p><p>多个同事对象的交互，被封装在中介者对象里面集中管理，使得这些交互行为发生变化的时候，只需要修改中介者对象就可以了，当然如果是已经做好的系统，那么就扩展中介者对象，而各个同事类不需要做修改。</p></li><li><p>一对多关联转变为一对一的关联</p><p>没有使用中介者模式的时候，同事对象之间的关系通常是一对多的，引入中介者对象以后，中介者对象和同事对象的关系通常变成双向的一对一，这会让对象的关系更容易理解和实现。</p></li></ul><p><strong>2，缺点：</strong></p><p>当同事类太多时，中介者的职责将很大，它会变得复杂而庞大，以至于系统难以维护。</p><h3 id="6-7-5-使用场景"><a href="#6-7-5-使用场景" class="headerlink" title="6.7.5 使用场景"></a>6.7.5 使用场景</h3><ul><li>系统中对象之间存在复杂的引用关系，系统结构混乱且难以理解。</li><li>当想创建一个运行于多个类之间的对象，又不想生成新的子类时。</li></ul><h2 id="6-8-迭代器模式"><a href="#6-8-迭代器模式" class="headerlink" title="6.8 迭代器模式"></a>6.8 迭代器模式</h2><h3 id="6-8-1-概述"><a href="#6-8-1-概述" class="headerlink" title="6.8.1 概述"></a>6.8.1 概述</h3><p><strong>定义：</strong></p><p>提供一个对象来顺序访问聚合对象中的一系列数据，而不暴露聚合对象的内部表示。 </p><h3 id="6-8-2-结构"><a href="#6-8-2-结构" class="headerlink" title="6.8.2 结构"></a>6.8.2 结构</h3><p>迭代器模式主要包含以下角色：</p><ul><li><p>抽象聚合（Aggregate）角色：定义存储、添加、删除聚合元素以及创建迭代器对象的接口。</p></li><li><p>具体聚合（ConcreteAggregate）角色：实现抽象聚合类，返回一个具体迭代器的实例。</p></li><li><p>抽象迭代器（Iterator）角色：定义访问和遍历聚合元素的接口，通常包含 hasNext()、next() 等方法。</p></li><li><p>具体迭代器（Concretelterator）角色：实现抽象迭代器接口中所定义的方法，完成对聚合对象的遍历，记录遍历的当前位置。</p></li></ul><h3 id="6-8-3-案例实现"><a href="#6-8-3-案例实现" class="headerlink" title="6.8.3 案例实现"></a>6.8.3 案例实现</h3><p>【例】定义一个可以存储学生对象的容器对象，将遍历该容器的功能交由迭代器实现，涉及到的类如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%A8%A1%E5%BC%8F.png" style="zoom:90%;" /><p>代码如下：</p><p>定义迭代器接口，声明hasNext、next方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StudentIterator</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span>;<br>    Student <span class="hljs-title function_">next</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义具体的迭代器类，重写所有的抽象方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentIteratorImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StudentIterator</span> &#123;<br>    <span class="hljs-keyword">private</span> List&lt;Student&gt; list;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">StudentIteratorImpl</span><span class="hljs-params">(List&lt;Student&gt; list)</span> &#123;<br>        <span class="hljs-built_in">this</span>.list = list;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> position &lt; list.size();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Student <span class="hljs-title function_">next</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">currentStudent</span> <span class="hljs-operator">=</span> list.get(position);<br>        position ++;<br>        <span class="hljs-keyword">return</span> currentStudent;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义抽象容器类，包含添加元素，删除元素，获取迭代器对象的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StudentAggregate</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addStudent</span><span class="hljs-params">(Student student)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeStudent</span><span class="hljs-params">(Student student)</span>;<br><br>    StudentIterator <span class="hljs-title function_">getStudentIterator</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义具体的容器类，重写所有的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentAggregateImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StudentAggregate</span> &#123;<br><br>    <span class="hljs-keyword">private</span> List&lt;Student&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Student&gt;();  <span class="hljs-comment">// 学生列表</span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addStudent</span><span class="hljs-params">(Student student)</span> &#123;<br>        <span class="hljs-built_in">this</span>.list.add(student);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeStudent</span><span class="hljs-params">(Student student)</span> &#123;<br>        <span class="hljs-built_in">this</span>.list.remove(student);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> StudentIterator <span class="hljs-title function_">getStudentIterator</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StudentIteratorImpl</span>(list);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-8-4-优缺点"><a href="#6-8-4-优缺点" class="headerlink" title="6.8.4 优缺点"></a>6.8.4 优缺点</h3><p><strong>1，优点：</strong></p><ul><li>它支持以不同的方式遍历一个聚合对象，在同一个聚合对象上可以定义多种遍历方式。在迭代器模式中只需要用一个不同的迭代器来替换原有迭代器即可改变遍历算法，我们也可以自己定义迭代器的子类以支持新的遍历方式。</li><li>迭代器简化了聚合类。由于引入了迭代器，在原有的聚合对象中不需要再自行提供数据遍历等方法，这样可以简化聚合类的设计。</li><li>在迭代器模式中，由于引入了抽象层，增加新的聚合类和迭代器类都很方便，无须修改原有代码，满足 “开闭原则” 的要求。</li></ul><p><strong>2，缺点：</strong></p><p>增加了类的个数，这在一定程度上增加了系统的复杂性。</p><h3 id="6-8-5-使用场景"><a href="#6-8-5-使用场景" class="headerlink" title="6.8.5 使用场景"></a>6.8.5 使用场景</h3><ul><li>当需要为聚合对象提供多种遍历方式时。</li><li>当需要为遍历不同的聚合结构提供一个统一的接口时。</li><li>当访问一个聚合对象的内容而无须暴露其内部细节的表示时。</li></ul><h3 id="6-8-6-JDK源码解析"><a href="#6-8-6-JDK源码解析" class="headerlink" title="6.8.6 JDK源码解析"></a>6.8.6 JDK源码解析</h3><p>迭代器模式在JAVA的很多集合类中被广泛应用，接下来看看JAVA源码中是如何使用迭代器模式的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>Iterator&lt;String&gt; iterator = list.iterator(); <span class="hljs-comment">//list.iterator()方法返回的肯定是Iterator接口的子实现类对象</span><br><span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>    System.out.println(iterator.next());<br>&#125;<br></code></pre></td></tr></table></figure><p>看完这段代码是不是很熟悉，与我们上面代码基本类似。单列集合都使用到了迭代器，我们以ArrayList举例来说明</p><ul><li>List：抽象聚合类</li><li>ArrayList：具体的聚合类</li><li>Iterator：抽象迭代器</li><li>list.iterator()：返回的是实现了 <code>Iterator</code> 接口的具体迭代器对象</li></ul><p>具体的来看看 ArrayList的代码实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayList</span>&lt;E&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractList</span>&lt;E&gt;<br>        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">List</span>&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable &#123;<br>    <br>    <span class="hljs-keyword">public</span> Iterator&lt;E&gt; <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Itr</span>();<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Itr</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Iterator</span>&lt;E&gt; &#123;<br>        <span class="hljs-type">int</span> cursor;       <span class="hljs-comment">// 下一个要返回元素的索引</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">lastRet</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 上一个返回元素的索引</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">expectedModCount</span> <span class="hljs-operator">=</span> modCount;<br><br>        Itr() &#123;&#125;<br><br>        <span class="hljs-comment">//判断是否还有元素</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> cursor != size;<br>        &#125;<br><br>        <span class="hljs-comment">//获取下一个元素</span><br>        <span class="hljs-keyword">public</span> E <span class="hljs-title function_">next</span><span class="hljs-params">()</span> &#123;<br>            checkForComodification();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> cursor;<br>            <span class="hljs-keyword">if</span> (i &gt;= size)<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();<br>            Object[] elementData = ArrayList.<span class="hljs-built_in">this</span>.elementData;<br>            <span class="hljs-keyword">if</span> (i &gt;= elementData.length)<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentModificationException</span>();<br>            cursor = i + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">return</span> (E) elementData[lastRet = i];<br>        &#125;<br>        ...<br>&#125;<br></code></pre></td></tr></table></figure><p>这部分代码还是比较简单，大致就是在 <code>iterator</code> 方法中返回了一个实例化的 <code>Iterator</code> 对象。Itr是一个内部类，它实现了 <code>Iterator</code> 接口并重写了其中的抽象方法。</p><blockquote><p>注意： </p><p>​当我们在使用JAVA开发的时候，想使用迭代器模式的话，只要让我们自己定义的容器类实现<code>java.util.Iterable</code>并实现其中的iterator()方法使其返回一个 <code>java.util.Iterator</code> 的实现类就可以了。</p></blockquote><h2 id="6-9-访问者模式"><a href="#6-9-访问者模式" class="headerlink" title="6.9 访问者模式"></a>6.9 访问者模式</h2><h3 id="6-9-1-概述"><a href="#6-9-1-概述" class="headerlink" title="6.9.1 概述"></a>6.9.1 概述</h3><p><strong>定义：</strong></p><p>封装一些作用于某种数据结构中的各元素的操作，它可以在不改变这个数据结构的前提下定义作用于这些元素的新的操作。</p><h3 id="6-9-2-结构"><a href="#6-9-2-结构" class="headerlink" title="6.9.2 结构"></a>6.9.2 结构</h3><p>访问者模式包含以下主要角色:</p><ul><li>抽象访问者（Visitor）角色：定义了对每一个元素<code>（Element）</code>访问的行为，它的参数就是可以访问的元素，它的方法个数理论上来讲与元素类个数（Element的实现类个数）是一样的，从这点不难看出，访问者模式要求元素类的个数不能改变。</li><li>具体访问者（ConcreteVisitor）角色：给出对每一个元素类访问时所产生的具体行为。</li><li>抽象元素（Element）角色：定义了一个接受访问者的方法（<code>accept</code>），其意义是指，每一个元素都要可以被访问者访问。</li><li>具体元素（ConcreteElement）角色： 提供接受访问方法的具体实现，而这个具体的实现，通常情况下是使用访问者提供的访问该元素类的方法。</li><li>对象结构（Object Structure）角色：定义当中所提到的对象结构，对象结构是一个抽象表述，具体点可以理解为一个具有容器性质或者复合对象特性的类，它会含有一组元素（<code>Element</code>），并且可以迭代这些元素，供访问者访问。</li></ul><h3 id="6-9-3-案例实现"><a href="#6-9-3-案例实现" class="headerlink" title="6.9.3 案例实现"></a>6.9.3 案例实现</h3><p>【例】给宠物喂食</p><p>现在养宠物的人特别多，我们就以这个为例，当然宠物还分为狗，猫等，要给宠物喂食的话，主人可以喂，其他人也可以喂食。</p><ul><li>访问者角色：给宠物喂食的人</li><li>具体访问者角色：主人、其他人</li><li>抽象元素角色：动物抽象类</li><li>具体元素角色：宠物狗、宠物猫</li><li>结构对象角色：主人家</li></ul><p>类图如下：</p><p><img src="/23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BF%E9%97%AE%E8%80%85%E6%A8%A1%E5%BC%8F.png"></p><p>代码如下：</p><p>创建抽象访问者接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">feed</span><span class="hljs-params">(Cat cat)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">feed</span><span class="hljs-params">(Dog dog)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>创建不同的具体访问者角色（主人和其他人），都需要实现 <code>Person</code>接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Owner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Person</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">feed</span><span class="hljs-params">(Cat cat)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;主人喂食猫&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">feed</span><span class="hljs-params">(Dog dog)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;主人喂食狗&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Someone</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">feed</span><span class="hljs-params">(Cat cat)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;其他人喂食猫&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">feed</span><span class="hljs-params">(Dog dog)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;其他人喂食狗&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义抽象节点 – 宠物</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Animal</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(Person person)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义实现<code>Animal</code>接口的 具体节点（元素）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Animal</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(Person person)</span> &#123;<br>        person.feed(<span class="hljs-built_in">this</span>);<br>        System.out.println(<span class="hljs-string">&quot;好好吃，汪汪汪！！！&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Animal</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(Person person)</span> &#123;<br>        person.feed(<span class="hljs-built_in">this</span>);<br>        System.out.println(<span class="hljs-string">&quot;好好吃，喵喵喵！！！&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义对象结构，此案例中就是主人的家</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Home</span> &#123;<br>    <span class="hljs-keyword">private</span> List&lt;Animal&gt; nodeList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Animal&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">action</span><span class="hljs-params">(Person person)</span> &#123;<br>        <span class="hljs-keyword">for</span> (Animal node : nodeList) &#123;<br>            node.accept(person);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//添加操作</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(Animal animal)</span> &#123;<br>        nodeList.add(animal);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Home</span> <span class="hljs-variable">home</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Home</span>();<br>        home.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>());<br>        home.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>());<br><br>        <span class="hljs-type">Owner</span> <span class="hljs-variable">owner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Owner</span>();<br>        home.action(owner);<br><br>        <span class="hljs-type">Someone</span> <span class="hljs-variable">someone</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Someone</span>();<br>        home.action(someone);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-9-4-优缺点"><a href="#6-9-4-优缺点" class="headerlink" title="6.9.4 优缺点"></a>6.9.4 优缺点</h3><p><strong>1，优点：</strong></p><ul><li><p>扩展性好</p><p>在不修改对象结构中的元素的情况下，为对象结构中的元素添加新的功能。</p></li><li><p>复用性好</p><p>通过访问者来定义整个对象结构通用的功能，从而提高复用程度。</p></li><li><p>分离无关行为</p><p>通过访问者来分离无关的行为，把相关的行为封装在一起，构成一个访问者，这样每一个访问者的功能都比较单一。</p></li></ul><p><strong>2，缺点：</strong></p><ul><li><p>对象结构变化很困难</p><p>在访问者模式中，每增加一个新的元素类，都要在每一个具体访问者类中增加相应的具体操作，这违背了“开闭原则”。</p></li><li><p>违反了依赖倒置原则</p><p>访问者模式依赖了具体类，而没有依赖抽象类。</p></li></ul><h3 id="6-9-5-使用场景"><a href="#6-9-5-使用场景" class="headerlink" title="6.9.5  使用场景"></a>6.9.5  使用场景</h3><ul><li><p>对象结构相对稳定，但其操作算法经常变化的程序。</p></li><li><p>对象结构中的对象需要提供多种不同且不相关的操作，而且要避免让这些操作的变化影响对象的结构。</p></li></ul><h3 id="6-9-6-扩展"><a href="#6-9-6-扩展" class="headerlink" title="6.9.6 扩展"></a>6.9.6 扩展</h3><p>访问者模式用到了一种双分派的技术。</p><p><strong>1，分派：</strong></p><p>变量被声明时的类型叫做变量的静态类型，有些人又把静态类型叫做明显类型；而变量所引用的对象的真实类型又叫做变量的实际类型。比如 <code>Map map = new HashMap()</code> ，map变量的静态类型是 <code>Map</code> ，实际类型是 <code>HashMap</code> 。根据对象的类型而对方法进行的选择，就是分派(Dispatch)，分派(Dispatch)又分为两种，即静态分派和动态分派。</p><p><strong>静态分派(Static Dispatch)</strong> 发生在编译时期，分派根据静态类型信息发生。静态分派对于我们来说并不陌生，方法重载就是静态分派。</p><p><strong>动态分派(Dynamic Dispatch)</strong> 发生在运行时期，动态分派动态地置换掉某个方法。Java通过方法的重写支持动态分派。</p><p><strong>2，动态分派：</strong></p><p>通过方法的重写支持动态分派。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Animal&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Animal</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;dog&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Animal</span> &#123;<br>     <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;cat&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Animal</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();<br>        a.execute();<br>        <br>        <span class="hljs-type">Animal</span> <span class="hljs-variable">a1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();<br>        a1.execute();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>上面代码的结果大家应该直接可以说出来，这不就是多态吗！运行执行的是子类中的方法。</p><p>Java编译器在编译时期并不总是知道哪些代码会被执行，因为编译器仅仅知道对象的静态类型，而不知道对象的真实类型；而方法的调用则是根据对象的真实类型，而不是静态类型。</p><p><strong>3，静态分派：</strong></p><p>通过方法重载支持静态分派。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> &#123;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Animal</span> &#123;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Animal</span> &#123;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Execute</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Animal a)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Animal&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Dog d)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;dog&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Cat c)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;cat&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Animal</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>();<br>        <span class="hljs-type">Animal</span> <span class="hljs-variable">a1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();<br>        <span class="hljs-type">Animal</span> <span class="hljs-variable">a2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();<br><br>        <span class="hljs-type">Execute</span> <span class="hljs-variable">exe</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Execute</span>();<br>        exe.execute(a);<br>        exe.execute(a1);<br>        exe.execute(a2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行结果：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200214215446638.png" style="zoom:70%;" /><p>这个结果可能出乎一些人的意料了，为什么呢？</p><p><strong>重载方法的分派是根据静态类型进行的，这个分派过程在编译时期就完成了。</strong></p><p><strong>4，双分派：</strong></p><p>所谓双分派技术就是在选择一个方法的时候，不仅仅要根据消息接收者（receiver）的运行时区别，还要根据参数的运行时区别。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(Execute exe)</span> &#123;<br>        exe.execute(<span class="hljs-built_in">this</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Animal</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(Execute exe)</span> &#123;<br>        exe.execute(<span class="hljs-built_in">this</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Animal</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(Execute exe)</span> &#123;<br>        exe.execute(<span class="hljs-built_in">this</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Execute</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Animal a)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;animal&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Dog d)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;dog&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Cat c)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;cat&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Animal</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>();<br>        <span class="hljs-type">Animal</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();<br>        <span class="hljs-type">Animal</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();<br><br>        <span class="hljs-type">Execute</span> <span class="hljs-variable">exe</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Execute</span>();<br>        a.accept(exe);<br>        d.accept(exe);<br>        c.accept(exe);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在上面代码中，客户端将Execute对象做为参数传递给Animal类型的变量调用的方法，这里完成第一次分派，这里是方法重写，所以是动态分派，也就是执行实际类型中的方法，同时也<code>将自己this作为参数传递进去，这里就完成了第二次分派</code>，这里的Execute类中有多个重载的方法，而传递进行的是this，就是具体的实际类型的对象。</p><p>说到这里，我们已经明白双分派是怎么回事了，但是它有什么效果呢？就是可以实现方法的动态绑定，我们可以对上面的程序进行修改。</p><p>运行结果如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200426233931693.png" style="zoom:67%;" /><p><strong>双分派实现动态绑定的本质，就是在重载方法委派的前面加上了继承体系中覆盖的环节，由于覆盖是动态的，所以重载就是动态的了。</strong></p><h2 id="6-10-备忘录模式"><a href="#6-10-备忘录模式" class="headerlink" title="6.10 备忘录模式"></a>6.10 备忘录模式</h2><h3 id="6-10-1-概述"><a href="#6-10-1-概述" class="headerlink" title="6.10.1 概述"></a>6.10.1 概述</h3><p>备忘录模式提供了一种状态恢复的实现机制，使得用户可以方便地回到一个特定的历史步骤，当新的状态无效或者存在问题时，可以使用暂时存储起来的备忘录将状态复原，很多软件都提供了撤销（Undo）操作，如 Word、记事本、Photoshop、IDEA等软件在编辑时按 Ctrl+Z 组合键时能撤销当前操作，使文档恢复到之前的状态；还有在 浏览器 中的后退键、数据库事务管理中的回滚操作、玩游戏时的中间结果存档功能、数据库与操作系统的备份操作、棋类游戏中的悔棋功能等都属于这类。</p><p><strong>定义：</strong></p><p>又叫快照模式，在不破坏封装性的前提下，捕获一个对象的内部状态，并在该对象之外保存这个状态，以便以后当需要时能将该对象恢复到原先保存的状态。</p><h3 id="6-10-2-结构"><a href="#6-10-2-结构" class="headerlink" title="6.10.2 结构"></a>6.10.2 结构</h3><p>备忘录模式的主要角色如下：</p><ul><li>发起人（Originator）角色：记录当前时刻的内部状态信息，提供创建备忘录和恢复备忘录数据的功能，实现其他业务功能，它可以访问备忘录里的所有信息。</li><li>备忘录（Memento）角色：负责存储发起人的内部状态，在需要的时候提供这些内部状态给发起人。</li><li>管理者（Caretaker）角色：对备忘录进行管理，提供保存与获取备忘录的功能，但其不能对备忘录的内容进行访问与修改。</li></ul><blockquote><p>备忘录有两个等效的接口：</p><ul><li><strong>窄接口</strong>：管理者(Caretaker)对象（和其他发起人对象之外的任何对象）看到的是备忘录的窄接口(narror Interface)，这个窄接口只允许他把备忘录对象传给其他的对象。</li><li><strong>宽接口</strong>：与管理者看到的窄接口相反，发起人对象可以看到一个宽接口(wide Interface)，这个宽接口允许它读取所有的数据，以便根据这些数据恢复这个发起人对象的内部状态。</li></ul></blockquote><h3 id="6-10-3-案例实现"><a href="#6-10-3-案例实现" class="headerlink" title="6.10.3 案例实现"></a>6.10.3 案例实现</h3><p>【例】游戏挑战BOSS</p><p>游戏中的某个场景，一游戏角色有生命力、攻击力、防御力等数据，在打Boss前和后一定会不一样的，我们允许玩家如果感觉与Boss决斗的效果不理想可以让游戏恢复到决斗之前的状态。</p><p>要实现上述案例，有两种方式：</p><ul><li>“白箱”备忘录模式</li><li>“黑箱”备忘录模式</li></ul><h4 id="6-10-3-1-“白箱”备忘录模式"><a href="#6-10-3-1-“白箱”备忘录模式" class="headerlink" title="6.10.3.1 “白箱”备忘录模式"></a>6.10.3.1 “白箱”备忘录模式</h4><p>备忘录角色对任何对象都提供一个接口，即宽接口，备忘录角色的内部所存储的状态就对所有对象公开。类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%99%BD%E7%AE%B1%E5%A4%87%E5%BF%98%E5%BD%95%E6%A8%A1%E5%BC%8F.png" style="zoom:80%;" /><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//游戏角色类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GameRole</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> vit; <span class="hljs-comment">//生命力</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> atk; <span class="hljs-comment">//攻击力</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> def; <span class="hljs-comment">//防御力</span><br><br>    <span class="hljs-comment">//初始化状态</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initState</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.vit = <span class="hljs-number">100</span>;<br>        <span class="hljs-built_in">this</span>.atk = <span class="hljs-number">100</span>;<br>        <span class="hljs-built_in">this</span>.def = <span class="hljs-number">100</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//战斗</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fight</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.vit = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">this</span>.atk = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">this</span>.def = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//保存角色状态</span><br>    <span class="hljs-keyword">public</span> RoleStateMemento <span class="hljs-title function_">saveState</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RoleStateMemento</span>(vit, atk, def);<br>    &#125;<br><br>    <span class="hljs-comment">//回复角色状态</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recoverState</span><span class="hljs-params">(RoleStateMemento roleStateMemento)</span> &#123;<br>        <span class="hljs-built_in">this</span>.vit = roleStateMemento.getVit();<br>        <span class="hljs-built_in">this</span>.atk = roleStateMemento.getAtk();<br>        <span class="hljs-built_in">this</span>.def = roleStateMemento.getDef();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stateDisplay</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;角色生命力：&quot;</span> + vit);<br>        System.out.println(<span class="hljs-string">&quot;角色攻击力：&quot;</span> + atk);<br>        System.out.println(<span class="hljs-string">&quot;角色防御力：&quot;</span> + def);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getVit</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> vit;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setVit</span><span class="hljs-params">(<span class="hljs-type">int</span> vit)</span> &#123;<br>        <span class="hljs-built_in">this</span>.vit = vit;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAtk</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> atk;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAtk</span><span class="hljs-params">(<span class="hljs-type">int</span> atk)</span> &#123;<br>        <span class="hljs-built_in">this</span>.atk = atk;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getDef</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> def;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDef</span><span class="hljs-params">(<span class="hljs-type">int</span> def)</span> &#123;<br>        <span class="hljs-built_in">this</span>.def = def;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//游戏状态存储类(备忘录类)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoleStateMemento</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> vit;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> atk;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> def;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RoleStateMemento</span><span class="hljs-params">(<span class="hljs-type">int</span> vit, <span class="hljs-type">int</span> atk, <span class="hljs-type">int</span> def)</span> &#123;<br>        <span class="hljs-built_in">this</span>.vit = vit;<br>        <span class="hljs-built_in">this</span>.atk = atk;<br>        <span class="hljs-built_in">this</span>.def = def;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getVit</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> vit;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setVit</span><span class="hljs-params">(<span class="hljs-type">int</span> vit)</span> &#123;<br>        <span class="hljs-built_in">this</span>.vit = vit;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAtk</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> atk;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAtk</span><span class="hljs-params">(<span class="hljs-type">int</span> atk)</span> &#123;<br>        <span class="hljs-built_in">this</span>.atk = atk;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getDef</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> def;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDef</span><span class="hljs-params">(<span class="hljs-type">int</span> def)</span> &#123;<br>        <span class="hljs-built_in">this</span>.def = def;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//角色状态管理者类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoleStateCaretaker</span> &#123;<br>    <span class="hljs-keyword">private</span> RoleStateMemento roleStateMemento;<br><br>    <span class="hljs-keyword">public</span> RoleStateMemento <span class="hljs-title function_">getRoleStateMemento</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> roleStateMemento;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRoleStateMemento</span><span class="hljs-params">(RoleStateMemento roleStateMemento)</span> &#123;<br>        <span class="hljs-built_in">this</span>.roleStateMemento = roleStateMemento;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;------------大战Boss前------------&quot;</span>);<br>        <span class="hljs-comment">//大战Boss前</span><br>        <span class="hljs-type">GameRole</span> <span class="hljs-variable">gameRole</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GameRole</span>();<br>        gameRole.initState();<br>        gameRole.stateDisplay();<br><br>        <span class="hljs-comment">//保存进度</span><br>        <span class="hljs-type">RoleStateCaretaker</span> <span class="hljs-variable">roleStateCaretaker</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RoleStateCaretaker</span>();<br>        roleStateCaretaker.setRoleStateMemento(gameRole.saveState());<br><br>        System.out.println(<span class="hljs-string">&quot;------------大战Boss后------------&quot;</span>);<br>        <span class="hljs-comment">//大战Boss时，损耗严重</span><br>        gameRole.fight();<br>        gameRole.stateDisplay();<br>        System.out.println(<span class="hljs-string">&quot;------------恢复之前状态------------&quot;</span>);<br>        <span class="hljs-comment">//恢复之前状态</span><br>        gameRole.recoverState(roleStateCaretaker.getRoleStateMemento());<br>        gameRole.stateDisplay();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>分析：白箱备忘录模式是破坏封装性的。但是通过程序员自律，同样可以在一定程度上实现模式的大部分用意。</p></blockquote><h4 id="6-10-3-2-“黑箱”备忘录模式"><a href="#6-10-3-2-“黑箱”备忘录模式" class="headerlink" title="6.10.3.2 “黑箱”备忘录模式"></a>6.10.3.2 “黑箱”备忘录模式</h4><p>备忘录角色对发起人对象提供一个宽接口，而为其他对象提供一个窄接口。在Java语言中，实现双重接口的办法就是将<strong>备忘录类</strong>设计成<strong>发起人类</strong>的内部成员类。</p><p>将 <code>RoleStateMemento</code> 设为 <code>GameRole</code> 的内部类，从而将 <code>RoleStateMemento</code> 对象封装在 <code>GameRole</code> 里面；在外面提供一个标识接口 <code>Memento</code> 给 <code>RoleStateCaretaker</code> 及其他对象使用。这样 <code>GameRole</code> 类看到的是 <code>RoleStateMemento</code> 所有的接口，而<code>RoleStateCaretaker</code>  及其他对象看到的仅仅是标识接口 <code>Memento</code> 所暴露出来的接口，从而维护了封装型。类图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%BB%91%E7%AE%B1%E5%A4%87%E5%BF%98%E5%BD%95%E6%A8%A1%E5%BC%8F.png" style="zoom:70%;" /><p>代码如下：</p><p>窄接口<code>Memento</code>，这是一个标识接口，因此没有定义出任何的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Memento</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义发起人类 <code>GameRole</code>，并在内部定义备忘录内部类 <code>RoleStateMemento</code>（该内部类设置为私有的）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs java">/游戏角色类<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GameRole</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> vit; <span class="hljs-comment">//生命力</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> atk; <span class="hljs-comment">//攻击力</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> def; <span class="hljs-comment">//防御力</span><br><br>    <span class="hljs-comment">//初始化状态</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initState</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.vit = <span class="hljs-number">100</span>;<br>        <span class="hljs-built_in">this</span>.atk = <span class="hljs-number">100</span>;<br>        <span class="hljs-built_in">this</span>.def = <span class="hljs-number">100</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//战斗</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fight</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.vit = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">this</span>.atk = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">this</span>.def = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//保存角色状态</span><br>    <span class="hljs-keyword">public</span> Memento <span class="hljs-title function_">saveState</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RoleStateMemento</span>(vit, atk, def);<br>    &#125;<br><br>    <span class="hljs-comment">//回复角色状态</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recoverState</span><span class="hljs-params">(Memento memento)</span> &#123;<br>        <span class="hljs-type">RoleStateMemento</span> <span class="hljs-variable">roleStateMemento</span> <span class="hljs-operator">=</span> (RoleStateMemento) memento;<br>        <span class="hljs-built_in">this</span>.vit = roleStateMemento.getVit();<br>        <span class="hljs-built_in">this</span>.atk = roleStateMemento.getAtk();<br>        <span class="hljs-built_in">this</span>.def = roleStateMemento.getDef();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stateDisplay</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;角色生命力：&quot;</span> + vit);<br>        System.out.println(<span class="hljs-string">&quot;角色攻击力：&quot;</span> + atk);<br>        System.out.println(<span class="hljs-string">&quot;角色防御力：&quot;</span> + def);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getVit</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> vit;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setVit</span><span class="hljs-params">(<span class="hljs-type">int</span> vit)</span> &#123;<br>        <span class="hljs-built_in">this</span>.vit = vit;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAtk</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> atk;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAtk</span><span class="hljs-params">(<span class="hljs-type">int</span> atk)</span> &#123;<br>        <span class="hljs-built_in">this</span>.atk = atk;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getDef</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> def;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDef</span><span class="hljs-params">(<span class="hljs-type">int</span> def)</span> &#123;<br>        <span class="hljs-built_in">this</span>.def = def;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoleStateMemento</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Memento</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> vit;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> atk;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> def;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">RoleStateMemento</span><span class="hljs-params">(<span class="hljs-type">int</span> vit, <span class="hljs-type">int</span> atk, <span class="hljs-type">int</span> def)</span> &#123;<br>            <span class="hljs-built_in">this</span>.vit = vit;<br>            <span class="hljs-built_in">this</span>.atk = atk;<br>            <span class="hljs-built_in">this</span>.def = def;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getVit</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> vit;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setVit</span><span class="hljs-params">(<span class="hljs-type">int</span> vit)</span> &#123;<br>            <span class="hljs-built_in">this</span>.vit = vit;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAtk</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> atk;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAtk</span><span class="hljs-params">(<span class="hljs-type">int</span> atk)</span> &#123;<br>            <span class="hljs-built_in">this</span>.atk = atk;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getDef</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> def;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDef</span><span class="hljs-params">(<span class="hljs-type">int</span> def)</span> &#123;<br>            <span class="hljs-built_in">this</span>.def = def;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>负责人角色类 <code>RoleStateCaretaker</code> 能够得到的备忘录对象是以 <code>Memento</code> 为接口的，由于这个接口仅仅是一个标识接口，因此负责人角色不可能改变这个备忘录对象的内容</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//角色状态管理者类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoleStateCaretaker</span> &#123;<br>    <span class="hljs-keyword">private</span> Memento memento;<br><br>    <span class="hljs-keyword">public</span> Memento <span class="hljs-title function_">getMemento</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> memento;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMemento</span><span class="hljs-params">(Memento memento)</span> &#123;<br>        <span class="hljs-built_in">this</span>.memento = memento;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>客户端测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;------------大战Boss前------------&quot;</span>);<br>        <span class="hljs-comment">//大战Boss前</span><br>        <span class="hljs-type">GameRole</span> <span class="hljs-variable">gameRole</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GameRole</span>();<br>        gameRole.initState();<br>        gameRole.stateDisplay();<br><br>        <span class="hljs-comment">//保存进度</span><br>        <span class="hljs-type">RoleStateCaretaker</span> <span class="hljs-variable">roleStateCaretaker</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RoleStateCaretaker</span>();<br>        roleStateCaretaker.setMemento(gameRole.saveState());<br>        <br>        System.out.println(<span class="hljs-string">&quot;------------大战Boss后------------&quot;</span>);<br>        <span class="hljs-comment">//大战Boss时，损耗严重</span><br>        gameRole.fight();<br>        gameRole.stateDisplay();<br>        System.out.println(<span class="hljs-string">&quot;------------恢复之前状态------------&quot;</span>);<br>        <span class="hljs-comment">//恢复之前状态</span><br>        gameRole.recoverState(roleStateCaretaker.getMemento());<br>        gameRole.stateDisplay();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="6-10-4-优缺点"><a href="#6-10-4-优缺点" class="headerlink" title="6.10.4 优缺点"></a>6.10.4 优缺点</h3><p><strong>1，优点：</strong></p><ul><li>提供了一种可以恢复状态的机制。当用户需要时能够比较方便地将数据恢复到某个历史的状态。</li><li>实现了内部状态的封装。除了创建它的发起人之外，其他对象都不能够访问这些状态信息。</li><li>简化了发起人类。发起人不需要管理和保存其内部状态的各个备份，所有状态信息都保存在备忘录中，并由管理者进行管理，这符合单一职责原则。</li></ul><p><strong>2，缺点：</strong></p><ul><li>资源消耗大。如果要保存的内部状态信息过多或者特别频繁，将会占用比较大的内存资源。</li></ul><h3 id="6-10-5-使用场景"><a href="#6-10-5-使用场景" class="headerlink" title="6.10.5 使用场景"></a>6.10.5 使用场景</h3><ul><li><p>需要保存与恢复数据的场景，如玩游戏时的中间结果的存档功能。</p></li><li><p>需要提供一个可回滚操作的场景，如 Word、记事本、Photoshop，idea等软件在编辑时按 Ctrl+Z 组合键，还有数据库中事务操作。</p></li></ul><h1 id="6，行为型模式-2"><a href="#6，行为型模式-2" class="headerlink" title="6，行为型模式"></a>6，行为型模式</h1><h2 id="6-11-解释器模式"><a href="#6-11-解释器模式" class="headerlink" title="6.11 解释器模式"></a>6.11 解释器模式</h2><h3 id="6-11-1-概述"><a href="#6-11-1-概述" class="headerlink" title="6.11.1 概述"></a>6.11.1 概述</h3><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200215220322641.png" style="zoom:60%;" /><p>如上图，设计一个软件用来进行加减计算。我们第一想法就是使用工具类，提供对应的加法和减法的工具方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//用于两个整数相加</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span>&#123;<br>    <span class="hljs-keyword">return</span> a + b;<br>&#125;<br><br><span class="hljs-comment">//用于两个整数相加</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b,<span class="hljs-type">int</span> c)</span>&#123;<br>    <span class="hljs-keyword">return</span> a + b + c;<br>&#125;<br><br><span class="hljs-comment">//用于n个整数相加</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(Integer ... arr)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (Integer i : arr) &#123;<br>        sum += i;<br>    &#125;<br>    <span class="hljs-keyword">return</span> sum;<br>&#125;<br></code></pre></td></tr></table></figure><p>上面的形式比较单一、有限，如果形式变化非常多，这就不符合要求，因为加法和减法运算，两个运算符与数值可以有无限种组合方式。比如 1+2+3+4+5、1+2+3-4等等。   </p><p>显然，现在需要一种翻译识别机器，能够解析由数字以及 + - 符号构成的合法的运算序列。如果把运算符和数字都看作节点的话，能够逐个节点的进行读取解析运算，这就是解释器模式的思维。</p><p><strong>定义：</strong></p><blockquote><p>给定一个语言，定义它的文法表示，并定义一个解释器，这个解释器使用该标识来解释语言中的句子。</p></blockquote><p>在解释器模式中，我们需要将待解决的问题，提取出规则，抽象为一种“语言”。比如加减法运算，规则为：由数值和+-符号组成的合法序列，“1+3-2” 就是这种语言的句子。</p><p>解释器就是要解析出来语句的含义。但是如何描述规则呢？</p><p><strong>文法（语法）规则：</strong></p><p>文法是用于描述语言的语法结构的形式规则。</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mel"><span class="hljs-keyword">expression</span> ::= value | plus | minus<br>plus ::= <span class="hljs-keyword">expression</span> ‘+’ <span class="hljs-keyword">expression</span>   <br>minus ::= <span class="hljs-keyword">expression</span> ‘-’ <span class="hljs-keyword">expression</span>  <br>value ::= integer<br></code></pre></td></tr></table></figure><blockquote><p>注意： 这里的符号“::&#x3D;”表示“定义为”的意思，竖线 | 表示或，左右的其中一个，引号内为字符本身，引号外为语法。</p></blockquote><p>上面规则描述为 ：</p><p>表达式可以是一个值，也可以是plus或者minus运算，而plus和minus又是由表达式结合运算符构成，值的类型为整型数。</p><p><strong>抽象语法树：</strong></p><p>在计算机科学中，抽象语法树（AbstractSyntaxTree，AST），或简称语法树（Syntax tree），是源代码语法结构的一种抽象表示。它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。</p><p>用树形来表示符合文法规则的句子。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200215225227616.png" style="zoom:50%;" /><h3 id="6-11-2-结构"><a href="#6-11-2-结构" class="headerlink" title="6.11.2 结构"></a>6.11.2 结构</h3><p>解释器模式包含以下主要角色。</p><ul><li><p>抽象表达式（Abstract Expression）角色：定义解释器的接口，约定解释器的解释操作，主要包含解释方法 interpret()。</p></li><li><p>终结符表达式（Terminal  Expression）角色：是抽象表达式的子类，用来实现文法中与终结符相关的操作，文法中的每一个终结符都有一个具体终结表达式与之相对应。</p></li><li><p>非终结符表达式（Nonterminal Expression）角色：也是抽象表达式的子类，用来实现文法中与非终结符相关的操作，文法中的每条规则都对应于一个非终结符表达式。</p></li><li><p>环境（Context）角色：通常包含各个解释器需要的数据或是公共的功能，一般用来传递被所有解释器共享的数据，后面的解释器可以从这里获取这些值。</p></li><li><p>客户端（Client）：主要任务是将需要分析的句子或表达式转换成使用解释器对象描述的抽象语法树，然后调用解释器的解释方法，当然也可以通过环境角色间接访问解释器的解释方法。</p></li></ul><h3 id="6-11-3-案例实现"><a href="#6-11-3-案例实现" class="headerlink" title="6.11.3 案例实现"></a>6.11.3 案例实现</h3><p>【例】设计实现加减法的软件</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A7%A3%E9%87%8A%E5%99%A8%E6%A8%A1%E5%BC%8F.png" style="zoom:80%;" /><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//抽象角色AbstractExpression</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractExpression</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">int</span> <span class="hljs-title function_">interpret</span><span class="hljs-params">(Context context)</span>;<br>&#125;<br><br><span class="hljs-comment">//终结符表达式角色</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Value</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractExpression</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> value;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Value</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> &#123;<br>        <span class="hljs-built_in">this</span>.value = value;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">interpret</span><span class="hljs-params">(Context context)</span> &#123;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(value).toString();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//非终结符表达式角色  加法表达式</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Plus</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractExpression</span> &#123;<br>    <span class="hljs-keyword">private</span> AbstractExpression left;<br>    <span class="hljs-keyword">private</span> AbstractExpression right;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Plus</span><span class="hljs-params">(AbstractExpression left, AbstractExpression right)</span> &#123;<br>        <span class="hljs-built_in">this</span>.left = left;<br>        <span class="hljs-built_in">this</span>.right = right;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">interpret</span><span class="hljs-params">(Context context)</span> &#123;<br>        <span class="hljs-keyword">return</span> left.interpret(context) + right.interpret(context);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;(&quot;</span> + left.toString() + <span class="hljs-string">&quot; + &quot;</span> + right.toString() + <span class="hljs-string">&quot;)&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">///非终结符表达式角色 减法表达式</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Minus</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractExpression</span> &#123;<br>    <span class="hljs-keyword">private</span> AbstractExpression left;<br>    <span class="hljs-keyword">private</span> AbstractExpression right;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Minus</span><span class="hljs-params">(AbstractExpression left, AbstractExpression right)</span> &#123;<br>        <span class="hljs-built_in">this</span>.left = left;<br>        <span class="hljs-built_in">this</span>.right = right;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">interpret</span><span class="hljs-params">(Context context)</span> &#123;<br>        <span class="hljs-keyword">return</span> left.interpret(context) - right.interpret(context);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;(&quot;</span> + left.toString() + <span class="hljs-string">&quot; - &quot;</span> + right.toString() + <span class="hljs-string">&quot;)&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//终结符表达式角色 变量表达式</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Variable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractExpression</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Variable</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">interpret</span><span class="hljs-params">(Context ctx)</span> &#123;<br>        <span class="hljs-keyword">return</span> ctx.getValue(<span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//环境类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span> &#123;<br>    <span class="hljs-keyword">private</span> Map&lt;Variable, Integer&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Variable, Integer&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">assign</span><span class="hljs-params">(Variable <span class="hljs-keyword">var</span>, Integer value)</span> &#123;<br>        map.put(<span class="hljs-keyword">var</span>, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getValue</span><span class="hljs-params">(Variable <span class="hljs-keyword">var</span>)</span> &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-keyword">var</span>);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//测试类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Context</span>();<br><br>        <span class="hljs-type">Variable</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Variable</span>(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">Variable</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Variable</span>(<span class="hljs-string">&quot;b&quot;</span>);<br>        <span class="hljs-type">Variable</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Variable</span>(<span class="hljs-string">&quot;c&quot;</span>);<br>        <span class="hljs-type">Variable</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Variable</span>(<span class="hljs-string">&quot;d&quot;</span>);<br>        <span class="hljs-type">Variable</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Variable</span>(<span class="hljs-string">&quot;e&quot;</span>);<br>        <span class="hljs-comment">//Value v = new Value(1);</span><br><br>        context.assign(a, <span class="hljs-number">1</span>);<br>        context.assign(b, <span class="hljs-number">2</span>);<br>        context.assign(c, <span class="hljs-number">3</span>);<br>        context.assign(d, <span class="hljs-number">4</span>);<br>        context.assign(e, <span class="hljs-number">5</span>);<br><br>        <span class="hljs-type">AbstractExpression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Minus</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Plus</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Plus</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Plus</span>(a, b), c), d), e);<br><br>        System.out.println(expression + <span class="hljs-string">&quot;= &quot;</span> + expression.interpret(context));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-11-4-优缺点"><a href="#6-11-4-优缺点" class="headerlink" title="6.11.4 优缺点"></a>6.11.4 优缺点</h3><p><strong>1，优点：</strong></p><ul><li><p>易于改变和扩展文法。</p><p>由于在解释器模式中使用类来表示语言的文法规则，因此可以通过继承等机制来改变或扩展文法。每一条文法规则都可以表示为一个类，因此可以方便地实现一个简单的语言。</p></li><li><p>实现文法较为容易。</p><p>在抽象语法树中每一个表达式节点类的实现方式都是相似的，这些类的代码编写都不会特别复杂。</p></li><li><p>增加新的解释表达式较为方便。</p><p>如果用户需要增加新的解释表达式只需要对应增加一个新的终结符表达式或非终结符表达式类，原有表达式类代码无须修改，符合 “开闭原则”。</p></li></ul><p><strong>2，缺点：</strong></p><ul><li><p>对于复杂文法难以维护。</p><p>在解释器模式中，每一条规则至少需要定义一个类，因此如果一个语言包含太多文法规则，类的个数将会急剧增加，导致系统难以管理和维护。</p></li></ul><ul><li><p>执行效率较低。</p><p>由于在解释器模式中使用了大量的循环和递归调用，因此在解释较为复杂的句子时其速度很慢，而且代码的调试过程也比较麻烦。</p></li></ul><h3 id="6-11-5-使用场景"><a href="#6-11-5-使用场景" class="headerlink" title="6.11.5 使用场景"></a>6.11.5 使用场景</h3><ul><li><p>当语言的文法较为简单，且执行效率不是关键问题时。</p></li><li><p>当问题重复出现，且可以用一种简单的语言来进行表达时。</p></li><li><p>当一个语言需要解释执行，并且语言中的句子可以表示为一个抽象语法树的时候。</p></li></ul><h1 id="7，自定义Spring框架"><a href="#7，自定义Spring框架" class="headerlink" title="7，自定义Spring框架"></a>7，自定义Spring框架</h1><h2 id="7-1-spring使用回顾"><a href="#7-1-spring使用回顾" class="headerlink" title="7.1 spring使用回顾"></a>7.1 spring使用回顾</h2><p>自定义spring框架前，先回顾一下spring框架的使用，从而分析spring的核心，并对核心功能进行模拟。</p><ul><li><p>数据访问层。定义UserDao接口及其子实现类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDao</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDao</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;userDaoImpl ....&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>业务逻辑层。定义UserService接口及其子实现类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-keyword">private</span> UserDao userDao;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserDao</span><span class="hljs-params">(UserDao userDao)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userDao = userDao;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;userServiceImpl ...&quot;</span>);<br>        userDao.add();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>定义UserController类，使用main方法模拟controller层</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//创建spring容器对象</span><br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;applicationContext.xml&quot;</span>);<br>        <span class="hljs-comment">//从IOC容器中获取UserService对象</span><br>        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> applicationContext.getBean(<span class="hljs-string">&quot;userService&quot;</span>, UserService.class);<br>        <span class="hljs-comment">//调用UserService对象的add方法</span><br>        userService.add();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>编写配置文件。在类路径下编写一个名为ApplicationContext.xml的配置文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;beans xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>       xmlns=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span><br>       xmlns:context=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span><br>       xsi:schemaLocation=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span><br><span class="hljs-string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="hljs-string">        http://www.springframework.org/schema/context</span><br><span class="hljs-string">        http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;<br><br>    &lt;bean id=<span class="hljs-string">&quot;userService&quot;</span> class=<span class="hljs-string">&quot;com.itheima.service.impl.UserServiceImpl&quot;</span>&gt;<br>        &lt;property name=<span class="hljs-string">&quot;userDao&quot;</span> ref=<span class="hljs-string">&quot;userDao&quot;</span>&gt;&lt;/property&gt;<br>    &lt;/bean&gt;<br><br>    &lt;bean id=<span class="hljs-string">&quot;userDao&quot;</span> class=<span class="hljs-string">&quot;com.itheima.dao.impl.UserDaoImpl&quot;</span>&gt;&lt;/bean&gt;<br><br>&lt;/beans&gt;<br></code></pre></td></tr></table></figure><p>代码运行结果如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200429165544151.png" style="zoom:60%;" /></li></ul><p>通过上面代码及结果可以看出：</p><ul><li>userService对象是从applicationContext容器对象获取到的，也就是userService对象交由spring进行管理。</li><li>上面结果可以看到调用了UserDao对象中的add方法，也就是说UserDao子实现类对象也交由spring管理了。</li><li>UserService中的userDao变量我们并没有进行赋值，但是可以正常使用，说明spring已经将UserDao对象赋值给了userDao变量。</li></ul><p>上面三点体现了Spring框架的IOC（Inversion of Control）和DI（Dependency Injection, DI）</p><h2 id="7-2-spring核心功能结构"><a href="#7-2-spring核心功能结构" class="headerlink" title="7.2 spring核心功能结构"></a>7.2 spring核心功能结构</h2><p>Spring大约有20个模块，由1300多个不同的文件构成。这些模块可以分为:</p><p>核心容器、AOP和设备支持、数据访问与集成、Web组件、通信报文和集成测试等，下面是 Spring 框架的总体架构图：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200429111324770.png" style="zoom:40%;" /><p>核心容器由 beans、core、context 和 expression（Spring Expression Language，SpEL）4个模块组成。</p><ul><li>spring-beans和spring-core模块是Spring框架的核心模块，包含了控制反转（Inversion of Control，IOC）和依赖注入（Dependency Injection，DI）。BeanFactory使用控制反转对应用程序的配置和依赖性规范与实际的应用程序代码进行了分离。BeanFactory属于延时加载，也就是说在实例化容器对象后并不会自动实例化Bean，只有当Bean被使用时，BeanFactory才会对该 Bean 进行实例化与依赖关系的装配。</li><li>spring-context模块构架于核心模块之上，扩展了BeanFactory，为它添加了Bean生命周期控制、框架事件体系及资源加载透明化等功能。此外，该模块还提供了许多企业级支持，如邮件访问、远程访问、任务调度等，ApplicationContext 是该模块的核心接口，它的超类是 BeanFactory。与BeanFactory不同，ApplicationContext实例化后会自动对所有的单实例Bean进行实例化与依赖关系的装配，使之处于待用状态。</li><li>spring-context-support模块是对Spring IoC容器及IoC子容器的扩展支持。</li><li>spring-context-indexer模块是Spring的类管理组件和Classpath扫描组件。</li><li>spring-expression 模块是统一表达式语言（EL）的扩展模块，可以查询、管理运行中的对象，同时也可以方便地调用对象方法，以及操作数组、集合等。它的语法类似于传统EL，但提供了额外的功能，最出色的要数函数调用和简单字符串的模板函数。EL的特性是基于Spring产品的需求而设计的，可以非常方便地同Spring IoC进行交互。</li></ul><h3 id="7-1-1-bean概述"><a href="#7-1-1-bean概述" class="headerlink" title="7.1.1 bean概述"></a>7.1.1 bean概述</h3><p>Spring 就是面向 <code>Bean</code> 的编程（BOP,Bean Oriented Programming），Bean 在 Spring 中处于核心地位。Bean对于Spring的意义就像Object对于OOP的意义一样，Spring中没有Bean也就没有Spring存在的意义。Spring IoC容器通过配置文件或者注解的方式来管理bean对象之间的依赖关系。</p><p>spring中bean用于对一个类进行封装。如下面的配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userService&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.itheima.service.impl.UserServiceImpl&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;userDao&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;userDao&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userDao&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.itheima.dao.impl.UserDaoImpl&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure><p>为什么Bean如此重要呢？</p><ul><li>spring 将bean对象交由一个叫IOC容器进行管理。</li><li>bean对象之间的依赖关系在配置文件中体现，并由spring完成。</li></ul><h2 id="7-3-Spring-IOC相关接口分析"><a href="#7-3-Spring-IOC相关接口分析" class="headerlink" title="7.3 Spring IOC相关接口分析"></a>7.3 Spring IOC相关接口分析</h2><h3 id="7-3-1-BeanFactory解析"><a href="#7-3-1-BeanFactory解析" class="headerlink" title="7.3.1 BeanFactory解析"></a>7.3.1 BeanFactory解析</h3><p>Spring中Bean的创建是典型的工厂模式，这一系列的Bean工厂，即IoC容器，为开发者管理对象之间的依赖关系提供了很多便利和基础服务，在Spring中有许多IoC容器的实现供用户选择，其相互关系如下图所示。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200429185050396.png" style="zoom:60%;" /><p>其中，BeanFactory作为最顶层的一个接口，定义了IoC容器的基本功能规范，BeanFactory有三个重要的子接口：ListableBeanFactory、HierarchicalBeanFactory和AutowireCapableBeanFactory。但是从类图中我们可以发现最终的默认实现类是DefaultListableBeanFactory，它实现了所有的接口。</p><p>那么为何要定义这么多层次的接口呢？</p><p>每个接口都有它的使用场合，主要是为了区分在Spring内部操作过程中对象的传递和转化，对对象的数据访问所做的限制。例如，</p><ul><li>ListableBeanFactory接口表示这些Bean可列表化。</li><li>HierarchicalBeanFactory表示这些Bean 是有继承关系的，也就是每个 Bean 可能有父 Bean</li><li>AutowireCapableBeanFactory 接口定义Bean的自动装配规则。</li></ul><p>这三个接口共同定义了Bean的集合、Bean之间的关系及Bean行为。最基本的IoC容器接口是BeanFactory，来看一下它的源码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanFactory</span> &#123;<br><br><span class="hljs-type">String</span> <span class="hljs-variable">FACTORY_BEAN_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&amp;&quot;</span>;<br><br><span class="hljs-comment">//根据bean的名称获取IOC容器中的的bean对象</span><br>Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> BeansException;<br><span class="hljs-comment">//根据bean的名称获取IOC容器中的的bean对象，并指定获取到的bean对象的类型，这样我们使用时就不需要进行类型强转了</span><br>&lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name, Class&lt;T&gt; requiredType)</span> <span class="hljs-keyword">throws</span> BeansException;<br>Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name, Object... args)</span> <span class="hljs-keyword">throws</span> BeansException;<br>&lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(Class&lt;T&gt; requiredType)</span> <span class="hljs-keyword">throws</span> BeansException;<br>&lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(Class&lt;T&gt; requiredType, Object... args)</span> <span class="hljs-keyword">throws</span> BeansException;<br><br>&lt;T&gt; ObjectProvider&lt;T&gt; <span class="hljs-title function_">getBeanProvider</span><span class="hljs-params">(Class&lt;T&gt; requiredType)</span>;<br>&lt;T&gt; ObjectProvider&lt;T&gt; <span class="hljs-title function_">getBeanProvider</span><span class="hljs-params">(ResolvableType requiredType)</span>;<br><br><span class="hljs-comment">//判断容器中是否包含指定名称的bean对象</span><br><span class="hljs-type">boolean</span> <span class="hljs-title function_">containsBean</span><span class="hljs-params">(String name)</span>;<br><span class="hljs-comment">//根据bean的名称判断是否是单例</span><br><span class="hljs-type">boolean</span> <span class="hljs-title function_">isSingleton</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException;<br><span class="hljs-type">boolean</span> <span class="hljs-title function_">isPrototype</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException;<br><span class="hljs-type">boolean</span> <span class="hljs-title function_">isTypeMatch</span><span class="hljs-params">(String name, ResolvableType typeToMatch)</span> <span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException;<br><span class="hljs-type">boolean</span> <span class="hljs-title function_">isTypeMatch</span><span class="hljs-params">(String name, Class&lt;?&gt; typeToMatch)</span> <span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException;<br><span class="hljs-meta">@Nullable</span><br>Class&lt;?&gt; getType(String name) <span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException;<br>String[] getAliases(String name);<br>&#125;<br></code></pre></td></tr></table></figure><p>在BeanFactory里只对IoC容器的基本行为做了定义，根本不关心你的Bean是如何定义及怎样加载的。正如我们只关心能从工厂里得到什么产品，不关心工厂是怎么生产这些产品的。</p><p>BeanFactory有一个很重要的子接口，就是ApplicationContext接口，该接口主要来规范容器中的bean对象是非延时加载，即在创建容器对象的时候就对象bean进行初始化，并存储到一个容器中。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200430220155371.png" style="zoom:60%;" /><p>要知道工厂是如何产生对象的，我们需要看具体的IoC容器实现，Spring提供了许多IoC容器实现，比如：</p><ul><li>ClasspathXmlApplicationContext : 根据类路径加载xml配置文件，并创建IOC容器对象。</li><li>FileSystemXmlApplicationContext ：根据系统路径加载xml配置文件，并创建IOC容器对象。</li><li>AnnotationConfigApplicationContext ：加载注解类配置，并创建IOC容器。</li></ul><h3 id="7-3-2-BeanDefinition解析"><a href="#7-3-2-BeanDefinition解析" class="headerlink" title="7.3.2 BeanDefinition解析"></a>7.3.2 BeanDefinition解析</h3><p>Spring IoC容器管理我们定义的各种Bean对象及其相互关系，而Bean对象在Spring实现中是以BeanDefinition来描述的，如下面配置文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userDao&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.itheima.dao.impl.UserDaoImpl&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>bean标签还有很多属性：<br>scope、init-method、destory-method等。<br></code></pre></td></tr></table></figure><p>其继承体系如下图所示。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200429204239868.png" style="zoom:60%;" /><h3 id="7-3-3-BeanDefinitionReader解析"><a href="#7-3-3-BeanDefinitionReader解析" class="headerlink" title="7.3.3 BeanDefinitionReader解析"></a>7.3.3 BeanDefinitionReader解析</h3><p>Bean的解析过程非常复杂，功能被分得很细，因为这里需要被扩展的地方很多，必须保证足够的灵活性，以应对可能的变化。Bean的解析主要就是对Spring配置文件的解析。这个解析过程主要通过BeanDefinitionReader来完成，看看Spring中BeanDefinitionReader的类结构图，如下图所示。</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200429204700956.png" style="zoom:60%;" /><p>看看BeanDefinitionReader接口定义的功能来理解它具体的作用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanDefinitionReader</span> &#123;<br><br><span class="hljs-comment">//获取BeanDefinitionRegistry注册器对象</span><br>BeanDefinitionRegistry <span class="hljs-title function_">getRegistry</span><span class="hljs-params">()</span>;<br><br><span class="hljs-meta">@Nullable</span><br>ResourceLoader <span class="hljs-title function_">getResourceLoader</span><span class="hljs-params">()</span>;<br><br><span class="hljs-meta">@Nullable</span><br>ClassLoader <span class="hljs-title function_">getBeanClassLoader</span><span class="hljs-params">()</span>;<br><br>BeanNameGenerator <span class="hljs-title function_">getBeanNameGenerator</span><span class="hljs-params">()</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">下面的loadBeanDefinitions都是加载bean定义，从指定的资源中</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(Resource resource)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException;<br><span class="hljs-type">int</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(Resource... resources)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException;<br><span class="hljs-type">int</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(String location)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException;<br><span class="hljs-type">int</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(String... locations)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="7-3-4-BeanDefinitionRegistry解析"><a href="#7-3-4-BeanDefinitionRegistry解析" class="headerlink" title="7.3.4 BeanDefinitionRegistry解析"></a>7.3.4 BeanDefinitionRegistry解析</h3><p>BeanDefinitionReader用来解析bean定义，并封装BeanDefinition对象，而我们定义的配置文件中定义了很多bean标签，所以就有一个问题，解析的BeanDefinition对象存储到哪儿？答案就是BeanDefinition的注册中心，而该注册中心顶层接口就是BeanDefinitionRegistry。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanDefinitionRegistry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AliasRegistry</span> &#123;<br><br><span class="hljs-comment">//往注册表中注册bean</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinition</span><span class="hljs-params">(String beanName, BeanDefinition beanDefinition)</span><br><span class="hljs-keyword">throws</span> BeanDefinitionStoreException;<br><br><span class="hljs-comment">//从注册表中删除指定名称的bean</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">removeBeanDefinition</span><span class="hljs-params">(String beanName)</span> <span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException;<br><br><span class="hljs-comment">//获取注册表中指定名称的bean</span><br>BeanDefinition <span class="hljs-title function_">getBeanDefinition</span><span class="hljs-params">(String beanName)</span> <span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException;<br>    <br><span class="hljs-comment">//判断注册表中是否已经注册了指定名称的bean</span><br><span class="hljs-type">boolean</span> <span class="hljs-title function_">containsBeanDefinition</span><span class="hljs-params">(String beanName)</span>;<br>    <br><span class="hljs-comment">//获取注册表中所有的bean的名称</span><br>String[] getBeanDefinitionNames();<br>    <br><span class="hljs-type">int</span> <span class="hljs-title function_">getBeanDefinitionCount</span><span class="hljs-params">()</span>;<br><span class="hljs-type">boolean</span> <span class="hljs-title function_">isBeanNameInUse</span><span class="hljs-params">(String beanName)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>继承结构图如下：</p><img src="23%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/image-20200429211132185.png" style="zoom:60%;" /><p>从上面类图可以看到BeanDefinitionRegistry接口的子实现类主要有以下几个：</p><ul><li><p>DefaultListableBeanFactory</p><p>在该类中定义了如下代码，就是用来注册bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">256</span>);<br></code></pre></td></tr></table></figure></li><li><p>SimpleBeanDefinitionRegistry</p><p>在该类中定义了如下代码，就是用来注册bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">64</span>);<br></code></pre></td></tr></table></figure></li></ul><h3 id="7-3-5-创建容器"><a href="#7-3-5-创建容器" class="headerlink" title="7.3.5 创建容器"></a>7.3.5 创建容器</h3><p>ClassPathXmlApplicationContext对Bean配置资源的载入是从refresh（）方法开始的。refresh（）方法是一个模板方法，规定了 IoC 容器的启动流程，有些逻辑要交给其子类实现。它对 Bean 配置资源进行载入，ClassPathXmlApplicationContext通过调用其父类AbstractApplicationContext的refresh（）方法启动整个IoC容器对Bean定义的载入过程。</p><h2 id="7-4-自定义SpringIOC"><a href="#7-4-自定义SpringIOC" class="headerlink" title="7.4 自定义SpringIOC"></a>7.4 自定义SpringIOC</h2><p>现要对下面的配置文件进行解析，并自定义Spring框架的IOC对涉及到的对象进行管理。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userService&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.itheima.service.impl.UserServiceImpl&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;userDao&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;userDao&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userDao&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.itheima.dao.impl.UserDaoImpl&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="7-4-1-定义bean相关的pojo类"><a href="#7-4-1-定义bean相关的pojo类" class="headerlink" title="7.4.1 定义bean相关的pojo类"></a>7.4.1 定义bean相关的pojo类</h3><h4 id="7-4-1-1-PropertyValue类"><a href="#7-4-1-1-PropertyValue类" class="headerlink" title="7.4.1.1 PropertyValue类"></a>7.4.1.1 PropertyValue类</h4><p>用于封装bean的属性，体现到上面的配置文件就是封装bean标签的子标签property标签数据。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PropertyValue</span> &#123;<br><br>  <span class="hljs-keyword">private</span> String name;<br>  <span class="hljs-keyword">private</span> String ref;<br>  <span class="hljs-keyword">private</span> String value;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">PropertyValue</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">PropertyValue</span><span class="hljs-params">(String name, String ref,String value)</span> &#123;<br>    <span class="hljs-built_in">this</span>.name = name;<br>    <span class="hljs-built_in">this</span>.ref = ref;<br>    <span class="hljs-built_in">this</span>.value = value;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> name;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-built_in">this</span>.name = name;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getRef</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> ref;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRef</span><span class="hljs-params">(String ref)</span> &#123;<br>    <span class="hljs-built_in">this</span>.ref = ref;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> value;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(String value)</span> &#123;<br>    <span class="hljs-built_in">this</span>.value = value;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="7-4-1-2-MutablePropertyValues类"><a href="#7-4-1-2-MutablePropertyValues类" class="headerlink" title="7.4.1.2 MutablePropertyValues类"></a>7.4.1.2 MutablePropertyValues类</h4><p>一个bean标签可以有多个property子标签，所以再定义一个MutablePropertyValues类，用来存储并管理多个PropertyValue对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MutablePropertyValues</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Iterable</span>&lt;PropertyValue&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;PropertyValue&gt; propertyValueList;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MutablePropertyValues</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.propertyValueList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;PropertyValue&gt;();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MutablePropertyValues</span><span class="hljs-params">(List&lt;PropertyValue&gt; propertyValueList)</span> &#123;<br>        <span class="hljs-built_in">this</span>.propertyValueList = (propertyValueList != <span class="hljs-literal">null</span> ? propertyValueList : <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;PropertyValue&gt;());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> PropertyValue[] getPropertyValues() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.propertyValueList.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyValue</span>[<span class="hljs-number">0</span>]);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> PropertyValue <span class="hljs-title function_">getPropertyValue</span><span class="hljs-params">(String propertyName)</span> &#123;<br>        <span class="hljs-keyword">for</span> (PropertyValue pv : <span class="hljs-built_in">this</span>.propertyValueList) &#123;<br>            <span class="hljs-keyword">if</span> (pv.getName().equals(propertyName)) &#123;<br>                <span class="hljs-keyword">return</span> pv;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Iterator&lt;PropertyValue&gt; <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> propertyValueList.iterator();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmpty</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.propertyValueList.isEmpty();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> MutablePropertyValues <span class="hljs-title function_">addPropertyValue</span><span class="hljs-params">(PropertyValue pv)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.propertyValueList.size(); i++) &#123;<br>            <span class="hljs-type">PropertyValue</span> <span class="hljs-variable">currentPv</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.propertyValueList.get(i);<br>            <span class="hljs-keyword">if</span> (currentPv.getName().equals(pv.getName())) &#123;<br>                <span class="hljs-built_in">this</span>.propertyValueList.set(i, <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyValue</span>(pv.getName(),pv.getRef(), pv.getValue()));<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-built_in">this</span>.propertyValueList.add(pv);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(String propertyName)</span> &#123;<br>        <span class="hljs-keyword">return</span> getPropertyValue(propertyName) != <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="7-4-1-3-BeanDefinition类"><a href="#7-4-1-3-BeanDefinition类" class="headerlink" title="7.4.1.3 BeanDefinition类"></a>7.4.1.3 BeanDefinition类</h4><p>BeanDefinition类用来封装bean信息的，主要包含id（即bean对象的名称）、class（需要交由spring管理的类的全类名）及子标签property数据。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanDefinition</span> &#123;<br>    <span class="hljs-keyword">private</span> String id;<br>    <span class="hljs-keyword">private</span> String className;<br><br>    <span class="hljs-keyword">private</span> MutablePropertyValues propertyValues;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BeanDefinition</span><span class="hljs-params">()</span> &#123;<br>        propertyValues = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutablePropertyValues</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(String id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getClassName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> className;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setClassName</span><span class="hljs-params">(String className)</span> &#123;<br>        <span class="hljs-built_in">this</span>.className = className;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPropertyValues</span><span class="hljs-params">(MutablePropertyValues propertyValues)</span> &#123;<br>        <span class="hljs-built_in">this</span>.propertyValues = propertyValues;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> MutablePropertyValues <span class="hljs-title function_">getPropertyValues</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> propertyValues;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="7-4-2-定义注册表相关类"><a href="#7-4-2-定义注册表相关类" class="headerlink" title="7.4.2 定义注册表相关类"></a>7.4.2 定义注册表相关类</h3><h4 id="7-4-2-1-BeanDefinitionRegistry接口"><a href="#7-4-2-1-BeanDefinitionRegistry接口" class="headerlink" title="7.4.2.1 BeanDefinitionRegistry接口"></a>7.4.2.1 BeanDefinitionRegistry接口</h4><p>BeanDefinitionRegistry接口定义了注册表的相关操作，定义如下功能：</p><ul><li>注册BeanDefinition对象到注册表中</li><li>从注册表中删除指定名称的BeanDefinition对象</li><li>根据名称从注册表中获取BeanDefinition对象</li><li>判断注册表中是否包含指定名称的BeanDefinition对象</li><li>获取注册表中BeanDefinition对象的个数</li><li>获取注册表中所有的BeanDefinition的名称</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanDefinitionRegistry</span> &#123;<br><br>    <span class="hljs-comment">//注册BeanDefinition对象到注册表中</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinition</span><span class="hljs-params">(String beanName, BeanDefinition beanDefinition)</span>;<br><br>    <span class="hljs-comment">//从注册表中删除指定名称的BeanDefinition对象</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeBeanDefinition</span><span class="hljs-params">(String beanName)</span> <span class="hljs-keyword">throws</span> Exception;<br><br>    <span class="hljs-comment">//根据名称从注册表中获取BeanDefinition对象</span><br>    BeanDefinition <span class="hljs-title function_">getBeanDefinition</span><span class="hljs-params">(String beanName)</span> <span class="hljs-keyword">throws</span> Exception;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsBeanDefinition</span><span class="hljs-params">(String beanName)</span>;<br><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">getBeanDefinitionCount</span><span class="hljs-params">()</span>;<br><br>    String[] getBeanDefinitionNames();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="7-4-2-2-SimpleBeanDefinitionRegistry类"><a href="#7-4-2-2-SimpleBeanDefinitionRegistry类" class="headerlink" title="7.4.2.2 SimpleBeanDefinitionRegistry类"></a>7.4.2.2 SimpleBeanDefinitionRegistry类</h4><p>该类实现了BeanDefinitionRegistry接口，定义了Map集合作为注册表容器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleBeanDefinitionRegistry</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanDefinitionRegistry</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, BeanDefinition&gt;();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinition</span><span class="hljs-params">(String beanName, BeanDefinition beanDefinition)</span> &#123;<br>        beanDefinitionMap.put(beanName,beanDefinition);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeBeanDefinition</span><span class="hljs-params">(String beanName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        beanDefinitionMap.remove(beanName);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> BeanDefinition <span class="hljs-title function_">getBeanDefinition</span><span class="hljs-params">(String beanName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> beanDefinitionMap.get(beanName);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsBeanDefinition</span><span class="hljs-params">(String beanName)</span> &#123;<br>        <span class="hljs-keyword">return</span> beanDefinitionMap.containsKey(beanName);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getBeanDefinitionCount</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> beanDefinitionMap.size();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String[] getBeanDefinitionNames() &#123;<br>        <span class="hljs-keyword">return</span> beanDefinitionMap.keySet().toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">1</span>]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="7-4-3-定义解析器相关类"><a href="#7-4-3-定义解析器相关类" class="headerlink" title="7.4.3 定义解析器相关类"></a>7.4.3 定义解析器相关类</h3><h4 id="7-4-3-1-BeanDefinitionReader接口"><a href="#7-4-3-1-BeanDefinitionReader接口" class="headerlink" title="7.4.3.1 BeanDefinitionReader接口"></a>7.4.3.1 BeanDefinitionReader接口</h4><p>BeanDefinitionReader是用来解析配置文件并在注册表中注册bean的信息。定义了两个规范：</p><ul><li>获取注册表的功能，让外界可以通过该对象获取注册表对象。</li><li>加载配置文件，并注册bean数据。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanDefinitionReader</span> &#123;<br><br><span class="hljs-comment">//获取注册表对象</span><br>    BeanDefinitionRegistry <span class="hljs-title function_">getRegistry</span><span class="hljs-params">()</span>;<br><span class="hljs-comment">//加载配置文件并在注册表中进行注册</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(String configLocation)</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="7-4-3-2-XmlBeanDefinitionReader类"><a href="#7-4-3-2-XmlBeanDefinitionReader类" class="headerlink" title="7.4.3.2 XmlBeanDefinitionReader类"></a>7.4.3.2 XmlBeanDefinitionReader类</h4><p>XmlBeanDefinitionReader类是专门用来解析xml配置文件的。该类实现BeanDefinitionReader接口并实现接口中的两个功能。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XmlBeanDefinitionReader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanDefinitionReader</span> &#123;<br><br>    <span class="hljs-keyword">private</span> BeanDefinitionRegistry registry;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">XmlBeanDefinitionReader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.registry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleBeanDefinitionRegistry</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> BeanDefinitionRegistry <span class="hljs-title function_">getRegistry</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> registry;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(String configLocation)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClass().getClassLoader().getResourceAsStream(configLocation);<br>        <span class="hljs-type">SAXReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SAXReader</span>();<br>        <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> reader.read(is);<br>        <span class="hljs-type">Element</span> <span class="hljs-variable">rootElement</span> <span class="hljs-operator">=</span> document.getRootElement();<br>        <span class="hljs-comment">//解析bean标签</span><br>        parseBean(rootElement);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseBean</span><span class="hljs-params">(Element rootElement)</span> &#123;<br><br>        List&lt;Element&gt; elements = rootElement.elements();<br>        <span class="hljs-keyword">for</span> (Element element : elements) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> element.attributeValue(<span class="hljs-string">&quot;id&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> element.attributeValue(<span class="hljs-string">&quot;class&quot;</span>);<br>            <span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinition</span>();<br>            beanDefinition.setId(id);<br>            beanDefinition.setClassName(className);<br>            List&lt;Element&gt; list = element.elements(<span class="hljs-string">&quot;property&quot;</span>);<br>            <span class="hljs-type">MutablePropertyValues</span> <span class="hljs-variable">mutablePropertyValues</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutablePropertyValues</span>();<br>            <span class="hljs-keyword">for</span> (Element element1 : list) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> element1.attributeValue(<span class="hljs-string">&quot;name&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> element1.attributeValue(<span class="hljs-string">&quot;ref&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> element1.attributeValue(<span class="hljs-string">&quot;value&quot;</span>);<br>                <span class="hljs-type">PropertyValue</span> <span class="hljs-variable">propertyValue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyValue</span>(name,ref,value);<br>                mutablePropertyValues.addPropertyValue(propertyValue);<br>            &#125;<br>            beanDefinition.setPropertyValues(mutablePropertyValues);<br><br>            registry.registerBeanDefinition(id,beanDefinition);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="7-4-4-IOC容器相关类"><a href="#7-4-4-IOC容器相关类" class="headerlink" title="7.4.4 IOC容器相关类"></a>7.4.4 IOC容器相关类</h3><h4 id="7-4-4-1-BeanFactory接口"><a href="#7-4-4-1-BeanFactory接口" class="headerlink" title="7.4.4.1 BeanFactory接口"></a>7.4.4.1 BeanFactory接口</h4><p>在该接口中定义IOC容器的统一规范即获取bean对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanFactory</span> &#123;<br><span class="hljs-comment">//根据bean对象的名称获取bean对象</span><br>    Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> Exception;<br><span class="hljs-comment">//根据bean对象的名称获取bean对象，并进行类型转换</span><br>    &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name, Class&lt;? extends T&gt; clazz)</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="7-4-4-2-ApplicationContext接口"><a href="#7-4-4-2-ApplicationContext接口" class="headerlink" title="7.4.4.2 ApplicationContext接口"></a>7.4.4.2 ApplicationContext接口</h4><p>该接口的所以的子实现类对bean对象的创建都是非延时的，所以在该接口中定义 <code>refresh()</code> 方法，该方法主要完成以下两个功能：</p><ul><li>加载配置文件。</li><li>根据注册表中的BeanDefinition对象封装的数据进行bean对象的创建。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BeanFactory</span> &#123;<br><span class="hljs-comment">//进行配置文件加载并进行对象创建</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IllegalStateException, Exception;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="7-4-4-3-AbstractApplicationContext类"><a href="#7-4-4-3-AbstractApplicationContext类" class="headerlink" title="7.4.4.3 AbstractApplicationContext类"></a>7.4.4.3 AbstractApplicationContext类</h4><ul><li><p>作为ApplicationContext接口的子类，所以该类也是非延时加载，所以需要在该类中定义一个Map集合，作为bean对象存储的容器。</p></li><li><p>声明BeanDefinitionReader类型的变量，用来进行xml配置文件的解析，符合单一职责原则。</p><p>BeanDefinitionReader类型的对象创建交由子类实现，因为只有子类明确到底创建BeanDefinitionReader哪儿个子实现类对象。</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractApplicationContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContext</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> BeanDefinitionReader beanDefinitionReader;<br>    <span class="hljs-comment">//用来存储bean对象的容器   key存储的是bean的id值，value存储的是bean对象</span><br>    <span class="hljs-keyword">protected</span> Map&lt;String, Object&gt; singletonObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br><br>    <span class="hljs-comment">//存储配置文件的路径</span><br>    <span class="hljs-keyword">protected</span> String configLocation;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IllegalStateException, Exception &#123;<br><br>        <span class="hljs-comment">//加载BeanDefinition</span><br>        beanDefinitionReader.loadBeanDefinitions(configLocation);<br><br>        <span class="hljs-comment">//初始化bean</span><br>        finishBeanInitialization();<br>    &#125;<br><br>    <span class="hljs-comment">//bean的初始化</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finishBeanInitialization</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">BeanDefinitionRegistry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> beanDefinitionReader.getRegistry();<br>        String[] beanNames = registry.getBeanDefinitionNames();<br><br>        <span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;<br>            <span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> registry.getBeanDefinition(beanName);<br>            getBean(beanName);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>注意：该类finishBeanInitialization()方法中调用getBean()方法使用到了模板方法模式。</p></blockquote><h4 id="7-4-4-4-ClassPathXmlApplicationContext类"><a href="#7-4-4-4-ClassPathXmlApplicationContext类" class="headerlink" title="7.4.4.4 ClassPathXmlApplicationContext类"></a>7.4.4.4 ClassPathXmlApplicationContext类</h4><p>该类主要是加载类路径下的配置文件，并进行bean对象的创建，主要完成以下功能：</p><ul><li>在构造方法中，创建BeanDefinitionReader对象。</li><li>在构造方法中，调用refresh()方法，用于进行配置文件加载、创建bean对象并存储到容器中。</li><li>重写父接口中的getBean()方法，并实现依赖注入操作。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractApplicationContext</span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ClassPathXmlApplicationContext</span><span class="hljs-params">(String configLocation)</span> &#123;<br>        <span class="hljs-built_in">this</span>.configLocation = configLocation;<br>        <span class="hljs-comment">//构建XmlBeanDefinitionReader对象</span><br>        beanDefinitionReader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XmlBeanDefinitionReader</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.refresh();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//根据bean的id属性值获取bean对象</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//return singletonObjects.get(name);</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> singletonObjects.get(name);<br>        <span class="hljs-keyword">if</span>(obj != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> obj;<br>        &#125;<br><br>        <span class="hljs-type">BeanDefinitionRegistry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> beanDefinitionReader.getRegistry();<br>        <span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> registry.getBeanDefinition(name);<br>        <span class="hljs-keyword">if</span>(beanDefinition == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> beanDefinition.getClassName();<br>        Class&lt;?&gt; clazz = Class.forName(className);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">beanObj</span> <span class="hljs-operator">=</span> clazz.newInstance();<br>        <span class="hljs-type">MutablePropertyValues</span> <span class="hljs-variable">propertyValues</span> <span class="hljs-operator">=</span> beanDefinition.getPropertyValues();<br>        <span class="hljs-keyword">for</span> (PropertyValue propertyValue : propertyValues) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">propertyName</span> <span class="hljs-operator">=</span> propertyValue.getName();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> propertyValue.getValue();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> propertyValue.getRef();<br>            <span class="hljs-keyword">if</span>(ref != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-string">&quot;&quot;</span>.equals(ref)) &#123;<br><br>                <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> getBean(ref);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> StringUtils.getSetterMethodNameByFieldName(propertyName);<br>                Method[] methods = clazz.getMethods();<br>                <span class="hljs-keyword">for</span> (Method method : methods) &#123;<br>                    <span class="hljs-keyword">if</span>(method.getName().equals(methodName)) &#123;<br>                        method.invoke(beanObj,bean);<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span>(value != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-string">&quot;&quot;</span>.equals(value)) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> StringUtils.getSetterMethodNameByFieldName(propertyName);<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> clazz.getMethod(methodName, String.class);<br>                method.invoke(beanObj,value);<br>            &#125;<br>        &#125;<br>        singletonObjects.put(name,beanObj);<br>        <span class="hljs-keyword">return</span> beanObj;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name, Class&lt;? extends T&gt; clazz)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> getBean(name);<br>        <span class="hljs-keyword">if</span>(bean != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> clazz.cast(bean);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="7-4-5-自定义Spring-IOC总结"><a href="#7-4-5-自定义Spring-IOC总结" class="headerlink" title="7.4.5 自定义Spring IOC总结"></a>7.4.5 自定义Spring IOC总结</h3><h4 id="7-4-5-1-使用到的设计模式"><a href="#7-4-5-1-使用到的设计模式" class="headerlink" title="7.4.5.1 使用到的设计模式"></a>7.4.5.1 使用到的设计模式</h4><ul><li>工厂模式。这个使用工厂模式 + 配置文件的方式。</li><li>单例模式。Spring IOC管理的bean对象都是单例的，此处的单例不是通过构造器进行单例的控制的，而是spring框架对每一个bean只创建了一个对象。</li><li>模板方法模式。AbstractApplicationContext类中的finishBeanInitialization()方法调用了子类的getBean()方法，因为getBean()的实现和环境息息相关。</li><li>迭代器模式。对于MutablePropertyValues类定义使用到了迭代器模式，因为此类存储并管理PropertyValue对象，也属于一个容器，所以给该容器提供一个遍历方式。</li></ul><p>spring框架其实使用到了很多设计模式，如AOP使用到了代理模式，选择JDK代理或者CGLIB代理使用到了策略模式，还有适配器模式，装饰者模式，观察者模式等。</p><h4 id="7-4-5-2-符合大部分设计原则"><a href="#7-4-5-2-符合大部分设计原则" class="headerlink" title="7.4.5.2 符合大部分设计原则"></a>7.4.5.2 符合大部分设计原则</h4><h4 id="7-4-5-3-整个设计和Spring的设计还是有一定的出入"><a href="#7-4-5-3-整个设计和Spring的设计还是有一定的出入" class="headerlink" title="7.4.5.3 整个设计和Spring的设计还是有一定的出入"></a>7.4.5.3 整个设计和Spring的设计还是有一定的出入</h4><p>spring框架底层是很复杂的，进行了很深入的封装，并对外提供了很好的扩展性。而我们自定义SpringIOC有以下几个目的：</p><ul><li>了解Spring底层对对象的大体管理机制。</li><li>了解设计模式在具体的开发中的使用。</li><li>以后学习spring源码，通过该案例的实现，可以降低spring学习的入门成本。</li></ul><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Design pattern</tag>
      
      <tag>23种设计模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis</title>
    <link href="/2022/10/29/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/"/>
    <url>/2022/10/29/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/</url>
    
    <content type="html"><![CDATA[<h1 id="redis安装部署与启动"><a href="#redis安装部署与启动" class="headerlink" title="redis安装部署与启动"></a>redis安装部署与启动</h1><p><a href="https://www.runoob.com/redis/redis-install.html">https://www.runoob.com/redis/redis-install.html</a></p><h1 id="redis的简单调用"><a href="#redis的简单调用" class="headerlink" title="redis的简单调用"></a>redis的简单调用</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.springboot_redis;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.HashOperations;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.ValueOperations;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringbootRedisApplicationTests</span> &#123;<br><br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setKV</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ValueOperations</span> <span class="hljs-variable">valueOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue();<br>        valueOperations.set(<span class="hljs-string">&quot;姓名&quot;</span>,<span class="hljs-string">&quot;Kblayt&quot;</span>,<span class="hljs-number">1</span>, TimeUnit.SECONDS);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getKV</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ValueOperations</span> <span class="hljs-variable">valueOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) valueOperations.get(<span class="hljs-string">&quot;姓名&quot;</span>);<br>        System.out.println(name);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setKMap</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ValueOperations</span> <span class="hljs-variable">valueOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue();<br>        <span class="hljs-type">HashOperations</span> <span class="hljs-variable">hashOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForHash();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;姓名&quot;</span>,<span class="hljs-string">&quot;Kblayt&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;性别&quot;</span>,<span class="hljs-string">&quot;男&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;年龄&quot;</span>,<span class="hljs-string">&quot;19&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">JsonMap</span> <span class="hljs-operator">=</span> JSON.toJSONString(map);<br>        hashOperations.putAll(<span class="hljs-string">&quot;参与人员1&quot;</span>,map);<br>        valueOperations.set(<span class="hljs-string">&quot;参与人员2&quot;</span>,JsonMap);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getKMap1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">HashOperations</span> <span class="hljs-variable">hashOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForHash();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> hashOperations.entries(<span class="hljs-string">&quot;参与人员1&quot;</span>);<br>        System.out.println(msg);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getKMap2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ValueOperations</span> <span class="hljs-variable">valueOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> valueOperations.get(<span class="hljs-string">&quot;参与人员2&quot;</span>);<br>        System.out.println(msg.toString());<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>redis传输乱码配置</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">package com.takeaway.merchantsprovider.config;<br><br><br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.<span class="hljs-keyword">Configuration</span>;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.<span class="hljs-keyword">connection</span>.RedisConnectionFactory;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;<br><br><span class="hljs-keyword">import</span> java.net.UnknownHostException;<br><br>@<span class="hljs-keyword">Configuration</span><br><span class="hljs-built_in">public</span> <span class="hljs-keyword">class</span> RedisConfig &#123;<br>    @Bean<br>    @ConditionalOnMissingBean(<span class="hljs-type">name</span> = &quot;redisTemplate&quot;)<br>    <span class="hljs-built_in">public</span> RedisTemplate&lt;<span class="hljs-keyword">Object</span>, <span class="hljs-keyword">Object</span>&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory)<br>            throws UnknownHostException &#123;<br><br>        RedisTemplate&lt;<span class="hljs-keyword">Object</span>, <span class="hljs-keyword">Object</span>&gt; template = <span class="hljs-built_in">new</span> RedisTemplate&lt;&gt;();<br>        <span class="hljs-keyword">template</span>.setConnectionFactory(redisConnectionFactory);<br>        StringRedisSerializer stringRedisSerializer = <span class="hljs-built_in">new</span> StringRedisSerializer();<br>        <span class="hljs-keyword">template</span>.setKeySerializer(stringRedisSerializer);<br>        <span class="hljs-keyword">template</span>.setValueSerializer(stringRedisSerializer);<br>        <span class="hljs-keyword">template</span>.afterPropertiesSet();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">template</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>中间件</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nginx</title>
    <link href="/2022/10/29/%E4%B8%AD%E9%97%B4%E4%BB%B6/nginx/"/>
    <url>/2022/10/29/%E4%B8%AD%E9%97%B4%E4%BB%B6/nginx/</url>
    
    <content type="html"><![CDATA[<div class="row">    <embed src="Nginx_day01.pdf" width="100%" height="550" type="application/pdf"></div><div class="row">    <embed src="Nginx_day02.pdf" width="100%" height="550" type="application/pdf"></div><div class="row">    <embed src="Nginx_day03.pdf" width="100%" height="550" type="application/pdf"></div><div class="row">    <embed src="Nginx_day04.pdf" width="100%" height="550" type="application/pdf"></div><div class="row">    <embed src="Nginx_day05.pdf" width="100%" height="550" type="application/pdf"></div><p><a href="C:/Users/Kblayt/Desktop/youdaonote/youdaonote-pull/youdaonote/youdaonote-attachments/WEBRESOURCEc6d2252a79f1a3de703585df478bbf8bNginx.xmind">Nginx.xmind</a></p><h2 id="负载均衡有四种方式"><a href="#负载均衡有四种方式" class="headerlink" title="负载均衡有四种方式"></a>负载均衡有四种方式</h2><ul><li><p>轮询（默认）</p></li><li><p>权重轮询（weight）</p></li><li><p>ip_hash（让某一客户机在相当长的一段时间内只访问固定的后端的某台真实的web服务器）</p></li><li><p>least_conn（请求将被传递给当前拥有最少活跃连接的server，同时考虑权重weight的因素）</p></li></ul><h2 id="配置在niginx-conf中"><a href="#配置在niginx-conf中" class="headerlink" title="配置在niginx.conf中"></a>配置在niginx.conf中</h2><p>①http节点下面配置</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros">upstream serverPools &#123;<br>#ip_hash;<br>#least_conn;<br><span class="hljs-built_in">server </span>localhost:8080 backup;<br><span class="hljs-built_in">server </span>localhost:8081 <span class="hljs-attribute">weight</span>=1;<br><span class="hljs-built_in">server </span>localhost:8082 <span class="hljs-attribute">weight</span>=2;<br><span class="hljs-built_in">server </span>localhost:8083 <span class="hljs-attribute">weight</span>=3;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>②server节点下配置</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">location <span class="hljs-regexp">/mystation/</span> &#123;<br>        proxy_pass  http:<span class="hljs-regexp">//</span>serverPools/;<br><span class="hljs-comment">#proxy_set_header Host $host;</span><br>    &#125;<br><br></code></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>中间件</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>微服务框架(二)</title>
    <link href="/2022/10/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/"/>
    <url>/2022/10/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/</url>
    
    <content type="html"><![CDATA[<h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a><strong>Docker</strong></h1><h2 id="Docker-1"><a href="#Docker-1" class="headerlink" title="Docker"></a><strong>Docker</strong></h2><p>项目部署问题</p><p>Docker如何解决大型项目依赖关系复杂，不同组件依赖的兼容性问题？</p><ul><li>Docker允许开发中将应用、依赖、函数库、配置一起<strong>打包</strong>，形成可移植镜像</li><li>Docker应用运行在容器中，使用沙箱机制，相互<strong>隔离</strong></li></ul><p>Docker如何解决开发、测试、生产环境有差异的问题</p><ul><li>Docker镜像中包含完整运行环境，包括系统函数库，仅依赖系统的Linux内核，因此可以在任意Linux操作系统上运行</li></ul><table><thead><tr><th>ZooKeeper</th><th>Dubbo</th><th>ActiveMQ</th><th>Redis</th><th>MySQL</th></tr></thead><tbody><tr><td><strong>Portainer</strong></td><td><strong>ElasticSearch</strong></td><td><strong>Kibana</strong></td><td><strong>Logstash</strong></td><td></td></tr></tbody></table><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101053397.png" alt="image-20221103101053397"></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>Docker是一个快速交付应用、运行应用的技术：</p><p>1.可以将程序及其依赖、运行环境一起打包为一个镜像，可以迁移到任意Linux操作系统</p><p>2.运行时利用沙箱机制形成隔离容器，各个应用互不干扰</p><p>3.启动、移除都可以通过一行命令完成，方便快捷</p><h2 id="Docker与虚拟机"><a href="#Docker与虚拟机" class="headerlink" title="Docker与虚拟机"></a><strong>Docker与虚拟机</strong></h2><p>虚拟机（virtual machine）是在操作系统中模拟硬件设备，然后运行另一个操作系统，比如在 Windows系统里面运行 Ubuntu 系统，这样就可以运行任意的Ubuntu应用了。<img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101114303.png" alt="image-20221103101114303"></p><h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>Docker和虚拟机的差异：</p><p>•docker是一个系统进程；虚拟机是在操作系统中的操作系统</p><p>•docker体积小、启动速度快、性能好；虚拟机体积大、启动速度慢、性能一般</p><h2 id="Docker架构"><a href="#Docker架构" class="headerlink" title="Docker架构"></a><strong>Docker架构</strong></h2><h3 id="容器和镜像"><a href="#容器和镜像" class="headerlink" title="容器和镜像"></a><strong>容器和镜像</strong></h3><p><strong>镜像（Image）</strong>：Docker将应用程序及其所需的依赖、函数库、环境、配置等文件打包在一起，称为镜像。</p><p><strong>容器（Container）</strong>：镜像中的应用程序运行后形成的进程就是<strong>容器</strong>，只是Docker会给容器做隔离，对外不可见。</p><h3 id="Docker和DockerHub"><a href="#Docker和DockerHub" class="headerlink" title="Docker和DockerHub"></a><strong>Docker和DockerHub</strong></h3><p>DockerHub：<a href="https://hub.docker.com/">DockerHub</a>是一个Docker镜像的托管平台。这样的平台称为Docker Registry。国内也有类似于DockerHub的公开服务，比如<a href="https://c.163yun.com/hub">网易云镜像服务</a>、<a href="https://cr.console.aliyun.com/">阿里云镜像库</a>等。</p><h3 id="docker架构"><a href="#docker架构" class="headerlink" title="docker架构"></a><strong>docker架构</strong></h3><p>Docker是一个CS架构的程序，由两部分组成：</p><ul><li>服务端(server)：Docker守护进程，负责处理Docker指令，管理镜像、容器等</li><li>客户端(client)：通过命令或RestAPI向Docker服务端发送指令。可以在本地或远程向服务端发送指令</li></ul><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101310555.png" alt="image-20221103101310555"></p><h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>镜像：</p><ul><li>将应用程序及其依赖、环境、配置打包在一起</li></ul><p>容器：</p><ul><li>镜像运行起来就是容器，一个镜像可以运行多个容器</li></ul><p>Docker结构：</p><ul><li>服务端：接收命令或远程请求，操作镜像或容器</li><li>客户端：发送命令或者请求到Docker服务端</li></ul><p>DockerHub：</p><ul><li>一个镜像托管的服务器，类似的还有阿里云镜像服务，统称为DockerRegistry</li></ul><h2 id="安装Docker（参考centos7安装docker）"><a href="#安装Docker（参考centos7安装docker）" class="headerlink" title="安装Docker（参考centos7安装docker）"></a><strong>安装Docker</strong>（参考centos7安装docker）</h2><h2 id="Docker基本操作"><a href="#Docker基本操作" class="headerlink" title="Docker基本操作"></a><strong>Docker基本操作</strong></h2><h3 id="镜像操作"><a href="#镜像操作" class="headerlink" title="镜像操作"></a><strong>镜像操作</strong></h3><ul><li>镜像名称一般分两部分组成：[repository]:[tag]。</li><li>在没有指定tag时，默认是latest，代表最新版本的镜像</li></ul><p>例如：mysql:5.7</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101434783.png" alt="image-20221103101434783"></p><p>docker –help、docker images –help查看帮助文档</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101441028.png" alt="image-20221103101441028"></p><p>利用dockersave将nginx镜像导出磁盘，然后再通过load加载回来：</p><p>步骤一：利用docker xx –help命令查看docker save和docker load的语法</p><p>步骤二：使用docker save导出镜像到磁盘 </p><p>步骤三：使用docker load加载镜像</p><h4 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a><strong>总结</strong></h4><p>镜像操作有哪些？</p><ul><li>docker images</li><li>docker rmi</li><li>docker pull</li><li>docker push</li><li>docker save </li><li>docker load</li></ul><h3 id="容器操作"><a href="#容器操作" class="headerlink" title="容器操作"></a><strong>容器操作</strong></h3><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101456037.png" alt="image-20221103101456037"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101459085.png" alt="image-20221103101459085"></p><h4 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a><strong>总结</strong></h4><p>dockerrun命令的常见参数有哪些？</p><ul><li>–name：指定容器名称</li><li>-p：指定端口映射</li><li>-d：让容器后台运行</li></ul><p>查看容器日志的命令：</p><ul><li>docker logs</li><li>添加 -f</li></ul><p>参数可以持续查看日志</p><p>查看容器状态：</p><ul><li>docker ps</li></ul><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101531610.png" alt="image-20221103101531610"></p><h4 id="总结-5"><a href="#总结-5" class="headerlink" title="总结"></a><strong>总结</strong></h4><p>查看容器状态：</p><ul><li>docker ps</li><li>添加-a参数查看所有状态的容器</li></ul><p>删除容器：</p><ul><li>docker rm</li><li>不能删除运行中的容器，除非添加 -f 参数</li></ul><p>进入容器：</p><ul><li>命令是docker exec -it [容器名] [要执行的命令]</li><li>exec命令可以进入容器修改文件，但是在容器内修改文件是不推荐的</li></ul><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101601141.png" alt="image-20221103101601141"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101605054.png" alt="image-20221103101605054"></p><h3 id="数据卷（容器数据管理）"><a href="#数据卷（容器数据管理）" class="headerlink" title="数据卷（容器数据管理）"></a><strong>数据卷（容器数据管理）</strong></h3><p>容器与数据耦合存在的问题</p><ul><li>不便于修改：当我们要修改Nginx的html内容时，需要进入容器内部修改，很不方便。</li><li>数据不可服用：在容器内的修改对外是不可见的。所有修改对新创建的容器是不可复用的。</li><li>升级维护困难：数据在容器内，如果要升级容器必然删除就容器，所有数据都跟着删除了。</li></ul><p>数据卷（volume）是一个虚拟目录，指向宿主机文件系统中的某个目录。</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101650554.png" alt="image-20221103101650554"></p><h4 id="数据卷操作的基本语法如下："><a href="#数据卷操作的基本语法如下：" class="headerlink" title="数据卷操作的基本语法如下："></a><strong>数据卷操作的基本语法如下：</strong></h4><ul><li>docker volume [COMMAND]</li></ul><p>docker volume命令是数据卷操作，根据命令后跟随的command来确定下一步的操作：</p><ul><li>create 创建一个volume</li><li>inspect 显示一个或多个volume的信息</li><li>ls 列出所有的volume</li><li>prune 删除未使用的volume</li><li>rm 删除一个或多个指定的volume</li></ul><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101713739.png" alt="image-20221103101713739"></p><h4 id="总结-6"><a href="#总结-6" class="headerlink" title="总结"></a><strong>总结</strong></h4><p>数据卷的作用：</p><ul><li>将容器与数据分离，解耦合，方便操作容器内数据，保证数据安全</li></ul><p>数据卷操作：</p><ul><li>docker volume create</li><li>docker volume ls</li><li>docker volume inspect</li><li>docker volume rm</li><li>docker volume prune</li></ul><h4 id="挂载数据卷"><a href="#挂载数据卷" class="headerlink" title="挂载数据卷"></a><strong>挂载数据卷</strong></h4><p>我们在创建容器时，可以通过-v参数来挂在一个数据卷到某个容器目录</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101745919.png" alt="image-20221103101745919"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101748208.png" alt="image-20221103101748208"></p><h4 id="总结-7"><a href="#总结-7" class="headerlink" title="总结"></a><strong>总结</strong></h4><p>数据卷挂载方式：</p><ul><li>-v volumeName: &#x2F;targetContainerPath</li><li>如果容器运行时volume不存在，会自动被创建出来</li></ul><p>案例：创建并运行一个MySQL容器，将宿主机目录直接挂载到容器</p><p>提示：目录挂载与数据卷挂载的语法是类似的：</p><ul><li>-v [宿主机目录]:[容器内目录]</li><li>-v [宿主机文件]:[容器内文件]</li></ul><p>实现思路如下：</p><p>1.在将课前资料中的mysql.tar文件上传到虚拟机，通过load命令加载为镜像</p><p>2.创建目录&#x2F;tmp&#x2F;mysql&#x2F;data</p><p>3.创建目录&#x2F;tmp&#x2F;mysql&#x2F;conf，将课前资料提供的hmy.cnf文件上传到&#x2F;tmp&#x2F;mysql&#x2F;conf</p><p>4.去DockerHub查阅资料，创建并运行MySQL容器，要求：</p><p>①挂载&#x2F;tmp&#x2F;mysql&#x2F;data到mysql容器内数据存储目录</p><p>②挂载&#x2F;tmp&#x2F;mysql&#x2F;conf&#x2F;hmy.cnf到mysql容器的配置文件</p><p>③设置MySQL密码</p><h4 id="数据卷挂载的方式对比："><a href="#数据卷挂载的方式对比：" class="headerlink" title="数据卷挂载的方式对比："></a><strong>数据卷挂载的方式对比：</strong></h4><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101825721.png" alt="image-20221103101825721"></p><p><strong>总结</strong></p><p>1.docker run的命令中通过 -v 参数挂载文件或目录到容器中：</p><p>​①-v volume名称:容器内目录</p><p>​②-v 宿主机文件:容器内文件</p><p>​③-v 宿主机目录:容器内目录</p><p>2.数据卷挂载与目录直接挂载的</p><p>​①数据卷挂载耦合度低，由docker来管理目录，但是目录较深，不好找</p><p>​②目录挂载耦合度高，需要我们自己管理目录，不过目录容易寻找查看</p><h2 id="Dockerfile自定义镜像"><a href="#Dockerfile自定义镜像" class="headerlink" title="Dockerfile自定义镜像"></a><strong>Dockerfile自定义镜像</strong></h2><h3 id="镜像结构"><a href="#镜像结构" class="headerlink" title="镜像结构"></a><strong>镜像结构</strong></h3><ul><li>镜像是将应用程序及其需要的系统函数库、环境、配置、依赖打包而成。</li></ul><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103101936256.png" alt="image-20221103101936256"></p><h3 id="总结-8"><a href="#总结-8" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>镜像是分层结构，每一层称为一个Layer</p><ul><li>BaseImage层：包含基本的系统函数库、环境变量、文件系统</li><li>Entrypoint：入口，是镜像中应用启动的命令</li><li>其它：在BaseImage基础上添加依赖、安装程序、完成整个应用的安装和配置</li></ul><h3 id="什么是dockerfile"><a href="#什么是dockerfile" class="headerlink" title="什么是dockerfile"></a><strong>什么是dockerfile</strong></h3><p>Dockerfile就是要给文本文件，其中包含一个个的指令，用指令来说明要执行什么操作来构建镜像。每一个指令都会形成一层Layer。</p><table><thead><tr><th>指令</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>FROM</td><td>指定基础镜像</td><td>FROM centos:6</td></tr><tr><td>ENV</td><td>设置环境变量，可在后面指令使用</td><td>ENV key value</td></tr><tr><td>COPY</td><td>拷贝本地文件到镜像的指定目录</td><td>COPY .&#x2F;mysql-5.7.rpm &#x2F;tmp</td></tr><tr><td>RUN</td><td>执行Linux的shell命令，一般是安装过程的命令</td><td>RUN yum install gcc</td></tr><tr><td>EXPOSE</td><td>指定容器运行时监听的端口，是给镜像使用者看的</td><td>EXPOSE 8080</td></tr><tr><td>ENTRYPOINT</td><td>镜像中应用的启动命令，容器运行时调用</td><td>ENTRYPOINT java -jar xx.jar</td></tr></tbody></table><p>更新详细语法说明，请参考官网文档： <a href="https://docs.docker.com/engine/reference/builder">https://docs.docker.com/engine/reference/builder</a></p><p>Dockerfile实际上就是方便编程人员生成一个脚本文件方便以后再次需要安装或者执行某个操作时不需要再次去输入Docker指令</p><p>Dockerfile执行指令：docker build -t [docker文件名称]</p><p>实际上shell指令也能生成脚本文件，在secureCRT工具中Script-&gt;Start Recording Script、Start Recording Scrip、run</p><h3 id="总结-9"><a href="#总结-9" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>1.Dockerfile的本质是一个文件，通过指令描述镜像的构建过程</p><p>2.Dockerfile的第一行必须是FROM，从一个基础镜像来构建</p><p>3.基础镜像可以是基本操作系统，如Ubuntu。也可以是其他人制作好的镜像，例如：java:8-alpine</p><h2 id="DockerCompose"><a href="#DockerCompose" class="headerlink" title="DockerCompose"></a><strong>DockerCompose</strong></h2><p>什么是DockerCompose</p><ul><li>Docker Compose可以基于Compose文件帮我们快速的部署分布式应用，而无需手动一个个创建和运行容器！</li><li>Compose文件是一个文本文件，通过指令定义集群中的每个容器如何运行。</li></ul><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">version:</span> <span class="hljs-string">&quot;3.8&quot;</span><br><span class="hljs-symbol">services:</span><br><span class="hljs-symbol">  mysql:</span><br><span class="hljs-symbol">    image:</span> mysql:<span class="hljs-number">5.7</span><span class="hljs-number">.25</span><br><span class="hljs-symbol">    environment:</span><br><span class="hljs-symbol">     MYSQL_ROOT_PASSWORD:</span><span class="hljs-number">123</span> <br><span class="hljs-symbol">    volumes:</span><br>     - <span class="hljs-string">&quot;/tmp/mysql/data:/var/lib/mysql&quot;</span><br>     -  <span class="hljs-string">&quot;/tmp/mysql/conf/hmy.cnf:/etc/mysql/conf.d/hmy.cnf&quot;</span><br><span class="hljs-symbol">  web:</span><br><span class="hljs-symbol">    build:</span> .<br><span class="hljs-symbol">    ports:</span><br>     -<span class="hljs-string">&quot;8090:8090&quot;</span><br></code></pre></td></tr></table></figure><p>DockerCompose的详细语法参考官网：<a href="https://docs.docker.com/compose/compose-file/">https://docs.docker.com/compose/compose-file/</a></p><h2 id="DockerCompose部署"><a href="#DockerCompose部署" class="headerlink" title="DockerCompose部署"></a><strong>DockerCompose部署</strong></h2><h3 id="实现思路如下："><a href="#实现思路如下：" class="headerlink" title="实现思路如下："></a><strong>实现思路如下：</strong></h3><p>①查看课前资料提供的cloud-demo文件夹，里面已经编写好了docker-compose文件</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%BA%8C/image-20221103102135824.png" alt="image-20221103102135824"></p><p>②修改自己的cloud-demo项目，将数据库、nacos地址都命名为docker-compose中的服务名</p><p>③使用maven打包工具，将项目中的每个微服务都打包为app.jar</p><p>④将打包好的app.jar拷贝到cloud-demo中的每一个对应的子目录中</p><p>⑤将cloud-demo上传至虚拟机，利用 docker-compose up -d 来部署</p><h2 id="Docker镜像中心"><a href="#Docker镜像中心" class="headerlink" title="Docker镜像中心"></a><strong>Docker镜像中心</strong></h2><h3 id="搭建私有镜像中心"><a href="#搭建私有镜像中心" class="headerlink" title="搭建私有镜像中心"></a><strong>搭建私有镜像中心</strong></h3><p>镜像仓库（Docker Registry ）有公共的和私有的两种形式：</p><ul><li>公共仓库：例如Docker官方的<a href="https://hub.docker.com/">Docker Hub</a>，国内也有一些云服务商提供类似于Docker Hub 的公开服务，比如<a href="https://c.163.com/hub">网易云镜像服务</a>、<a href="https://hub.daocloud.io/">DaoCloud</a><a href="https://hub.daocloud.io/">镜像服务</a>、<a href="https://cr.console.aliyun.com/">阿里云镜像服务</a>等。</li><li>除了使用公开仓库外，用户还可以在本地搭建私有 Docker Registry。企业自己的镜像最好是采用私有Docker Registry来实现。</li></ul><h3 id="向镜像仓库推送镜像"><a href="#向镜像仓库推送镜像" class="headerlink" title="向镜像仓库推送镜像"></a><strong>向镜像仓库推送镜像</strong></h3><h3 id="从镜像仓库拉取镜像"><a href="#从镜像仓库拉取镜像" class="headerlink" title="从镜像仓库拉取镜像"></a><strong>从镜像仓库拉取镜像</strong></h3><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>微服务框架(一)</title>
    <link href="/2022/10/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/"/>
    <url>/2022/10/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/</url>
    
    <content type="html"><![CDATA[<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103093422400.png" alt="image-20221103093422400"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103093426678.png" alt="image-20221103093426678"></p><p>软件架构分类：单体式、微服务</p><p>微服务架构的相关概念：Provider和Consumer，PRC和Restful，分布式和集群。</p><p>国内最知名的微服务技术框架就是：</p><ul><li><p>Dubbo&#x2F;Duboox</p></li><li><ul><li><a href="http://dubbo.io/">http://dubbo.io/</a></li><li><a href="https://github.com/dangdangdotcom/dubbox">https://github.com/dangdangdotcom/dubbox</a></li></ul></li><li><p>SpringCloud</p></li><li><ul><li><a href="http://projects.spring.io/spring-cloud/">http://projects.spring.io/spring-cloud/</a></li></ul></li></ul><p>微服务架构特征：</p><ul><li>单一职责：微服务拆分粒度更小，每个服务都对应唯一的业务能力，做到单一职责，避免重复业务开发</li><li>面向服务：微服务对外暴露业务接口</li><li>自治：团队独立、技术独立、数据独立、部署独立</li><li>隔离性强：服务调用做好隔离、容错、降级、避免出现联机问题</li></ul><h1 id="微服务技术对比"><a href="#微服务技术对比" class="headerlink" title="微服务技术对比"></a><strong>微服务技术对比</strong></h1><table><thead><tr><th></th><th>Dubbo</th><th>SpringCloud</th><th>SpringCloudAlibaba</th></tr></thead><tbody><tr><td>注册中心</td><td>zookeeper、Redis</td><td>Eureka、Consul</td><td>Nacos、Eureka</td></tr><tr><td>服务远程调用</td><td>Dubbo协议</td><td>Feign(http协议)</td><td>Dubbo、Feign</td></tr><tr><td>配置中心</td><td>无</td><td>SpringCloudConfig</td><td>SpringCloudConfig、Nacos</td></tr><tr><td>服务网关</td><td>无</td><td>SpringCloudGateway、Zuul</td><td>SpringCloudGateway、Zuul</td></tr><tr><td>服务监控和保护</td><td>dubbo-admin，功能弱</td><td>Hystrix</td><td>Sentinel</td></tr></tbody></table><p><strong>所有可能会碰到四种微服务方式</strong>：</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103093555150.png" alt="image-20221103093555150"></p><h1 id="微服务拆分及远程调用"><a href="#微服务拆分及远程调用" class="headerlink" title="微服务拆分及远程调用"></a><strong>微服务拆分及远程调用</strong></h1><p>服务拆分注意事项</p><p>1、不同微服务，不要重复开发相同业务</p><p>2、微服务数据独立，不要访问其他微服务的数据库</p><p>3、微服务可以将自己的业务暴露为接口，供其他微服务调用</p><p>微服务远程调用</p><p>步骤：（例订单查询）</p><p>①注册RestTemplate</p><p>在order-service的OrderApplication中注册RestTemplate</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@MapperScan</span>(<span class="hljs-string">&quot;cn.itcast.order.mapper&quot;</span>)<br><span class="hljs-meta">@SpringBootApplication</span> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderApplication</span> &#123;   <br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) &#123;        <br>         <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">OrderApplication</span>.<span class="hljs-property">class</span>,args);    <br>     &#125;     <br>     <span class="hljs-meta">@Bean</span>    <br>     <span class="hljs-keyword">public</span> <span class="hljs-title class_">RestTemplate</span> <span class="hljs-title function_">restTemplate</span>(<span class="hljs-params"></span>)&#123;<br>         returnnew <span class="hljs-title class_">RestTemplate</span>();<br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>②服务远程调用RestTemplate</p><p>修改oerder-service中的OrderService的queryOrderById方法：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">@Service<br>public <span class="hljs-keyword">class</span> OrderService &#123;<br>        @Autowired<br>        <span class="hljs-keyword">private</span> RestTemplate restTemplate;    <br>        <br>        public Order query<span class="hljs-constructor">OrderById(Long <span class="hljs-params">orderId</span>)</span> &#123;<br>                <span class="hljs-comment">// 1.查询订单        </span><br>                Orderorder = orderMapper.find<span class="hljs-constructor">ById(<span class="hljs-params">orderId</span>)</span>;        <br>                <span class="hljs-comment">// TODO2.查询用户         </span><br>                Stringurl = <span class="hljs-string">&quot;http://localhost:8081/user/&quot;</span> +  order.get<span class="hljs-constructor">UserId()</span>;        <br>                User user = restTemplate.get<span class="hljs-constructor">ForObject(<span class="hljs-params">url</span>,User.<span class="hljs-params">class</span>)</span>;        <br>                <span class="hljs-comment">// 3.封装user信息        </span><br>                order.set<span class="hljs-constructor">User(<span class="hljs-params">user</span>)</span>;        <br>                <span class="hljs-comment">// 4.返回        </span><br>                returnorder;    <br>                &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="提供者与消费者"><a href="#提供者与消费者" class="headerlink" title="提供者与消费者"></a><strong>提供者与消费者</strong></h2><ul><li>服务提供者：一次业务中，被其它微服务调用的服务。（提供接口给其它微服务）</li><li>服务消费者：一次业务中，调用其它微服务的服务。（调用其它微服务提供的接口）</li></ul><h1 id="Eureka注册中心"><a href="#Eureka注册中心" class="headerlink" title="Eureka注册中心"></a><strong>Eureka注册中心</strong></h1><p>硬编码模式的服务远程调用会出现一系列问题：</p><ul><li><p>服务消费者该如何获取服务提供者的地址信息？</p></li><li><ul><li>服务提供者启动时向eureka注册自己的信息</li><li>eureka保存这些信息</li><li>消费者根据服务名称向eureka拉取提供者信息</li></ul></li><li><p>如果有多个服务提供者，消费者该如何选择？</p></li><li><ul><li>服务消费者利用负载均衡算法，从服务列表中挑选一个</li></ul></li><li><p>消费者如何得知服务提供者的健康状态？</p></li><li><ul><li>服务提供者会每隔30秒向EurekaServer发送心跳请求，报告健康状态</li><li>eureka会更新记录服务列表信息，心跳不正常会被踢出</li><li>消费者就可以拉取到最新的信息</li></ul></li></ul><p>在Eureka架构中，微服务角色有两类：</p><ul><li><p>EurekaServer：服务端，注册中心</p></li><li><ul><li>记录服务信息</li><li>心跳监控</li></ul></li><li><p>EurekaClient：客户端</p></li><li><ul><li><p>Provider：服务提供者，例如案例中的user-service</p></li><li><ul><li>注册自己的信息到EurekaServer</li><li>每隔30秒向EurekaServer发送心跳</li></ul></li><li><p>consumer：服务消费者，例如案例中的order-service</p></li><li><ul><li>根据服务名称从EurekaServer拉取服务列表</li><li>基于服务列表做负载均衡，选中一个微服务后发起远程调用</li></ul></li></ul></li></ul><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103093709350.png" alt="image-20221103093709350"></p><h2 id="1、搭建EurekaServer"><a href="#1、搭建EurekaServer" class="headerlink" title="1、搭建EurekaServer"></a><strong>1、搭建EurekaServer</strong></h2><p>搭建EurekaServer服务步骤如下：</p><p>①创建项目，引入spring-cloud-starter-netflix-eureka-server的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>②编写启动类，添加@EnableEurekaServer注解</p><p>③添加application.yml文件，编写下面的配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml">server:<br>  port: 10086 #服务端口<br>spring:<br>  application:<br>      name: eurekaserver #eureka的服务名称<br>eureka:<br>  client:<br>      service-url: #eureka的地址信息<br>            defaultZone:http://127.0.0.1:10086/eureka/<br></code></pre></td></tr></table></figure><h2 id="2、注册服务"><a href="#2、注册服务" class="headerlink" title="2、注册服务"></a><strong>2、注册服务</strong></h2><p>将服务注册到eureka</p><p>将user-service服务注册到EurekaServer步骤如下：</p><p>①在user-service项目引入spring-cloud-starter-netflix-eureka-client的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>②在application.yml文件，编写下面的配置：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">spring:</span><br><span class="hljs-symbol">  application:</span><br><span class="hljs-symbol">      name:</span> userservice<br><span class="hljs-symbol">eureka:</span><br><span class="hljs-symbol">  client:</span><br>      service-url:<br><span class="hljs-symbol">            defaultZone:</span>http:<span class="hljs-comment">//127.0.0.1:10086/eureka/</span><br></code></pre></td></tr></table></figure><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103093813501.png" alt="image-20221103093813501"></p><h2 id="3、服务发现"><a href="#3、服务发现" class="headerlink" title="3、服务发现"></a><strong>3、服务发现</strong></h2><p>在一个服务中完成服务拉取，然后通过负载均衡挑选一个服务，实现远程调用。</p><p>服务拉取是基于服务名称获取服务列表，然后在对服务列表做负载均衡</p><p>①修改OrderService的代码，修改访问的url路径，用服务名代替ip、端口：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">Stringurl</span> = <span class="hljs-string">&quot;http://userservice/user/&quot;</span>+order.getUserId()<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p><strong>②</strong>在order-service项目的启动类OrderApplication中的RestTemplate添加<strong>负载均衡</strong>注解：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Bean</span><br><span class="hljs-variable">@LoadBalanced</span><br>public RestTemplate <span class="hljs-built_in">restTemplate</span>() &#123;<br>    <span class="hljs-selector-tag">returnnew</span> <span class="hljs-selector-tag">RestTemplate</span>();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><p>1.搭建EurekaServer</p><ul><li>引入eureka-server依赖</li><li>添加@EnableEurekaServer注解</li><li>在application.yml中配置eureka地址</li></ul><p>2.服务注册</p><ul><li>引入eureka-client依赖</li><li>在application.yml中配置eureka地址</li></ul><p>3.服务发现</p><ul><li>引入eureka-client依赖</li><li>在application.yml中配置eureka地址</li><li>给RestTemplate添加@LoadBalanced注解</li><li>用服务提供者的服务名称远程调用</li></ul><h1 id="Ribbon负载均衡（Eureka中负载均衡的实现组件）"><a href="#Ribbon负载均衡（Eureka中负载均衡的实现组件）" class="headerlink" title="Ribbon负载均衡（Eureka中负载均衡的实现组件）"></a><strong>Ribbon负载均衡（Eureka中负载均衡的实现组件）</strong></h1><h2 id="负载均衡原理"><a href="#负载均衡原理" class="headerlink" title="负载均衡原理"></a><strong>负载均衡原理</strong></h2><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103093905461.png" alt="image-20221103093905461"></p><h2 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a><strong>负载均衡策略</strong></h2><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103093914932.png" alt="image-20221103093914932"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103093917780.png" alt="image-20221103093917780"></p><p>通过定义IRule实现可以修改负载均衡规则，有两种方式：</p><p>①代码方式：在order-service中的OrderApplication类中，定义一个新的IRule：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp">@Bean<br><span class="hljs-function"><span class="hljs-keyword">public</span> IRule <span class="hljs-title">randomRule</span>()</span>&#123;<br>    <span class="hljs-function">returnnew <span class="hljs-title">RandomRule</span>()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>②配置文件方式：在order-service的application.yml文件中，添加新的配置也可以修改规则：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">userservice:</span><br><span class="hljs-symbol">  ribbon:</span><br><span class="hljs-symbol">      NFLoadBalancerRuleClassName:</span> com.netflix.loadbalancer.RandomRule<span class="hljs-meta">#负载均衡规则</span><br></code></pre></td></tr></table></figure><h2 id="懒加载"><a href="#懒加载" class="headerlink" title="懒加载"></a><strong>懒加载</strong></h2><p>Ribbon默认是采用懒加载，即第一次访问时才会去创建LoadBalanceClient，请求时间会很长。</p><p>而饥饿加载则会在项目启动时创建，降低第一次访问的耗时，通过下面配置开启饥饿加载：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">ribbon:</span><br>  <span class="hljs-attr">eager-load:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启饥饿加载     </span><br>      <span class="hljs-string">clients:userservice</span> <span class="hljs-comment"># 指定对userservice这个服务饥饿加载</span><br></code></pre></td></tr></table></figure><h1 id="Nacos注册中心"><a href="#Nacos注册中心" class="headerlink" title="Nacos注册中心"></a><strong>Nacos注册中心</strong></h1><h2 id="Nacos安装指南"><a href="#Nacos安装指南" class="headerlink" title="Nacos安装指南"></a><strong>Nacos安装指南</strong></h2><p>参考：<a href="https://www.bilibili.com/video/BV1LQ4y127n4?p=17&amp;spm_id_from=pageDriver&amp;vd_source=e3b8237315186129c5794d1094b57c6a">https://www.bilibili.com/video/BV1LQ4y127n4?p=17&amp;spm_id_from=pageDriver&amp;vd_source=e3b8237315186129c5794d1094b57c6a</a></p><h3 id="服务注册到Nacos"><a href="#服务注册到Nacos" class="headerlink" title="服务注册到Nacos"></a><strong>服务注册到Nacos</strong></h3><p>①在cloud-demo父工程中添加spring-cloud-alibaba的依赖管理：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>②注释掉order-service和user-service中原有的eureka依赖</p><p>③添加nacos的客户端依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- nacos客户端依赖包 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>④修改user-service&amp;order-service中的application.yml文件，注释eureka地址，添加nacos地址：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">spring：<br>    <span class="hljs-keyword">cloud：</span><br><span class="hljs-keyword"></span>        nacos：<br>            server-<span class="hljs-keyword">addr：localhost：8848 </span><span class="hljs-comment">#nacos服务地址</span><br></code></pre></td></tr></table></figure><p>⑤启动并测试</p><h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>1.Nacos服务搭建</p><p>​①下载安装包</p><p>​②解压</p><p>​③在bin目录下运行指令：startup.cmd -m standalone</p><p>2.Nacos服务注册或发现</p><p>​①引入nacos.discovery依赖</p><p>​②配置nacos地址spring.cloud.nacos.server-addr</p><h2 id="Nacos服分级存储模型"><a href="#Nacos服分级存储模型" class="headerlink" title="Nacos服分级存储模型"></a><strong>Nacos服分级存储模型</strong></h2><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103094311954.png" alt="image-20221103094311954"></p><h3 id="服务跨集群调用问题"><a href="#服务跨集群调用问题" class="headerlink" title="服务跨集群调用问题"></a><strong>服务跨集群调用问题</strong></h3><p>服务调用尽可能选择本地集群的服务，跨集群调用延迟较高，本地集群不可访问时，再去访问其他集群</p><h3 id="服务集群属性"><a href="#服务集群属性" class="headerlink" title="服务集群属性"></a><strong>服务集群属性</strong></h3><p>①修改application.yml，添加如下内容</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">spring:</span><br><span class="hljs-symbol">    cloud:</span><br><span class="hljs-symbol">        nacos:</span><br>            server-add:localhost:<span class="hljs-number">8848</span> <span class="hljs-meta">#nacos 服务端地址</span><br><span class="hljs-symbol">            discovery:</span><br>                cluster-name:HZ <span class="hljs-meta"># 配置集群名称,也就是机房位置，例如:HZ，杭州</span><br></code></pre></td></tr></table></figure><h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>1.Nacos服务分级存储模型</p><p>​①一级是服务，例如userservice</p><p>​②二级是集群，例如杭州或上海</p><p>​③三级是实例，例如杭州机房的某台部署了userservice的服务器</p><p>2.如何设置实例的集群属性</p><p>​①修改application.yml文件，添加spring.cloud.nacos.discovery.cluster-name属性即可</p><h2 id="Nacos的负载均衡"><a href="#Nacos的负载均衡" class="headerlink" title="Nacos的负载均衡"></a><strong>Nacos的负载均衡</strong></h2><h3 id="根据集群负载均衡"><a href="#根据集群负载均衡" class="headerlink" title="根据集群负载均衡"></a><strong>根据集群负载均衡</strong></h3><p>①修改order-service中的application.yml，设置集群为HZ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>      <span class="hljs-attr">nacos:</span><br>            <span class="hljs-string">server-addr:localhost:8848</span> <span class="hljs-comment"># nacos 服务端地址</span><br>            <span class="hljs-attr">discovery:</span><br>                    <span class="hljs-attr">cluster-name:</span> <span class="hljs-string">HZ</span> <span class="hljs-comment"># 配置集群名称，也就是机房位置</span><br></code></pre></td></tr></table></figure><p>②然后再order-service中设置负载均衡的IRule为NacosRule，这个规则有限会寻找与自己统计群的服务：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">userservice:<br>  ribbon:<br>     NFLoadBalancerRuleClassName:com<span class="hljs-selector-class">.alibaba</span><span class="hljs-selector-class">.cloud</span><span class="hljs-selector-class">.nacos</span><span class="hljs-selector-class">.ribbon</span><span class="hljs-selector-class">.NacosRule</span> #负载均衡规则<br></code></pre></td></tr></table></figure><h3 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>1.NacosRule负载均衡策略</p><p>​①优先选择同集群服务实例列表</p><p>​②本地集群找不到提供者，才去其它集群寻找，并且会报警告</p><p>​③确定了可用实例列表后，再采用随机负载均衡挑选实例</p><h3 id="根据权重负载均衡"><a href="#根据权重负载均衡" class="headerlink" title="根据权重负载均衡"></a><strong>根据权重负载均衡</strong></h3><p>实际部署中会出现这样的场景：</p><p>服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求</p><p>Nacos提供了权重配置来控制访问频率，权重越大则访问频率越高</p><p>①在Nacos控制台可以设置实例的权重值，首先选中实例后面的编辑按钮</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103094656488.png" alt="image-20221103094656488"></p><p>②将权重设置为0.1，测试可以发现8081被访问到的频率大大降低</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103094701023.png" alt="image-20221103094701023"></p><h3 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>1.实例的权重控制</p><p>①Nacos控制台可以设置实例的权重值，0~1之间</p><p>②同集群内的多个实例，权重越高被访问的频率越高</p><p>③权重设置为0则完全不会被访问</p><h2 id="环境隔离-namespace"><a href="#环境隔离-namespace" class="headerlink" title="环境隔离-namespace"></a><strong>环境隔离-namespace</strong></h2><p>Nacos中服务存储和数据存储的最外层都是一个名为namespace的东西，用来做最外层隔离</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103094721255.png" alt="image-20221103094721255"></p><p>①在Nacos控制台可以创建namespace，用来隔离不同环境</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103094726811.png" alt="image-20221103094726811"></p><p><strong>②</strong>然后填写一个新的命名空间信息：</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103094734583.png" alt="image-20221103094734583"></p><p>③保存后会在控制台看到这个命名空间的id</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103094740214.png" alt="image-20221103094740214"></p><p>④修改order-service的application.yml，添加namespace：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">spring:</span><br><span class="hljs-symbol">  datasource:</span><br><span class="hljs-symbol">      url:</span>jdbc:mysql:<span class="hljs-comment">//localhost:3306/heima?useSSL=false</span><br><span class="hljs-symbol">      username:</span>root<br><span class="hljs-symbol">      password:</span><span class="hljs-number">123</span><br>      driver-class-name:com.mysql.jdbc.Driver<br><span class="hljs-symbol">   cloud:</span><br><span class="hljs-symbol">       nacos:</span><br>             server-addr:localhost:<span class="hljs-number">8848</span><br><span class="hljs-symbol">             discovery:</span><br>                     cluster-name: SH <span class="hljs-meta"># 上海</span><br><span class="hljs-symbol">                     namespace:</span><span class="hljs-number">492</span>a7d5d<span class="hljs-number">-237</span>b<span class="hljs-number">-46</span>a1-a99a-fa8e98e4b0f9 <span class="hljs-meta"># 命名空间，填ID</span><br></code></pre></td></tr></table></figure><p>⑤重启order-service后，再来查看控制台：</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103094756679.png" alt="image-20221103094756679"></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103094758647.png" alt="image-20221103094758647"></p><p>⑥此时访问order-service，因为namespace不同，会导致找不到userservice，控制台会报错：</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103094806032.png" alt="image-20221103094806032"></p><h3 id="总结-5"><a href="#总结-5" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>1.Nacos环境隔离</p><p>​①每个namespace都有唯一id</p><p>​②服务设置namespace时要写id而不是名称</p><p>​③不同namespace下的服务互相不可见</p><h2 id="Nacos注册中心与Eureka注册成中心的对比"><a href="#Nacos注册中心与Eureka注册成中心的对比" class="headerlink" title="Nacos注册中心与Eureka注册成中心的对比"></a><strong>Nacos注册中心与Eureka注册成中心的对比</strong></h2><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103094857086.png" alt="image-20221103094857086"></p><h3 id="临时实力和非临时实力"><a href="#临时实力和非临时实力" class="headerlink" title="临时实力和非临时实力"></a><strong>临时实力和非临时实力</strong></h3><p>服务注册到Nacos时，可以选择注册为临时或非临时实例，通过下面的配置来设置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>      <span class="hljs-attr">nacos:</span><br>            <span class="hljs-attr">discovery:</span><br>                    <span class="hljs-attr">ephemeral:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 设置为非临时实例</span><br></code></pre></td></tr></table></figure><p>临时实例宕机时，会从nacos的服务列表中提出，而非临时实例则不会</p><h3 id="总结-6"><a href="#总结-6" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>1.Nacos与eureka的共同点</p><p>​①都支持服务注册和服务拉取</p><p>​②都支持服务提供者心跳方式做健康检测</p><p>2.Nacos与Eureka的区别</p><p>​①Nacos支持服务端主动检测提供者状态：临时实例采用心跳模式，非临时实例采用主动检测模式</p><p>​②临时实例心跳不正常会被剔除，非临时实例则不会被剔除</p><p>​③Nacos支持服务列表变更的消息推送模式，服务列表更新更及时</p><p>​④Nacos集群默认采用AP方式，当集群中存在非临时实例时，采用CP模式；Eureka采用AP方式</p><h1 id="Nacos配置管理"><a href="#Nacos配置管理" class="headerlink" title="Nacos配置管理"></a><strong>Nacos配置管理</strong></h1><h2 id="统一配置管理"><a href="#统一配置管理" class="headerlink" title="统一配置管理"></a><strong>统一配置管理</strong></h2><p>①在Nacos中添加配置信息：</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103095007974.png" alt="image-20221103095007974"></p><p>②在弹出表单中填写配置信息：</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103095013228.png" alt="image-20221103095013228"></p><p>配置获取的步骤如下：</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103095020264.png" alt="image-20221103095020264"></p><p>①引入Nacos的配置管理客户端依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--nacos配置管理依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>②在userservice中的resource目录添加一个bootstrap.yml文件，这个文件是引导文件，优先级高于application.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">userservice</span> <span class="hljs-comment"># 服务名称  </span><br>  <span class="hljs-attr">profiles:</span>    <br>      <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span> <span class="hljs-comment">#开发环境，这里是dev   </span><br>  <span class="hljs-attr">cloud:</span><br>      <span class="hljs-attr">nacos:</span><br>         <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment"># Nacos地址      </span><br>         <span class="hljs-attr">config:</span><br>                <span class="hljs-string">file-extension:yaml</span> <span class="hljs-comment"># 文件后缀名</span><br></code></pre></td></tr></table></figure><h3 id="总结-7"><a href="#总结-7" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>将配置交给Nacos管理的步骤</p><p>​①在Nacos中添加配置文件</p><p>​②在微服务中引入nacos的config依赖</p><p>​③在微服务中添加bootstrap.yml，配置nacos地址、当前环境、服务名称、文件后缀名。这些决定了程序启动时去nacos读取哪个文件</p><h2 id="配置热更新"><a href="#配置热更新" class="headerlink" title="配置热更新"></a><strong>配置热更新</strong></h2><p>Nacos中的配置文件变更后，微服务无需重启就可以感知。不过需要通过下面两种配置实现：</p><p>方式一：在@Value注入的变量所在类上添加注解@RefreshScope</p><p>​    <img src="data:image/png;base64,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" alt="0"></p><p>方式二：使用@ConfigurationProperties注解</p><p>​    <img src="data:image/png;base64,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" alt="0"></p><h3 id="总结-8"><a href="#总结-8" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>Nacos配置更改后，微服务可以实现热更新，方式：</p><p>​①通过@Value注解注入，结合@RefreshScope来刷新</p><p>​②通过@ConfigurationProperties注入，自动刷新</p><p>注意事项：</p><ul><li>不是所有的配置都适合放到配置中心，维护起来比较麻烦</li><li>建议将一些关键参数，需要运行时调整的参数放到nacos配置中心，一般都是自定义配置</li></ul><h2 id="多环境配置共享"><a href="#多环境配置共享" class="headerlink" title="多环境配置共享"></a><strong>多环境配置共享</strong></h2><p>微服务启动时会从nacos读取多个配置文件：</p><p>[spring.application.name]-[spring.profiles.active].yaml，例如：userservice-dev.yaml</p><p>[spring.application.name].yaml，例如：userservice.yaml</p><p>无论profile如何变化，[spring.application.name].yaml这个文件一定会加载，因此多环境共享配置可以写入这个文件</p><p>多种配置的优先级：</p><p>​    <img src="data:image/png;base64,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" alt="0"></p><h3 id="总结-9"><a href="#总结-9" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>微服务会从nacos读取的配置文件：</p><p>①[服务名]-[spring.profile.active].yaml，环境配置</p><p>②[服务名].yaml，默认配置，多环境共享</p><p>优先级：</p><p>①[服务名]-[环境].yaml &gt;[服务名].yaml &gt; 本地配置</p><h2 id="多服务共享配置"><a href="#多服务共享配置" class="headerlink" title="多服务共享配置"></a><strong>多服务共享配置</strong></h2><p>不同微服务之间可以共享配置文件，通过下面的两种方式来指定：</p><p>方式一：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">userservice</span> <span class="hljs-comment">#服务名称</span><br>  <span class="hljs-attr">profiles:</span><br>      <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span> <span class="hljs-comment"># 环境，  </span><br>  <span class="hljs-attr">cloud:</span><br>      <span class="hljs-attr">nacos:</span><br>            <span class="hljs-string">server-addr:localhost:8848</span> <span class="hljs-comment"># Nacos地址      </span><br>            <span class="hljs-attr">config:</span><br>                 <span class="hljs-string">file-extension:yaml</span> <span class="hljs-comment"># 文件后缀名        </span><br>                 <span class="hljs-attr">shared-configs:</span> <span class="hljs-comment">#多微服务间共享的配置列表       </span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-string">dataId:common.yaml</span> <span class="hljs-comment"># 要共享的配置文件id</span><br></code></pre></td></tr></table></figure><p>方式二：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">userservice</span> <span class="hljs-comment">#服务名称</span><br>  <span class="hljs-attr">profiles:</span><br>      <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span> <span class="hljs-comment"># 环境，  </span><br>  <span class="hljs-attr">cloud:</span><br>      <span class="hljs-attr">nacos:</span><br>            <span class="hljs-string">server-addr:localhost:8848</span> <span class="hljs-comment"># Nacos地址      </span><br>            <span class="hljs-attr">config:</span><br>                 <span class="hljs-string">file-extension:yaml</span> <span class="hljs-comment"># 文件后缀名        </span><br>                 <span class="hljs-attr">shared-configs:</span> <span class="hljs-comment">#多微服务间共享的配置列表       </span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-string">dataId:extend.yaml</span> <span class="hljs-comment"># 要共享的配置文件id</span><br></code></pre></td></tr></table></figure><p>多种配置的优先级</p><p>​    <img src="data:image/png;base64,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" alt="0"></p><h3 id="总结-10"><a href="#总结-10" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>微服务默认读取的配置文件：</p><p>​①[服务名]-[spring.profile.active].yaml，默认配置</p><p>​②[服务名].yaml，多环境共享</p><p>不同微服务共享的配置文件：</p><p>​①通过shared-configs指定</p><p>​②通过extension-configs指定</p><p>优先级：</p><p>​①环境配置 &gt;服务名.yaml &gt; extension-config&gt; extension-configs &gt; shared-configs &gt; 本地配置</p><h2 id="搭建Nacos集群"><a href="#搭建Nacos集群" class="headerlink" title="搭建Nacos集群"></a><strong>搭建Nacos集群</strong></h2><p><a href="https://www.bilibili.com/video/BV1LQ4y127n4?p=29&amp;spm_id_from=pageDriver&amp;vd_source=e3b8237315186129c5794d1094b57c6a">https://www.bilibili.com/video/BV1LQ4y127n4?p=29&amp;spm_id_from=pageDriver&amp;vd_source=e3b8237315186129c5794d1094b57c6a</a></p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103095532214.png" alt="image-20221103095532214"></p><h3 id="总结-11"><a href="#总结-11" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>集群搭建步骤：</p><p>​①搭建MySQL集群并初始化数据库表</p><p>​②下载解压nacos</p><p>​③修改集群配置（节点信息）、数据库配置</p><p>​④分别启动多个nacos节点</p><p>​⑤nginx反向代理</p><h1 id="Feign远程调用"><a href="#Feign远程调用" class="headerlink" title="Feign远程调用"></a><strong>Feign远程调用</strong></h1><h2 id="Feign替代RestTemplate"><a href="#Feign替代RestTemplate" class="headerlink" title="Feign替代RestTemplate"></a><strong>Feign替代RestTemplate</strong></h2><p>RestTemplate方式调用存在的问题</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Stringurl = &quot;http://userservice/user/&quot;+ <span class="hljs-keyword">order</span>.getUserId();<br><span class="hljs-keyword">User</span> <span class="hljs-keyword">user</span> = restTemplate.getForObject(url, <span class="hljs-keyword">User</span>.<span class="hljs-keyword">class</span>);<br></code></pre></td></tr></table></figure><p>存在下面的问题：</p><ul><li>代码可读性差，编程体验不统一</li><li>参数复杂URL难以维护</li></ul><p>Feign是一个声明式的http客户端，官方地址：<a href="https://github.com/OpenFeign/feign">https://github.com/OpenFeign/feign</a></p><p>其作用就是帮助我们优雅的实现http请求的发送，解决上面提到的问题。</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103095706215.png" alt="image-20221103095706215"></p><p>使用Feign的步骤如下：</p><p>①引入依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>②在order-service的启动类添加注解开启Feign的功能：</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103095720971.png" alt="image-20221103095720971"></p><p>③编写Feign客户端：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@FeignClient</span>(<span class="hljs-string">&quot;userservice&quot;</span>)<br>public interface UserClient&#123;<br>    <br>    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">&quot;/user/&#123;id&#125;&quot;</span>)     <br>    User <span class="hljs-built_in">findById</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">&quot;id&quot;</span>) Long id);<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>主要是基于SpringMVC的注解来声明远程调用的信息，比如：</p><ul><li>服务名称：userservice</li><li>请求方式：GET</li><li>请求路径：&#x2F;user&#x2F;{id}</li><li>请求参数：Long id</li><li>返回值类型：User</li></ul><p>④用Feign客户端代替RestTemplate</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103095736026.png" alt="image-20221103095736026"></p><h3 id="总结-12"><a href="#总结-12" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>Feign的使用步骤</p><p>①引入依赖</p><p>②添加@EnableFeignClients注解</p><p>③编写FeignClient接口</p><p>④使用FeignClient中定义的方法代替RestTemplate</p><h2 id="Feign的自定义配置"><a href="#Feign的自定义配置" class="headerlink" title="Feign的自定义配置"></a><strong>Feign的自定义配置</strong></h2><p>Feign运行自定义配置来覆盖默认配置，可以修改的配置如下：</p><table><thead><tr><th>类型</th><th>作用</th><th>说明</th></tr></thead><tbody><tr><td>feign.Logger.Level</td><td>修改日志级别</td><td>包含四种不同的级别：NONE,BASIC,HEADERS,FULL</td></tr><tr><td>feign.codec.Decoder</td><td>响应结果的解析器</td><td>http远程调用的结果做解析，例如解析json字符串为java对象</td></tr><tr><td>feign.codec.Encoder</td><td>请求参数编码</td><td>将请求参数编码，便于通过http请求发送</td></tr><tr><td>fegn.Contract</td><td>支持的注解格式</td><td>默认是SpringMVC的注解</td></tr><tr><td>feign.Retryer</td><td>失败重试机制</td><td>请求失败的重试机制，默认是没有，不过会使用Ribbon的重试</td></tr></tbody></table><p>配置Feign日志有两种方式：</p><p>方式一：配置文件方式</p><p>①全局生效</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103095820759.png" alt="image-20221103095820759"></p><p>②局部生效</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103095825937.png" alt="image-20221103095825937"></p><p>方式二：java代码方式，需要先声明一个Bean：</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103095846007.png" alt="image-20221103095846007"></p><p>①而后如果是全局配置，则把它放到@EnableFeignClients这个注解中：（加到启动类中）</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103095851150.png" alt="image-20221103095851150"></p><p>②如果是局部配置，则把它放到@FeignClient这个注解中：（加到具体的FeignClient注解中）</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103095901385.png" alt="image-20221103095901385"></p><h3 id="总结-13"><a href="#总结-13" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>Feign的日志配置:</p><p>1.方式一是配置文件，feign.client.config.xxx.loggerLevel</p><p>​①如果xxx是default则代表全局</p><p>​②如果xxx是服务名称，例如userservice则代表某服务</p><p>2.方式二是java代码配置Logger.Level这个Bean</p><p>​①如果在@EnableFeignClients注解声明则代表全局</p><p>​②如果在@FeignClient注解中声明则代表某服务</p><h2 id="Feign的性能优化"><a href="#Feign的性能优化" class="headerlink" title="Feign的性能优化"></a><strong>Feign的性能优化</strong></h2><p>Feign底层的客户端实现：</p><ul><li>URLConnection：默认实现，不支持连接池</li><li>Apache HttpClient ：支持连接池</li><li>OKHttp：支持连接池</li></ul><p>因此优化Feign的性能主要包括：</p><p>①使用连接池代替默认的URLConnection</p><p>②日志级别，最好用basic或none</p><h3 id="Feign的性能优化-连接池配置"><a href="#Feign的性能优化-连接池配置" class="headerlink" title="Feign的性能优化-连接池配置"></a><strong>Feign的性能优化-连接池配置</strong></h3><p>引入依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--httpClient的依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>feign-httpclient<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>配置连接池：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">client:</span><br>      <span class="hljs-attr">config:</span><br>          <span class="hljs-attr">default:</span> <span class="hljs-comment">#default全局的配置</span><br>               <span class="hljs-string">loggerLevel:BASIC</span> <span class="hljs-comment"># 日志级别，BASIC就是基本的请求和响应信息   </span><br>  <span class="hljs-attr">httpclient:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#开启feign对HttpClient的支持    </span><br>    <span class="hljs-attr">max-connections:</span> <span class="hljs-number">200</span> <span class="hljs-comment">#最大的连接数    </span><br>    <span class="hljs-attr">max-connections-per-route:</span> <span class="hljs-number">50</span> <span class="hljs-comment">#每个路径的最大连接数</span><br></code></pre></td></tr></table></figure><h3 id="总结-14"><a href="#总结-14" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>Feign的优化：</p><p>1.日志级别尽量用basic</p><p>2.使用HttpClient或OKHttp代替URLConnection</p><p>​①引入feign-httpClient依赖</p><p>​②配置文件开启httpClient功能，设置连接池参数</p><h2 id="Feign的最佳实践"><a href="#Feign的最佳实践" class="headerlink" title="Feign的最佳实践"></a><strong>Feign的最佳实践</strong></h2><p>方法一（继承）：给消费者的FeignClient和提供者的controller定义统一的父接口作为标准。</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103100023985.png" alt="image-20221103100023985"></p><p>方法二（抽取）：将FeignClient抽取为独立模块，并且把接口有关的POJO、默认的Feign配置都放到这个模块中，提供给所有消费者使用</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103100031246.png" alt="image-20221103100031246"></p><p><strong>实现最佳实践方式二的步骤如下：</strong></p><p>1.首先创建一个module，命名为feign-api，然后引入feign的starter依赖</p><p>2.将order-service中编写的UserClient、User、DefaultFeignConfiguration都复制到feign-api项目中</p><p>3.在order-service中引入feign-api的依赖</p><p>4.修改order-service中的所有与上述三个组件有关的import部分，改成导入feign-api中的包</p><p>5.重启测试</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103100046386.png" alt="image-20221103100046386"></p><h3 id="总结-15"><a href="#总结-15" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>Feign的最佳实践：</p><p>①让controller和FeignClient继承同一接口</p><p>②将FeignClient、POJO、Feign的默认配置都定义到一个项目中，供所有消费者使用</p><p>不同包的FeignClient的导入有两种方式：</p><p>①在@EnableFeignClients注解中添加basePackages，指定FeignClient所在的包</p><p>②在@EnableFeignClients注解中添加clients，指定具体FeignClient的字节码</p><h1 id="Gateway服务网关"><a href="#Gateway服务网关" class="headerlink" title="Gateway服务网关"></a><strong>Gateway服务网关</strong></h1><h2 id="为什么需要网关"><a href="#为什么需要网关" class="headerlink" title="为什么需要网关"></a><strong>为什么需要网关</strong></h2><p>网关功能:</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103100117614.png" alt="image-20221103100117614"></p><p>在SpringCloud中网关的实现包括两种：</p><ul><li>gateway</li><li>zuul</li></ul><p>Zuul是基于Servlet的是实现，属于阻塞式编程。二SpringCloudGateway则是基于Spring5中提供的WebFlux，属于响应式编程的实现，具备更好的性能。</p><h2 id="gateway快速入门"><a href="#gateway快速入门" class="headerlink" title="gateway快速入门"></a><strong>gateway快速入门</strong></h2><p>搭建网关服务的步骤：</p><p>1.创建新的module，引入SpringCloudGateway的依赖和Nacos的服务发现依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--网关依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--nacos服务发现依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>2.编写路由配置及nacos地址</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">server:</span><br><span class="hljs-symbol">  port:</span><span class="hljs-number">10010</span> <span class="hljs-meta">#网关端口</span><br><span class="hljs-symbol">spring:</span><br><span class="hljs-symbol">  application:</span><br><span class="hljs-symbol">    name:</span>gateway <span class="hljs-meta"># 服务名称</span><br><span class="hljs-symbol">  cloud:</span><br><span class="hljs-symbol">    nacos:</span><br>      server-addr:localhost:<span class="hljs-number">8848</span> <span class="hljs-meta"># nacos地址</span><br><span class="hljs-symbol">    gateway:</span><br><span class="hljs-symbol">      routes:</span><span class="hljs-meta">#网关路由配置</span><br>        - id:user-service <span class="hljs-meta"># 路由id，自定义，只要唯一即可</span><br>          <span class="hljs-meta"># uri: http:<span class="hljs-comment">//127.0.0.1:8081 #路由的目标地址 http就是固定地址</span></span><br><span class="hljs-symbol">          uri:</span>lb:<span class="hljs-comment">//userservice # 路由的目标地址 lb(loadBalance)就是负载均衡，后面跟服务名称</span><br><span class="hljs-symbol">          predicates:</span><span class="hljs-meta">#路由断言，也就是判断请求是否符合路由规则的条件</span><br>            - P<span class="hljs-attr">ath</span><span class="hljs-operator">=</span><span class="hljs-keyword">/user/</span>** <span class="hljs-meta">#这个是按照路径匹配，只要以/user/开头就符合要求</span><br></code></pre></td></tr></table></figure><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103100154232.png" alt="image-20221103100154232"></p><h3 id="总结-16"><a href="#总结-16" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>网关搭建步骤：</p><p>1.创建项目，引入nacos服务发现和gateway依赖</p><p>2.配置application.yml，包括服务基本信息、nacos地址、路由</p><p>路由配置包括：</p><p>1.路由id：路由的唯一标示</p><p>2.路由目标（uri）：路由的目标地址，http代表固定地址，lb代表根据服务名负载均衡</p><p>3.路由断言（predicates）：判断路由的规则，</p><p>4.路由过滤器（filters）：对请求或响应做处理</p><h2 id="路由断言工厂（Route-Predicate-Factory）"><a href="#路由断言工厂（Route-Predicate-Factory）" class="headerlink" title="路由断言工厂（Route Predicate Factory）"></a><strong>路由断言工厂（Route Predicate Factory）</strong></h2><ul><li>我们在配置文件中写的断言规则只是字符串，这些字符串会被Predicate Factory读取并处理，转变为路由判断的条件</li><li>例如Path&#x3D;&#x2F;user&#x2F;**是按照路径匹配，这个规则是由org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory类来处理的</li><li>像这样的断言工厂在SpringCloudGateway还有十几个</li></ul><p>Spring提供了十一种基本的Predicate工厂：</p><p><a href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-after-route-predicate-factory">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-after-route-predicate-factory</a></p><table><thead><tr><th>名称</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>After</td><td>是某个时间点后的请求</td><td>-  After&#x3D;2037-01-20T17:42:47.789-07:00[America&#x2F;Denver]</td></tr><tr><td>Before</td><td>是某个时间点之前的请求</td><td>-  Before&#x3D;2031-04-13T15:14:47.433+08:00[Asia&#x2F;Shanghai]</td></tr><tr><td>Between</td><td>是某两个时间点之前的请求</td><td>-  Between&#x3D;2037-01-20T17:42:47.789-07:00[America&#x2F;Denver],  2037-01-21T17:42:47.789-07:00[America&#x2F;Denver]</td></tr><tr><td>Cookie</td><td>请求必须包含某些cookie</td><td>- Cookie&#x3D;chocolate, ch.p</td></tr><tr><td>Header</td><td>请求必须包含某些header</td><td>- Header&#x3D;X-Request-Id, \d+</td></tr><tr><td>Host</td><td>请求必须是访问某个host（域名）</td><td>-  Host&#x3D;<strong>.somehost.org,</strong>.anotherhost.org</td></tr><tr><td>Method</td><td>请求方式必须是指定方式</td><td>- Method&#x3D;GET,POST</td></tr><tr><td>Path</td><td>请求路径必须符合指定规则</td><td>- Path&#x3D;&#x2F;red&#x2F;{segment},&#x2F;blue&#x2F;**</td></tr><tr><td>Query</td><td>请求参数必须包含指定参数</td><td>- Query&#x3D;name, Jack或者-  Query&#x3D;name</td></tr><tr><td>RemoteAddr</td><td>请求者的ip必须是指定范围</td><td>- RemoteAddr&#x3D;192.168.1.1&#x2F;24</td></tr><tr><td>Weight</td><td>权重处理</td><td></td></tr></tbody></table><h3 id="总结-17"><a href="#总结-17" class="headerlink" title="总结"></a><strong>总结</strong></h3><ul><li>lPredicateFactory的作用是什么？</li></ul><p>读取用户定义的断言条件，对请求做出判断</p><ul><li>lPath&#x3D;&#x2F;user&#x2F;**是什么含义？</li></ul><p>路径是以&#x2F;user开头的就认为是符合的</p><h2 id="过滤器工厂（GatewayFilter）"><a href="#过滤器工厂（GatewayFilter）" class="headerlink" title="过滤器工厂（GatewayFilter）"></a><strong>过滤器工厂（GatewayFilter）</strong></h2><p>GatewayFilter是网关中提供的一种过滤器，可以队进入网关的请求和微服务返回的相应做处理：</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103100301657.png" alt="image-20221103100301657"></p><p>Spring提供了31种不同的路由过滤器工厂：</p><p><a href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories</a></p><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>AddRequestHeader</td><td>给当前请求添加一个请求头</td></tr><tr><td>RemoveRequestHeader</td><td>移除请求中的一个请求头</td></tr><tr><td>AddResponseHeader</td><td>给响应结果中添加一个响应头</td></tr><tr><td>RemoveResponseHeader</td><td>从响应结果中移除有一个响应头</td></tr><tr><td>RequestRateLimiter</td><td>限制请求的流量</td></tr><tr><td>…</td><td></td></tr></tbody></table><p>给所有进入userservice的请求添加一个请求头：Truth&#x3D;itcast is freaking awesome！</p><p>实现方式：在gateway中修改application.yml文件，给userservice的路由添加过滤器</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103100317754.png" alt="image-20221103100317754"></p><p>默认过滤器</p><p>如果要对所有的路由都生效，则可以将过滤器工厂写道default下：</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103100326699.png" alt="image-20221103100326699"></p><h3 id="总结-18"><a href="#总结-18" class="headerlink" title="总结"></a><strong>总结</strong></h3><ul><li>过滤器的作用是什么？</li></ul><p>①对路由的请求或响应做加工处理，比如添加请求头</p><p>②配置在路由下的过滤器只对当前路由的请求生效</p><ul><li>defaultFilters的作用是什么？</li></ul><p>①对所有路由都生效的过滤器</p><h2 id="全局过滤器（GlobalFilter）"><a href="#全局过滤器（GlobalFilter）" class="headerlink" title="全局过滤器（GlobalFilter）"></a><strong>全局过滤器（GlobalFilter）</strong></h2><p>全局过滤器的作用也是处理一切进入网关的请求和微服务响应，与GatewayFilter的作用一样。</p><p>区别在于GatewayFilter通过配置定义，处理逻辑是固定的。而GlobalFilter的逻辑需要自己写代码实现。</p><p>定义方式是实现GlobalFilter接口。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">public</span><span class="hljs-keyword">interface</span> <span class="hljs-title class_">GlobalFilter</span>&#123;<br>   <span class="hljs-comment">/**  </span><br><span class="hljs-comment">    *  处理当前请求，有必要的话通过&#123;<span class="hljs-doctag">@link</span> GatewayFilterChain&#125;将请求交给下一个过滤器处理</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@paramexchange</span> 请求上下文，里面可以获取Request、Response等信息    </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@paramchain</span> 用来把请求委托给下一个过滤器    </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span>&#123;<span class="hljs-doctag">@code</span> Mono&lt;Void&gt;&#125; 返回标示当前过滤器业务结束    </span><br><span class="hljs-comment">    */</span>   <br>   Mono&lt;<span class="hljs-built_in">Void</span>&gt;filter(ServerWebExchange exchange, GatewayFilterChain chain);<br>&#125;<br></code></pre></td></tr></table></figure><p>案例：定义全局过滤器，拦截并判断用户身份</p><p>需求：定义全局过滤器，拦截请求，判断请求的参数是否满足下面条件：</p><ul><li>参数中是否有authorization，</li><li>authorization参数值是否为admin</li></ul><p>如果同时满足则放行，否则拦截</p><p>实现案例：</p><p>自定义类，实现GlobalFilter接口，添加@Order注解：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Order</span>(-<span class="hljs-number">1</span>)<br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizeFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlobalFilter</span>&#123;<br>    <span class="hljs-meta">@Override</span>    <br>    publicMono&lt;<span class="hljs-title class_">Void</span>&gt; <span class="hljs-title function_">filter</span>(<span class="hljs-params">ServerWebExchangeexchange, GatewayFilterChain chain</span>) &#123;<br>            <span class="hljs-comment">// 1.获取请求参数        </span><br>            <span class="hljs-title class_">MultiValueMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt;params = exchange.<span class="hljs-title function_">getRequest</span>().<span class="hljs-title function_">getQueryParams</span>();        <br>            <span class="hljs-comment">// 2.获取authorization参数        </span><br>            <span class="hljs-title class_">String</span> auth = params.<span class="hljs-title function_">getFirst</span>(<span class="hljs-string">&quot;authorization&quot;</span>);        <br>            <span class="hljs-comment">// 3.校验        </span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;admin&quot;</span>.<span class="hljs-title function_">equals</span>(auth)) &#123;<br>                  <span class="hljs-comment">// 放行            </span><br>                  <span class="hljs-keyword">return</span> chain.<span class="hljs-title function_">filter</span>(exchange);        <br>            &#125;        <br>            <span class="hljs-comment">// 4.拦截        </span><br>                  <span class="hljs-comment">// 4.1.禁止访问        </span><br>                  exchange.<span class="hljs-title function_">getResponse</span>().<span class="hljs-title function_">setStatusCode</span>(<span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">FORBIDDEN</span>);        <br>                  <span class="hljs-comment">// 4.2.结束处理        </span><br>                  <span class="hljs-keyword">return</span> exchange.<span class="hljs-title function_">getResponse</span>().<span class="hljs-title function_">setComplete</span>();    <br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a><strong>总结：</strong></h3><ul><li>全局过滤器的作用是什么？</li></ul><p>对所有路由都生效的过滤器，并且可以自定义处理逻辑</p><ul><li>实现全局过滤器的步骤？</li></ul><p>①实现GlobalFilter接口</p><p>②添加@Order注解或实现Ordered接口</p><p>③编写处理逻辑</p><h2 id="过滤器执行顺序"><a href="#过滤器执行顺序" class="headerlink" title="过滤器执行顺序"></a><strong>过滤器执行顺序</strong></h2><p>请求进入网关会碰到三类过滤器：当前路由的过滤器、DefaultFilter、GlobalFilter</p><p>请求路由后，会将当前路由过滤器和DefaultFilter、GlobalFilter，合并到一个过滤器链（集合）中，排序后依次执行每个过滤器</p><p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6-%E4%B8%80/image-20221103100443308.png" alt="image-20221103100443308"></p><ul><li>每一个过滤器都必须指定一个int类型的order值，<strong>order值越小，优先级越高，执行顺序越靠前。</strong></li><li>GlobalFilter通过实现Ordered接口，或者添加@Order注解来指定order值，由我们自己指定</li><li>路由过滤器和defaultFilter的order由Spring指定，默认是按照声明顺序从1递增。</li><li>当过滤器的order值一样时，会按照 defaultFilter &gt; 路由过滤器 &gt; GlobalFilter的顺序执行。</li></ul><p>可以参考下面几个类的源码来查看：</p><p>**org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator#getFilters()**方法是先加载defaultFilters，然后再加载某个route的filters，然后合并。</p><p><strong>org.springframework.cloud.gateway.handler.FilteringWebHandler#handle</strong>()方法会加载全局过滤器，与前面的过滤器合并后根据order排序，组织过滤器链</p><h3 id="总结-19"><a href="#总结-19" class="headerlink" title="总结"></a><strong>总结</strong></h3><ul><li>路由过滤器、defaultFilter、全局过滤器的执行顺序？</li></ul><p>①order值越小，优先级越高</p><p>②当order值一样时，顺序是defaultFilter最先，然后是局部的路由过滤器，最后是全局过滤器</p><h2 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a><strong>跨域问题</strong></h2><p>跨域：域名不一致就是跨域，主要包括：</p><ul><li><p>域名不同：<a href="http://www.taobao.com/">www.taobao.com</a> 和 <a href="http://www.taobao.org/">www.taobao.org</a> 和 <a href="http://www.jd.com/">www.jd.com</a> 和 miaosha.jd.com</p></li><li><p>域名相同，端口不同：localhost:8080和localhost8081</p></li></ul><p>跨域问题：浏览器禁止请求的发起者与服务端发生跨域ajax请求，请求被浏览器拦截的问题</p><p>解决方案：CORS</p><p>网关处理跨域采用的同样是CORS方案，并且只需要简单配置即可实现：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">spring:<br>  cloud:<br>      gateway:      <br>      # 。。。  <br>              globalcors: # 全局的跨域处理<br>                  add-to-simple-url-handler-mapping: true # 解决options请求被拦截问题<br>                  corsConfigurations:          <br>         &#x27;<span class="hljs-string">[/**]</span>&#x27;:            <br>             allowedOrigins: # 允许哪些网站的跨域请求<br>                        - <span class="hljs-string">&quot;http://localhost:8090&quot;</span>              <br>                        - <span class="hljs-string">&quot;http://www.leyou.com&quot;</span>            <br>             allowedMethods: # 允许的跨域ajax的请求方式<br>                       - <span class="hljs-string">&quot;<span class="hljs-keyword">GET</span>&quot;</span>              <br>                       - <span class="hljs-string">&quot;<span class="hljs-keyword">POST</span>&quot;</span>              <br>                       - <span class="hljs-string">&quot;<span class="hljs-keyword">DELETE</span>&quot;</span>              <br>                       - <span class="hljs-string">&quot;<span class="hljs-keyword">PUT</span>&quot;</span>              <br>                       - <span class="hljs-string">&quot;<span class="hljs-keyword">OPTIONS</span>&quot;</span>            <br>             allowedHeaders: <span class="hljs-string">&quot;*&quot;</span> # 允许在请求中携带的头信息<br>                     allowCredentials:true # 是否允许携带cookie<br>             maxAge:<span class="hljs-number">360000</span> # 这次跨域检测的有效期<br></code></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>微服务项目打包</title>
    <link href="/2022/10/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85/"/>
    <url>/2022/10/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85/</url>
    
    <content type="html"><![CDATA[<h1 id="微服务项目打包"><a href="#微服务项目打包" class="headerlink" title="微服务项目打包"></a>微服务项目打包</h1><h2 id="1、项目结构说明"><a href="#1、项目结构说明" class="headerlink" title="1、项目结构说明"></a>1、项目结构说明</h2><p><img src="/2022/10/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85/image-20221029104254419.png" alt="image-20221029104254419"></p><p>其中TakeAwayBack为父项目，其它项目为子项目，Common为其它项目所依赖的公共项目。</p><h2 id="2、打包步骤"><a href="#2、打包步骤" class="headerlink" title="2、打包步骤"></a>2、打包步骤</h2><h3 id="2-1、配置父项目的pom文件"><a href="#2-1、配置父项目的pom文件" class="headerlink" title="2.1、配置父项目的pom文件"></a>2.1、配置父项目的pom文件</h3><p>修改打包为pom（一般父级的打包方式为pom，所以只要有子项目的项目都需要配置packaging节点为pom。比如：如果MerchantsConsumer下有子项目那么该项目pon文件中的packaging节点也要配置为pom）</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br></code></pre></td></tr></table></figure><p>指定该父模块下面有哪些子模块</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>AdminConsumer<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>AdminProvider<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>BuyerConsumer<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>BuyerProvider<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>Common<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>MerchantsConsumer<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>MerchantsProvider<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>TakeawayGateway<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br></code></pre></td></tr></table></figure><p>指定Java的版本号</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>     <br></code></pre></td></tr></table></figure><p>在最外层的父项目配置apache的maven打包插件，其它该项目下的父项目不需要配置这个</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.19.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">skipTests</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">skipTests</span>&gt;</span>    <span class="hljs-comment">&lt;!--默认关掉单元测试 --&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><p>完整总父项目的pom文件如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>AdminConsumer<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>AdminProvider<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>BuyerConsumer<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>BuyerProvider<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>Common<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>MerchantsConsumer<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>MerchantsProvider<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>TakeawayGateway<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.takeaway<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>TakeAwayBack<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>TakeAwayBack<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.19.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">skipTests</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">skipTests</span>&gt;</span>    <span class="hljs-comment">&lt;!--默认关掉单元测试 --&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="2-2、配置子项目的pom文件"><a href="#2-2、配置子项目的pom文件" class="headerlink" title="2.2、配置子项目的pom文件"></a>2.2、配置子项目的pom文件</h3><p>在parent节点下面加上relativePath，作用是指明依赖哪个父模块pom文件(编写规则与绝对路径相对路径相似)</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>&gt;</span>../pom.xml<span class="hljs-tag">&lt;/<span class="hljs-name">relativePath</span>&gt;</span><br></code></pre></td></tr></table></figure><p>修改打包方式为jar</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br></code></pre></td></tr></table></figure><p>加上SpringBoot的maven打包插件，并且指定运行的主入口类(SpringBoot的maven产检，用这个产检打包的Jar包可以直接运行，但是不可依赖！)，如果该子项目需要被其他项目依赖，那么还需设置classifier节点为exec（不加会报错Cannot find Class）。（在这个项目中Common项目需要加，其它项目不用加）</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">classifier</span>&gt;</span>exec<span class="hljs-tag">&lt;/<span class="hljs-name">classifier</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">classifier</span>&gt;</span>exec<span class="hljs-tag">&lt;/<span class="hljs-name">classifier</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!-- 指定该Main Class为全局的唯一入口 --&gt;</span><br>                   <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>com.zzh.demo.EntiyApplication<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                   <span class="hljs-tag">&lt;<span class="hljs-name">layout</span>&gt;</span>ZIP<span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span><br>               <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>               <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                   <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                       <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                           <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><span class="hljs-comment">&lt;!--可以把依赖的包都打包到生成的Jar包中--&gt;</span><br>                       <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                   <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>               <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>           <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><p>指定一下build的编码规则</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br></code></pre></td></tr></table></figure><p>完整的pom文件为:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.takeaway<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>TakeAwayBack<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>&gt;</span>../pom.xml<span class="hljs-tag">&lt;/<span class="hljs-name">relativePath</span>&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.takeaway<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>AdminConsumer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>AdminConsumer<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>AdminConsumer<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-context<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.pagehelper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-netflix-hystrix --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!--WebSocket--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.75<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">classifier</span>&gt;</span>exec<span class="hljs-tag">&lt;/<span class="hljs-name">classifier</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!-- 指定该Main Class为全局的唯一入口 --&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>com.takeaway.adminconsumer.AdminConsumerApplication<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">layout</span>&gt;</span>ZIP<span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><span class="hljs-comment">&lt;!--可以把依赖的包都打包到生成的Jar包中--&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="2-3、项目总打包"><a href="#2-3、项目总打包" class="headerlink" title="2.3、项目总打包"></a>2.3、项目总打包</h3><p>点击maven中的package（第一次可以不clean，如果出错了请先clean之后再package）</p><p><img src="/2022/10/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85/image-20221029115316876.png" alt="image-20221029115316876"></p><p>打包完成如下图：</p><p><img src="/2022/10/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85/image-20221029115355897.png" alt="image-20221029115355897"></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务项目打包</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RabbitMQ部署指南</title>
    <link href="/2022/10/29/%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/"/>
    <url>/2022/10/29/%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/</url>
    
    <content type="html"><![CDATA[<h1 id="RabbitMQ部署指南"><a href="#RabbitMQ部署指南" class="headerlink" title="RabbitMQ部署指南"></a>RabbitMQ部署指南</h1><h1 id="1-单机部署"><a href="#1-单机部署" class="headerlink" title="1.单机部署"></a>1.单机部署</h1><p>我们在Centos7虚拟机中使用Docker来安装。</p><h2 id="1-1-下载镜像"><a href="#1-1-下载镜像" class="headerlink" title="1.1.下载镜像"></a>1.1.下载镜像</h2><p>方式一：在线拉取</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> pull rabbitmq:<span class="hljs-number">3</span>-management<br><br></code></pre></td></tr></table></figure><p>方式二：从本地加载</p><p>在课前资料已经提供了镜像包：</p><p><img src="/WEBRESOURCE0cbd3a023160ff7412cd9cf626deef19.png" alt="WEBRESOURCE0cbd3a023160ff7412cd9cf626deef19"></p><p>上传到虚拟机中后，使用命令加载镜像即可：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">docker load -<span class="hljs-selector-tag">i</span> mq<span class="hljs-selector-class">.tar</span><br><br></code></pre></td></tr></table></figure><h2 id="1-2-安装MQ"><a href="#1-2-安装MQ" class="headerlink" title="1.2.安装MQ"></a>1.2.安装MQ</h2><p>执行下面的命令来运行MQ容器：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs livescript">docker run <span class="hljs-string">\</span><br> -e RABBITMQ_DEFAULT_USER=itcast <span class="hljs-string">\</span><br> -e RABBITMQ_DEFAULT_PASS=<span class="hljs-number">123321</span> <span class="hljs-string">\</span><br> --name mq <span class="hljs-string">\</span><br> --hostname mq1 <span class="hljs-string">\</span><br> -p <span class="hljs-number">15672</span>:<span class="hljs-number">15672</span> <span class="hljs-string">\</span><br> -p <span class="hljs-number">5672</span>:<span class="hljs-number">5672</span> <span class="hljs-string">\</span><br> -d <span class="hljs-string">\</span><br> rabbitmq:<span class="hljs-number">3</span>-management<br><br></code></pre></td></tr></table></figure><h1 id="2-集群部署"><a href="#2-集群部署" class="headerlink" title="2.集群部署"></a>2.集群部署</h1><p>接下来，我们看看如何安装RabbitMQ的集群。</p><h2 id="2-1-集群分类"><a href="#2-1-集群分类" class="headerlink" title="2.1.集群分类"></a>2.1.集群分类</h2><p>在RabbitMQ的官方文档中，讲述了两种集群的配置方式：</p><ul><li><p>普通模式：普通模式集群不进行数据同步，每个MQ都有自己的队列、数据信息（其它元数据信息如交换机等会同步）。例如我们有2个MQ：mq1，和mq2，如果你的消息在mq1，而你连接到了mq2，那么mq2会去mq1拉取消息，然后返回给你。如果mq1宕机，消息就会丢失。</p></li><li><p>镜像模式：与普通模式不同，队列会在各个mq的镜像节点之间同步，因此你连接到任何一个镜像节点，均可获取到消息。而且如果一个节点宕机，并不会导致数据丢失。不过，这种方式增加了数据同步的带宽消耗。</p></li></ul><p>我们先来看普通模式集群。</p><h2 id="2-2-设置网络"><a href="#2-2-设置网络" class="headerlink" title="2.2.设置网络"></a>2.2.设置网络</h2><p>首先，我们需要让3台MQ互相知道对方的存在。</p><p>分别在3台机器中，设置 &#x2F;etc&#x2F;hosts文件，添加如下内容：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">192.168.150.101</span> mq1<br><span class="hljs-number">192.168.150.102</span> mq2<br><span class="hljs-number">192.168.150.103</span> mq3<br><br></code></pre></td></tr></table></figure><p>并在每台机器上测试，是否可以ping通对方：</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>中间件</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RabbitMQ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nacos集群搭建</title>
    <link href="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"/>
    <url>/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="Nacos集群搭建"><a href="#Nacos集群搭建" class="headerlink" title="Nacos集群搭建"></a>Nacos集群搭建</h1><h1 id="1-集群结构图"><a href="#1-集群结构图" class="headerlink" title="1.集群结构图"></a>1.集群结构图</h1><p>官方给出的Nacos集群图：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/image-20210409210621117.png"></p><p>其中包含3个nacos节点，然后一个负载均衡器代理3个Nacos。这里负载均衡器可以使用nginx。</p><p>我们计划的集群结构：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/image-20210409211355037.png"></p><p>三个nacos节点的地址：</p><table><thead><tr><th>节点</th><th>ip</th><th>port</th></tr></thead><tbody><tr><td>nacos1</td><td>192.168.150.1</td><td>8845</td></tr><tr><td>nacos2</td><td>192.168.150.1</td><td>8846</td></tr><tr><td>nacos3</td><td>192.168.150.1</td><td>8847</td></tr></tbody></table><h1 id="2-搭建集群"><a href="#2-搭建集群" class="headerlink" title="2.搭建集群"></a>2.搭建集群</h1><p>搭建集群的基本步骤：</p><ul><li><p>搭建数据库，初始化数据库表结构</p></li><li><p>下载nacos安装包</p></li><li><p>配置nacos</p></li><li><p>启动nacos集群</p></li><li><p>nginx反向代理</p></li></ul><h2 id="2-1-初始化数据库"><a href="#2-1-初始化数据库" class="headerlink" title="2.1.初始化数据库"></a>2.1.初始化数据库</h2><p>Nacos默认数据存储在内嵌数据库Derby中，不属于生产可用的数据库。</p><p>官方推荐的最佳实践是使用带有主从的高可用数据库集群，主从模式的高可用数据库可以参考传智教育的后续高手课程。</p><p>这里我们以单点的数据库为例来讲解。</p><p>首先新建一个数据库，命名为nacos，而后导入下面的SQL：</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">CREATE TABLE `config_info` (<br>  `id` bigint(<span class="hljs-number">20</span>) <span class="hljs-literal">NOT</span> NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,<br>  `dat<span class="hljs-built_in">a_id</span>` varchar(<span class="hljs-number">255</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;dat<span class="hljs-built_in">a_id</span>&#x27;,<br>  `group_id` varchar(<span class="hljs-number">255</span>) DEFAULT NULL,<br>  `content` longtext <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;content&#x27;,<br>  `md5` varchar(<span class="hljs-number">32</span>) DEFAULT NULL COMMENT &#x27;md5&#x27;,<br>  `gmt_create` datetime <span class="hljs-literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,<br>  `gmt_modified` datetime <span class="hljs-literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,<br>  `src_user` text COMMENT &#x27;source user&#x27;,<br>  `src_ip` varchar(<span class="hljs-number">50</span>) DEFAULT NULL COMMENT &#x27;source ip&#x27;,<br>  `app_name` varchar(<span class="hljs-number">128</span>) DEFAULT NULL,<br>  `tenant_id` varchar(<span class="hljs-number">128</span>) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,<br>  `c_desc` varchar(<span class="hljs-number">256</span>) DEFAULT NULL,<br>  `c_use` varchar(<span class="hljs-number">64</span>) DEFAULT NULL,<br>  `effect` varchar(<span class="hljs-number">64</span>) DEFAULT NULL,<br>  `type` varchar(<span class="hljs-number">64</span>) DEFAULT NULL,<br>  `c_schema` text,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `uk_configinfo_datagrouptenant` (`dat<span class="hljs-built_in">a_id</span>`,`group_id`,`tenant_id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info&#x27;<span class="hljs-comment">;</span><br><br><span class="hljs-comment">/******************************************/</span><br><span class="hljs-comment">/*   数据库全名 = nacos_config   */</span><br><span class="hljs-comment">/*   表名称 = config_info_aggr   */</span><br><span class="hljs-comment">/******************************************/</span><br>CREATE TABLE `config_info_aggr` (<br>  `id` bigint(<span class="hljs-number">20</span>) <span class="hljs-literal">NOT</span> NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,<br>  `dat<span class="hljs-built_in">a_id</span>` varchar(<span class="hljs-number">255</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;dat<span class="hljs-built_in">a_id</span>&#x27;,<br>  `group_id` varchar(<span class="hljs-number">255</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;group_id&#x27;,<br>  `datum_id` varchar(<span class="hljs-number">255</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;datum_id&#x27;,<br>  `content` longtext <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;内容&#x27;,<br>  `gmt_modified` datetime <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;修改时间&#x27;,<br>  `app_name` varchar(<span class="hljs-number">128</span>) DEFAULT NULL,<br>  `tenant_id` varchar(<span class="hljs-number">128</span>) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `uk_configinfoaggr_datagrouptenantdatum` (`dat<span class="hljs-built_in">a_id</span>`,`group_id`,`tenant_id`,`datum_id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;增加租户字段&#x27;<span class="hljs-comment">;</span><br><br><br><span class="hljs-comment">/******************************************/</span><br><span class="hljs-comment">/*   数据库全名 = nacos_config   */</span><br><span class="hljs-comment">/*   表名称 = config_info_beta   */</span><br><span class="hljs-comment">/******************************************/</span><br>CREATE TABLE `config_info_beta` (<br>  `id` bigint(<span class="hljs-number">20</span>) <span class="hljs-literal">NOT</span> NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,<br>  `dat<span class="hljs-built_in">a_id</span>` varchar(<span class="hljs-number">255</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;dat<span class="hljs-built_in">a_id</span>&#x27;,<br>  `group_id` varchar(<span class="hljs-number">128</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;group_id&#x27;,<br>  `app_name` varchar(<span class="hljs-number">128</span>) DEFAULT NULL COMMENT &#x27;app_name&#x27;,<br>  `content` longtext <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;content&#x27;,<br>  `bet<span class="hljs-built_in">a_ips</span>` varchar(<span class="hljs-number">1024</span>) DEFAULT NULL COMMENT &#x27;betaIps&#x27;,<br>  `md5` varchar(<span class="hljs-number">32</span>) DEFAULT NULL COMMENT &#x27;md5&#x27;,<br>  `gmt_create` datetime <span class="hljs-literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,<br>  `gmt_modified` datetime <span class="hljs-literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,<br>  `src_user` text COMMENT &#x27;source user&#x27;,<br>  `src_ip` varchar(<span class="hljs-number">50</span>) DEFAULT NULL COMMENT &#x27;source ip&#x27;,<br>  `tenant_id` varchar(<span class="hljs-number">128</span>) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `uk_configinfobet<span class="hljs-built_in">a_datagrouptenant</span>` (`dat<span class="hljs-built_in">a_id</span>`,`group_id`,`tenant_id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info_beta&#x27;<span class="hljs-comment">;</span><br><br><span class="hljs-comment">/******************************************/</span><br><span class="hljs-comment">/*   数据库全名 = nacos_config   */</span><br><span class="hljs-comment">/*   表名称 = config_info_tag   */</span><br><span class="hljs-comment">/******************************************/</span><br>CREATE TABLE `config_info_tag` (<br>  `id` bigint(<span class="hljs-number">20</span>) <span class="hljs-literal">NOT</span> NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,<br>  `dat<span class="hljs-built_in">a_id</span>` varchar(<span class="hljs-number">255</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;dat<span class="hljs-built_in">a_id</span>&#x27;,<br>  `group_id` varchar(<span class="hljs-number">128</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;group_id&#x27;,<br>  `tenant_id` varchar(<span class="hljs-number">128</span>) DEFAULT &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,<br>  `tag_id` varchar(<span class="hljs-number">128</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;tag_id&#x27;,<br>  `app_name` varchar(<span class="hljs-number">128</span>) DEFAULT NULL COMMENT &#x27;app_name&#x27;,<br>  `content` longtext <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;content&#x27;,<br>  `md5` varchar(<span class="hljs-number">32</span>) DEFAULT NULL COMMENT &#x27;md5&#x27;,<br>  `gmt_create` datetime <span class="hljs-literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,<br>  `gmt_modified` datetime <span class="hljs-literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,<br>  `src_user` text COMMENT &#x27;source user&#x27;,<br>  `src_ip` varchar(<span class="hljs-number">50</span>) DEFAULT NULL COMMENT &#x27;source ip&#x27;,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `uk_configinfotag_datagrouptenanttag` (`dat<span class="hljs-built_in">a_id</span>`,`group_id`,`tenant_id`,`tag_id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info_tag&#x27;<span class="hljs-comment">;</span><br><br><span class="hljs-comment">/******************************************/</span><br><span class="hljs-comment">/*   数据库全名 = nacos_config   */</span><br><span class="hljs-comment">/*   表名称 = config_tags_relation   */</span><br><span class="hljs-comment">/******************************************/</span><br>CREATE TABLE `config_tags_relation` (<br>  `id` bigint(<span class="hljs-number">20</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;id&#x27;,<br>  `tag_name` varchar(<span class="hljs-number">128</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;tag_name&#x27;,<br>  `tag_type` varchar(<span class="hljs-number">64</span>) DEFAULT NULL COMMENT &#x27;tag_type&#x27;,<br>  `dat<span class="hljs-built_in">a_id</span>` varchar(<span class="hljs-number">255</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;dat<span class="hljs-built_in">a_id</span>&#x27;,<br>  `group_id` varchar(<span class="hljs-number">128</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;group_id&#x27;,<br>  `tenant_id` varchar(<span class="hljs-number">128</span>) DEFAULT &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,<br>  `nid` bigint(<span class="hljs-number">20</span>) <span class="hljs-literal">NOT</span> NULL AUTO_INCREMENT,<br>  PRIMARY KEY (`nid`),<br>  UNIQUE KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),<br>  KEY `idx_tenant_id` (`tenant_id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_tag_relation&#x27;<span class="hljs-comment">;</span><br><br><span class="hljs-comment">/******************************************/</span><br><span class="hljs-comment">/*   数据库全名 = nacos_config   */</span><br><span class="hljs-comment">/*   表名称 = group_capacity   */</span><br><span class="hljs-comment">/******************************************/</span><br>CREATE TABLE `group_capacity` (<br>  `id` bigint(<span class="hljs-number">20</span>) unsigned <span class="hljs-literal">NOT</span> NULL AUTO_INCREMENT COMMENT &#x27;主键ID&#x27;,<br>  `group_id` varchar(<span class="hljs-number">128</span>) <span class="hljs-literal">NOT</span> NULL DEFAULT &#x27;&#x27; COMMENT &#x27;Group ID，空字符表示整个集群&#x27;,<br>  `quota` int(<span class="hljs-number">10</span>) unsigned <span class="hljs-literal">NOT</span> NULL DEFAULT &#x27;<span class="hljs-number">0</span>&#x27; COMMENT &#x27;配额，<span class="hljs-number">0</span>表示使用默认值&#x27;,<br>  `usage` int(<span class="hljs-number">10</span>) unsigned <span class="hljs-literal">NOT</span> NULL DEFAULT &#x27;<span class="hljs-number">0</span>&#x27; COMMENT &#x27;使用量&#x27;,<br>  `max_size` int(<span class="hljs-number">10</span>) unsigned <span class="hljs-literal">NOT</span> NULL DEFAULT &#x27;<span class="hljs-number">0</span>&#x27; COMMENT &#x27;单个配置大小上限，单位为字节，<span class="hljs-number">0</span>表示使用默认值&#x27;,<br>  `max_aggr_count` int(<span class="hljs-number">10</span>) unsigned <span class="hljs-literal">NOT</span> NULL DEFAULT &#x27;<span class="hljs-number">0</span>&#x27; COMMENT &#x27;聚合子配置最大个数，，<span class="hljs-number">0</span>表示使用默认值&#x27;,<br>  `max_aggr_size` int(<span class="hljs-number">10</span>) unsigned <span class="hljs-literal">NOT</span> NULL DEFAULT &#x27;<span class="hljs-number">0</span>&#x27; COMMENT &#x27;单个聚合数据的子配置大小上限，单位为字节，<span class="hljs-number">0</span>表示使用默认值&#x27;,<br>  `max_history_count` int(<span class="hljs-number">10</span>) unsigned <span class="hljs-literal">NOT</span> NULL DEFAULT &#x27;<span class="hljs-number">0</span>&#x27; COMMENT &#x27;最大变更历史数量&#x27;,<br>  `gmt_create` datetime <span class="hljs-literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,<br>  `gmt_modified` datetime <span class="hljs-literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `uk_group_id` (`group_id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;集群、各Group容量信息表&#x27;<span class="hljs-comment">;</span><br><br><span class="hljs-comment">/******************************************/</span><br><span class="hljs-comment">/*   数据库全名 = nacos_config   */</span><br><span class="hljs-comment">/*   表名称 = his_config_info   */</span><br><span class="hljs-comment">/******************************************/</span><br>CREATE TABLE `his_config_info` (<br>  `id` bigint(<span class="hljs-number">64</span>) unsigned <span class="hljs-literal">NOT</span> NULL,<br>  `nid` bigint(<span class="hljs-number">20</span>) unsigned <span class="hljs-literal">NOT</span> NULL AUTO_INCREMENT,<br>  `dat<span class="hljs-built_in">a_id</span>` varchar(<span class="hljs-number">255</span>) <span class="hljs-literal">NOT</span> NULL,<br>  `group_id` varchar(<span class="hljs-number">128</span>) <span class="hljs-literal">NOT</span> NULL,<br>  `app_name` varchar(<span class="hljs-number">128</span>) DEFAULT NULL COMMENT &#x27;app_name&#x27;,<br>  `content` longtext <span class="hljs-literal">NOT</span> NULL,<br>  `md5` varchar(<span class="hljs-number">32</span>) DEFAULT NULL,<br>  `gmt_create` datetime <span class="hljs-literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP,<br>  `gmt_modified` datetime <span class="hljs-literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP,<br>  `src_user` text,<br>  `src_ip` varchar(<span class="hljs-number">50</span>) DEFAULT NULL,<br>  `op_type` char(<span class="hljs-number">10</span>) DEFAULT NULL,<br>  `tenant_id` varchar(<span class="hljs-number">128</span>) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,<br>  PRIMARY KEY (`nid`),<br>  KEY `idx_gmt_create` (`gmt_create`),<br>  KEY `idx_gmt_modified` (`gmt_modified`),<br>  KEY `idx_did` (`dat<span class="hljs-built_in">a_id</span>`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;多租户改造&#x27;<span class="hljs-comment">;</span><br><br><br><span class="hljs-comment">/******************************************/</span><br><span class="hljs-comment">/*   数据库全名 = nacos_config   */</span><br><span class="hljs-comment">/*   表名称 = tenant_capacity   */</span><br><span class="hljs-comment">/******************************************/</span><br>CREATE TABLE `tenant_capacity` (<br>  `id` bigint(<span class="hljs-number">20</span>) unsigned <span class="hljs-literal">NOT</span> NULL AUTO_INCREMENT COMMENT &#x27;主键ID&#x27;,<br>  `tenant_id` varchar(<span class="hljs-number">128</span>) <span class="hljs-literal">NOT</span> NULL DEFAULT &#x27;&#x27; COMMENT &#x27;Tenant ID&#x27;,<br>  `quota` int(<span class="hljs-number">10</span>) unsigned <span class="hljs-literal">NOT</span> NULL DEFAULT &#x27;<span class="hljs-number">0</span>&#x27; COMMENT &#x27;配额，<span class="hljs-number">0</span>表示使用默认值&#x27;,<br>  `usage` int(<span class="hljs-number">10</span>) unsigned <span class="hljs-literal">NOT</span> NULL DEFAULT &#x27;<span class="hljs-number">0</span>&#x27; COMMENT &#x27;使用量&#x27;,<br>  `max_size` int(<span class="hljs-number">10</span>) unsigned <span class="hljs-literal">NOT</span> NULL DEFAULT &#x27;<span class="hljs-number">0</span>&#x27; COMMENT &#x27;单个配置大小上限，单位为字节，<span class="hljs-number">0</span>表示使用默认值&#x27;,<br>  `max_aggr_count` int(<span class="hljs-number">10</span>) unsigned <span class="hljs-literal">NOT</span> NULL DEFAULT &#x27;<span class="hljs-number">0</span>&#x27; COMMENT &#x27;聚合子配置最大个数&#x27;,<br>  `max_aggr_size` int(<span class="hljs-number">10</span>) unsigned <span class="hljs-literal">NOT</span> NULL DEFAULT &#x27;<span class="hljs-number">0</span>&#x27; COMMENT &#x27;单个聚合数据的子配置大小上限，单位为字节，<span class="hljs-number">0</span>表示使用默认值&#x27;,<br>  `max_history_count` int(<span class="hljs-number">10</span>) unsigned <span class="hljs-literal">NOT</span> NULL DEFAULT &#x27;<span class="hljs-number">0</span>&#x27; COMMENT &#x27;最大变更历史数量&#x27;,<br>  `gmt_create` datetime <span class="hljs-literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,<br>  `gmt_modified` datetime <span class="hljs-literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `uk_tenant_id` (`tenant_id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;租户容量信息表&#x27;<span class="hljs-comment">;</span><br><br><br>CREATE TABLE `tenant_info` (<br>  `id` bigint(<span class="hljs-number">20</span>) <span class="hljs-literal">NOT</span> NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,<br>  `kp` varchar(<span class="hljs-number">128</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;kp&#x27;,<br>  `tenant_id` varchar(<span class="hljs-number">128</span>) default &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,<br>  `tenant_name` varchar(<span class="hljs-number">128</span>) default &#x27;&#x27; COMMENT &#x27;tenant_name&#x27;,<br>  `tenant_desc` varchar(<span class="hljs-number">256</span>) DEFAULT NULL COMMENT &#x27;tenant_desc&#x27;,<br>  `create_source` varchar(<span class="hljs-number">32</span>) DEFAULT NULL COMMENT &#x27;create_source&#x27;,<br>  `gmt_create` bigint(<span class="hljs-number">20</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;创建时间&#x27;,<br>  `gmt_modified` bigint(<span class="hljs-number">20</span>) <span class="hljs-literal">NOT</span> NULL COMMENT &#x27;修改时间&#x27;,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),<br>  KEY `idx_tenant_id` (`tenant_id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;tenant_info&#x27;<span class="hljs-comment">;</span><br><br>CREATE TABLE `users` (<br>`username` varchar(<span class="hljs-number">50</span>) <span class="hljs-literal">NOT</span> NULL PRIMARY KEY,<br>`password` varchar(<span class="hljs-number">500</span>) <span class="hljs-literal">NOT</span> NULL,<br>`enabled` boolean <span class="hljs-literal">NOT</span> NULL<br>)<span class="hljs-comment">;</span><br><br>CREATE TABLE `roles` (<br>`username` varchar(<span class="hljs-number">50</span>) <span class="hljs-literal">NOT</span> NULL,<br>`role` varchar(<span class="hljs-number">50</span>) <span class="hljs-literal">NOT</span> NULL,<br>UNIQUE INDEX `idx_user_role` (`username` ASC, `role` ASC) USING BTREE<br>)<span class="hljs-comment">;</span><br><br>CREATE TABLE `permissions` (<br>    `role` varchar(<span class="hljs-number">50</span>) <span class="hljs-literal">NOT</span> NULL,<br>    `resource` varchar(<span class="hljs-number">255</span>) <span class="hljs-literal">NOT</span> NULL,<br>    `action` varchar(<span class="hljs-number">8</span>) <span class="hljs-literal">NOT</span> NULL,<br>    UNIQUE INDEX `uk_role_permission` (`role`,`resource`,`action`) USING BTREE<br>)<span class="hljs-comment">;</span><br><br>INSERT INTO users (username, password, enabled) VALUES (&#x27;nacos&#x27;, &#x27;$<span class="hljs-number">2</span>a$<span class="hljs-number">10</span>$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu&#x27;, <span class="hljs-literal">TRUE</span>)<span class="hljs-comment">;</span><br><br>INSERT INTO roles (username, role) VALUES (&#x27;nacos&#x27;, &#x27;ROLE_ADMIN&#x27;)<span class="hljs-comment">;</span><br><br></code></pre></td></tr></table></figure><h2 id="2-2-下载nacos"><a href="#2-2-下载nacos" class="headerlink" title="2.2.下载nacos"></a>2.2.下载nacos</h2><p>nacos在GitHub上有下载地址：<a href="https://github.com/alibaba/nacos/tags%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%89%E6%8B%A9%E4%BB%BB%E6%84%8F%E7%89%88%E6%9C%AC%E4%B8%8B%E8%BD%BD%E3%80%82">https://github.com/alibaba/nacos/tags，可以选择任意版本下载。</a></p><p>本例中才用1.4.1版本：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/image-20210409212119411.png"></p><h2 id="2-3-配置Nacos"><a href="#2-3-配置Nacos" class="headerlink" title="2.3.配置Nacos"></a>2.3.配置Nacos</h2><p>将这个包解压到任意非中文目录下，如图：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/image-20210402161843337.png"></p><p>目录说明：</p><ul><li><p>bin：启动脚本</p></li><li><p>conf：配置文件</p></li></ul><p>进入nacos的conf目录，修改配置文件cluster.conf.example，重命名为cluster.conf：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/image-20210409212459292.png"></p><p>然后添加内容：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">127.0.0.1:8845</span><br><span class="hljs-number">127.0.0.1</span>.<span class="hljs-number">8846</span><br><span class="hljs-number">127.0.0.1</span>.<span class="hljs-number">8847</span><br><br></code></pre></td></tr></table></figure><p>然后修改application.properties文件，添加数据库配置</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">spring.datasource.platform</span>=mysql<br><br><span class="hljs-attr">db.num</span>=<span class="hljs-number">1</span><br><br><span class="hljs-attr">db.url.0</span>=jdbc:mysql://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">3306</span>/nacos?characterEncoding=utf8&amp;connectTimeout=<span class="hljs-number">1000</span>&amp;socketTimeout=<span class="hljs-number">3000</span>&amp;autoReconnect=<span class="hljs-literal">true</span>&amp;useUnicode=<span class="hljs-literal">true</span>&amp;useSSL=<span class="hljs-literal">false</span>&amp;serverTimezone=UTC<br><span class="hljs-attr">db.user.0</span>=root<br><span class="hljs-attr">db.password.0</span>=<span class="hljs-number">123</span><br><br></code></pre></td></tr></table></figure><h2 id="2-4-启动"><a href="#2-4-启动" class="headerlink" title="2.4.启动"></a>2.4.启动</h2><p>将nacos文件夹复制三份，分别命名为：nacos1、nacos2、nacos3</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/image-20210409213335538.png"></p><p>然后分别修改三个文件夹中的application.properties，</p><p>nacos1:</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-title">server</span>.<span class="hljs-keyword">port</span>=8845<br><br></code></pre></td></tr></table></figure><p>nacos2:</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-title">server</span>.<span class="hljs-keyword">port</span>=8846<br><br></code></pre></td></tr></table></figure><p>nacos3:</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-title">server</span>.<span class="hljs-keyword">port</span>=8847<br><br></code></pre></td></tr></table></figure><p>然后分别启动三个nacos节点：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dos">startup.<span class="hljs-built_in">cmd</span><br><br></code></pre></td></tr></table></figure><h2 id="2-5-nginx反向代理"><a href="#2-5-nginx反向代理" class="headerlink" title="2.5.nginx反向代理"></a>2.5.nginx反向代理</h2><p>找到课前资料提供的nginx安装包：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/image-20210410103253355.png"></p><p>解压到任意非中文目录下：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/image-20210410103322874.png"></p><p>修改conf&#x2F;nginx.conf文件，配置如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">upstream</span> nacos-cluster &#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:8845</span>;<br><span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:8846</span>;<br><span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:8847</span>;<br>&#125;<br><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span>  localhost;<br><br>    <span class="hljs-section">location</span> /nacos &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://nacos-cluster;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>而后在浏览器访问：<a href="http://localhost/nacos%E5%8D%B3%E5%8F%AF%E3%80%82">http://localhost/nacos即可。</a></p><p>代码中application.yml文件配置如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:80</span> <span class="hljs-comment"># Nacos地址</span><br><br></code></pre></td></tr></table></figure><h2 id="2-6-优化"><a href="#2-6-优化" class="headerlink" title="2.6.优化"></a>2.6.优化</h2><ul><li><p>实际部署时，需要给做反向代理的nginx服务器设置一个域名，这样后续如果有服务器迁移nacos的客户端也无需更改配置.</p></li><li><p>Nacos的各个节点应该部署到多个不同服务器，做好容灾和隔离</p></li></ul><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>容器化技术</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Nacos集群搭建</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nacos安装指南</title>
    <link href="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/"/>
    <url>/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/</url>
    
    <content type="html"><![CDATA[<h1 id="Nacos安装指南"><a href="#Nacos安装指南" class="headerlink" title="Nacos安装指南"></a>Nacos安装指南</h1><p><a href="C:/Users/Kblayt/Desktop/youdaonote/youdaonote-pull/youdaonote/youdaonote-attachments/WEBRESOURCE33c451eccdc661d94d641a1b381f2af1Nacos.xmind">Nacos.xmind</a></p><h1 id="1-Windows安装"><a href="#1-Windows安装" class="headerlink" title="1.Windows安装"></a>1.Windows安装</h1><p>开发阶段采用单机安装即可。</p><h2 id="1-1-下载安装包"><a href="#1-1-下载安装包" class="headerlink" title="1.1.下载安装包"></a>1.1.下载安装包</h2><p>在Nacos的GitHub页面，提供有下载链接，可以下载编译好的Nacos服务端或者源代码：</p><p>GitHub主页：<a href="https://github.com/alibaba/nacos">https://github.com/alibaba/nacos</a></p><p>GitHub的Release下载页：<a href="https://github.com/alibaba/nacos/releases">https://github.com/alibaba/nacos/releases</a></p><p>如图：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402161102887.png" alt="image-20210402161102887"></p><p>本课程采用1.4.1.版本的Nacos，课前资料已经准备了安装包：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402161130261.png" alt="image-20210402161130261"></p><p>windows版本使用nacos-server-1.4.1.zip包即可。</p><h2 id="1-2-解压"><a href="#1-2-解压" class="headerlink" title="1.2.解压"></a>1.2.解压</h2><p>将这个包解压到任意非中文目录下，如图：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402161843337.png" alt="image-20210402161843337"></p><p>目录说明：</p><ul><li><p>bin：启动脚本</p></li><li><p>conf：配置文件</p></li></ul><h2 id="1-3-端口配置"><a href="#1-3-端口配置" class="headerlink" title="1.3.端口配置"></a>1.3.端口配置</h2><p>Nacos的默认端口是8848，如果你电脑上的其它进程占用了8848端口，请先尝试关闭该进程。</p><p>如果无法关闭占用8848端口的进程，也可以进入nacos的conf目录，修改配置文件中的端口：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402162008280.png" alt="image-20210402162008280"></p><p>修改其中的内容：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402162251093.png" alt="image-20210402162251093"></p><h2 id="1-4-启动"><a href="#1-4-启动" class="headerlink" title="1.4.启动"></a>1.4.启动</h2><p>启动非常简单，进入bin目录，结构如下：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402162350977.png" alt="image-20210402162350977"></p><p>然后执行命令即可：</p><ul><li>windows命令：</li></ul><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dos">startup.<span class="hljs-built_in">cmd</span> -m standalone<br><br></code></pre></td></tr></table></figure><p>执行后的效果如图：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402162526774.png" alt="image-20210402162526774"></p><h2 id="1-5-访问"><a href="#1-5-访问" class="headerlink" title="1.5.访问"></a>1.5.访问</h2><p>在浏览器输入地址：<a href="http://127.0.0.1:8848/nacos%E5%8D%B3%E5%8F%AF%EF%BC%9A">http://127.0.0.1:8848/nacos即可：</a></p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402162630427.png" alt="image-20210402162630427"></p><p>默认的账号和密码都是nacos，进入后：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402162709515.png" alt="image-20210402162709515"></p><h1 id="2-Linux安装"><a href="#2-Linux安装" class="headerlink" title="2.Linux安装"></a>2.Linux安装</h1><p>Linux或者Mac安装方式与Windows类似。</p><h2 id="2-1-安装JDK"><a href="#2-1-安装JDK" class="headerlink" title="2.1.安装JDK"></a>2.1.安装JDK</h2><p>Nacos依赖于JDK运行，索引Linux上也需要安装JDK才行。</p><p>上传jdk安装包：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402172334810.png" alt="image-20210402172334810"></p><p>上传到某个目录，例如：&#x2F;usr&#x2F;local&#x2F;</p><p>然后解压缩：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">tar -xvf jdk-<span class="hljs-number">8</span>u144-linux-x64<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span><br><br></code></pre></td></tr></table></figure><p>然后重命名为java</p><p>配置环境变量：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">export</span> <span class="hljs-attribute">JAVA_HOME</span>=/usr/local/java<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-variable">$PATH</span>:$JAVA_HOME/bin<br><br></code></pre></td></tr></table></figure><p>设置环境变量：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">source</span> <span class="hljs-regexp">/etc/</span>profile<br><br></code></pre></td></tr></table></figure><h2 id="2-2-上传安装包"><a href="#2-2-上传安装包" class="headerlink" title="2.2.上传安装包"></a>2.2.上传安装包</h2><p>如图：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402161102887.png" alt="image-20210402161102887"></p><p>也可以直接使用课前资料中的tar.gz：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402161130261.png" alt="image-20210402161130261"></p><p>上传到Linux服务器的某个目录，例如&#x2F;usr&#x2F;local&#x2F;src目录下：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402163715580.png" alt="image-20210402163715580"></p><h2 id="2-3-解压"><a href="#2-3-解压" class="headerlink" title="2.3.解压"></a>2.3.解压</h2><p>命令解压缩安装包：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">tar</span> -xvf nacos-server-<span class="hljs-number">1</span>.<span class="hljs-number">4</span>.<span class="hljs-number">1</span>.tar.gz<br><br></code></pre></td></tr></table></figure><p>然后删除安装包：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">rm</span> -rf nacos-server-<span class="hljs-number">1</span>.<span class="hljs-number">4</span>.<span class="hljs-number">1</span>.tar.gz<br><br></code></pre></td></tr></table></figure><p>目录中最终样式：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402163858429.png" alt="image-20210402163858429"></p><p>目录内部：</p><p><img src="/2022/10/29/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/image-20210402164414827.png" alt="image-20210402164414827"></p><h2 id="2-4-端口配置"><a href="#2-4-端口配置" class="headerlink" title="2.4.端口配置"></a>2.4.端口配置</h2><p>与windows中类似</p><h2 id="2-5-启动"><a href="#2-5-启动" class="headerlink" title="2.5.启动"></a>2.5.启动</h2><p>在nacos&#x2F;bin目录中，输入命令启动Nacos：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">sh </span>startup.<span class="hljs-keyword">sh </span>-m standalone<br><br></code></pre></td></tr></table></figure><h1 id="3-Nacos的依赖"><a href="#3-Nacos的依赖" class="headerlink" title="3.Nacos的依赖"></a>3.Nacos的依赖</h1><p>父工程：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>客户端：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- nacos客户端依赖包 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><br></code></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>容器化技术</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Nacos安装指南</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Centos7安装Docker</title>
    <link href="/2022/10/29/%E4%B8%AD%E9%97%B4%E4%BB%B6/Centos7%E5%AE%89%E8%A3%85Docker/"/>
    <url>/2022/10/29/%E4%B8%AD%E9%97%B4%E4%BB%B6/Centos7%E5%AE%89%E8%A3%85Docker/</url>
    
    <content type="html"><![CDATA[<h1 id="0-安装Docker"><a href="#0-安装Docker" class="headerlink" title="0.安装Docker"></a>0.安装Docker</h1><p>Docker 分为 CE 和 EE 两大版本。CE 即社区版（免费，支持周期 7 个月），EE 即企业版，强调安全，付费使用，支持周期 24 个月。</p><p>Docker CE 分为 stable test 和 nightly 三个更新频道。</p><p>官方网站上有各种环境下的 安装指南，这里主要介绍 Docker CE 在 CentOS上的安装。</p><h1 id="1-CentOS安装Docker"><a href="#1-CentOS安装Docker" class="headerlink" title="1.CentOS安装Docker"></a>1.CentOS安装Docker</h1><p>Docker CE 支持 64 位版本 CentOS 7，并且要求内核版本不低于 3.10， CentOS 7 满足最低内核的要求，所以我们在CentOS 7安装Docker。</p><h2 id="1-1-卸载（可选）"><a href="#1-1-卸载（可选）" class="headerlink" title="1.1.卸载（可选）"></a>1.1.卸载（可选）</h2><p>如果之前安装过旧版本的Docker，可以使用下面命令卸载：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs livescript">yum remove docker <span class="hljs-string">\</span><br>                  docker-client <span class="hljs-string">\</span><br>                  docker-client-latest <span class="hljs-string">\</span><br>                  docker-common <span class="hljs-string">\</span><br>                  docker-latest <span class="hljs-string">\</span><br>                  docker-latest-logrotate <span class="hljs-string">\</span><br>                  docker-logrotate <span class="hljs-string">\</span><br>                  docker-selinux <span class="hljs-string">\</span><br>                  docker-engine-selinux <span class="hljs-string">\</span><br>                  docker-engine <span class="hljs-string">\</span><br>                  docker-ce<br><br></code></pre></td></tr></table></figure><h2 id="1-2-安装docker"><a href="#1-2-安装docker" class="headerlink" title="1.2.安装docker"></a>1.2.安装docker</h2><p>首先需要大家虚拟机联网，安装yum工具</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">yum</span> install -y yum-utils \<br>           device-mapper-persistent-<span class="hljs-class"><span class="hljs-keyword">data</span> \</span><br>           lvm2 <span class="hljs-comment">--skip-broken</span><br><br></code></pre></td></tr></table></figure><p>然后更新本地镜像源：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 设置docker镜像源</span><br>yum-config-manager \<br>    --add-repo \<br>    https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/docker-ce/</span>linux<span class="hljs-regexp">/centos/</span>docker-ce.repo<br>    <br>sed -i <span class="hljs-string">&#x27;s/download.docker.com/mirrors.aliyun.com\/docker-ce/g&#x27;</span> <span class="hljs-regexp">/etc/yum</span>.repos.d/docker-ce.repo<br><br>yum makecache fast<br><br></code></pre></td></tr></table></figure><p>然后输入命令：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> -y docker-ce<br><br></code></pre></td></tr></table></figure><p>docker-ce为社区免费版本。稍等片刻，docker即可安装成功。</p><h2 id="1-3-启动docker"><a href="#1-3-启动docker" class="headerlink" title="1.3.启动docker"></a>1.3.启动docker</h2><p>Docker应用需要用到各种端口，逐一去修改防火墙设置。非常麻烦，因此建议大家直接关闭防火墙！</p><p>启动docker前，一定要关闭防火墙后！！</p><p>启动docker前，一定要关闭防火墙后！！</p><p>启动docker前，一定要关闭防火墙后！！</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-meta"># 关闭</span><br>systemctl <span class="hljs-keyword">stop</span> firewalld<br><span class="hljs-meta"># 禁止开机启动防火墙</span><br>systemctl <span class="hljs-keyword">disable</span> firewalld<br><br></code></pre></td></tr></table></figure><p>通过命令启动docker：</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-params">system</span>ctl start docker  <span class="hljs-comment"># 启动docker服务</span><br><br><span class="hljs-params">system</span>ctl stop docker  <span class="hljs-comment"># 停止docker服务</span><br><br><span class="hljs-params">system</span>ctl restart docker  <span class="hljs-comment"># 重启docker服务</span><br><br></code></pre></td></tr></table></figure><p>然后输入命令，可以查看docker版本：</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">docker -v</span><br><br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="/Centos7%E5%AE%89%E8%A3%85Docker/WEBRESOURCE0cc64d0658051d2e441626162799fd29.png" alt="WEBRESOURCE0cc64d0658051d2e441626162799fd29"></p><h2 id="1-4-配置镜像加速"><a href="#1-4-配置镜像加速" class="headerlink" title="1.4.配置镜像加速"></a>1.4.配置镜像加速</h2><p>docker官方镜像仓库网速较差，我们需要设置国内镜像服务：</p><p>参考阿里云的镜像加速文档：<a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</a></p><h1 id="2-CentOS7安装DockerCompose"><a href="#2-CentOS7安装DockerCompose" class="headerlink" title="2.CentOS7安装DockerCompose"></a>2.CentOS7安装DockerCompose</h1><h2 id="2-1-下载"><a href="#2-1-下载" class="headerlink" title="2.1.下载"></a>2.1.下载</h2><p>Linux下需要通过命令下载：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 安装</span><br>curl -L https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/docker/</span>compose<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/1.23.1/</span>docker-compose-`uname -s`-`uname -m` &gt; <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>docker-compose<br><br></code></pre></td></tr></table></figure><p>如果下载速度较慢，或者下载失败，可以使用课前资料提供的docker-compose文件：</p><p><img src="/Centos7%E5%AE%89%E8%A3%85Docker/WEBRESOURCE87edc261969e51ab61c4107bd9b6725b.png" alt="WEBRESOURCE87edc261969e51ab61c4107bd9b6725b"></p><p>上传到&#x2F;usr&#x2F;local&#x2F;bin&#x2F;目录也可以。</p><h2 id="2-2-修改文件权限"><a href="#2-2-修改文件权限" class="headerlink" title="2.2.修改文件权限"></a>2.2.修改文件权限</h2><p>修改文件权限：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 修改权限</span><br>chmod +x <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>docker-compose<br><br></code></pre></td></tr></table></figure><h2 id="2-3-Base自动补全命令："><a href="#2-3-Base自动补全命令：" class="headerlink" title="2.3.Base自动补全命令："></a>2.3.Base自动补全命令：</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 补全命令</span><br>curl -L https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/docker/</span>compose<span class="hljs-regexp">/1.29.1/</span>contrib<span class="hljs-regexp">/completion/</span>bash<span class="hljs-regexp">/docker-compose &gt; /</span>etc<span class="hljs-regexp">/bash_completion.d/</span>docker-compose<br><br></code></pre></td></tr></table></figure><p>如果这里出现错误，需要修改自己的hosts文件：</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arcade">echo <span class="hljs-string">&quot;199.232.68.133 raw.githubusercontent.com&quot;</span> &gt;&gt; <span class="hljs-regexp">/etc/</span>hosts<br><br></code></pre></td></tr></table></figure><h1 id="3-Docker镜像仓库"><a href="#3-Docker镜像仓库" class="headerlink" title="3.Docker镜像仓库"></a>3.Docker镜像仓库</h1><p>搭建镜像仓库可以基于Docker官方提供的DockerRegistry来实现。</p><p>官网地址：<a href="https://hub.docker.com/_/registry">https://hub.docker.com/_/registry</a></p><h2 id="3-1-简化版镜像仓库"><a href="#3-1-简化版镜像仓库" class="headerlink" title="3.1.简化版镜像仓库"></a>3.1.简化版镜像仓库</h2><p>Docker官方的Docker Registry是一个基础版本的Docker镜像仓库，具备仓库管理的完整功能，但是没有图形化界面。</p><p>搭建方式比较简单，命令如下：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs livescript">docker run -d <span class="hljs-string">\</span><br>    --restart=always <span class="hljs-string">\</span><br>    --name registry<span class="hljs-string">\</span><br>    -p <span class="hljs-number">5000</span>:<span class="hljs-number">5000</span> <span class="hljs-string">\</span><br>    -v registry-data:/<span class="hljs-keyword">var</span>/lib/registry <span class="hljs-string">\</span><br>    registry<br><br></code></pre></td></tr></table></figure><p>命令中挂载了一个数据卷registry-data到容器内的&#x2F;var&#x2F;lib&#x2F;registry 目录，这是私有镜像库存放数据的目录。</p><p>访问<a href="http://yourip:5000/v2/_catalog">http://YourIp:5000/v2/_catalog</a> 可以查看当前私有镜像服务中包含的镜像</p><h2 id="3-2-带有图形化界面版本"><a href="#3-2-带有图形化界面版本" class="headerlink" title="3.2.带有图形化界面版本"></a>3.2.带有图形化界面版本</h2><p>使用DockerCompose部署带有图象界面的DockerRegistry，命令如下：</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">version</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&#x27;3.0&#x27;</span><br><span class="hljs-attribute">services</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">registry</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">image</span><span class="hljs-punctuation">:</span> <span class="hljs-string">registry</span><br>    <span class="hljs-attribute">volumes</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./registry-data:/var/lib/registry</span><br>  <span class="hljs-attribute">ui</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">image</span><span class="hljs-punctuation">:</span> <span class="hljs-string">joxit/docker-registry-ui:static</span><br>    <span class="hljs-attribute">ports</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">8080:80</span><br>    <span class="hljs-attribute">environment</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">REGISTRY_TITLE=传智教育私有仓库</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">REGISTRY_URL=http://registry:5000</span><br>    <span class="hljs-attribute">depends_on</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">registry</span><br><br></code></pre></td></tr></table></figure><h2 id="3-3-配置Docker信任地址"><a href="#3-3-配置Docker信任地址" class="headerlink" title="3.3.配置Docker信任地址"></a>3.3.配置Docker信任地址</h2><p>我们的私服采用的是http协议，默认不被Docker信任，所以需要做一个配置：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 打开要修改的文件</span><br>vi <span class="hljs-regexp">/etc/</span>docker/daemon.json<br><span class="hljs-comment"># 添加内容：</span><br><span class="hljs-string">&quot;insecure-registries&quot;</span>:[<span class="hljs-string">&quot;http://192.168.150.101:8080&quot;</span>]<br><span class="hljs-comment"># 重加载</span><br>systemctl daemon-reload<br><span class="hljs-comment"># 重启docker</span><br>systemctl restart docker<br><br></code></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>中间件</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Centos7安装Docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>并发编程与多线程</title>
    <link href="/2022/10/28/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    <url>/2022/10/28/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="1、什么是并发与并行"><a href="#1、什么是并发与并行" class="headerlink" title="1、什么是并发与并行"></a>1、什么是并发与并行</h1><p>并行：之两个或多个时间在<strong>同一时刻</strong>发生（同时发生）</p><p>并发：之两个或多个时间在<strong>同一个时间段内</strong>发生。</p><p><img src="/2022/10/28/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/image-20221103140028421.png" alt="image-20221103140028421"></p><h1 id="2、什么是进程、线程"><a href="#2、什么是进程、线程" class="headerlink" title="2、什么是进程、线程"></a>2、什么是进程、线程</h1><p><strong>进程：</strong></p><ul><li>进程是正在运行的程序的实例。</li><li>进程是线程的容器，即一个进程中可以开启多个线程。</li><li>比如打开一个浏览器、打开一个word等操作，都会创建进程。</li></ul><p><strong>线程：</strong></p><ul><li>线程是进程内部的一个独立执行单元。</li><li>一个进程可以同时并发运行多个线程。</li><li>比如进程可以理解为医院，线程是挂号、就诊、缴费、拿药等业务活动</li></ul><p><strong>多线程</strong>：多个线程并发执行</p><h1 id="3、线程创建"><a href="#3、线程创建" class="headerlink" title="3、线程创建"></a>3、线程创建</h1><p>Java中线程有四种创建方式：</p><ul><li>继承Thread类</li><li>实现Runnable接口</li><li>实现Callable接口</li><li>线程池</li></ul><h2 id="3-1、继承Thread类"><a href="#3-1、继承Thread类" class="headerlink" title="3.1、继承Thread类"></a>3.1、继承Thread类</h2><p><strong>MyThread.class</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span></span>&#123;<br><br>public void run()&#123;<br><span class="hljs-keyword">for</span>(int i&lt;<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++)&#123;<br><span class="hljs-type">System</span>.out.println(<span class="hljs-string">&quot;myThread执行了:&quot;</span>+<span class="hljs-keyword">new</span> <span class="hljs-type">Date</span>().getTime());<br>&#125;<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ThreadCreateDemo.class:</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadCreateDemo</span>&#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>)&#123;<br><span class="hljs-comment">//1.创建自定义线程类实例</span><br><span class="hljs-title class_">MyThread</span> myThread = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyThread</span>();<br><span class="hljs-comment">//2.启动线程</span><br>myThread.<span class="hljs-title function_">start</span>();<br><span class="hljs-comment">//3.在main主线程打印行信息</span><br><span class="hljs-keyword">for</span>(int i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++)&#123;<br><span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;main主线程执行了：&quot;</span>+<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>());<br>&#125;<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-2、实现Runnable接口"><a href="#3-2、实现Runnable接口" class="headerlink" title="3.2、实现Runnable接口"></a>3.2、实现Runnable接口</h2><p><strong>MyRunnable.class:</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyRunnable</span> <span class="hljs-title">implements</span> <span class="hljs-title">Runnable</span>&#123;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span>&#123;<br><span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++)&#123;<br>System.<span class="hljs-keyword">out</span>.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;执行时间是：&quot;</span>+<span class="hljs-keyword">new</span> Date().getTime()+<span class="hljs-string">&quot;;执行次数是：&quot;</span>+i)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ThreadCreateDemo.class:</strong></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadCreateDemo</span>&#123;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span></span>&#123;<br><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++)&#123;<br>System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;main主线程执行了：&quot;</span>+<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().<span class="hljs-built_in">getTime</span>());<br>&#125;<br><span class="hljs-comment">//通过thread类执行MyRunnable类</span><br>Thread thread = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">MyRunnable</span>(),<span class="hljs-string">&quot;MyRunnable&quot;</span>);<br>thread.<span class="hljs-built_in">start</span>();<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-3、实现Callable接口"><a href="#3-3、实现Callable接口" class="headerlink" title="3.3、实现Callable接口"></a>3.3、实现Callable接口</h2><p>Callable需要使用FutureTask类帮助执行，FutureTask类结构如下：</p><p><img src="/2022/10/28/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/image-20221103142346879.png" alt="image-20221103142346879"></p><p>Future接口：</p><ul><li>判断任务是否完成：isDone()</li><li>能够终端任务：cancel()</li><li>能够获取任务执行结果：get()</li></ul><p><strong>MyCallable.class:</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-built_in">public</span> <span class="hljs-keyword">class</span> MyCallable implements Callable&lt;String&gt;&#123;<br><span class="hljs-built_in">public</span> String <span class="hljs-keyword">call</span>() throws <span class="hljs-keyword">Exception</span>&#123;<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++)&#123;<br><span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(Thread.currentThread().getName()+&quot;执行时间是：&quot;+<span class="hljs-built_in">new</span> <span class="hljs-type">Date</span>().getTime()+&quot;；循环次数是：&quot;+i);<br>&#125;<br><span class="hljs-keyword">return</span> &quot;MyCallable接口执行完成&quot;;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ThreadCreateDemo.class:</strong></p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadCreateDemo</span></span>&#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> void main(<span class="hljs-keyword">String</span>[] args)&#123;<br><span class="hljs-comment">//1、创建FutureTask实例，创建MyCallable实例</span><br>FutureTask&lt;<span class="hljs-keyword">String</span>&gt; task = <span class="hljs-keyword">new</span> <span class="hljs-type">FutureTask</span>&lt;<span class="hljs-keyword">String</span>&gt;(<span class="hljs-keyword">new</span> <span class="hljs-type">MyCallable</span>());<br><span class="hljs-comment">//2、创建Thread实例，执行FutureTask</span><br>Thread thread = <span class="hljs-keyword">new</span> <span class="hljs-type">Thread</span>(task,<span class="hljs-string">&quot;MyCallable&quot;</span>);<br>thread.start();<br><span class="hljs-comment">//3、在主线程打印信息</span><br><span class="hljs-keyword">for</span>(int i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++)&#123;<br>System.out.println(<span class="hljs-string">&quot;main主线程执行了：&quot;</span>+<span class="hljs-keyword">new</span> <span class="hljs-type">Date</span>().getTime());<br>&#125;<br><span class="hljs-comment">//4、获取并打印MyCallable执行结果</span><br><span class="hljs-keyword">try</span>&#123;<br><span class="hljs-keyword">String</span> result = task.<span class="hljs-keyword">get</span>();<br>System.out.println(<span class="hljs-string">&quot;MyCallable执行结果是：&quot;</span>+result)<br>&#125;<span class="hljs-keyword">catch</span> (ExecutionException e)&#123;<br>e.printStackTrace();<br>&#125;<br><br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-4、线程池-Executor"><a href="#3-4、线程池-Executor" class="headerlink" title="3.4、线程池-Executor"></a>3.4、线程池-Executor</h2><p><strong>线程池线类关系图</strong>：</p><p><img src="/2022/10/28/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/1378444-20191125143829962-1722847086.png" alt="img"></p><p><strong>MyRunnable.class:</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyRunnable</span> <span class="hljs-title">implements</span> <span class="hljs-title">Runnable</span>&#123;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span>&#123;<br><span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++)&#123;<br>System.<span class="hljs-keyword">out</span>.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;执行时间是：&quot;</span>+<span class="hljs-keyword">new</span> Date().getTime()+<span class="hljs-string">&quot;;执行次数是：&quot;</span>+i)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ThreadCreateDemo.class:</strong></p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadCreateDemo</span></span>&#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> void main(<span class="hljs-keyword">String</span>[] args)&#123;<br><span class="hljs-comment">//1.使用Executors获取线程池对象</span><br>ExecutorService executorService = Executors.<span class="hljs-keyword">new</span><span class="hljs-type">FixedThreadPool</span>(<span class="hljs-number">10</span>);<span class="hljs-comment">//(10个线程)</span><br><span class="hljs-comment">//2.通过线程池对象获取线程并执行MyRunnable实例</span><br>executorService.execute(<span class="hljs-keyword">new</span> <span class="hljs-type">MyRunnable</span>());<br><span class="hljs-comment">//3.主线程打印信息</span><br><span class="hljs-keyword">for</span>(int i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++)&#123;<br>System.out.println(<span class="hljs-string">&quot;main主线程执行了：&quot;</span>+<span class="hljs-keyword">new</span> <span class="hljs-type">Date</span>().getTime());<br>&#125;<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-5、小结"><a href="#3-5、小结" class="headerlink" title="3.5、小结"></a>3.5、小结</h2><h3 id="3-5-1、实现接口和继承Thread类比较"><a href="#3-5-1、实现接口和继承Thread类比较" class="headerlink" title="3.5.1、实现接口和继承Thread类比较"></a>3.5.1、实现接口和继承Thread类比较</h3><ul><li>接口更高适合多个相同的程序代码的线程去共享同一个资源。</li><li>接口可以避免java中的单继承的局限性。</li><li>接口代码可以被多个线程共享，代码和线程独立。</li><li>线程池只能放入实现Runnable或Callable接口的线程，不能直接放入继承Thread的类。</li></ul><p>扩充：在java中，每次程序运行至少启动2个线程。一个是main线程，一个是垃圾收集线程。</p><h3 id="3-5-2、Runnable和Callable接口比较"><a href="#3-5-2、Runnable和Callable接口比较" class="headerlink" title="3.5.2、Runnable和Callable接口比较"></a>3.5.2、Runnable和Callable接口比较</h3><p><strong>相同点：</strong></p><ul><li>两者都是借口。</li><li>两者都可用来编写多线程程序。</li><li>两者都需要调用Thread.start()启动线程。</li></ul><p><strong>不同点：</strong></p><ul><li>实现Callable接口的线程能返回执行结果，而实现Runnable接口的线程不能返回结果。</li><li>Callable接口的call()方法允许抛出异常，而Runnable接口的run()方法不允许抛异常。</li><li>实现Callable接口的线程可以调用Future.cancel取消执行，而实现Runnable接口的线程不能</li></ul><p><strong>注意点：</strong></p><ul><li>Callable接口支持返回执行结果，此时需要调用FutureTask.get()方法实现，此方法会阻塞主线程直到获取“将来”结果，当不调用此方法时，主线程不会阻塞。</li></ul><h1 id="4、线程生命周期"><a href="#4、线程生命周期" class="headerlink" title="4、线程生命周期"></a>4、线程生命周期</h1><p><img src="/2022/10/28/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/image-20221103152613817.png" alt="image-20221103152613817"></p><h2 id="4-1、新建"><a href="#4-1、新建" class="headerlink" title="4.1、新建"></a>4.1、新建</h2><ul><li>new关键字创建了一个线程之后，该线程就处于新建状态。</li><li>JVM为线程分配内存，初始化成员变量值。</li></ul><h2 id="4-2、就绪"><a href="#4-2、就绪" class="headerlink" title="4.2、就绪"></a>4.2、就绪</h2><ul><li>当线程对象调用了start()方法之后，该线程处于就绪状态。</li><li>JVM为线程创建方法栈和程序计数器，等待线程调度器调度。</li></ul><h2 id="4-3、运行"><a href="#4-3、运行" class="headerlink" title="4.3、运行"></a>4.3、运行</h2><ul><li>就绪状态的线程获得CPU资源，开始运行run()方法，该线程进如运行状态</li></ul><h2 id="4-4、阻塞"><a href="#4-4、阻塞" class="headerlink" title="4.4、阻塞"></a>4.4、阻塞</h2><p>当发生如下情况时，线程将会进入阻塞状态</p><ul><li>线程调用sleep()方法主动放弃所占用的处理器资源</li><li>线程调用了一个阻塞式IO方法，在该方法返回之前，该线程被阻塞</li><li>线程试图获得一个同步锁（同步监视器），但该同步锁正在被其他线程所持有。</li><li>线程在等待某个通知（notify）</li><li>程序调用了线程的suspend()方法将该线程挂起。但这个方法容易导致死锁，所以应尽量避免使用该方法</li></ul><h2 id="4-5、死亡"><a href="#4-5、死亡" class="headerlink" title="4.5、死亡"></a>4.5、死亡</h2><p>线程会以如下三种方式结束，结束后就处于死亡状态：</p><ul><li>run()或call()方法执行完成，线程正常结束。</li><li>线程抛出一个未捕获的Exception或Error。</li><li>调用该线程stop()方法来结束该线程，该方法容易导致死亡锁，不推荐使用。</li></ul><h1 id="5、线程安全问题"><a href="#5、线程安全问题" class="headerlink" title="5、线程安全问题"></a>5、线程安全问题</h1><h2 id="5-1、什么是线程安全"><a href="#5-1、什么是线程安全" class="headerlink" title="5.1、什么是线程安全"></a>5.1、什么是线程安全</h2><p>如果有多个线程同时运行同一个实现了Runnable接口的类，程序每次运行结果和单线程运行的结果是一样的，而且其他的变量的值也和预期的是一样的，就是线程安全的。反之，则是线程不安全的。</p><h2 id="5-2、问题演示"><a href="#5-2、问题演示" class="headerlink" title="5.2、问题演示"></a>5.2、问题演示</h2><p><strong>Ticket.class</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public <span class="hljs-keyword">class</span> Ticket implements Runnable&#123;<br><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> ticketNum = <span class="hljs-number">100</span>;<br><br>public void run<span class="hljs-literal">()</span>&#123;<br><span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br><span class="hljs-keyword">if</span>(ticketNum &gt;<span class="hljs-number">0</span>)&#123;<br><span class="hljs-keyword">try</span>&#123;<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Thread</span>.</span></span>sleep(<span class="hljs-number">100</span>);<br>&#125;catch(InterruptedException e)&#123;<br>e.print<span class="hljs-constructor">StackTrace()</span>;<br>&#125;<br><span class="hljs-comment">//2.打印进程号和票号，票数减1</span><br>String name = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Thread</span>.</span></span>current<span class="hljs-constructor">Thread()</span>.get<span class="hljs-constructor">Name()</span>;<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.print<span class="hljs-constructor">Ln(<span class="hljs-string">&quot;线程：&quot;</span>+<span class="hljs-params">name</span>+<span class="hljs-string">&quot;售票：&quot;</span>+<span class="hljs-params">ticketNum</span>--)</span><br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>TicketDemo.class</strong></p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketDemo</span></span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> void main(<span class="hljs-keyword">String</span>[] args)&#123;<br>Ticket ticket = <span class="hljs-keyword">new</span> <span class="hljs-type">Ticket</span>();<br>Thread thread1 = <span class="hljs-keyword">new</span> <span class="hljs-type">Thread</span>(ticket,<span class="hljs-string">&quot;窗口1&quot;</span>);<br>Thread thread2 = <span class="hljs-keyword">new</span> <span class="hljs-type">Thread</span>(ticket,<span class="hljs-string">&quot;窗口2&quot;</span>);<br>Thread thread3 = <span class="hljs-keyword">new</span> <span class="hljs-type">Thread</span>(ticket,<span class="hljs-string">&quot;窗口3&quot;</span>);<br><br>thread1.start();<br>thread2.start();<br>thread3.start();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>程序出现了两个问题：</p><p>1、相同的票数，比如5这张票被卖了两回。</p><p>2、不存在的票，比如0票与-1票，是不存在的。</p><h2 id="5-3、问题分析"><a href="#5-3、问题分析" class="headerlink" title="5.3、问题分析"></a>5.3、问题分析</h2><p>线程安全问题都是由全局变量及静态变量引起的。</p><p>若每个线程对全局变量、静态变量只读，不屑，一般来说，这个变量是线程安全的。</p><p>若有多个线程同时执行写操作，一般都需要考虑线程同步，否则的话就可能影响线程安全。</p><p>综上所述，线程安全问题根本原因：</p><ul><li>多个线程在操作共享的数据。</li><li>操作共享数据的线程代码有多条。</li><li>多个线程对共享数据有些操作。</li></ul><h2 id="5-4、问题解决-线程同步"><a href="#5-4、问题解决-线程同步" class="headerlink" title="5.4、问题解决-线程同步"></a>5.4、问题解决-线程同步</h2><p>​要解决以上线程问题，只要在某个线程修改共享资源的时候，其他线程不能修改该资源，等待修改完毕同步之后，才能去抢夺CPU资源，完成对应的操作，保证了数据的同步性，解决了线程不安全的现象。</p><p>​为了保证每个现车给都能正常执行共享资源操作，Java引入了7中线程同步机制：</p><ul><li>同步代码块（synchronized）</li><li>同步方法（synchronized）</li><li>同步锁（ReentrantLock）</li><li>特殊域变量（volatile）</li><li>局部变量（ThreadLocal）</li><li>阻塞队列（LinkedBloclingQueue）</li><li>原子变量（Atomic*）</li></ul><h3 id="5-4-1、同步代码块的方式（synchronized）"><a href="#5-4-1、同步代码块的方式（synchronized）" class="headerlink" title="5.4.1、同步代码块的方式（synchronized）"></a>5.4.1、同步代码块的方式（synchronized）</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Ticket</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>&#123;<br><span class="hljs-keyword">private</span> int ticketNum = <span class="hljs-number">100</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-title class_">Object</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">run</span>(<span class="hljs-params"></span>)&#123;<br><span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br><span class="hljs-title function_">synchronized</span>(<span class="hljs-params">obj</span>)&#123;<br><span class="hljs-keyword">if</span>(ticketNum &gt;<span class="hljs-number">0</span>)&#123;<br><span class="hljs-keyword">try</span>&#123;<br><span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">100</span>);<br>&#125;<span class="hljs-keyword">catch</span>(<span class="hljs-title class_">InterruptedException</span> e)&#123;<br>e.<span class="hljs-title function_">printStackTrace</span>();<br>&#125;<br><span class="hljs-comment">//2.打印进程号和票号，票数减1</span><br><span class="hljs-title class_">String</span> name = <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">getName</span>();<br><span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">printLn</span>(<span class="hljs-string">&quot;线程：&quot;</span>+name+<span class="hljs-string">&quot;售票：&quot;</span>+ticketNum--)<br>&#125;<br>&#125;<br><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><strong>同步锁是自定义的obj对象</strong></li><li><strong>这种方式会将多线程变为单线程</strong></li></ul><h3 id="5-4-2、同步方法的方式（synchronized）"><a href="#5-4-2、同步方法的方式（synchronized）" class="headerlink" title="5.4.2、同步方法的方式（synchronized）"></a>5.4.2、同步方法的方式（synchronized）</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public <span class="hljs-keyword">class</span> Ticket implements Runnable&#123;<br><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> ticketNum = <span class="hljs-number">100</span>;<br><br>public void run<span class="hljs-literal">()</span>&#123;<br><span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>sale<span class="hljs-constructor">Ticket()</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> synchronized void sale<span class="hljs-constructor">Ticket()</span>&#123;<br><span class="hljs-keyword">if</span>(ticketNum &gt;<span class="hljs-number">0</span>)&#123;<br><span class="hljs-keyword">try</span>&#123;<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Thread</span>.</span></span>sleep(<span class="hljs-number">100</span>);<br>&#125;catch(InterruptedException e)&#123;<br>e.print<span class="hljs-constructor">StackTrace()</span>;<br>&#125;<br><span class="hljs-comment">//2.打印进程号和票号，票数减1</span><br>String name = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Thread</span>.</span></span>current<span class="hljs-constructor">Thread()</span>.get<span class="hljs-constructor">Name()</span>;<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.print<span class="hljs-constructor">Ln(<span class="hljs-string">&quot;线程：&quot;</span>+<span class="hljs-params">name</span>+<span class="hljs-string">&quot;售票：&quot;</span>+<span class="hljs-params">ticketNum</span>--)</span><br>&#125;<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>对于非static方法，同步锁就是this。</li><li>对于static方法，同步锁时当前方法所在类的字节码对象(类名.class)</li></ul><h3 id="5-4-3、同步锁方式（ReentrantLock）"><a href="#5-4-3、同步锁方式（ReentrantLock）" class="headerlink" title="5.4.3、同步锁方式（ReentrantLock）"></a>5.4.3、同步锁方式（ReentrantLock）</h3><p><strong>同步锁：</strong></p><p>java.util.concurrent.locks.Lock 机制提供了比synchronized代码块和synchronized方法更广泛的锁定操作，同步代码块同步方法具有的功能Lock都有，除此之外更加强大，更提现面向对象。</p><p><strong>同步锁方法：</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span>():加同步锁。</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span>():释放同步锁。</span><br></code></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Ticket</span> <span class="hljs-title">implements</span> <span class="hljs-title">Runnable</span>&#123;<br><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> ticketNum = <span class="hljs-number">100</span>;<br><span class="hljs-keyword">private</span> Lock <span class="hljs-keyword">lock</span> = <span class="hljs-keyword">new</span> ReentrantLock(<span class="hljs-literal">true</span>);<span class="hljs-comment">//参数是是否公平锁：true是公平锁，多个线程都公平拥有执行权。false非公平，独占锁。</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span>&#123;<br><span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br><span class="hljs-keyword">lock</span>.<span class="hljs-keyword">lock</span>();<br><span class="hljs-keyword">try</span>&#123;<br><span class="hljs-keyword">if</span>(ticketNum &gt;<span class="hljs-number">0</span>)&#123;<br><span class="hljs-keyword">try</span>&#123;<br>Thread.sleep(<span class="hljs-number">100</span>);<br>&#125;<span class="hljs-keyword">catch</span>(InterruptedException e)&#123;<br>e.printStackTrace();<br>&#125;<br><span class="hljs-comment">//2.打印进程号和票号，票数减1</span><br>String name = Thread.currentThread().getName();<br>System.<span class="hljs-keyword">out</span>.printLn(<span class="hljs-string">&quot;线程：&quot;</span>+name+<span class="hljs-string">&quot;售票：&quot;</span>+ticketNum--)<br>&#125;<br>&#125; <span class="hljs-keyword">finally</span>&#123;<br><span class="hljs-keyword">lock</span>.unlock();<br>&#125;<br>&#125;<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-5、小结"><a href="#5-5、小结" class="headerlink" title="5.5、小结"></a>5.5、小结</h2><p>Synchronized和Lock区别</p><ul><li>synchronized是java内置关键字，在jvm层面，lock是个java类。</li><li>synchronized无法判断是否获取锁的状态，Lock可以判断是否获取到锁。</li><li>synchronized会自动释放锁（a线程执行完同步代码会释放锁，b线程执行过程中发生异常会释放锁），Lock需要在finally中手动释放锁（unlock()方法释放锁），否则容易造成线程死锁。</li><li>用synchronized关键字的两个线程1和线程2，如果当前线程1获得锁，线程2线程等待。如果线程1阻塞，线程2则会一直等待下去，而Lock锁就不一定会等待下去，如果尝试获取不到锁，线程可以不用一直等待就结束了。</li><li>synchronized的锁可重入、不可中断、非公平、而Lock锁可重入、可判断、可公平（两者皆可）</li><li>Lock锁适合大量同步的代码的同步问题，synchronized锁适合代码少量的同步问题。</li></ul><h1 id="6、线程死锁"><a href="#6、线程死锁" class="headerlink" title="6、线程死锁"></a>6、线程死锁</h1><h2 id="6-1、什么是死锁"><a href="#6-1、什么是死锁" class="headerlink" title="6.1、什么是死锁"></a>6.1、什么是死锁</h2><p>​多线程以及多进程改善了系统资源的利用率并提高了系统的处理能。然而，并发执行也带来了新的问题——死锁。</p><p>​所谓死锁是指多个线程因竞争资源而造成的一种僵局（互相等待），若无外力所用，这些进程都将无法向前推进。</p><p><img src="/2022/10/28/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/image-20221103165227368.png" alt="image-20221103165227368"></p><h2 id="6-2、死锁产生的必要条件"><a href="#6-2、死锁产生的必要条件" class="headerlink" title="6.2、死锁产生的必要条件"></a>6.2、死锁产生的必要条件</h2><p>​以下这四个条件是死锁的必要条件，只要系统发生死锁，这些条件必然成立，而只要以下条件之一不满足，就不会发生死锁。</p><h3 id="6-2-1、互斥条件"><a href="#6-2-1、互斥条件" class="headerlink" title="6.2.1、互斥条件"></a>6.2.1、互斥条件</h3><p>​进程要求对所分配的资源（如打印机）进行排他性控制，即在一段时间内某资源仅为一个进程所占有。此时若有其他进程请求该资源，则请求进程只能等待。</p><h3 id="6-2-2、不可剥夺条件"><a href="#6-2-2、不可剥夺条件" class="headerlink" title="6.2.2、不可剥夺条件"></a>6.2.2、不可剥夺条件</h3><p>​进程所获得的资源在未使用完毕之前，不能被其他进程强行夺走，即只能由获得该资源的进程自己来释放（只能是主动释放）。</p><h3 id="6-2-3、请求与保持条件"><a href="#6-2-3、请求与保持条件" class="headerlink" title="6.2.3、请求与保持条件"></a>6.2.3、请求与保持条件</h3><p>​进程已经保持了至少一个资源，但又提出了新的资源请求，而该资源已被其他进程占有，此时请求进程被阻塞，但对自己已获得的资源保持不放。</p><h3 id="6-2-4、循环等待条件"><a href="#6-2-4、循环等待条件" class="headerlink" title="6.2.4、循环等待条件"></a>6.2.4、循环等待条件</h3><p>​存在一种进程资源的循环等待链，链中没有给进程已获得的资源同时被链中下一个进程锁请求。即存在于给处于等待状态的进程集合{p1,p1…,pn},其中pi等待的资源被p(i+1)占有（i0，1，…，n-1），pn等待的资源被p0占有，如图：</p><p><img src="/2022/10/28/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/image-20221103165844699.png" alt="循环等待"></p><p><img src="/2022/10/28/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/image-20221103165935140.png" alt="满足条件但无死循环"></p><h2 id="6-3、死锁处理"><a href="#6-3、死锁处理" class="headerlink" title="6.3、死锁处理"></a>6.3、死锁处理</h2><h3 id="6-3-1、死锁预防"><a href="#6-3-1、死锁预防" class="headerlink" title="6.3.1、死锁预防"></a>6.3.1、死锁预防</h3><ul><li>预防思索：通过设置某些限制条件，去破坏产生死锁的四个必要条件中的一个或几个条件，来防止死锁的发生。</li><li>避免死锁：在资源的动态分配过程中，用某种方法去防止系统进入不安全的状态，从而避免死锁的发生。</li><li>检测死锁：允许系统在运行过程中发生死锁，但可设置检测机构及时检测死锁的发生，并采取适当措施加以清除。</li><li>解除死锁：当检测出死锁后，便采取适当措施将进程从死锁状态中解脱出来。</li></ul><h4 id="6-3-1-1、破坏”互斥“条件"><a href="#6-3-1-1、破坏”互斥“条件" class="headerlink" title="6.3.1.1、破坏”互斥“条件"></a>6.3.1.1、破坏”互斥“条件</h4><p>”互斥条件“是无法破坏的，因此，在思索预防里主要是破坏其他几个必要条件，而不去涉及破坏”互斥“条件。</p><h4 id="6-3-1-2、破坏”占有并等待“条件"><a href="#6-3-1-2、破坏”占有并等待“条件" class="headerlink" title="6.3.1.2、破坏”占有并等待“条件"></a>6.3.1.2、破坏”占有并等待“条件</h4><p>破坏”占有并等待“条件，就是在系统中不允许进程在已获得某种资源的情况下，申请其他资源。即要想出一个办法，组织进程在持有资源的同时申请其他资源。</p><ul><li>方法一：一次性分配资源，即创建进程时，要求它申请所需要的全部资源，系统或满足其所有要求，或什么也不给它。</li><li>方法二：要求每个进程提出新的资源申请前，释放它所占有的资源。这样，一个进程在需要资源 s 时，须先把它先前占有的资源 R 释放掉，然后才能提出对 s 的申请面积十它可能很快又要用到资源 R 。</li></ul><h4 id="6-3-1-3、破坏”不可抢占“条件"><a href="#6-3-1-3、破坏”不可抢占“条件" class="headerlink" title="6.3.1.3、破坏”不可抢占“条件"></a>6.3.1.3、破坏”不可抢占“条件</h4><p>破坏”不可抢占“条件就是允许资源实行抢夺。</p><ul><li>方法一：如果占有某些资源的一个进程进行进一步资源请求被拒绝，则该进程必须释放它最初占有的资源，如果有必要，可再次请求这些资源和另外的资源。</li><li>方法二：如果一个进程请求当前被另一个进程占有的一个资源，则操作系统可以抢占另一个进程，要求它释放资源。之后任意两个进程的优先级都不相同的条件下，方法二才能预防死锁。</li></ul><h4 id="6-3-1-4、破坏”循环等待“条件"><a href="#6-3-1-4、破坏”循环等待“条件" class="headerlink" title="6.3.1.4、破坏”循环等待“条件"></a>6.3.1.4、破坏”循环等待“条件</h4><p>破环”循环等待“条件的一种方法，是将系统中的所有资源统一编号，进程可在任何时刻提出资源申请，但所有申请必须按照资源的编号顺序（升序）提出。这样做就能保证系统不出现死锁。</p><h3 id="6-3-2、死锁避免"><a href="#6-3-2、死锁避免" class="headerlink" title="6.3.2、死锁避免"></a>6.3.2、死锁避免</h3><p>​避免死锁不严格限制产生死锁的必要条件的存在，因为即使死锁的必要条件存在，也不一定发生死锁。</p><h4 id="6-3-2-1、有序资源分配发"><a href="#6-3-2-1、有序资源分配发" class="headerlink" title="6.3.2.1、有序资源分配发"></a>6.3.2.1、有序资源分配发</h4><p>该算法实现步骤如下：</p><ul><li>必须为所有资源统一编号，例如打印机为1、传真机为2、磁盘为3等</li><li>同类资源必须一次申请完，例如打印机和传真机一般为同一个机器，必须同时申请</li><li>不同类资源必须按顺序申请</li></ul><p>例如：有两个进程P1和P2，有两个资源R1和R2</p><p>P1请求资源：R1、R2</p><p>P2请求资源：R1、R2</p><p>这样就破坏了环路条件，避免了死锁的发生。</p><h4 id="6-3-2-2、银行家算法"><a href="#6-3-2-2、银行家算法" class="headerlink" title="6.3.2.2、银行家算法"></a>6.3.2.2、银行家算法</h4><p>​银行家算法（Banker’s Algorithm）是一个避免死锁（Deadlock）的著名算法，是由艾兹格.迪杰斯特拉在1965年为T.H.E系统设计的一种避免死锁的算法。它以银行借贷系统的分配策略为基础，判断并保证系统的安全运行。流程图如下：</p><p><img src="/2022/10/28/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/image-20221103180400921.png" alt="image-20221103180400921"></p><p>​银行家算法的基本思想是分配资源之前，判断系统是否是安全的。若是，才分配。它是最具有代表性的避免死锁的算法。</p><p>设进程i提出请求REQUEST[i],则银行家算法按如下规则进行判断。</p><ol><li><p>如果REQUEST[i]&lt;&#x3D;NEED[i,j],则转②。否则，出错。</p></li><li><p>如果REQUEST[i]&lt;&#x3D;AVAILABLE[i,j],则转③。否则，等待。</p></li><li><p>系统试探分配资源，修改相关数据：</p><p>AVAILABLE[i]  -&#x3D; REQUEST[i];&#x2F;&#x2F;可用资源数-请求资源数</p><p>ALLOCATION[i] +&#x3D; REQUEST[i];&#x2F;&#x2F;已分配资源数+请求资源数</p><p>NEED[i] -&#x3D; REQUEST[i];&#x2F;&#x2F;需要资源数-请求资源数</p></li><li><p>系统执行安全性检查，如果安全，则分配成立；否则试探险性分配作废，系统恢复原装，进程等待。</p></li></ol><h4 id="6-3-2-3、顺序枷锁"><a href="#6-3-2-3、顺序枷锁" class="headerlink" title="6.3.2.3、顺序枷锁"></a>6.3.2.3、顺序枷锁</h4><p>​当个多个线程需要相同的一些锁，但是按照不同的顺序加锁，死锁就很容易发生。</p><p>​例如一下两个线程就会死锁：</p><p>Thread1：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">lock</span> <span class="hljs-title">A</span> (<span class="hljs-params"><span class="hljs-keyword">when</span> C locked</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">lock</span> <span class="hljs-title">B</span> (<span class="hljs-params"><span class="hljs-keyword">when</span> C locked</span>)</span><br><span class="hljs-function">wait <span class="hljs-keyword">for</span> C</span><br></code></pre></td></tr></table></figure><p>Thread2：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css">wait for <span class="hljs-selector-tag">A</span><br>wait for <span class="hljs-selector-tag">B</span><br>lock C (when <span class="hljs-selector-tag">A</span> locked)<br></code></pre></td></tr></table></figure><p>​如果能确保所有的线程都是按照相同的顺序获得锁，那么死锁就不会发生。</p><p>​例如以下两个线程就不会死锁</p><p>Thread1：</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cos"><span class="hljs-keyword">lock</span> A<br><span class="hljs-keyword">lock</span> B<br><span class="hljs-keyword">lock</span> C<br></code></pre></td></tr></table></figure><p>Thread2：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">wait </span>for A<br><span class="hljs-keyword">wait </span>for <span class="hljs-keyword">B</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">wait </span>for C<br></code></pre></td></tr></table></figure><p>​按照顺序加锁是一种有效的死锁预防机制。但是，这种方式需要事先知道所有可能会用到的锁，但总是有些时候是无法预知的，所有该种方式只适合特定场景。</p><h4 id="6-3-2-4、限时加锁"><a href="#6-3-2-4、限时加锁" class="headerlink" title="6.3.2.4、限时加锁"></a>6.3.2.4、限时加锁</h4><p>​限时加锁是线程在尝试获取锁的时候加一个超时时间，若超过这个时间则放弃对该所请求，并回退并释放所有已经获得的锁，然后等待一段随机的时间再重试</p><p>​以下是一个例子，展示了两个线程以不同的顺序尝试获取相同的两个锁，在发生超时后回退并重试的场景：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs applescript">Thread1 locks A<br>Thread2 locks B<br>Thread1 attempts <span class="hljs-keyword">to</span> lock B <span class="hljs-keyword">but</span> <span class="hljs-keyword">is</span> blocked<br>Thread2 attempts <span class="hljs-keyword">to</span> lock A <span class="hljs-keyword">but</span> <span class="hljs-keyword">is</span> blocked<br>Thread1&#x27;s lock attempt <span class="hljs-keyword">on</span> B <span class="hljs-keyword">times</span> out<br>Thread1 backs up <span class="hljs-keyword">and</span> releases A <span class="hljs-keyword">as</span> well<br>Thread1 waits randomly(e.g<span class="hljs-number">.257</span>millis) <span class="hljs-keyword">before</span> retrying<br>Thread2&#x27;s lock attempt <span class="hljs-keyword">on</span> A <span class="hljs-keyword">times</span> out<br>Thread2 backs up <span class="hljs-keyword">and</span> releases B <span class="hljs-keyword">as</span> well<br>Thread2 waits randomly(e.g<span class="hljs-number">.43</span>millis) <span class="hljs-keyword">before</span> retrying<br></code></pre></td></tr></table></figure><p>​在上面的例子中，线程2比线程1早200ms进行重试加锁，因此它可以先成功地获取到两个锁。这时，线程1尝试获取锁A并且处于等待状态。当线程2结束时，线程1也可以顺利的获得这两个锁。</p><p>​这种方式有两个缺点：</p><ul><li>当线程数量少时，该种方式可避免死锁，但当线程数量过多，这些线程的加锁时限相同的概率就会高很多，可能会导致超时后重试的死循环。</li><li>Java中不能对synchronized同步块设置超时时间。你需要创建一个自定义锁，或使用Java5中java.util.concurrent包下的工具。</li></ul><h3 id="6-3-3、死锁检测"><a href="#6-3-3、死锁检测" class="headerlink" title="6.3.3、死锁检测"></a>6.3.3、死锁检测</h3><p>​预防和避免死锁系统开销大且不能充分利用资源，更好的方法是不采取任何限制性措施，而是提供检测和解脱死锁的手段，这就是死锁检测和恢复。</p><p>死锁检测数据结构：</p><ul><li>E是现有资源向量（existing resource vector），代码每种已存在资源的总数。</li><li>A是可用资源向量（available resource vector），那么Ai表示当前可供使用的资源数（即没有分配的资源）</li><li>C是当前分配矩阵（current allocation matrix），C的第i行代表Pi当前所持有的每一种类型资源的资源数</li><li>R是请求矩阵（request matrix），R的每一行代表P所需要的资源的数量</li></ul><p><img src="/2022/10/28/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/image-20221104093135512.png" alt="image-20221104093135512"></p><p>死锁检测步骤：</p><p>1）寻找一个没有结束标记的进程Pi，对于它而言R矩阵的第i行向量小于或等于A。</p><p>2）如果找到了这样一个进程，执行该进程，然后将C矩阵的第i行向量加到A中，标记该进程，并转到第1步。</p><p>3）如果没有这样的进程，那么算法终止</p><p>4）算法结束时，所有没有标记过的进程都是死锁进程。</p><h3 id="6-3-4、死锁恢复"><a href="#6-3-4、死锁恢复" class="headerlink" title="6.3.4、死锁恢复"></a>6.3.4、死锁恢复</h3><p><strong>利用抢占恢复：</strong></p><ul><li>临时将某个资源从它的当前所属进程转移到另一个进程。</li><li>这种做法很可能需要人工干预，主要做法是否可行需取决于资源本身的特性。</li></ul><p><strong>利用滚回恢复：</strong></p><ul><li>周期性的将进程的状态进行备份，当发现进程死锁后，根据备份将该进程复位到一个更早的，还没有取得所需的资源的状态，接着就把这些金源分配给其他死锁进程。</li></ul><p><strong>通过杀死进程恢复：</strong></p><ul><li>最直接简单的方式就是杀死一个或若干个进程。</li><li>尽可能保证杀死的进程可用从头再来而不带来副作用。</li></ul><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>多线程</tag>
      
      <tag>并发编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM</title>
    <link href="/2022/10/26/Java%20Virtual%20Machine/JVM/"/>
    <url>/2022/10/26/Java%20Virtual%20Machine/JVM/</url>
    
    <content type="html"><![CDATA[<hr><p>title: JVM<br>date: 2022-10-26 15:11:15<br>categories:<br>    - Java<br>    - JVM<br>tags:<br>    - JVM<br>    - JVM调优</p><hr><h1 id="什么是JVM-？"><a href="#什么是JVM-？" class="headerlink" title="什么是JVM  ？"></a>什么是JVM  ？</h1><p> 定义：</p><p>Java Virtual  Machine ＿ java程序的运行环环境（java二进制字节码的运行环境）</p><p>好处：</p><p>一次编写，到处运行</p><p>自动内存管理，垃圾回收功能</p><p>数组下标越界检查</p><p>多态</p><p>比较：</p><p>JVM，JRE，JDK</p><p><img src="/JVM/63923723e6a1ee131cc1e80176ef78f8.jpeg" alt="63923723e6a1ee131cc1e80176ef78f8"></p><h1 id="学习JVM有什么用"><a href="#学习JVM有什么用" class="headerlink" title="学习JVM有什么用"></a>学习JVM有什么用</h1><p>面试</p><p>理解底层的实现原理</p><p>中高级程序员必备技能</p><p><img src="/JVM/WEBRESOURCE25e1cb46f11e9645a38327ed44b90a70.png" alt="WEBRESOURCE25e1cb46f11e9645a38327ed44b90a70"></p><p><img src="/JVM/WEBRESOURCE41561026b067c83cc38dbac758f4c182.png" alt="WEBRESOURCE41561026b067c83cc38dbac758f4c182"></p><p>1、JVM内存结构</p><p>2、GC垃圾回收</p><p>3、Java Class（类的字节码结构、编译器的优化等等）</p><p>4、ClassLoader类加载器</p><p>5、类运行时的一些优化（JIT Compiler即时编译器）</p><h1 id="1、内存结构"><a href="#1、内存结构" class="headerlink" title="1、内存结构"></a>1、内存结构</h1><h2 id="1-1、程序计数器"><a href="#1-1、程序计数器" class="headerlink" title="1.1、程序计数器"></a>1.1、程序计数器</h2><p><img src="/JVM/WEBRESOURCEcb7171c291b81048105a4fcc1b3adb03.png" alt="WEBRESOURCEcb7171c291b81048105a4fcc1b3adb03"></p><ul><li><p>定义：Program Counter Register 程序计数器（寄存器）</p></li><li><p>Java中虚拟机指令执行流程：将源代码翻译成为jvm指令，再交给解释器，解释器再交给机器码，机器码再交给CPU运行</p></li><li><p>作用：实际上就是在程序运行中记住下一条jvm指令的执行地址</p></li><li><p>物理上实现程序计数器是通过寄存器(读取速度最快的一个单元)来实现的</p></li></ul><p><img src="/JVM/WEBRESOURCE25c52f6bcc83666a2b7882eeb1aafa8b.png" alt="WEBRESOURCE25c52f6bcc83666a2b7882eeb1aafa8b"></p><ul><li><p>特点：</p></li><li><p>是一块较小的内存空间</p></li><li><p>是线程私有的，随着线程创建而创建，随着线程销毁而销毁</p></li><li><p>不会存在内存溢出</p></li></ul><h2 id="1-2、虚拟机栈"><a href="#1-2、虚拟机栈" class="headerlink" title="1.2、虚拟机栈"></a>1.2、虚拟机栈</h2><p><img src="/JVM/WEBRESOURCE985e7c0ac9a60d961a873d7fd4404924.png" alt="WEBRESOURCE985e7c0ac9a60d961a873d7fd4404924"></p><h3 id="1-2-1、Java-Virtual-Machine-Stacks-Java虚拟机栈"><a href="#1-2-1、Java-Virtual-Machine-Stacks-Java虚拟机栈" class="headerlink" title="1.2.1、Java Virtual Machine Stacks(Java虚拟机栈)"></a>1.2.1、Java Virtual Machine Stacks(Java虚拟机栈)</h3><p><img src="/JVM/WEBRESOURCEf9f8514f9942614b9db2a4882858fe5c.png" alt="WEBRESOURCEf9f8514f9942614b9db2a4882858fe5c"></p><ul><li>虚拟机栈：实际上就是线程运行需要的内存空间</li><li>每个栈有多个栈帧(Frame)组成，对应着每次方法调用时所占用的内存</li><li>栈帧：实际上就是每个方法运行时需要的内存</li><li>每个线程只能有一个活动栈帧，对应着当前正在执行的那个方法</li></ul><p><strong>用处：是用来存放在函数中定义的一些基本类型的变量和对象的引用变量</strong></p><p>问题辨析：</p><p>1.垃圾回收是否涉及栈内存？不涉及</p><p>2.栈内存分配越大越好吗？不是</p><p>3.方法内的局部变量是否线程安全？</p><p>如果方法内局部变量没有逃离方法的作用范围，那么它是线程安全的</p><p>如果是局部变量引用了对象，或逃离方法的作用范围，则需要考虑线程安全问题</p><p><img src="/JVM/WEBRESOURCE478700b79798874b7d2c1a67fac3a8a9.png" alt="WEBRESOURCE478700b79798874b7d2c1a67fac3a8a9"></p><p>只有第一个方法中的sb是线程安全的，另外两个皆是线程不安全的，主要是看</p><h3 id="1-2-2、栈内存溢出"><a href="#1-2-2、栈内存溢出" class="headerlink" title="1.2.2、栈内存溢出"></a>1.2.2、栈内存溢出</h3><p>-Xss256k通过该参数来设置占内存大小</p><p>两种情况会导致占内存溢出(java.lang.StackOverflowError)：</p><ul><li><p>栈帧过多导致占内存溢出(方法递归调用没有限制，或方法循环调用)</p></li><li><p>栈帧过大导致占内存溢出(此类情况不常见)</p></li></ul><h3 id="1-2-3、线程运行诊断"><a href="#1-2-3、线程运行诊断" class="headerlink" title="1.2.3、线程运行诊断"></a>1.2.3、线程运行诊断</h3><p>案例1：cpu占用过多</p><p>解决方案：</p><p>①top命令查看cpu内存使用情况，有无占用cpu极高的进程</p><p>②使用ps H -eo pid,tid,%cpu命令，H意思是打印所有进程中所有线程信息，-eo后面带所感兴趣的内容</p><p>③找到进程中占用cpu过高的线程id</p><p>④使用ps H -eo pid,tid,%cpu | grep 线程id，来筛选出对应占用cpu过高的线程信息</p><p>⑤使用jstack 进程id 命令来查看到底是那个线程出现了问题</p><p>⑥找到对应16进制的nid就是异常线程，进一步定位到出现问题的源代码行数以此来解决问题</p><p><img src="/JVM/WEBRESOURCE66d1731efb3000fc66666d0183362074.png" alt="WEBRESOURCE66d1731efb3000fc66666d0183362074"></p><p>案列2：程序运行很长时间没有结果</p><p>解决方案：</p><p>①使用jstack 进程id 命令来查看</p><p><img src="/JVM/WEBRESOURCE18bfa381dad22654f3ac2ccde831e642.png" alt="WEBRESOURCE18bfa381dad22654f3ac2ccde831e642"></p><p><img src="/JVM/WEBRESOURCEd28878fea598d5b0ce56a9d8156f1569.png" alt="WEBRESOURCEd28878fea598d5b0ce56a9d8156f1569"></p><h2 id="1-3、本地方法栈"><a href="#1-3、本地方法栈" class="headerlink" title="1.3、本地方法栈"></a>1.3、本地方法栈</h2><p><img src="/JVM/WEBRESOURCE434ca1e65faa9ec0c2881244b85f3961.png" alt="WEBRESOURCE434ca1e65faa9ec0c2881244b85f3961"></p><p>本地方法(Native Method)：指不是由java编写的代码，java无法直接调用一些硬件结构和底层，需要通过C++或C语言的接口来间接调用硬件。</p><h2 id="1-4、堆（Heap）"><a href="#1-4、堆（Heap）" class="headerlink" title="1.4、堆（Heap）"></a>1.4、堆（Heap）</h2><p>定义：</p><ul><li>通过new关键字，创建对象都会使用堆内存</li></ul><p>特点</p><ul><li>它是线程共享的，堆中对象都需要考虑线程安全的问题</li><li>有垃圾回收机制</li></ul><p><strong>用处：是用来存放由new创建的对象和数组，即动态申请的内存都存放在堆内存</strong></p><h3 id="1-4-2、堆内存溢出"><a href="#1-4-2、堆内存溢出" class="headerlink" title="1.4.2、堆内存溢出"></a>1.4.2、堆内存溢出</h3><p>java.lang.OutOfMemoryError</p><p>-Xmx8m 设置堆大小的参数</p><p><img src="/JVM/WEBRESOURCE5803d56511d00eed793f6dc0d2218794.png" alt="WEBRESOURCE5803d56511d00eed793f6dc0d2218794"></p><h3 id="1-4-3、堆内存诊断"><a href="#1-4-3、堆内存诊断" class="headerlink" title="1.4.3、堆内存诊断"></a>1.4.3、堆内存诊断</h3><p>1、jps工具</p><ul><li>查看当前系统中有哪些java进程</li></ul><p><img src="/JVM/WEBRESOURCE51d16482e606b4cd95d2f4147ee89ca2.png" alt="WEBRESOURCE51d16482e606b4cd95d2f4147ee89ca2"></p><p>2、jmap工具</p><ul><li><p>jmap -heap 进程id</p></li><li><p>查看堆内存占用情况</p></li></ul><p>3、jconsole工具</p><ul><li>图形界面的，多功能的检测工具，可以连续监测</li></ul><p><img src="/JVM/WEBRESOURCEa7bec0913fa275fc4bb630c57a6bdd2b.png" alt="WEBRESOURCEa7bec0913fa275fc4bb630c57a6bdd2b"></p><p>4、jvisualvm</p><ul><li>图形界面</li></ul><p><img src="/JVM/WEBRESOURCEc770e97a68b73a5e3152462fbef6ec97.png" alt="WEBRESOURCEc770e97a68b73a5e3152462fbef6ec97"></p><p>案列</p><ul><li>垃圾回收后，内存占用仍然很高</li></ul><p>解决方案：</p><p>使用jvisualvm进行排查</p><h2 id="1-5、方法区"><a href="#1-5、方法区" class="headerlink" title="1.5、方法区"></a>1.5、方法区</h2><p><img src="/JVM/WEBRESOURCEe08ac275d90a93d3eb8985ba2171024f.png" alt="WEBRESOURCEe08ac275d90a93d3eb8985ba2171024f"></p><h3 id="1-5-1、Java1-8中对方法中的定义"><a href="#1-5-1、Java1-8中对方法中的定义" class="headerlink" title="1.5.1、Java1.8中对方法中的定义"></a>1.5.1、Java1.8中对方法中的定义</h3><p><img src="/JVM/WEBRESOURCE7f704c060d981682045cbee26a35eeeb.png" alt="WEBRESOURCE7f704c060d981682045cbee26a35eeeb"></p><h3 id="1-5-2、组成"><a href="#1-5-2、组成" class="headerlink" title="1.5.2、组成"></a>1.5.2、组成</h3><p><img src="/JVM/WEBRESOURCE3463ee2dc6acab7dccf42a00cd82cbeb.png" alt="WEBRESOURCE3463ee2dc6acab7dccf42a00cd82cbeb"></p><h3 id="1-5-3、方法区内存溢出"><a href="#1-5-3、方法区内存溢出" class="headerlink" title="1.5.3、方法区内存溢出"></a>1.5.3、方法区内存溢出</h3><ul><li>1.8以前会导致永久代内存溢出</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">演示永久代内存溢出 java.lang.OutOfMemoryError: PermGen space<br>-XX:<span class="hljs-attribute">MaxPermSize</span>=8m<br></code></pre></td></tr></table></figure><ul><li>1.8之后会导致元空间内存溢出</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">演示元空间内存溢出 java.lang.OutOfMemoryError: Metaspace<br>-XX:<span class="hljs-attribute">MaxMetaspaceSize</span>=8M<br></code></pre></td></tr></table></figure><p>反编译指令：<img src="/JVM/image-20221026091351137.png" alt="image-20221026091351137"></p><p><strong>javap</strong>的使用</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">javap </span>是<span class="hljs-keyword">JDK自带的反汇编器，可以查看java编译器为我们生成的字节码。通过它，我们可以对照源代码和字节码，从而了解很多编译器内部的工作。</span><br><span class="hljs-keyword"></span>语法：<br>　　 <span class="hljs-keyword">javap </span>[ 命令选项 ] class. . .<br>　　 <span class="hljs-keyword">javap </span>命令用于解析类文件。其输出取决于所用的选项。若没有使用选项， <span class="hljs-keyword">javap </span>将输出传递给它的类的 public 域及方法。 <span class="hljs-keyword">javap </span>将其输出到标准输出设备上。<br>命令选项<br>　　-help 输出 <span class="hljs-keyword">javap </span>的帮助信息。<br>　　-l 输出行及局部变量表。<br>　　-<span class="hljs-keyword">b </span>确保与 <span class="hljs-keyword">JDK </span><span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-keyword">javap </span>的向后兼容性。<br>　　-public 只显示 public 类及成员。<br>　　-protected 只显示 protected 和 public 类及成员。<br>　　-package 只显示包、protected 和 public 类及成员。这是缺省设置。<br>　　-private 显示所有类和成员。<br>　　-<span class="hljs-keyword">J[flag] </span>直接将 flag 传给运行时系统。<br>　　-s 输出内部类型签名。<br>　　-c 输出类中各方法的未解析的代码，即构成 <span class="hljs-keyword">Java </span>字节码的指令。<br>　　-verbose 输出堆栈大小、各方法的 locals 及 args 数,以及class文件的编译版本<br>　　-classpath[路径] 指定 <span class="hljs-keyword">javap </span>用来查找类的路径。如果设置了该选项，则它将覆盖缺省值或 CLASSPATH 环境变量。目录用冒号分隔。<br> 　 -<span class="hljs-keyword">bootclasspath[路径] </span>指定加载自举类所用的路径。缺省情况下，自举类是实现核心 <span class="hljs-keyword">Java </span>平台的类，位于 <span class="hljs-keyword">jrelib下面。</span><br><span class="hljs-keyword"></span>　　-<span class="hljs-keyword">extdirs[dirs] </span>覆盖搜索安装方式扩展的位置。扩展的缺省位置是 <span class="hljs-keyword">jrelibext。</span><br></code></pre></td></tr></table></figure><h3 id="1-5-4、运行时常量池"><a href="#1-5-4、运行时常量池" class="headerlink" title="1.5.4、运行时常量池"></a>1.5.4、运行时常量池</h3><ul><li>常量池，就是一张表，虚拟机指令根据这张常量表找到要执行的类名、方法名、参数类型、字面量等信息</li><li>运行时常量池，常量池是*.class文件中的，当该类被加载，它的常量池信息就会放入运行时常量池，并把里面的符号地址变为真实地址</li></ul><h3 id="1-5-5、StringTable"><a href="#1-5-5、StringTable" class="headerlink" title="1.5.5、StringTable"></a>1.5.5、StringTable</h3><p><img src="/JVM/image-20221026095722397.png" alt="image-20221026095722397"></p><ol><li>常量池中的信息，都会被加载到运行时常量池中，这时a、b、ab都是常量池中的符号，还没有变为java字符串对象</li><li>当程序运行到该处时ldc #7会把a符号变为“a”字符串对象此时串池StringTable[]若没有“a”对象就会把对象“a”放入串池StringTable[“a”]、ldc #9会把b符号变为“b”字符串对象此时串池StringTable[“a”]若没有“a”对象就会把对象“a”放入串池StringTable[“a”,”b”]、ldc #11会把ab符号变为“ab”字符串对象此时串池StringTable[“a”,”b”]若没有“a”对象就会把对象“a”放入串池StringTable[“a”,”b”,”ab”]</li></ol><p><strong>StringTable特性</strong></p><ul><li>常量池中的字符串仅是符号，第一次用到时才变为对象</li><li>利用串池的机制，来避免重复创建字符串对象</li><li>字符串变量拼接的原理时StringBuilder(1.8)</li><li>字符串常量拼接的原理时编译期优化</li><li>可以使用intern方法，主动将串池中还没有的字符串对象放入串池<ul><li>jdk1.8将这个字符串对象尝试放入串池，<strong>如果有则并不会放入，如果没有则把元对象放入串池，会把串池中的对象返回</strong></li><li>jdk1.6将这个字符串对象尝试放入串池，<strong>如果有则并不会放入，如果没有会把此对象复制一份（副本跟原对象不同），将副本放入串池，会把串池中的副本对象返回</strong></li></ul></li></ul><h3 id="1-5-6、StringTable位置"><a href="#1-5-6、StringTable位置" class="headerlink" title="1.5.6、StringTable位置"></a>1.5.6、StringTable位置</h3><p><img src="/JVM/WEBRESOURCE3463ee2dc6acab7dccf42a00cd82cbeb.png" alt="WEBRESOURCE3463ee2dc6acab7dccf42a00cd82cbeb"></p><h3 id="1-5-7、StringTable垃圾回收"><a href="#1-5-7、StringTable垃圾回收" class="headerlink" title="1.5.7、StringTable垃圾回收"></a>1.5.7、StringTable垃圾回收</h3><h3 id="1-5-8、性能调优"><a href="#1-5-8、性能调优" class="headerlink" title="1.5.8、性能调优"></a>1.5.8、性能调优</h3><ul><li>调整 -XX:StringTableSize&#x3D;桶个数</li><li>考虑将字符串对象是否入池</li></ul><h2 id="1-6、直接内存（操作系统的内存）"><a href="#1-6、直接内存（操作系统的内存）" class="headerlink" title="1.6、直接内存（操作系统的内存）"></a>1.6、直接内存（操作系统的内存）</h2><h3 id="1-6-1、Direct-Memory"><a href="#1-6-1、Direct-Memory" class="headerlink" title="1.6.1、Direct Memory"></a>1.6.1、Direct Memory</h3><ul><li>常见于NIO操作时，用于数据缓冲区</li><li>分配回收成本较高，但读写性能高</li><li>不受JVM内存回收管理</li></ul><p>传统IO流文件读写过程：</p><p><img src="/JVM/image-20221026170923648.png" alt="image-20221026170923648"></p><p>NIO文件读写过程</p><p><img src="/JVM/image-20221026171211997.png" alt="image-20221026171211997"></p><h2 id="1-6-2、分配和回收原理"><a href="#1-6-2、分配和回收原理" class="headerlink" title="1.6.2、分配和回收原理"></a>1.6.2、分配和回收原理</h2><ul><li>使用了Unsafe对象 完成直接内存的分配回收，并且回收需要主动调用freeMemory方法</li><li>ByteBuffer的实现类内部，使用了Cleaner（虚引用）来检测ByteBuffer对象，一旦ByteBuffer对象被垃圾回收，那么就会由ReferenceHandler线程通过Cleaner的clean方法调用freeMemory来释放直接内存</li></ul><p>-XX:+DisableExplicitGC （禁用显示的垃圾回收）也就是代码中的System.gc()</p><h1 id="2、垃圾回收"><a href="#2、垃圾回收" class="headerlink" title="2、垃圾回收"></a>2、垃圾回收</h1><h2 id="2-1、如何判断对象可以回收？"><a href="#2-1、如何判断对象可以回收？" class="headerlink" title="2.1、如何判断对象可以回收？"></a>2.1、如何判断对象可以回收？</h2><h3 id="2-1-1、引用计数法"><a href="#2-1-1、引用计数法" class="headerlink" title="2.1.1、引用计数法"></a>2.1.1、引用计数法</h3><p><strong>概念：</strong>只要一个对象被其他变量所引用，那我就让这个对象的计数加一，如果它被引用了两次那就让它的计数变成二，如果某个变量不再引用它了那么就让它的计数减一，当这个对象的引用计数变为零的时候那就意味着没有人引用它了，那么它就会被垃圾回收。</p><p><strong>问题：</strong>循环引用</p><p><img src="/JVM/image-20221027085226369.png" alt="image-20221027085226369"></p><p>此时A、B的引用计数都为1，但没有对象使用他们了，又由于他们的引用计数都不唯一导致它们不能被垃圾回收。（早期python在垃圾回收时就采用了引用技术的算法。）</p><h3 id="2-1-2、可达性分析法"><a href="#2-1-2、可达性分析法" class="headerlink" title="2.1.2、可达性分析法"></a>2.1.2、可达性分析法</h3><p><strong>概念：</strong>首先会确定一系列根对象，根对象就是那些肯定不能当成垃圾被回收的对象。在垃圾回收之前首先会对堆中的所有对象进行一边扫描，看看哪些对象会被根对象直接或间接的引用，如果是这个对象就不能被回收，反之可以被回收。</p><ul><li>Java虚拟机中的垃圾回收器采用可达性分析算法来探索所有存活的对象</li><li>扫描堆中的对象，看是否能够沿着GC Root对象为起点的引用链找到该对象，找不到，表示可以回收</li><li>哪些对象可以作为GC Root？（System Class、Native Stack、Thread、Busy Monitor）</li></ul><p>使用过eclipse提供的Memory Analyzer(MAT)来帮助分析。</p><p>为了配合MAT的使用先运行起来再通过jmap快照抓取下来再用MAT进行分析。</p><h3 id="2-1-3、四种引用"><a href="#2-1-3、四种引用" class="headerlink" title="2.1.3、四种引用"></a>2.1.3、四种引用</h3><p><img src="/JVM/image-20221027092433116.png" alt="image-20221027092433116"></p><h4 id="2-1-3-1、强引用"><a href="#2-1-3-1、强引用" class="headerlink" title="2.1.3.1、强引用"></a>2.1.3.1、强引用</h4><ul><li><p>定义：沿着某个GC Root的引用链能够找到的对象就属于强引用。</p></li><li><p>回收条件：只有当所有强引用都断开时该对象才能被垃圾回收。</p></li></ul><h4 id="2-1-3-2、软引用-SoftReference"><a href="#2-1-3-2、软引用-SoftReference" class="headerlink" title="2.1.3.2、软引用(SoftReference)"></a>2.1.3.2、软引用(SoftReference)</h4><ul><li><p>仅有软引用引用过该对象时，在垃圾回收后，内存仍不足时会再次触发垃圾回收，回收引用对象</p></li><li><p>可以配合引用队列来释放软引用自身</p></li></ul><h4 id="2-1-3-3、弱引用-WeakReference"><a href="#2-1-3-3、弱引用-WeakReference" class="headerlink" title="2.1.3.3、弱引用(WeakReference)"></a>2.1.3.3、弱引用(WeakReference)</h4><ul><li>仅有弱引用引用该对象时，在垃圾回收时，无论内存是否充足，都会回收弱引用对象</li><li>可以配合引用队列来释放弱引用自身</li></ul><h4 id="2-1-3-4、虚引用-PhantomReference"><a href="#2-1-3-4、虚引用-PhantomReference" class="headerlink" title="2.1.3.4、虚引用(PhantomReference)"></a>2.1.3.4、虚引用(PhantomReference)</h4><ul><li>必须配合引用该队列使用，主要配合ByteBuffer使用，被引用对象回收时，会将虚引用入队，由Reference Handler线程调用虚拟引用相关方法释放直接内存</li></ul><h4 id="2-1-3-5、终结器引用-FinalReference"><a href="#2-1-3-5、终结器引用-FinalReference" class="headerlink" title="2.1.3.5、终结器引用(FinalReference)"></a>2.1.3.5、终结器引用(FinalReference)</h4><ul><li>必须配合引用该队列使用，无需手动编码，但其内部配合引用队列使用，在垃圾回收时，终结器引用入队(被引用对象暂时没看被回收)，再由Finalizer线程通过终结器引用找到被引用对象并调用它的finalize方法，第二次GC时才能回收被引用对象。</li></ul><p><strong>软引用实例：</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示软引用, 配合引用队列</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Demo2_4</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-built_in">int</span> _4MB = <span class="hljs-number">4</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> &#123;<br>        List&lt;SoftReference&lt;<span class="hljs-built_in">byte</span>[]&gt;&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><br>        <span class="hljs-comment">// 引用队列</span><br>        ReferenceQueue&lt;<span class="hljs-built_in">byte</span>[]&gt; queue = <span class="hljs-keyword">new</span> ReferenceQueue&lt;&gt;();<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-comment">// 关联了引用队列， 当软引用所关联的 byte[]被回收时，软引用自己会加入到 queue 中去</span><br>            SoftReference&lt;<span class="hljs-built_in">byte</span>[]&gt; <span class="hljs-keyword">ref</span> = <span class="hljs-keyword">new</span> SoftReference&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[_4MB], queue);<br>            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-keyword">ref</span>.<span class="hljs-keyword">get</span>());<br>            list.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">ref</span>);<br>            System.<span class="hljs-keyword">out</span>.println(list.size());<br>        &#125;<br><br>        <span class="hljs-comment">// 从队列中获取无用的 软引用对象，并移除</span><br>        Reference&lt;? extends <span class="hljs-built_in">byte</span>[]&gt; poll = queue.poll();<br>        <span class="hljs-keyword">while</span>( poll != <span class="hljs-literal">null</span>) &#123;<br>            list.<span class="hljs-keyword">remove</span>(poll);<br>            poll = queue.poll();<br>        &#125;<br><br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;===========================&quot;</span>);<br>        <span class="hljs-keyword">for</span> (SoftReference&lt;<span class="hljs-built_in">byte</span>[]&gt; reference : list) &#123;<br>            System.<span class="hljs-keyword">out</span>.println(reference.<span class="hljs-keyword">get</span>());<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>弱引用实例</strong>：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示弱引用</span><br><span class="hljs-comment"> * -Xmx20m -XX:+PrintGCDetails -verbose:gc</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Demo2_5</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-built_in">int</span> _4MB = <span class="hljs-number">4</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> &#123;<br>        <span class="hljs-comment">//  list --&gt; WeakReference --&gt; byte[]</span><br>        List&lt;WeakReference&lt;<span class="hljs-built_in">byte</span>[]&gt;&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            WeakReference&lt;<span class="hljs-built_in">byte</span>[]&gt; <span class="hljs-keyword">ref</span> = <span class="hljs-keyword">new</span> WeakReference&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[_4MB]);<br>            list.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">ref</span>);<br>            <span class="hljs-keyword">for</span> (WeakReference&lt;<span class="hljs-built_in">byte</span>[]&gt; w : list) &#123;<br>                System.<span class="hljs-keyword">out</span>.print(w.<span class="hljs-keyword">get</span>()+<span class="hljs-string">&quot; &quot;</span>);<br>            &#125;<br>            System.<span class="hljs-keyword">out</span>.println();<br><br>        &#125;<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;循环结束：&quot;</span> + list.size());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-2、垃圾回收算法"><a href="#2-2、垃圾回收算法" class="headerlink" title="2.2、垃圾回收算法"></a>2.2、垃圾回收算法</h2><h3 id="2-2-1、标记清除"><a href="#2-2-1、标记清除" class="headerlink" title="2.2.1、标记清除"></a>2.2.1、标记清除</h3><p>定义：Mark Sweep</p><p><img src="/JVM/image-20221027135600774.png" alt="image-20221027135600774"></p><p>优点：速度快</p><p>缺点：容易产生内存碎片</p><h3 id="2-2-2、标记整理"><a href="#2-2-2、标记整理" class="headerlink" title="2.2.2、标记整理"></a>2.2.2、标记整理</h3><p>定义：Mark Compact</p><p><img src="/JVM/image-20221027135813905.png" alt="image-20221027135813905"></p><p>优点：不会产生内存碎片</p><p>缺点：效率比较低</p><h3 id="2-2-3、复制"><a href="#2-2-3、复制" class="headerlink" title="2.2.3、复制"></a>2.2.3、复制</h3><p>定义：Copy</p><p><img src="/JVM/image-20221027135944213.png" alt="image-20221027135944213"></p><p><img src="/JVM/image-20221027135957779.png" alt="image-20221027135957779"></p><p><img src="/JVM/image-20221027140013820.png" alt="image-20221027140013820"> </p><p><img src="/JVM/image-20221027140030356.png" alt="image-20221027140030356"></p><p>优点：不会产生内存碎片</p><p>缺点：会占用双倍的内存空间</p><h2 id="2-3、分代垃圾回收"><a href="#2-3、分代垃圾回收" class="headerlink" title="2.3、分代垃圾回收"></a>2.3、分代垃圾回收</h2><p><strong>老年代：</strong>Java中长时间使用（长时间存活）的对象存储在老年代当中，老年代的垃圾回收很久才发生一次</p><p><strong>新生代</strong>：Java中用完了就可以丢弃的（朝生幕死）对象存储在新生代当中，新生代的垃圾回收(Minor GC)发生的比较频繁</p><p><img src="/JVM/image-20221027140540693.png" alt="image-20221027140540693"></p><p><strong>分代垃圾回收的执行顺序：</strong></p><p><img src="/JVM/image-20221027141430630.png" alt="image-20221027141430630"></p><ul><li><p>对象首先分配在伊甸园区域</p></li><li><p>当新生代空间不足时，触发minor GC，伊甸园和from存活的对象使用copy算法复制到to中，存活的对象年龄加一并且交换from和to</p></li><li><p>minor GC会引发stop the world，暂停其它用户的线程，等垃圾回收结束，用户线程才恢复运行</p></li><li><p>当对象寿命超过阈值时，会晋升至老年代，最大寿命是15（4bit）</p></li><li><p>当老年代空间不足，会尝试先出发minor GC，如果之后仍空间不足，那么会触发full GC(STW的时间更长)。</p></li><li><p>如果full GC之后空间仍不足，则会触发OOM(Out Of Memory)异常</p><p><strong>相关VM参数</strong></p><table><thead><tr><th>含义</th><th>参数</th></tr></thead><tbody><tr><td>堆初始大小</td><td>-Xms</td></tr><tr><td>堆最大大小</td><td>-Xmx或-XX:MaxHeapSize&#x3D;size</td></tr><tr><td>新生代大小</td><td>-Xmn或（-XX:NewSize&#x3D;size + -XX:MaxNewSize&#x3D;size）</td></tr><tr><td>幸存区比例（动态）</td><td>-XX:InitialSurvivorRatio&#x3D;ratio和-XX:+UseAdaptiveSizePolicy</td></tr><tr><td>幸存区比例</td><td>-XX:SurvivorRatio&#x3D;ratio</td></tr><tr><td>晋升阈值</td><td>-XX:MaxTenuringThreshold&#x3D;threshold</td></tr><tr><td>晋升详情</td><td>-XX:+PrintTenuringDistribution</td></tr><tr><td>GC详情</td><td>-XX:+PrintGCDetails -verbose:gc</td></tr><tr><td>Full GC 前 Minor GC</td><td>-XX:+ScavengeBeforeFullGC</td></tr></tbody></table></li><li><p>一个线程内部的OOM不会导致整个主线程终短</p></li></ul><h2 id="2-4、垃圾回收器"><a href="#2-4、垃圾回收器" class="headerlink" title="2.4、垃圾回收器"></a>2.4、垃圾回收器</h2><h3 id="2-4-1、串行"><a href="#2-4-1、串行" class="headerlink" title="2.4.1、串行"></a>2.4.1、串行</h3><ul><li><p>单线程</p></li><li><p>堆内存较小，适合个人电脑</p></li><li><p>开启串行回收器语句： -XX:UseSerialGC &#x3D; Serial + SerialOld</p><p>**ps:**此处的Serial处于新生代，采用的算法为复制(Copy)算法。Serialold处于老年代，采用的算法为标记整理算法。</p><p><img src="/JVM/image-20221027200556584.png" alt="image-20221027200556584"></p></li></ul><h3 id="2-4-2、吞吐量优先"><a href="#2-4-2、吞吐量优先" class="headerlink" title="2.4.2、吞吐量优先"></a>2.4.2、吞吐量优先</h3><ul><li><p>多线程</p></li><li><p>堆内存较大，多核CPU</p></li><li><p>让单位时间内，STW的时间最短0.2 0.2 &#x3D; 0.4，垃圾回收时间占比最低，这样就称吞吐量高</p></li><li><p>开启吞吐量优先回收器语句：-XX:+UseParallelGC ~ -XX:+UseParallelOldGC</p><ul><li>控制线程数：-XX:ParallelGCThreads&#x3D;n</li><li>采用调整自适应大小策略(调整的是新生代的大小)：-XX:+UseAdaptiveSizePolicy</li><li>用来调整堆的大小来达到期望的吞吐量目标-XX:GCTimeRatio&#x3D;ratio （公式：1&#x2F;(1+ratio)）(若ratio为99，则意为允许在100分钟内有1分钟的时间来STW用来GC)</li><li>用来调整每次垃圾回收的期望时间(默认的为200ms)-XX:MaxGCPauseMillis&#x3D;ms</li></ul><p><img src="/JVM/image-20221027201022728.png" alt="image-20221027201022728"></p></li></ul><h3 id="2-4-3、响应时间优先"><a href="#2-4-3、响应时间优先" class="headerlink" title="2.4.3、响应时间优先"></a>2.4.3、响应时间优先</h3><ul><li><p>多线程</p></li><li><p>堆内存较大，多核CPU</p></li><li><p>尽可能让单次STW的时间最短0.1 0.1 0.1 0.1 0.1&#x3D;0.5</p></li><li><p>开启响应时间优先的回收器语句：-XX:+UseConcMarkSweepGC ~ -XX:+UseParNewGC ~ SerialOld</p><ul><li><p>并行和并发的线程数设置：-XX:ParallelGCThreads&#x3D;n ~ -XX:ConcGCThreads&#x3D;threads</p></li><li><p>执行CMS垃圾回收的内存占比：-XX:CMSInitiatingOccupancyFraction&#x3D;percent</p></li><li><p>设置CMS垃圾回收重新标记前清除垃圾：-XX:+CMSScavengeBeforeRemark</p></li></ul></li></ul><p><strong>ps：</strong>此处的ConcMarkSweepGC是工作在老年代的基于标记清除法的垃圾回收器，与之配合的是UseParNewGC，它是工作在新生代的基于复制算法的垃圾回收器。有时CMSGC会发生并发失败的问题，这个时候会采用补救措施SerialOld。</p><p><img src="/JVM/image-20221027202342818.png" alt="image-20221027202342818"></p><h3 id="2-4-4、G1"><a href="#2-4-4、G1" class="headerlink" title="2.4.4、G1"></a>2.4.4、G1</h3><p>定义：Garbage First</p><ul><li>2004 论文发布 </li><li>2009 JDK 6u14 体验 </li><li>2012 JDK 7u4 官方支持 </li><li>2017 JDK 9 默认</li></ul><p>适用场景</p><ul><li>同时注重吞吐量（Throughput）和低延迟（Low latency），默认的暂停目标是 200 ms</li><li>超大堆内存，会将堆划分为多个大小相等的 Region</li><li>整体上是 标记+整理 算法，两个区域之间是 复制 算法</li></ul><p>相关JVM参数</p><ul><li><p>开启G1语句：-XX:+UseG1GC </p><ul><li><p>-XX:G1HeapRegionSize&#x3D;size </p></li><li><p>-XX:MaxGCPauseMillis&#x3D;time</p></li></ul></li></ul><h4 id="1）G1垃圾回收阶段"><a href="#1）G1垃圾回收阶段" class="headerlink" title="1）G1垃圾回收阶段"></a>1）G1垃圾回收阶段</h4><p><img src="/JVM/image-20221028090805853.png" alt="image-20221028090805853"></p><h4 id="2）Young-Collection"><a href="#2）Young-Collection" class="headerlink" title="2）Young Collection"></a>2）Young Collection</h4><ul><li>会STW</li></ul><p><img src="/JVM/image-20221028094245001.png" alt="image-20221028094245001"></p><p><img src="/JVM/image-20221028094253567.png" alt="image-20221028094253567"></p><p><img src="/JVM/image-20221028094305004.png" alt="image-20221028094305004"></p><h4 id="3）Young-Collection-CM-Concurrent-Mark"><a href="#3）Young-Collection-CM-Concurrent-Mark" class="headerlink" title="3）Young Collection + CM(Concurrent Mark)"></a>3）Young Collection + CM(Concurrent Mark)</h4><ul><li>在Young GC时会进行GC Root的初始标记</li><li>老年代占用堆空间比例达到阈值时，进行并发标记(不会STW)，有下面的JVM参数决定</li></ul><p>-XX:InitiatingHeapOccupancyPercent&#x3D;percent(默认45%)</p><p><img src="/JVM/image-20221028094850389.png" alt="image-20221028094850389"></p><h4 id="4）Mixed-Collection"><a href="#4）Mixed-Collection" class="headerlink" title="4）Mixed Collection"></a>4）Mixed Collection</h4><p>会对E、S、O进行全面垃圾回收</p><ul><li>最终标记(Remark)会STW</li><li>拷贝存活(Evacuation)会STW</li></ul><p>-XX:MaxGCPauseMillis&#x3D;ms</p><p><img src="/JVM/image-20221028095006258.png" alt="image-20221028095006258"></p><h4 id="5）Full-GC"><a href="#5）Full-GC" class="headerlink" title="5）Full GC"></a>5）Full GC</h4><ul><li>SerialGC<ul><li>新生代内存不足发生的垃圾收集器 - minor GC</li><li>老年代内存不足发生的垃圾收集器 - ful GC</li></ul></li><li>ParallelGC<ul><li>新生代内存不足发生的垃圾收集 - minor GC</li><li>老年代内存不足发生的垃圾收集 - full GC</li></ul></li><li>CMS<ul><li>新生代内存不足发生的垃圾收集 - minor GC</li><li>老年代内存不足</li></ul></li><li>G1<ul><li>新生代内存不足发生的垃圾收集 - minor GC</li><li>老年代内存不足</li></ul></li></ul><h4 id="6）Young-Collection跨代引用"><a href="#6）Young-Collection跨代引用" class="headerlink" title="6）Young Collection跨代引用"></a>6）Young Collection跨代引用</h4><ul><li>新生代回收的跨代引用(老年代引用新生代)问题</li></ul><p><img src="/JVM/image-20221028095213153.png" alt="image-20221028095213153"></p><ul><li>卡表与 Remembered Set</li><li>在引用变更时通过 post-write barrier + dirty card queue</li><li>concurrent refinement threads 更新 Remembered Set</li></ul><p><img src="/JVM/image-20221028095242383.png" alt="image-20221028095242383"></p><h4 id="7）Remark"><a href="#7）Remark" class="headerlink" title="7）Remark"></a>7）Remark</h4><ul><li>pre-write barrier + satb_mark_queue</li></ul><p><img src="/JVM/image-20221028095308744.png" alt="image-20221028095308744"></p><h4 id="8）JDK-8u20字符串去重"><a href="#8）JDK-8u20字符串去重" class="headerlink" title="8）JDK 8u20字符串去重"></a>8）JDK 8u20字符串去重</h4><ul><li>优点：节省大量内存</li><li>缺点：略微躲闪用了cpu时间，新生代回收时间略微增加</li></ul><p>-XX:+UseStringDeduplication</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">String</span> s1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">String</span>(<span class="hljs-string">&quot;hello&quot;</span>); <span class="hljs-regexp">//</span> char[]&#123;<span class="hljs-string">&#x27;h&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>&#125;<br><span class="hljs-built_in">String</span> s2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">String</span>(<span class="hljs-string">&quot;hello&quot;</span>); <span class="hljs-regexp">//</span> char[]&#123;<span class="hljs-string">&#x27;h&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>&#125;<br></code></pre></td></tr></table></figure><ul><li>将所有新分配的字符串放入一个队列</li><li>当新生代回收时，G1并发检查是否有字符串重复</li><li>如果它们值一样，让它们引用同一个 char[]</li><li>注意，与 String.intern() 不一样<ul><li>String.intern() 关注的是字符串对象</li><li>而字符串去重关注的是 char[]</li><li>在 JVM 内部，使用了不同的字符串表</li></ul></li></ul><h4 id="9）JDK-8u40并发标记类卸载"><a href="#9）JDK-8u40并发标记类卸载" class="headerlink" title="9）JDK 8u40并发标记类卸载"></a>9）JDK 8u40并发标记类卸载</h4><p>所有对象都经过并发标记后，就能知道哪些类不再被使用，当一个类加载器的所有类都不再使用，则卸 载它所加载的所有类</p><p>-XX:+ClassUnloadingWithConcurrentMark 默认启用</p><h4 id="10）JDK-8u60回收巨型对象"><a href="#10）JDK-8u60回收巨型对象" class="headerlink" title="10）JDK 8u60回收巨型对象"></a>10）JDK 8u60回收巨型对象</h4><ul><li>一个对象大于 region 的一半时，称之为巨型对象</li><li>G1 不会对巨型对象进行拷贝</li><li>回收时被优先考虑</li><li>G1 会跟踪老年代所有 incoming 引用，这样老年代 incoming 引用为0 的巨型对象就可以在新生 代垃圾回收时处理掉</li></ul><h4 id="11）JDK-9-并发标记起始时间的调整"><a href="#11）JDK-9-并发标记起始时间的调整" class="headerlink" title="11）JDK 9 并发标记起始时间的调整"></a>11）JDK 9 并发标记起始时间的调整</h4><ul><li>并发标记必须在堆空间占满前完成，否则退化为 FullGC</li><li>JDK 9 之前需要使用 -XX:InitiatingHeapOccupancyPercent</li><li>JDK 9 可以动态调整<ul><li>-XX:InitiatingHeapOccupancyPercent 用来设置初始值</li><li>进行数据采样并动态调整</li><li>总会添加一个安全的空档空间</li></ul></li></ul><h4 id="12）JDK-9-更高效的回收"><a href="#12）JDK-9-更高效的回收" class="headerlink" title="12）JDK 9 更高效的回收"></a>12）JDK 9 更高效的回收</h4><ul><li>250+增强 </li><li>180+bug修复 </li><li><a href="https://docs.oracle.com/en/java/javase/12/gctuning">https://docs.oracle.com/en/java/javase/12/gctuning</a></li></ul><h2 id="2-5、垃圾回收调优"><a href="#2-5、垃圾回收调优" class="headerlink" title="2.5、垃圾回收调优"></a>2.5、垃圾回收调优</h2><p>预备知识</p><ul><li>掌握GC相关的VM参数，会基本的空间调整</li><li>掌握相关工具</li><li>明白一点：调优跟应用、环境有关，没有放之四海而皆准的法则</li></ul><p>查看当前虚拟机运行参数：</p><p>java -XX:+PrintFlagsFinal -version | findstr “GC”</p><ul><li>-XX:+PrintFlagsInitial 是打印所有的默认参数设置</li><li>-XX:+PrintFlagsFinal 是打印最终值，如果某个默认值被新值覆盖，显示新值</li><li>-XX:+PrintCommandLineFlags 是打印那些被新值覆盖的项</li></ul><h3 id="2-5-1、调优领域"><a href="#2-5-1、调优领域" class="headerlink" title="2.5.1、调优领域"></a>2.5.1、调优领域</h3><ul><li>内存</li><li>竞争锁</li><li>cpu占用</li><li>IO</li></ul><h3 id="2-5-2、确定目标"><a href="#2-5-2、确定目标" class="headerlink" title="2.5.2、确定目标"></a>2.5.2、确定目标</h3><ul><li>[低延迟]还是[高吞吐量]，选择合适的回收器，比如：如果开发的是进行科学研究一般要求高吞吐量而不是低延迟，而如果开发的是互联网项目一般要求低延迟。</li><li>低延迟的垃圾回收器有：CMS,G1,ZGC</li><li>高吞吐量的垃圾回收器有：ParallelGC</li><li>Zing虚拟机号称0停顿</li></ul><h3 id="2-5-3、最快的GC是不发生GC"><a href="#2-5-3、最快的GC是不发生GC" class="headerlink" title="2.5.3、最快的GC是不发生GC"></a>2.5.3、最快的GC是不发生GC</h3><ul><li>查看FullGC前后的内存占用，考虑下面几个问题<ul><li>数据是不是太多？</li><li>数据表示是否太臃肿？<ul><li>对象图</li><li>对象大小</li></ul></li><li>是否存在内存泄漏?</li></ul></li></ul><h3 id="2-5-4、新生代调优"><a href="#2-5-4、新生代调优" class="headerlink" title="2.5.4、新生代调优"></a>2.5.4、新生代调优</h3><ul><li>新生代的特点<ul><li>所有的new操作的内存分配非常廉价<ul><li>TLAB thread-local allocation buffer</li></ul></li><li>死亡对象的回收代价是零</li><li>大部分对象用过即死</li><li>Minor GC的时间远远低于Full GC</li></ul></li><li>新生代的内存越大越好吗？</li></ul><p>-Xmn Sets the initial and maximum size (in bytes) of the heap for the young generation (nursery). GC is performed in this region more often than in other regions. If the size for the young generation is too small, then a lot of minor garbage collections are performed. If the size is too large, then only full garbage collections are performed, which can take a long time to complete. Oracle recommends that you keep the size for the young generation greater than 25% and less than 50% of the overall heap size.</p><ul><li>调优后的理想状态（调优规则）：<ul><li>新生代能容纳所有【并发量 * (请求-响应)】的数据</li><li>幸存区大到能保留【当前活跃对象+需要晋升对象】</li><li>晋升阈值配置得当，让长时间存活对象尽快晋升</li></ul></li></ul><p>-XX:MaxTenuringThreshold&#x3D;threshold </p><p>-XX:+PrintTenuringDistribution</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs terminal">Desired survivor size 48286924 bytes, new threshold 10 (max 10)<br>- age 1: 28992024 bytes, 28992024 total<br>- age 2: 1366864 bytes, 30358888 total<br>- age 3: 1425912 bytes, 31784800 total<br>...<br></code></pre></td></tr></table></figure><h3 id="2-5-5、老年代调优"><a href="#2-5-5、老年代调优" class="headerlink" title="2.5.5、老年代调优"></a>2.5.5、老年代调优</h3><p>以CMS为例</p><ul><li><p>调优后的理想状态（调优规则）：</p><ul><li><p>以 CMS 为例 CMS 的老年代内存越大越好</p></li><li><p>先尝试不做调优，如果没有 Full GC 那么说明已经很不错了，否则先尝试调优新生代 </p></li><li><p>观察发生 Full GC 时老年代内存占用，将老年代内存预设调大 1&#x2F;4 ~ 1&#x2F;3</p><ul><li>-XX:CMSInitiatingOccupancyFraction&#x3D;percent</li></ul></li></ul></li></ul><h3 id="2-5-6、案例"><a href="#2-5-6、案例" class="headerlink" title="2.5.6、案例"></a>2.5.6、案例</h3><ul><li>案例1：Full GC 和 Minor GC频繁<ul><li>分析：GC特别频繁，说明我们的空间紧张，究竟是哪部分空间紧张呢？如果是新生代空间紧张，那么当我们业务高峰期来了大量对象被创建很快就把我们新生代的空间给塞满了，如果塞满了还会造成一个后果，它空间紧张了那么它对象晋升的阈值就会降低，导致很多本来生存周期很短的对象也会被晋升到老年代去，这样情况就进一步恶化了。老年代就会存在很多生存周期很短的对象，然后进一步触发Full GC的频繁发生。</li><li>解决方法：增大了新生代的内存，之后新生代的内存充裕了这样Minor GC就不在那么频繁了，同时增大了幸存区的空间同时也提高了晋升阈值。这样就会让很多生命周期较短的对象尽可能的留在新生代而不要晋升到老年代中，这样也就会使老年代的Full GC频率降低。</li></ul></li><li>案列2：请求高峰期发生Full GC，单次暂停时间特别长(CMS)<ul><li>分析：</li><li>解决方法：</li></ul></li><li>案例3：老年代充裕情况下，发生Full GC（1.7）<ul><li>分析：</li><li>解决方法：</li></ul></li></ul><h1 id="3、类加载与字节码技术"><a href="#3、类加载与字节码技术" class="headerlink" title="3、类加载与字节码技术"></a>3、类加载与字节码技术</h1><p><img src="/JVM/image-20221031110544226.png" alt="image-20221031110544226"></p><h2 id="3-1、类文件结构"><a href="#3-1、类文件结构" class="headerlink" title="3.1、类文件结构"></a>3.1、类文件结构</h2><p>一个简单的 HelloWorld.java</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript">package cn.<span class="hljs-property">itcast</span>.<span class="hljs-property">jvm</span>.<span class="hljs-property">t5</span>;<br><br><span class="hljs-comment">// HelloWorld 示例</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) &#123;<br><span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;hello world&quot;</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>执行 javac -parameters -d . HellowWorld.java </p><p>编译为 HelloWorld.class 后是这个样子的：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@localhost ~]<span class="hljs-comment"># od -t xC HelloWorld.class</span><br>0000000 ca fe ba be<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>34<span class="hljs-number"> 00 </span>23 0a<span class="hljs-number"> 00 </span>06<span class="hljs-number"> 00 </span>15 09<br>0000020<span class="hljs-number"> 00 </span>16<span class="hljs-number"> 00 </span>17<span class="hljs-number"> 08 </span>00<span class="hljs-number"> 18 </span>0a<span class="hljs-number"> 00 </span>19<span class="hljs-number"> 00 </span>1a<span class="hljs-number"> 07 </span>00 1b 07<br>0000040<span class="hljs-number"> 00 </span>1c<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 06 </span>3c<span class="hljs-number"> 69 </span>6e<span class="hljs-number"> 69 </span>74 3e<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 03 </span>28 29<br>0000060<span class="hljs-number"> 56 </span>01<span class="hljs-number"> 00 </span>04<span class="hljs-number"> 43 </span>6f<span class="hljs-number"> 64 </span>65<span class="hljs-number"> 01 </span>00 0f 4c<span class="hljs-number"> 69 </span>6e<span class="hljs-number"> 65 </span>4e<br>0000100<span class="hljs-number"> 75 </span>6d<span class="hljs-number"> 62 </span>65<span class="hljs-number"> 72 </span>54<span class="hljs-number"> 61 </span>62 6c<span class="hljs-number"> 65 </span>01<span class="hljs-number"> 00 </span>12 4c 6f 63<br>0000120<span class="hljs-number"> 61 </span>6c<span class="hljs-number"> 56 </span>61<span class="hljs-number"> 72 </span>69<span class="hljs-number"> 61 </span>62 6c<span class="hljs-number"> 65 </span>54<span class="hljs-number"> 61 </span>62 6c<span class="hljs-number"> 65 </span>01<br>0000140<span class="hljs-number"> 00 </span>04<span class="hljs-number"> 74 </span>68<span class="hljs-number"> 69 </span>73<span class="hljs-number"> 01 </span>00 1d 4c<span class="hljs-number"> 63 </span>6e 2f<span class="hljs-number"> 69 </span>74 63<br>0000160<span class="hljs-number"> 61 </span>73<span class="hljs-number"> 74 </span>2f 6a<span class="hljs-number"> 76 </span>6d 2f<span class="hljs-number"> 74 </span>35 2f<span class="hljs-number"> 48 </span>65 6c 6c 6f<br>0000200<span class="hljs-number"> 57 </span>6f<span class="hljs-number"> 72 </span>6c<span class="hljs-number"> 64 </span>3b<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 04 </span>6d<span class="hljs-number"> 61 </span>69 6e<span class="hljs-number"> 01 </span>00 16<br>0000220<span class="hljs-number"> 28 </span>5b 4c 6a<span class="hljs-number"> 61 </span>76<span class="hljs-number"> 61 </span>2f 6c<span class="hljs-number"> 61 </span>6e<span class="hljs-number"> 67 </span>2f<span class="hljs-number"> 53 </span>74 72<br>0000240<span class="hljs-number"> 69 </span>6e<span class="hljs-number"> 67 </span>3b<span class="hljs-number"> 29 </span>56<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 04 </span>61<span class="hljs-number"> 72 </span>67<span class="hljs-number"> 73 </span>01<span class="hljs-number"> 00 </span>13<br>0000260 5b 4c 6a<span class="hljs-number"> 61 </span>76<span class="hljs-number"> 61 </span>2f 6c<span class="hljs-number"> 61 </span>6e<span class="hljs-number"> 67 </span>2f<span class="hljs-number"> 53 </span>74<span class="hljs-number"> 72 </span>69<br>0000300 6e<span class="hljs-number"> 67 </span>3b<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 10 </span>4d<span class="hljs-number"> 65 </span>74<span class="hljs-number"> 68 </span>6f<span class="hljs-number"> 64 </span>50<span class="hljs-number"> 61 </span>72 61<br>0000320 6d<span class="hljs-number"> 65 </span>74<span class="hljs-number"> 65 </span>72<span class="hljs-number"> 73 </span>01<span class="hljs-number"> 00 </span>0a<span class="hljs-number"> 53 </span>6f<span class="hljs-number"> 75 </span>72<span class="hljs-number"> 63 </span>65 46<br>0000340<span class="hljs-number"> 69 </span>6c<span class="hljs-number"> 65 </span>01<span class="hljs-number"> 00 </span>0f<span class="hljs-number"> 48 </span>65 6c 6c 6f<span class="hljs-number"> 57 </span>6f<span class="hljs-number"> 72 </span>6c 64<br>0000360 2e 6a<span class="hljs-number"> 61 </span>76<span class="hljs-number"> 61 </span>0c<span class="hljs-number"> 00 </span>07<span class="hljs-number"> 00 </span>08<span class="hljs-number"> 07 </span>00 1d 0c<span class="hljs-number"> 00 </span>1e<br>0000400<span class="hljs-number"> 00 </span>1f<span class="hljs-number"> 01 </span>00 0b<span class="hljs-number"> 68 </span>65 6c 6c 6f<span class="hljs-number"> 20 </span>77 6f<span class="hljs-number"> 72 </span>6c 64<br>0000420<span class="hljs-number"> 07 </span>00<span class="hljs-number"> 20 </span>0c<span class="hljs-number"> 00 </span>21<span class="hljs-number"> 00 </span>22<span class="hljs-number"> 01 </span>00 1b<span class="hljs-number"> 63 </span>6e 2f<span class="hljs-number"> 69 </span>74<br>0000440<span class="hljs-number"> 63 </span>61<span class="hljs-number"> 73 </span>74 2f 6a<span class="hljs-number"> 76 </span>6d 2f<span class="hljs-number"> 74 </span>35 2f<span class="hljs-number"> 48 </span>65 6c 6c<br>0000460 6f<span class="hljs-number"> 57 </span>6f<span class="hljs-number"> 72 </span>6c<span class="hljs-number"> 64 </span>01<span class="hljs-number"> 00 </span>10 6a<span class="hljs-number"> 61 </span>76<span class="hljs-number"> 61 </span>2f 6c 61<br>0000500 6e<span class="hljs-number"> 67 </span>2f 4f<span class="hljs-number"> 62 </span>6a<span class="hljs-number"> 65 </span>63<span class="hljs-number"> 74 </span>01<span class="hljs-number"> 00 </span>10 6a<span class="hljs-number"> 61 </span>76 61<br>0000520 2f 6c<span class="hljs-number"> 61 </span>6e<span class="hljs-number"> 67 </span>2f<span class="hljs-number"> 53 </span>79<span class="hljs-number"> 73 </span>74<span class="hljs-number"> 65 </span>6d<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 03 </span>6f<br>0000540<span class="hljs-number"> 75 </span>74<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 15 </span>4c 6a<span class="hljs-number"> 61 </span>76<span class="hljs-number"> 61 </span>2f<span class="hljs-number"> 69 </span>6f 2f<span class="hljs-number"> 50 </span>72<br>0000560<span class="hljs-number"> 69 </span>6e<span class="hljs-number"> 74 </span>53<span class="hljs-number"> 74 </span>72<span class="hljs-number"> 65 </span>61 6d 3b<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 13 </span>6a<span class="hljs-number"> 61 </span>76<br>0000600<span class="hljs-number"> 61 </span>2f<span class="hljs-number"> 69 </span>6f 2f<span class="hljs-number"> 50 </span>72<span class="hljs-number"> 69 </span>6e<span class="hljs-number"> 74 </span>53<span class="hljs-number"> 74 </span>72<span class="hljs-number"> 65 </span>61 6d<br>0000620<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 07 </span>70<span class="hljs-number"> 72 </span>69 6e<span class="hljs-number"> 74 </span>6c 6e<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 15 </span>28 4c 6a<br>0000640<span class="hljs-number"> 61 </span>76<span class="hljs-number"> 61 </span>2f 6c<span class="hljs-number"> 61 </span>6e<span class="hljs-number"> 67 </span>2f<span class="hljs-number"> 53 </span>74<span class="hljs-number"> 72 </span>69 6e<span class="hljs-number"> 67 </span>3b<br>0000660<span class="hljs-number"> 29 </span>56<span class="hljs-number"> 00 </span>21<span class="hljs-number"> 00 </span>05<span class="hljs-number"> 00 </span>06<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>02<span class="hljs-number"> 00 </span>01<br>0000700<span class="hljs-number"> 00 </span>07<span class="hljs-number"> 00 </span>08<span class="hljs-number"> 00 </span>01<span class="hljs-number"> 00 </span>09<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>2f<span class="hljs-number"> 00 </span>01<span class="hljs-number"> 00 </span>01<br>0000720<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>05 2a b7<span class="hljs-number"> 00 </span>01 b1<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>02<span class="hljs-number"> 00 </span>0a 00<br>0000740<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 06 </span>00<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 04 </span>00 0b<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>0c 00<br>0000760<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 05 </span>00 0c<span class="hljs-number"> 00 </span>0d<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>09<span class="hljs-number"> 00 </span>0e 00<br>0001000 0f<span class="hljs-number"> 00 </span>02<span class="hljs-number"> 00 </span>09<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>37<span class="hljs-number"> 00 </span>02<span class="hljs-number"> 00 </span>01<span class="hljs-number"> 00 </span>00 00<br>0001020<span class="hljs-number"> 09 </span>b2<span class="hljs-number"> 00 </span>02<span class="hljs-number"> 12 </span>03 b6<span class="hljs-number"> 00 </span>04 b1<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>02<span class="hljs-number"> 00 </span>0a<br>0001040<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>0a<span class="hljs-number"> 00 </span>02<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>06<span class="hljs-number"> 00 </span>08<span class="hljs-number"> 00 </span>07<span class="hljs-number"> 00 </span>0b<br>0001060<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>0c<span class="hljs-number"> 00 </span>01<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>09<span class="hljs-number"> 00 </span>10<span class="hljs-number"> 00 </span>11<span class="hljs-number"> 00 </span>00<br>0001100<span class="hljs-number"> 00 </span>12<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>05<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 10 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 13 </span>00<br>0001120<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 02 </span>00 14<br></code></pre></td></tr></table></figure><p>根据JVM规范，类文件结构如下:</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs abnf">ClassFile &#123;<br>u4 magic<span class="hljs-comment">;</span><br>u2 minor_version<span class="hljs-comment">;</span><br>u2 major_version<span class="hljs-comment">;</span><br>u2 constant_pool_count<span class="hljs-comment">;</span><br>cp_info constant_pool[constant_pool_count-<span class="hljs-number">1</span>]<span class="hljs-comment">;</span><br>u2 access_flags<span class="hljs-comment">;</span><br>u2 this_class<span class="hljs-comment">;</span><br>u2 super_class<span class="hljs-comment">;</span><br>u2 interfaces_count<span class="hljs-comment">;</span><br>u2 interfaces[interfaces_count]<span class="hljs-comment">;</span><br>u2 fields_count<span class="hljs-comment">;</span><br>field_info fields[fields_count]<span class="hljs-comment">;</span><br>u2 methods_count<span class="hljs-comment">;</span><br>method_info methods[methods_count]<span class="hljs-comment">;</span><br>u2 attributes_count<span class="hljs-comment">;</span><br>attribute_info attributes[attributes_count]<span class="hljs-comment">;</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-1-1、魔术-magic"><a href="#3-1-1、魔术-magic" class="headerlink" title="3.1.1、魔术(magic)"></a>3.1.1、魔术(magic)</h3><p>0~3 字节，表示它是否是【class】类型的文件 </p><p>0000000 <em><strong>ca fe ba be</strong></em> 00 00 00 34 00 23 0a 00 06 00 15 09</p><h3 id="3-1-2、版本"><a href="#3-1-2、版本" class="headerlink" title="3.1.2、版本"></a>3.1.2、版本</h3><p>4~7 字节，表示类的版本 00 34（52） 表示是 Java 8</p><p>0000000 ca fe ba be <em><strong>00 00 00 34</strong></em> 00 23 0a 00 06 00 15 09</p><h3 id="3-1-3、常量池"><a href="#3-1-3、常量池" class="headerlink" title="3.1.3、常量池"></a>3.1.3、常量池</h3><table><thead><tr><th>ConstantType</th><th>Value</th></tr></thead><tbody><tr><td>CONSTANT_Class</td><td>7</td></tr><tr><td>CONSTANT_Fieldref</td><td>9</td></tr><tr><td>CONSTANT_Methodref</td><td>10</td></tr><tr><td>CONSTANT_InterfaceMethodref</td><td>11</td></tr><tr><td>CONSTANT_String</td><td>8</td></tr><tr><td>CONSTANT_Integer</td><td>3</td></tr><tr><td>CONSTANT_Float</td><td>4</td></tr><tr><td>CONSTANT_Long</td><td>5</td></tr><tr><td>CONSTANT_Double</td><td>6</td></tr><tr><td>CONSTANT_NameAndType</td><td>12</td></tr><tr><td>CONSTANT_Uft8</td><td>1</td></tr><tr><td>CONSTANT_MethodHandle</td><td>15</td></tr><tr><td>CONSTANT_MethodType</td><td>16</td></tr><tr><td>CONSTANT_InvokeDynamic</td><td>18</td></tr></tbody></table><p>8<del>9 字节，表示常量池长度，00 23 （35） 表示常量池有 #1</del>#34项，注意 #0 项不计入，也没有值 </p><p>0000000 ca fe ba be 00 00 00 34 00 <em><strong>23 0a</strong></em> 00 06 00 15 09</p><p>第#1项 0a 表示一个 Method 信息，00 06 和 00 15（21） 表示它引用了常量池中 #6 和 #21 项来获得 这个方法的【所属类】和【方法名】 </p><p>0000000 ca fe ba be 00 00 00 34 00 23 <em><strong>0a 00 06 00 15</strong></em> 09</p><p>第#2项 09 表示一个 Field 信息，00 16（22）和 00 17（23） 表示它引用了常量池中 #22 和 # 23 项 来获得这个成员变量的【所属类】和【成员变量名】 </p><p>0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 <em><strong>09</strong></em> </p><p>0000020 <em><strong>00 16 00 17</strong></em> 08 00 18 0a 00 19 00 1a 07 00 1b 07</p><p>第#3项 08 表示一个字符串常量名称，00 18（24）表示它引用了常量池中 #24 项 </p><p>0000020 00 16 00 17 <em><strong>08 00 18</strong></em> 0a 00 19 00 1a 07 00 1b 07</p><p>第#4项 0a 表示一个 Method 信息，00 19（25） 和 00 1a（26） 表示它引用了常量池中 #25 和 #26 项来获得这个方法的【所属类】和【方法名】 </p><p>0000020 00 16 00 17 08 00 18 <em><strong>0a 00 19 00 1a</strong></em> 07 00 1b 07</p><p>第#5项 07 表示一个 Class 信息，00 1b（27） 表示它引用了常量池中 #27 项</p><p>0000020 00 16 00 17 08 00 18 0a 00 19 00 1a <em><strong>07 00 1b</strong></em> 07</p><p>第#6项 07 表示一个 Class 信息，00 1c（28） 表示它引用了常量池中 #28 项 </p><p>0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b <em><strong>07</strong></em> </p><p>0000040 <em><strong>00 1c</strong></em> 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29</p><p>第#7项 01 表示一个 utf8 串，00 06 表示长度，3c 69 6e 69 74 3e 是【<init>】 </p><p>0000040 00 1c <em><strong>01 00 06 3c 69 6e 69 74 3e</strong></em> 01 00 03 28 29</p><p>第#8项 01 表示一个 utf8 串，00 03 表示长度，28 29 56 是【()V】其实就是表示无参、无返回值 </p><p>0000040 00 1c 01 00 06 3c 69 6e 69 74 3e <em><strong>01 00 03 28 29</strong></em> </p><p>0000060 <em><strong>56</strong></em> 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e</p><p>第#9项 01 表示一个 utf8 串，00 04 表示长度，43 6f 64 65 是【Code】 </p><p>0000060 56 <em><strong>01 00 04 43 6f 64 65</strong></em> 01 00 0f 4c 69 6e 65 4e</p><p>第#10项 01 表示一个 utf8 串，00 0f（15） 表示长度，4c 69 6e 65 4e 75 6d 62 65 72 54 61 62 6c 65 是【LineNumberTable】 </p><p>0000060 56 01 00 04 43 6f 64 65 <em><strong>01 00 0f 4c 69 6e 65 4e</strong></em></p><p>0000100 <em><strong>75 6d 62 65 72 54 61 62 6c 65</strong></em> 01 00 12 4c 6f 63</p><p>第#11项 01 表示一个 utf8 串，00 12（18） 表示长度，4c 6f 63 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65是【LocalVariableTable】 </p><p>0000100 75 6d 62 65 72 54 61 62 6c 65 <em><strong>01 00 12 4c 6f 63</strong></em></p><p>0000120 <em><strong>61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65</strong></em> 01</p><p>第#12项 01 表示一个 utf8 串，00 04 表示长度，74 68 69 73 是【this】 </p><p>0000120 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65 <em><strong>01</strong></em> </p><p>0000140 <em><strong>00 04 74 68 69 73</strong></em> 01 00 1d 4c 63 6e 2f 69 74 63</p><p>第#13项 01 表示一个 utf8 串，00 1d（29） 表示长度，是【Lcn&#x2F;itcast&#x2F;t5&#x2F;HelloWorld;】 </p><p>0000140 00 04 74 68 69 73 <em><strong>01 00 1d 4c 63 6e 2f 69 74 63</strong></em> </p><p>0000160 <em><strong>61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c 6f</strong></em> </p><p>0000200 <em><strong>57 6f 72 6c 64 3b</strong></em> 01 00 04 6d 61 69 6e 01 00 16</p><p>第#14项 01 表示一个 utf8 串，00 04 表示长度，74 68 69 73 是【main】 </p><p>0000200 57 6f 72 6c 64 3b <em><strong>01 00 04 6d 61 69 6e</strong></em> 01 00 16</p><p>第#15项 01 表示一个 utf8 串，00 16（22） 表示长度，是【([Ljava&#x2F;lang&#x2F;String;)V】其实就是参数为 字符串数组，无返回值 </p><p>0000200 57 6f 72 6c 64 3b 01 00 04 6d 61 69 6e <em><strong>01 00 16</strong></em> </p><p>0000220 <em><strong>28 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72</strong></em> </p><p>0000240 <em><strong>69 6e 67 3b 29 56</strong></em> 01 00 04 61 72 67 73 01 00 13</p><p>第#16项 01 表示一个 utf8 串，00 04 表示长度，是【args】 </p><p>0000240 69 6e 67 3b 29 56 <em><strong>01 00 04 61 72 67 73</strong></em> 01 00 13</p><p>第#17项 01 表示一个 utf8 串，00 13（19） 表示长度，是【[Ljava&#x2F;lang&#x2F;String;】 </p><p>0000240 69 6e 67 3b 29 56 01 00 04 61 72 67 73 <em><strong>01 00 13</strong></em> </p><p>0000260 <em><strong>5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69</strong></em> </p><p>0000300 <em><strong>6e 67 3b</strong></em> 01 00 10 4d 65 74 68 6f 64 50 61 72 61</p><p>第#18项 01 表示一个 utf8 串，00 10（16） 表示长度，是【MethodParameters】 </p><p>0000300 6e 67 3b <em><strong>01 00 10 4d 65 74 68 6f 64 50 61 72 61</strong></em> </p><p>0000320 <em><strong>6d 65 74 65</strong></em> 72 73 01 00 0a 53 6f 75 72 63 65 46</p><p>第#19项 01 表示一个 utf8 串，00 0a（10） 表示长度，是【SourceFile】 </p><p>0000320 6d 65 74 65 72 73 <em><strong>01 00 0a 53 6f 75 72 63 65 46</strong></em> </p><p>0000340 <em><strong>69 6c 65</strong></em> 01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64</p><p>第#20项 01 表示一个 utf8 串，00 0f（15） 表示长度，是【HelloWorld.java】 </p><p>0000340 69 6c 65 <em><strong>01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64</strong></em> </p><p>0000360 <em><strong>2e 6a 61 76 61</strong></em> 0c 00 07 00 08 07 00 1d 0c 00 1e</p><p>第#21项 0c 表示一个 【名+类型】，00 07 00 08 引用了常量池中 #7 #8 两项 </p><p>0000360 2e 6a 61 76 61 <em><strong>0c 00 07 00 08</strong></em> 07 00 1d 0c 00 1e</p><p>第#22项 07 表示一个 Class 信息，00 1d（29） 引用了常量池中 #29 项 </p><p>0000360 2e 6a 61 76 61 0c 00 07 00 08 <em><strong>07 00 1d</strong></em> 0c 00 1e</p><p>第#23项 0c 表示一个 【名+类型】，00 1e（30） 00 1f （31）引用了常量池中 #30 #31 两项 </p><p>0000360 2e 6a 61 76 61 0c 00 07 00 08 07 00 1d <em><strong>0c 00 1e</strong></em> </p><p>0000400 <em><strong>00 1f</strong></em> 01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64</p><p>第#24项 01 表示一个 utf8 串，00 0f（15） 表示长度，是【hello world】 </p><p>0000400 00 1f <em><strong>01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64</strong></em></p><p>第#25项 07 表示一个 Class 信息，00 20（32） 引用了常量池中 #32 项 </p><p>0000420 <em><strong>07 00 20</strong></em> 0c 00 21 00 22 01 00 1b 63 6e 2f 69 74</p><p>第#26项 0c 表示一个 【名+类型】，00 21（33） 00 22（34）引用了常量池中 #33 #34 两项 </p><p>0000420 07 00 20 <em><strong>0c 00 21 00 22</strong></em> 01 00 1b 63 6e 2f 69 74</p><p>第#27项 01 表示一个 utf8 串，00 1b（27） 表示长度，是【cn&#x2F;itcast&#x2F;t5&#x2F;HelloWorld】 </p><p>0000420 07 00 20 0c 00 21 00 22 <em><strong>01 00 1b 63 6e 2f 69 74</strong></em> </p><p>0000440 <em><strong>63 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c</strong></em> </p><p>0000460 <em><strong>6f 57 6f 72 6c 64</strong></em> 01 00 10 6a 61 76 61 2f 6c 61</p><p>第#28项 01 表示一个 utf8 串，00 10（16） 表示长度，是【java&#x2F;lang&#x2F;Object】 </p><p>0000460 6f 57 6f 72 6c 64 <em><strong>01 00 10 6a 61 76 61 2f 6c 61</strong></em> </p><p>0000500 <em><strong>6e 67 2f 4f 62 6a 65 63 74</strong></em> 01 00 10 6a 61 76 61</p><p>第#29项 01 表示一个 utf8 串，00 10（16） 表示长度，是【java&#x2F;lang&#x2F;System】 </p><p>0000500 6e 67 2f 4f 62 6a 65 63 74 <em><strong>01 00 10 6a 61 76 61</strong></em> </p><p>0000520 <em><strong>2f 6c 61 6e 67 2f 53 79 73 74 65 6d</strong></em> 01 00 03 6f</p><p>第#30项 01 表示一个 utf8 串，00 03 表示长度，是【out】 </p><p>0000520 2f 6c 61 6e 67 2f 53 79 73 74 65 6d <em><strong>01 00 03 6f</strong></em> </p><p>0000540 <em><strong>75 74</strong></em> 01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72</p><p>第#31项 01 表示一个 utf8 串，00 15（21） 表示长度，是【Ljava&#x2F;io&#x2F;PrintStream;】 </p><p>0000540 75 74 <em><strong>01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72</strong></em> </p><p>0000560 <em><strong>69 6e 74 53 74 72 65 61 6d 3b</strong></em> 01 00 13 6a 61 76</p><p>第#32项 01 表示一个 utf8 串，00 13（19） 表示长度，是【java&#x2F;io&#x2F;PrintStream】 </p><p>0000560 69 6e 74 53 74 72 65 61 6d 3b <em><strong>01 00 13 6a 61 76</strong></em></p><p>0000600 <em><strong>61 2f 69 6f 2f 50 72 69 6e 74 53 74 72 65 61 6d</strong></em></p><p>第#33项 01 表示一个 utf8 串，00 07 表示长度，是【println】 </p><p>0000620 <em><strong>01 00 07 70 72 69 6e 74 6c 6e</strong></em> 01 00 15 28 4c 6a</p><p>第#34项 01 表示一个 utf8 串，00 15（21） 表示长度，是【(Ljava&#x2F;lang&#x2F;String;)V】 </p><p>0000620 01 00 07 70 72 69 6e 74 6c 6e <em><strong>01 00 15 28 4c 6a</strong></em> </p><p>0000640 <em><strong>61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b</strong></em> </p><p>0000660 <em><strong>29 56</strong></em> 00 21 00 05 00 06 00 00 00 00 00 02 00 01</p><h3 id="3-1-4、访问标识与继承信息"><a href="#3-1-4、访问标识与继承信息" class="headerlink" title="3.1.4、访问标识与继承信息"></a>3.1.4、访问标识与继承信息</h3><p>21 表示该 class 是一个类，公共的 </p><p>0000660 29 56 <em><strong>00 21</strong></em> 00 05 00 06 00 00 00 00 00 02 00 01 </p><p>05 表示根据常量池中 #5 找到本类全限定名 </p><p>0000660 29 56 00 21 <em><strong>00 05</strong></em> 00 06 00 00 00 00 00 02 00 01 </p><p>06 表示根据常量池中 #6 找到父类全限定名 </p><p>0000660 29 56 00 21 00 05 <em><strong>00 06</strong></em> 00 00 00 00 00 02 00 01 </p><p>表示接口的数量，本类为 0 </p><p>0000660 29 56 00 21 00 05 00 06 <em><strong>00 00</strong></em> 00 00 00 02 00 0</p><table><thead><tr><th>Flag Name</th><th>Value</th><th>Interpretation</th></tr></thead><tbody><tr><td>ACC_PUBLIC</td><td>0x0001</td><td>Declared public ; may be accessed from outside its  package.</td></tr><tr><td>ACC_FINAL</td><td>0x0010</td><td>Declared final ; no subclasses allowed.</td></tr><tr><td>ACC_SUPER</td><td>0x0020</td><td>Treat superclass methods specially when invoked by the invokespecial instruction.</td></tr><tr><td>ACC_INTERFACE</td><td>0x0200</td><td>Is an interface, not a class.</td></tr><tr><td>ACC_ABSTRACT</td><td>0x0400</td><td>Declared abstract ; must not be instantiated.</td></tr><tr><td>ACC_SYNTHETIC</td><td>0x1000</td><td>Declared synthetic; not present in the source code.</td></tr><tr><td>ACC_ANNOTATION</td><td>0x2000</td><td>Declared as an annotation type.</td></tr><tr><td>ACC_ENUM</td><td>0x4000</td><td>Declared as an enum type.</td></tr></tbody></table><h3 id="3-1-5、Field信息"><a href="#3-1-5、Field信息" class="headerlink" title="3.1.5、Field信息"></a>3.1.5、Field信息</h3><p>表示成员变量数量，本类为 0 </p><p>0000660 29 56 00 21 00 05 00 06 00 00 <em><strong>00 00</strong></em> 00 02 00 01</p><table><thead><tr><th>FieldType</th><th>Type</th><th>Interpretation</th></tr></thead><tbody><tr><td>B</td><td>byte</td><td>signed byte</td></tr><tr><td>C</td><td>char</td><td>Unicode character code point in the Basic Multilingual Plane, encoded with UTF-16</td></tr><tr><td>D</td><td>double</td><td>double-precision floating-point value</td></tr><tr><td>F</td><td>float</td><td>single-precision floating-point value</td></tr><tr><td>I</td><td>int</td><td>integer</td></tr><tr><td>J</td><td>long</td><td>long integer</td></tr><tr><td>L <br />ClassName <br />;</td><td>reference</td><td>an instance of class ClassName</td></tr><tr><td>S</td><td>short</td><td>signed short</td></tr><tr><td>Z</td><td>boolean</td><td>true or false</td></tr><tr><td>[</td><td>reference</td><td>one array dimension</td></tr></tbody></table><h3 id="3-1-6、Method信息"><a href="#3-1-6、Method信息" class="headerlink" title="3.1.6、Method信息"></a>3.1.6、Method信息</h3><p><img src="/JVM/image-20221031140109206.png" alt="image-20221031140109206"></p><p><img src="/JVM/image-20221031140141999.png" alt="image-20221031140141999"></p><p><img src="/JVM/image-20221031140206312.png" alt="image-20221031140206312"><img src="/JVM/image-20221031140257982.png" alt="image-20221031140257982"></p><p><img src="/JVM/image-20221031140316845.png" alt="image-20221031140316845"></p><h3 id="3-1-7、附加属性"><a href="#3-1-7、附加属性" class="headerlink" title="3.1.7、附加属性"></a>3.1.7、附加属性</h3><ul><li>00 01 表示附加属性数量</li><li>00 13 表示引用了常量池 #19 项，即【SourceFile】</li><li>00 00 00 02 表示此属性的长度</li><li>00 14 表示引用了常量池 #20 项，即【HelloWorld.java】</li></ul><p>0001100 00 12 00 00 00 05 01 00 10 00 00 00 01 00 13 00</p><p>0001120 00 00 02 00 14</p><p>参考：<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html</a></p><h2 id="3-2、字节码指令"><a href="#3-2、字节码指令" class="headerlink" title="3.2、字节码指令"></a>3.2、字节码指令</h2><h3 id="3-2-1、入门"><a href="#3-2-1、入门" class="headerlink" title="3.2.1、入门"></a>3.2.1、入门</h3><p>接着上一节，研究一下两组字节码指令，一个是</p><p><code>public cn.itcast.jvm.t5.HelloWorld();</code>  构造方法的字节码指令</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">2a</span> b7 <span class="hljs-number">00</span> <span class="hljs-number">01</span> b1<br></code></pre></td></tr></table></figure><ol><li>2a &#x3D;&gt; aload_0 加载 slot 0 的局部变量，即 this，做为下面的 invokespecial 构造方法调用的参数 </li><li>b7 &#x3D;&gt; invokespecial 预备调用构造方法，哪个方法呢？ </li><li>00 01 引用常量池中 #1 项，即【 Method java&#x2F;lang&#x2F;Object.””:()V 】</li><li>b1 表示返回</li></ol><p>另一个是 public static void main(java.lang.String[]); 主方法的字节码指令</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">b2</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">12</span> <span class="hljs-number">03</span> b6 <span class="hljs-number">00</span> <span class="hljs-number">04</span> b1<br></code></pre></td></tr></table></figure><ol><li>b2 &#x3D;&gt; getstatic 用来加载静态变量，哪个静态变量呢？ </li><li>00 02 引用常量池中 #2 项，即【Field java&#x2F;lang&#x2F;System.out:Ljava&#x2F;io&#x2F;PrintStream;】</li><li>12 &#x3D;&gt; ldc 加载参数，哪个参数呢？ </li><li>03 引用常量池中 #3 项，即 【String hello world】 </li><li>b6 &#x3D;&gt; invokevirtual 预备调用成员方法，哪个方法呢？ </li><li>00 04 引用常量池中 #4 项，即【Method java&#x2F;io&#x2F;PrintStream.println:(Ljava&#x2F;lang&#x2F;String;)V】 </li><li>b1 表示返回</li></ol><p>请参考：<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5</a></p><h3 id="3-2-2、javap工具"><a href="#3-2-2、javap工具" class="headerlink" title="3.2.2、javap工具"></a>3.2.2、javap工具</h3><p>自己分析类文件结构太麻烦了，Oracle 提供了 javap 工具来反编译 class 文件</p><p><img src="/JVM/image-20221102103445192.png" alt="image-20221102103445192"></p><p><img src="/JVM/image-20221102103427032.png" alt="image-20221102103427032"></p><p><img src="/JVM/image-20221102103518271.png" alt="image-20221102103518271"></p><h3 id="3-2-3、图解方法执行流程"><a href="#3-2-3、图解方法执行流程" class="headerlink" title="3.2.3、图解方法执行流程"></a>3.2.3、图解方法执行流程</h3><p>1）原始 java 代码</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.bytecode;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 演示 字节码指令 和 操作数栈、常量池的关系</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> Demo3_1 &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> main(String[] args) &#123;<br><span class="hljs-keyword">int</span> a = <span class="hljs-number">10</span>;<br><span class="hljs-keyword">int</span> b = <span class="hljs-keyword">Short</span>.MAX_VALUE + <span class="hljs-number">1</span>;<br><span class="hljs-keyword">int</span> c = a + b;<br>System.out.<span class="hljs-keyword">println</span>(c);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>2）编译后的字节码文件</p><p><img src="/JVM/image-20221102103601651.png" alt="image-20221102103601651"></p><p><img src="/JVM/image-20221102103614954.png" alt="image-20221102103614954"></p><p><img src="/JVM/image-20221102103632461.png" alt="image-20221102103632461"></p><p><img src="/JVM/image-20221102103643166.png" alt="image-20221102103643166"></p><p>3）常量池载入运行时常量池</p><p><img src="/JVM/image-20221102103656297.png" alt="image-20221102103656297"></p><p>4）方法字节码载入方法区</p><p><img src="/JVM/image-20221102103705315.png" alt="image-20221102103705315"></p><p>5）main 线程开始运行，分配栈帧内存</p><p>（stack&#x3D;2，locals&#x3D;4）</p><p><img src="/JVM/image-20221102103722807.png" alt="image-20221102103722807"></p><p>6）执行引擎开始执行字节码</p><p>bipush 10</p><ul><li>将一个 byte 压入操作数栈（其长度会补齐 4 个字节），类似的指令还有</li><li>sipush 将一个 short 压入操作数栈（其长度会补齐 4 个字节） </li><li>ldc 将一个 int 压入操作数栈 </li><li>ldc2_w 将一个 long 压入操作数栈（分两次压入，因为 long 是 8 个字节） </li><li>这里小的数字都是和字节码指令存在一起，超过 short 范围的数字存入了常量池</li></ul><p><img src="/JVM/image-20221102103815252.png" alt="image-20221102103815252"></p><p>istore_1</p><ul><li>将操作数栈顶数据弹出，存入局部变量表的 slot 1</li></ul><p><img src="/JVM/image-20221102103929219.png" alt="image-20221102103929219"></p><p><img src="/JVM/image-20221102103934229.png" alt="image-20221102103934229"></p><p>ldc #3</p><ul><li>从常量池加载 #3 数据到操作数栈 </li><li>注意 Short.MAX_VALUE 是 32767，所以 32768 &#x3D; Short.MAX_VALUE + 1 实际是在编译期间计算好的</li></ul><p><img src="/JVM/image-20221102104009697.png" alt="image-20221102104009697"></p><p>istore_2</p><p><img src="/JVM/image-20221102104021847.png" alt="image-20221102104021847"></p><p><img src="/JVM/image-20221102104029382.png" alt="image-20221102104029382"></p><p>iload_1</p><p><img src="/JVM/image-20221102104045057.png" alt="image-20221102104045057"></p><p>iload_2</p><p><img src="/JVM/image-20221102104057398.png" alt="image-20221102104057398"></p><p>iadd</p><p><img src="/JVM/image-20221102104108668.png" alt="image-20221102104108668"></p><p><img src="/JVM/image-20221102104115884.png" alt="image-20221102104115884"></p><p>istore_3</p><p><img src="/JVM/image-20221102104129152.png" alt="image-20221102104129152"></p><p><img src="/JVM/image-20221102104135622.png" alt="image-20221102104135622"></p><p>getstatic #4</p><p><img src="/JVM/image-20221102104145763.png" alt="image-20221102104145763"></p><p><img src="/JVM/image-20221102104153687.png" alt="image-20221102104153687"></p><p>iload_3</p><p><img src="/JVM/image-20221102104205754.png" alt="image-20221102104205754"></p><p><img src="/JVM/image-20221102104212672.png" alt="image-20221102104212672"></p><p>invokevirtual #5</p><ul><li>找到常量池 #5 项 </li><li>定位到方法区 java&#x2F;io&#x2F;PrintStream.println:(I)V 方法 </li><li>生成新的栈帧（分配 locals、stack等） </li><li>传递参数，执行新栈帧中的字节码</li></ul><p><img src="/JVM/image-20221102104241504.png" alt="image-20221102104241504"></p><ul><li>执行完毕，弹出栈帧 </li><li>清除 main 操作数栈内容</li></ul><p><img src="/JVM/image-20221102104325220.png" alt="image-20221102104325220"></p><p>return</p><ul><li>完成 main 方法调用，弹出 main 栈帧 </li><li>程序结束</li></ul><h3 id="3-2-4、练习-分析i"><a href="#3-2-4、练习-分析i" class="headerlink" title="3.2.4、练习 - 分析i++"></a>3.2.4、练习 - 分析i++</h3><p>目的：从字节码角度分析 a++ 相关题目</p><p>源码：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">package cn.itcast.jvm.t3.bytecode;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 从字节码角度分析 a++ 相关题目</span><br><span class="hljs-comment">*/</span><br><span class="hljs-built_in">public</span> <span class="hljs-keyword">class</span> Demo3_2 &#123;<br><span class="hljs-built_in">public</span> static <span class="hljs-type">void</span> main(String[] args) &#123;<br><span class="hljs-type">int</span> a = <span class="hljs-number">10</span>;<br><span class="hljs-type">int</span> b = a++ + ++a + a<span class="hljs-comment">--;</span><br><span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(a);<br><span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(b);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>字节码：</p><p><img src="/JVM/image-20221102104450398.png" alt="image-20221102104450398"></p><p><img src="/JVM/image-20221102104455844.png" alt="image-20221102104455844"></p><p>分析：</p><ul><li>注意 iinc 指令是直接在局部变量 slot 上进行运算 </li><li>a++ 和 ++a 的区别是先执行 iload 还是 先执行 iinc</li></ul><p><img src="/JVM/image-20221102104520641.png" alt="image-20221102104520641"></p><p><img src="/JVM/image-20221102104530903.png" alt="image-20221102104530903"></p><p><img src="/JVM/image-20221102104537395.png" alt="image-20221102104537395"></p><p><img src="/JVM/image-20221102104544336.png" alt="image-20221102104544336"></p><p><img src="/JVM/image-20221102104556881.png" alt="image-20221102104556881"></p><p><img src="/JVM/image-20221102104603865.png" alt="image-20221102104603865"></p><p><img src="/JVM/image-20221102104617984.png" alt="image-20221102104617984"></p><p><img src="/JVM/image-20221102104624772.png" alt="image-20221102104624772"></p><p><img src="/JVM/image-20221102104630356.png" alt="image-20221102104630356"></p><p><img src="/JVM/image-20221102104636559.png" alt="image-20221102104636559"></p><p><img src="/JVM/image-20221102104641852.png" alt="image-20221102104641852"></p><h3 id="3-2-5、条件判断指令"><a href="#3-2-5、条件判断指令" class="headerlink" title="3.2.5、条件判断指令"></a>3.2.5、条件判断指令</h3><table><thead><tr><th>指令</th><th>助记符</th><th>含义</th></tr></thead><tbody><tr><td>0x99</td><td>ifeq</td><td>判断是否 &#x3D;&#x3D; 0</td></tr><tr><td>0x9a</td><td>ifne</td><td>判断是否 !&#x3D; 0</td></tr><tr><td>0x9b</td><td>iflt</td><td>判断是否 &lt; 0</td></tr><tr><td>0x9c</td><td>ifge</td><td>判断是否 &gt;&#x3D; 0</td></tr><tr><td>0x9d</td><td>ifgt</td><td>判断是否 &gt; 0</td></tr><tr><td>0x9e</td><td>ifle</td><td>判断是否 &lt;&#x3D; 0</td></tr><tr><td>0x9f</td><td>if_icmpeq</td><td>两个int是否 &#x3D;&#x3D;</td></tr><tr><td>0xa0</td><td>if_icmpne</td><td>两个int是否 !&#x3D;</td></tr><tr><td>0xa1</td><td>if_icmplt</td><td>两个int是否 &lt;</td></tr><tr><td>0xa2</td><td>if_icmpge</td><td>两个int是否 &gt;&#x3D;</td></tr><tr><td>0xa3</td><td>if_icmpgt</td><td>两个int是否 &gt;</td></tr><tr><td>0xa4</td><td>if_icmple</td><td>两个int是否 &lt;&#x3D;</td></tr><tr><td>0xa5</td><td>if_acmpeq</td><td>两个引用是否 &#x3D;&#x3D;</td></tr><tr><td>0xa6</td><td>if_acmpne</td><td>两个引用是否 !&#x3D;</td></tr><tr><td>0xc6</td><td>ifnull</td><td>判断是否 &#x3D;&#x3D; null</td></tr><tr><td>0xc7</td><td>ifnonnull</td><td>判断是否 !&#x3D; null</td></tr></tbody></table><p>几点说明：</p><ul><li>byte，short，char 都会按 int 比较，因为操作数栈都是 4 字节 </li><li>goto 用来进行跳转到指定行号的字节码</li></ul><p>源码：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_3</span> &#123;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>&#123;<br><span class="hljs-type">int</span> a = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span>(a == <span class="hljs-number">0</span>) &#123;<br>a = <span class="hljs-number">10</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>a = <span class="hljs-number">20</span>;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>字节码：</p><p><img src="/JVM/image-20221102105020761.png" alt="image-20221102105020761"></p><p>思考：以上比较指令中没有 long，float，double 的比较，那么它们要比较怎么办？</p><p>参考：<a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html#jvms-6.5.lcmp">https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html#jvms-6.5.lcmp</a></p><h3 id="3-2-6、循环控制指令"><a href="#3-2-6、循环控制指令" class="headerlink" title="3.2.6、循环控制指令"></a>3.2.6、循环控制指令</h3><p>其实循环控制还是前面介绍的那些指令，例如 while 循环：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_4</span> &#123;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>&#123;<br><span class="hljs-type">int</span> a = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">while</span> (a &lt; <span class="hljs-number">10</span>) &#123;<br>a++;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>字节码是：</p><p><img src="/JVM/image-20221102105228962.png" alt="image-20221102105228962"></p><p>再比如 do while 循环：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_5</span> &#123;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>&#123;<br><span class="hljs-type">int</span> a = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">do</span> &#123;<br>a++;<br>&#125; <span class="hljs-keyword">while</span> (a &lt; <span class="hljs-number">10</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>字节码是：</p><p>0: iconst_0 </p><p>1: istore_1 </p><p>2: iinc 1, 1 </p><p>5: iload_1 </p><p>6: bipush 10 </p><p>8: if_icmplt 2 </p><p>11: return</p><p>最后再看看 for 循环：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_6</span> &#123;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>字节码是：</p><p><img src="/JVM/image-20221102105408966.png" alt="image-20221102105408966"></p><p>注意：比较 while 和 for 的字节码，你发现它们是一模一样的，殊途也能同归</p><h3 id="3-2-7、练习-判断结果"><a href="#3-2-7、练习-判断结果" class="headerlink" title="3.2.7、练习 - 判断结果"></a>3.2.7、练习 - 判断结果</h3><p>请从字节码角度分析，下列代码运行的结果：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_6_1</span> &#123;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>&#123;<br><span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> x = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">while</span> (i &lt; <span class="hljs-number">10</span>) &#123;<br>x = x++;<br>i++;<br>&#125;<br>System.out.<span class="hljs-built_in">println</span>(x); <span class="hljs-comment">// 结果是 0</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-8、构造方法"><a href="#3-2-8、构造方法" class="headerlink" title="3.2.8、构造方法"></a>3.2.8、构造方法</h3><p>1）<code>&lt;cinit&gt;()V</code></p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_8_1</span> &#123;<br><span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> i = <span class="hljs-number">10</span>;<br><span class="hljs-keyword">static</span> &#123;<br>i = <span class="hljs-number">20</span>;<br>&#125;<br><span class="hljs-keyword">static</span> &#123;<br>i = <span class="hljs-number">30</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>编译器会按从上至下的顺序，收集所有 static 静态代码块和静态成员赋值的代码，合并为一个特殊的方法 <code>&lt;cinit&gt;()V</code> ：</p><p><img src="/JVM/image-20221102105618094.png" alt="image-20221102105618094"></p><p>练习：自己调整一下 static 变量和静态代码块的位置，观察字节码的改动</p><p>2）<code>&lt;init&gt;()V</code></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_8_2</span> &#123;<br><span class="hljs-keyword">private</span> <span class="hljs-type">String</span> a = <span class="hljs-string">&quot;s1&quot;</span>;<br>&#123;<br>b = <span class="hljs-number">20</span>;<br>&#125;<br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> b = <span class="hljs-number">10</span>;<br>&#123;<br>a = <span class="hljs-string">&quot;s2&quot;</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Demo3_8_2</span><span class="hljs-params">(<span class="hljs-type">String</span> a, <span class="hljs-type">int</span> b)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.a = a;<br><span class="hljs-keyword">this</span>.b = b;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>&#123;<br>Demo3_8_2 d = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Demo3_8_2</span>(<span class="hljs-string">&quot;s3&quot;</span>, <span class="hljs-number">30</span>);<br>System.out.<span class="hljs-built_in">println</span>(d.a);<br>System.out.<span class="hljs-built_in">println</span>(d.b);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>编译器会按从上至下的顺序，收集所有 {} 代码块和成员变量赋值的代码，形成新的构造方法，但原始构 造方法内的代码总是在最后</p><p><img src="/JVM/image-20221102105803812.png" alt="image-20221102105803812"></p><h3 id="3-2-9、方法调用"><a href="#3-2-9、方法调用" class="headerlink" title="3.2.9、方法调用"></a>3.2.9、方法调用</h3><p>看一下几种不同的方法调用对应的字节码指令</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Demo3_9</span> &#123;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Demo3_9</span>()</span> &#123; &#125;<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span>()</span> &#123; &#125;<br><span class="hljs-function"><span class="hljs-keyword">private</span> final <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span>()</span> &#123; &#125;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span>()</span> &#123; &#125;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test4</span>()</span> &#123; &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> &#123;<br>Demo3_9 d = <span class="hljs-keyword">new</span> Demo3_9();<br>d.test1();<br>d.test2();<br>d.test3();<br>d.test4();<br>Demo3_9.test4();<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>字节码：</p><p><img src="/JVM/image-20221102105843791.png" alt="image-20221102105843791"></p><ul><li>new 是创建【对象】，给对象分配堆内存，执行成功会将【对象引用】压入操作数栈 </li><li>dup 是赋值操作数栈栈顶的内容，本例即为【对象引用】，为什么需要两份引用呢，一个是要配合 invokespecial 调用该对象的构造方法 “”:()V （会消耗掉栈顶一个引用），另一个要 配合 astore_1 赋值给局部变量 </li><li>最终方法（final），私有方法（private），构造方法都是由 invokespecial 指令来调用，属于静态绑定 </li><li>普通成员方法是由 invokevirtual 调用，属于动态绑定，即支持多态 </li><li>成员方法与静态方法调用的另一个区别是，执行方法前是否需要【对象引用】 </li><li>比较有意思的是 d.test4(); 是通过【对象引用】调用一个静态方法，可以看到在调用 invokestatic 之前执行了 pop 指令，把【对象引用】从操作数栈弹掉了😂 </li><li>还有一个执行 invokespecial 的情况是通过 super 调用父类方法</li></ul><h3 id="3-2-10、多态的原理"><a href="#3-2-10、多态的原理" class="headerlink" title="3.2.10、多态的原理"></a>3.2.10、多态的原理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.bytecode;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 演示多态原理，注意加上下面的 JVM 参数，禁用指针压缩</span><br><span class="hljs-comment">* -XX:-UseCompressedOops -XX:-UseCompressedClassPointers</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_10</span> &#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(Animal animal)</span> &#123;<br>animal.eat();<br>System.out.println(animal.toString());<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>test(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>());<br>test(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>());<br>System.in.read();<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> &#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">eat</span><span class="hljs-params">()</span>;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;我是&quot;</span> + <span class="hljs-built_in">this</span>.getClass().getSimpleName();<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Animal</span> &#123;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">eat</span><span class="hljs-params">()</span> &#123;<br>System.out.println(<span class="hljs-string">&quot;啃骨头&quot;</span>);<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Animal</span> &#123;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">eat</span><span class="hljs-params">()</span> &#123;<br>System.out.println(<span class="hljs-string">&quot;吃鱼&quot;</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>1）运行代码</p><p>停在 System.in.read() 方法上，这时运行 jps 获取进程 id</p><p>2）运行 HSDB 工具</p><p>进入 JDK 安装目录，执行<code>java -cp ./lib/sa-jdi.jar sun.jvm.hotspot.HSDB</code></p><p>3）查找某个对象</p><p>打开 Tools -&gt; Find Object By Query </p><p>输入 <code>select d from cn.itcast.jvm.t3.bytecode.Dog d</code> 点击 Execute 执行</p><p><img src="/JVM/image-20221102110127313.png" alt="image-20221102110127313"></p><p>4）查看对象内存结构</p><p>点击超链接可以看到对象的内存结构，此对象没有任何属性，因此只有对象头的 16 字节，前 8 字节是 MarkWord，后 8 字节就是对象的 Class 指针</p><p>但目前看不到它的实际地址</p><p><img src="/JVM/image-20221102110145382.png" alt="image-20221102110145382"></p><p>5）查看对象 Class 的内存地址</p><p>可以通过 Windows -&gt; Console 进入命令行模式，执行<code>mem 0x00000001299b4978 2</code></p><p>mem 有两个参数，参数 1 是对象地址，参数 2 是查看 2 行（即 16 字节）</p><p>结果中第二行 0x000000001b7d4028 即为 Class 的内存地址</p><p><img src="/JVM/image-20221102110235601.png" alt="image-20221102110235601"></p><p>6）查看类的 vtable</p><ul><li>方法1：Alt+R 进入 Inspector 工具，输入刚才的 Class 内存地址，看到如下界面</li></ul><p><img src="/JVM/image-20221102110306376.png" alt="image-20221102110306376"></p><ul><li>方法2：或者 Tools -&gt; Class Browser 输入 Dog 查找，可以得到相同的结果</li></ul><p><img src="/JVM/image-20221102110319143.png" alt="image-20221102110319143"></p><p>无论通过哪种方法，都可以找到 Dog Class 的 vtable 长度为 6，意思就是 Dog 类有 6 个虚方法（多态相关的，final，static 不会列入）</p><p>那么这 6 个方法都是谁呢？从 Class 的起始地址开始算，偏移 0x1b8 就是 vtable 的起始地址，进行计算得到：</p><p><img src="/JVM/image-20221102110340837.png" alt="image-20221102110340837"></p><p>通过 Windows -&gt; Console 进入命令行模式，执行</p><p><img src="/JVM/image-20221102110353791.png" alt="image-20221102110353791"></p><p>就得到了 6 个虚方法的入口地址</p><p>7）验证方法地址</p><p>通过 Tools -&gt; Class Browser 查看每个类的方法定义，比较可知</p><p><img src="/JVM/image-20221102110413384.png" alt="image-20221102110413384"></p><p>对号入座，发现</p><ul><li>eat() 方法是 Dog 类自己的 </li><li>toString() 方法是继承 String 类的 </li><li>finalize() ，equals()，hashCode()，clone() 都是继承 Object 类的</li></ul><p>8）小结</p><p>当执行 invokevirtual 指令时， </p><ol><li>先通过栈帧中的对象引用找到对象 </li><li>分析对象头，找到对象的实际 Class </li><li>Class 结构中有 vtable，它在类加载的链接阶段就已经根据方法的重写规则生成好了 </li><li>查表得到方法的具体地址 </li><li>执行方法的字节码</li></ol><h3 id="3-2-11、异常处理"><a href="#3-2-11、异常处理" class="headerlink" title="3.2.11、异常处理"></a>3.2.11、异常处理</h3><h3 id="3-2-12、练习-finally"><a href="#3-2-12、练习-finally" class="headerlink" title="3.2.12、练习 - finally"></a>3.2.12、练习 - finally</h3><h3 id="3-2-13、synchronized"><a href="#3-2-13、synchronized" class="headerlink" title="3.2.13、synchronized"></a>3.2.13、synchronized</h3><h2 id="3-3、编译器处理"><a href="#3-3、编译器处理" class="headerlink" title="3.3、编译器处理"></a>3.3、编译器处理</h2><h3 id="3-3-1、默认构造器"><a href="#3-3-1、默认构造器" class="headerlink" title="3.3.1、默认构造器"></a>3.3.1、默认构造器</h3><h3 id="3-3-2、自动拆装箱"><a href="#3-3-2、自动拆装箱" class="headerlink" title="3.3.2、自动拆装箱"></a>3.3.2、自动拆装箱</h3><h3 id="3-3-3、泛型集合取值"><a href="#3-3-3、泛型集合取值" class="headerlink" title="3.3.3、泛型集合取值"></a>3.3.3、泛型集合取值</h3><h3 id="3-3-4、可变参数"><a href="#3-3-4、可变参数" class="headerlink" title="3.3.4、可变参数"></a>3.3.4、可变参数</h3><h3 id="3-3-5、foreach循环"><a href="#3-3-5、foreach循环" class="headerlink" title="3.3.5、foreach循环"></a>3.3.5、foreach循环</h3><h3 id="3-3-6、switch字符串"><a href="#3-3-6、switch字符串" class="headerlink" title="3.3.6、switch字符串"></a>3.3.6、switch字符串</h3><h3 id="3-3-7、switch枚举"><a href="#3-3-7、switch枚举" class="headerlink" title="3.3.7、switch枚举"></a>3.3.7、switch枚举</h3><h3 id="3-3-8、枚举类"><a href="#3-3-8、枚举类" class="headerlink" title="3.3.8、枚举类"></a>3.3.8、枚举类</h3><h3 id="3-3-9、try-with-resources"><a href="#3-3-9、try-with-resources" class="headerlink" title="3.3.9、try-with-resources"></a>3.3.9、try-with-resources</h3><h3 id="3-3-10、方法重写时的桥接方法"><a href="#3-3-10、方法重写时的桥接方法" class="headerlink" title="3.3.10、方法重写时的桥接方法"></a>3.3.10、方法重写时的桥接方法</h3><h3 id="3-3-11、匿名内部类"><a href="#3-3-11、匿名内部类" class="headerlink" title="3.3.11、匿名内部类"></a>3.3.11、匿名内部类</h3><h2 id="3-4、类加载阶段"><a href="#3-4、类加载阶段" class="headerlink" title="3.4、类加载阶段"></a>3.4、类加载阶段</h2><h3 id="3-4-1、加载"><a href="#3-4-1、加载" class="headerlink" title="3.4.1、加载"></a>3.4.1、加载</h3><h3 id="3-4-2、链接"><a href="#3-4-2、链接" class="headerlink" title="3.4.2、链接"></a>3.4.2、链接</h3><h3 id="3-4-3、初始化"><a href="#3-4-3、初始化" class="headerlink" title="3.4.3、初始化"></a>3.4.3、初始化</h3><h3 id="3-4-4、练习"><a href="#3-4-4、练习" class="headerlink" title="3.4.4、练习"></a>3.4.4、练习</h3><h2 id="3-5、类加载器"><a href="#3-5、类加载器" class="headerlink" title="3.5、类加载器"></a>3.5、类加载器</h2><h3 id="3-5-1、启动类加载器"><a href="#3-5-1、启动类加载器" class="headerlink" title="3.5.1、启动类加载器"></a>3.5.1、启动类加载器</h3><h3 id="3-5-2、扩展类加载器"><a href="#3-5-2、扩展类加载器" class="headerlink" title="3.5.2、扩展类加载器"></a>3.5.2、扩展类加载器</h3><h3 id="3-5-3、双亲委派模式"><a href="#3-5-3、双亲委派模式" class="headerlink" title="3.5.3、双亲委派模式"></a>3.5.3、双亲委派模式</h3><h3 id="3-5-4、线程上下文类加载器"><a href="#3-5-4、线程上下文类加载器" class="headerlink" title="3.5.4、线程上下文类加载器"></a>3.5.4、线程上下文类加载器</h3><h3 id="3-5-5、自定义类加载器"><a href="#3-5-5、自定义类加载器" class="headerlink" title="3.5.5、自定义类加载器"></a>3.5.5、自定义类加载器</h3><h2 id="3-6、运行期优化"><a href="#3-6、运行期优化" class="headerlink" title="3.6、运行期优化"></a>3.6、运行期优化</h2><h3 id="3-6-1、即时编译"><a href="#3-6-1、即时编译" class="headerlink" title="3.6.1、即时编译"></a>3.6.1、即时编译</h3><h3 id="3-6-2、反射优化"><a href="#3-6-2、反射优化" class="headerlink" title="3.6.2、反射优化"></a>3.6.2、反射优化</h3><h1 id="4、内存模型"><a href="#4、内存模型" class="headerlink" title="4、内存模型"></a>4、内存模型</h1><h2 id="4-1、java内存模型"><a href="#4-1、java内存模型" class="headerlink" title="4.1、java内存模型"></a>4.1、java内存模型</h2><p>4.1.1、原子性</p><p>4.1.2、问题分析</p><p>4.1.3、解决方法</p><h2 id="4-2、可见性"><a href="#4-2、可见性" class="headerlink" title="4.2、可见性"></a>4.2、可见性</h2><p>4.2.1、退不出的循环</p><p>4.2.2、解决方法</p><p>4.2.3、可见性</p><h2 id="4-3、有序性"><a href="#4-3、有序性" class="headerlink" title="4.3、有序性"></a>4.3、有序性</h2><p>4.3.1、诡异的结果</p><p>4.3.2、解决方法</p><p>4.3.3、有序性理解</p><p>4.3.4、happens-before</p><h2 id="4-4、CAS与原子类"><a href="#4-4、CAS与原子类" class="headerlink" title="4.4、CAS与原子类"></a>4.4、CAS与原子类</h2><p>4.4.1、CAS</p><p>4.4.2、乐观锁与悲观锁</p><p>4.4.3、原子操作类</p><h2 id="4-5、synchronized优化"><a href="#4-5、synchronized优化" class="headerlink" title="4.5、synchronized优化"></a>4.5、synchronized优化</h2><p>4.5.1、轻量级锁</p><p>4.5.2、锁膨胀</p><p>4.5.3、重量锁</p><p>4.5.4、偏向锁</p><p>4.5.5、其它优化</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Java Virtual Machine</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git提交项目笔记</title>
    <link href="/2022/10/22/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git%E6%8F%90%E4%BA%A4%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/"/>
    <url>/2022/10/22/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git%E6%8F%90%E4%BA%A4%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<p>1、打开想要提交或者克隆的项目文件夹</p><p>2、进入该文件夹打开Git Bash Here</p><p>3、初始化用户，告诉git你是谁</p><ul><li><p>git config –global user.name “你的名字或昵称”</p></li><li><p>git config –global user.email “你的邮箱”</p></li></ul><p>4、在该文件夹中执行下面命令，完成初始化</p><ul><li><p>git init</p></li><li><p>git remote add origin &lt;项目地址&gt; &#x2F;&#x2F;注:项目地址形式为:<a href="https://gitee.com/xxx/xxx.git%E6%88%96%E8%80%85">https://gitee.com/xxx/xxx.git或者</a> <a href="mailto:&#x67;&#x69;&#116;&#64;&#103;&#105;&#116;&#101;&#x65;&#x2e;&#99;&#111;&#109;">&#x67;&#x69;&#116;&#64;&#103;&#105;&#116;&#101;&#x65;&#x2e;&#99;&#111;&#109;</a>:xxx&#x2F;xxx.git</p></li><li><p>如果提交到github上则为： https:&#x2F;&#x2F;&lt;Personal access tokens(自己github上的tokens)&gt;@github.com&#x2F;Kblayt&#x2F;Kblayt.github.io.git</p></li></ul><p>5、若想克隆，只需要执行命令</p><ul><li>git clone &lt;项目地址&gt; &#x2F;&#x2F;注:项目地址形式为:<a href="https://gitee.com/xxx/xxx.git%E6%88%96%E8%80%85">https://gitee.com/xxx/xxx.git或者</a> <a href="mailto:&#103;&#105;&#x74;&#x40;&#x67;&#x69;&#x74;&#101;&#101;&#46;&#99;&#111;&#109;">&#103;&#105;&#x74;&#x40;&#x67;&#x69;&#x74;&#101;&#101;&#46;&#99;&#111;&#109;</a>:xxx&#x2F;xxx.git</li></ul><p>6、进入已经初始化好的或者克隆项目的目录然后执行：</p><p>从服务器下更新项目，因为已经clone过，所以不需要再更新</p><ul><li>git pull origin master</li></ul><p>7、做一些修改后执行如下命令完成一次完整的提交</p><ul><li><p>git add .</p></li><li><p>git commit -m “安装教程测试”</p></li><li><p>git push origin master</p></li></ul><p>注意：提交命令有两个，git push origin master（正常提交）和git push origin master -f（强制提交，强制提交可能会把之前的commit注释信息，不会改变修改的代码，慎用），都是提交到master分支 其他常见git命令</p><ul><li><p>查看所有分支 ：git branch -a</p></li><li><p>切换到某一分支：git checkout 分支名称</p></li><li><p>合并分支：git merge 原分支 目标分支</p></li></ul><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>项目管理工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
      <tag>gitee</tag>
      
      <tag>github</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>大数据</title>
    <link href="/2022/10/21/python/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    <url>/2022/10/21/python/%E5%A4%A7%E6%95%B0%E6%8D%AE/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Python</tag>
      
      <tag>大数据</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>强化学习</title>
    <link href="/2022/10/21/python/%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/"/>
    <url>/2022/10/21/python/%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Python</tag>
      
      <tag>强化学习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>深度学习</title>
    <link href="/2022/10/21/python/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    <url>/2022/10/21/python/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="深度学习的介绍"><a href="#深度学习的介绍" class="headerlink" title="深度学习的介绍"></a>深度学习的介绍</h1><p><strong>目标</strong></p><ol><li>知道什么是深度学习</li><li>知道深度学习和机器学习的区别</li><li>能够说出深度学习的主要应用场景</li><li>知道深度学习的常见框架</li></ol><h2 id="1-深度学习的概念"><a href="#1-深度学习的概念" class="headerlink" title="1.深度学习的概念"></a>1.深度学习的概念</h2><p>深度学习（deep learning）是机器学习的分支，是一种以人工神经网络为架构，对数据进行特征学习的算法。</p><h2 id="2-机器学习和深度学习的区别"><a href="#2-机器学习和深度学习的区别" class="headerlink" title="2.机器学习和深度学习的区别"></a>2.机器学习和深度学习的区别</h2><h3 id="2-1-区别1：特征提取"><a href="#2-1-区别1：特征提取" class="headerlink" title="2.1 区别1：特征提取"></a>2.1 区别1：特征提取</h3><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/image-20230408144050339.png" alt="image-20230408144050339"></p><p>从特征提取的角度出发：</p><ol><li>机器学习需要由人工的特征提取的过程</li><li>深度学习没有复杂的人工特征提取过程，特征提取的过程可以通过深度神经网络自动完成</li></ol><h3 id="2-2-区别2：数据量"><a href="#2-2-区别2：数据量" class="headerlink" title="2.2 区别2：数据量"></a>2.2 区别2：数据量</h3><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/image-20230408144401982.png" alt="image-20230408144401982"></p><p>从数据量角度出发：</p><ol><li>深度学习需要大量的训练数据集，会有更高的效果</li><li>深度学习训练深度神经网路需要大量的算力，因为其中有更多的参数</li></ol><h2 id="3-深度学习的应用场景"><a href="#3-深度学习的应用场景" class="headerlink" title="3.深度学习的应用场景"></a>3.深度学习的应用场景</h2><ol><li>图像识别<ol><li>物体识别</li><li>场景识别</li><li>人脸检测跟踪</li><li>人脸身份认证</li></ol></li><li>自然语言处理技术<ol><li>机器翻译</li><li>文本识别</li><li>聊天对话</li></ol></li><li>语音技术<ol><li>语音识别</li></ol></li></ol><h2 id="4-常见的深度学习框架"><a href="#4-常见的深度学习框架" class="headerlink" title="4.常见的深度学习框架"></a>4.常见的深度学习框架</h2><p>目前企业中常见的深度学习框架有很多，TensorFlow，Caffe2，Keras，Theano，PyTorch，Chainer，DyNet，CNTK等等</p><p>其中TensorFlow喝Kears是google出品的，使用者很多，但是其语法灰色而且喝python的语法不尽相同，对于入门玩家而言上手难度较高</p><p>所有我们将学习facebook推出的PyTorch，PyTorch的使用和Python的语法相同，整个操作类似Numpy的操作，并且PyTorch使用的是动态计算，会让代码的调试变得更加简单</p><h1 id="神经网络的介绍"><a href="#神经网络的介绍" class="headerlink" title="神经网络的介绍"></a>神经网络的介绍</h1><p><strong>目标</strong></p><ol><li>知道神经网络的概念</li><li>知道什么是神经元</li><li>知道什么是单层神经网络</li><li>知道什么是感知机</li><li>知道什么是多层神经网络</li><li>知道激活函数是什么，有什么作用</li><li>理解神经网络的思想</li></ol><h2 id="1-人工神经网络的概念"><a href="#1-人工神经网络的概念" class="headerlink" title="1.人工神经网络的概念"></a>1.人工神经网络的概念</h2><p>人工神经网络（Artificial Neural Network），简称神经网络（Neural Network）或类神经网络，是一种模仿生物神经网络（动物的中枢神经系统，特别是大脑）的结构和功能的数学模型，用于对函数进行估计或近似</p><p>和其他机器学习方法一样，神经网络已经被用于解决各种各样的问题，例如机器视觉和语音识别。这戏问题都是很难被传统基于规则的编程所解决的。</p><h2 id="2-神经元的概念"><a href="#2-神经元的概念" class="headerlink" title="2.神经元的概念"></a>2.神经元的概念</h2><p>在生物神经网络中，每个神经元与其他神经元相连接，当它“兴奋”时，就会向相连的神经元发送化学物质，从而改变这些神经元内的电位；如果某神经元的电位i而超过了一个“阈值”，那么它就会被激活，即“兴奋”起来，向其他神经元发送化学物质。</p><p>1943年，McCulloch和Pitts将上述情形抽象为上图所示的简单模型，这就是一直沿用至今的M-P神经元模型。把许多这样的神经元按一定的层次结构连接起来，就得到了神经网络。</p><p>一个简单的神经元如下图所示：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/image-20230410131346791.png" alt="image-20230410131346791"></p><p>其中：</p><ol><li>α1，α2，… αn为各个输入的分量</li><li>ω1，ω2，… ωn为各个输入分量对应的权重参数</li><li>b为偏置</li><li>f为激活函数，常见的激活函数有tanh，sigmold，relu</li><li>t为神经元的输出</li></ol><p>使用数学公式表示就是：<br>$$<br>t &#x3D; f(W^TA+b)<br>$$<br>可见，一个神经元的功能是求得输入向量与权向量的内积后，经过一个非线性传递函数得到一个标量结果。</p><h2 id="3-单层神经网络"><a href="#3-单层神经网络" class="headerlink" title="3.单层神经网络"></a>3.单层神经网络</h2><p>是最基本的神经网络形式，由有限个神经元构成，所有数据有的输入向量都是同一个向量，由于每一个神经元都会产生一个标量结果，使用单层神经元的输出是一个向量，向量的维度等于神经元的数目。</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/image-20230410131357167.png" alt="image-20230410131357167"></p><h2 id="4-感知机"><a href="#4-感知机" class="headerlink" title="4.感知机"></a>4.感知机</h2><p>感知机由两层神经网络组成，输入层接收外界输入信号后传递给输出层（输出+1正例，-1反例），输出层都是M-P神经元</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/image-20230410131410871.png" alt="image-20230410131410871"></p><p>其中ω0，ω1，ω2 … ωn都表示权重</p><p><strong>感知机的作用：</strong></p><p>把一个n维向量空间用一个超平面分割成两部分，给定一个输入向量，超平面可以判断出这个向量位于超平面的哪一边，得到输入时正类或者是反类，<strong>对应到2为空间就是一条直线把一个平面分为两个部分。</strong></p><h2 id="5-多层神经网络"><a href="#5-多层神经网络" class="headerlink" title="5.多层神经网络"></a>5.多层神经网络</h2><p>多层神经网络就是由单层神经网络进行叠加之后得到的，所以就形成了层的概念，常见的多层神经网络有如下结构：</p><ul><li>输入层（Input layer），众多神经元（Neuron）接受大量非线性输入消息，输入的消息称为输入向量。</li><li>输出层（Output layer），消息在神经元连接中传输，分析，权衡，形成输出结果。输出的消息称为输出向量。</li><li>隐藏层（Hidden layer），简称“隐层”，是出入层和输出层之间众多神经元和里按揭组成的各个层面。隐层可以有一层或多层。隐层的节点（神经元）数目不定，但数目越多神经网络的非线性越显著，从而神经网络的强健性（robustness）更显著。</li></ul><p>示意图如下：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/image-20230410131422931.png" alt="image-20230410131422931"></p><p><strong>概念：全连接层</strong></p><p>全连接层：当前一层和前一层每个神经元相互里按揭，我们称当前这一层为全连接层。</p><p>思考：假设第N-1层有m个神经元，第N层有n个神经元，当第N层是全连接层的时候，则N-1和N层之间有多少个参数w，这些参数可以如何表示？</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/image-20230410131902590.png" alt="image-20230410131902590"></p><p>从上图可以看出，所谓的全连接层就是在前一层的输出的基础上进行一次<br>$$<br>Y&#x3D;Wx+b<br>$$<br>的变化(不考虑激活函数的情况下就是一次线性变化，所谓线性变化就是平移(+b)和缩放的组合(*w))</p><h2 id="6-激活函数"><a href="#6-激活函数" class="headerlink" title="6. 激活函数"></a>6. 激活函数</h2><p>在前面的神经元的介绍过程中我们提到了激活函数，那么他到底是干什么的呢？</p><p>假设我们有这样一组数据，三角形和四边形，需要把他们分为两类</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%BF%80%E6%B4%BB%E5%87%BD%E6%95%B01.png"></p><p>通过不带激活函数的感知机模型我们可以划出一条线, 把平面分割开</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%BF%80%E6%B4%BB%E5%87%BD%E6%95%B02.png"></p><p>假设我们确定了参数w和b之后，那么带入需要预测的数据，如果y&gt;0,我们认为这个点在直线的右边，也就是正类（三角形），否则是在左边（四边形）</p><p>但是可以看出，三角形和四边形是没有办法通过直线分开的，那么这个时候该怎么办？</p><p>可以考虑使用多层神经网络来进行尝试，比如<strong>在前面的感知机模型中再增加一层</strong></p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%BF%80%E6%B4%BB%E5%87%BD%E6%95%B03.png"></p><p>对上图中的等式进行合并，我们可以得到：<br>$$<br>y &#x3D; (w_{1-11}w_{2-1}+\cdots)x_1+(w_{1-21}w_{2-1}+\cdots)x_2 + (w_{2-1}+\cdots)b_{1-1}<br>$$<br>上式括号中的都为w参数，和公式$y &#x3D; w_1x_1 + w_2x_2 +b$完全相同，依然只能够绘制出直线</p><p>所以可以发现，即使是多层神经网络，相比于前面的感知机，没有任何的改进。</p><p>但是如果此时，我们在前面感知机的基础上加上<strong>非线性的激活函数</strong>之后，输出的结果就不在是一条直线</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%BF%80%E6%B4%BB%E5%87%BD%E6%95%B04.png"></p><p>如上图，右边是sigmoid函数，对感知机的结果，通过sigmoid函数进行处理</p><p>如果给定合适的参数w和b，就可以得到合适的曲线，能够完成对最开始问题的非线性分割</p><p>所以激活函数很重要的一个<strong>作用</strong>就是<strong>增加模型的非线性分割能力</strong></p><p>常见的激活函数有：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%BF%80%E6%B4%BB%E5%87%BD%E6%95%B05.jpg"></p><p>看图可知：</p><ul><li>sigmoid 只会输出正数，以及靠近0的输出变化率最大</li><li>tanh和sigmoid不同的是，tanh输出可以是负数</li><li>Relu是输入只能大于0,如果你输入含有负数，Relu就不适合，如果你的输入是图片格式，Relu就挺常用的，因为图片的像素值作为输入时取值为[0,255]。</li></ul><p>激活函数的作用除了前面说的<strong>增加模型的非线性分割能力</strong>外，还有</p><ul><li><strong>提高模型鲁棒性</strong></li><li><strong>缓解梯度消失问题</strong></li><li><strong>加速模型收敛等</strong></li></ul><p>这些好处，大家后续会慢慢体会到，这里先知道就行</p><h2 id="7-神经网络示例"><a href="#7-神经网络示例" class="headerlink" title="7. 神经网络示例"></a>7. 神经网络示例</h2><p>一个男孩想要找一个女朋友，于是实现了一个<strong>女友判定机</strong>，随着年龄的增长，他的判定机也一直在变化</p><p>14岁的时候：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BE%8B%E5%AD%901.png"></p><p>无数次碰壁之后，男孩意识到追到女孩的可能性和颜值一样重要，于是修改了判定机：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BE%8B%E5%AD%902.png"></p><p>在15岁的时候终于找到呢女朋友，但是一顿时间后他发现有各种难以忍受的习惯，最终决定分手。一段空窗期中，他发现找女朋友很复杂，需要更多的条件才能够帮助他找到女朋友，于是在25岁的时候，他再次修改了判定机：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BE%8B%E5%AD%903.png"></p><p>在更新了女友判定机之后，问题又来了，很多指标不能够很好的量化，如何颜值，什么样的叫做颜值高，什么样的叫做性格好等等，为了解决这个问题，他又更新了判定机，最终得到<strong>超级女友判定机</strong></p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BE%8B%E5%AD%904.png"></p><p>上述的超级女友判定机其实就是神经网络，它能够接受基础的输入，通过隐藏层的线性的和非线性的变化最终的到输出</p><p>通过上面例子，希望大家能够理解深度学习的<strong>思想</strong>：</p><p>输出的最原始、最基本的数据，通过模型来进行特征工程，进行更加高级特征的学习，然后通过传入的数据来确定合适的参数，让模型去更好的拟合数据。</p><p>这个过程可以理解为盲人摸象，多个人一起摸，把摸到的结果乘上合适的权重，进行合适的变化，让他和目标值趋近一致。整个过程只需要输入基础的数据，程序自动寻找合适的参数。</p><h1 id="Pytorch的安装"><a href="#Pytorch的安装" class="headerlink" title="Pytorch的安装"></a>Pytorch的安装</h1><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ol><li>知道如何安装pytorch</li></ol><h2 id="1-Pytorch的介绍"><a href="#1-Pytorch的介绍" class="headerlink" title="1. Pytorch的介绍"></a>1. Pytorch的介绍</h2><p>Pytorch是一款facebook发布的深度学习框架，由其易用性，友好性，深受广大用户青睐。</p><h2 id="2-Pytorch的版本"><a href="#2-Pytorch的版本" class="headerlink" title="2. Pytorch的版本"></a>2. Pytorch的版本</h2><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/torch%E7%89%88%E6%9C%AC.png"></p><h2 id="3-Pytorch的安装"><a href="#3-Pytorch的安装" class="headerlink" title="3. Pytorch的安装"></a>3. Pytorch的安装</h2><p>安装地址介绍：<a href="https://pytorch.org/get-started/locally/">https://pytorch.org/get-started/locally/</a></p><p>带GPU安装步骤：</p><p><code>conda install pytorch torchvision cudatoolkit=9.0 -c pytorch</code></p><p>不带GPU安装步骤</p><p><code>conda install pytorch-cpu torchvision-cpu -c pytorch</code></p><p>安装之后打开ipython</p><p>输入：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">1</span>]:<span class="hljs-keyword">import</span> torch<br>In [<span class="hljs-number">2</span>]: torch.__version__<br>Out[<span class="hljs-number">2</span>]: <span class="hljs-string">&#x27;1.0.1&#x27;</span><br></code></pre></td></tr></table></figure><p>注意：安装模块的时候安装的是<code>pytorch</code> ，但是在代码中都是使用<code>torch</code></p><h1 id="Pytorch的入门使用"><a href="#Pytorch的入门使用" class="headerlink" title="Pytorch的入门使用"></a>Pytorch的入门使用</h1><h2 id="目标-1"><a href="#目标-1" class="headerlink" title="目标"></a>目标</h2><ol><li>知道张量和Pytorch中的张量</li><li>知道pytorch中如何创建张量</li><li>知道pytorch中tensor的常见方法</li><li>知道pytorch中tensor的数据类型</li><li>知道pytorch中如何实现tensor在cpu和cuda中转化</li></ol><h2 id="1-张量Tensor"><a href="#1-张量Tensor" class="headerlink" title="1. 张量Tensor"></a>1. 张量Tensor</h2><p>张量是一个统称，其中包含很多类型：</p><ol><li>0阶张量：标量、常数，0-D Tensor</li><li>1阶张量：向量，1-D Tensor</li><li>2阶张量：矩阵，2-D Tensor</li><li>3阶张量</li><li>…</li><li>N阶张量</li></ol><h2 id="2-Pytorch中创建张量"><a href="#2-Pytorch中创建张量" class="headerlink" title="2. Pytorch中创建张量"></a>2. Pytorch中创建张量</h2><ol><li><p>使用python中的列表或者序列创建tensor</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">torch.tensor([[<span class="hljs-number">1.</span>, -<span class="hljs-number">1.</span>], [<span class="hljs-number">1.</span>, -<span class="hljs-number">1.</span>]])<br>tensor([[ <span class="hljs-number">1.0000</span>, -<span class="hljs-number">1.0000</span>],<br>        [ <span class="hljs-number">1.0000</span>, -<span class="hljs-number">1.0000</span>]])<br></code></pre></td></tr></table></figure></li><li><p>使用numpy中的数组创建tensor</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">torch.tensor(np.array([[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]]))<br>tensor([[ <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],<br>        [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>]])<br></code></pre></td></tr></table></figure></li><li><p>使用torch的api创建tensor</p><ol><li><p><code>torch.empty(3,4)</code>创建3行4列的空的tensor，会用无用数据进行填充</p></li><li><p><code>torch.ones([3,4])</code> 创建3行4列的<strong>全为1</strong>的tensor</p></li><li><p><code>torch.zeros([3,4])</code>创建3行4列的<strong>全为0</strong>的tensor</p></li><li><p><code>torch.rand([3,4])</code> 创建3行4列的<strong>随机值</strong>的tensor，随机值的区间是<code>[0, 1)</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>torch.rand(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br>tensor([[ <span class="hljs-number">0.8237</span>,  <span class="hljs-number">0.5781</span>,  <span class="hljs-number">0.6879</span>],<br>[ <span class="hljs-number">0.3816</span>,  <span class="hljs-number">0.7249</span>,  <span class="hljs-number">0.0998</span>]])<br></code></pre></td></tr></table></figure></li><li><p><code>torch.randint(low=0,high=10,size=[3,4])</code> 创建3行4列的<strong>随机整数</strong>的tensor，随机值的区间是<code>[low, high)</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>torch.randint(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>, (<span class="hljs-number">2</span>, <span class="hljs-number">2</span>))<br>tensor([[<span class="hljs-number">4</span>, <span class="hljs-number">5</span>],<br>[<span class="hljs-number">6</span>, <span class="hljs-number">7</span>]])<br></code></pre></td></tr></table></figure></li><li><p><code>torch.randn([3,4])</code> 创建3行4列的<strong>随机数</strong>的tensor，随机值的分布式均值为0，方差为1</p></li></ol></li></ol><h2 id="3-Pytorch中tensor的常用方法"><a href="#3-Pytorch中tensor的常用方法" class="headerlink" title="3. Pytorch中tensor的常用方法"></a>3. Pytorch中tensor的常用方法</h2><ol><li><p>获取tensor中的数据(当tensor中只有一个元素可用)：<code>tensor.item()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">10</span>]: a = torch.tensor(np.arange(<span class="hljs-number">1</span>))<br><br>In [<span class="hljs-number">11</span>]: a<br>Out[<span class="hljs-number">11</span>]: tensor([<span class="hljs-number">0</span>])<br><br>In [<span class="hljs-number">12</span>]: a.item()<br>Out[<span class="hljs-number">12</span>]: <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure></li><li><p>转化为numpy数组</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">55</span>]: z.numpy()<br>Out[<span class="hljs-number">55</span>]:<br>array([[-<span class="hljs-number">2.5871205</span>],<br>       [ <span class="hljs-number">7.3690367</span>],<br>       [-<span class="hljs-number">2.4918075</span>]], dtype=float32)<br></code></pre></td></tr></table></figure></li><li><p>获取形状：<code>tensor.size()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">72</span>]: x<br>Out[<span class="hljs-number">72</span>]:<br>tensor([[    <span class="hljs-number">1</span>,     <span class="hljs-number">2</span>],<br>        [    <span class="hljs-number">3</span>,     <span class="hljs-number">4</span>],<br>        [    <span class="hljs-number">5</span>,    <span class="hljs-number">10</span>]], dtype=torch.int32)<br><br>In [<span class="hljs-number">73</span>]: x.size()<br>Out[<span class="hljs-number">73</span>]: torch.Size([<span class="hljs-number">3</span>, <span class="hljs-number">2</span>])<br></code></pre></td></tr></table></figure></li><li><p>形状改变：<code>tensor.view((3,4))</code>。类似numpy中的reshape，是一种浅拷贝，仅仅是形状发生改变</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">76</span>]: x.view(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)<br>Out[<span class="hljs-number">76</span>]:<br>tensor([[    <span class="hljs-number">1</span>,     <span class="hljs-number">2</span>,     <span class="hljs-number">3</span>],<br>        [    <span class="hljs-number">4</span>,     <span class="hljs-number">5</span>,    <span class="hljs-number">10</span>]], dtype=torch.int32)<br></code></pre></td></tr></table></figure></li><li><p>获取阶数：<code>tensor.dim()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">77</span>]: x.dim()<br>Out[<span class="hljs-number">77</span>]: <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure></li><li><p>获取最大值：<code>tensor.max()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">78</span>]: x.<span class="hljs-built_in">max</span>()<br>Out[<span class="hljs-number">78</span>]: tensor(<span class="hljs-number">10</span>, dtype=torch.int32)<br></code></pre></td></tr></table></figure></li><li><p>转置：<code>tensor.t()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">79</span>]: x.t()<br>Out[<span class="hljs-number">79</span>]:<br>tensor([[    <span class="hljs-number">1</span>,     <span class="hljs-number">3</span>,     <span class="hljs-number">5</span>],<br>        [    <span class="hljs-number">2</span>,     <span class="hljs-number">4</span>,   <span class="hljs-number">10</span>]], dtype=torch.int32)<br></code></pre></td></tr></table></figure></li><li><p><code>tensor[1,3]</code>  获取tensor中第一行第三列的值</p></li><li><p><code>tensor[1,3]=100</code> 对tensor中第一行第三列的位置进行赋值100</p></li><li><p>tensor的切片</p></li></ol>   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">101</span>]: x<br>Out[<span class="hljs-number">101</span>]:<br>tensor([[<span class="hljs-number">1.6437</span>, <span class="hljs-number">1.9439</span>, <span class="hljs-number">1.5393</span>],<br>        [<span class="hljs-number">1.3491</span>, <span class="hljs-number">1.9575</span>, <span class="hljs-number">1.0552</span>],<br>        [<span class="hljs-number">1.5106</span>, <span class="hljs-number">1.0123</span>, <span class="hljs-number">1.0961</span>],<br>        [<span class="hljs-number">1.4382</span>, <span class="hljs-number">1.5939</span>, <span class="hljs-number">1.5012</span>],<br>        [<span class="hljs-number">1.5267</span>, <span class="hljs-number">1.4858</span>, <span class="hljs-number">1.4007</span>]])<br><br>In [<span class="hljs-number">102</span>]: x[:,<span class="hljs-number">1</span>]<br>Out[<span class="hljs-number">102</span>]: tensor([<span class="hljs-number">1.9439</span>, <span class="hljs-number">1.9575</span>, <span class="hljs-number">1.0123</span>, <span class="hljs-number">1.5939</span>, <span class="hljs-number">1.4858</span>])<br></code></pre></td></tr></table></figure><p>​    </p><h2 id="4-tensor的数据类型"><a href="#4-tensor的数据类型" class="headerlink" title="4. tensor的数据类型"></a>4. tensor的数据类型</h2><p>tensor中的数据类型非常多，常见类型如下：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/tensor%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.png"></p><p>上图中的Tensor types表示这种type的tensor是其实例</p><ol><li><p>获取tensor的数据类型:<code>tensor.dtype</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">80</span>]: x.dtype<br>Out[<span class="hljs-number">80</span>]: torch.int32<br></code></pre></td></tr></table></figure></li><li><p>创建数据的时候指定类型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">88</span>]: torch.ones([<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],dtype=torch.float32)<br>Out[<span class="hljs-number">88</span>]:<br>tensor([[<span class="hljs-number">9.1167e+18</span>, <span class="hljs-number">0.0000e+00</span>, <span class="hljs-number">7.8796e+15</span>],<br>        [<span class="hljs-number">8.3097e-43</span>, <span class="hljs-number">0.0000e+00</span>, -<span class="hljs-number">0.0000e+00</span>]])<br></code></pre></td></tr></table></figure></li><li><p>类型的修改</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">17</span>]: a<br>Out[<span class="hljs-number">17</span>]: tensor([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>], dtype=torch.int32)<br><br>In [<span class="hljs-number">18</span>]: a.<span class="hljs-built_in">type</span>(torch.<span class="hljs-built_in">float</span>)<br>Out[<span class="hljs-number">18</span>]: tensor([<span class="hljs-number">1.</span>, <span class="hljs-number">2.</span>])<br><br>In [<span class="hljs-number">19</span>]: a.double()<br>Out[<span class="hljs-number">19</span>]: tensor([<span class="hljs-number">1.</span>, <span class="hljs-number">2.</span>], dtype=torch.float64)<br></code></pre></td></tr></table></figure></li></ol><h2 id="5-tensor的其他操作"><a href="#5-tensor的其他操作" class="headerlink" title="5. tensor的其他操作"></a>5. tensor的其他操作</h2><ol><li><p>tensor和tensor相加</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">94</span>]: x = x.new_ones(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, dtype=torch.<span class="hljs-built_in">float</span>)<br><br>In [<span class="hljs-number">95</span>]: y = torch.rand(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)<br><br>In [<span class="hljs-number">96</span>]: x+y<br>Out[<span class="hljs-number">96</span>]:<br>tensor([[<span class="hljs-number">1.6437</span>, <span class="hljs-number">1.9439</span>, <span class="hljs-number">1.5393</span>],<br>        [<span class="hljs-number">1.3491</span>, <span class="hljs-number">1.9575</span>, <span class="hljs-number">1.0552</span>],<br>        [<span class="hljs-number">1.5106</span>, <span class="hljs-number">1.0123</span>, <span class="hljs-number">1.0961</span>],<br>        [<span class="hljs-number">1.4382</span>, <span class="hljs-number">1.5939</span>, <span class="hljs-number">1.5012</span>],<br>        [<span class="hljs-number">1.5267</span>, <span class="hljs-number">1.4858</span>, <span class="hljs-number">1.4007</span>]])<br>In [<span class="hljs-number">98</span>]: torch.add(x,y)<br>Out[<span class="hljs-number">98</span>]:<br>tensor([[<span class="hljs-number">1.6437</span>, <span class="hljs-number">1.9439</span>, <span class="hljs-number">1.5393</span>],<br>        [<span class="hljs-number">1.3491</span>, <span class="hljs-number">1.9575</span>, <span class="hljs-number">1.0552</span>],<br>        [<span class="hljs-number">1.5106</span>, <span class="hljs-number">1.0123</span>, <span class="hljs-number">1.0961</span>],<br>        [<span class="hljs-number">1.4382</span>, <span class="hljs-number">1.5939</span>, <span class="hljs-number">1.5012</span>],<br>        [<span class="hljs-number">1.5267</span>, <span class="hljs-number">1.4858</span>, <span class="hljs-number">1.4007</span>]])<br>In [<span class="hljs-number">99</span>]: x.add(y)<br>Out[<span class="hljs-number">99</span>]:<br>tensor([[<span class="hljs-number">1.6437</span>, <span class="hljs-number">1.9439</span>, <span class="hljs-number">1.5393</span>],<br>        [<span class="hljs-number">1.3491</span>, <span class="hljs-number">1.9575</span>, <span class="hljs-number">1.0552</span>],<br>        [<span class="hljs-number">1.5106</span>, <span class="hljs-number">1.0123</span>, <span class="hljs-number">1.0961</span>],<br>        [<span class="hljs-number">1.4382</span>, <span class="hljs-number">1.5939</span>, <span class="hljs-number">1.5012</span>],<br>        [<span class="hljs-number">1.5267</span>, <span class="hljs-number">1.4858</span>, <span class="hljs-number">1.4007</span>]])<br>In [<span class="hljs-number">100</span>]: x.add_(y)  <span class="hljs-comment">#带下划线的方法会对x进行就地修改</span><br>Out[<span class="hljs-number">100</span>]:<br>tensor([[<span class="hljs-number">1.6437</span>, <span class="hljs-number">1.9439</span>, <span class="hljs-number">1.5393</span>],<br>        [<span class="hljs-number">1.3491</span>, <span class="hljs-number">1.9575</span>, <span class="hljs-number">1.0552</span>],<br>        [<span class="hljs-number">1.5106</span>, <span class="hljs-number">1.0123</span>, <span class="hljs-number">1.0961</span>],<br>        [<span class="hljs-number">1.4382</span>, <span class="hljs-number">1.5939</span>, <span class="hljs-number">1.5012</span>],<br>        [<span class="hljs-number">1.5267</span>, <span class="hljs-number">1.4858</span>, <span class="hljs-number">1.4007</span>]])<br><br>In [<span class="hljs-number">101</span>]: x <span class="hljs-comment">#x发生改变</span><br>Out[<span class="hljs-number">101</span>]:<br>tensor([[<span class="hljs-number">1.6437</span>, <span class="hljs-number">1.9439</span>, <span class="hljs-number">1.5393</span>],<br>        [<span class="hljs-number">1.3491</span>, <span class="hljs-number">1.9575</span>, <span class="hljs-number">1.0552</span>],<br>        [<span class="hljs-number">1.5106</span>, <span class="hljs-number">1.0123</span>, <span class="hljs-number">1.0961</span>],<br>        [<span class="hljs-number">1.4382</span>, <span class="hljs-number">1.5939</span>, <span class="hljs-number">1.5012</span>],<br>        [<span class="hljs-number">1.5267</span>, <span class="hljs-number">1.4858</span>, <span class="hljs-number">1.4007</span>]])<br></code></pre></td></tr></table></figure><p>注意：带下划线的方法（比如:<code>add_</code>)会对tensor进行就地修改</p></li><li><p>tensor和数字操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">97</span>]: x +<span class="hljs-number">10</span><br>Out[<span class="hljs-number">97</span>]:<br>tensor([[<span class="hljs-number">11.</span>, <span class="hljs-number">11.</span>, <span class="hljs-number">11.</span>],<br>        [<span class="hljs-number">11.</span>, <span class="hljs-number">11.</span>, <span class="hljs-number">11.</span>],<br>        [<span class="hljs-number">11.</span>, <span class="hljs-number">11.</span>, <span class="hljs-number">11.</span>],<br>        [<span class="hljs-number">11.</span>, <span class="hljs-number">11.</span>, <span class="hljs-number">11.</span>],<br>        [<span class="hljs-number">11.</span>, <span class="hljs-number">11.</span>, <span class="hljs-number">11.</span>]])<br></code></pre></td></tr></table></figure></li><li><p>CUDA中的tensor</p><p>CUDA（Compute Unified Device Architecture），是NVIDIA推出的运算平台。 CUDA™是一种由NVIDIA推出的通用并行计算架构，该架构使GPU能够解决复杂的计算问题。</p><p><code>torch.cuda</code>这个模块增加了对CUDA tensor的支持，能够在cpu和gpu上使用相同的方法操作tensor</p><p>通过<code>.to</code>方法能够把一个tensor转移到另外一个设备(比如从CPU转到GPU)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#device = torch.device(&quot;cuda:0&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span><br><span class="hljs-keyword">if</span> torch.cuda.is_available():<br>    device = torch.device(<span class="hljs-string">&quot;cuda&quot;</span>)          <span class="hljs-comment"># cuda device对象</span><br>    y = torch.ones_like(x, device=device)  <span class="hljs-comment"># 创建一个在cuda上的tensor</span><br>    x = x.to(device)                       <span class="hljs-comment"># 使用方法把x转为cuda 的tensor</span><br>    z = x + y<br>    <span class="hljs-built_in">print</span>(z)<br>    <span class="hljs-built_in">print</span>(z.to(<span class="hljs-string">&quot;cpu&quot;</span>, torch.double))       <span class="hljs-comment"># .to方法也能够同时设置类型</span><br>    <br>&gt;&gt;tensor([<span class="hljs-number">1.9806</span>], device=<span class="hljs-string">&#x27;cuda:0&#x27;</span>)<br>&gt;&gt;tensor([<span class="hljs-number">1.9806</span>], dtype=torch.float64)<br></code></pre></td></tr></table></figure></li></ol><p>通过前面的学习，可以发现torch的各种操作几乎和numpy一样</p><h1 id="梯度下降和反向传播"><a href="#梯度下降和反向传播" class="headerlink" title="梯度下降和反向传播"></a>梯度下降和反向传播</h1><h2 id="目标-2"><a href="#目标-2" class="headerlink" title="目标"></a>目标</h2><ol><li>知道什么是梯度下降</li><li>知道什么是反向传播</li></ol><h2 id="1-梯度是什么"><a href="#1-梯度是什么" class="headerlink" title="1. 梯度是什么?"></a>1. 梯度是什么?</h2><p>梯度：是一个向量，导数+变化最快的方向(学习的前进方向)</p><p>回顾机器学习</p><p>收集数据$x$ ，构建机器学习模型$f$，得到$f(x,w) &#x3D; Y_{predict}$</p><p>判断模型好坏的方法：<br>$$<br>\begin{align*}<br>loss &amp; &#x3D; (Y_{predict}-Y_{true})^2  &amp;(回归损失) \<br>loss &amp; &#x3D; Y_{true} \cdot log(Y_{predict}) &amp;(分类损失)<br>\end{align*}<br>$$</p><p>目标：通过调整(学习)参数$w$，尽可能的降低$loss$，那么我们该如何调整$w$呢？</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%A2%AF%E5%BA%A61.png"></p><p>随机选择一个起始点$w_0$,通过调整$w_0$，让loss函数取到最小值</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%A2%AF%E5%BA%A62.png"></p><p><strong>$w$的更新方法</strong>：</p><ol><li>计算$w$的梯度（导数）</li></ol><p>$$<br>\begin{align*}<br>\nabla w &#x3D; \frac{f(w+0.000001)-f(w-0.000001)}{2*0.000001} </p><p>\end{align*}<br>$$</p><ol start="2"><li>更新$w$<br>$$<br>w &#x3D; w - \alpha \nabla w<br>$$</li></ol><p>其中：</p><ol><li>$\nabla w &lt;0 $ ,意味着w将增大</li><li>$\nabla w &gt;0 $ ,意味着w将减小</li></ol><p>总结：梯度就是多元函数参数的变化趋势（参数学习的方向），只有一个自变量时称为<strong>导数</strong></p><h2 id="2-偏导的计算"><a href="#2-偏导的计算" class="headerlink" title="2. 偏导的计算"></a>2. 偏导的计算</h2><h3 id="2-1-常见的导数计算"><a href="#2-1-常见的导数计算" class="headerlink" title="2.1 常见的导数计算"></a>2.1 常见的导数计算</h3><ul><li><p>多项式求导数：$f(x) &#x3D; x^5$ ,$f^{‘}(x) &#x3D; 5x^{(5-1)}$</p></li><li><p>基本运算求导：$f(x) &#x3D; xy$ ，$f^{‘}(x) &#x3D; y$</p></li><li><p>指数求导：$f(x) &#x3D; 5e^x$ ，$f^{‘}(x) &#x3D; 5e^x$</p></li><li><p>对数求导：$f(x) &#x3D; 5lnx$ ，$f^{‘}(x) &#x3D; \frac{5}{x}$，ln 表示log以e为底的对数</p></li><li><p>导数的微分形式：<br>$$<br>\begin{align*}<br>&amp; f^{‘}(x) &#x3D; &amp; \frac{d f(x)}{dx} \<br>&amp; 牛顿         &amp;莱布尼兹<br>\end{align*}<br>$$</p></li></ul><p>那么：如何求$f(x) &#x3D; (1+e^{-x})^{-1}$ 的导数呢？那就可以使用</p><p>$f(x) &#x3D; (1+e^{-x})^{-1}$         &#x3D;&#x3D;&gt;   $f(a) &#x3D; a^{-1},a(b) &#x3D; (1+b),b(c) &#x3D; e^c,c(x) &#x3D; -x$</p><p>则有：<br>$$<br>\begin{align*}<br>\frac{d f(x)}{dx} &amp; &#x3D; \frac{df}{da} \times \frac{da}{db} \times \frac{db}{dc}\times \frac{dc}{dx} \<br>&amp;&#x3D;-a^{-2} \times 1\times e^c \times (-1) \<br>&amp;&#x3D; -(1+e^{-x})^{-2} \times e^{-x} \times (-1) \<br>&amp;&#x3D; e^{-x}(1+e^{-x})^{-2}<br>\end{align*}<br>$$</p><h3 id="2-2-多元函数求偏导"><a href="#2-2-多元函数求偏导" class="headerlink" title="2.2 多元函数求偏导"></a>2.2 多元函数求偏导</h3><p>一元函数，即有一个自变量。类似$f(x)$</p><p>多元函数，即有多个自变量。类似$f(x,y,z),三个自变量x,y,z$</p><p>多元函数求偏导过程中：<strong>对某一个自变量求导，其他自变量当做常量即可</strong></p><p>例1：<br>$$<br>\begin{align*}<br> &amp;f(x,y,z) &amp;&#x3D; &amp;ax+by+cz \<br>&amp;\frac{df(x,y,z)}{dx} &amp;&#x3D; &amp;a \<br>&amp;\frac{df(x,y,z)}{dy} &amp;&#x3D; &amp;b \<br>&amp;\frac{df(x,y,z)}{dz} &amp;&#x3D; &amp;c<br>\end{align*}<br>$$</p><p>例2：<br>$$<br>\begin{align*}<br> &amp;f(x,y) &amp;&#x3D; &amp;xy \<br>&amp;\frac{df(x,y)}{dx} &amp;&#x3D; &amp; y\<br>&amp;\frac{df(x,y)}{dy} &amp;&#x3D; &amp;x<br>\end{align*}<br>$$<br>例3：<br>$$<br>\begin{align*}<br> &amp;f(x,w) &amp;&#x3D; &amp;(y-xw)^2 \<br>&amp;\frac{df(x,w)}{dx} &amp;&#x3D; &amp; -2w(y-xw)\<br>&amp;\frac{df(x,w)}{dw} &amp;&#x3D; &amp; -2x(y-xw)<br>\end{align*}<br>$$<br><strong>练习：</strong></p><p>已知$J(a,b,c) &#x3D; 3(a+bc),令u&#x3D;a+v,v &#x3D; bc$,求a，b，c各自的偏导数。<br>$$<br>\begin{align*}<br> 令:&amp; J(a,b,c) &#x3D; 3u\<br> \frac{dJ}{da} &amp;&#x3D;\frac{dJ}{du} \times \frac{du}{da} &#x3D; 3\times1 \<br> \frac{dJ}{db} &amp;&#x3D;\frac{dJ}{du} \times \frac{du}{dv} \times \frac{dv}{db} &#x3D; 3\times1\times c \<br> \frac{dJ}{dc} &amp;&#x3D;\frac{dJ}{du} \times \frac{du}{dv} \times \frac{dv}{dc} &#x3D; 3\times1\times b \<br>\end{align*}<br>$$</p><h2 id="3-反向传播算法"><a href="#3-反向传播算法" class="headerlink" title="3. 反向传播算法"></a>3. 反向传播算法</h2><h3 id="3-1-计算图和反向传播"><a href="#3-1-计算图和反向传播" class="headerlink" title="3.1 计算图和反向传播"></a>3.1 计算图和反向传播</h3><p>计算图：通过图的方式来描述函数的图形</p><p>在上面的练习中，$J(a,b,c) &#x3D; 3(a+bc),令u&#x3D;a+v,v &#x3D; bc$,把它绘制成计算图可以表示为：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E8%AE%A1%E7%AE%97%E5%9B%BE.png"></p><p>绘制成为计算图之后，可以清楚的看到向前计算的过程</p><p>之后，对每个节点求偏导可有：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E8%AE%A1%E7%AE%97%E6%A2%AF%E5%BA%A6.png"></p><p>那么反向传播的过程就是一个上图的从右往左的过程，自变量$a,b,c$各自的偏导就是连线上的梯度的乘积：<br>$$<br>\begin{align*}<br>\frac{dJ}{da} &amp;&#x3D; 3 \times 1 \<br>\frac{dJ}{db} &amp;&#x3D; 3 \times 1 \times c \<br>\frac{dJ}{dc} &amp;&#x3D; 3 \times 1 \times b<br>\end{align*}<br>$$</p><h3 id="3-2-神经网络中的反向传播"><a href="#3-2-神经网络中的反向传播" class="headerlink" title="3.2 神经网络中的反向传播"></a>3.2 神经网络中的反向传播</h3><h4 id="3-2-1-神经网络的示意图"><a href="#3-2-1-神经网络的示意图" class="headerlink" title="3.2.1 神经网络的示意图"></a>3.2.1 神经网络的示意图</h4><p>$w1,w2,….wn$表示网络第n层权重</p><p>$w_n[i,j]$表示第n层第i个神经元，连接到第n+1层第j个神经元的权重。</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E8%AE%A1%E7%AE%97%E5%9B%BE.png"></p><h4 id="3-2-2-神经网络的计算图"><a href="#3-2-2-神经网络的计算图" class="headerlink" title="3.2.2 神经网络的计算图"></a>3.2.2 神经网络的计算图</h4><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E8%AE%A1%E7%AE%97%E5%9B%BE2.png"></p><p>其中：</p><ol><li>$\nabla out$是根据损失函数对预测值进行求导得到的结果</li><li>f函数可以理解为激活函数</li></ol><p><strong>问题：</strong>那么此时$w_1[1,2]$的偏导该如何求解呢？</p><p>通过观察，发现从$out$ 到$w_1[1,2]$的来连接线有两条</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%81%8F%E5%AF%BC%E7%9A%84%E8%AE%A1%E7%AE%97.png"></p><p>结果如下：<br>$$<br>\frac{dout}{dW_1[1,2]} &#x3D; x1<em>f^{‘}(a2)</em>(W_2[2,1]*f^{‘}(b1)*W_3[1,1]*\nabla out +W_2[2,2]*f^{‘}(b2)*W_3[2,1]*\nabla out)<br>$$<br>公式分为两部分：</p><ol><li>括号外：左边红线部分</li><li>括号内<ol><li>加号左边：右边红线部分</li><li>加号右边：蓝线部分</li></ol></li></ol><p>但是这样做，当模型很大的时候，计算量非常大</p><p>所以反向传播的思想就是对其中的某一个参数单独求梯度，之后更新，如下图所示：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%81%8F%E5%AF%BC%E7%9A%84%E8%AE%A1%E7%AE%972.png"></p><p>计算过程如下<br>$$<br>\begin{align*}<br>&amp;\nabla W_3[1,1] &#x3D; f(b_1)*\nabla out  &amp; （计算W_3[1,1]梯度）\<br>&amp;\nabla W_3[2,1] &#x3D; f(b_2)*\nabla out  &amp; （计算W_3[2,1]梯度）\<br>\<br>&amp;\nabla b_1&#x3D; f^{‘}(b_1)*W_3[1,1]*\nabla out  &amp; （计算W_3[2,1]梯度）\<br>&amp;\nabla b_2&#x3D; f^{‘}(b_2)*W_3[2,1]*\nabla out  &amp; （计算W_3[2,1]梯度）\</p><p>\end{align*}<br>$$<br>更新参数之后，继续反向传播</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%81%8F%E5%AF%BC%E7%9A%84%E8%AE%A1%E7%AE%973.png"></p><p>计算过程如下：<br>$$<br>\begin{align*}<br>&amp;\nabla W_2[1,2] &#x3D; f(a_1)* \nabla b_2 \<br>&amp;\nabla a_2 &#x3D; f^{‘}(a_2)<em>(w_2[2,1]\nabla b_1 +W_2[2,2] \nabla b_2)<br>\end{align</em>}<br>$$<br>继续反向传播</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%81%8F%E5%AF%BC%E7%9A%84%E8%AE%A1%E7%AE%974.png"></p><p>计算过程如下：<br>$$<br>\begin{align*}<br>&amp;▽W_1[1,2]&#x3D; x_1*▽a_2\<br>&amp;▽x_1&#x3D; (W_1[1,1]*▽a_1+w_1[1,2]*▽a_2)<em>x_1’<br>\end{align</em>}<br>$$</p><p><strong>通用的描述如下</strong><br>$$<br>\nabla w^{l}<em>{i,j} &#x3D; f(a^l_i)* \nabla a^{i+1}</em>{j}\<br>\nabla a^{l}<em>i &#x3D; f’(a^l_i)*(\sum</em>{j&#x3D;1}^{m}w_{i,j}*\nabla a_j^{l+1})<br>$$</p><h1 id="Pytorch完成线性回归"><a href="#Pytorch完成线性回归" class="headerlink" title="Pytorch完成线性回归"></a>Pytorch完成线性回归</h1><h2 id="目标-3"><a href="#目标-3" class="headerlink" title="目标"></a>目标</h2><ol><li><p>知道<code>requires_grad</code>的作用</p></li><li><p>知道如何使用<code>backward</code></p></li><li><p>知道如何手动完成线性回归</p></li></ol><h2 id="1-向前计算"><a href="#1-向前计算" class="headerlink" title="1. 向前计算"></a>1. 向前计算</h2><p>对于pytorch中的一个tensor，如果设置它的属性 <code>.requires_grad</code>为<code>True</code>，那么它将会追踪对于该张量的所有操作。或者可以理解为，这个tensor是一个参数，后续会被计算梯度，更新该参数。</p><h3 id="1-1-计算过程"><a href="#1-1-计算过程" class="headerlink" title="1.1 计算过程"></a>1.1 计算过程</h3><p>假设有以下条件（1&#x2F;4表示求均值，xi中有4个数），使用torch完成其向前计算的过程<br>$$<br>\begin{align*}<br>&amp;o &#x3D; \frac{1}{4}\sum_iz_i \<br>&amp;z_i &#x3D; 3(x_i+2)^2\<br>其中:&amp;\<br>&amp;z_i|_{x_i&#x3D;1}&#x3D;27\<br>\end{align*}<br>$$<br>如果x为参数，需要对其进行梯度的计算和更新</p><p>那么，在最开始随机设置x的值的过程中，需要设置他的requires_grad属性为True，其<strong>默认值为False</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br>x = torch.ones(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, requires_grad=<span class="hljs-literal">True</span>)  <span class="hljs-comment">#初始化参数x并设置requires_grad=True用来追踪其计算历史</span><br><span class="hljs-built_in">print</span>(x)<br><span class="hljs-comment">#tensor([[1., 1.],</span><br><span class="hljs-comment">#        [1., 1.]], requires_grad=True)</span><br><br>y = x+<span class="hljs-number">2</span><br><span class="hljs-built_in">print</span>(y)<br><span class="hljs-comment">#tensor([[3., 3.],</span><br><span class="hljs-comment">#        [3., 3.]], grad_fn=&lt;AddBackward0&gt;)</span><br><br>z = y*y*<span class="hljs-number">3</span>  <span class="hljs-comment">#平方x3</span><br><span class="hljs-built_in">print</span>(x)<br><span class="hljs-comment">#tensor([[27., 27.],</span><br><span class="hljs-comment">#        [27., 27.]], grad_fn=&lt;MulBackward0&gt;) </span><br><br>out = z.mean() <span class="hljs-comment">#求均值</span><br><span class="hljs-built_in">print</span>(out)<br><span class="hljs-comment">#tensor(27., grad_fn=&lt;MeanBackward0&gt;)</span><br><br></code></pre></td></tr></table></figure><p>从上述代码可以看出：</p><ol><li>x的requires_grad属性为True</li><li>之后的每次计算都会修改其<code>grad_fn</code>属性，用来记录做过的操作<ol><li>通过这个函数和grad_fn能够组成一个和前一小节类似的计算图</li></ol></li></ol><h3 id="1-2-requires-grad和grad-fn"><a href="#1-2-requires-grad和grad-fn" class="headerlink" title="1.2 requires_grad和grad_fn"></a>1.2 requires_grad和grad_fn</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">a = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)<br>a = ((a * <span class="hljs-number">3</span>) / (a - <span class="hljs-number">1</span>))<br><span class="hljs-built_in">print</span>(a.requires_grad)  <span class="hljs-comment">#False</span><br>a.requires_grad_(<span class="hljs-literal">True</span>)  <span class="hljs-comment">#就地修改</span><br><span class="hljs-built_in">print</span>(a.requires_grad)  <span class="hljs-comment">#True</span><br>b = (a * a).<span class="hljs-built_in">sum</span>()<br><span class="hljs-built_in">print</span>(b.grad_fn) <span class="hljs-comment"># &lt;SumBackward0 object at 0x4e2b14345d21&gt;</span><br><span class="hljs-keyword">with</span> torch.no_gard():<br>    c = (a * a).<span class="hljs-built_in">sum</span>()  <span class="hljs-comment">#tensor(151.6830),此时c没有gard_fn</span><br>    <br><span class="hljs-built_in">print</span>(c.requires_grad) <span class="hljs-comment">#False</span><br></code></pre></td></tr></table></figure><p>注意：</p><p>为了防止跟踪历史记录（和使用内存），可以将代码块包装在<code>with torch.no_grad():</code>中。<strong>在评估模型时特别有用</strong>，因为模型可能具有<code>requires_grad = True</code>的可训练的参数，但是我们不需要在此过程中对他们进行梯度计算。</p><h2 id="2-梯度计算"><a href="#2-梯度计算" class="headerlink" title="2. 梯度计算"></a>2. 梯度计算</h2><p>对于1.1 中的out而言，我们可以使用<code>backward</code>方法来进行反向传播，计算梯度</p><p><code>out.backward()</code>,此时便能够求出导数$\frac{d out}{dx}$,调用<code>x.gard</code>能够获取导数值</p><p>得到</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">tensor([[<span class="hljs-number">4.5000</span>, <span class="hljs-number">4.5000</span>],<br>        [<span class="hljs-number">4.5000</span>, <span class="hljs-number">4.5000</span>]])<br></code></pre></td></tr></table></figure><p> 因为：<br>$$<br>\frac{d(O)}{d(x_i)} &#x3D; \frac{3}{2}(x_i+2)<br>$$<br>在$x_i$等于1时其值为4.5</p><p>注意：在输出为一个标量的情况下，我们可以调用输出<code>tensor</code>的<code>backword()</code> 方法，但是在数据是一个向量的时候，调用<code>backward()</code>的时候还需要传入其他参数。</p><p>很多时候我们的损失函数都是一个标量，所以这里就不再介绍损失为向量的情况。</p><p><code>loss.backward()</code>就是根据损失函数，对参数（requires_grad&#x3D;True）的去计算他的梯度，并且把它累加保存到<code>x.gard</code>，此时还并未更新其梯度</p><p>注意点：</p><ol><li><p><code>tensor.data</code>:</p><ul><li><p>在tensor的require_grad&#x3D;False，tensor.data和tensor等价</p></li><li><p>require_grad&#x3D;True时，tensor.data仅仅是获取tensor中的数据</p></li></ul></li><li><p><code>tensor.numpy()</code>:</p><ul><li><code>require_grad=True</code>不能够直接转换，需要使用<code>tensor.detach().numpy()</code></li></ul></li></ol><h2 id="3-线性回归实现"><a href="#3-线性回归实现" class="headerlink" title="3. 线性回归实现"></a>3. 线性回归实现</h2><p>下面，我们使用一个自定义的数据，来使用torch实现一个简单的线性回归</p><p>假设我们的基础模型就是<code>y = wx+b</code>，其中w和b均为参数，我们使用<code>y = 3x+0.8</code>来构造数据x、y，所以最后通过模型应该能够得出w和b应该分别接近3和0.8</p><ol><li>准备数据</li><li>计算预测值</li><li>计算损失，把参数的梯度置为0，进行反向传播</li><li>更新参数</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> matplotlib <span class="hljs-keyword">import</span> pyplot <span class="hljs-keyword">as</span> plt<br><br><br><span class="hljs-comment">#1. 准备数据 y = 3x+0.8，准备参数</span><br>x = torch.rand([<span class="hljs-number">50</span>])<br>y = <span class="hljs-number">3</span>*x + <span class="hljs-number">0.8</span><br><br>w = torch.rand(<span class="hljs-number">1</span>,requires_grad=<span class="hljs-literal">True</span>)<br>b = torch.rand(<span class="hljs-number">1</span>,requires_grad=<span class="hljs-literal">True</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">loss_fn</span>(<span class="hljs-params">y,y_predict</span>):<br>    loss = (y_predict-y).<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>).mean()<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [w,b]:<br><span class="hljs-comment">#每次反向传播前把梯度置为0</span><br>        <span class="hljs-keyword">if</span> i.grad <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            i.grad.data.zero_()<br>    <span class="hljs-comment"># [i.grad.data.zero_() for i in [w,b] if i.grad is not None]</span><br>    loss.backward()<br>    <span class="hljs-keyword">return</span> loss.data<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">optimize</span>(<span class="hljs-params">learning_rate</span>):<br>    <span class="hljs-comment"># print(w.grad.data,w.data,b.data)</span><br>    w.data -= learning_rate* w.grad.data<br>    b.data -= learning_rate* b.grad.data<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3000</span>):<br>    <span class="hljs-comment">#2. 计算预测值</span><br>    y_predict = x*w + b<br><br>    <span class="hljs-comment">#3.计算损失，把参数的梯度置为0，进行反向传播 </span><br>    loss = loss_fn(y,y_predict)<br>    <br>    <span class="hljs-keyword">if</span> i%<span class="hljs-number">500</span> == <span class="hljs-number">0</span>:<br>        <span class="hljs-built_in">print</span>(i,loss)<br>    <span class="hljs-comment">#4. 更新参数w和b</span><br>    optimize(<span class="hljs-number">0.01</span>)<br><br><span class="hljs-comment"># 绘制图形，观察训练结束的预测值和真实值</span><br>predict =  x*w + b  <span class="hljs-comment">#使用训练后的w和b计算预测值</span><br><br>plt.scatter(x.data.numpy(), y.data.numpy(),c = <span class="hljs-string">&quot;r&quot;</span>)<br>plt.plot(x.data.numpy(), predict.data.numpy())<br>plt.show()<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;w&quot;</span>,w)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;b&quot;</span>,b)<br></code></pre></td></tr></table></figure><p>图形效果如下：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%921.png"></p><p>打印w和b，可有</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">w tensor([<span class="hljs-number">2.9280</span>], requires_grad=<span class="hljs-literal">True</span>)<br>b tensor([<span class="hljs-number">0.8372</span>], requires_grad=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p>可知，w和b已经非常接近原来的预设的3和0.8</p><h1 id="Pytorch完成基础的模型"><a href="#Pytorch完成基础的模型" class="headerlink" title="Pytorch完成基础的模型"></a>Pytorch完成基础的模型</h1><h2 id="目标-4"><a href="#目标-4" class="headerlink" title="目标"></a>目标</h2><ol><li>知道Pytorch中Module的使用方法</li><li>知道Pytorch中优化器类的使用方法</li><li>知道Pytorch中常见的损失函数的使用方法</li><li>知道如何在GPU上运行代码</li><li>能够说出常见的优化器及其原理</li></ol><h2 id="1-Pytorch完成模型常用API"><a href="#1-Pytorch完成模型常用API" class="headerlink" title="1. Pytorch完成模型常用API"></a>1. Pytorch完成模型常用API</h2><p>在前一部分，我们自己实现了通过torch的相关方法完成反向传播和参数更新，在pytorch中预设了一些更加灵活简单的对象，让我们来构造模型、定义损失，优化损失等</p><p>那么接下来，我们一起来了解一下其中常用的API</p><h3 id="1-1-nn-Module"><a href="#1-1-nn-Module" class="headerlink" title="1.1 nn.Module"></a>1.1 <code>nn.Module</code></h3><p><code>nn.Modul</code> 是<code>torch.nn</code>提供的一个类，是pytorch中我们<code>自定义网络</code>的一个基类，在这个类中定义了很多有用的方法，让我们在继承这个类定义网络的时候非常简单</p><p>当我们自定义网络的时候，有两个方法需要特别注意：</p><ol><li><code>__init__</code>需要调用<code>super</code>方法，继承父类的属性和方法</li><li><code>farward</code>方法必须实现，用来定义我们的网络的向前计算的过程</li></ol><p>用前面的<code>y = wx+b</code>的模型举例如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Lr</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(Lr, self).__init__()  <span class="hljs-comment">#继承父类init的参数</span><br>        self.linear = nn.Linear(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) <br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        out = self.linear(x)<br>        <span class="hljs-keyword">return</span> out<br></code></pre></td></tr></table></figure><p>注意：</p><ol><li><code>nn.Linear</code>为torch预定义好的线性模型，也被称为<strong>全链接层</strong>，传入的参数为输入的数量，输出的数量(in_features, out_features),是不算(batch_size的列数)</li><li><code>nn.Module</code>定义了<code>__call__</code>方法，实现的就是调用<code>forward</code>方法，即<code>Lr</code>的实例，能够直接被传入参数调用，实际上调用的是<code>forward</code>方法并传入参数</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 实例化模型</span><br>model = Lr()<br><span class="hljs-comment"># 传入数据，计算结果</span><br>predict = model(x)<br></code></pre></td></tr></table></figure><h3 id="1-2-优化器类"><a href="#1-2-优化器类" class="headerlink" title="1.2 优化器类"></a>1.2 优化器类</h3><p>优化器(<code>optimizer</code>)，可以理解为torch为我们封装的用来进行更新参数的方法，比如常见的随机梯度下降(<code>stochastic gradient descent,SGD</code>)</p><p>优化器类都是由<code>torch.optim</code>提供的，例如</p><ol><li><code>torch.optim.SGD(参数，学习率)</code></li><li><code>torch.optim.Adam(参数，学习率)</code></li></ol><p>注意：</p><ol><li>参数可以使用<code>model.parameters()</code>来获取，获取模型中所有<code>requires_grad=True</code>的参数</li><li>优化类的使用方法<ol><li>实例化</li><li>所有参数的梯度，将其值置为0</li><li>反向传播计算梯度</li><li>更新参数值</li></ol></li></ol><p>示例如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">optimizer = optim.SGD(model.parameters(), lr=<span class="hljs-number">1e-3</span>) <span class="hljs-comment">#1. 实例化</span><br>optimizer.zero_grad() <span class="hljs-comment">#2. 梯度置为0</span><br>loss.backward() <span class="hljs-comment">#3. 计算梯度</span><br>optimizer.step()  <span class="hljs-comment">#4. 更新参数的值</span><br></code></pre></td></tr></table></figure><h3 id="1-3-损失函数"><a href="#1-3-损失函数" class="headerlink" title="1.3 损失函数"></a>1.3 损失函数</h3><p>前面的例子是一个回归问题，torch中也预测了很多损失函数</p><ol><li>均方误差:<code>nn.MSELoss()</code>,常用于回归问题</li><li>交叉熵损失：<code>nn.CrossEntropyLoss()</code>，常用于分类问题</li></ol><p>使用方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">model = Lr() <span class="hljs-comment">#1. 实例化模型</span><br>criterion = nn.MSELoss() <span class="hljs-comment">#2. 实例化损失函数</span><br>optimizer = optim.SGD(model.parameters(), lr=<span class="hljs-number">1e-3</span>) <span class="hljs-comment">#3. 实例化优化器类</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):<br>    y_predict = model(x_true) <span class="hljs-comment">#4. 向前计算预测值</span><br>    loss = criterion(y_true,y_predict) <span class="hljs-comment">#5. 调用损失函数传入真实值和预测值，得到损失结果</span><br>    optimizer.zero_grad() <span class="hljs-comment">#5. 当前循环参数梯度置为0</span><br>    loss.backward() <span class="hljs-comment">#6. 计算梯度</span><br>    optimizer.step()  <span class="hljs-comment">#7. 更新参数的值</span><br></code></pre></td></tr></table></figure><h3 id="1-4-把线性回归完整代码"><a href="#1-4-把线性回归完整代码" class="headerlink" title="1.4 把线性回归完整代码"></a>1.4 把线性回归完整代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> optim<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> matplotlib <span class="hljs-keyword">import</span> pyplot <span class="hljs-keyword">as</span> plt<br><br><span class="hljs-comment"># 1. 定义数据</span><br>x = torch.rand([<span class="hljs-number">50</span>,<span class="hljs-number">1</span>])<br>y = x*<span class="hljs-number">3</span> + <span class="hljs-number">0.8</span><br><br><span class="hljs-comment">#2 .定义模型</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Lr</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(Lr,self).__init__()<br>        self.linear = nn.Linear(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        out = self.linear(x)<br>        <span class="hljs-keyword">return</span> out<br><br><span class="hljs-comment"># 2. 实例化模型，loss，和优化器</span><br>model = Lr()<br>criterion = nn.MSELoss()<br>optimizer = optim.SGD(model.parameters(), lr=<span class="hljs-number">1e-3</span>)<br><span class="hljs-comment">#3. 训练模型</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30000</span>):<br>    out = model(x) <span class="hljs-comment">#3.1 获取预测值</span><br>    loss = criterion(y,out) <span class="hljs-comment">#3.2 计算损失</span><br>    optimizer.zero_grad()  <span class="hljs-comment">#3.3 梯度归零</span><br>    loss.backward() <span class="hljs-comment">#3.4 计算梯度</span><br>    optimizer.step()  <span class="hljs-comment"># 3.5 更新梯度</span><br>    <span class="hljs-keyword">if</span> (i+<span class="hljs-number">1</span>) % <span class="hljs-number">20</span> == <span class="hljs-number">0</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Epoch[&#123;&#125;/&#123;&#125;], loss: &#123;:.6f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(i,<span class="hljs-number">30000</span>,loss.data))<br><br><span class="hljs-comment">#4. 模型评估</span><br>model.<span class="hljs-built_in">eval</span>() <span class="hljs-comment">#设置模型为评估模式，即预测模式</span><br>predict = model(x)<br>predict = predict.data.numpy()<br>plt.scatter(x.data.numpy(),y.data.numpy(),c=<span class="hljs-string">&quot;r&quot;</span>)<br>plt.plot(x.data.numpy(),predict)<br>plt.show()<br></code></pre></td></tr></table></figure><p>输出如下：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%922.png"></p><p>注意：</p><p><code>model.eval()</code>表示设置模型为评估模式，即预测模式</p><p><code>model.train(mode=True)</code> 表示设置模型为训练模式</p><p>在当前的线性回归中，上述并无区别</p><p>但是在其他的一些模型中，<strong>训练的参数和预测的参数会不相同</strong>，到时候就需要具体告诉程序我们是在进行训练还是预测，比如模型中存在<strong>Dropout</strong>，<strong>BatchNorm</strong>的时候</p><h2 id="2-在GPU上运行代码"><a href="#2-在GPU上运行代码" class="headerlink" title="2. 在GPU上运行代码"></a>2. 在GPU上运行代码</h2><p>当模型太大，或者参数太多的情况下，为了加快训练速度，经常会使用GPU来进行训练</p><p>此时我们的代码需要稍作调整：</p><ol><li><p>判断GPU是否可用<code>torch.cuda.is_available()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">torch.device(<span class="hljs-string">&quot;cuda:0&quot;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;cpu&quot;</span>)<br>&gt;&gt;device(<span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;cuda&#x27;</span>, index=<span class="hljs-number">0</span>)  <span class="hljs-comment">#使用gpu</span><br>&gt;&gt;device(<span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;cpu&#x27;</span>) <span class="hljs-comment">#使用cpu</span><br></code></pre></td></tr></table></figure></li><li><p>把模型参数和input数据转化为cuda的支持类型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">model.to(device)<br>x_true.to(device)<br></code></pre></td></tr></table></figure></li><li><p>在GPU上计算结果也为cuda的数据类型，需要转化为numpy或者torch的cpu的tensor类型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">predict = predict.cpu().detach().numpy() <br></code></pre></td></tr></table></figure><p><code>detach()</code>的效果和data的相似，但是<code>detach()</code>是深拷贝，data是取值，是浅拷贝</p></li></ol><p>修改之后的代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> optim<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> matplotlib <span class="hljs-keyword">import</span> pyplot <span class="hljs-keyword">as</span> plt<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-comment"># 1. 定义数据</span><br>x = torch.rand([<span class="hljs-number">50</span>,<span class="hljs-number">1</span>])<br>y = x*<span class="hljs-number">3</span> + <span class="hljs-number">0.8</span><br><br><span class="hljs-comment">#2 .定义模型</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Lr</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(Lr,self).__init__()<br>        self.linear = nn.Linear(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        out = self.linear(x)<br>        <span class="hljs-keyword">return</span> out<br><br><span class="hljs-comment"># 2. 实例化模型，loss，和优化器</span><br><br>device = torch.device(<span class="hljs-string">&quot;cuda:0&quot;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;cpu&quot;</span>)<br>x,y = x.to(device),y.to(device)<br><br>model = Lr().to(device)<br>criterion = nn.MSELoss()<br>optimizer = optim.SGD(model.parameters(), lr=<span class="hljs-number">1e-3</span>)<br><br><span class="hljs-comment">#3. 训练模型</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">300</span>):<br>    out = model(x)<br>    loss = criterion(y,out)<br><br>    optimizer.zero_grad()<br>    loss.backward()<br>    optimizer.step()<br>    <span class="hljs-keyword">if</span> (i+<span class="hljs-number">1</span>) % <span class="hljs-number">20</span> == <span class="hljs-number">0</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Epoch[&#123;&#125;/&#123;&#125;], loss: &#123;:.6f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(i,<span class="hljs-number">30000</span>,loss.data))<br><br><span class="hljs-comment">#4. 模型评估</span><br>model.<span class="hljs-built_in">eval</span>() <span class="hljs-comment">#</span><br>predict = model(x)<br>predict = predict.cpu().detach().numpy() <span class="hljs-comment">#转化为numpy数组</span><br>plt.scatter(x.cpu().data.numpy(),y.cpu().data.numpy(),c=<span class="hljs-string">&quot;r&quot;</span>)<br>plt.plot(x.cpu().data.numpy(),predict,)<br>plt.show()<br><br></code></pre></td></tr></table></figure><h2 id="3-常见的优化算法介绍"><a href="#3-常见的优化算法介绍" class="headerlink" title="3. 常见的优化算法介绍"></a>3. 常见的优化算法介绍</h2><h3 id="3-1-梯度下降算法（batch-gradient-descent-BGD）"><a href="#3-1-梯度下降算法（batch-gradient-descent-BGD）" class="headerlink" title="3.1 梯度下降算法（batch gradient descent BGD）"></a>3.1 梯度下降算法（batch gradient descent BGD）</h3><p>每次迭代都需要把所有样本都送入，这样的好处是每次迭代都顾及了全部的样本，做的是全局最优化,但是有可能达到局部最优。</p><h3 id="3-2-随机梯度下降法-Stochastic-gradient-descent-SGD"><a href="#3-2-随机梯度下降法-Stochastic-gradient-descent-SGD" class="headerlink" title="3.2 随机梯度下降法 (Stochastic gradient descent SGD)"></a>3.2 随机梯度下降法 (Stochastic gradient descent SGD)</h3><p>针对梯度下降算法训练速度过慢的缺点，提出了随机梯度下降算法，随机梯度下降算法算法是从样本中随机抽出一组，训练后按梯度更新一次，然后再抽取一组，再更新一次，在样本量及其大的情况下，可能不用训练完所有的样本就可以获得一个损失值在可接受范围之内的模型了。</p><p>torch中的api为：<code>torch.optim.SGD()</code></p><h3 id="3-3-小批量梯度下降-Mini-batch-gradient-descent-MBGD）"><a href="#3-3-小批量梯度下降-Mini-batch-gradient-descent-MBGD）" class="headerlink" title="3.3 小批量梯度下降 (Mini-batch gradient descent MBGD）"></a>3.3 小批量梯度下降 (Mini-batch gradient descent MBGD）</h3><p>SGD相对来说要快很多，但是也有存在问题，由于单个样本的训练可能会带来很多噪声，使得SGD并不是每次迭代都向着整体最优化方向，因此在刚开始训练时可能收敛得很快，但是训练一段时间后就会变得很慢。在此基础上又提出了小批量梯度下降法，它是每次从样本中随机抽取一小批进行训练，而不是一组，这样即保证了效果又保证的速度。</p><h3 id="3-4-动量法"><a href="#3-4-动量法" class="headerlink" title="3.4 动量法"></a>3.4 动量法</h3><p>mini-batch SGD算法虽然这种算法能够带来很好的训练速度，但是在到达最优点的时候并不能够总是真正到达最优点，而是在最优点附近徘徊。</p><p>另一个缺点就是mini-batch SGD需要我们挑选一个合适的学习率，当我们采用小的学习率的时候，会导致网络在训练的时候收敛太慢；当我们采用大的学习率的时候，会导致在训练过程中优化的幅度跳过函数的范围，也就是可能跳过最优点。我们所希望的仅仅是网络在优化的时候网络的损失函数有一个很好的收敛速度同时又不至于摆动幅度太大。</p><p>所以Momentum优化器刚好可以解决我们所面临的问题，它主要是基于梯度的移动指数加权平均，对网络的梯度进行平滑处理的，让梯度的摆动幅度变得更小。<br>$$<br>\begin{align*}<br>&amp;gradent &#x3D; 0.8\nabla w + 0.2 history_gradent  &amp;，\nabla w 表示当前一次的梯度\<br>&amp;w &#x3D; w - \alpha* gradent &amp;，\alpha表示学习率<br>\end{align*}<br>$$</p><p>（注：t+1的的histroy_gradent 为第t次的gradent）</p><h3 id="3-5-AdaGrad"><a href="#3-5-AdaGrad" class="headerlink" title="3.5 AdaGrad"></a>3.5 AdaGrad</h3><p>AdaGrad算法就是将每一个参数的每一次迭代的梯度取平方累加后在开方，用全局学习率除以这个数，作为学习率的动态更新，从而达到<strong>自适应学习率</strong>的效果<br>$$<br>\begin{align*}<br>&amp;gradent &#x3D; history_gradent + (\nabla w)^2 \<br>&amp;w &#x3D; w - \frac{\alpha}{\sqrt{gradent}+\delta} \nabla w ,&amp;\delta为小常数，为了数值稳定大约设置为10^{-7}<br>\end{align*}<br>$$</p><h3 id="3-6-RMSProp"><a href="#3-6-RMSProp" class="headerlink" title="3.6 RMSProp"></a>3.6 RMSProp</h3><p>Momentum优化算法中，虽然初步解决了优化中摆动幅度大的问题,为了进一步优化损失函数在更新中存在摆动幅度过大的问题，并且进一步加快函数的收敛速度，RMSProp算法对参数的梯度使用了平方加权平均数。<br>$$<br>\begin{align*}<br>&amp; gradent &#x3D; 0.8<em>history_gradent + 0.2</em>(\nabla w)^2 \<br>&amp; w &#x3D; w - \frac{\alpha}{\sqrt{gradent}+\delta} \nabla w<br>\end{align*}<br>$$</p><h3 id="3-7-Adam"><a href="#3-7-Adam" class="headerlink" title="3.7 Adam"></a>3.7 Adam</h3><p>Adam（Adaptive Moment Estimation）算法是将Momentum算法和RMSProp算法结合起来使用的一种算法,能够达到防止梯度的摆幅多大，同时还能够加开收敛速度<br>$$<br>\begin{align*}<br>&amp; 1. 需要初始化梯度的累积量和平方累积量 \<br>&amp; v_w &#x3D; 0,s_w &#x3D; 0 \<br>&amp; 2. 第 t 轮训练中，我们首先可以计算得到Momentum和RMSProp的参数更新：\<br>&amp; v_w &#x3D; 0.8v  + 0.2 \nabla w \qquad,Momentum计算的梯度\<br>&amp; s_w &#x3D; 0.8<em>s + 0.2</em>(\nabla w)^2 \qquad,RMSProp计算的梯度\<br>&amp; 3. 对其中的值进行处理后，得到：\<br>&amp; w &#x3D; w - \frac{\alpha}{\sqrt{s_w}+\delta} v_w<br>\end{align*}<br>$$<br>torch中的api为：<code>torch.optim.Adam()</code></p><h3 id="3-8-效果演示："><a href="#3-8-效果演示：" class="headerlink" title="3.8 效果演示："></a>3.8 效果演示：</h3><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E4%BC%98%E5%8C%96%E5%99%A8%E6%96%B9%E6%B3%95.gif"></p><p>​</p><h1 id="Pytorch中的数据加载"><a href="#Pytorch中的数据加载" class="headerlink" title="Pytorch中的数据加载"></a>Pytorch中的数据加载</h1><h2 id="目标-5"><a href="#目标-5" class="headerlink" title="目标"></a>目标</h2><ol><li>知道数据加载的目的</li><li>知道pytorch中Dataset的使用方法</li><li>知道pytorch中DataLoader的使用方法</li><li>知道pytorch中的自带数据集如何获取</li></ol><h2 id="1-模型中使用数据加载器的目的"><a href="#1-模型中使用数据加载器的目的" class="headerlink" title="1. 模型中使用数据加载器的目的"></a>1. 模型中使用数据加载器的目的</h2><p>在前面的线性回归模型中，我们使用的数据很少，所以直接把全部数据放到模型中去使用。</p><p>但是在深度学习中，数据量通常是都非常多，非常大的，如此大量的数据，不可能一次性的在模型中进行向前的计算和反向传播，经常我们会对整个数据进行随机的打乱顺序，把数据处理成一个个的batch，同时还会对数据进行预处理。</p><p>所以，接下来我们来学习pytorch中的数据加载的方法</p><h2 id="2-数据集类"><a href="#2-数据集类" class="headerlink" title="2. 数据集类"></a>2. 数据集类</h2><h3 id="2-1-Dataset基类介绍"><a href="#2-1-Dataset基类介绍" class="headerlink" title="2.1 Dataset基类介绍"></a>2.1 Dataset基类介绍</h3><p>在torch中提供了数据集的基类<code>torch.utils.data.Dataset</code>，继承这个基类，我们能够非常快速的实现对数据的加载。</p><p><code>torch.utils.data.Dataset</code>的源码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dataset</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;An abstract class representing a Dataset.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    All other datasets should subclass it. All subclasses should override</span><br><span class="hljs-string">    ``__len__``, that provides the size of the dataset, and ``__getitem__``,</span><br><span class="hljs-string">    supporting integer indexing in range from 0 to len(self) exclusive.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, index</span>):<br>        <span class="hljs-keyword">raise</span> NotImplementedError<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">raise</span> NotImplementedError<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__add__</span>(<span class="hljs-params">self, other</span>):<br>        <span class="hljs-keyword">return</span> ConcatDataset([self, other])<br></code></pre></td></tr></table></figure><p>可知：我们需要在自定义的数据集类中继承Dataset类，同时还需要实现两个方法：</p><ol><li><code>__len__</code>方法，能够实现通过全局的<code>len()</code>方法获取其中的元素个数</li><li><code>__getitem__</code>方法，能够通过传入索引的方式获取数据，例如通过<code>dataset[i]</code>获取其中的第<code>i</code>条数据</li></ol><h3 id="2-2-数据加载案例"><a href="#2-2-数据加载案例" class="headerlink" title="2.2 数据加载案例"></a>2.2 数据加载案例</h3><p>下面通过一个例子来看看如何使用Dataset来加载数据</p><p>数据来源：<code>http://archive.ics.uci.edu/ml/datasets/SMS+Spam+Collection</code></p><p>数据介绍：SMS Spam Collection是用于骚扰短信识别的经典数据集，完全来自真实短信内容，包括4831条正常短信和747条骚扰短信。正常短信和骚扰短信保存在一个文本文件中。 每行完整记录一条短信内容，每行开头通过ham和spam标识正常短信和骚扰短信</p><p>数据实例：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/dataset%E6%95%B0%E6%8D%AE%E7%A4%BA%E4%BE%8B.png"></p><p>实现如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> Dataset,DataLoader<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br>data_path = <span class="hljs-string">r&quot;data\SMSSpamCollection&quot;</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CifarDataset</span>(<span class="hljs-title class_ inherited__">Dataset</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        lines = <span class="hljs-built_in">open</span>(data_path,<span class="hljs-string">&quot;r&quot;</span>)<br>        <span class="hljs-comment">#对数据进行处理，前4个为label，后面的为短信内容</span><br>        lines = [[i[:<span class="hljs-number">4</span>].strip(),i[<span class="hljs-number">4</span>:].strip()] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> lines]<br>        <span class="hljs-comment">#转化为dataFrame</span><br>        self.df = pd.DataFrame(lines,columns=[<span class="hljs-string">&quot;label&quot;</span>,<span class="hljs-string">&quot;sms&quot;</span>])<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, index</span>):<br>        single_item = self.df.iloc[index,:]<br>        <span class="hljs-keyword">return</span> single_item.values[<span class="hljs-number">0</span>],single_item.values[<span class="hljs-number">1</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> self.df.shape[<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure><p>之后对Dataset进行实例化，可以跌倒获取其中的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">d = CifarDataset()<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(d)):<br>    <span class="hljs-built_in">print</span>(i,d[i])<br></code></pre></td></tr></table></figure><p>输出如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">....<br><span class="hljs-number">5571</span> (<span class="hljs-string">&#x27;ham&#x27;</span>, <span class="hljs-string">&#x27;Pity, * was in mood for that. So...any other suggestions?&#x27;</span>)<br><span class="hljs-number">5572</span> (<span class="hljs-string">&#x27;ham&#x27;</span>, <span class="hljs-string">&quot;The guy did some bitching but I acted like i&#x27;d be interested in buying something else next week and he gave it to us for free&quot;</span>)<br><span class="hljs-number">5573</span> (<span class="hljs-string">&#x27;ham&#x27;</span>, <span class="hljs-string">&#x27;Rofl. Its true to its name&#x27;</span>)<br></code></pre></td></tr></table></figure><h2 id="3-迭代数据集"><a href="#3-迭代数据集" class="headerlink" title="3. 迭代数据集"></a>3. 迭代数据集</h2><p>使用上述的方法能够进行数据的读取，但是其中还有很多内容没有实现：</p><ul><li>批处理数据（Batching the data）</li><li>打乱数据（Shuffling the data）</li><li>使用多线程 <code>multiprocessing</code> 并行加载数据。</li></ul><p>在pytorch中<code>torch.utils.data.DataLoader</code>提供了上述的所用方法</p><p><code>DataLoader</code>的使用方法示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> DataLoader<br><br>dataset = CifarDataset()<br>data_loader = DataLoader(dataset=dataset,batch_size=<span class="hljs-number">10</span>,shuffle=<span class="hljs-literal">True</span>,num_workers=<span class="hljs-number">2</span>)<br><br><span class="hljs-comment">#遍历，获取其中的每个batch的结果</span><br><span class="hljs-keyword">for</span> index, (label, context) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(data_loader):<br>    <span class="hljs-built_in">print</span>(index,label,context)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;*&quot;</span>*<span class="hljs-number">100</span>)<br></code></pre></td></tr></table></figure><p>其中参数含义：</p><ol><li>dataset：提前定义的dataset的实例</li><li>batch_size:传入数据的batch的大小，常用128,256等等</li><li>shuffle：bool类型，表示是否在每次获取数据的时候提前打乱数据</li><li><code>num_workers</code>:加载数据的线程数</li></ol><p>数据迭代器的返回结果如下：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-number">555</span> (&#x27;spam&#x27;, &#x27;ham&#x27;, &#x27;spam&#x27;, &#x27;ham&#x27;, &#x27;ham&#x27;, &#x27;ham&#x27;, &#x27;ham&#x27;, &#x27;spam&#x27;, &#x27;ham&#x27;, &#x27;ham&#x27;) (&#x27;URGENT! We are trying to contact U. Todays draw shows that you have won a £800 prize GUARANTEED. Call <span class="hljs-number">0905000309</span>1 from....&quot;, &#x27;swhrt how u dey,hope ur ok, tot about u <span class="hljs-number">2</span>day.love n miss.take care.&#x27;)<br>***********************************************************************************<br>556 (&#x27;ham&#x27;, &#x27;ham&#x27;, &#x27;ham&#x27;, &#x27;ham&#x27;, &#x27;ham&#x27;, &#x27;ham&#x27;, &#x27;ham&#x27;, &#x27;ham&#x27;, &#x27;ham&#x27;, &#x27;spam&#x27;) (&#x27;He telling not to tell any one. If so treat for me hi hi hi&#x27;, &#x27;Did u got that persons story&#x27;, &quot;Don kn....<span class="hljs-number">1000</span> cash prize or a prize worth £<span class="hljs-number">5000</span>&#x27;)<br></code></pre></td></tr></table></figure><p>注意：</p><ol><li><code>len(dataset) = 数据集的样本数</code></li><li><code>len(dataloader) = math.ceil(样本数/batch_size) 即向上取整</code></li></ol><h2 id="4-pytorch自带的数据集"><a href="#4-pytorch自带的数据集" class="headerlink" title="4 pytorch自带的数据集"></a>4 pytorch自带的数据集</h2><p>pytorch中自带的数据集由两个上层api提供，分别是<code>torchvision</code>和<code>torchtext</code></p><p>其中：</p><ol><li><code>torchvision</code>提供了对图片数据处理相关的api和数据<ul><li>数据位置：<code>torchvision.datasets</code>，例如：<code>torchvision.datasets.MNIST</code>(手写数字图片数据)</li></ul></li><li><code>torchtext</code>提供了对文本数据处理相关的API和数据<ul><li>数据位置：<code>torchtext.datasets</code>,例如：<code>torchtext.datasets.IMDB（电影</code>评论文本数据）</li></ul></li></ol><p>下面我们以Mnist手写数字为例，来看看pytorch如何加载其中自带的数据集</p><p>使用方法和之前一样：</p><ol><li>准备好Dataset实例</li><li>把dataset交给dataloder 打乱顺序，组成batch</li></ol><h3 id="4-1-torchversion-datasets"><a href="#4-1-torchversion-datasets" class="headerlink" title="4.1 torchversion.datasets"></a>4.1 torchversion.datasets</h3><p><code>torchversoin.datasets</code>中的数据集类（比如<code>torchvision.datasets.MNIST</code>）,都是继承自<code>Dataset</code></p><p>意味着：直接对<code>torchvision.datasets.MNIST</code>进行实例化就可以得到<code>Dataset</code>的实例</p><p>但是MNIST API中的参数需要注意一下：</p><p><code> torchvision.datasets.MNIST(root=&#39;/files/&#39;, train=True, download=True, transform=)</code></p><ol><li><code>root</code>参数表示数据存放的位置</li><li><code>train：</code>bool类型，表示是使用训练集的数据还是测试集的数据</li><li><code>download：</code>bool类型，表示是否需要下载数据到root目录</li><li><code>transform:</code>实现的对图片的处理函数</li></ol><h3 id="4-2-MNIST数据集的介绍"><a href="#4-2-MNIST数据集的介绍" class="headerlink" title="4.2 MNIST数据集的介绍"></a>4.2 MNIST数据集的介绍</h3><p>数据集的原始地址：<code>http://yann.lecun.com/exdb/mnist/</code></p><p>MNIST是由<code>Yann LeCun</code>等人提供的免费的图像识别的数据集，其中包括60000个训练样本和10000个测试样本，其中图拍了的尺寸已经进行的标准化的处理，都是黑白的图像，大小为<code>28X28</code></p><p>执行代码，下载数据，观察数据类型：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torchvision<br><br>dataset = torchvision.datasets.MNIST(root=<span class="hljs-string">&quot;./data&quot;</span>,train=<span class="hljs-literal">True</span>,download=<span class="hljs-literal">True</span>,transform=<span class="hljs-literal">None</span>)<br><br><span class="hljs-built_in">print</span>(dataset[<span class="hljs-number">0</span>])<br></code></pre></td></tr></table></figure><p>下载的数据如下：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/MNIST-dataset.png"></p><p>代码输出结果如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">Downloading http://yann.lecun.com/exdb/mnist/train-images-idx3-ubyte.gz<br>Downloading http://yann.lecun.com/exdb/mnist/train-labels-idx1-ubyte.gz<br>Downloading http://yann.lecun.com/exdb/mnist/t10k-images-idx3-ubyte.gz<br>Downloading http://yann.lecun.com/exdb/mnist/t10k-labels-idx1-ubyte.gz<br>Processing...<br>Done!<br>(&lt;PIL.Image.Image image mode=L size=28x28 at <span class="hljs-number">0x18D303B9C18</span>&gt;, tensor(<span class="hljs-number">5</span>))<br></code></pre></td></tr></table></figure><p>可以其中数据集返回了两条数据，可以猜测为图片的数据和目标值</p><p>返回值的第0个为Image类型，可以调用show() 方法打开，发现为手写数字5</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torchvision<br><br>dataset = torchvision.datasets.MNIST(root=<span class="hljs-string">&quot;./data&quot;</span>,train=<span class="hljs-literal">True</span>,download=<span class="hljs-literal">True</span>,transform=<span class="hljs-literal">None</span>)<br><br><span class="hljs-built_in">print</span>(dataset[<span class="hljs-number">0</span>])<br><br>img = dataset[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]<br>img.show() <span class="hljs-comment">#打开图片</span><br></code></pre></td></tr></table></figure><p>图片如下：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/MNIST-dataset-5.png"></p><p>由上可知：返回值为<code>(图片，目标值)</code>,这个结果也可以通过观察源码得到</p><h1 id="使用Pytorch实现手写数字识别"><a href="#使用Pytorch实现手写数字识别" class="headerlink" title="使用Pytorch实现手写数字识别"></a>使用Pytorch实现手写数字识别</h1><h2 id="目标-6"><a href="#目标-6" class="headerlink" title="目标"></a>目标</h2><ol><li>知道如何使用Pytorch完成神经网络的构建</li><li>知道Pytorch中激活函数的使用方法</li><li>知道Pytorch中<code>torchvision.transforms</code>中常见图形处理函数的使用</li><li>知道如何训练模型和如何评估模型</li></ol><h2 id="1-思路和流程分析"><a href="#1-思路和流程分析" class="headerlink" title="1. 思路和流程分析"></a>1. 思路和流程分析</h2><p>流程：</p><ol><li>准备数据，这些需要准备DataLoader</li><li>构建模型，这里可以使用torch构造一个深层的神经网络</li><li>模型的训练</li><li>模型的保存，保存模型，后续持续使用</li><li>模型的评估，使用测试集，观察模型的好坏</li></ol><h2 id="2-准备训练集和测试集"><a href="#2-准备训练集和测试集" class="headerlink" title="2. 准备训练集和测试集"></a>2. 准备训练集和测试集</h2><p>准备数据集的方法前面已经讲过，但是通过前面的内容可知，调用MNIST返回的结果中图形数据是一个Image对象,需要对其进行处理</p><p>为了进行数据的处理，接下来学习<code>torchvision.transfroms</code>的方法</p><h3 id="2-1-torchvision-transforms的图形数据处理方法"><a href="#2-1-torchvision-transforms的图形数据处理方法" class="headerlink" title="2.1 torchvision.transforms的图形数据处理方法"></a>2.1 <code>torchvision.transforms</code>的图形数据处理方法</h3><h4 id="2-1-1-torchvision-transforms-ToTensor"><a href="#2-1-1-torchvision-transforms-ToTensor" class="headerlink" title="2.1.1 torchvision.transforms.ToTensor"></a>2.1.1 <code>torchvision.transforms.ToTensor</code></h4><p>把一个取值范围是<code>[0,255]</code>的<code>PIL.Image</code>或者<code>shape</code>为<code>(H,W,C)</code>的<code>numpy.ndarray</code>，转换成形状为<code>[C,H,W]</code></p><p>其中<code>(H,W,C)</code>意思为<code>(高，宽，通道数)</code>，黑白图片的通道数只有1，其中每个像素点的取值为[0,255],彩色图片的通道数为(R,G,B),每个通道的每个像素点的取值为[0,255]，三个通道的颜色相互叠加，形成了各种颜色</p><p>示例如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br>data = np.random.randint(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, size=<span class="hljs-number">12</span>)<br>img = data.reshape(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)<br><span class="hljs-built_in">print</span>(img.shape)<br>img_tensor = transforms.ToTensor()(img) <span class="hljs-comment"># 转换成tensor</span><br><span class="hljs-built_in">print</span>(img_tensor)<br><span class="hljs-built_in">print</span>(img_tensor.shape)<br></code></pre></td></tr></table></figure><p>输出如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">shape:(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br>img_tensor:tensor([[[<span class="hljs-number">215</span>, <span class="hljs-number">171</span>],<br>                 [ <span class="hljs-number">34</span>,  <span class="hljs-number">12</span>]],<br><br>                [[<span class="hljs-number">229</span>,  <span class="hljs-number">87</span>],<br>                 [ <span class="hljs-number">15</span>, <span class="hljs-number">237</span>]],<br><br>                [[ <span class="hljs-number">10</span>,  <span class="hljs-number">55</span>],<br>                 [ <span class="hljs-number">72</span>, <span class="hljs-number">204</span>]]], dtype=torch.int32)<br>new shape:torch.Size([<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>])<br><br></code></pre></td></tr></table></figure><p>注意：</p><p><code>transforms.ToTensor</code>对象中有<code>__call__</code>方法，所以可以对其示例能够传入数据获取结果</p><h4 id="2-1-2-torchvision-transforms-Normalize-mean-std"><a href="#2-1-2-torchvision-transforms-Normalize-mean-std" class="headerlink" title="2.1.2 torchvision.transforms.Normalize(mean, std)"></a>2.1.2 <code>torchvision.transforms.Normalize(mean, std)</code></h4><p>给定均值：mean，shape和图片的通道数相同(指的是每个通道的均值)，方差：std，和图片的通道数相同(指的是每个通道的方差)，将会把<code>Tensor</code>规范化处理。</p><p>即：<code>Normalized_image=(image-mean)/std</code>。</p><p>例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> torchvision<br><br>data = np.random.randint(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, size=<span class="hljs-number">12</span>)<br>img = data.reshape(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)<br>img = transforms.ToTensor()(img) <span class="hljs-comment"># 转换成tensor</span><br><span class="hljs-built_in">print</span>(img)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;*&quot;</span>*<span class="hljs-number">100</span>)<br><br>norm_img = transforms.Normalize((<span class="hljs-number">10</span>,<span class="hljs-number">10</span>,<span class="hljs-number">10</span>), (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))(img) <span class="hljs-comment">#进行规范化处理</span><br><br><span class="hljs-built_in">print</span>(norm_img)<br></code></pre></td></tr></table></figure><p>输出如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs lua">tensor(<span class="hljs-string">[[[177, 223],</span><br><span class="hljs-string">         [ 71, 182]]</span>,<br><br>        <span class="hljs-string">[[153, 120],</span><br><span class="hljs-string">         [173,  33]]</span>,<br><br>        <span class="hljs-string">[[162, 233],</span><br><span class="hljs-string">         [194,  73]]</span>], dtype=torch.int32)<br>***************************************************************************************<br>tensor(<span class="hljs-string">[[[167, 213],</span><br><span class="hljs-string">         [ 61, 172]]</span>,<br><br>        <span class="hljs-string">[[143, 110],</span><br><span class="hljs-string">         [163,  23]]</span>,<br><br>        <span class="hljs-string">[[152, 223],</span><br><span class="hljs-string">         [184,  63]]</span>], dtype=torch.int32)<br></code></pre></td></tr></table></figure><p>注意：在sklearn中，默认上式中的std和mean为数据每列的std和mean，sklearn会在标准化之前算出每一列的std和mean。</p><p>但是在api：Normalize中并没有帮我们计算，所以我们需要手动计算</p><ol><li><p>当mean为全部数据的均值，std为全部数据的std的时候，才是进行了标准化。</p></li><li><p>如果mean(x)不是全部数据的mean的时候，std(y)也不是的时候，Normalize后的数据分布满足下面的关系<br>$$<br>\begin{align*}<br>&amp;new_mean &#x3D; \frac{mean-x}{y}&amp;， mean为原数据的均值，x为传入的均值x \<br>&amp;new_std &#x3D; \frac{std}{y} &amp;，y为传入的标准差y\<br>\end{align*}<br>$$</p></li></ol><h4 id="2-1-3-torchvision-transforms-Compose-transforms"><a href="#2-1-3-torchvision-transforms-Compose-transforms" class="headerlink" title="2.1.3 torchvision.transforms.Compose(transforms)"></a>2.1.3 <code>torchvision.transforms.Compose(transforms)</code></h4><p>将多个<code>transform</code>组合起来使用。</p><p>例如</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">transforms.Compose([<br>     torchvision.transforms.ToTensor(), <span class="hljs-comment">#先转化为Tensor</span><br>     torchvision.transforms.Normalize(mean,std) <span class="hljs-comment">#在进行正则化</span><br> ])<br></code></pre></td></tr></table></figure><h3 id="2-2-准备MNIST数据集的Dataset和DataLoader"><a href="#2-2-准备MNIST数据集的Dataset和DataLoader" class="headerlink" title="2.2 准备MNIST数据集的Dataset和DataLoader"></a>2.2 准备MNIST数据集的Dataset和DataLoader</h3><p>准备训练集</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torchvision<br><br><span class="hljs-comment">#准备数据集，其中0.1307，0.3081为MNIST数据的均值和标准差，这样操作能够对其进行标准化</span><br><span class="hljs-comment">#因为MNIST只有一个通道（黑白图片）,所以元组中只有一个值</span><br>dataset = torchvision.datasets.MNIST(<span class="hljs-string">&#x27;/data&#x27;</span>, train=<span class="hljs-literal">True</span>, download=<span class="hljs-literal">True</span>,<br>                             transform=torchvision.transforms.Compose([<br>                               torchvision.transforms.ToTensor(),<br>                               torchvision.transforms.Normalize(<br>                                 (<span class="hljs-number">0.1307</span>,), (<span class="hljs-number">0.3081</span>,))<br>                             ]))<br><span class="hljs-comment">#准备数据迭代器                          </span><br>train_dataloader = torch.utils.data.DataLoader(dataset,batch_size=<span class="hljs-number">64</span>,shuffle=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p>准备测试集</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torchvision<br><br><span class="hljs-comment">#准备数据集，其中0.1307，0.3081为MNIST数据的均值和标准差，这样操作能够对其进行标准化</span><br><span class="hljs-comment">#因为MNIST只有一个通道（黑白图片）,所以元组中只有一个值</span><br>dataset = torchvision.datasets.MNIST(<span class="hljs-string">&#x27;/data&#x27;</span>, train=<span class="hljs-literal">False</span>, download=<span class="hljs-literal">True</span>,<br>                             transform=torchvision.transforms.Compose([<br>                               torchvision.transforms.ToTensor(),<br>                               torchvision.transforms.Normalize(<br>                                 (<span class="hljs-number">0.1307</span>,), (<span class="hljs-number">0.3081</span>,))<br>                             ]))<br><span class="hljs-comment">#准备数据迭代器                          </span><br>train_dataloader = torch.utils.data.DataLoader(dataset,batch_size=<span class="hljs-number">64</span>,shuffle=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><h2 id="3-构建模型"><a href="#3-构建模型" class="headerlink" title="3. 构建模型"></a>3. 构建模型</h2><p>补充：<strong>全连接层</strong>：当前一层的神经元和前一层的神经元相互链接，其核心操作就是$y &#x3D; wx$，即矩阵的乘法，实现对前一层的数据的变换</p><p>模型的构建使用了一个三层的神经网络，其中包括两个全连接层和一个输出层，第一个全连接层会经过激活函数的处理，将处理后的结果交给下一个全连接层，进行变换后输出结果</p><p>那么在这个模型中有两个地方需要注意：</p><ol><li>激活函数如何使用</li><li>每一层数据的形状</li><li>模型的损失函数</li></ol><h3 id="3-1-激活函数的使用"><a href="#3-1-激活函数的使用" class="headerlink" title="3.1 激活函数的使用"></a>3.1 激活函数的使用</h3><p>前面介绍了激活函数的作用，常用的激活函数为Relu激活函数，他的使用非常简单</p><p>Relu激活函数由<code>import torch.nn.functional as F</code>提供，<code>F.relu(x)</code>即可对x进行处理</p><p>例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">30</span>]: b<br>Out[<span class="hljs-number">30</span>]: tensor([-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>,  <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>])<br><br>In [<span class="hljs-number">31</span>]: <span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><br>In [<span class="hljs-number">32</span>]: F.relu(b)<br>Out[<span class="hljs-number">32</span>]: tensor([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>])<br></code></pre></td></tr></table></figure><h3 id="3-2-模型中数据的形状（【添加形状变化图形】）"><a href="#3-2-模型中数据的形状（【添加形状变化图形】）" class="headerlink" title="3.2  模型中数据的形状（【添加形状变化图形】）"></a>3.2  模型中数据的形状（【添加形状变化图形】）</h3><ol><li>原始输入数据为的形状:<code>[batch_size,1,28,28]</code></li><li>进行形状的修改：<code>[batch_size,28*28]</code> ,(全连接层是在进行矩阵的乘法操作)</li><li>第一个全连接层的输出形状：<code>[batch_size,28]</code>，这里的28是个人设定的，你也可以设置为别的</li><li>激活函数不会修改数据的形状</li><li>第二个全连接层的输出形状：<code>[batch_size,10]</code>,因为手写数字有10个类别</li></ol><p>构建模型的代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MnistNet</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(MnistNet,self).__init__()<br>        self.fc1 = nn.Linear(<span class="hljs-number">28</span>*<span class="hljs-number">28</span>*<span class="hljs-number">1</span>,<span class="hljs-number">28</span>)  <span class="hljs-comment">#定义Linear的输入和输出的形状</span><br>        self.fc2 = nn.Linear(<span class="hljs-number">28</span>,<span class="hljs-number">10</span>)  <span class="hljs-comment">#定义Linear的输入和输出的形状</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self,x</span>):<br>        x = x.view(-<span class="hljs-number">1</span>,<span class="hljs-number">28</span>*<span class="hljs-number">28</span>*<span class="hljs-number">1</span>)  <span class="hljs-comment">#对数据形状变形，-1表示该位置根据后面的形状自动调整</span><br>        x = self.fc1(x) <span class="hljs-comment">#[batch_size,28]</span><br>        x = F.relu(x)  <span class="hljs-comment">#[batch_size,28]</span><br>        x = self.fc2(x) <span class="hljs-comment">#[batch_size,10]</span><br>  <br></code></pre></td></tr></table></figure><p>可以发现：pytorch在构建模型的时候<code>形状上</code>并不会考虑<code>batch_size</code></p><h3 id="3-3-模型的损失函数"><a href="#3-3-模型的损失函数" class="headerlink" title="3.3 模型的损失函数"></a>3.3 模型的损失函数</h3><p>首先，我们需要明确，当前我们手写字体识别的问题是一个多分类的问题，所谓多分类对比的是之前学习的2分类</p><p>回顾之前的课程，我们在逻辑回归中，我们使用sigmoid进行计算对数似然损失，来定义我们的2分类的损失。</p><ul><li><p>在2分类中我们有正类和负类，正类的概率为$P(x) &#x3D;  \frac{1}{1+e^{-x}} &#x3D; \frac{e^x}{1+e^x}$,那么负类的概率为$1-P(x)$</p></li><li><p>将这个结果进行计算对数似然损失$-\sum y log(P(x))$就可以得到最终的损失</p></li></ul><p>那么在多分类的过程中我们应该怎么做呢？</p><ul><li><p>多分类和2分类中唯一的区别是我们不能够再使用sigmoid函数来计算当前样本属于某个类别的概率，而应该使用softmax函数。</p></li><li><p>softmax和sigmoid的区别在于我们需要去计算样本属于每个类别的概率，需要计算多次，而sigmoid只需要计算一次</p></li></ul><p>softmax的公式如下：<br>$$<br>\sigma(z)<em>j &#x3D; \frac{e^{z_j}}{\sum^K</em>{k&#x3D;1}e^{z_K}}  ,j&#x3D;1 \cdots k<br>$$</p><p>例如下图：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/softmax.png"></p><p>假如softmax之前的输出结果是<code>2.3, 4.1, 5.6</code>,那么经过softmax之后的结果是多少呢？<br>$$<br>Y1 &#x3D; \frac{e^{2.3}}{e^{2.3}+e^{4.1}+e^{5.6}} \<br>Y2 &#x3D; \frac{e^{4.1}}{e^{2.3}+e^{4.1}+e^{5.6}} \<br>Y3 &#x3D; \frac{e^{5.6}}{e^{2.3}+e^{4.1}+e^{5.6}} \<br>$$</p><p>对于这个softmax输出的结果，是在[0,1]区间，我们可以把它当做概率</p><p>和前面2分类的损失一样，多分类的损失只需要再把这个结果进行对数似然损失的计算即可</p><p>即：<br>$$<br>\begin{align*}<br>&amp; J &#x3D; -\sum Y log(P) &amp;, 其中 P &#x3D; \frac{e^{z_j}}{\sum^K_{k&#x3D;1}e^{z_K}} ,Y表示真实值<br>\end{align*}<br>$$<br>最后，会计算每个样本的损失，即上式的平均值</p><p>我们把softmax概率传入对数似然损失得到的损失函数称为<strong>交叉熵损失</strong></p><p>在pytorch中有两种方法实现交叉熵损失</p><ol><li>&#96;&#96;&#96;<br>criterion &#x3D; nn.CrossEntropyLoss()<br>loss &#x3D; criterion(input,target)<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><br><span class="hljs-number">2.</span> ```<br>   #<span class="hljs-number">1.</span> 对输出值计算softmax和取对数<br>   output = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">F</span>.</span></span>log<span class="hljs-constructor">_softmax(<span class="hljs-params">x</span>,<span class="hljs-params">dim</span>=-1)</span><br>   #<span class="hljs-number">2.</span> 使用torch中带权损失<br>   loss = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">F</span>.</span></span>nll<span class="hljs-constructor">_loss(<span class="hljs-params">output</span>,<span class="hljs-params">target</span>)</span><br></code></pre></td></tr></table></figure></li></ol><p>带权损失定义为：$l_n &#x3D; -\sum w_{i} x_{i}$，其实就是把$log(P)$作为$x_i$,把真实值Y作为权重</p><h2 id="4-模型的训练"><a href="#4-模型的训练" class="headerlink" title="4. 模型的训练"></a>4. 模型的训练</h2><p>训练的流程：</p><ol><li>实例化模型，设置模型为训练模式</li><li>实例化优化器类，实例化损失函数</li><li>获取，遍历dataloader</li><li>梯度置为0</li><li>进行向前计算</li><li>计算损失</li><li>反向传播</li><li>更新参数</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">mnist_net = MnistNet()<br>optimizer = optim.Adam(mnist_net.parameters(),lr= <span class="hljs-number">0.001</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">epoch</span>):<br>    mode = <span class="hljs-literal">True</span><br>    mnist_net.train(mode=mode) <span class="hljs-comment">#模型设置为训练模型</span><br>    <br>    train_dataloader = get_dataloader(train=mode) <span class="hljs-comment">#获取训练数据集</span><br>    <span class="hljs-keyword">for</span> idx,(data,target) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_dataloader):<br>        optimizer.zero_grad() <span class="hljs-comment">#梯度置为0</span><br>        output = mnist_net(data) <span class="hljs-comment">#进行向前计算</span><br>        loss = F.nll_loss(output,target) <span class="hljs-comment">#带权损失</span><br>        loss.backward()  <span class="hljs-comment">#进行反向传播，计算梯度</span><br>        optimizer.step() <span class="hljs-comment">#参数更新</span><br>        <span class="hljs-keyword">if</span> idx % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Train Epoch: &#123;&#125; [&#123;&#125;/&#123;&#125; (&#123;:.0f&#125;%)]\tLoss: &#123;:.6f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<br>                epoch, idx * <span class="hljs-built_in">len</span>(data), <span class="hljs-built_in">len</span>(train_dataloader.dataset),<br>                       <span class="hljs-number">100.</span> * idx / <span class="hljs-built_in">len</span>(train_dataloader), loss.item()))<br></code></pre></td></tr></table></figure><h2 id="5-模型的保存和加载"><a href="#5-模型的保存和加载" class="headerlink" title="5. 模型的保存和加载"></a>5. 模型的保存和加载</h2><h3 id="5-1-模型的保存"><a href="#5-1-模型的保存" class="headerlink" title="5.1 模型的保存"></a>5.1 模型的保存</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">torch.save(mnist_net.state_dict(),<span class="hljs-string">&quot;model/mnist_net.pt&quot;</span>) <span class="hljs-comment">#保存模型参数</span><br>torch.save(optimizer.state_dict(), <span class="hljs-string">&#x27;results/mnist_optimizer.pt&#x27;</span>) <span class="hljs-comment">#保存优化器参数</span><br></code></pre></td></tr></table></figure><h3 id="5-2-模型的加载"><a href="#5-2-模型的加载" class="headerlink" title="5.2 模型的加载"></a>5.2 模型的加载</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">mnist_net.load_state_dict(torch.load(<span class="hljs-string">&quot;model/mnist_net.pt&quot;</span>))<br>optimizer.load_state_dict(torch.load(<span class="hljs-string">&quot;results/mnist_optimizer.pt&quot;</span>))<br></code></pre></td></tr></table></figure><h2 id="6-模型的评估"><a href="#6-模型的评估" class="headerlink" title="6. 模型的评估"></a>6. 模型的评估</h2><p>评估的过程和训练的过程相似，但是：</p><ol><li>不需要计算梯度</li><li>需要收集损失和准确率，用来计算平均损失和平均准确率</li><li>损失的计算和训练时候损失的计算方法相同</li><li>准确率的计算：<ul><li>模型的输出为[batch_size,10]的形状</li><li>其中最大值的位置就是其预测的目标值（预测值进行过sotfmax后为概率，sotfmax中分母都是相同的，分子越大，概率越大）</li><li>最大值的位置获取的方法可以使用<code>torch.max</code>,返回最大值和最大值的位置</li><li>返回最大值的位置后，和真实值（<code>[batch_size]</code>）进行对比，相同表示预测成功</li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>():<br>    test_loss = <span class="hljs-number">0</span><br>    correct = <span class="hljs-number">0</span><br>    mnist_net.<span class="hljs-built_in">eval</span>()  <span class="hljs-comment">#设置模型为评估模式</span><br>    test_dataloader = get_dataloader(train=<span class="hljs-literal">False</span>) <span class="hljs-comment">#获取评估数据集</span><br>    <span class="hljs-keyword">with</span> torch.no_grad(): <span class="hljs-comment">#不计算其梯度</span><br>        <span class="hljs-keyword">for</span> data, target <span class="hljs-keyword">in</span> test_dataloader:<br>            output = mnist_net(data)<br>            test_loss += F.nll_loss(output, target, reduction=<span class="hljs-string">&#x27;sum&#x27;</span>).item()<br>            pred = output.data.<span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>)[<span class="hljs-number">1</span>] <span class="hljs-comment">#获取最大值的位置,[batch_size,1]</span><br>            correct += pred.eq(target.data.view_as(pred)).<span class="hljs-built_in">sum</span>()  <span class="hljs-comment">#预测准备样本数累加</span><br>    test_loss /= <span class="hljs-built_in">len</span>(test_dataloader.dataset) <span class="hljs-comment">#计算平均损失</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\nTest set: Avg. loss: &#123;:.4f&#125;, Accuracy: &#123;&#125;/&#123;&#125; (&#123;:.2f&#125;%)\n&#x27;</span>.<span class="hljs-built_in">format</span>(<br>        test_loss, correct, <span class="hljs-built_in">len</span>(test_dataloader.dataset),<br>        <span class="hljs-number">100.</span> * correct / <span class="hljs-built_in">len</span>(test_dataloader.dataset)))<br></code></pre></td></tr></table></figure><h2 id="7-完整的代码如下："><a href="#7-完整的代码如下：" class="headerlink" title="7. 完整的代码如下："></a>7. 完整的代码如下：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> optim<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><span class="hljs-keyword">import</span> torchvision<br><br>train_batch_size = <span class="hljs-number">64</span><br>test_batch_size = <span class="hljs-number">1000</span><br>img_size = <span class="hljs-number">28</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_dataloader</span>(<span class="hljs-params">train=<span class="hljs-literal">True</span></span>):<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(train,<span class="hljs-built_in">bool</span>),<span class="hljs-string">&quot;train 必须是bool类型&quot;</span><br><br>    <span class="hljs-comment">#准备数据集，其中0.1307，0.3081为MNIST数据的均值和标准差，这样操作能够对其进行标准化</span><br>    <span class="hljs-comment">#因为MNIST只有一个通道（黑白图片）,所以元组中只有一个值</span><br>    dataset = torchvision.datasets.MNIST(<span class="hljs-string">&#x27;/data&#x27;</span>, train=train, download=<span class="hljs-literal">True</span>,<br>                                         transform=torchvision.transforms.Compose([<br>                                         torchvision.transforms.ToTensor(),<br>                                         torchvision.transforms.Normalize((<span class="hljs-number">0.1307</span>,), (<span class="hljs-number">0.3081</span>,)),]))<br>    <span class="hljs-comment">#准备数据迭代器</span><br>    batch_size = train_batch_size <span class="hljs-keyword">if</span> train <span class="hljs-keyword">else</span> test_batch_size<br>    dataloader = torch.utils.data.DataLoader(dataset,batch_size=batch_size,shuffle=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">return</span> dataloader<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MnistNet</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(MnistNet,self).__init__()<br>        self.fc1 = nn.Linear(<span class="hljs-number">28</span>*<span class="hljs-number">28</span>*<span class="hljs-number">1</span>,<span class="hljs-number">28</span>)<br>        self.fc2 = nn.Linear(<span class="hljs-number">28</span>,<span class="hljs-number">10</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self,x</span>):<br>        x = x.view(-<span class="hljs-number">1</span>,<span class="hljs-number">28</span>*<span class="hljs-number">28</span>*<span class="hljs-number">1</span>)<br>        x = self.fc1(x) <span class="hljs-comment">#[batch_size,28]</span><br>        x = F.relu(x)  <span class="hljs-comment">#[batch_size,28]</span><br>        x = self.fc2(x) <span class="hljs-comment">#[batch_size,10]</span><br>        <span class="hljs-comment"># return x</span><br>        <span class="hljs-keyword">return</span> F.log_softmax(x,dim=-<span class="hljs-number">1</span>)<br><br>mnist_net = MnistNet()<br>optimizer = optim.Adam(mnist_net.parameters(),lr= <span class="hljs-number">0.001</span>)<br><span class="hljs-comment"># criterion = nn.NLLLoss()</span><br><span class="hljs-comment"># criterion = nn.CrossEntropyLoss()</span><br>train_loss_list = []<br>train_count_list = []<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">epoch</span>):<br>    mode = <span class="hljs-literal">True</span><br>    mnist_net.train(mode=mode)<br>    train_dataloader = get_dataloader(train=mode)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(train_dataloader.dataset))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(train_dataloader))<br>    <span class="hljs-keyword">for</span> idx,(data,target) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_dataloader):<br>        optimizer.zero_grad()<br>        output = mnist_net(data)<br>        loss = F.nll_loss(output,target) <span class="hljs-comment">#对数似然损失</span><br>        loss.backward()<br>        optimizer.step()<br>        <span class="hljs-keyword">if</span> idx % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Train Epoch: &#123;&#125; [&#123;&#125;/&#123;&#125; (&#123;:.0f&#125;%)]\tLoss: &#123;:.6f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<br>                epoch, idx * <span class="hljs-built_in">len</span>(data), <span class="hljs-built_in">len</span>(train_dataloader.dataset),<br>                       <span class="hljs-number">100.</span> * idx / <span class="hljs-built_in">len</span>(train_dataloader), loss.item()))<br><br>            train_loss_list.append(loss.item())<br>            train_count_list.append(idx*train_batch_size+(epoch-<span class="hljs-number">1</span>)*<span class="hljs-built_in">len</span>(train_dataloader))<br>            torch.save(mnist_net.state_dict(),<span class="hljs-string">&quot;model/mnist_net.pkl&quot;</span>)<br>            torch.save(optimizer.state_dict(), <span class="hljs-string">&#x27;results/mnist_optimizer.pkl&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>():<br>    test_loss = <span class="hljs-number">0</span><br>    correct = <span class="hljs-number">0</span><br>    mnist_net.<span class="hljs-built_in">eval</span>()<br>    test_dataloader = get_dataloader(train=<span class="hljs-literal">False</span>)<br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        <span class="hljs-keyword">for</span> data, target <span class="hljs-keyword">in</span> test_dataloader:<br>            output = mnist_net(data)<br>            test_loss += F.nll_loss(output, target, reduction=<span class="hljs-string">&#x27;sum&#x27;</span>).item()<br>            pred = output.data.<span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>)[<span class="hljs-number">1</span>] <span class="hljs-comment">#获取最大值的位置,[batch_size,1]</span><br>            correct += pred.eq(target.data.view_as(pred)).<span class="hljs-built_in">sum</span>()<br>    test_loss /= <span class="hljs-built_in">len</span>(test_dataloader.dataset)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\nTest set: Avg. loss: &#123;:.4f&#125;, Accuracy: &#123;&#125;/&#123;&#125; (&#123;:.2f&#125;%)\n&#x27;</span>.<span class="hljs-built_in">format</span>(<br>        test_loss, correct, <span class="hljs-built_in">len</span>(test_dataloader.dataset),<br>        <span class="hljs-number">100.</span> * correct / <span class="hljs-built_in">len</span>(test_dataloader.dataset)))<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br><br>    test()  <br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>): <span class="hljs-comment">#模型训练5轮</span><br>        train(i)<br>        test()<br></code></pre></td></tr></table></figure><h1 id="循环神经网络和自然语言处理介绍"><a href="#循环神经网络和自然语言处理介绍" class="headerlink" title="循环神经网络和自然语言处理介绍"></a>循环神经网络和自然语言处理介绍</h1><h2 id="目标-7"><a href="#目标-7" class="headerlink" title="目标"></a>目标</h2><ol><li>知道<code>token</code>和<code>tokenization</code></li><li>知道<code>N-gram</code>的概念和作用</li><li>知道文本向量化表示的方法</li></ol><h2 id="1-文本的tokenization"><a href="#1-文本的tokenization" class="headerlink" title="1. 文本的tokenization"></a>1. 文本的<code>tokenization</code></h2><h3 id="1-1-概念和工具的介绍"><a href="#1-1-概念和工具的介绍" class="headerlink" title="1.1 概念和工具的介绍"></a>1.1 概念和工具的介绍</h3><p><code>tokenization</code>就是通常所说的分词，分出的每一个词语我们把它称为<code>token</code>。</p><p>常见的分词工具很多，比如：</p><ul><li><code>jieba分词：https://github.com/fxsjy/jieba</code></li><li>清华大学的分词工具THULAC：<code>https://github.com/thunlp/THULAC-Python</code></li></ul><h3 id="1-2-中英文分词的方法"><a href="#1-2-中英文分词的方法" class="headerlink" title="1.2 中英文分词的方法"></a>1.2 中英文分词的方法</h3><ul><li>把句子转化为词语<ul><li>比如：<code>我爱深度学习</code> 可以分为<code>[我，爱， 深度学习]</code></li></ul></li><li>把句子转化为单个字<ul><li>比如：<code>我爱深度学习</code>的token是<code>[我，爱，深，度，学，习]</code></li></ul></li></ul><h2 id="2-N-garm表示方法"><a href="#2-N-garm表示方法" class="headerlink" title="2. N-garm表示方法"></a>2. <code>N-garm</code>表示方法</h2><p>前面我们说，句子可以用但个字，词来表示，但是有的时候，我们可以用2个、3个或者多个词来表示。</p><p><code>N-gram</code>一组一组的词语，其中的<code>N</code>表示能够被一起使用的词的数量</p><p>例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">59</span>]: text = <span class="hljs-string">&quot;深度学习（英语：deep learning）是机器学习的分支，是一种以人工神经网络为架构，对数据进行表征学习的算法。&quot;</span><br><br>In [<span class="hljs-number">60</span>]: cuted = jieba.lcut(text)<br><br>In [<span class="hljs-number">61</span>]: [cuted[i:i+<span class="hljs-number">2</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(cuted)-<span class="hljs-number">1</span>)] <span class="hljs-comment">#N-gram 中n=2时</span><br>Out[<span class="hljs-number">61</span>]:[[<span class="hljs-string">&#x27;深度&#x27;</span>, <span class="hljs-string">&#x27;学习&#x27;</span>],<br> [<span class="hljs-string">&#x27;学习&#x27;</span>, <span class="hljs-string">&#x27;（&#x27;</span>],<br> [<span class="hljs-string">&#x27;（&#x27;</span>, <span class="hljs-string">&#x27;英语&#x27;</span>],<br> [<span class="hljs-string">&#x27;英语&#x27;</span>, <span class="hljs-string">&#x27;：&#x27;</span>],<br> [<span class="hljs-string">&#x27;：&#x27;</span>, <span class="hljs-string">&#x27;deep&#x27;</span>],<br> [<span class="hljs-string">&#x27;deep&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>],<br> [<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-string">&#x27;learning&#x27;</span>],<br> [<span class="hljs-string">&#x27;learning&#x27;</span>, <span class="hljs-string">&#x27;）&#x27;</span>],<br> [<span class="hljs-string">&#x27;）&#x27;</span>, <span class="hljs-string">&#x27;是&#x27;</span>],<br> [<span class="hljs-string">&#x27;是&#x27;</span>, <span class="hljs-string">&#x27;机器&#x27;</span>],<br> [<span class="hljs-string">&#x27;机器&#x27;</span>, <span class="hljs-string">&#x27;学习&#x27;</span>],<br> [<span class="hljs-string">&#x27;学习&#x27;</span>, <span class="hljs-string">&#x27;的&#x27;</span>],<br> [<span class="hljs-string">&#x27;的&#x27;</span>, <span class="hljs-string">&#x27;分支&#x27;</span>],<br> [<span class="hljs-string">&#x27;分支&#x27;</span>, <span class="hljs-string">&#x27;，&#x27;</span>],<br> [<span class="hljs-string">&#x27;，&#x27;</span>, <span class="hljs-string">&#x27;是&#x27;</span>],<br> [<span class="hljs-string">&#x27;是&#x27;</span>, <span class="hljs-string">&#x27;一种&#x27;</span>],<br> [<span class="hljs-string">&#x27;一种&#x27;</span>, <span class="hljs-string">&#x27;以&#x27;</span>],<br> [<span class="hljs-string">&#x27;以&#x27;</span>, <span class="hljs-string">&#x27;人工神经网络&#x27;</span>],<br> [<span class="hljs-string">&#x27;人工神经网络&#x27;</span>, <span class="hljs-string">&#x27;为&#x27;</span>],<br> [<span class="hljs-string">&#x27;为&#x27;</span>, <span class="hljs-string">&#x27;架构&#x27;</span>],<br> [<span class="hljs-string">&#x27;架构&#x27;</span>, <span class="hljs-string">&#x27;，&#x27;</span>],<br> [<span class="hljs-string">&#x27;，&#x27;</span>, <span class="hljs-string">&#x27;对&#x27;</span>],<br> [<span class="hljs-string">&#x27;对&#x27;</span>, <span class="hljs-string">&#x27;数据&#x27;</span>],<br> [<span class="hljs-string">&#x27;数据&#x27;</span>, <span class="hljs-string">&#x27;进行&#x27;</span>],<br> [<span class="hljs-string">&#x27;进行&#x27;</span>, <span class="hljs-string">&#x27;表征&#x27;</span>],<br> [<span class="hljs-string">&#x27;表征&#x27;</span>, <span class="hljs-string">&#x27;学习&#x27;</span>],<br> [<span class="hljs-string">&#x27;学习&#x27;</span>, <span class="hljs-string">&#x27;的&#x27;</span>],<br> [<span class="hljs-string">&#x27;的&#x27;</span>, <span class="hljs-string">&#x27;算法&#x27;</span>],<br> [<span class="hljs-string">&#x27;算法&#x27;</span>, <span class="hljs-string">&#x27;。&#x27;</span>]]<br></code></pre></td></tr></table></figure><p>在传统的机器学习中，使用N-gram方法往往能够取得非常好的效果，但是在深度学习比如RNN中会自带N-gram的效果。</p><h2 id="3-向量化"><a href="#3-向量化" class="headerlink" title="3. 向量化"></a>3. 向量化</h2><p>因为文本不能够直接被模型计算，所以需要将其转化为向量</p><p>把文本转化为向量有两种方法：</p><ol><li>转化为one-hot编码</li><li>转化为word embedding</li></ol><h3 id="3-1-one-hot-编码"><a href="#3-1-one-hot-编码" class="headerlink" title="3.1 one-hot 编码"></a>3.1 one-hot 编码</h3><p>在one-hot编码中，每一个token使用一个长度为N的向量表示，N表示词典的数量</p><p>即：把待处理的文档进行分词或者是N-gram处理，然后进行去重得到词典，假设我们有一个文档：<code>深度学习</code>，那么进行one-hot处理后的结果如下：</p><table><thead><tr><th>token</th><th>one-hot encoding</th></tr></thead><tbody><tr><td>深</td><td>1000</td></tr><tr><td>度</td><td>0100</td></tr><tr><td>学</td><td>0010</td></tr><tr><td>习</td><td>0001</td></tr></tbody></table><h3 id="3-2-word-embedding"><a href="#3-2-word-embedding" class="headerlink" title="3.2 word embedding"></a>3.2 word embedding</h3><p>word embedding是深度学习中表示文本常用的一种方法。和one-hot编码不同，word embedding使用了浮点型的稠密矩阵来表示token。根据词典的大小，我们的向量通常使用不同的维度，例如100,256,300等。其中向量中的每一个值是一个参数，其初始值是随机生成的，之后会在训练的过程中进行学习而获得。</p><p>如果我们文本中有20000个词语，如果使用one-hot编码，那么我们会有20000*20000的矩阵，其中大多数的位置都为0，但是如果我们使用word embedding来表示的话，只需要20000* 维度，比如20000*300</p><p>形象的表示就是：</p><table><thead><tr><th>token</th><th>num</th><th>vector</th></tr></thead><tbody><tr><td>词1</td><td>0</td><td><code>[w11,w12,w13...w1N]</code> ,其中N表示维度（dimension）</td></tr><tr><td>词2</td><td>1</td><td><code>[w21,w22,w23...w2N] </code></td></tr><tr><td>词3</td><td>2</td><td><code>[w31,w23,w33...w3N] </code></td></tr><tr><td>…</td><td>….</td><td>…</td></tr><tr><td>词m</td><td>m</td><td><code>[wm1,wm2,wm3...wmN]</code>,其中m表示词典的大小</td></tr></tbody></table><p>我们会把所有的文本转化为向量，把句子用向量来表示</p><p>但是在这中间，<strong>我们会先把token使用数字来表示，再把数字使用向量来表示。</strong></p><p>即：<code>token---&gt; num ----&gt;vector</code></p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/word_embedding.png"></p><h3 id="3-3-word-embedding-API"><a href="#3-3-word-embedding-API" class="headerlink" title="3.3 word embedding API"></a>3.3 word embedding API</h3><p><code>torch.nn.Embedding(num_embeddings,embedding_dim)</code></p><p>参数介绍：</p><ol><li><code>num_embeddings</code>：词典的大小</li><li><code>embedding_dim</code>：embedding的维度</li></ol><p>使用方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">embedding = nn.Embedding(vocab_size,<span class="hljs-number">300</span>) <span class="hljs-comment">#实例化</span><br>input_embeded = embedding(<span class="hljs-built_in">input</span>)         <span class="hljs-comment">#进行embedding的操作</span><br></code></pre></td></tr></table></figure><h3 id="3-4-数据的形状变化"><a href="#3-4-数据的形状变化" class="headerlink" title="3.4 数据的形状变化"></a>3.4 数据的形状变化</h3><p>思考：每个batch中的每个句子有10个词语，经过形状为[20，4]的Word emebedding之后，原来的句子会变成什么形状？</p><p>每个词语用长度为4的向量表示，所以，最终句子会变为<code>[batch_size,10,4]</code>的形状。</p><p>增加了一个维度，这个维度是embedding的dim</p><h1 id="文本情感分类"><a href="#文本情感分类" class="headerlink" title="文本情感分类"></a>文本情感分类</h1><h2 id="目标-8"><a href="#目标-8" class="headerlink" title="目标"></a>目标</h2><ol><li>知道文本处理的基本方法</li><li>能够使用数据实现情感分类的</li></ol><h2 id="1-案例介绍"><a href="#1-案例介绍" class="headerlink" title="1. 案例介绍"></a>1. 案例介绍</h2><p>为了对前面的word embedding这种常用的文本向量化的方法进行巩固，这里我们会完成一个文本情感分类的案例</p><p>现在我们有一个经典的数据集<code>IMDB</code>数据集，地址：<code>http://ai.stanford.edu/~amaas/data/sentiment/</code>，这是一份包含了5万条流行电影的评论数据，其中训练集25000条，测试集25000条。数据格式如下：</p><p>下图左边为名称，其中名称包含两部分，分别是序号和情感评分，（1-4为neg，5-10为pos），右边为评论内容</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%A0%B7%E6%9C%AC%E5%90%8D%E7%A7%B0.png"></p><p>根据上述的样本，需要使用pytorch完成模型，实现对评论情感进行预测</p><h2 id="2-思路分析"><a href="#2-思路分析" class="headerlink" title="2. 思路分析"></a>2. 思路分析</h2><p>首先可以把上述问题定义为分类问题，情感评分分为1-10，10个类别（也可以理解为回归问题，这里当做分类问题考虑）。那么根据之前的经验，我们的大致流程如下：</p><ol><li>准备数据集</li><li>构建模型</li><li>模型训练</li><li>模型评估</li></ol><p>知道思路之后，那么我们一步步来完成上述步骤</p><h2 id="3-准备数据集"><a href="#3-准备数据集" class="headerlink" title="3. 准备数据集"></a>3. 准备数据集</h2><p>准备数据集和之前的方法一样，实例化dataset，准备dataloader，最终我们的数据可以处理成如下格式：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%83%85%E6%84%9F%E5%88%86%E7%B1%BB-data%E5%8A%A0%E8%BD%BD1.png"></p><p>其中有两点需要注意：</p><ol><li>如何完成基础打Dataset的构建和Dataloader的准备</li><li>每个batch中文本的长度不一致的问题如何解决</li><li>每个batch中的文本如何转化为数字序列</li></ol><h3 id="3-1-基础Dataset的准备"><a href="#3-1-基础Dataset的准备" class="headerlink" title="3.1 基础Dataset的准备"></a>3.1 基础Dataset的准备</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> DataLoader,Dataset<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> re<br><br>data_base_path = <span class="hljs-string">r&quot;data\aclImdb&quot;</span><br><br><span class="hljs-comment">#1. 定义tokenize的方法</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">tokenize</span>(<span class="hljs-params">text</span>):<br>    <span class="hljs-comment"># fileters = &#x27;!&quot;#$%&amp;()*+,-./:;&lt;=&gt;?@[\\]^_`&#123;|&#125;~\t\n&#x27;</span><br>    fileters = [<span class="hljs-string">&#x27;!&#x27;</span>,<span class="hljs-string">&#x27;&quot;&#x27;</span>,<span class="hljs-string">&#x27;#&#x27;</span>,<span class="hljs-string">&#x27;$&#x27;</span>,<span class="hljs-string">&#x27;%&#x27;</span>,<span class="hljs-string">&#x27;&amp;&#x27;</span>,<span class="hljs-string">&#x27;\(&#x27;</span>,<span class="hljs-string">&#x27;\)&#x27;</span>,<span class="hljs-string">&#x27;\*&#x27;</span>,<span class="hljs-string">&#x27;\+&#x27;</span>,<span class="hljs-string">&#x27;,&#x27;</span>,<span class="hljs-string">&#x27;-&#x27;</span>,<span class="hljs-string">&#x27;\.&#x27;</span>,<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-string">&#x27;;&#x27;</span>,<span class="hljs-string">&#x27;&lt;&#x27;</span>,<span class="hljs-string">&#x27;=&#x27;</span>,<span class="hljs-string">&#x27;&gt;&#x27;</span>,<span class="hljs-string">&#x27;\?&#x27;</span>,<span class="hljs-string">&#x27;@&#x27;</span><br>        ,<span class="hljs-string">&#x27;\[&#x27;</span>,<span class="hljs-string">&#x27;\\&#x27;</span>,<span class="hljs-string">&#x27;\]&#x27;</span>,<span class="hljs-string">&#x27;^&#x27;</span>,<span class="hljs-string">&#x27;_&#x27;</span>,<span class="hljs-string">&#x27;`&#x27;</span>,<span class="hljs-string">&#x27;\&#123;&#x27;</span>,<span class="hljs-string">&#x27;\|&#x27;</span>,<span class="hljs-string">&#x27;\&#125;&#x27;</span>,<span class="hljs-string">&#x27;~&#x27;</span>,<span class="hljs-string">&#x27;\t&#x27;</span>,<span class="hljs-string">&#x27;\n&#x27;</span>,<span class="hljs-string">&#x27;\x97&#x27;</span>,<span class="hljs-string">&#x27;\x96&#x27;</span>,<span class="hljs-string">&#x27;”&#x27;</span>,<span class="hljs-string">&#x27;“&#x27;</span>,]<br>    text = re.sub(<span class="hljs-string">&quot;&lt;.*?&gt;&quot;</span>,<span class="hljs-string">&quot; &quot;</span>,text,flags=re.S)<br>    text = re.sub(<span class="hljs-string">&quot;|&quot;</span>.join(fileters),<span class="hljs-string">&quot; &quot;</span>,text,flags=re.S)<br>    <span class="hljs-keyword">return</span> [i.strip() <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> text.split()]<br><br><span class="hljs-comment">#2. 准备dataset</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ImdbDataset</span>(<span class="hljs-title class_ inherited__">Dataset</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,mode</span>):<br>        <span class="hljs-built_in">super</span>(ImdbDataset,self).__init__()<br>        <span class="hljs-keyword">if</span> mode==<span class="hljs-string">&quot;train&quot;</span>:<br>            text_path = [os.path.join(data_base_path,i)  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-string">&quot;train/neg&quot;</span>,<span class="hljs-string">&quot;train/pos&quot;</span>]]<br>        <span class="hljs-keyword">else</span>:<br>            text_path =  [os.path.join(data_base_path,i)  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-string">&quot;test/neg&quot;</span>,<span class="hljs-string">&quot;test/pos&quot;</span>]]<br><br>        self.total_file_path_list = []<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> text_path:<br>            self.total_file_path_list.extend([os.path.join(i,j) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> os.listdir(i)])<br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):<br>        cur_path = self.total_file_path_list[idx]<br><br>        cur_filename = os.path.basename(cur_path)<br>        label = <span class="hljs-built_in">int</span>(cur_filename.split(<span class="hljs-string">&quot;_&quot;</span>)[-<span class="hljs-number">1</span>].split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">0</span>]) -<span class="hljs-number">1</span> <span class="hljs-comment">#处理标题，获取label，转化为从[0-9]</span><br>        text = tokenize(<span class="hljs-built_in">open</span>(cur_path).read().strip()) <span class="hljs-comment">#直接按照空格进行分词</span><br>        <span class="hljs-keyword">return</span> label,text<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.total_file_path_list)<br>    <br> <span class="hljs-comment"># 2. 实例化，准备dataloader</span><br>dataset = ImdbDataset(mode=<span class="hljs-string">&quot;train&quot;</span>)<br>dataloader = DataLoader(dataset=dataset,batch_size=<span class="hljs-number">2</span>,shuffle=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment">#3. 观察数据输出结果</span><br><span class="hljs-keyword">for</span> idx,(label,text) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(dataloader):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;idx：&quot;</span>,idx)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;table:&quot;</span>,label)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;text:&quot;</span>,text)<br>    <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p>输出如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">idx： <span class="hljs-number">0</span><br>table: tensor([<span class="hljs-number">3</span>, <span class="hljs-number">1</span>])<br>text: [(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-string">&#x27;Want&#x27;</span>), (<span class="hljs-string">&#x27;thought&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>), (<span class="hljs-string">&#x27;this&#x27;</span>, <span class="hljs-string">&#x27;great&#x27;</span>), (<span class="hljs-string">&#x27;was&#x27;</span>, <span class="hljs-string">&#x27;recipe&#x27;</span>), (<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;for&#x27;</span>), (<span class="hljs-string">&#x27;great&#x27;</span>, <span class="hljs-string">&#x27;failure&#x27;</span>), (<span class="hljs-string">&#x27;idea&#x27;</span>, <span class="hljs-string">&#x27;Take&#x27;</span>), (<span class="hljs-string">&#x27;but&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>), (<span class="hljs-string">&#x27;boy&#x27;</span>, <span class="hljs-string">&#x27;s&#x27;</span>), (<span class="hljs-string">&#x27;was&#x27;</span>, <span class="hljs-string">&#x27;y&#x27;</span>), (<span class="hljs-string">&#x27;it&#x27;</span>, <span class="hljs-string">&#x27;plot&#x27;</span>), (<span class="hljs-string">&#x27;poorly&#x27;</span>, <span class="hljs-string">&#x27;add&#x27;</span>), (<span class="hljs-string">&#x27;executed&#x27;</span>, <span class="hljs-string">&#x27;in&#x27;</span>), (<span class="hljs-string">&#x27;We&#x27;</span>, <span class="hljs-string">&#x27;some&#x27;</span>), (<span class="hljs-string">&#x27;do&#x27;</span>, <span class="hljs-string">&#x27;weak&#x27;</span>), (<span class="hljs-string">&#x27;get&#x27;</span>, <span class="hljs-string">&#x27;completely&#x27;</span>), (<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;undeveloped&#x27;</span>), (<span class="hljs-string">&#x27;broad&#x27;</span>, <span class="hljs-string">&#x27;characters&#x27;</span>), (<span class="hljs-string">&#x27;sense&#x27;</span>, <span class="hljs-string">&#x27;and&#x27;</span>), (<span class="hljs-string">&#x27;of&#x27;</span>, <span class="hljs-string">&#x27;than&#x27;</span>), (<span class="hljs-string">&#x27;how&#x27;</span>, <span class="hljs-string">&#x27;throw&#x27;</span>), (<span class="hljs-string">&#x27;complex&#x27;</span>, <span class="hljs-string">&#x27;in&#x27;</span>), (<span class="hljs-string">&#x27;and&#x27;</span>, <span class="hljs-string">&#x27;the&#x27;</span>), (<span class="hljs-string">&#x27;challenging&#x27;</span>, <span class="hljs-string">&#x27;worst&#x27;</span>), (<span class="hljs-string">&#x27;the&#x27;</span>, <span class="hljs-string">&#x27;special&#x27;</span>), (<span class="hljs-string">&#x27;backstage&#x27;</span>, <span class="hljs-string">&#x27;effects&#x27;</span>), (<span class="hljs-string">&#x27;operations&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>), (<span class="hljs-string">&#x27;of&#x27;</span>, <span class="hljs-string">&#x27;horror&#x27;</span>), (<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;movie&#x27;</span>), (<span class="hljs-string">&#x27;show&#x27;</span>, <span class="hljs-string">&#x27;has&#x27;</span>), (<span class="hljs-string">&#x27;are&#x27;</span>, <span class="hljs-string">&#x27;known&#x27;</span>), (<span class="hljs-string">&#x27;but&#x27;</span>, <span class="hljs-string">&#x27;Let&#x27;</span>), (<span class="hljs-string">&#x27;virtually&#x27;</span>, <span class="hljs-string">&#x27;stew&#x27;</span>), (<span class="hljs-string">&#x27;no&#x27;</span>, <span class="hljs-string">&#x27;for&#x27;</span>), ...(<span class="hljs-string">&#x27;show&#x27;</span>, <span class="hljs-string">&#x27;somehow&#x27;</span>), (<span class="hljs-string">&#x27;rather&#x27;</span>, <span class="hljs-string">&#x27;destroy&#x27;</span>), (<span class="hljs-string">&#x27;than&#x27;</span>, <span class="hljs-string">&#x27;every&#x27;</span>), (<span class="hljs-string">&#x27;anything&#x27;</span>, <span class="hljs-string">&#x27;copy&#x27;</span>), (<span class="hljs-string">&#x27;worth&#x27;</span>, <span class="hljs-string">&#x27;of&#x27;</span>), (<span class="hljs-string">&#x27;watching&#x27;</span>, <span class="hljs-string">&#x27;this&#x27;</span>), (<span class="hljs-string">&#x27;for&#x27;</span>, <span class="hljs-string">&#x27;film&#x27;</span>), (<span class="hljs-string">&#x27;its&#x27;</span>, <span class="hljs-string">&#x27;so&#x27;</span>), (<span class="hljs-string">&#x27;own&#x27;</span>, <span class="hljs-string">&#x27;it&#x27;</span>), (<span class="hljs-string">&#x27;merit&#x27;</span>, <span class="hljs-string">&#x27;will&#x27;</span>)]<br></code></pre></td></tr></table></figure><p>明显，其中的text内容出现对应，和想象的不太相似，出现问题的原因在于<code>Dataloader</code>中的参数<code>collate_fn</code></p><p><code>collate_fn</code>的默认值为torch自定义的<code>default_collate</code>,<code>collate_fn</code>的作用就是对每个batch进行处理，而默认的<code>default_collate</code>处理出错。</p><p>解决问题的思路：</p><p>手段1：考虑先把数据转化为数字序列，观察其结果是否符合要求，之前使用DataLoader并未出现类似错误</p><p>手段2：考虑自定义一个<code>collate_fn</code>，观察结果</p><p>这里使用方式2，自定义一个<code>collate_fn</code>,然后观察结果：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">collate_fn</span>(<span class="hljs-params">batch</span>):<br><span class="hljs-comment">#batch是list，其中是一个一个元组，每个元组是dataset中__getitem__的结果</span><br>    batch = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">zip</span>(*batch))<br>    labes = torch.tensor(batch[<span class="hljs-number">0</span>],dtype=torch.int32)<br>    texts = batch[<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">del</span> batch<br>    <span class="hljs-keyword">return</span> labes,texts<br>dataloader = DataLoader(dataset=dataset,batch_size=<span class="hljs-number">2</span>,shuffle=<span class="hljs-literal">True</span>,collate_fn=collate_fn)<br><br><span class="hljs-comment">#此时输出正常</span><br><span class="hljs-keyword">for</span> idx,(label,text) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(dataloader):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;idx：&quot;</span>,idx)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;table:&quot;</span>,label)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;text:&quot;</span>,text)<br>    <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><h3 id="3-2-文本序列化"><a href="#3-2-文本序列化" class="headerlink" title="3.2 文本序列化"></a>3.2 文本序列化</h3><blockquote><p>再介绍word embedding的时候，我们说过，不会直接把文本转化为向量，而是先转化为数字，再把数字转化为向量，那么这个过程该如何实现呢？</p></blockquote><p>这里我们可以考虑把文本中的每个<strong>词语和其对应的数字，使用字典保存</strong>，同时实现方法<strong>把句子通过字典映射为包含数字的列表</strong>。</p><p>实现文本序列化之前，考虑以下几点:</p><ol><li>如何使用字典把词语和数字进行对应</li><li>不同的词语出现的次数不尽相同，是否需要对高频或者低频词语进行过滤，以及总的词语数量是否需要进行限制</li><li>得到词典之后，如何把句子转化为数字序列，如何把数字序列转化为句子</li><li>不同句子长度不相同，每个batch的句子如何构造成相同的长度（可以对短句子进行填充，填充特殊字符）</li><li>对于新出现的词语在词典中没有出现怎么办（可以使用特殊字符代理）</li></ol><p>思路分析：</p><ol><li>对所有句子进行分词</li><li>词语存入字典，根据次数对词语进行过滤，并统计次数</li><li>实现文本转数字序列的方法</li><li>实现数字序列转文本方法</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Word2Sequence</span>():<br>    UNK_TAG = <span class="hljs-string">&quot;UNK&quot;</span><br>    PAD_TAG = <span class="hljs-string">&quot;PAD&quot;</span><br><br>    UNK = <span class="hljs-number">0</span><br>    PAD = <span class="hljs-number">1</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.<span class="hljs-built_in">dict</span> = &#123;<br>            self.UNK_TAG :self.UNK,<br>            self.PAD_TAG :self.PAD<br>        &#125;<br>        self.fited = <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_index</span>(<span class="hljs-params">self,word</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;word -&gt; index&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">assert</span> self.fited == <span class="hljs-literal">True</span>,<span class="hljs-string">&quot;必须先进行fit操作&quot;</span><br>        <span class="hljs-keyword">return</span> self.<span class="hljs-built_in">dict</span>.get(word,self.UNK)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_word</span>(<span class="hljs-params">self,index</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;index -&gt; word&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">assert</span> self.fited , <span class="hljs-string">&quot;必须先进行fit操作&quot;</span><br>        <span class="hljs-keyword">if</span> index <span class="hljs-keyword">in</span> self.inversed_dict:<br>            <span class="hljs-keyword">return</span> self.inversed_dict[index]<br>        <span class="hljs-keyword">return</span> self.UNK_TAG<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> self(self.<span class="hljs-built_in">dict</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fit</span>(<span class="hljs-params">self, sentences, min_count=<span class="hljs-number">1</span>, max_count=<span class="hljs-literal">None</span>, max_feature=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :param sentences:[[word1,word2,word3],[word1,word3,wordn..],...]</span><br><span class="hljs-string">        :param min_count: 最小出现的次数</span><br><span class="hljs-string">        :param max_count: 最大出现的次数</span><br><span class="hljs-string">        :param max_feature: 总词语的最大数量</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        count = &#123;&#125;<br>        <span class="hljs-keyword">for</span> sentence <span class="hljs-keyword">in</span> sentences:<br>            <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> sentence:<br>                <span class="hljs-keyword">if</span> a <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> count:<br>                    count[a] = <span class="hljs-number">0</span><br>                count[a] += <span class="hljs-number">1</span><br><br>        <span class="hljs-comment"># 比最小的数量大和比最大的数量小的需要</span><br>        <span class="hljs-keyword">if</span> min_count <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            count = &#123;k: v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> count.items() <span class="hljs-keyword">if</span> v &gt;= min_count&#125;<br>        <span class="hljs-keyword">if</span> max_count <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            count = &#123;k: v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> count.items() <span class="hljs-keyword">if</span> v &lt;= max_count&#125;<br><br>        <span class="hljs-comment"># 限制最大的数量</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(max_feature, <span class="hljs-built_in">int</span>):<br>            count = <span class="hljs-built_in">sorted</span>(<span class="hljs-built_in">list</span>(count.items()), key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>])<br>            <span class="hljs-keyword">if</span> max_feature <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(count) &gt; max_feature:<br>                count = count[-<span class="hljs-built_in">int</span>(max_feature):]<br>            <span class="hljs-keyword">for</span> w, _ <span class="hljs-keyword">in</span> count:<br>                self.<span class="hljs-built_in">dict</span>[w] = <span class="hljs-built_in">len</span>(self.<span class="hljs-built_in">dict</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(count.keys()):<br>                self.<span class="hljs-built_in">dict</span>[w] = <span class="hljs-built_in">len</span>(self.<span class="hljs-built_in">dict</span>)<br><br>        self.fited = <span class="hljs-literal">True</span><br>        <span class="hljs-comment"># 准备一个index-&gt;word的字典</span><br>        self.inversed_dict = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(self.<span class="hljs-built_in">dict</span>.values(), self.<span class="hljs-built_in">dict</span>.keys()))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">self, sentence,max_len=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        实现吧句子转化为数组（向量）</span><br><span class="hljs-string">        :param sentence:</span><br><span class="hljs-string">        :param max_len:</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">assert</span> self.fited, <span class="hljs-string">&quot;必须先进行fit操作&quot;</span><br>        <span class="hljs-keyword">if</span> max_len <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            r = [self.PAD]*max_len<br>        <span class="hljs-keyword">else</span>:<br>            r = [self.PAD]*<span class="hljs-built_in">len</span>(sentence)<br>        <span class="hljs-keyword">if</span> max_len <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(sentence)&gt;max_len:<br>            sentence=sentence[:max_len]<br>        <span class="hljs-keyword">for</span> index,word <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(sentence):<br>            r[index] = self.to_index(word)<br>        <span class="hljs-keyword">return</span> np.array(r,dtype=np.int64)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inverse_transform</span>(<span class="hljs-params">self,indices</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        实现从数组 转化为文字</span><br><span class="hljs-string">        :param indices: [1,2,3....]</span><br><span class="hljs-string">        :return:[word1,word2.....]</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        sentence = []<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> indices:<br>            word = self.to_word(i)<br>            sentence.append(word)<br>        <span class="hljs-keyword">return</span> sentence<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    w2s = Word2Sequence()<br>    w2s.fit([<br>        [<span class="hljs-string">&quot;你&quot;</span>, <span class="hljs-string">&quot;好&quot;</span>, <span class="hljs-string">&quot;么&quot;</span>],<br>        [<span class="hljs-string">&quot;你&quot;</span>, <span class="hljs-string">&quot;好&quot;</span>, <span class="hljs-string">&quot;哦&quot;</span>]])<br><br>    <span class="hljs-built_in">print</span>(w2s.<span class="hljs-built_in">dict</span>)<br>    <span class="hljs-built_in">print</span>(w2s.fited)<br>    <span class="hljs-built_in">print</span>(w2s.transform([<span class="hljs-string">&quot;你&quot;</span>,<span class="hljs-string">&quot;好&quot;</span>,<span class="hljs-string">&quot;嘛&quot;</span>]))<br>    <span class="hljs-built_in">print</span>(w2s.transform([<span class="hljs-string">&quot;你好嘛&quot;</span>],max_len=<span class="hljs-number">10</span>))<br></code></pre></td></tr></table></figure><p>完成了<code>wordsequence</code>之后，接下来就是保存现有样本中的数据字典，方便后续的使用。</p><p>实现对IMDB数据的处理和保存</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#1. 对IMDB的数据记性fit操作</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fit_save_word_sequence</span>():<br>    <span class="hljs-keyword">from</span> wordSequence <span class="hljs-keyword">import</span> Word2Sequence<br><br>    ws = Word2Sequence()<br>    train_path = [os.path.join(data_base_path,i)  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-string">&quot;train/neg&quot;</span>,<span class="hljs-string">&quot;train/pos&quot;</span>]]<br>    total_file_path_list = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> train_path:<br>        total_file_path_list.extend([os.path.join(i, j) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> os.listdir(i)])<br>    <span class="hljs-keyword">for</span> cur_path <span class="hljs-keyword">in</span> tqdm(total_file_path_list,<span class="hljs-built_in">ascii</span>=<span class="hljs-literal">True</span>,desc=<span class="hljs-string">&quot;fitting&quot;</span>):<br>        ws.fit(tokenize(<span class="hljs-built_in">open</span>(cur_path).read().strip()))<br>    ws.build_vocab()<br>    <span class="hljs-comment"># 对wordSequesnce进行保存</span><br>    pickle.dump(ws,<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./model/ws.pkl&quot;</span>,<span class="hljs-string">&quot;wb&quot;</span>))<br><br><span class="hljs-comment">#2. 在dataset中使用wordsequence</span><br>ws = pickle.load(<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./model/ws.pkl&quot;</span>,<span class="hljs-string">&quot;rb&quot;</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">collate_fn</span>(<span class="hljs-params">batch</span>):<br>    MAX_LEN = <span class="hljs-number">500</span> <br>    <span class="hljs-comment">#MAX_LEN = max([len(i) for i in texts]) #取当前batch的最大值作为batch的最大长度</span><br><br>    batch = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">zip</span>(*batch))<br>    labes = torch.tensor(batch[<span class="hljs-number">0</span>],dtype=torch.<span class="hljs-built_in">int</span>)<br><br>    texts = batch[<span class="hljs-number">1</span>]<br>    <span class="hljs-comment">#获取每个文本的长度</span><br>    lengths = [<span class="hljs-built_in">len</span>(i) <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(i)&lt;MAX_LEN <span class="hljs-keyword">else</span> MAX_LEN <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> texts]<br>    texts = torch.tensor([ws.transform(i, MAX_LEN) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> texts])<br>    <span class="hljs-keyword">del</span> batch<br>    <span class="hljs-keyword">return</span> labes,texts,lengths<br><br><span class="hljs-comment">#3. 获取输出</span><br>dataset = ImdbDataset(ws,mode=<span class="hljs-string">&quot;train&quot;</span>)<br>    dataloader = DataLoader(dataset=dataset,batch_size=<span class="hljs-number">20</span>,shuffle=<span class="hljs-literal">True</span>,collate_fn=collate_fn)<br>    <span class="hljs-keyword">for</span> idx,(label,text,length) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(dataloader):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;idx：&quot;</span>,idx)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;table:&quot;</span>,label)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;text:&quot;</span>,text)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;length:&quot;</span>,length)<br>        <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p>输出如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">idx： <span class="hljs-number">0</span><br>table: tensor([ <span class="hljs-number">7</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">8</span>,  <span class="hljs-number">1</span>, <span class="hljs-number">10</span>,  <span class="hljs-number">7</span>, <span class="hljs-number">10</span>,  <span class="hljs-number">7</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">8</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">7</span>, <span class="hljs-number">10</span>,<br>         <span class="hljs-number">1</span>,  <span class="hljs-number">4</span>], dtype=torch.int32)<br>text: tensor([[ <span class="hljs-number">50983</span>,  <span class="hljs-number">77480</span>,  <span class="hljs-number">82366</span>,  ...,      <span class="hljs-number">1</span>,      <span class="hljs-number">1</span>,      <span class="hljs-number">1</span>],<br>        [ <span class="hljs-number">54702</span>,  <span class="hljs-number">57262</span>, <span class="hljs-number">102035</span>,  ...,  <span class="hljs-number">80474</span>,  <span class="hljs-number">56457</span>,  <span class="hljs-number">63180</span>],<br>        [ <span class="hljs-number">26991</span>,  <span class="hljs-number">57693</span>,  <span class="hljs-number">88450</span>,  ...,      <span class="hljs-number">1</span>,      <span class="hljs-number">1</span>,      <span class="hljs-number">1</span>],<br>        ...,<br>        [ <span class="hljs-number">51138</span>,  <span class="hljs-number">73263</span>,  <span class="hljs-number">80428</span>,  ...,      <span class="hljs-number">1</span>,      <span class="hljs-number">1</span>,      <span class="hljs-number">1</span>],<br>        [  <span class="hljs-number">7022</span>,  <span class="hljs-number">78114</span>,  <span class="hljs-number">83498</span>,  ...,      <span class="hljs-number">1</span>,      <span class="hljs-number">1</span>,      <span class="hljs-number">1</span>],<br>        [  <span class="hljs-number">5353</span>, <span class="hljs-number">101803</span>,  <span class="hljs-number">99148</span>,  ...,      <span class="hljs-number">1</span>,      <span class="hljs-number">1</span>,      <span class="hljs-number">1</span>]])<br>length: [<span class="hljs-number">296</span>, <span class="hljs-number">500</span>, <span class="hljs-number">221</span>, <span class="hljs-number">132</span>, <span class="hljs-number">74</span>, <span class="hljs-number">407</span>, <span class="hljs-number">500</span>, <span class="hljs-number">130</span>, <span class="hljs-number">54</span>, <span class="hljs-number">217</span>, <span class="hljs-number">80</span>, <span class="hljs-number">322</span>, <span class="hljs-number">72</span>, <span class="hljs-number">156</span>, <span class="hljs-number">94</span>, <span class="hljs-number">270</span>, <span class="hljs-number">317</span>, <span class="hljs-number">117</span>, <span class="hljs-number">200</span>, <span class="hljs-number">379</span>]<br><br></code></pre></td></tr></table></figure><blockquote><p>思考：前面我们自定义了MAX_LEN作为句子的最大长度，如果我们需要把每个batch中的最长的句子长度作为当前batch的最大长度，该如何实现？</p></blockquote><h2 id="4-构建模型"><a href="#4-构建模型" class="headerlink" title="4. 构建模型"></a>4. 构建模型</h2><p>这里我们只练习使用word embedding，所以模型只有一层，即：</p><ol><li>数据经过word embedding</li><li>数据通过全连接层返回结果，计算<code>log_softmax</code></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> optim<br><span class="hljs-keyword">from</span> build_dataset <span class="hljs-keyword">import</span> get_dataloader,ws,MAX_LEN<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">IMDBModel</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,max_len</span>):<br>        <span class="hljs-built_in">super</span>(IMDBModel,self).__init__()<br>        self.embedding = nn.Embedding(<span class="hljs-built_in">len</span>(ws),<span class="hljs-number">300</span>,padding_idx=ws.PAD) <span class="hljs-comment">#[N,300]</span><br>        self.fc = nn.Linear(max_len*<span class="hljs-number">300</span>,<span class="hljs-number">10</span>)  <span class="hljs-comment">#[max_len*300,10]</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        embed = self.embedding(x) <span class="hljs-comment">#[batch_size,max_len,300]</span><br>        embed = embed.view(x.size(<span class="hljs-number">0</span>),-<span class="hljs-number">1</span>)<br>        out = self.fc(embed)<br>        <span class="hljs-keyword">return</span> F.log_softmax(out,dim=-<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><h2 id="5-模型的训练和评估"><a href="#5-模型的训练和评估" class="headerlink" title="5. 模型的训练和评估"></a>5. 模型的训练和评估</h2><p>训练流程和之前相同</p><ol><li>实例化模型，损失函数，优化器</li><li>遍历dataset_loader，梯度置为0，进行向前计算</li><li>计算损失，反向传播优化损失，更新参数</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python">train_batch_size = <span class="hljs-number">128</span><br>test_batch_size = <span class="hljs-number">1000</span><br>imdb_model = IMDBModel(MAX_LEN)<br>optimizer = optim.Adam(imdb_model.parameters())<br>criterion = nn.CrossEntropyLoss()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">epoch</span>):<br>    mode = <span class="hljs-literal">True</span><br>    imdb_model.train(mode)<br>    train_dataloader =get_dataloader(mode,train_batch_size)<br>    <span class="hljs-keyword">for</span> idx,(target,<span class="hljs-built_in">input</span>,input_lenght) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_dataloader):<br>        optimizer.zero_grad()<br>        output = imdb_model(<span class="hljs-built_in">input</span>)<br>        loss = F.nll_loss(output,target) <span class="hljs-comment">#traget需要是[0,9]，不能是[1-10]</span><br>        loss.backward()<br>        optimizer.step()<br>        <span class="hljs-keyword">if</span> idx %<span class="hljs-number">10</span> == <span class="hljs-number">0</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Train Epoch: &#123;&#125; [&#123;&#125;/&#123;&#125; (&#123;:.0f&#125;%)]\tLoss: &#123;:.6f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<br>                epoch, idx * <span class="hljs-built_in">len</span>(<span class="hljs-built_in">input</span>), <span class="hljs-built_in">len</span>(train_dataloader.dataset),<br>                       <span class="hljs-number">100.</span> * idx / <span class="hljs-built_in">len</span>(train_dataloader), loss.item()))<br><br>            torch.save(imdb_model.state_dict(), <span class="hljs-string">&quot;model/mnist_net.pkl&quot;</span>)<br>            torch.save(optimizer.state_dict(), <span class="hljs-string">&#x27;model/mnist_optimizer.pkl&#x27;</span>)<br>            <br> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>():<br>    test_loss = <span class="hljs-number">0</span><br>    correct = <span class="hljs-number">0</span><br>    mode = <span class="hljs-literal">False</span><br>    imdb_model.<span class="hljs-built_in">eval</span>()<br>    test_dataloader = get_dataloader(mode, test_batch_size)<br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        <span class="hljs-keyword">for</span> target, <span class="hljs-built_in">input</span>, input_lenght <span class="hljs-keyword">in</span> test_dataloader:<br>            output = imdb_model(<span class="hljs-built_in">input</span>)<br>            test_loss  += F.nll_loss(output, target,reduction=<span class="hljs-string">&quot;sum&quot;</span>)<br>            pred = torch.<span class="hljs-built_in">max</span>(output,dim=-<span class="hljs-number">1</span>,keepdim=<span class="hljs-literal">False</span>)[-<span class="hljs-number">1</span>]<br>            correct = pred.eq(target.data).<span class="hljs-built_in">sum</span>()<br>        test_loss = test_loss/<span class="hljs-built_in">len</span>(test_dataloader.dataset)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\nTest set: Avg. loss: &#123;:.4f&#125;, Accuracy: &#123;&#125;/&#123;&#125; (&#123;:.2f&#125;%)\n&#x27;</span>.<span class="hljs-built_in">format</span>(<br>            test_loss, correct, <span class="hljs-built_in">len</span>(test_dataloader.dataset),<br>            <span class="hljs-number">100.</span> * correct / <span class="hljs-built_in">len</span>(test_dataloader.dataset)))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    test()<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        train(i)<br>        test()<br><br></code></pre></td></tr></table></figure><p>这里我们仅仅使用了一层全连接层，其分类效果不会很好，这里重点是理解常见的模型流程和word embedding的使用方法</p><h1 id="循环神经网络"><a href="#循环神经网络" class="headerlink" title="循环神经网络"></a>循环神经网络</h1><h2 id="目标-9"><a href="#目标-9" class="headerlink" title="目标"></a>目标</h2><ol><li>能够说出循环神经网络的概念和作用</li><li>能够说出循环神经网络的类型和应用场景</li><li>能够说出LSTM的作用和原理</li><li>能够说出GRU的作用和原理</li></ol><h2 id="1-循环神经网络的介绍"><a href="#1-循环神经网络的介绍" class="headerlink" title="1. 循环神经网络的介绍"></a>1. 循环神经网络的介绍</h2><blockquote><p>为什么有了神经网络还需要有循环神经网络？</p></blockquote><p>在普通的神经网络中，信息的传递是单向的，这种限制虽然使得网络变得更容易学习，但在一定程度上也减弱了神经网络模型的能力。特别是在很多现实任务中，网络的输出不仅和当前时刻的输入相关，也和其过去一段时间的输出相关。此外，普通网络难以处理时序数据，比如视频、语音、文本等，时序数据的长度一般是不固定的，而前馈神经网络要求输入和输出的维数都是固定的，不能任意改变。因此，当处理这一类和时序相关的问题时，就需要一种能力更强的模型。</p><p>循环神经网络（Recurrent Neural Network，RNN）是一类具有短期记忆能力的神经网络。在循环神经网络中，神经元不但可以接受其它神经元的信息，也可以接受自身的信息，形成具有环路的网络结构。换句话说：神经元的输出可以在下一个时间步直接作用到自身（</p><p>入）</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/RNN%E5%9B%BE.png"></p><p>通过简化图，我们看到RNN比传统的神经网络多了一个循环圈，这个循环表示的就是在下一个时间步（<strong>Time Step</strong>）上会返回作为输入的一部分，我们把RNN在时间点上展开，得到的图形如下：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/RNN%E5%B1%95%E5%BC%80.png"></p><p>或者是：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%9F%BA%E7%A1%80%E7%9A%84RNN%E5%B1%95%E5%BC%80%E5%9B%BE.png"></p><p>在不同的时间步，RNN的输入都将与之前的时间状态有关，$t_n$时刻网络的输出结果是该时刻的输入和所有历史共同作用的结果，这就达到了对时间序列建模的目的。</p><p>RNN的不同表示和功能可以通过下图看出：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/RNN%E5%8A%9F%E8%83%BD.png"></p><ul><li>图1：固定长度的输入和输出 (e.g. 图像分类)</li><li>图2：序列输出 (e.g.图像转文字)</li><li>图3：数列输入 (e.g. 文本分类)</li><li>图4：异步的序列输入和输出(e.g.文本翻译).</li><li>图5：同步的序列输入和输出 (e.g. 根据视频的每一帧来对视频进行分类)</li></ul><h2 id="2-LSTM和GRU"><a href="#2-LSTM和GRU" class="headerlink" title="2. LSTM和GRU"></a>2. LSTM和GRU</h2><h3 id="2-1-LSTM的基础介绍"><a href="#2-1-LSTM的基础介绍" class="headerlink" title="2.1 LSTM的基础介绍"></a>2.1 LSTM的基础介绍</h3><p>假如现在有这样一个需求，根据现有文本预测下一个词语，比如<code>天上的云朵漂浮在__</code>，通过间隔不远的位置就可以预测出来词语是<code>天上</code>，但是对于其他一些句子，可能需要被预测的词语在前100个词语之前，那么此时由于间隔非常大，随着间隔的增加可能会导致真实的预测值对结果的影响变的非常小，而无法非常好的进行预测（RNN中的长期依赖问题（long-Term Dependencies））</p><p>那么为了解决这个问题需要<strong>LSTM</strong>（<strong>Long Short-Term Memory网络</strong>）</p><p>LSTM是一种RNN特殊的类型，可以学习长期依赖信息。在很多问题上，LSTM都取得相当巨大的成功，并得到了广泛的应用。</p><p>一个LSMT的单元就是下图中的一个绿色方框中的内容：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/LSTM1.jpg"></p><p>其中$\sigma$表示sigmod函数，其他符号的含义：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/LSTM2.jpg"></p><h3 id="2-2-LSTM的核心"><a href="#2-2-LSTM的核心" class="headerlink" title="2.2 LSTM的核心"></a>2.2 LSTM的核心</h3><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/LSTM3.png"></p><p>LSTM的核心在于单元（细胞）中的状态，也就是上图中最上面的那根线。</p><p>但是如果只有上面那一条线，那么没有办法实现信息的增加或者删除，所以在LSTM是通过一个叫做<code>门</code>的结构实现，门可以选择让信息通过或者不通过。</p><p>这个门主要是通过sigmoid和点乘（<code>pointwise multiplication</code>）实现的</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/LSTM4.png"></p><p>我们都知道，$sigmoid$的取值范围是在(0,1)之间，如果接近0表示不让任何信息通过，如果接近1表示所有的信息都会通过</p><h3 id="2-3-逐步理解LSTM"><a href="#2-3-逐步理解LSTM" class="headerlink" title="2.3 逐步理解LSTM"></a>2.3 逐步理解LSTM</h3><h4 id="2-3-1-遗忘门"><a href="#2-3-1-遗忘门" class="headerlink" title="2.3.1 遗忘门"></a>2.3.1 遗忘门</h4><p>遗忘门通过sigmoid函数来决定哪些信息会被遗忘</p><p>在下图就是$h_{t-1}和x_t$进行合并（concat）之后乘上权重和偏置，通过sigmoid函数，输出0-1之间的一个值，这个值会和前一次的细胞状态($C_{t-1}$)进行点乘，从而决定遗忘或者保留</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%98%93%E7%8E%8B%E9%97%A8.png"></p><h4 id="2-3-2-输入门"><a href="#2-3-2-输入门" class="headerlink" title="2.3.2 输入门"></a>2.3.2 输入门</h4><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E8%BE%93%E5%85%A5%E9%97%A8.png"></p><p>下一步就是决定哪些新的信息会被保留，这个过程有两步：</p><ol><li>一个被称为<code>输入门</code>的sigmoid 层决定哪些信息会被更新</li><li><code>tanh</code>会创造一个新的候选向量$\widetilde{C}_{t}$，后续可能会被添加到细胞状态中</li></ol><p>例如：</p><p><code>我昨天吃了苹果，今天我想吃菠萝</code>，在这个句子中，通过遗忘门可以遗忘<code>苹果</code>,同时更新新的主语为<code>菠萝</code></p><p>现在就可以更新旧的细胞状态$C_{t-1}$为新的$C_{ t }$ 了。</p><p>更新的构成很简单就是：</p><ol><li>旧的细胞状态和遗忘门的结果相乘</li><li>然后加上 输入门和tanh相乘的结果</li></ol><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/LSTM-update.png"></p><h4 id="2-3-3-输出门"><a href="#2-3-3-输出门" class="headerlink" title="2.3.3 输出门"></a>2.3.3 输出门</h4><p>最后，我们需要决定什么信息会被输出，也是一样这个输出经过变换之后会通过sigmoid函数的结果来决定那些细胞状态会被输出。</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E8%BE%93%E5%87%BA%E9%97%A8.png"></p><p>步骤如下：</p><ol><li>前一次的输出和当前时间步的输入的组合结果通过sigmoid函数进行处理得到$O_t$</li><li>更新后的细胞状态$C_t$会经过tanh层的处理，把数据转化到(-1,1)的区间</li><li>tanh处理后的结果和$O_t$进行相乘，把结果输出同时传到下一个LSTM的单元</li></ol><h3 id="2-4-GRU，LSTM的变形"><a href="#2-4-GRU，LSTM的变形" class="headerlink" title="2.4 GRU，LSTM的变形"></a>2.4 GRU，LSTM的变形</h3><p>GRU(Gated Recurrent Unit),是一种LSTM的变形版本， 它将遗忘和输入门组合成一个“更新门”。它还合并了单元状态和隐藏状态，并进行了一些其他更改，由于他的模型比标准LSTM模型简单，所以越来越受欢迎。</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/GRU.png"></p><p>LSTM内容参考地址：<a href="https://colah.github.io/posts/2015-08-Understanding-LSTMs/">https://colah.github.io/posts/2015-08-Understanding-LSTMs/</a></p><h2 id="3-双向LSTM"><a href="#3-双向LSTM" class="headerlink" title="3. 双向LSTM"></a>3. 双向LSTM</h2><p>单向的 RNN，是根据前面的信息推出后面的，但有时候只看前面的词是不够的， 可能需要预测的词语和后面的内容也相关，那么此时需要一种机制，能够让模型不仅能够从前往后的具有记忆，还需要从后往前需要记忆。此时双向LSTM就可以帮助我们解决这个问题</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/bidir_lstm.png"></p><p>由于是双向LSTM，所以每个方向的LSTM都会有一个输出，最终的输出会有2部分，所以往往需要concat的操作</p><h1 id="循环神经网络实现文本情感分类"><a href="#循环神经网络实现文本情感分类" class="headerlink" title="循环神经网络实现文本情感分类"></a>循环神经网络实现文本情感分类</h1><h2 id="目标-10"><a href="#目标-10" class="headerlink" title="目标"></a>目标</h2><ol><li>知道LSTM和GRU的使用方法及输入输出的格式</li><li>能够应用LSTM和GRU实现文本情感分类</li></ol><h2 id="1-Pytorch中LSTM和GRU模块使用"><a href="#1-Pytorch中LSTM和GRU模块使用" class="headerlink" title="1. Pytorch中LSTM和GRU模块使用"></a>1. Pytorch中LSTM和GRU模块使用</h2><h3 id="1-1-LSTM介绍"><a href="#1-1-LSTM介绍" class="headerlink" title="1.1 LSTM介绍"></a>1.1 LSTM介绍</h3><p>LSTM和GRU都是由<code>torch.nn</code>提供</p><p>通过观察文档，可知LSMT的参数，</p><p><code>torch.nn.LSTM(input_size,hidden_size,num_layers,batch_first,dropout,bidirectional)</code></p><ol><li><code>input_size </code>：输入数据的形状，即embedding_dim</li><li><code>hidden_size</code>：隐藏层神经元的数量，即每一层有多少个LSTM单元</li><li><code>num_layer</code> ：即RNN的中LSTM单元的层数</li><li><code>batch_first</code>：默认值为False，输入的数据需要<code>[seq_len,batch,feature]</code>,如果为True，则为<code>[batch,seq_len,feature]</code></li><li><code>dropout</code>:dropout的比例，默认值为0。dropout是一种训练过程中让部分参数随机失活的一种方式，能够提高训练速度，同时能够解决过拟合的问题。这里是在LSTM的最后一层，对每个输出进行dropout</li><li><code>bidirectional</code>：是否使用双向LSTM,默认是False</li></ol><p>实例化LSTM对象之后,<strong>不仅需要传入数据，还需要前一次的h_0(前一次的隐藏状态)和c_0（前一次memory）</strong></p><p>即：<code>lstm(input,(h_0,c_0))</code></p><p>LSTM的默认输出为<code>output, (h_n, c_n)</code></p><ol><li><code>output</code>：<code>(seq_len, batch, num_directions * hidden_size)</code>—&gt;batch_first&#x3D;False</li><li><code>h_n</code>:<code>(num_layers * num_directions, batch, hidden_size)</code></li><li><code>c_n</code>: <code>(num_layers * num_directions, batch, hidden_size)</code></li></ol><h2 id="1-2-LSTM使用示例"><a href="#1-2-LSTM使用示例" class="headerlink" title="1.2 LSTM使用示例"></a>1.2 LSTM使用示例</h2><p>假设数据输入为 input ,形状是<code>[10,20]</code>，假设embedding的形状是<code>[100,30]</code></p><p>则LSTM使用示例如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python">batch_size =<span class="hljs-number">10</span><br>seq_len = <span class="hljs-number">20</span><br>embedding_dim = <span class="hljs-number">30</span><br>word_vocab = <span class="hljs-number">100</span><br>hidden_size = <span class="hljs-number">18</span><br>num_layer = <span class="hljs-number">2</span><br><br><span class="hljs-comment">#准备输入数据</span><br><span class="hljs-built_in">input</span> = torch.randint(low=<span class="hljs-number">0</span>,high=<span class="hljs-number">100</span>,size=(batch_size,seq_len))<br><span class="hljs-comment">#准备embedding</span><br>embedding  = torch.nn.Embedding(word_vocab,embedding_dim)<br>lstm = torch.nn.LSTM(embedding_dim,hidden_size,num_layer)<br><br><span class="hljs-comment">#进行mebed操作</span><br>embed = embedding(<span class="hljs-built_in">input</span>) <span class="hljs-comment">#[10,20,30]</span><br><br><span class="hljs-comment">#转化数据为batch_first=False</span><br>embed = embed.permute(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>) <span class="hljs-comment">#[20,10,30]</span><br><br><span class="hljs-comment">#初始化状态， 如果不初始化，torch默认初始值为全0</span><br>h_0 = torch.rand(num_layer,batch_size,hidden_size)<br>c_0 = torch.rand(num_layer,batch_size,hidden_size)<br>output,(h_1,c_1) = lstm(embed,(h_0,c_0))<br><span class="hljs-comment">#output [20,10,1*18]</span><br><span class="hljs-comment">#h_1 [2,10,18]</span><br><span class="hljs-comment">#c_1 [2,10,18]</span><br></code></pre></td></tr></table></figure><p>输出如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">122</span>]: output.size()<br>Out[<span class="hljs-number">122</span>]: torch.Size([<span class="hljs-number">20</span>, <span class="hljs-number">10</span>, <span class="hljs-number">18</span>])<br><br>In [<span class="hljs-number">123</span>]: h_1.size()<br>Out[<span class="hljs-number">123</span>]: torch.Size([<span class="hljs-number">2</span>, <span class="hljs-number">10</span>, <span class="hljs-number">18</span>])<br><br>In [<span class="hljs-number">124</span>]: c_1.size()<br>Out[<span class="hljs-number">124</span>]: torch.Size([<span class="hljs-number">2</span>, <span class="hljs-number">10</span>, <span class="hljs-number">18</span>])<br></code></pre></td></tr></table></figure><p>通过前面的学习，我们知道，最后一次的h_1应该和output的最后一个time step的输出是一样的</p><p>通过下面的代码，我们来验证一下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">179</span>]: a = output[-<span class="hljs-number">1</span>,:,:]<br><br>In [<span class="hljs-number">180</span>]: a.size()<br>Out[<span class="hljs-number">180</span>]: torch.Size([<span class="hljs-number">10</span>, <span class="hljs-number">18</span>])<br><br>In [<span class="hljs-number">183</span>]: b.size()<br>Out[<span class="hljs-number">183</span>]: torch.Size([<span class="hljs-number">10</span>, <span class="hljs-number">18</span>])<br>In [<span class="hljs-number">184</span>]: a == b<br>Out[<span class="hljs-number">184</span>]:<br>tensor([[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>],<br>        [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>],<br>        [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>],<br>        [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>],<br>        [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>],<br>        [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>],<br>        [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>],<br>        [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>],<br>        [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>],<br>        [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]],<br>       dtype=torch.uint8)<br></code></pre></td></tr></table></figure><h3 id="1-3-GRU的使用示例"><a href="#1-3-GRU的使用示例" class="headerlink" title="1.3 GRU的使用示例"></a>1.3 GRU的使用示例</h3><p>GRU模块<code>torch.nn.GRU</code>，和LSTM的参数相同，含义相同，具体可参考文档</p><p>但是输入只剩下<code>gru(input,h_0)</code>，输出为<code>output, h_n</code></p><p>其形状为：</p><ol><li><code>output</code>:<code>(seq_len, batch, num_directions * hidden_size)</code></li><li><code>h_n</code>:<code>(num_layers * num_directions, batch, hidden_size)</code></li></ol><p>大家可以使用上述代码，观察GRU的输出形式</p><h3 id="1-4-双向LSTM"><a href="#1-4-双向LSTM" class="headerlink" title="1.4 双向LSTM"></a>1.4 双向LSTM</h3><p>如果需要使用双向LSTM，则在实例化LSTM的过程中，需要把LSTM中的bidriectional设置为True，同时h_0和c_0使用num_layer*2</p><p>观察效果，输出为</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python">batch_size =<span class="hljs-number">10</span> <span class="hljs-comment">#句子的数量</span><br>seq_len = <span class="hljs-number">20</span>  <span class="hljs-comment">#每个句子的长度</span><br>embedding_dim = <span class="hljs-number">30</span>  <span class="hljs-comment">#每个词语使用多长的向量表示</span><br>word_vocab = <span class="hljs-number">100</span>  <span class="hljs-comment">#词典中词语的总数</span><br>hidden_size = <span class="hljs-number">18</span>  <span class="hljs-comment">#隐层中lstm的个数</span><br>num_layer = <span class="hljs-number">2</span>  <span class="hljs-comment">#多少个隐藏层</span><br><br><span class="hljs-built_in">input</span> = torch.randint(low=<span class="hljs-number">0</span>,high=<span class="hljs-number">100</span>,size=(batch_size,seq_len))<br>embedding  = torch.nn.Embedding(word_vocab,embedding_dim)<br>lstm = torch.nn.LSTM(embedding_dim,hidden_size,num_layer,bidirectional=<span class="hljs-literal">True</span>)<br><br>embed = embedding(<span class="hljs-built_in">input</span>) <span class="hljs-comment">#[10,20,30]</span><br><br><span class="hljs-comment">#转化数据为batch_first=False</span><br>embed = embed.permute(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>) <span class="hljs-comment">#[20,10,30]</span><br>h_0 = torch.rand(num_layer*<span class="hljs-number">2</span>,batch_size,hidden_size)<br>c_0 = torch.rand(num_layer*<span class="hljs-number">2</span>,batch_size,hidden_size)<br>output,(h_1,c_1) = lstm(embed,(h_0,c_0))<br><br>In [<span class="hljs-number">135</span>]: output.size()<br>Out[<span class="hljs-number">135</span>]: torch.Size([<span class="hljs-number">20</span>, <span class="hljs-number">10</span>, <span class="hljs-number">36</span>])<br><br>In [<span class="hljs-number">136</span>]: h_1.size()<br>Out[<span class="hljs-number">136</span>]: torch.Size([<span class="hljs-number">4</span>, <span class="hljs-number">10</span>, <span class="hljs-number">18</span>])<br><br>In [<span class="hljs-number">137</span>]: c_1.size()<br>Out[<span class="hljs-number">137</span>]: torch.Size([<span class="hljs-number">4</span>, <span class="hljs-number">10</span>, <span class="hljs-number">18</span>])<br></code></pre></td></tr></table></figure><p>在单向LSTM中，最后一个time step的输出的前hidden_size个和最后一层隐藏状态h_1的输出相同，那么双向LSTM呢？</p><p>双向LSTM中：</p><p><strong>output：按照正反计算的结果顺序在第2个维度进行拼接，正向第一个拼接反向的最后一个输出</strong></p><p><strong>hidden state:按照得到的结果在第0个维度进行拼接，正向第一个之后接着是反向第一个</strong></p><ol><li><p>前向的LSTM中，最后一个time step的输出的前hidden_size个和最后一层向前传播h_1的输出相同</p><ul><li><p>示例：</p></li><li><p>&#96;&#96;&#96;python<br>#-1是前向LSTM的最后一个，前18是前hidden_size个<br>In [188]: a &#x3D; output[-1,:,:18]  #前项LSTM中最后一个time step的output</p><p>In [189]: b &#x3D; h_1[-2,:,:]  #倒数第二个为前向</p><p>In [190]: a.size()<br>Out[190]: torch.Size([10, 18])</p><p>In [191]: b.size()<br>Out[191]: torch.Size([10, 18])</p><p>In [192]: a &#x3D;&#x3D; b<br>Out[192]:<br>tensor([[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],<br>    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],<br>    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],<br>    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],<br>    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],<br>    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],<br>    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],<br>    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],<br>    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],<br>    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]],<br>   dtype&#x3D;torch.uint8)</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><br>     <br><br><span class="hljs-number">2</span>. 后向LSTM中，最后一个<span class="hljs-selector-tag">time</span> step的输出的后hidden_size个和最后一层后向传播的h_1的输出相同<br><br>   - 示例<br><br>   - ```python<br>     #<span class="hljs-number">0</span> 是反向LSTM的最后一个，后<span class="hljs-number">18</span>是后hidden_size个<br>     In <span class="hljs-selector-attr">[196]</span>: c = output<span class="hljs-selector-attr">[0,:,18:]</span>  #后向LSTM中的最后一个输出<br>     <br>     In <span class="hljs-selector-attr">[197]</span>: d = h_1<span class="hljs-selector-attr">[-1,:,:]</span> #后向LSTM中的最后一个隐藏层状态<br>     <br>     In <span class="hljs-selector-attr">[198]</span>: c == d<br>     Out<span class="hljs-selector-attr">[198]</span>:<br>     <span class="hljs-built_in">tensor</span>(<span class="hljs-selector-attr">[[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span>,<br>             <span class="hljs-selector-attr">[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span>,<br>             <span class="hljs-selector-attr">[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span>,<br>             <span class="hljs-selector-attr">[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span>,<br>             <span class="hljs-selector-attr">[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span>,<br>             <span class="hljs-selector-attr">[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span>,<br>             <span class="hljs-selector-attr">[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span>,<br>             <span class="hljs-selector-attr">[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span>,<br>             <span class="hljs-selector-attr">[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span>,<br>             <span class="hljs-selector-attr">[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span>],<br>            dtype=torch.uint8)<br></code></pre></td></tr></table></figure></li></ul></li></ol><h3 id="1-4-LSTM和GRU的使用注意点"><a href="#1-4-LSTM和GRU的使用注意点" class="headerlink" title="1.4 LSTM和GRU的使用注意点"></a>1.4 LSTM和GRU的使用注意点</h3><ol><li>第一次调用之前，需要初始化隐藏状态，如果不初始化，默认创建全为0的隐藏状态</li><li>往往会使用LSTM or GRU 的输出的最后一维的结果，来代表LSTM、GRU对文本处理的结果，其形状为<code>[batch,  num_directions*hidden_size]</code>。<ol><li>并不是所有模型都会使用最后一维的结果</li><li>如果实例化LSTM的过程中，batch_first&#x3D;False,则<code>output[-1] or output[-1,:,:]</code>可以获取最后一维</li><li>如果实例化LSTM的过程中，batch_first&#x3D;True,则<code>output[:,-1,:]</code>可以获取最后一维</li></ol></li><li>如果结果是<code>(seq_len, batch_size, num_directions * hidden_size)</code>,需要把它转化为<code>(batch_size,seq_len, num_directions * hidden_size)</code>的形状，不能够不是view等变形的方法，需要使用<code>output.permute(1,0,2)</code>，即交换0和1轴，实现上述效果</li><li>使用双向LSTM的时候，往往会分别使用每个方向最后一次的output，作为当前数据经过双向LSTM的结果<ul><li>即：<code>torch.cat([h_1[-2,:,:],h_1[-1,:,:]],dim=-1)</code></li><li>最后的表示的size是<code>[batch_size,hidden_size*2]</code></li></ul></li><li>上述内容在GRU中同理</li></ol><h2 id="2-使用LSTM完成文本情感分类"><a href="#2-使用LSTM完成文本情感分类" class="headerlink" title="2. 使用LSTM完成文本情感分类"></a>2. 使用LSTM完成文本情感分类</h2><p>在前面，我们使用了word embedding去实现了toy级别的文本情感分类，那么现在我们在这个模型中添加上LSTM层，观察分类效果。</p><p>为了达到更好的效果，对之前的模型做如下修改</p><ol><li>MAX_LEN &#x3D; 200</li><li>构建dataset的过程，把数据转化为2分类的问题，pos为1，neg为0，否则25000个样本完成10个类别的划分数据量是不够的</li><li>在实例化LSTM的时候，使用dropout&#x3D;0.5，在model.eval()的过程中，dropout自动会为0</li></ol><h3 id="2-1-修改模型"><a href="#2-1-修改模型" class="headerlink" title="2.1 修改模型"></a>2.1 修改模型</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">IMDBLstmmodel</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(IMDBLstmmodel,self).__init__()<br>        self.hidden_size = <span class="hljs-number">64</span><br>        self.embedding_dim = <span class="hljs-number">200</span><br>        self.num_layer = <span class="hljs-number">2</span><br>        self.bidriectional = <span class="hljs-literal">True</span><br>        self.bi_num = <span class="hljs-number">2</span> <span class="hljs-keyword">if</span> self.bidriectional <span class="hljs-keyword">else</span> <span class="hljs-number">1</span><br>        self.dropout = <span class="hljs-number">0.5</span><br>        <span class="hljs-comment">#以上部分为超参数，可以自行修改</span><br><br>        self.embedding = nn.Embedding(<span class="hljs-built_in">len</span>(ws),self.embedding_dim,padding_idx=ws.PAD) <span class="hljs-comment">#[N,300]</span><br>        self.lstm = nn.LSTM(self.embedding_dim,self.hidden_size,self.num_layer,bidirectional=<span class="hljs-literal">True</span>,dropout=self.dropout)<br>        <span class="hljs-comment">#使用两个全连接层，中间使用relu激活函数</span><br>        self.fc = nn.Linear(self.hidden_size*self.bi_num,<span class="hljs-number">20</span>)<br>        self.fc2 = nn.Linear(<span class="hljs-number">20</span>,<span class="hljs-number">2</span>)<br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        x = self.embedding(x)<br>        x = x.permute(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>) <span class="hljs-comment">#进行轴交换</span><br>        h_0,c_0 = self.init_hidden_state(x.size(<span class="hljs-number">1</span>))<br>        _,(h_n,c_n) = self.lstm(x,(h_0,c_0))<br><br>        <span class="hljs-comment">#只要最后一个lstm单元处理的结果，这里多去的hidden state</span><br>        out = torch.cat([h_n[-<span class="hljs-number">2</span>, :, :], h_n[-<span class="hljs-number">1</span>, :, :]], dim=-<span class="hljs-number">1</span>)<br>        out = self.fc(out)<br>        out = F.relu(out)<br>        out = self.fc2(out)<br>        <span class="hljs-keyword">return</span> F.log_softmax(out,dim=-<span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_hidden_state</span>(<span class="hljs-params">self,batch_size</span>):<br>        h_0 = torch.rand(self.num_layer * self.bi_num, batch_size, self.hidden_size).to(device)<br>        c_0 = torch.rand(self.num_layer * self.bi_num, batch_size, self.hidden_size).to(device)<br>        <span class="hljs-keyword">return</span> h_0,c_0<br></code></pre></td></tr></table></figure><h3 id="2-2-完成训练和测试代码"><a href="#2-2-完成训练和测试代码" class="headerlink" title="2.2 完成训练和测试代码"></a>2.2 完成训练和测试代码</h3><p>为了提高程序的运行速度，可以考虑把模型放在gup上运行，那么此时需要处理一下几点：</p><ol><li><code>device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</code></li><li><code>model.to(device)</code></li><li>除了上述修改外，涉及计算的所有tensor都需要转化为CUDA的tensor<ol><li>初始化的<code>h_0,c_0</code></li><li>训练集和测试集的<code>input,traget</code></li></ol></li><li>在最后可以通过<code>tensor.cpu()</code>转化为torch的普通tensor</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python">train_batch_size = <span class="hljs-number">64</span><br>test_batch_size = <span class="hljs-number">5000</span><br><span class="hljs-comment"># imdb_model = IMDBModel(MAX_LEN) #基础model</span><br>imdb_model = IMDBLstmmodel().to(device) <span class="hljs-comment">#在gpu上运行，提高运行速度</span><br><span class="hljs-comment"># imdb_model.load_state_dict(torch.load(&quot;model/mnist_net.pkl&quot;))</span><br>optimizer = optim.Adam(imdb_model.parameters())<br>criterion = nn.CrossEntropyLoss()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">epoch</span>):<br>    mode = <span class="hljs-literal">True</span><br>    imdb_model.train(mode)<br>    train_dataloader =get_dataloader(mode,train_batch_size)<br>    <span class="hljs-keyword">for</span> idx,(target,<span class="hljs-built_in">input</span>,input_lenght) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_dataloader):<br>        target = target.to(device)<br>        <span class="hljs-built_in">input</span> = <span class="hljs-built_in">input</span>.to(device)<br>        optimizer.zero_grad()<br>        output = imdb_model(<span class="hljs-built_in">input</span>)<br>        loss = F.nll_loss(output,target) <span class="hljs-comment">#traget需要是[0,9]，不能是[1-10]</span><br>        loss.backward()<br>        optimizer.step()<br>        <span class="hljs-keyword">if</span> idx %<span class="hljs-number">10</span> == <span class="hljs-number">0</span>:<br>            pred = torch.<span class="hljs-built_in">max</span>(output, dim=-<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">False</span>)[-<span class="hljs-number">1</span>]<br>            acc = pred.eq(target.data).cpu().numpy().mean()*<span class="hljs-number">100.</span><br><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Train Epoch: &#123;&#125; [&#123;&#125;/&#123;&#125; (&#123;:.0f&#125;%)]\tLoss: &#123;:.6f&#125;\t ACC: &#123;:.6f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(epoch, idx * <span class="hljs-built_in">len</span>(<span class="hljs-built_in">input</span>), <span class="hljs-built_in">len</span>(train_dataloader.dataset),<br>                       <span class="hljs-number">100.</span> * idx / <span class="hljs-built_in">len</span>(train_dataloader), loss.item(),acc))<br><br>            torch.save(imdb_model.state_dict(), <span class="hljs-string">&quot;model/mnist_net.pkl&quot;</span>)<br>            torch.save(optimizer.state_dict(), <span class="hljs-string">&#x27;model/mnist_optimizer.pkl&#x27;</span>)<br>            <br> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>():<br>    mode = <span class="hljs-literal">False</span><br>    imdb_model.<span class="hljs-built_in">eval</span>()<br>    test_dataloader = get_dataloader(mode, test_batch_size)<br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        <span class="hljs-keyword">for</span> idx,(target, <span class="hljs-built_in">input</span>, input_lenght) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(test_dataloader):<br>            target = target.to(device)<br>            <span class="hljs-built_in">input</span> = <span class="hljs-built_in">input</span>.to(device)<br>            output = imdb_model(<span class="hljs-built_in">input</span>)<br>            test_loss  = F.nll_loss(output, target,reduction=<span class="hljs-string">&quot;mean&quot;</span>)<br>            pred = torch.<span class="hljs-built_in">max</span>(output,dim=-<span class="hljs-number">1</span>,keepdim=<span class="hljs-literal">False</span>)[-<span class="hljs-number">1</span>]<br>            correct = pred.eq(target.data).<span class="hljs-built_in">sum</span>()<br>            acc = <span class="hljs-number">100.</span> * pred.eq(target.data).cpu().numpy().mean()<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;idx: &#123;&#125; Test set: Avg. loss: &#123;:.4f&#125;, Accuracy: &#123;&#125;/&#123;&#125; (&#123;:.2f&#125;%)\n&#x27;</span>.<span class="hljs-built_in">format</span>(idx,test_loss, correct, target.size(<span class="hljs-number">0</span>),acc))<br>            <br> <span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    test()<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>        train(i)<br>        test()<br><br></code></pre></td></tr></table></figure><h3 id="2-3-模型训练的最终输出"><a href="#2-3-模型训练的最终输出" class="headerlink" title="2.3 模型训练的最终输出"></a>2.3 模型训练的最终输出</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">...</span><br><span class="hljs-attr">Train Epoch:</span> <span class="hljs-number">9</span> [<span class="hljs-number">20480</span><span class="hljs-string">/25000</span> <span class="hljs-string">(82%)</span>]<span class="hljs-attr">Loss:</span> <span class="hljs-number">0.017165</span> <span class="hljs-attr">ACC:</span> <span class="hljs-number">100.000000</span><br><span class="hljs-attr">Train Epoch:</span> <span class="hljs-number">9</span> [<span class="hljs-number">21120</span><span class="hljs-string">/25000</span> <span class="hljs-string">(84%)</span>]<span class="hljs-attr">Loss:</span> <span class="hljs-number">0.021572</span> <span class="hljs-attr">ACC:</span> <span class="hljs-number">98.437500</span><br><span class="hljs-attr">Train Epoch:</span> <span class="hljs-number">9</span> [<span class="hljs-number">21760</span><span class="hljs-string">/25000</span> <span class="hljs-string">(87%)</span>]<span class="hljs-attr">Loss:</span> <span class="hljs-number">0.058546</span> <span class="hljs-attr">ACC:</span> <span class="hljs-number">98.437500</span><br><span class="hljs-attr">Train Epoch:</span> <span class="hljs-number">9</span> [<span class="hljs-number">22400</span><span class="hljs-string">/25000</span> <span class="hljs-string">(90%)</span>]<span class="hljs-attr">Loss:</span> <span class="hljs-number">0.045248</span> <span class="hljs-attr">ACC:</span> <span class="hljs-number">98.437500</span><br><span class="hljs-attr">Train Epoch:</span> <span class="hljs-number">9</span> [<span class="hljs-number">23040</span><span class="hljs-string">/25000</span> <span class="hljs-string">(92%)</span>]<span class="hljs-attr">Loss:</span> <span class="hljs-number">0.027622</span> <span class="hljs-attr">ACC:</span> <span class="hljs-number">98.437500</span><br><span class="hljs-attr">Train Epoch:</span> <span class="hljs-number">9</span> [<span class="hljs-number">23680</span><span class="hljs-string">/25000</span> <span class="hljs-string">(95%)</span>]<span class="hljs-attr">Loss:</span> <span class="hljs-number">0.097722</span> <span class="hljs-attr">ACC:</span> <span class="hljs-number">95.312500</span><br><span class="hljs-attr">Train Epoch:</span> <span class="hljs-number">9</span> [<span class="hljs-number">24320</span><span class="hljs-string">/25000</span> <span class="hljs-string">(97%)</span>]<span class="hljs-attr">Loss:</span> <span class="hljs-number">0.026713</span> <span class="hljs-attr">ACC:</span> <span class="hljs-number">98.437500</span><br><span class="hljs-attr">Train Epoch:</span> <span class="hljs-number">9</span> [<span class="hljs-number">15600</span><span class="hljs-string">/25000</span> <span class="hljs-string">(100%)</span>]<span class="hljs-attr">Loss:</span> <span class="hljs-number">0.006082</span> <span class="hljs-attr">ACC:</span> <span class="hljs-number">100.000000</span><br><span class="hljs-attr">idx: 0 Test set: Avg. loss:</span> <span class="hljs-number">0.8794</span><span class="hljs-string">,</span> <span class="hljs-attr">Accuracy:</span> <span class="hljs-number">4053</span><span class="hljs-string">/5000</span> <span class="hljs-string">(81.06%)</span><br><span class="hljs-attr">idx: 1 Test set: Avg. loss:</span> <span class="hljs-number">0.8791</span><span class="hljs-string">,</span> <span class="hljs-attr">Accuracy:</span> <span class="hljs-number">4018</span><span class="hljs-string">/5000</span> <span class="hljs-string">(80.36%)</span><br><span class="hljs-attr">idx: 2 Test set: Avg. loss:</span> <span class="hljs-number">0.8250</span><span class="hljs-string">,</span> <span class="hljs-attr">Accuracy:</span> <span class="hljs-number">4087</span><span class="hljs-string">/5000</span> <span class="hljs-string">(81.74%)</span><br><span class="hljs-attr">idx: 3 Test set: Avg. loss:</span> <span class="hljs-number">0.8380</span><span class="hljs-string">,</span> <span class="hljs-attr">Accuracy:</span> <span class="hljs-number">4074</span><span class="hljs-string">/5000</span> <span class="hljs-string">(81.48%)</span><br><span class="hljs-attr">idx: 4 Test set: Avg. loss:</span> <span class="hljs-number">0.8696</span><span class="hljs-string">,</span> <span class="hljs-attr">Accuracy:</span> <span class="hljs-number">4027</span><span class="hljs-string">/5000</span> <span class="hljs-string">(80.54%)</span><br></code></pre></td></tr></table></figure><p>可以看到模型的测试准确率稳定在81%左右。</p><p>大家可以把上述代码改为GRU，或者多层LSTM继续尝试，观察效果</p><h1 id="Pytorch中的序列化容器"><a href="#Pytorch中的序列化容器" class="headerlink" title="Pytorch中的序列化容器"></a>Pytorch中的序列化容器</h1><h2 id="目标-11"><a href="#目标-11" class="headerlink" title="目标"></a>目标</h2><ol><li>知道梯度消失和梯度爆炸的原理和解决方法</li><li>能够使用<code>nn.Sequential</code>完成模型的搭建</li><li>知道<code>nn.BatchNorm1d</code>的使用方法</li><li>知道<code>nn.Dropout</code>的使用方法</li></ol><h2 id="1-梯度消失和梯度爆炸"><a href="#1-梯度消失和梯度爆炸" class="headerlink" title="1. 梯度消失和梯度爆炸"></a>1. 梯度消失和梯度爆炸</h2><p>在使用pytorch中的序列化 容器之前，我们先来了解一下常见的梯度消失和梯度爆炸的问题</p><h3 id="1-1-梯度消失"><a href="#1-1-梯度消失" class="headerlink" title="1.1 梯度消失"></a>1.1 梯度消失</h3><p>假设我们有四层极简神经网络：每层只有一个神经元</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%A2%AF%E5%BA%A6%E6%B6%88%E5%A4%B1.png"></p><p>$获取w1的梯度有：▽w1 &#x3D; x1<em>f(a1)’</em>w2<em>f(b1)’</em>w3*▽out$</p><p>假设我们使用sigmoid激活函数，即f为sigmoid函数，sigmoid的导数如下图</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/sigmoid%E5%AF%BC%E6%95%B0.png"></p><p>假设每层都取得sigmoid导函数的最大值1&#x2F;4，那么在反向传播时，$X1&#x3D;0.5,w1&#x3D;w2&#x3D;w3&#x3D;0.5$</p><p>$\nabla w1&lt; \frac{1}{2} * \frac{1}{4}* \frac{1}{2}* \frac{1}{4}*\frac{1}{2}*\nabla out &#x3D; \frac{1}{2^7} \nabla out$ </p><p>当权重初始过小或使用<code>易饱和神经元(sigmoid,tanh，) sigmoid在y=0,1处梯度接近0，而无法更新参数</code>，时神经网络在反向传播时也会呈现指数倍缩小，产生“消失”现象。</p><h3 id="1-2-梯度爆炸"><a href="#1-2-梯度爆炸" class="headerlink" title="1.2 梯度爆炸"></a>1.2 梯度爆炸</h3><p>假设$X2&#x3D;2,w1&#x3D;w2&#x3D;w3&#x3D;2$</p><p>$\nabla w1 &#x3D; f’{a}<em>2</em>f‘{a}*x2\nabla out &#x3D; 2^3f’(a)^2 \nabla out $</p><p> 当权重初始过大时，梯度神经网络在反向传播时也会呈现指数倍放大，产生“爆炸”现象。</p><h3 id="1-3-解决梯度消失或者梯度爆炸的经验"><a href="#1-3-解决梯度消失或者梯度爆炸的经验" class="headerlink" title="1.3 解决梯度消失或者梯度爆炸的经验"></a>1.3 解决梯度消失或者梯度爆炸的经验</h3><ol><li><p><strong>替换易训练神经元</strong></p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%9B%BF%E6%8D%A2%E6%BF%80%E6%B4%BB%E5%87%BD%E6%95%B0.png"></p></li><li><p><strong>改进梯度优化算法：</strong>使用adam等算法</p></li><li><p><strong>使用batch normalization</strong></p></li></ol><h2 id="2-nn-Sequential"><a href="#2-nn-Sequential" class="headerlink" title="2. nn.Sequential"></a>2. <code>nn.Sequential</code></h2><p><code>nn.Sequential</code>是一个有序的容器，其中传入的是构造器类(各种用来处理input的类)，最终input会被Sequential中的构造器类依次执行</p><p>例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">layer = nn.Sequential(<br>            nn.Linear(input_dim, n_hidden_1), <br>            nn.ReLU(<span class="hljs-literal">True</span>)， <span class="hljs-comment">#inplace=False 是否对输入进行就地修改，默认为False</span><br>            nn.Linear(n_hidden_1, n_hidden_2)，<br>            nn.ReLU(<span class="hljs-literal">True</span>)，<br>            nn.Linear(n_hidden_2, output_dim) <span class="hljs-comment"># 最后一层不需要添加激活函数</span><br>             )<br></code></pre></td></tr></table></figure><p>在上述就够中，可以直接调用layer(x)，得到输出</p><p>x的被执行顺序就是Sequential中定义的顺序：</p><ol><li>被隐层1执行，形状变为[batch_size,n_hidden_1]</li><li>被relu执行，形状不变</li><li>被隐层2执行，形状变为[batch_size,n_hidden_2]</li><li>被relu执行，形状不变</li><li>被最后一层执行，形状变为[batch_size,output_dim]</li></ol><h2 id="3-nn-BatchNorm1d"><a href="#3-nn-BatchNorm1d" class="headerlink" title="3. nn.BatchNorm1d"></a>3. <code>nn.BatchNorm1d</code></h2><p><code>batch normalization</code>  翻译成中文就是批规范化，即在每个batch训练的过程中，对参数进行归一化的处理，从而达到加快训练速度的效果。</p><p>以sigmoid激活函数为例，他在反向传播的过程中，在值为0,1的时候，梯度接近0，导致参数被更新的幅度很小，训练速度慢。但是如果对数据进行归一化之后，就会尽可能的把数据拉倒[0-1]的范围，从而让参数更新的幅度变大，提高训练的速度。</p><p>batchNorm一般会放到激活函数之后，即对输入进行激活处理之后再进入batchNorm</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">layer = nn.Sequential(<br>            nn.Linear(input_dim, n_hidden_1),<br>    <br>            nn.ReLU(<span class="hljs-literal">True</span>)， <br>    nn.BatchNorm1d(n_hidden_1)<br>    <br>            nn.Linear(n_hidden_1, n_hidden_2)，<br>            nn.ReLU(<span class="hljs-literal">True</span>)，<br>    nn.BatchNorm1d(n_hidden_2)<br><br>            nn.Linear(n_hidden_2, output_dim) <br>             )<br></code></pre></td></tr></table></figure><h2 id="4-nn-Dropout"><a href="#4-nn-Dropout" class="headerlink" title="4. nn.Dropout"></a>4. <code>nn.Dropout</code></h2><p>dropout在前面已经介绍过，可以理解为对参数的随机失活</p><ol><li>增加模型的稳健性</li><li>可以解决过拟合的问题（增加模型的泛化能力）</li><li>可以理解为训练后的模型是多个模型的组合之后的结果，类似随机森林。</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">layer = nn.Sequential(<br>            nn.Linear(input_dim, n_hidden_1),<br>            nn.ReLU(<span class="hljs-literal">True</span>)， <br>    nn.BatchNorm1d(n_hidden_1)<br>    nn.Dropout(<span class="hljs-number">0.3</span>) <span class="hljs-comment">#0.3 为dropout的比例，默认值为0.5</span><br>    <br>            nn.Linear(n_hidden_1, n_hidden_2)，<br>            nn.ReLU(<span class="hljs-literal">True</span>)，<br>    nn.BatchNorm1d(n_hidden_2)<br>    nn.Dropout(<span class="hljs-number">0.3</span>)<br>    <br>            nn.Linear(n_hidden_2, output_dim) <br>             )<br></code></pre></td></tr></table></figure><h1 id="走进聊天机器人"><a href="#走进聊天机器人" class="headerlink" title="走进聊天机器人"></a>走进聊天机器人</h1><h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2><ol><li>知道常见的bot的分类</li><li>知道企业中常见的流程和方法</li></ol><h2 id="1-目前企业中的常见的聊天机器人"><a href="#1-目前企业中的常见的聊天机器人" class="headerlink" title="1. 目前企业中的常见的聊天机器人"></a>1. 目前企业中的常见的聊天机器人</h2><ol><li>QA BOT（问答机器人）：回答问题<ol><li>代表 ：智能客服、</li><li>比如：提问和回答</li></ol></li><li>TASK BOT (任务机器人)：帮助人们做事情<ol><li>代表：siri</li><li>比如：设置明天早上9点的闹钟</li></ol></li><li>CHAT BOT(聊天机器人)：通用、开放聊天<ol><li>代表：微软小冰</li></ol></li></ol><h3 id="2-常见的聊天机器人怎么实现的"><a href="#2-常见的聊天机器人怎么实现的" class="headerlink" title="2. 常见的聊天机器人怎么实现的"></a>2. 常见的聊天机器人怎么实现的</h3><h5 id="2-1-问答机器人的常见实现手段"><a href="#2-1-问答机器人的常见实现手段" class="headerlink" title="2.1 问答机器人的常见实现手段"></a>2.1 问答机器人的常见实现手段</h5><ol><li><p>信息检索、搜索 （简单，效果一般，对数据问答对的要求高）</p><p>关键词：tfidf、SVM、朴素贝叶斯、RNN、CNN</p></li><li><p>知识图谱（相对复杂，效果好，很多论文）</p><p>在图形数据库中存储知识和知识间的关系、把问答转化为查询语句、能够实现推理</p></li></ol><h5 id="2-2-任务机器人的常见实现思路"><a href="#2-2-任务机器人的常见实现思路" class="headerlink" title="2.2 任务机器人的常见实现思路"></a>2.2 任务机器人的常见实现思路</h5><ol><li>语音转文字</li><li>意图识别、领域识别、文本分类</li><li>槽位填充：比如买机票的机器人 使用命令体识别填充 <code>从&#123;位置&#125;到&#123;位置&#125;的票</code>2个位置的</li><li>回话管理、回话策略</li><li>自然语言生成</li><li>文本转语音</li></ol><h5 id="2-3-闲聊机器人的常见实现思路"><a href="#2-3-闲聊机器人的常见实现思路" class="headerlink" title="2.3 闲聊机器人的常见实现思路"></a>2.3 闲聊机器人的常见实现思路</h5><ol><li>信息检索（简单、能够回答的话术有限）</li><li>seq2seq 和变种（答案覆盖率高，但是不能保证答案的通顺等）</li></ol><h2 id="3-企业中的聊天机器人是如何实现的"><a href="#3-企业中的聊天机器人是如何实现的" class="headerlink" title="3. 企业中的聊天机器人是如何实现的"></a>3. 企业中的聊天机器人是如何实现的</h2><h3 id="3-1-阿里小蜜-电商智能助理是如何实现的"><a href="#3-1-阿里小蜜-电商智能助理是如何实现的" class="headerlink" title="3.1 阿里小蜜-电商智能助理是如何实现的"></a>3.1 阿里小蜜-电商智能助理是如何实现的</h3><p>参考地址：<code>https://juejin.im/entry/59e96f946fb9a04510499c7f</code></p><h5 id="3-1-1-主要交互过程"><a href="#3-1-1-主要交互过程" class="headerlink" title="3.1.1 主要交互过程"></a>3.1.1 主要交互过程</h5><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%B0%8F%E8%9C%9C%E7%9A%84%E4%BA%A4%E4%BA%92%E8%BF%87%E7%A8%8B.png" alt="img"></p><p>从图可以看出：</p><ol><li>输入：语音转化为文本，进行理解之后根据上下文得到语义的表示</li><li>输出：根据语义的表是和生成方法得到文本，再把文本转化为语音输出</li></ol><h5 id="3-1-2-技术架构"><a href="#3-1-2-技术架构" class="headerlink" title="3.1.2 技术架构"></a>3.1.2 技术架构</h5><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%B0%8F%E8%9C%9C%E7%9A%84%E6%9E%B6%E6%9E%84.png"></p><p>可以看出其流程为：</p><ol><li>判断用户意图</li><li>如果意图为面向目标：可能是问答型或者是任务型</li><li>如果非面向目标：可能是语聊型</li></ol><h5 id="3-1-3-检索模型流程（小蜜还用了其他的模型，这里以此为例）"><a href="#3-1-3-检索模型流程（小蜜还用了其他的模型，这里以此为例）" class="headerlink" title="3.1.3 检索模型流程（小蜜还用了其他的模型，这里以此为例）"></a>3.1.3 检索模型流程（小蜜还用了其他的模型，这里以此为例）</h5><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%B0%8F%E8%9C%9C%E7%9A%84%E6%A3%80%E7%B4%A2%E6%B5%81%E7%A8%8B.png"></p><p>通过上图可知，小蜜的检索式回答的流程大致为：</p><ol><li>对问题进行处理</li><li>根据问题进行召回，使用了提前准备的结构化的语料和训练的模型</li><li>对召回的结果进行组长和日志记录</li><li>对召回的结果进行相似度计算，情感分析和属性识别</li><li>返回组装的结果</li></ol><h3 id="3-2-58同城智能客服帮帮如何实现的"><a href="#3-2-58同城智能客服帮帮如何实现的" class="headerlink" title="3.2 58同城智能客服帮帮如何实现的"></a>3.2 58同城智能客服帮帮如何实现的</h3><p>参考地址：<code>http://www.6aiq.com/article/1536149308075?p=1&amp;m=0</code></p><h4 id="3-2-1-58客服体系"><a href="#3-2-1-58客服体系" class="headerlink" title="3.2.1 58客服体系"></a>3.2.1 58客服体系</h4><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/q.jpeg"></p><p>58的客服主要用户为公司端和个人端，智能客服主要实现自动回答，如果回答不好会转到人工客服，其中自动回答需要覆盖的问题包括：业务咨询、投诉建议等</p><h4 id="3-2-2-58智能客服整体架构"><a href="#3-2-2-58智能客服整体架构" class="headerlink" title="3.2.2 58智能客服整体架构"></a>3.2.2 58智能客服整体架构</h4><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/q-16812675798501.jpeg"></p><p>整体来看，58的客服架构分为三个部分</p><ol><li>基础服务，实现基础的NLP的功能和意图识别</li><li>应用对话部分实现不同意图的模型，同时包括编辑运营等内容</li><li>提供对外的接口</li></ol><h4 id="3-2-3-业务咨询服务流程"><a href="#3-2-3-业务咨询服务流程" class="headerlink" title="3.2.3 业务咨询服务流程"></a>3.2.3 业务咨询服务流程</h4><h5 id="大致流程"><a href="#大致流程" class="headerlink" title="大致流程"></a>大致流程</h5><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/q-16812675798502.jpeg"></p><p>KB-bot的流程大致为：</p><ol><li>对问题进行基础处理</li><li>对答案通过tfidf等方法进行召回</li><li>对答案通过规则、深度神经网络等方法进行重排序</li><li>返回答案排序列表</li></ol><h5 id="使用融合的模型"><a href="#使用融合的模型" class="headerlink" title="使用融合的模型"></a>使用融合的模型</h5><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/q-16812675798503.jpeg"></p><p>在问答模型的深度网络模型中使用了多套模型进行融合来获取结果</p><ol><li>在模型层应用了 FastText、TextCNN 和 Bi-LSTM 等模型</li><li>在特征层尝试使用了单字、词、词性、词语属性等多种特征</li></ol><p>通过以上两个模型来组合获取相似的问题，返回相似问题ID对应的答案</p><h4 id="3-2-4-58的闲聊机器人"><a href="#3-2-4-58的闲聊机器人" class="headerlink" title="3.2.4 58的闲聊机器人"></a>3.2.4 58的闲聊机器人</h4><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/q-16812675798504.jpeg"></p><p>58同城的闲聊机器人使用三种方法包括：</p><ol><li>基于模板匹配的方法</li><li>基于搜索的方式获取（上上图）</li><li>使用seq2seq的神经网络来实现</li></ol><h4 id="3-2-5-解决不了转人工服务"><a href="#3-2-5-解决不了转人工服务" class="headerlink" title="3.2.5 解决不了转人工服务"></a>3.2.5 解决不了转人工服务</h4><p>​智能客服解决不了的可以使用人工客服来实现</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/q-16812675798505.jpeg"></p><h1 id="需求分析和流程介绍"><a href="#需求分析和流程介绍" class="headerlink" title="需求分析和流程介绍"></a>需求分析和流程介绍</h1><h2 id="目标-12"><a href="#目标-12" class="headerlink" title="目标"></a>目标</h2><ol><li>能够说出实现聊天机器人的需求</li><li>能够说出实现聊天机器人的流程</li></ol><h2 id="1-需求分析"><a href="#1-需求分析" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>在黑马头条的小智同学板块实现聊天机器人，能够起到<code>智能客服</code>的效果，能够为使用app的用户解决基础的问题，而不用额外的人力。</p><p>但是由于语料的限制，所以这里使用了编程相关的问题，能够回答类似：<code>python是什么</code>，<code>python有什么优势</code>等问题</p><h2 id="2-效果演示"><a href="#2-效果演示" class="headerlink" title="2. 效果演示"></a>2. 效果演示</h2><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/app%E6%88%AA%E5%9B%BE.png"></p><h2 id="3-实现流程"><a href="#3-实现流程" class="headerlink" title="3. 实现流程"></a>3. 实现流程</h2><h4 id="3-1-整体架构"><a href="#3-1-整体架构" class="headerlink" title="3.1 整体架构"></a>3.1 整体架构</h4><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84.png"></p><p>整个流程的描述如下：</p><ol><li>接受用户的问题之后，对问题进行基础的处理</li><li>对处理后的问题进行分类，判断其意图</li><li>如果用户希望闲聊，那么调用闲聊模型返回结果</li><li>如果用户希望咨询问题，那么调用问答模型返回结果</li></ol><h4 id="3-2-闲聊模型"><a href="#3-2-闲聊模型" class="headerlink" title="3.2 闲聊模型"></a>3.2 闲聊模型</h4><p>闲聊模型使用了seq2seq模型实现</p><p>包含：</p><ol><li>对数据的embedding</li><li>编码层</li><li>attention机制的处理</li><li>解码层</li></ol><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chabot.png"></p><h4 id="3-4-问答模型"><a href="#3-4-问答模型" class="headerlink" title="3.4 问答模型"></a>3.4 问答模型</h4><p>问答模型使用了召回和排序的机制来实现，保证获取的速度的同时保证了准确率</p><ol><li>问题分析：对问题进行基础的处理，包括分词，词性的获取，词向量的获取</li><li>问题的召回：通过机器学习的方法进行海选，海选出大致满足要求的相似问题的前K个</li><li>问题的排序：通过深度学习的模型对问题计算准确率，进行排序</li><li>设置阈值，返回结果</li></ol><p><img src="/..%5Cimages%5C2.1%5CQAbot.png"></p><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="目标-13"><a href="#目标-13" class="headerlink" title="目标"></a>目标</h2><ol><li>能够使用anaconda创建虚拟环境</li><li>能够安装fasttext</li><li>能够安装pysparnn</li></ol><h2 id="1-Anaconda环境准备"><a href="#1-Anaconda环境准备" class="headerlink" title="1. Anaconda环境准备"></a>1. Anaconda环境准备</h2><ol><li><p>下载地址：<code>https://mirror.tuna.tsinghua.edu.cn/help/anaconda/</code></p></li><li><p>下载对应电脑版本软件，安装</p><ol><li>windows ：双击exe文件</li><li>unix：给sh文件添加可执行权限，执行sh文件</li></ol></li><li><p>添加到环境变量</p><ol><li>windows安装过程中勾选</li><li>unix：<code>export PATH=&quot;/root/miniconda3/bin:$PATH&quot;</code></li></ol></li><li><p>创建虚拟环境</p><ol><li><code>conda create -n 名字 python=3.6(版本)</code></li><li>查看所有虚拟环境： <code>conda env list</code></li></ol></li><li><p>切换到虚拟环境</p><ol><li><code>conda activate 名字</code></li></ol></li><li><p>退出虚拟环境</p><ol><li><code>conda deactivate 名字</code></li></ol></li></ol><h2 id="2-fasttext安装"><a href="#2-fasttext安装" class="headerlink" title="2. fasttext安装"></a>2. fasttext安装</h2><p>文档地址：<code>https://fasttext.cc/docs/en/support.html</code></p><p>github地址：<code>&lt;https://github.com/facebookresearch/fastText</code></p><p>安装步骤：</p><ol><li>下载 <code>git clone https://github.com/facebookresearch/fastText.git</code></li><li>cd <code>cd fastText</code></li><li>安装 <code>python setup.py install</code></li></ol><h2 id="3-pysparnn安装"><a href="#3-pysparnn安装" class="headerlink" title="3. pysparnn安装"></a>3. pysparnn安装</h2><p>文档地址：<code>https://github.com/facebookresearch/pysparnn</code></p><p>安装步骤：</p><ol><li>下载：<code>git clone https://github.com/facebookresearch/pysparnn.git</code></li><li>安装：<code>python setupy.py install</code></li></ol><h1 id="语料准备"><a href="#语料准备" class="headerlink" title="语料准备"></a>语料准备</h1><h2 id="目标-14"><a href="#目标-14" class="headerlink" title="目标"></a>目标</h2><ol><li>准备分词词典</li><li>准备停用词</li><li>准备问答对</li><li>爬虫采集相似问题</li></ol><h2 id="1-分词词典"><a href="#1-分词词典" class="headerlink" title="1. 分词词典"></a>1. 分词词典</h2><p>最终词典的格式：</p><blockquote><p>词语   词性(不要和jieba默认的词性重复)</p></blockquote><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E8%AF%8D%E5%85%B8.png"></p><h4 id="1-1-词典来源"><a href="#1-1-词典来源" class="headerlink" title="1.1 词典来源"></a>1.1 词典来源</h4><ol><li><p>各种输入法的词典</p><p>例如：<code>https://pinyin.sogou.com/dict/cate/index/97?rf=dictindex</code></p><p>例如：<code>https://shurufa.baidu.com/dict_list?cid=211</code></p></li><li><p>手动收集，根据目前的需求，我们可以手动收集如下词典</p><ol><li>机构名称，例如：<code>传智</code>，<code>传智播客</code>,<code>黑马程序员</code></li><li>课程名词，例如：<code>python</code>,<code>人工智能+python</code>，<code>c++</code>等</li></ol></li></ol><h4 id="1-2-词典处理"><a href="#1-2-词典处理" class="headerlink" title="1.2 词典处理"></a>1.2 词典处理</h4><p>输入法的词典都是特殊格式，需要使用特殊的工具才能够把它转化为文本格式</p><p>工具名称：<code>深蓝词库转换.exe</code></p><p>下载地址：<code>https://github.com/studyzy/imewlconverter</code></p><h4 id="1-3-对多个词典文件内容进行合并"><a href="#1-3-对多个词典文件内容进行合并" class="headerlink" title="1.3 对多个词典文件内容进行合并"></a>1.3 对多个词典文件内容进行合并</h4><p>下载使用不同平台的多个词典之后,把所有的txt文件合并到一起供之后使用</p><h2 id="2-准备停用词"><a href="#2-准备停用词" class="headerlink" title="2. 准备停用词"></a>2. 准备停用词</h2><h4 id="2-1-什么是停用词？"><a href="#2-1-什么是停用词？" class="headerlink" title="2.1 什么是停用词？"></a>2.1 什么是停用词？</h4><p>对句子进行分词之后，句子中不重要的词</p><h4 id="2-2-停用词的准备"><a href="#2-2-停用词的准备" class="headerlink" title="2.2 停用词的准备"></a>2.2 停用词的准备</h4><p>常用停用词下载地址：<code>https://github.com/goto456/stopwords</code></p><h4 id="2-3-手动筛选和合并"><a href="#2-3-手动筛选和合并" class="headerlink" title="2.3 手动筛选和合并"></a>2.3 手动筛选和合并</h4><p>对于停用词的具体内容，不同场景下可能需要保留和去除的词语不一样</p><p>比如：词语<code>哪个</code>，很多场景可以删除，但是在判断语义的时候则不行</p><h2 id="3-问答对的准备"><a href="#3-问答对的准备" class="headerlink" title="3. 问答对的准备"></a>3. 问答对的准备</h2><h4 id="3-1-现有问答对的样式"><a href="#3-1-现有问答对的样式" class="headerlink" title="3.1 现有问答对的样式"></a>3.1 现有问答对的样式</h4><p>问答对有两部分，一部分是咨询老师整理的问答对，一部分是excel中的问答对，</p><p>最终我们需要把问答对分别整理到两个txt文档中，如下图（左边是问题，右边是答案）：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E9%97%AE%E7%AD%94%E5%AF%B9.png"></p><p>Excel中的问答对如下图：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/excel%E4%B8%AD%E7%9A%84%E9%97%AE%E9%A2%98.png"></p><h4 id="3-2-excel中问答对的处理"><a href="#3-2-excel中问答对的处理" class="headerlink" title="3.2 excel中问答对的处理"></a>3.2 excel中问答对的处理</h4><p>Excel中的问答对直接使用pandas就能够处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">python_qa_path = <span class="hljs-string">&quot;./data/Python短问答-11月汇总.xlsx&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_duanwenda</span>():<br>    <span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br>    ret = pd.read_excel(python_qa_path)<br>    column_list = ret.columns<br>    <span class="hljs-keyword">assert</span> <span class="hljs-string">&#x27;问题&#x27;</span> <span class="hljs-keyword">in</span> column_list <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;答案&quot;</span> <span class="hljs-keyword">in</span> column_list,<span class="hljs-string">&quot;excel 中必须包含问题和答案&quot;</span><br>    <span class="hljs-keyword">for</span> q,a <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(ret[<span class="hljs-string">&quot;问题&quot;</span>],ret[<span class="hljs-string">&quot;答案&quot;</span>]):<br>        q = re.sub(<span class="hljs-string">&quot;\s+&quot;</span>,<span class="hljs-string">&quot; &quot;</span>,q)<br>        q = q.strip()<br>        <span class="hljs-built_in">print</span>(q,a)<br></code></pre></td></tr></table></figure><h2 id="4-相似问答对的采集"><a href="#4-相似问答对的采集" class="headerlink" title="4. 相似问答对的采集"></a>4. 相似问答对的采集</h2><h4 id="4-1-采集相似问答对的目的"><a href="#4-1-采集相似问答对的目的" class="headerlink" title="4.1 采集相似问答对的目的"></a>4.1 采集相似问答对的目的</h4><p>后续在判断问题相似度的时候，需要有语料用来进行模型的训练，输入两个句子，输出相似度，这个语料不好获取，所以决定从百度知道入手，采集百度知道上面的相似问题，如下图所示：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E7%99%BE%E5%BA%A6%E7%9B%B8%E4%BC%BC%E9%97%AE%E9%A2%98%E6%90%9C%E7%B4%A2.png"></p><p>上面采集的数据会存在部分噪声，部分问题搜索到的结果语义上并不是太相似</p><h4 id="4-2-手动构造数据"><a href="#4-2-手动构造数据" class="headerlink" title="4.2 手动构造数据"></a>4.2 手动构造数据</h4><p>根据前面的问答对的内容，把问题大致分为了若干类型，对不同类型的问题设计模板，然后构造问题，问题模块如下：</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs autoit">templete = [<br><span class="hljs-meta">#概念</span><br>[<span class="hljs-string">&quot;&#123;kc&#125;&quot;</span>,<span class="hljs-string">&quot;什么是&#123;kc&#125;&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;是什么&quot;</span>,<span class="hljs-string">&quot;给我介绍一下&#123;kc&#125;&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;可以干什么&quot;</span>,<span class="hljs-string">&quot;能简单说下什么是&#123;kc&#125;吗&quot;</span>,<span class="hljs-string">&quot;我想了解&#123;kc&#125;&quot;</span>],<br><br><span class="hljs-meta">#课程优势</span><br>[<span class="hljs-string">&quot;&#123;kc&#125;课程有什么特点&quot;</span>,<span class="hljs-string">&quot;&#123;jgmc&#125;的&#123;kc&#125;课程有什么特点&quot;</span>,<span class="hljs-string">&quot;&#123;jgmc&#125;的&#123;kc&#125;课程有什么优势&quot;</span>,<span class="hljs-string">&quot;为什么我要来&#123;jgmc&#125;学习&#123;kc&#125;&quot;</span>,<span class="hljs-string">&quot;&#123;jgmc&#125;的&#123;kc&#125;课程有什么优势&quot;</span>,<span class="hljs-string">&quot;为什么要到&#123;jgmc&#125;学习&#123;kc&#125;&quot;</span>,<span class="hljs-string">&quot;&#123;jgmc&#125;的&#123;kc&#125;跟其他机构有什么区别？&quot;</span>,<span class="hljs-string">&quot;为什么选择&#123;jgmc&#125;来学习&#123;kc&#125;？&quot;</span>],<br><br><span class="hljs-meta">#语言优势</span><br><span class="hljs-meta">#[<span class="hljs-string">&quot;&#123;kc&#125;&quot;</span>,<span class="hljs-string">&quot;什么是&#123;kc&#125;&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;是什么&quot;</span>,<span class="hljs-string">&quot;给我介绍一下&#123;kc&#125;&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;可以干什么&quot;</span>,<span class="hljs-string">&quot;能简单说下什么是&#123;kc&#125;吗&quot;</span>], </span><br><span class="hljs-meta">#特点</span><br>[<span class="hljs-string">&quot;&#123;kc&#125;有什么特点&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;有什么优势&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;有什么亮点&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;有那些亮点&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;有那些优势&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;有那些特点&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的亮点是什么&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的优势是什么&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的特点是什么&quot;</span>],<br><span class="hljs-meta">#发展前景</span><br>[<span class="hljs-string">&quot;&#123;kc&#125;的发展怎么样？&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的前景怎么样？&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的发展前景如何？&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的未来怎样&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的前景好么&quot;</span> ],<br><span class="hljs-meta">#就业</span><br>[<span class="hljs-string">&quot;&#123;kc&#125;好就业么&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;就业机会多么&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的岗位多吗&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;工作好找吗&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的市场需求怎么样&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的就业环境怎么样&quot;</span>],<br><span class="hljs-meta">#就业方向</span><br>[<span class="hljs-string">&quot;&#123;kc&#125;学完以后能具体从事哪方面工作?&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的就业岗位有哪些？&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;课程学完应聘哪方面工作？&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;可以从事哪方面工作？&quot;</span>,],<br><span class="hljs-meta">#用途</span><br>[<span class="hljs-string">&quot;&#123;kc&#125;学完可以做什么&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;能干什么&quot;</span>,<span class="hljs-string">&quot;学&#123;kc&#125;能干什么&quot;</span>,<span class="hljs-string">&quot;能举例说下&#123;kc&#125;能做什么吗？&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;毕业了能干什么&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;主要应用在什么领域&quot;</span>],<br><span class="hljs-meta">#就业薪资</span><br>[<span class="hljs-string">&quot;&#123;kc&#125;学完工资多少&quot;</span>,<span class="hljs-string">&quot;学完&#123;kc&#125;能拿多少钱&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的就业薪资多少&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;就业的平均是工资多少&quot;</span>],<br><span class="hljs-meta">#学习难度</span><br>[<span class="hljs-string">&quot;&#123;kc&#125;简单么&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;容易么&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;课程容易么&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;上手快么&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;课程难么&quot;</span>],<br><span class="hljs-meta">#校区</span><br>[<span class="hljs-string">&quot;在那些城市开设了&#123;kc&#125;&quot;</span>,<span class="hljs-string">&quot;哪里可以学习&#123;kc&#125;&quot;</span>,<span class="hljs-string">&quot;学习&#123;kc&#125;可以去那些城市&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;在哪里开班了&quot;</span>],<br><span class="hljs-meta">#学费</span><br>[<span class="hljs-string">&quot;&#123;kc&#125;学费&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;多少钱&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的学费多少&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;是怎么收费的？&quot;</span>,<span class="hljs-string">&quot;学习&#123;kc&#125;要花多少钱&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;是怎么收费的&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;课程的价格&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;课程的价格是多少&quot;</span>],<br><span class="hljs-meta">#适合人群</span><br>[<span class="hljs-string">&quot;什么人可以学&#123;kc&#125;&quot;</span>,<span class="hljs-string">&quot;哪些人可以学&#123;kc&#125;&quot;</span>,<span class="hljs-string">&quot;学习&#123;kc&#125;有什么要求&quot;</span>,<span class="hljs-string">&quot;学习&#123;kc&#125;需要那些条件&quot;</span>,<span class="hljs-string">&quot;没有基础可以学&#123;kc&#125;吗&quot;</span>,<span class="hljs-string">&quot;学历低可以学习&#123;kc&#125;吗？&quot;</span>,<span class="hljs-string">&quot;成绩不好可以学习&#123;kc&#125;吗？&quot;</span>,<span class="hljs-string">&quot;什么样的人适合学习&#123;kc&#125;?&quot;</span>],<br><span class="hljs-meta">#学习时间</span><br>[<span class="hljs-string">&quot;&#123;kc&#125;需要学多久&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;需要多久才能就业&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;需要学习多长时间&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的学时是多少&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的课时是多少&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;课时&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;课时长度&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;的课程周期？&quot;</span>,<span class="hljs-string">&quot;0基础学&#123;kc&#125;多久能才就业&quot;</span>],<br><span class="hljs-meta">#学习内容</span><br>[<span class="hljs-string">&quot;&#123;kc&#125;学什么&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;学习那些内容&quot;</span>,<span class="hljs-string">&quot;我们在&#123;kc&#125;中学习那些内容&quot;</span>,<span class="hljs-string">&quot;在&#123;kc&#125;中大致都学习什么内容&quot;</span>],<br><span class="hljs-meta">#项目内容</span><br>[<span class="hljs-string">&quot;&#123;kc&#125;的项目有哪些&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;有哪些项目&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;上课都有哪些实战&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;做什么项目？&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;项目有多少个？&quot;</span>,<span class="hljs-string">&quot;&#123;kc&#125;课程中有项目吗？&quot;</span>],<br><span class="hljs-meta">#学习某课程的好处</span><br>[<span class="hljs-string">&quot;为什么要学习&#123;kc&#125;？&quot;</span>,<span class="hljs-string">&quot;学习&#123;kc&#125;有哪些好处？&quot;</span>,<span class="hljs-string">&quot;学习&#123;kc&#125;的理由？&quot;</span>,<span class="hljs-string">&quot;为什么我要来学习&#123;kc&#125;&quot;</span>],<br><span class="hljs-meta">#上课时间</span><br>[<span class="hljs-string">&quot;上课时间&quot;</span>,<span class="hljs-string">&quot;你们那边每天的上课时间是怎样的呢？&quot;</span>],<br><span class="hljs-meta">#英语要求</span><br>[<span class="hljs-string">&quot;学习&#123;kc&#125;对英语有要求么&quot;</span>,<span class="hljs-string">&quot;来&#123;jgmc&#125;学习对英语有要求吗？&quot;</span>]<br>]<br></code></pre></td></tr></table></figure><p>其中大括号的内容<code>kc</code>表示课程，<code>jgmc</code>表示机构名称</p><p>接下来，需要完成两件事</p><ol><li>最终我们会把前面准备好的课程字典和机构名称字典中的词语放入大括号中</li><li>把kc相同的内容构造成相似问题</li></ol><h1 id="文本分词"><a href="#文本分词" class="headerlink" title="文本分词"></a>文本分词</h1><h2 id="目标-15"><a href="#目标-15" class="headerlink" title="目标"></a>目标</h2><ol><li>完成停用词的准备</li><li>完成分词方法的封装</li></ol><h2 id="1-准备词典和停用词"><a href="#1-准备词典和停用词" class="headerlink" title="1. 准备词典和停用词"></a>1. 准备词典和停用词</h2><h3 id="1-1-准备词典"><a href="#1-1-准备词典" class="headerlink" title="1.1 准备词典"></a>1.1 准备词典</h3><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E8%AF%8D%E5%85%B8-168126759923612.png"></p><h3 id="1-2-准备停用词"><a href="#1-2-准备停用词" class="headerlink" title="1.2 准备停用词"></a>1.2 准备停用词</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">stopwords = <span class="hljs-built_in">set</span>([i.strip() <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">open</span>(config.stopwords_path).readlines()])<br></code></pre></td></tr></table></figure><h2 id="2-准备按照单个字切分句子的方法"><a href="#2-准备按照单个字切分句子的方法" class="headerlink" title="2. 准备按照单个字切分句子的方法"></a>2. 准备按照单个字切分句子的方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_cut_by_word</span>(<span class="hljs-params">sentence</span>):<br>    <span class="hljs-comment"># 对中文按照字进行处理，对英文不分为字母</span><br>    sentence = re.sub(<span class="hljs-string">&quot;\s+&quot;</span>,<span class="hljs-string">&quot; &quot;</span>,sentence)<br>    sentence = sentence.strip()<br>    result = []<br>    temp = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> sentence:<br>        <span class="hljs-keyword">if</span> word.lower() <span class="hljs-keyword">in</span> letters:<br>            temp += word.lower()<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> temp != <span class="hljs-string">&quot;&quot;</span>: <span class="hljs-comment">#不是字母</span><br>                result.append(temp)<br>                temp = <span class="hljs-string">&quot;&quot;</span><br>            <span class="hljs-keyword">if</span> word.strip() <span class="hljs-keyword">in</span> filters: <span class="hljs-comment">#标点符号</span><br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">else</span>: <span class="hljs-comment">#是单个字</span><br>                result.append(word)<br>    <span class="hljs-keyword">if</span> temp != <span class="hljs-string">&quot;&quot;</span>: <span class="hljs-comment">#最后的temp中包含字母</span><br>        result.append(temp)<br>    <span class="hljs-keyword">return</span> result<br></code></pre></td></tr></table></figure><h2 id="3-完成分词方法的封装"><a href="#3-完成分词方法的封装" class="headerlink" title="3. 完成分词方法的封装"></a>3. 完成分词方法的封装</h2><p>lib 下创建<code>cut_sentence.py</code>文件，完成分词方法的构建</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> jieba<br><span class="hljs-keyword">import</span> jieba.posseg <span class="hljs-keyword">as</span> psg<br><span class="hljs-keyword">import</span> config<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> string<br><br><span class="hljs-comment">#关闭jieba log输出</span><br>jieba.setLogLevel(logging.INFO)<br><span class="hljs-comment">#加载词典</span><br>jieba.load_userdict(config.keywords_path)<br><span class="hljs-comment">#单字分割，英文部分</span><br>letters = string.ascii_lowercase<br><span class="hljs-comment">#单字分割 去除的标点</span><br>filters= [<span class="hljs-string">&quot;,&quot;</span>,<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;.&quot;</span>,<span class="hljs-string">&quot; &quot;</span>]<br><span class="hljs-comment">#停用词</span><br>stopwords = <span class="hljs-built_in">set</span>([i.strip() <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">open</span>(config.stopwords_path).readlines()])<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cut</span>(<span class="hljs-params">sentence,by_word=<span class="hljs-literal">False</span>,use_stopwords=<span class="hljs-literal">False</span>,with_sg=<span class="hljs-literal">False</span></span>):<br>    <span class="hljs-keyword">assert</span> by_word!=<span class="hljs-literal">True</span> <span class="hljs-keyword">or</span> with_sg!=<span class="hljs-literal">True</span>,<span class="hljs-string">&quot;根据word切分时候无法返回词性&quot;</span><br>    <span class="hljs-keyword">if</span> by_word:<br>        <span class="hljs-keyword">return</span> _cut_by_word(sentence)<br>    <span class="hljs-keyword">else</span>:<br>        ret = psg.lcut(sentence)<br>        <span class="hljs-keyword">if</span> use_stopwords:<br>            ret = [(i.word,i.flag) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ret <span class="hljs-keyword">if</span> i.word <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> stopwords]<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> with_sg:<br>            ret = [i.word <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ret]<br>        <span class="hljs-keyword">return</span> ret<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_cut_by_word</span>(<span class="hljs-params">sentence</span>):<br>    <span class="hljs-comment"># 对中文按照字进行处理，对英文不分为字母</span><br>    sentence = re.sub(<span class="hljs-string">&quot;\s+&quot;</span>,<span class="hljs-string">&quot; &quot;</span>,sentence)<br>    sentence = sentence.strip()<br>    result = []<br>    temp = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> sentence:<br>        <span class="hljs-keyword">if</span> word.lower() <span class="hljs-keyword">in</span> letters:<br>            temp += word.lower()<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> temp != <span class="hljs-string">&quot;&quot;</span>: <span class="hljs-comment">#不是字母</span><br>                result.append(temp)<br>                temp = <span class="hljs-string">&quot;&quot;</span><br>            <span class="hljs-keyword">if</span> word.strip() <span class="hljs-keyword">in</span> filters: <span class="hljs-comment">#标点符号</span><br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">else</span>: <span class="hljs-comment">#是单个字</span><br>                result.append(word)<br>    <span class="hljs-keyword">if</span> temp != <span class="hljs-string">&quot;&quot;</span>: <span class="hljs-comment">#最后的temp中包含字母</span><br>        result.append(temp)<br>    <span class="hljs-keyword">return</span> result<br></code></pre></td></tr></table></figure><h1 id="动手练习"><a href="#动手练习" class="headerlink" title="动手练习"></a>动手练习</h1><h2 id="目标-16"><a href="#目标-16" class="headerlink" title="目标"></a>目标</h2><ol><li>动手准备好词典</li><li>动手准备问答对</li><li>动手构造问答对</li><li>对问题进行分词，单独存储</li></ol><h1 id="分类的目的和分类的方法"><a href="#分类的目的和分类的方法" class="headerlink" title="分类的目的和分类的方法"></a>分类的目的和分类的方法</h1><h2 id="目标-17"><a href="#目标-17" class="headerlink" title="目标"></a>目标</h2><ol><li>能够说出项目中进行文本的目的</li><li>能够说出意图识别的方法</li><li>能够说出常见的分类的方法</li></ol><h2 id="1-文本分类的目的"><a href="#1-文本分类的目的" class="headerlink" title="1. 文本分类的目的"></a>1. 文本分类的目的</h2><p>回顾之前的流程，我们可以发现文本分类的目的就是为了进行<strong>意图识别</strong></p><p>在当前我们的项目的下，我们只有两种意图需要被识别出来，所以对应的是<strong>2分类</strong>的问题</p><p>可以想象，如果我们的聊天机器人有多个功能，那么我们需要分类的类别就有多个，这样就是一个<strong>多分类</strong>的问题。例如，如果希望聊天机器人能够播报当前的时间，那么我们就需要准备关于询问时间的语料，同时其目标值就是一个新的类别。在训练后，通过这个新的模型，判断出用户询问的是当前的时间这个类别，那么就返回当前的时间。</p><p>同理，如果还希望聊天机器人能够播报未来某一天的天气，那么这个机器人就还需要增加一个新的进行分类的意图，重新进行训练</p><h2 id="2-机器学习中常见的分类方法"><a href="#2-机器学习中常见的分类方法" class="headerlink" title="2. 机器学习中常见的分类方法"></a>2. 机器学习中常见的分类方法</h2><p>在前面的机器学习的课程中我们学习了<strong>朴素贝叶斯</strong>，<strong>决策树</strong>等方法都能够帮助我们进行文本的分类，那么我们具体该怎么做呢？</p><h3 id="2-1-步骤"><a href="#2-1-步骤" class="headerlink" title="2.1 步骤"></a>2.1 步骤</h3><ol><li>特征工程：对文本进行处理，转化为能够被计算的向量来表示。我们可以考虑使用所有词语的出现次数，也可以考虑使用tfidf这种方法来处理</li><li>对模型进行训练</li><li>对模型进行评估</li></ol><h3 id="2-2-优化"><a href="#2-2-优化" class="headerlink" title="2.2 优化"></a>2.2 优化</h3><p>使用机器学习的方法进行文本分类的时候，为了让结果更好，我们经常从两个角度出发</p><ol><li>特征工程的过程中处理的更加细致，比如文本中类似<strong>你，我，他</strong>这种词语可以把它剔除；某些词语出现的次数太少，可能并不具有代表意义；某些词语出现的次数太多，可能导致影响的程度过大等等都是我们可以考虑的地方</li><li>使用不同的算法进行训练，获取不同算法的结果，选择最好的，或者是使用集成学习方法</li></ol><h2 id="3-深度学习实现文本分类"><a href="#3-深度学习实现文本分类" class="headerlink" title="3. 深度学习实现文本分类"></a>3. 深度学习实现文本分类</h2><p>前面我们简单回顾了使用机器学习如何来进行文本分类，那么使用深度学习该如何实现呢？</p><p>在深度学习中我们常见的操作就是：</p><ol><li>对文本进行embedding的操作，转化为向量</li><li>之后再通过多层的神经网络进行线性和非线性的变化得到结果</li><li>变换后的结果和目标值进行计算得到损失函数，比如对数似然损失等</li><li>通过最小化损失函数，去更新原来模型中的参数</li></ol><h1 id="fastText实现文本分类"><a href="#fastText实现文本分类" class="headerlink" title="fastText实现文本分类"></a>fastText实现文本分类</h1><h2 id="目标-18"><a href="#目标-18" class="headerlink" title="目标"></a>目标</h2><ol><li>知道fastext是什么</li><li>能够应用fasttext进行文本分类</li><li>能够完成项目中意图识别的代码</li></ol><h2 id="1-fastText的介绍"><a href="#1-fastText的介绍" class="headerlink" title="1.  fastText的介绍"></a>1.  fastText的介绍</h2><p>文档地址：<code>https://fasttext.cc/docs/en/support.html</code></p><p>fastText is a library for efficient learning of word representations and sentence classification.</p><p>fastText是一个单词表示学习和文本分类的库</p><p>优点：在标准的多核CPU上， 在10分钟之内能够训练10亿词级别语料库的词向量，能够在1分钟之内给30万多类别的50多万句子进行分类。</p><p>fastText 模型输入一个词的序列（一段文本或者一句话)，输出这个词序列属于不同类别的概率。</p><h2 id="2-安装和基本使用"><a href="#2-安装和基本使用" class="headerlink" title="2. 安装和基本使用"></a>2. 安装和基本使用</h2><h3 id="2-1-安装步骤："><a href="#2-1-安装步骤：" class="headerlink" title="2.1 安装步骤："></a>2.1 安装步骤：</h3><ol><li>下载 <code>git clone https://github.com/facebookresearch/fastText.git</code></li><li>cd <code>cd fastText</code></li><li>安装 <code>python setup.py install</code></li></ol><h4 id="2-2-基本使用"><a href="#2-2-基本使用" class="headerlink" title="2.2 基本使用"></a>2.2 基本使用</h4><ol><li><p>把数据准备为需要的格式</p></li><li><p>进行模型的训练、保存和加载、预测</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#1. 训练</span><br>model = fastText.train_supervised(<span class="hljs-string">&quot;./data/text_classify.txt&quot;</span>,wordNgrams=<span class="hljs-number">1</span>,epoch=<span class="hljs-number">20</span>)<br><span class="hljs-comment">#2. 保存</span><br>model.save_model(<span class="hljs-string">&quot;./data/ft_classify.model&quot;</span>)<br><span class="hljs-comment">#3. 加载</span><br>model = fastText.load_model(<span class="hljs-string">&quot;./data/ft_classify.model&quot;</span>)<br><br>textlist = [句子<span class="hljs-number">1</span>，句子<span class="hljs-number">2</span>]<br><span class="hljs-comment">#4. 预测，传入句子列表</span><br>ret = model.predict(textlist)<br></code></pre></td></tr></table></figure></li></ol><h2 id="3-意图识别实现"><a href="#3-意图识别实现" class="headerlink" title="3.  意图识别实现"></a>3.  意图识别实现</h2><h3 id="3-1-数据准备"><a href="#3-1-数据准备" class="headerlink" title="3.1 数据准备"></a>3.1 数据准备</h3><p>数据准备最终需要的形式如下：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%871.png"></p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%872.png"></p><p>以上格式是fastText要求的格式，其中chat、QA字段可以自定义，就是目标值，<code>__label__</code>之前的为特征值，需要使用<code>\t</code>进行分隔，特征值需要进行分词，<code>__label__</code>后面的是目标值</p><h4 id="3-1-1-准备特征文本"><a href="#3-1-1-准备特征文本" class="headerlink" title="3.1.1 准备特征文本"></a>3.1.1 准备特征文本</h4><p>使用之前通过模板构造的样本和通过爬虫抓取的百度上的相似问题，</p><h4 id="3-1-2-准备闲聊文本"><a href="#3-1-2-准备闲聊文本" class="headerlink" title="3.1.2 准备闲聊文本"></a>3.1.2 准备闲聊文本</h4><p>使用小黄鸡的语料，地址：<a href="https://github.com/fateleak/dgk_lost_conv/tree/master/results">https://github.com/fateleak/dgk_lost_conv/tree/master/results</a></p><h4 id="3-1-3-把文本转化为需要的格式"><a href="#3-1-3-把文本转化为需要的格式" class="headerlink" title="3.1.3 把文本转化为需要的格式"></a>3.1.3 把文本转化为需要的格式</h4><p>对两部分文本进行分词、合并，转化为需要的格式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">prepar_data</span>():<br>    <span class="hljs-comment">#小黄鸡 作为闲聊</span><br>    xiaohaungji = <span class="hljs-string">&quot;./corpus/recall/小黄鸡未分词.conv&quot;</span><br>    handle_chat_corpus(xiaohaungji)<br>    <span class="hljs-comment"># mongodb中的数据，问题和相似问题作为 问答</span><br>    handle_mongodb_corpus()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">keywords_in_line</span>(<span class="hljs-params">line</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;相似问题中去除关键字不在其中的句子</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    keywords_list = [<span class="hljs-string">&quot;传智播客&quot;</span>,<span class="hljs-string">&quot;传智&quot;</span>,<span class="hljs-string">&quot;黑马程序员&quot;</span>,<span class="hljs-string">&quot;黑马&quot;</span>,<span class="hljs-string">&quot;python&quot;</span><br>    <span class="hljs-string">&quot;人工智能&quot;</span>,<span class="hljs-string">&quot;c语言&quot;</span>,<span class="hljs-string">&quot;c++&quot;</span>,<span class="hljs-string">&quot;java&quot;</span>,<span class="hljs-string">&quot;javaee&quot;</span>,<span class="hljs-string">&quot;前端&quot;</span>,<span class="hljs-string">&quot;移动开发&quot;</span>,<span class="hljs-string">&quot;ui&quot;</span>,<br>    <span class="hljs-string">&quot;ue&quot;</span>,<span class="hljs-string">&quot;大数据&quot;</span>,<span class="hljs-string">&quot;软件测试&quot;</span>,<span class="hljs-string">&quot;php&quot;</span>,<span class="hljs-string">&quot;h5&quot;</span>,<span class="hljs-string">&quot;产品经理&quot;</span>,<span class="hljs-string">&quot;linux&quot;</span>,<span class="hljs-string">&quot;运维&quot;</span>,<span class="hljs-string">&quot;go语言&quot;</span>,<br>    <span class="hljs-string">&quot;区块链&quot;</span>,<span class="hljs-string">&quot;影视制作&quot;</span>,<span class="hljs-string">&quot;pmp&quot;</span>,<span class="hljs-string">&quot;项目管理&quot;</span>,<span class="hljs-string">&quot;新媒体&quot;</span>,<span class="hljs-string">&quot;小程序&quot;</span>,<span class="hljs-string">&quot;前端&quot;</span>]<br>    <span class="hljs-keyword">for</span> keyword <span class="hljs-keyword">in</span> keywords_list:<br>        <span class="hljs-keyword">if</span> keyword <span class="hljs-keyword">in</span> line:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_chat_corpus</span>(<span class="hljs-params">path</span>):<br>    chat_num = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./corpus/recall/text_classify.txt&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>) <span class="hljs-keyword">as</span> f:<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> <span class="hljs-built_in">open</span>(path,<span class="hljs-string">&quot;r&quot;</span>):<br>            <span class="hljs-keyword">if</span> line.strip() == <span class="hljs-string">&quot;E&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(line.strip())&lt;<span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">elif</span> keywords_in_line(line):<br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">elif</span> line.startswith(<span class="hljs-string">&quot;M&quot;</span>):<br>                line = line[<span class="hljs-number">2</span>:]<br>                line = re.sub(<span class="hljs-string">&quot;\s+&quot;</span>,<span class="hljs-string">&quot; &quot;</span>,line)<br>                line_cuted = <span class="hljs-string">&quot; &quot;</span>.join(jieba_cut(line.strip())).strip()<br>                lable = <span class="hljs-string">&quot;\t__label__&#123;&#125;\n&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-string">&quot;chat&quot;</span>)<br>                f.write(line_cuted+lable)<br>                chat_num +=<span class="hljs-number">1</span><br>    <span class="hljs-built_in">print</span>(chat_num)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_QA_corpus</span>():<br>  <br>    by_hand_data_path = <span class="hljs-string">&quot;./corpus/recall/手动构造的问题.json&quot;</span> <span class="hljs-comment">#手动构造的数据</span><br>    by_hand_data = json.load(<span class="hljs-built_in">open</span>(by_hand_data_path))<br><br>    qa_num = <span class="hljs-number">0</span><br><br>    f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./corpus/recall/text_classify.txt&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> by_hand_data:<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> by_hand_data[i]:<br>            <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> j:<br>                x = re.sub(<span class="hljs-string">&quot;\s+&quot;</span>, <span class="hljs-string">&quot; &quot;</span>, x)<br>                line_cuted = <span class="hljs-string">&quot; &quot;</span>.join(jieba_cut(x.strip())).strip()<br>                lable = <span class="hljs-string">&quot;\t__label__&#123;&#125;\n&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-string">&quot;QA&quot;</span>)<br>                f.write(line_cuted + lable)<br>                qa_num+=<span class="hljs-number">1</span><br><br>    <span class="hljs-comment">#mogodb导出的数据</span><br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./corpus/recall/爬虫抓取的问题.csv&quot;</span>):<br>        line = re.sub(<span class="hljs-string">&quot;\s+&quot;</span>, <span class="hljs-string">&quot; &quot;</span>, line)<br>        line_cuted = <span class="hljs-string">&quot; &quot;</span>.join(jieba_cut(line.strip()))<br>        lable = <span class="hljs-string">&quot;\t__label__&#123;&#125;\n&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-string">&quot;QA&quot;</span>)<br>        f.write(line_cuted + lable)<br>        qa_num += <span class="hljs-number">1</span><br><br>    f.close()<br>    <span class="hljs-built_in">print</span>(qa_num)<br></code></pre></td></tr></table></figure><h4 id="3-1-4-思考："><a href="#3-1-4-思考：" class="headerlink" title="3.1.4 思考："></a>3.1.4 思考：</h4><p>是否可以把文本分割为单个字作为特征呢？</p><p>修改上述代码，准备一份以单个字作为特征的符合要求的文本</p><h3 id="3-2-模型的训练"><a href="#3-2-模型的训练" class="headerlink" title="3.2 模型的训练"></a>3.2 模型的训练</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> fastText<br><span class="hljs-keyword">import</span> pickle<br><br>logging.basicConfig(<span class="hljs-built_in">format</span>=<span class="hljs-string">&#x27;%(asctime)s : %(levelname)s : %(message)s&#x27;</span>, level=logging.DEBUG)<br><br><br>ft_model = fastText.train_supervised(<span class="hljs-string">&quot;./data/text_classify.txt&quot;</span>,wordNgrams=<span class="hljs-number">1</span>,epoch=<span class="hljs-number">20</span>)<br>ft_model.save_model(<span class="hljs-string">&quot;./data/ft_classify.model&quot;</span>)<br></code></pre></td></tr></table></figure><p>训练完成后看看测试的结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">ft_model = fastText.load_model(<span class="hljs-string">&quot;./data/ft_classify.model&quot;</span>)<br><br>textlist = [<br>    <span class="hljs-comment"># &quot;人工智能 和 人工智障 有 啥 区别&quot;, #QA</span><br>    <span class="hljs-comment"># &quot;我 来 学 python 是不是 脑袋 有 问题 哦&quot;, #QA</span><br>    <span class="hljs-comment"># &quot;什么 是 python&quot;, #QA</span><br>    <span class="hljs-comment"># &quot;人工智能 和 python 有 什么 区别&quot;,  #QA</span><br>    <span class="hljs-comment"># &quot;为什么 要 学 python&quot;, #QA</span><br>    <span class="hljs-comment"># &quot;python 该 怎么 学&quot;,  #CHAT</span><br>    <span class="hljs-comment"># &quot;python&quot;, #QA</span><br>    <span class="hljs-string">&quot;jave&quot;</span>, <span class="hljs-comment">#CHAT</span><br>    <span class="hljs-string">&quot;php&quot;</span>, <span class="hljs-comment">#QA</span><br>    <span class="hljs-string">&quot;理想 很 骨感 ，现实 很 丰满&quot;</span>,<br>    <span class="hljs-string">&quot;今天 天气 真好 啊&quot;</span>,<br>    <span class="hljs-string">&quot;你 怎么 可以 这样 呢&quot;</span>,<br>    <span class="hljs-string">&quot;哎呀 ， 我 错 了&quot;</span>,<br>]<br>ret = ft_model.predict(textlist)<br><span class="hljs-built_in">print</span>(ret)<br></code></pre></td></tr></table></figure><h4 id="3-2-2-模型的准确率该如何观察呢？"><a href="#3-2-2-模型的准确率该如何观察呢？" class="headerlink" title="3.2.2 模型的准确率该如何观察呢？"></a>3.2.2 模型的准确率该如何观察呢？</h4><p>观察准备去，首先需要对文本进行划分，分为训练集和测试集，之后再使用测试集观察模型的准确率</p><h3 id="3-3-模型的封装"><a href="#3-3-模型的封装" class="headerlink" title="3.3 模型的封装"></a>3.3 模型的封装</h3><p>为了在项目中更好的使用模型，需要对模型进行简单的封装，输入文本，返回结果</p><p>这里我们可以使用把单个字作为特征和把词语作为特征的手段结合起来实现</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">构造模型进行预测</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> fastText<br><span class="hljs-keyword">import</span> config<br><span class="hljs-keyword">from</span> lib <span class="hljs-keyword">import</span> cut<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Classify</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.ft_word_model = fastText.load_model(config.fasttext_word_model_path)<br>        self.ft_model = fastText.load_model(config.fasttext_model_path)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_qa</span>(<span class="hljs-params">self,sentence_info</span>):<br>        python_qs_list = [<span class="hljs-string">&quot; &quot;</span>.join(sentence_info[<span class="hljs-string">&quot;cuted_sentence&quot;</span>])]<br>        result = self.ft_mode.predict(python_qs_list)<br><br>        python_qs_list = [<span class="hljs-string">&quot; &quot;</span>.join(cut(sentence_info[<span class="hljs-string">&quot;sentence&quot;</span>],by_word=<span class="hljs-literal">True</span>))]<br>        words_result = self.ft_word_mode.predict(python_qs_list)<br><br>        acc,word_acc = self.get_qa_prob(result,words_result)<br>        <span class="hljs-keyword">if</span> acc&gt;<span class="hljs-number">0.95</span> <span class="hljs-keyword">or</span> word_acc&gt;<span class="hljs-number">0.95</span>:<br>            <span class="hljs-comment">#是QA</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_qa_prob</span>(<span class="hljs-params">self,result,words_result</span>):<br>        label, acc, word_label, word_acc = <span class="hljs-built_in">zip</span>(*result, *words_result)<br>        label = label[<span class="hljs-number">0</span>]<br>        acc = acc[<span class="hljs-number">0</span>]<br>        word_label = word_label[<span class="hljs-number">0</span>]<br>        word_acc = word_acc[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">if</span> label == <span class="hljs-string">&quot;__label__chat&quot;</span>:<br>            acc = <span class="hljs-number">1</span> - acc<br>        <span class="hljs-keyword">if</span> word_label == <span class="hljs-string">&quot;__label__chat&quot;</span>:<br>            word_acc = <span class="hljs-number">1</span> - word_acc<br>        <span class="hljs-keyword">return</span> acc,word_acc<br></code></pre></td></tr></table></figure><h1 id="fastText的原理剖析"><a href="#fastText的原理剖析" class="headerlink" title="fastText的原理剖析"></a>fastText的原理剖析</h1><h2 id="目标-19"><a href="#目标-19" class="headerlink" title="目标"></a>目标</h2><ol><li>能够说出fasttext的架构</li><li>能够说出fasttext速度快的原因</li><li>能够说出fastText中层次化的softmax是如何实现的</li></ol><h2 id="1-fastText的模型架构"><a href="#1-fastText的模型架构" class="headerlink" title="1. fastText的模型架构"></a>1. fastText的模型架构</h2><p>fastText的架构非常简单，有三层：输入层、隐含层、输出层（Hierarchical Softmax）</p><p>输入层：是对文档embedding之后的向量，包含有N-garm特征</p><p>隐藏层：是对输入数据的求和平均</p><p>输出层：是文档对应标签</p><p>如下图所示：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/fasttext%E5%8E%9F%E7%90%86.jpg"></p><h3 id="1-1-N-garm的理解"><a href="#1-1-N-garm的理解" class="headerlink" title="1.1 N-garm的理解"></a>1.1 N-garm的理解</h3><h3 id="1-1-1-bag-of-word"><a href="#1-1-1-bag-of-word" class="headerlink" title="1.1.1 bag of word"></a>1.1.1 bag of word</h3><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/bow%E6%A8%A1%E5%9E%8B.png"></p><p>bag of word 又称为bow，称为词袋。是一种只统计词频的手段。</p><p>例如：在机器学习的课程中通过朴素贝叶斯来预测文本的类别，我们学习的countVectorizer和TfidfVectorizer都可以理解为一种bow模型。</p><h3 id="1-1-2-N-gram模型"><a href="#1-1-2-N-gram模型" class="headerlink" title="1.1.2 N-gram模型"></a>1.1.2 N-gram模型</h3><p>但是在很多情况下，词袋模型是不满足我们的需求的。</p><p>例如：<code>我爱她</code>  和<code>她爱我</code>在词袋模型下面，概率完全相同，但是其含义确实差别非常大。</p><p>为了解决这个问题，就有了N-gram模型，它不仅考虑词频，还会考虑当前词前面的词语，比如<code>我爱</code>，<code>她爱</code>。</p><p>N-gram模型的描述是：第n个词出现与前n-1个词相关，而与其他任何词不相关。（当然在很多场景下和前n-1个词也会相关，但是为了简化问题，经常会这样去计算）</p><p>例如：<code>I love deep learning</code>这个句子，在n&#x3D;2的情况下，可以表示为<code>&#123;i love&#125;,&#123;love deep&#125;,&#123;deep learning&#125;，</code>n&#x3D;3的情况下，可以表示为<code>&#123;I love deep&#125;,&#123;love deep learning&#125;</code>。</p><p>在n&#x3D;2的情况下，这个模型被称为Bi-garm（二元n-garm模型）</p><p>在n&#x3D;3 的情况下，这个模型被称为Tri-garm（三元n-garm模型）</p><p>具体可以参考 <a href="http://web.stanford.edu/~jurafsky/slp3/ed3book.pdf">ed3book chapter3 </a></p><p>所以在fasttext的输入层，不仅有分词之后的词语，还有包含有N-gram的组合词语一起作为输入</p><h2 id="2-fastText中的层次化的softmax-对传统softmax的优化方法1"><a href="#2-fastText中的层次化的softmax-对传统softmax的优化方法1" class="headerlink" title="2. fastText中的层次化的softmax-对传统softmax的优化方法1"></a>2. fastText中的层次化的softmax-对传统softmax的优化方法1</h2><p>为了提高效率，在fastText中计算分类标签的概率的时候，不再是使用传统的softmax来进行多分类的计算，而是使用的哈夫曼树(Huffman，也成为霍夫曼树),使用层次化的softmax（Hierarchial softmax）来进行概率的计算。</p><h3 id="2-1-哈夫曼树和哈夫曼编码"><a href="#2-1-哈夫曼树和哈夫曼编码" class="headerlink" title="2.1 哈夫曼树和哈夫曼编码"></a>2.1 哈夫曼树和哈夫曼编码</h3><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/Inked%E5%93%88%E5%A4%AB%E6%9B%BC%E6%A0%91.jpg"></p><h4 id="2-1-1-哈夫曼树的定义"><a href="#2-1-1-哈夫曼树的定义" class="headerlink" title="2.1.1 哈夫曼树的定义"></a>2.1.1 哈夫曼树的定义</h4><p>哈夫曼树概念：给定n个权值作为n个叶子结点，构造一棵二叉树，若该树的带权路径长度达到最小，称这样的二叉树为最优二叉树，也称为哈夫曼树(Huffman Tree)。</p><p>哈夫曼树是带权路径长度最短的树，权值较大的结点离根较近。</p><h4 id="2-1-2-哈夫曼树的相关概念"><a href="#2-1-2-哈夫曼树的相关概念" class="headerlink" title="2.1.2 哈夫曼树的相关概念"></a>2.1.2 哈夫曼树的相关概念</h4><p><strong>二叉树</strong>：每个节点最多有2个子树的有序树，两个子树分别称为左子树、右子树。有序的意思是：树有左右之分，不能颠倒</p><p><strong>叶子节点</strong>：一棵树当中没有子结点的结点称为叶子结点，简称“叶子”</p><p><strong>路径和路径长度</strong>：在一棵树中，从一个结点往下可以达到的孩子或孙子结点之间的通路，称为路径。通路中分支的数目称为路径长度。若规定根结点的层数为1，则从根结点到第L层结点的路径长度为L-1。</p><p><strong>结点的权及带权路径长度</strong>：若将树中结点赋给一个有着某种含义的数值，则这个数值称为该结点的权。结点的带权路径长度为：从根结点到该结点之间的路径长度与该结点的权的<strong>乘积</strong>。</p><p><strong>树的带权路径长度</strong>：树的带权路径长度规定为所有叶子结点的带权路径长度之和</p><p><strong>树的高度</strong>：树中结点的最大层次。包含n个结点的二叉树的高度至少为**log2 (n+1)**。</p><h4 id="2-1-3-哈夫曼树的构造算法"><a href="#2-1-3-哈夫曼树的构造算法" class="headerlink" title="2.1.3 哈夫曼树的构造算法"></a>2.1.3 哈夫曼树的构造算法</h4><ol><li>把${W_1,W_2,W_3 \dots W_n}$看成n棵树的森林</li><li>在森林中选择两个根节点权值最小的树进行合并，作为一颗新树的左右子树，新树的根节点权值为左右子树的和</li><li>删除之前选择出的子树，把新树加入森林</li><li>重复2-3步骤，直到森林只有一棵树为止，概树就是所求的哈夫曼树</li></ol><p>例如：圆圈中的表示每个词语出现的次数，以这些词语为叶子节点构造的哈夫曼树过程如下：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%93%88%E5%A4%AB%E6%9B%BC%E6%A0%91%E6%9E%84%E9%80%A0%E8%BF%87%E7%A8%8B.png"></p><p>可见：</p><ol><li>权重越大，距离根节点越近</li><li>叶子的个数为n，构造哈夫曼树中新增的节点的个数为n-1</li></ol><h4 id="2-2-1-哈夫曼编码"><a href="#2-2-1-哈夫曼编码" class="headerlink" title="2.2.1 哈夫曼编码"></a>2.2.1 哈夫曼编码</h4><p>在数据通信中，需要将传送的文字转换成二进制的字符串，用0，1码的不同排列来表示字符。</p><p>例如，需传送的报文为<code>AFTER DATA EAR ARE ART AREA</code>，这里用到的字符集为<code>A，E，R，T，F，D</code>，各字母出现的次数为{8，4，5，3，1，1}。现要求为这些字母设计编码。要区别6个字母，最简单的二进制编码方式是等长编码，固定采用3位二进制，可分别用<code>000、001、010、011、100、101</code>对<code>A，E，R，T，F，D</code>进行编码发送</p><p>但是很明显，上述的编码的方式并不是最优的，即整理传送的字节数量并不是最少的。</p><p>为了提高数据传送的效率，同时为了保证<code>任一字符的编码都不是另一个字符编码的前缀，这种编码称为前缀编码[前缀编码]</code>,可以使用哈夫曼树生成哈夫曼编码解决问题</p><p>可用字符集中的每个字符作为叶子结点生成一棵编码二叉树，为了获得传送报文的最短长度，可将每个字符的出现频率作为字符结点的权值赋予该结点上，显然字使用频率越小权值越小，权值越小叶子就越靠下，于是频率小编码长，频率高编码短，这样就保证了此树的最小带权路径长度效果上就是传送报文的最短长度</p><p>因此，求传送报文的最短长度问题转化为求由字符集中的所有字符作为叶子结点，由字符出现频率作为其权值所产生的哈夫曼树的问题。利用哈夫曼树来设计二进制的前缀编码，既满足前缀编码的条件，又保证报文编码总长最短。</p><p>下图中<code>label1 .... label6</code>分别表示<code>A，E，R，T，F，D</code></p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%93%88%E5%A4%AB%E6%9B%BC%E7%BC%96%E7%A0%81.jpg"></p><h4 id="2-3-梯度计算"><a href="#2-3-梯度计算" class="headerlink" title="2.3 梯度计算"></a>2.3 梯度计算</h4><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%93%88%E5%A4%AB%E6%9B%BC%E7%BC%96%E7%A0%81%20-%20%E5%89%AF%E6%9C%AC.jpg"></p><p>上图中，红色为哈夫曼编码，即label5的哈夫曼编码为1001，那么此时如何定义条件概率$P(Label5|contex)$呢？</p><p>以Label5为例，从根节点到Label5中间经历了4次分支，每次分支都可以认为是进行了一次2分类，根据哈夫曼编码，可以把路径中的每个非叶子节点0认为是负类，1认为是正类（也可以把0认为是正类）</p><p>由机器学习课程中逻辑回归使用sigmoid函数进行2分类的过程中，一个节点被分为正类的概率是$\delta(X^{T}\theta) &#x3D; \frac{1}{1+e^{-X^T\theta}}$,被分类负类的概率是：$1-\delta(X^T\theta)$，其中$\theta$就是图中非叶子节点对应的参数$\theta$。</p><p>对于从根节点出发，到达Label5一共经历4次2分类，将每次分类结果的概率写出来就是：</p><ol><li>第一次：$P(1|X,\theta_1) &#x3D; \delta(X^T\theta_1) $ ,即从根节点到23节点的概率是在知道X和$\theta_1$的情况下取值为1的概率</li><li>第二次：$P(0|X,\theta_2) &#x3D;1- \delta(X^T\theta_2) $  </li><li>第三次：$P(0 |X,\theta_3) &#x3D;1- \delta(X^T\theta_4) $</li><li>第四次：$P(1|X,\theta_4) &#x3D; \delta(X^T\theta_4) $</li></ol><p>但是我们需要求的是$P(Label|contex)$, 他等于前4词的概率的乘积，公式如下（$d_j^w$是第j个节点的哈夫曼编码）<br>$$<br>P(Label|context) &#x3D; \prod_{j&#x3D;2}^5P(d_j|X,\theta_{j-1})<br>$$</p><p>其中：<br>$$<br>P(d_j|X,\theta_{j-1}) &#x3D; \left{<br>\begin{aligned}<br>&amp;\delta(X^T\theta_{j-1}), &amp; d_j&#x3D;1;\<br>&amp;1-\delta(X^T\theta_{j-1}) &amp; d_j&#x3D;0;<br>\end{aligned}<br>\right.<br>$$</p><p>或者也可以写成一个整体,把目标值作为指数，之后取log之后会前置：<br>$$<br>P(d_j|X,\theta_{j-1}) &#x3D; [\delta(X^T\theta_{j-1})]^{d_j} \cdot [1-\delta(X^T\theta_{j-1})]^{1-d_j}<br>$$</p><p>在机器学习中的逻辑回归中，我们经常把二分类的损失函数(目标函数)定义为对数似然损失，即<br>$$<br>l &#x3D;-\frac{1}{M} \sum_{label\in labels} log\ P(label|context)<br>$$</p><p>式子中，求和符号表示的是使用样本的过程中，每一个label对应的概率取对数后的和，之后求取均值。</p><p>带入前面对$P(label|context)$的定义得到：<br>$$<br>\begin{align*}<br>l &amp; &#x3D; -\frac{1}{M}\sum_{label\in labels}log \prod_{j&#x3D;2}{[\delta(X^T\theta_{j-1})]^{d_j} \cdot [1-\delta(X^T\theta_{j-1})]^{1-d_j}} \<br>&amp; &#x3D;-\frac{1}{M} \sum_{label\in labels} \sum_{j&#x3D;2}{d_j\cdot log[\delta(X^T\theta_{j-1})]+ (1-d_j) \cdot log [1-\delta(X^T\theta_{j-1})]}<br>\end{align*}<br>$$<br>有了损失函数之后，接下来就是对其中的$X,\theta$进行求导，并更新，最终还需要更新最开始的每个词语词向量</p><p><strong>层次化softmax的好处</strong>：传统的softmax的时间复杂度为L（Labels的数量），但是使用层次化softmax之后时间复杂度的log(L) （二叉树高度和宽度的近似），从而在多分类的场景提高了效率</p><h2 id="3-fastText中的negative-sampling-负采样-对传统softmax的优化方法2"><a href="#3-fastText中的negative-sampling-负采样-对传统softmax的优化方法2" class="headerlink" title="3. fastText中的negative sampling(负采样)-对传统softmax的优化方法2"></a>3. fastText中的negative sampling(负采样)-对传统softmax的优化方法2</h2><p>negative sampling，即每次从除当前label外的其他label中，随机的选择几个作为负样本。具体的采样方法：</p><p>如果所有的label为$V$,那么我们就将一段长度为1的线段分成$V$份，每份对应所有label中的一类label。当然每个词对应的线段长度是不一样的，高频label对应的线段长，低频label对应的线段短。每个label的线段长度由下式决定：<br>$$<br>len(w) &#x3D; \frac{count(label)^{\alpha}}{\sum_{w \in labels} count(labels)^{\alpha}},a在fasttext中为0.75，即负采样的数量和原来词频的平方根成正比<br>$$<br>在采样前，我们将这段长度为1的线段划分成$M$等份，这里$M&gt;&gt;V$，这样可以保证每个label对应的线段都会划分成对应的小块。而M份中的每一份都会落在某一个label对应的线段上。在采样的时候，我们只需要从$M$个位置中采样出neg个位置就行，此时采样到的每一个位置对应到的线段所属的词就是我们的负例。</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E8%B4%9F%E9%87%87%E6%A0%B7.png"></p><p>简单的理解就是，从原来所有的样本中，等比例的选择neg个负样本作（遇到自己则跳过），作为训练样本，添加到训练数据中，和正例样本一起来进行训练。</p><p>Negative Sampling也是采用了二元逻辑回归来求解模型参数，通过负采样，我们得到了neg个负例，将正例定义为$label_0$,负例定义为$label_i,i&#x3D;1,2,3…neg$</p><p>定义正例的概率为$P\left( label_{0}|\text {context}\right)&#x3D;\sigma\left(x_{\mathrm{k}}^{T} \theta\right), y_{i}&#x3D;1$</p><p>则负例的概率为：$P\left( label_{i}|\text {context}\right)&#x3D;1-\sigma\left(x_{\mathrm{k}}^{T} \theta\right), y_{i}&#x3D;0,i&#x3D;1,2,3..neg$</p><p>此时对应的对数似然函数为：<br>$$<br>L&#x3D;\sum_{i&#x3D;0}^{n e g} y_{i} \log \left(\sigma\left(x_{label_0}^{T} \theta\right)\right)+\left(1-y_{i}\right) \log \left(1-\sigma\left(x_{label_0}^{T} \theta\right)\right)<br>$$<br>具体的训练时候损失的计算过程(源代码已经更新)：</p><p><img src="/../../../../BaiduNetdiskDownload/%25E9%2598%25B6%25E6%25AE%25B59-%25E4%25BA%25BA%25E5%25B7%25A5%25E6%2599%25BA%25E8%2583%25BDNLP%25E9%25A1%25B9%25E7%259B%25AE/NLP%25E8%25AF%25BE%25E4%25BB%25B6%25E7%25BC%2596%25E5%2586%2599/markdown/doc/images/2.2/fasttext%25E8%25B4%259F%25E9%2587%2587%25E6%25A0%25B7.png"></p><p>可以看出：一个neg+1个样本进行了训练，得到了总的损失。</p><p>之后会使用梯度上升的方法进行梯度计算和参数更新，仅仅每次只用一波样本(一个正例和neg个反例)更新梯度，来进行迭代更新</p><p>具体的更新伪代码如下:</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E8%B4%9F%E9%87%87%E6%A0%B7%E6%A2%AF%E5%BA%A6%E4%B8%8A%E5%8D%87.png"></p><p>其中内部大括号部分为w相关参数的梯度计算过程，e为w的梯度和学习率的乘积，具体参考:<a href="https://blog.csdn.net/itplus/article/details/37998797">https://blog.csdn.net/itplus/article/details/37998797</a></p><p>好处：</p><ol><li>提高训练速度，选择了部分数据进行计算损失，同时整个对每一个label而言都是一个二分类，损失计算更加简单，只需要让当前label的值的概率尽可能大，其他label的都为反例，概率会尽可能小</li><li>改进效果，增加部分负样本，能够模拟真实场景下的噪声情况，能够让模型的稳健性更强</li></ol><h1 id="闲聊机器人的介绍"><a href="#闲聊机器人的介绍" class="headerlink" title="闲聊机器人的介绍"></a>闲聊机器人的介绍</h1><h2 id="目标-20"><a href="#目标-20" class="headerlink" title="目标"></a>目标</h2><ol><li>了解闲聊机器人是什么</li></ol><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>在项目准备阶段我们知道，用户说了一句话后，会判断其意图，如果是想进行闲聊，那么就会调用闲聊模型返回结果，这是我们会在项目中实现的功能。</p><p>目前市面上的常见闲聊机器人有<code>微软小冰</code>这种类型的模型，很久之前还有<code>小黄鸡</code>这种体验更差的模型</p><p>常见的闲聊模型都是一种seq2seq的结构，在后面的课程中我们会学习并使用seq2seq来实现我们的闲聊机器人</p><h1 id="Seq2Seq模型的原理"><a href="#Seq2Seq模型的原理" class="headerlink" title="Seq2Seq模型的原理"></a>Seq2Seq模型的原理</h1><h2 id="目标-21"><a href="#目标-21" class="headerlink" title="目标"></a>目标</h2><ol><li>知道seq2seq的常见应用场景</li><li>能够说出常见的seq2seq的结构</li><li>能够使用代码完成基础的seq2seq的结构</li></ol><h2 id="1-Seq2Seq的介绍"><a href="#1-Seq2Seq的介绍" class="headerlink" title="1. Seq2Seq的介绍"></a>1. Seq2Seq的介绍</h2><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/seq2seq.png"></p><p><code>Sequence to sequence (seq2seq)</code>是由<code>encoder（编码器）</code>和<code>decoder（解码器）</code>两个RNN的组成的。其中encoder负责对输入句子的理解，转化为<code>context vector</code>，decoder负责对理解后的句子的向量进行处理，解码，获得输出。上述的过程和我们大脑理解东西的过程很相似，<code>听到一句话，理解之后，尝试组装答案，进行回答</code></p><p>那么此时，就有一个问题，在encoder的过程中得到的context vector作为decoder的输入，那么这样一个输入，怎么能够得到多个输出呢？</p><p>其实就是<code>当前一步的输出，作为下一个单元的输入，然后得到结果</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">outputs = []<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    output = decoderd(output)<br>    outputs.append(output)<br></code></pre></td></tr></table></figure><p>那么循环什么时候停止呢？</p><p>在训练数据集中，可以再输出的最后面添加一个结束符<code>&lt;END&gt;</code>，如果遇到该结束符，则可以终止循环</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">outputs = []<br><span class="hljs-keyword">while</span> output!=<span class="hljs-string">&quot;&lt;END&gt;&quot;</span>:<br>    output = decoderd(output)<br>    outputs.append(output)<br></code></pre></td></tr></table></figure><p>这个结束符只是一个标记，很多人也会使用<code>&lt;EOS&gt;(End Of Sentence)</code></p><p>总之：Seq2seq模型中的encoder接受一个长度为M的序列，得到1个 context vector，之后decoder把这一个context vector转化为长度为N的序列作为输出，从而构成一个<code>M to N</code>的模型，能够处理很多不定长输入输出的问题，比如：<code>文本翻译，问答，文章摘要，关键字写诗等等</code></p><h2 id="2-Seq2Seq模型的实现"><a href="#2-Seq2Seq模型的实现" class="headerlink" title="2. Seq2Seq模型的实现"></a>2. Seq2Seq模型的实现</h2><p>下面，我们通过一个简单的列子，来看看普通的Seq2Seq模型应该如何实现。</p><p><strong>需求</strong>：完成一个模型，实现往模型输入一串数字，输出这串数字+0</p><p><strong>例如</strong>：</p><ul><li>输入<code>123456789</code>，输出<code>1234567890</code>；</li><li>输入<code>52555568</code>，输出<code>525555680</code></li></ul><h3 id="2-1-实现流程"><a href="#2-1-实现流程" class="headerlink" title="2.1 实现流程"></a>2.1 实现流程</h3><ol><li>文本转化为序列（数字序列，<code>torch.LongTensor</code>）</li><li>使用序列，准备数据集，准备<code>Dataloader</code></li><li>完成编码器</li><li>完成解码器</li><li>完成seq2seq模型</li><li>完成模型训练的逻辑，进行训练</li><li>完成模型评估的逻辑，进行模型评估</li></ol><h3 id="2-2-文本转化为序列"><a href="#2-2-文本转化为序列" class="headerlink" title="2.2 文本转化为序列"></a>2.2 文本转化为序列</h3><p>由于输入的是数字，为了把这写数字和词典中的真实数字进行对应，可以把这些数字理解为字符串</p><p>那么我们需要做的就是：</p><ol><li>把字符串对应为数字</li><li>把数字转化为字符串</li></ol><p>完成逻辑和之前相同，创建<code>word_sequence.py</code>文件，实现上述逻辑</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NumSequence</span>:<br>    UNK_TAG = <span class="hljs-string">&quot;UNK&quot;</span> <span class="hljs-comment">#未知词</span><br>    PAD_TAG = <span class="hljs-string">&quot;PAD&quot;</span> <span class="hljs-comment">#填充词，实现文本对齐，即一个batch中的句子长度都是相同的，短句子会被padding</span><br>    EOS_TAG = <span class="hljs-string">&quot;EOS&quot;</span> <span class="hljs-comment">#句子的开始</span><br>    SOS_TAG = <span class="hljs-string">&quot;SOS&quot;</span> <span class="hljs-comment">#句子的结束</span><br><br>    UNK = <span class="hljs-number">0</span><br>    PAD = <span class="hljs-number">1</span><br>    EOS = <span class="hljs-number">2</span><br>    SOS = <span class="hljs-number">3</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.<span class="hljs-built_in">dict</span> = &#123;<br>            self.UNK_TAG : self.UNK,<br>            self.PAD_TAG : self.PAD,<br>            self.EOS_TAG : self.EOS,<br>            self.SOS_TAG : self.SOS<br>        &#125;<br>        <span class="hljs-comment">#得到字符串和数字对应的字典</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>            self.<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>(i)] = <span class="hljs-built_in">len</span>(self.<span class="hljs-built_in">dict</span>)<br><span class="hljs-comment">#得到数字和字符串对应的字典</span><br>        self.index2word = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(self.<span class="hljs-built_in">dict</span>.values(),self.<span class="hljs-built_in">dict</span>.keys()))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.<span class="hljs-built_in">dict</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">self,sequence,max_len=<span class="hljs-literal">None</span>,add_eos=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        sequence：句子</span><br><span class="hljs-string">        max_len :句子的最大长度</span><br><span class="hljs-string">        add_eos:是否添加结束符</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <br>        sequence_list = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">str</span>(sequence))<br>        seq_len = <span class="hljs-built_in">len</span>(sequence_list)+<span class="hljs-number">1</span> <span class="hljs-keyword">if</span> add_eos <span class="hljs-keyword">else</span> <span class="hljs-built_in">len</span>(sequence_list)<br><br>        <span class="hljs-keyword">if</span> add_eos <span class="hljs-keyword">and</span> max_len <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">assert</span> max_len&gt;= seq_len, <span class="hljs-string">&quot;max_len 需要大于seq+eos的长度&quot;</span><br>        _sequence_index = [self.<span class="hljs-built_in">dict</span>.get(i,self.UNK) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> sequence_list]<br>        <span class="hljs-keyword">if</span> add_eos:<br>            _sequence_index += [self.EOS]<br>        <span class="hljs-keyword">if</span> max_len <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            sequence_index = [self.PAD]*max_len<br>            sequence_index[:seq_len] =  _sequence_index<br>            <span class="hljs-keyword">return</span> sequence_index<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> _sequence_index<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inverse_transform</span>(<span class="hljs-params">self,sequence_index</span>):<br>        result = []<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> sequence_index:<br>            <span class="hljs-keyword">if</span> i==self.EOS:<br>                <span class="hljs-keyword">break</span><br>            result.append(self.index2word.get(<span class="hljs-built_in">int</span>(i),self.UNK_TAG))<br>        <span class="hljs-keyword">return</span> result<br><span class="hljs-comment"># 实例化，供后续调用</span><br>num_sequence = NumSequence()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    num_sequence = NumSequence()<br>    <span class="hljs-built_in">print</span>(num_sequence.<span class="hljs-built_in">dict</span>)<br>    <span class="hljs-built_in">print</span>(num_sequence.index2word)<br>    <span class="hljs-built_in">print</span>(num_sequence.transform(<span class="hljs-string">&quot;1231230&quot;</span>,add_eos=<span class="hljs-literal">True</span>))<br></code></pre></td></tr></table></figure><h3 id="2-3-准备数据集"><a href="#2-3-准备数据集" class="headerlink" title="2.3 准备数据集"></a>2.3 准备数据集</h3><h4 id="2-3-1-准备Dataset"><a href="#2-3-1-准备Dataset" class="headerlink" title="2.3.1 准备Dataset"></a>2.3.1 准备<code>Dataset</code></h4><p>这里，我们使用随机创建的<code>[0,100000000]</code>的整型，来准备数据集</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> Dataset,DataLoader<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> word_sequence <span class="hljs-keyword">import</span> num_sequence<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> config<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RandomDataset</span>(<span class="hljs-title class_ inherited__">Dataset</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(RandomDataset,self).__init__()<br>        self.total_data_size = <span class="hljs-number">500000</span><br>        np.random.seed(<span class="hljs-number">10</span>)<br>        self.total_data = np.random.randint(<span class="hljs-number">1</span>,<span class="hljs-number">100000000</span>,size=[self.total_data_size])<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;返回input，target，input_length,target_length(真实长度)&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">input</span> = <span class="hljs-built_in">str</span>(self.total_data[idx])<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">input</span>, <span class="hljs-built_in">input</span>+ <span class="hljs-string">&quot;0&quot;</span>,<span class="hljs-built_in">len</span>(<span class="hljs-built_in">input</span>),<span class="hljs-built_in">len</span>(<span class="hljs-built_in">input</span>)+<span class="hljs-number">1</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> self.total_data_size<br></code></pre></td></tr></table></figure><p>通过随机数的结果，可以看到，大部分的数字长度为8，在目标值后面添加上0和EOS之后，最大长度为10</p><p>所以常见config配置文件，添加上<code>max_len：文本最大长度</code>，方便后续的修改</p><h4 id="2-3-2-准备DataLoader"><a href="#2-3-2-准备DataLoader" class="headerlink" title="2.3.2 准备DataLoader"></a>2.3.2 准备<code>DataLoader</code></h4><p>在准备<code>DataLoader</code>的过程中，可以通过定义的collate_fn来实现对dataset中batch数据的处理</p><p>其中需要注意：</p><ol><li>需要对batch中的数据进行排序，根据数据的真实长度进行降序排序（后面需要用到）</li><li>需要调用<code>文本序列化</code>的方法，把文本进行序列化的操作，同时target需要进行<code>add eos</code>的操作</li><li>最后返回序列的LongTensor格式</li><li>在<code>DataLoader中有drop_last参数</code>，当数据量无法被batch_size整除时，最后一个batch的数据个数和之前的数据个数长度不同，可以考虑进行删除</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">collate_fn</span>(<span class="hljs-params">batch</span>):<br>    <span class="hljs-comment">#1. 对batch进行排序，按照长度从长到短的顺序排序</span><br>    batch = <span class="hljs-built_in">sorted</span>(batch,key=<span class="hljs-keyword">lambda</span> x:x[<span class="hljs-number">3</span>],reverse=<span class="hljs-literal">True</span>)<br>    <span class="hljs-built_in">input</span>,target,input_length,target_length = <span class="hljs-built_in">zip</span>(*batch)<br><br>    <span class="hljs-comment">#2.进行padding的操作</span><br>    <span class="hljs-built_in">input</span> = torch.LongTensor([num_sequence.transform(i,max_len=config.max_len) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">input</span>])<br>    target = torch.LongTensor([num_sequence.transform(i,max_len=config.max_len,add_eos=<span class="hljs-literal">True</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> target])<br>    input_length = torch.LongTensor(input_length)<br>    target_length = torch.LongTensor(target_length)<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">input</span>,target,input_length,target_length<br><br>data_loader = DataLoader(dataset=RandomDataset(),batch_size=config.batch_size,collate_fn=collate_fn,drop_last=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><h3 id="2-4-准备编码器"><a href="#2-4-准备编码器" class="headerlink" title="2.4 准备编码器"></a>2.4 准备编码器</h3><p>编码器（encoder）的目的就是为了对文本进行编码，把编码后的结果交给后续的程序使用，所以在这里我们可以使用<code>Embedding+GRU</code>的结构来使用，使用最后一个<code>time step</code>的输出(<code>hidden state</code>)作为<code>句子的编码结果</code></p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/Encoder.png"></p><p>注意点：</p><ol><li>Embedding和GRU的参数,这里我们让GRU中batch放在前面</li><li>输出结果的形状</li><li>在LSTM和GRU中，每个<code>time step</code>的输入会进行计算，得到结果，整个过程是一个和句子长度相关的一个循环，手动实现速度较慢<ol><li>pytorch中实现了<code>nn.utils.rnn.pack_padded_sequence</code> 对padding后的句子进行打包的操作能够更快获得LSTM or GRU的结果</li><li>同时实现了<code>nn.utils.rnn.pad_packed_sequence</code>对打包的内容进行解包的操作</li></ol></li><li><code>nn.utils.rnn.pack_padded_sequence</code>使用过程中需要对batch中的内容按照句子的长度<strong>降序排序</strong></li></ol><p>实现代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">from</span> word_sequence <span class="hljs-keyword">import</span> num_sequence<br><span class="hljs-keyword">import</span> config<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NumEncoder</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(NumEncoder,self).__init__()<br>        self.vocab_size = <span class="hljs-built_in">len</span>(num_sequence)<br>        self.dropout = config.dropout<br>        self.embedding = nn.Embedding(num_embeddings=self.vocab_size,embedding_dim=config.embedding_dim,padding_idx=num_sequence.PAD)<br>        self.gru = nn.GRU(input_size=config.embedding_dim,<br>                          hidden_size=config.hidden_size,<br>                          num_layers=<span class="hljs-number">1</span>,<br>                          batch_first=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>,input_length</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        input:[batch_size,max_len]</span><br><span class="hljs-string">        input_length:[batch_size]</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        embeded = self.embedding(<span class="hljs-built_in">input</span>) <span class="hljs-comment">#[batch_size,max_len , embedding_dim]</span><br>        <br>        <span class="hljs-comment">#对文本对齐之后的句子进行打包，能够加速在LSTM or GRU中的计算过程</span><br>        embeded = nn.utils.rnn.pack_padded_sequence(embeded,lengths=input_length,batch_first=<span class="hljs-literal">True</span>)<br><br>        <span class="hljs-comment">#hidden:[1,batch_size,vocab_size]</span><br>        out,hidden = self.gru(embeded)<br>        <br>        <span class="hljs-comment">#对前面打包后的结果再进行解包</span><br>        out,outputs_length = nn.utils.rnn.pad_packed_sequence(out,batch_first=<span class="hljs-literal">True</span>,padding_value=num_sequence.PAD)<br>        <span class="hljs-comment"># out [batch_size,seq_len,hidden_size]</span><br>        <span class="hljs-keyword">return</span> out,hidden<br></code></pre></td></tr></table></figure><h3 id="2-5-实现解码器"><a href="#2-5-实现解码器" class="headerlink" title="2.5 实现解码器"></a>2.5 实现解码器</h3><p>加码器主要负责实现对编码之后结果的处理，得到预测值，为后续计算损失做准备</p><p>此时需要思考：</p><ol><li><p>使用什么样的损失函数，预测值需要是什么格式的</p><ul><li>结合之前的经验，我们可以理解为当前的问题是一个分类的问题，即每次的输出其实对选择一个概率最大的词</li><li>真实值的形状是<code>[batch_size,max_len]</code>，从而我们知道输出的结果需要是一个<code>[batch_size,max_len,vocab_size]</code>的形状</li><li>即预测值的最后一个维度进行计算log_softmax,然后和真实值进行相乘，从而得到损失</li></ul></li><li><p>如何把编码结果<code>[1,batch_size,hidden_size]</code>进行操作，得到预测值。解码器也是一个RNN，即也可以使用LSTM or GRU的结构，所以在解码器中：</p><ul><li><p>通过循环，每次计算的一个time step的内容</p></li><li><p>编码器的结果作为初始的隐层状态，定义一个<code>[batch_size,1]</code>的全为<code>SOS</code>的数据作为最开始的输入，告诉解码器，要开始工作了</p></li><li><p>通过解码器预测一个输出<code>[batch_size,hidden_size]</code>(会进行形状的调整为<code>[batch_size,vocab_size]</code>)，把这个输出作为输入再使用解码器进行解码</p></li><li><p>上述是一个循环，循环次数就是句子的最大长度，那么就可以得到<code>max_len</code>个输出</p></li><li><p>把所有输出的结果进行concate，得到<code>[batch_size,max_len,vocab_size]</code></p></li></ul></li><li><p>在RNN的训练过程中，使用前一个预测的结果作为下一个step的输入，可能会导致<code>一步错，步步错的结果</code>，如果提高模型的收敛速度？</p><ul><li>可以考虑在训练的过程中，把真实值作为下一步的输入，这样可以避免<code>步步错的局面</code></li><li>同时在使用真实值的过程中，仍然使用预测值作为下一步的输入，两种输入随机使用</li><li>上述这种机制我们把它称为<code>Teacher forcing</code>，就像是一个指导老师，在每一步都会对我们的行为进行纠偏，从而达到在多次训练之后能够需要其中的规律</li><li><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/teacher%20forcing.jpg"></li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">import</span> config<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><span class="hljs-keyword">from</span> word_sequence <span class="hljs-keyword">import</span> num_sequence<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NumDecoder</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(NumDecoder,self).__init__()<br>        self.max_seq_len = config.max_len<br>        self.vocab_size = <span class="hljs-built_in">len</span>(num_sequence)<br>        self.embedding_dim = config.embedding_dim<br>        self.dropout = config.dropout<br><br>        self.embedding = nn.Embedding(num_embeddings=self.vocab_size,embedding_dim=self.embedding_dim,padding_idx=num_sequence.PAD)<br>        self.gru = nn.GRU(input_size=self.embedding_dim,<br>                          hidden_size=config.hidden_size,<br>                          num_layers=<span class="hljs-number">1</span>,<br>                          batch_first=<span class="hljs-literal">True</span>,<br>                          dropout=self.dropout)<br>        self.log_softmax = nn.LogSoftmax()<br><br>        self.fc = nn.Linear(config.hidden_size,self.vocab_size)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, encoder_hidden,target,target_length</span>):<br>        <span class="hljs-comment"># encoder_hidden [batch_size,hidden_size]</span><br>        <span class="hljs-comment"># target [batch_size,max_len]</span><br><br>        <span class="hljs-comment">#初始的全为SOS的输入</span><br>        decoder_input = torch.LongTensor([[num_sequence.SOS]]*config.batch_size)<br><br>        <span class="hljs-comment">#解码器的输出，用来后保存所有的输出结果</span><br>        decoder_outputs = torch.zeros(config.batch_size,config.max_len,self.vocab_size) <br><br>        decoder_hidden = encoder_hidden <span class="hljs-comment">#[batch_size,hidden_size]</span><br><br>        <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(config.max_len):<br>            decoder_output_t , decoder_hidden = self.forward_step(decoder_input,decoder_hidden)<br>            <br>            <span class="hljs-comment">#在不同的time step上进行复制，decoder_output_t [batch_size,vocab_size]</span><br>            decoder_outputs[:,t,:] = decoder_output_t<br><br>            <span class="hljs-comment">#在训练的过程中，使用 teacher forcing，进行纠偏</span><br>            use_teacher_forcing = random.random() &gt; <span class="hljs-number">0.5</span><br>            <span class="hljs-keyword">if</span> use_teacher_forcing:<br>                <span class="hljs-comment">#下一次的输入使用真实值</span><br>                decoder_input =target[:,t].unsqueeze(<span class="hljs-number">1</span>)  <span class="hljs-comment">#[batch_size,1]</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-comment">#使用预测值，topk中k=1，即获取最后一个维度的最大的一个值</span><br>                value, index = torch.topk(decoder_output_t, <span class="hljs-number">1</span>) <span class="hljs-comment"># index [batch_size,1]</span><br>                decoder_input = index<br>        <span class="hljs-keyword">return</span> decoder_outputs,decoder_hidden<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward_step</span>(<span class="hljs-params">self,decoder_input,decoder_hidden</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :param decoder_input:[batch_size,1]</span><br><span class="hljs-string">        :param decoder_hidden: [1,batch_size,hidden_size]</span><br><span class="hljs-string">        :return: out:[batch_size,vocab_size],decoder_hidden:[1,batch_size,didden_size]</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        embeded = self.embedding(decoder_input)  <span class="hljs-comment">#embeded: [batch_size,1 , embedding_dim]</span><br><br>        out,decoder_hidden = self.gru(embeded,decoder_hidden) <span class="hljs-comment">#out [1, batch_size, hidden_size]</span><br><br>       out = out.squeeze(<span class="hljs-number">0</span>) <span class="hljs-comment">#去除第0维度的1</span><br>        <span class="hljs-comment">#进行全连接形状变化，同时进行求取log_softmax</span><br>        out = F.log_softmax(self.fc(out),dim=-<span class="hljs-number">1</span>)<span class="hljs-comment">#out [batch_Size,1, vocab_size]</span><br>        out = out.squeeze(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> out,decoder_hidden<br><br></code></pre></td></tr></table></figure><h3 id="2-6-完成seq2seq模型"><a href="#2-6-完成seq2seq模型" class="headerlink" title="2.6 完成seq2seq模型"></a>2.6 完成seq2seq模型</h3><p>调用之前的encoder和decoder，完成模型的搭建</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Seq2Seq</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,encoder,decoder</span>):<br>        <span class="hljs-built_in">super</span>(Seq2Seq,self).__init__()<br>        self.encoder = encoder<br>        self.decoder = decoder<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>,target,input_length,target_length</span>):<br>        <span class="hljs-comment">#进行编码</span><br>        encoder_outputs,encoder_hidden = self.encoder(<span class="hljs-built_in">input</span>,input_length)<br>        <span class="hljs-comment">#进行解码</span><br>        decoder_outputs,decoder_hidden = self.decoder(encoder_hidden,target,target_length)<br>        <span class="hljs-keyword">return</span> decoder_outputs,decoder_hidden<br></code></pre></td></tr></table></figure><h3 id="2-7-完成训练逻辑"><a href="#2-7-完成训练逻辑" class="headerlink" title="2.7 完成训练逻辑"></a>2.7 完成训练逻辑</h3><p>思路流程和之前相同</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> config<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> optim<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">from</span> encoder <span class="hljs-keyword">import</span> NumEncoder<br><span class="hljs-keyword">from</span> decoder <span class="hljs-keyword">import</span> NumDecoder<br><span class="hljs-keyword">from</span> seq2seq <span class="hljs-keyword">import</span> Seq2Seq<br><span class="hljs-keyword">from</span> dataset <span class="hljs-keyword">import</span> data_loader <span class="hljs-keyword">as</span> train_dataloader<br><span class="hljs-keyword">from</span> word_sequence <span class="hljs-keyword">import</span> num_sequence<br><br><br><br>encoder = NumEncoder()<br>decoder = NumDecoder()<br>model = Seq2Seq(encoder,decoder)<br><span class="hljs-built_in">print</span>(model)<br><br><span class="hljs-comment">#自定义初始化参数</span><br><span class="hljs-comment">#for name, param in model.named_parameters():</span><br><span class="hljs-comment">#    if &#x27;bias&#x27; in name:</span><br><span class="hljs-comment">#        torch.nn.init.constant_(param, 0.0)</span><br><span class="hljs-comment">#    elif &#x27;weight&#x27; in name:</span><br><span class="hljs-comment">#        torch.nn.init.xavier_normal_(param)</span><br><br><span class="hljs-comment"># model.load_state_dict(torch.load(&quot;model/seq2seq_model.pkl&quot;))</span><br>optimizer =  optim.Adam(model.parameters())<br><span class="hljs-comment"># optimizer.load_state_dict(torch.load(&quot;model/seq2seq_optimizer.pkl&quot;))</span><br>criterion= nn.NLLLoss(ignore_index=num_sequence.PAD,reduction=<span class="hljs-string">&quot;mean&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_loss</span>(<span class="hljs-params">decoder_outputs,target</span>):<br>    <span class="hljs-comment">#很多时候如果tensor进行了转置等操作，直接调用view进行形状的修改是无法成功的</span><br>    <span class="hljs-comment">#target = target.contiguous().view(-1) #[batch_size*max_len]</span><br>    target = target.view(-<span class="hljs-number">1</span>)<br>    decoder_outputs = decoder_outputs.view(config.batch_size*config.max_len,-<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span> criterion(decoder_outputs,target)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">epoch</span>):<br>    <span class="hljs-keyword">for</span> idx,(<span class="hljs-built_in">input</span>,target,input_length,target_len) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_dataloader):<br>        optimizer.zero_grad()<br>        <span class="hljs-comment">##[seq_len,batch_size,vocab_size] [batch_size,seq_len]</span><br>        decoder_outputs,decoder_hidden = model(<span class="hljs-built_in">input</span>,target,input_length,target_len)<br>        loss = get_loss(decoder_outputs,target)<br>        loss.backward()<br>        optimizer.step()<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Train Epoch: &#123;&#125; [&#123;&#125;/&#123;&#125; (&#123;:.0f&#125;%)]\tLoss: &#123;:.6f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<br>            epoch, idx * <span class="hljs-built_in">len</span>(<span class="hljs-built_in">input</span>), <span class="hljs-built_in">len</span>(train_dataloader.dataset),<br>                   <span class="hljs-number">100.</span> * idx / <span class="hljs-built_in">len</span>(train_dataloader), loss.item()))<br><br>        torch.save(model.state_dict(), <span class="hljs-string">&quot;model/seq2seq_model.pkl&quot;</span>)<br>        torch.save(optimizer.state_dict(), <span class="hljs-string">&#x27;model/seq2seq_optimizer.pkl&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>        train(i)<br></code></pre></td></tr></table></figure><h3 id="2-8-完成模型评估逻辑"><a href="#2-8-完成模型评估逻辑" class="headerlink" title="2.8 完成模型评估逻辑"></a>2.8 完成模型评估逻辑</h3><p>完成评估逻辑，和decoder中的训练过程稍微不同，可以在其中新建<code>evaluation</code>的方法，传入<code>encoder_hidden</code>，得到预测的结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluation</span>(<span class="hljs-params">self,encoder_hidden</span>): <span class="hljs-comment">#[1, 20, 14]</span><br>    batch_size = encoder_hidden.size(<span class="hljs-number">1</span>) <span class="hljs-comment">#评估的时候和训练的batch_size不同，不适用config的配置</span><br><br>    decoder_input = torch.LongTensor([[num_sequence.SOS] * batch_size])<br>    decoder_outputs = torch.zeros(batch_size,config.max_len, self.vocab_size)  <span class="hljs-comment"># [batch_size，seq_len,vocab_size]</span><br>    decoder_hidden = encoder_hidden<br><br>    <span class="hljs-comment">#评估，不再使用teacher forcing，完全使用预测值作为下一次的输入</span><br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(config.max_len):<br>        decoder_output_t, decoder_hidden = self.forward_step(decoder_input, decoder_hidden)<br>        decoder_outputs[:,t,:] = decoder_output_t<br>        value, index = torch.topk(decoder_output_t, <span class="hljs-number">1</span>)  <span class="hljs-comment"># index [20,1]</span><br>        decoder_input = index.transpose(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment">#获取输出的id</span><br>    decoder_indices = []  <span class="hljs-comment">#[[1,2,4],[23,3,2]]</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(config.max_len):<br>        value,index = torch.topk(decoder_outputs[:,i,:],k=<span class="hljs-number">1</span>,dim=-<span class="hljs-number">1</span>)<br>        decoder_indices.append(index.view(-<span class="hljs-number">1</span>).numpy())<br>    <span class="hljs-comment">#transpose 调整为按句子输出</span><br>    decoder_indices = np.array(decoder_indices).transpose() <br>    <span class="hljs-keyword">return</span> decoder_indices<br></code></pre></td></tr></table></figure><p>之后再seq2seq的model中，添加<code>evaluation</code>的逻辑</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Seq2Seq</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,encoder,decoder</span>):<br>        <span class="hljs-built_in">super</span>(Seq2Seq,self).__init__()<br>        self.encoder = encoder<br>        self.decoder = decoder<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>,target,input_length,target_length</span>):<br>        encoder_outputs,encoder_hidden = self.encoder(<span class="hljs-built_in">input</span>,input_length)<br>        decoder_outputs,decoder_hidden = self.decoder(encoder_hidden,target,target_length)<br>        <span class="hljs-keyword">return</span> decoder_outputs,decoder_hidden<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluation</span>(<span class="hljs-params">self,inputs,input_length</span>):<br>        encoder_outputs,encoder_hidden = self.encoder(inputs,input_length)<br>        decoded_sentence = self.decoder.evaluation(encoder_hidden)<br>        <span class="hljs-keyword">return</span> decoded_sentence<br></code></pre></td></tr></table></figure><p>创建<code>eval.py</code>，完成模型评估的逻辑</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> config<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> optim<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">from</span> encoder <span class="hljs-keyword">import</span> NumEncoder<br><span class="hljs-keyword">from</span> decoder <span class="hljs-keyword">import</span> NumDecoder<br><span class="hljs-keyword">from</span> seq2seq <span class="hljs-keyword">import</span> Seq2Seq<br><span class="hljs-keyword">from</span> dataset <span class="hljs-keyword">import</span> data_loader <span class="hljs-keyword">as</span> train_dataloader<br><span class="hljs-keyword">from</span> word_sequence <span class="hljs-keyword">import</span> num_sequence<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> random<br><br><br><br>encoder = NumEncoder()<br>decoder = NumDecoder()<br>model = Seq2Seq(encoder,decoder)<br>model.load_state_dict(torch.load(<span class="hljs-string">&quot;model/seq2seq_model.pkl&quot;</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">evalaute</span>():<br>    data = [<span class="hljs-built_in">str</span>(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> np.random.randint(<span class="hljs-number">0</span>, <span class="hljs-number">100000000</span>, [<span class="hljs-number">10</span>])]<br>    data = <span class="hljs-built_in">sorted</span>(data,key=<span class="hljs-keyword">lambda</span> x:<span class="hljs-built_in">len</span>(x),reverse=<span class="hljs-literal">True</span>)<br>    <span class="hljs-built_in">print</span>(data)<br><br>    _data_length = torch.LongTensor([<span class="hljs-built_in">len</span>(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> data])<br>    _data = torch.LongTensor([num_sequence.transform(i,max_len=config.max_len) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> data])<br>    output = seq2seq.evaluate(_data,_data_length)<br>    <span class="hljs-built_in">print</span>([num_sequence.inverse_transform(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> output])<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    evalaute()<br></code></pre></td></tr></table></figure><p>在model训练一个epoch之后，loss已经很低了,评估输出如下（为True表示预测正确）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">39304187</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-number">393041870</span> <span class="hljs-literal">True</span><br><span class="hljs-number">41020882</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-number">410208820</span> <span class="hljs-literal">True</span><br><span class="hljs-number">85784317</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-number">857843170</span> <span class="hljs-literal">True</span><br><span class="hljs-number">1394232</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-number">13942320</span> <span class="hljs-literal">True</span><br><span class="hljs-number">44548446</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-number">445484460</span> <span class="hljs-literal">True</span><br><span class="hljs-number">49457730</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-number">494577300</span> <span class="hljs-literal">True</span><br><span class="hljs-number">82451872</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-number">824518720</span> <span class="hljs-literal">True</span><br><span class="hljs-number">64380958</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-number">643809580</span> <span class="hljs-literal">True</span><br><span class="hljs-number">97501723</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-number">975017230</span> <span class="hljs-literal">True</span><br><span class="hljs-number">21656800</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-number">216568000</span> <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure><p>完整代码参考：<a href="https://github.com/SpringMagnolia/PytorchTutorial/tree/master/seq2seq">https://github.com/SpringMagnolia/PytorchTutorial/tree/master/seq2seq</a></p><h1 id="Seq2Seq实现闲聊机器人"><a href="#Seq2Seq实现闲聊机器人" class="headerlink" title="Seq2Seq实现闲聊机器人"></a>Seq2Seq实现闲聊机器人</h1><h2 id="目标-22"><a href="#目标-22" class="headerlink" title="目标"></a>目标</h2><ol><li>知道如何处理文本数据</li><li>知道如何使用seq2seq完成闲聊机器人代码的编写</li></ol><h2 id="1-准备训练数据"><a href="#1-准备训练数据" class="headerlink" title="1. 准备训练数据"></a>1. 准备训练数据</h2><p><code>单轮次</code>的聊天数据非常不好获取，所以这里我们从github上使用一些开放的数据集来训练我们的闲聊模型</p><p>数据地址：<a href="https://github.com/codemayq/chaotbot_corpus_Chinese">https://github.com/codemayq/chaotbot_corpus_Chinese</a></p><p>主要的数据有两个：</p><ol><li>小黄鸡的聊天语料：噪声很大<ul><li><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%B0%8F%E9%BB%84%E9%B8%A1%E8%AF%AD%E6%96%99.png"></li></ul></li><li>微博的标题和评论：质量相对较高<ul><li><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%BE%AE%E5%8D%9A%E8%AF%AD%E6%96%991.png"></li><li><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%BE%AE%E5%8D%9A%E8%AF%AD%E6%96%992.png"></li></ul></li></ol><h2 id="2-数据的处理和保存"><a href="#2-数据的处理和保存" class="headerlink" title="2. 数据的处理和保存"></a>2. 数据的处理和保存</h2><p>由于数据中存到大量的噪声，可以对其进行基础的处理，然后分别把input和target使用两个文件保存，即input中的第N行尾问，target的第N行为答</p><p>后续可能我们可能会把单个字作为特征（存放在input_word.txt），也可能会把词语作为特征(input.txt)</p><h3 id="2-1-小黄鸡的语料的处理"><a href="#2-1-小黄鸡的语料的处理" class="headerlink" title="2.1 小黄鸡的语料的处理"></a>2.1 小黄鸡的语料的处理</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">format_xiaohuangji_corpus</span>(<span class="hljs-params">word=<span class="hljs-literal">False</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;处理小黄鸡的语料&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> word:<br>        corpus_path = <span class="hljs-string">&quot;./chatbot/corpus/xiaohuangji50w_nofenci.conv&quot;</span><br>        input_path = <span class="hljs-string">&quot;./chatbot/corpus/input_word.txt&quot;</span><br>        output_path = <span class="hljs-string">&quot;./chatbot/corpus/output_word.txt&quot;</span><br>    <span class="hljs-keyword">else</span>:<br><br>        corpus_path = <span class="hljs-string">&quot;./chatbot/corpus/xiaohuangji50w_nofenci.conv&quot;</span><br>        input_path = <span class="hljs-string">&quot;./chatbot/corpus/input.txt&quot;</span><br>        output_path = <span class="hljs-string">&quot;./chatbot/corpus/output.txt&quot;</span><br><br>    f_input = <span class="hljs-built_in">open</span>(input_path,<span class="hljs-string">&quot;a&quot;</span>)<br>    f_output = <span class="hljs-built_in">open</span>(output_path,<span class="hljs-string">&quot;a&quot;</span>)<br>    pair = []<br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">open</span>(corpus_path),<span class="hljs-built_in">ascii</span>=<span class="hljs-literal">True</span>):<br>        <span class="hljs-keyword">if</span> line.strip() == <span class="hljs-string">&quot;E&quot;</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pair:<br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(pair) == <span class="hljs-number">2</span>,<span class="hljs-string">&quot;长度必须是2&quot;</span><br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(pair[<span class="hljs-number">0</span>].strip())&gt;=<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(pair[<span class="hljs-number">1</span>].strip())&gt;=<span class="hljs-number">1</span>:<br>                    f_input.write(pair[<span class="hljs-number">0</span>]+<span class="hljs-string">&quot;\n&quot;</span>)<br>                    f_output.write(pair[<span class="hljs-number">1</span>]+<span class="hljs-string">&quot;\n&quot;</span>)<br>                pair = []<br>        <span class="hljs-keyword">elif</span> line.startswith(<span class="hljs-string">&quot;M&quot;</span>):<br>            line = line[<span class="hljs-number">1</span>:]<br>            <span class="hljs-keyword">if</span> word:<br>                pair.append(<span class="hljs-string">&quot; &quot;</span>.join(<span class="hljs-built_in">list</span>(line.strip())))<br>            <span class="hljs-keyword">else</span>:<br>                pair.append(<span class="hljs-string">&quot; &quot;</span>.join(jieba_cut(line.strip())))<br><br></code></pre></td></tr></table></figure><h3 id="2-2-微博语料的处理"><a href="#2-2-微博语料的处理" class="headerlink" title="2.2 微博语料的处理"></a>2.2 微博语料的处理</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">format_weibo</span>(<span class="hljs-params">word=<span class="hljs-literal">False</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    微博数据存在一些噪声，未处理</span><br><span class="hljs-string">    :return:</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> word:<br>        origin_input = <span class="hljs-string">&quot;./chatbot/corpus/stc_weibo_train_post&quot;</span><br>        input_path = <span class="hljs-string">&quot;./chatbot/corpus/input_word.txt&quot;</span><br><br>        origin_output = <span class="hljs-string">&quot;./chatbot/corpus/stc_weibo_train_response&quot;</span><br>        output_path = <span class="hljs-string">&quot;./chatbot/corpus/output_word.txt&quot;</span><br><br>    <span class="hljs-keyword">else</span>:<br>        origin_input = <span class="hljs-string">&quot;./chatbot/corpus/stc_weibo_train_post&quot;</span><br>        input_path = <span class="hljs-string">&quot;./chatbot/corpus/input.txt&quot;</span><br><br>        origin_output = <span class="hljs-string">&quot;./chatbot/corpus/stc_weibo_train_response&quot;</span><br>        output_path = <span class="hljs-string">&quot;./chatbot/corpus/output.txt&quot;</span><br><br>    f_input = <span class="hljs-built_in">open</span>(input_path,<span class="hljs-string">&quot;a&quot;</span>)<br>    f_output = <span class="hljs-built_in">open</span>(output_path, <span class="hljs-string">&quot;a&quot;</span>)<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(origin_input) <span class="hljs-keyword">as</span> in_o,<span class="hljs-built_in">open</span>(origin_output) <span class="hljs-keyword">as</span> out_o:<br>        <span class="hljs-keyword">for</span> _<span class="hljs-keyword">in</span>,_out <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">zip</span>(in_o,out_o),<span class="hljs-built_in">ascii</span>=<span class="hljs-literal">True</span>):<br>            _<span class="hljs-keyword">in</span> = _<span class="hljs-keyword">in</span>.strip()<br>            _out = _out.strip()<br><br>            <span class="hljs-keyword">if</span> _<span class="hljs-keyword">in</span>.endswith(<span class="hljs-string">&quot;）&quot;</span>) <span class="hljs-keyword">or</span> _<span class="hljs-keyword">in</span>.endswith(<span class="hljs-string">&quot;」&quot;</span>) <span class="hljs-keyword">or</span> _<span class="hljs-keyword">in</span>.endswith(<span class="hljs-string">&quot;)&quot;</span>):<br>                _<span class="hljs-keyword">in</span> = re.sub(<span class="hljs-string">&quot;（.*）|「.*?」|\(.*?\)&quot;</span>,<span class="hljs-string">&quot; &quot;</span>,_<span class="hljs-keyword">in</span>)<br>            _<span class="hljs-keyword">in</span> = re.sub(<span class="hljs-string">&quot;我在.*?alink|alink|（.*?\d+x\d+.*?）|#|】|【|-+|_+|via.*?：*.*&quot;</span>,<span class="hljs-string">&quot; &quot;</span>,_<span class="hljs-keyword">in</span>)<br><br>            _<span class="hljs-keyword">in</span> = re.sub(<span class="hljs-string">&quot;\s+&quot;</span>,<span class="hljs-string">&quot; &quot;</span>,_<span class="hljs-keyword">in</span>)<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(_<span class="hljs-keyword">in</span>)&lt;<span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(_out)&lt;<span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> word:<br>                _<span class="hljs-keyword">in</span> = re.sub(<span class="hljs-string">&quot;\s+&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,_<span class="hljs-keyword">in</span>)  <span class="hljs-comment">#转化为一整行，不含空格</span><br>                _out = re.sub(<span class="hljs-string">&quot;\s+&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,_out)<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(_<span class="hljs-keyword">in</span>)&gt;=<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(_out)&gt;=<span class="hljs-number">1</span>:<br>                    f_input.write(<span class="hljs-string">&quot; &quot;</span>.join(<span class="hljs-built_in">list</span>(_<span class="hljs-keyword">in</span>)) + <span class="hljs-string">&quot;\n&quot;</span>)<br>                    f_output.write(<span class="hljs-string">&quot; &quot;</span>.join(<span class="hljs-built_in">list</span>(_out)) + <span class="hljs-string">&quot;\n&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(_<span class="hljs-keyword">in</span>) &gt;= <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(_out) &gt;= <span class="hljs-number">1</span>:<br>                    f_input.write(_<span class="hljs-keyword">in</span>.strip()+<span class="hljs-string">&quot;\n&quot;</span>)<br>                    f_output.write(_out.strip()+<span class="hljs-string">&quot;\n&quot;</span>)<br><br>    f_input.close()<br>    f_output.close()<br></code></pre></td></tr></table></figure><h3 id="2-3-处理后的结果"><a href="#2-3-处理后的结果" class="headerlink" title="2.3 处理后的结果"></a>2.3 处理后的结果</h3><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E5%90%8E.png"></p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E5%90%8E2.png"></p><h3 id="3-构造文本序列化和反序列化方法"><a href="#3-构造文本序列化和反序列化方法" class="headerlink" title="3. 构造文本序列化和反序列化方法"></a>3. 构造文本序列化和反序列化方法</h3><p>和之前的操作相同，需要把文本能转化为数字，同时还需实现方法把数字转化为文本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># word_sequence.py</span><br><span class="hljs-keyword">import</span> config<br><span class="hljs-keyword">import</span> pickle<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Word2Sequence</span>():<br>    UNK_TAG = <span class="hljs-string">&quot;UNK&quot;</span><br>    PAD_TAG = <span class="hljs-string">&quot;PAD&quot;</span><br>    SOS_TAG = <span class="hljs-string">&quot;SOS&quot;</span><br>    EOS_TAG = <span class="hljs-string">&quot;EOS&quot;</span><br><br>    UNK = <span class="hljs-number">0</span><br>    PAD = <span class="hljs-number">1</span><br>    SOS = <span class="hljs-number">2</span><br>    EOS = <span class="hljs-number">3</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.<span class="hljs-built_in">dict</span> = &#123;<br>            self.UNK_TAG :self.UNK,<br>            self.PAD_TAG :self.PAD,<br>            self.SOS_TAG :self.SOS,<br>            self.EOS_TAG :self.EOS<br>        &#125;<br>        self.count = &#123;&#125;<br>        self.fited = <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_index</span>(<span class="hljs-params">self,word</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;word -&gt; index&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">assert</span> self.fited == <span class="hljs-literal">True</span>,<span class="hljs-string">&quot;必须先进行fit操作&quot;</span><br>        <span class="hljs-keyword">return</span> self.<span class="hljs-built_in">dict</span>.get(word,self.UNK)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_word</span>(<span class="hljs-params">self,index</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;index -&gt; word&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">assert</span> self.fited , <span class="hljs-string">&quot;必须先进行fit操作&quot;</span><br>        <span class="hljs-keyword">if</span> index <span class="hljs-keyword">in</span> self.inversed_dict:<br>            <span class="hljs-keyword">return</span> self.inversed_dict[index]<br>        <span class="hljs-keyword">return</span> self.UNK_TAG<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.<span class="hljs-built_in">dict</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fit</span>(<span class="hljs-params">self, sentence</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :param sentence:[word1,word2,word3]</span><br><span class="hljs-string">        :param min_count: 最小出现的次数</span><br><span class="hljs-string">        :param max_count: 最大出现的次数</span><br><span class="hljs-string">        :param max_feature: 总词语的最大数量</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> sentence:<br>            <span class="hljs-keyword">if</span> a <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.count:<br>                self.count[a] = <span class="hljs-number">0</span><br>            self.count[a] += <span class="hljs-number">1</span><br><br>        self.fited = <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_vocab</span>(<span class="hljs-params">self, min_count=<span class="hljs-number">1</span>, max_count=<span class="hljs-literal">None</span>, max_feature=<span class="hljs-literal">None</span></span>):<br><br>        <span class="hljs-comment"># 比最小的数量大和比最大的数量小的需要</span><br>        <span class="hljs-keyword">if</span> min_count <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            self.count = &#123;k: v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> self.count.items() <span class="hljs-keyword">if</span> v &gt;= min_count&#125;<br>        <span class="hljs-keyword">if</span> max_count <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            self.count = &#123;k: v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> self.count.items() <span class="hljs-keyword">if</span> v &lt;= max_count&#125;<br><br>        <span class="hljs-comment"># 限制最大的数量</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(max_feature, <span class="hljs-built_in">int</span>):<br>            count = <span class="hljs-built_in">sorted</span>(<span class="hljs-built_in">list</span>(self.count.items()), key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>])<br>            <span class="hljs-keyword">if</span> max_feature <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(count) &gt; max_feature:<br>                count = count[-<span class="hljs-built_in">int</span>(max_feature):]<br>            <span class="hljs-keyword">for</span> w, _ <span class="hljs-keyword">in</span> count:<br>                self.<span class="hljs-built_in">dict</span>[w] = <span class="hljs-built_in">len</span>(self.<span class="hljs-built_in">dict</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(self.count.keys()):<br>                self.<span class="hljs-built_in">dict</span>[w] = <span class="hljs-built_in">len</span>(self.<span class="hljs-built_in">dict</span>)<br><br>        <span class="hljs-comment"># 准备一个index-&gt;word的字典</span><br>        self.inversed_dict = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(self.<span class="hljs-built_in">dict</span>.values(), self.<span class="hljs-built_in">dict</span>.keys()))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">self, sentence,max_len=<span class="hljs-literal">None</span>,add_eos=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        实现吧句子转化为数组（向量）</span><br><span class="hljs-string">        :param sentence:</span><br><span class="hljs-string">        :param max_len:</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">assert</span> self.fited, <span class="hljs-string">&quot;必须先进行fit操作&quot;</span><br><br>        r = [self.to_index(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> sentence]<br>        <span class="hljs-keyword">if</span> max_len <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">if</span> max_len&gt;<span class="hljs-built_in">len</span>(sentence):<br>                <span class="hljs-keyword">if</span> add_eos:<br>                    r+=[self.EOS]+[self.PAD <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_len-<span class="hljs-built_in">len</span>(sentence)-<span class="hljs-number">1</span>)]<br>                <span class="hljs-keyword">else</span>:<br>                    r += [self.PAD <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_len - <span class="hljs-built_in">len</span>(sentence))]<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">if</span> add_eos:<br>                    r = r[:max_len-<span class="hljs-number">1</span>]<br>                    r += [self.EOS]<br>                <span class="hljs-keyword">else</span>:<br>                    r = r[:max_len]<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> add_eos:<br>                r += [self.EOS]<br>        <span class="hljs-comment"># print(len(r),r)</span><br>        <span class="hljs-keyword">return</span> r<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inverse_transform</span>(<span class="hljs-params">self,indices</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        实现从数组 转化为 向量</span><br><span class="hljs-string">        :param indices: [1,2,3....]</span><br><span class="hljs-string">        :return:[word1,word2.....]</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        sentence = []<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> indices:<br>            word = self.to_word(i)<br>            sentence.append(word)<br>        <span class="hljs-keyword">return</span> sentence<br><br><span class="hljs-comment">#之后导入该word_sequence使用</span><br>word_sequence = pickle.load(<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./pkl/ws.pkl&quot;</span>,<span class="hljs-string">&quot;rb&quot;</span>)) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> config.use_word <span class="hljs-keyword">else</span> pickle.load(<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./pkl/ws_word.pkl&quot;</span>,<span class="hljs-string">&quot;rb&quot;</span>))<br><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">from</span> word_sequence <span class="hljs-keyword">import</span> Word2Sequence<br>    <span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br>    <span class="hljs-keyword">import</span> pickle<br><br>    word_sequence = Word2Sequence()<br>    <span class="hljs-comment">#词语级别</span><br>    input_path = <span class="hljs-string">&quot;../corpus/input.txt&quot;</span><br>    target_path = <span class="hljs-string">&quot;../corpus/output.txt&quot;</span><br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">open</span>(input_path).readlines()):<br>        word_sequence.fit(line.strip().split())<br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">open</span>(target_path).readlines()):<br>        word_sequence.fit(line.strip().split())<br><br>    <span class="hljs-comment">#使用max_feature=5000个数据</span><br>    word_sequence.build_vocab(min_count=<span class="hljs-number">5</span>,max_count=<span class="hljs-literal">None</span>,max_feature=<span class="hljs-number">5000</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(word_sequence))<br>    pickle.dump(word_sequence,<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./pkl/ws.pkl&quot;</span>,<span class="hljs-string">&quot;wb&quot;</span>))<br></code></pre></td></tr></table></figure><h3 id="4-构建Dataset和DataLoader"><a href="#4-构建Dataset和DataLoader" class="headerlink" title="4. 构建Dataset和DataLoader"></a>4. 构建Dataset和DataLoader</h3><p>创建<code>dataset.py</code>文件，准备数据集</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> config<br><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> Dataset,DataLoader<br><span class="hljs-keyword">from</span> word_sequence <span class="hljs-keyword">import</span> word_sequence<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatDataset</span>(<span class="hljs-title class_ inherited__">Dataset</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(ChatDataset,self).__init__()<br><br>        input_path = <span class="hljs-string">&quot;../corpus/input.txt&quot;</span><br>        target_path = <span class="hljs-string">&quot;../corpus/output.txt&quot;</span><br>        <span class="hljs-keyword">if</span> config.use_word:<br>            input_path = <span class="hljs-string">&quot;../corpus/input_word.txt&quot;</span><br>            target_path = <span class="hljs-string">&quot;../corpus/output_word.txt&quot;</span><br><br>        self.input_lines = <span class="hljs-built_in">open</span>(input_path).readlines()<br>        self.target_lines = <span class="hljs-built_in">open</span>(target_path).readlines()<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(self.input_lines) == <span class="hljs-built_in">len</span>(self.target_lines) ,<span class="hljs-string">&quot;input和target文本的数量必须相同&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, index</span>):<br>        <span class="hljs-built_in">input</span> = self.input_lines[index].strip().split()<br>        target = self.target_lines[index].strip().split()<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">input</span>) == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(target)==<span class="hljs-number">0</span>:<br>            <span class="hljs-built_in">input</span> = self.input_lines[index+<span class="hljs-number">1</span>].strip().split()<br>            target = self.target_lines[index+<span class="hljs-number">1</span>].strip().split()<br>        <span class="hljs-comment">#此处句子的长度如果大于max_len，那么应该返回max_len</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">input</span>,target,<span class="hljs-built_in">min</span>(<span class="hljs-built_in">len</span>(<span class="hljs-built_in">input</span>),config.max_len),<span class="hljs-built_in">min</span>(<span class="hljs-built_in">len</span>(target),config.max_len)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.input_lines)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">collate_fn</span>(<span class="hljs-params">batch</span>):<br>    <span class="hljs-comment">#1.排序</span><br>    batch = <span class="hljs-built_in">sorted</span>(batch,key=<span class="hljs-keyword">lambda</span> x:x[<span class="hljs-number">2</span>],reverse=<span class="hljs-literal">True</span>)<br>    <span class="hljs-built_in">input</span>, target, input_length, target_length = <span class="hljs-built_in">zip</span>(*batch)<br><br>    <span class="hljs-comment"># 2.进行padding的操作</span><br>    <span class="hljs-built_in">input</span> = torch.LongTensor([word_sequence.transform(i, max_len=config.max_len) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">input</span>])<br>    target = torch.LongTensor([word_sequence.transform(i, max_len=config.max_len, add_eos=<span class="hljs-literal">True</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> target])<br>    input_length = torch.LongTensor(input_length)<br>    target_length = torch.LongTensor(target_length)<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">input</span>, target, input_length, target_length<br><br>data_loader = DataLoader(dataset=ChatDataset(),batch_size=config.batch_size,shuffle=<span class="hljs-literal">True</span>,collate_fn=collate_fn,drop_last=<span class="hljs-literal">True</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">for</span> idx, (<span class="hljs-built_in">input</span>, target, input_lenght, target_length) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(data_loader):<br>        <span class="hljs-built_in">print</span>(idx)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">input</span>)<br>        <span class="hljs-built_in">print</span>(target)<br>        <span class="hljs-built_in">print</span>(input_lenght)<br>        <span class="hljs-built_in">print</span>(target_length)<br></code></pre></td></tr></table></figure><h2 id="5-完成encoder编码器逻辑"><a href="#5-完成encoder编码器逻辑" class="headerlink" title="5. 完成encoder编码器逻辑"></a>5. 完成<code>encoder</code>编码器逻辑</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">from</span> word_sequence <span class="hljs-keyword">import</span> word_sequence<br><span class="hljs-keyword">import</span> config<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Encoder</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(Encoder,self).__init__()<br>        self.vocab_size = <span class="hljs-built_in">len</span>(word_sequence)<br>        self.dropout = config.dropout<br>        self.embedding_dim = config.embedding_dim<br>        self.embedding = nn.Embedding(num_embeddings=self.vocab_size,embedding_dim=self.embedding_dim,padding_idx=word_sequence.PAD)<br>        self.gru = nn.GRU(input_size=self.embedding_dim,<br>                          hidden_size=config.hidden_size,<br>                          num_layers=<span class="hljs-number">1</span>,<br>                          batch_first=<span class="hljs-literal">True</span>,<br>                          dropout=config.dropout)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>,input_length</span>):<br>        embeded = self.embedding(<span class="hljs-built_in">input</span>)<br>        embeded = nn.utils.rnn.pack_padded_sequence(embeded,lengths=input_length,batch_first=<span class="hljs-literal">True</span>)<br><br>        <span class="hljs-comment">#hidden:[1,batch_size,vocab_size]</span><br>        out,hidden = self.gru(embeded)<br>        out,outputs_length = nn.utils.rnn.pad_packed_sequence(out,batch_first=<span class="hljs-literal">True</span>,padding_value=word_sequence.PAD)<br>        <span class="hljs-comment">#hidden [1,batch_size,hidden_size]</span><br>        <span class="hljs-keyword">return</span> out,hidden<br></code></pre></td></tr></table></figure><h2 id="6-完成decoder解码器的逻辑"><a href="#6-完成decoder解码器的逻辑" class="headerlink" title="6. 完成decoder解码器的逻辑"></a>6. 完成<code>decoder</code>解码器的逻辑</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">import</span> config<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><span class="hljs-keyword">from</span> word_sequence <span class="hljs-keyword">import</span> word_sequence<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Decoder</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(Decoder,self).__init__()<br>        self.max_seq_len = config.max_len<br>        self.vocab_size = <span class="hljs-built_in">len</span>(word_sequence)<br>        self.embedding_dim = config.embedding_dim<br>        self.dropout = config.dropout<br><br>        self.embedding = nn.Embedding(num_embeddings=self.vocab_size,embedding_dim=self.embedding_dim,padding_idx=word_sequence.PAD)<br>        self.gru = nn.GRU(input_size=self.embedding_dim,<br>                          hidden_size=config.hidden_size,<br>                          num_layers=<span class="hljs-number">1</span>,<br>                          batch_first=<span class="hljs-literal">True</span>,<br>                          dropout=self.dropout)<br>        self.log_softmax = nn.LogSoftmax()<br><br>        self.fc = nn.Linear(config.hidden_size,self.vocab_size)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, encoder_hidden,target,target_length</span>):<br>        <span class="hljs-comment"># encoder_hidden [batch_size,hidden_size]</span><br>        <span class="hljs-comment"># target [batch_size,seq-len]</span><br><br>        decoder_input = torch.LongTensor([[word_sequence.SOS]]*config.batch_size).to(config.device)<br>        decoder_outputs = torch.zeros(config.batch_size,config.max_len,self.vocab_size).to(config.device) <span class="hljs-comment">#[batch_size,seq_len,14]</span><br><br>        decoder_hidden = encoder_hidden <span class="hljs-comment">#[batch_size,hidden_size]</span><br><br>        <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(config.max_len):<br>            decoder_output_t , decoder_hidden = self.forward_step(decoder_input,decoder_hidden)<br>            decoder_outputs[:,t,:] = decoder_output_t<br>            value, index = torch.topk(decoder_output_t, <span class="hljs-number">1</span>) <span class="hljs-comment"># index [batch_size,1]</span><br>            decoder_input = index<br>        <span class="hljs-keyword">return</span> decoder_outputs,decoder_hidden<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward_step</span>(<span class="hljs-params">self,decoder_input,decoder_hidden</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :param decoder_input:[batch_size,1]</span><br><span class="hljs-string">        :param decoder_hidden: [1,batch_size,hidden_size]</span><br><span class="hljs-string">        :return: out:[batch_size,vocab_size],decoder_hidden:[1,batch_size,didden_size]</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        embeded = self.embedding(decoder_input)  <span class="hljs-comment">#embeded: [batch_size,1 , embedding_dim]</span><br>        out,decoder_hidden = self.gru(embeded,decoder_hidden) <span class="hljs-comment">#out [1, batch_size, hidden_size]</span><br>        out = out.squeeze(<span class="hljs-number">0</span>)<br>        out = F.log_softmax(self.fc(out),dim=-<span class="hljs-number">1</span>)<span class="hljs-comment">#[batch_Size, vocab_size]</span><br>        out = out.squeeze(<span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># print(&quot;out size:&quot;,out.size(),decoder_hidden.size())</span><br>        <span class="hljs-keyword">return</span> out,decoder_hidden<br></code></pre></td></tr></table></figure><h2 id="7-完成seq2seq的模型"><a href="#7-完成seq2seq的模型" class="headerlink" title="7.完成seq2seq的模型"></a>7.完成seq2seq的模型</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Seq2Seq</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,encoder,decoder</span>):<br>        <span class="hljs-built_in">super</span>(Seq2Seq,self).__init__()<br>        self.encoder = encoder<br>        self.decoder = decoder<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>,target,input_length,target_length</span>):<br>        encoder_outputs,encoder_hidden = self.encoder(<span class="hljs-built_in">input</span>,input_length)<br>        decoder_outputs,decoder_hidden = self.decoder(encoder_hidden,target,target_length)<br>        <span class="hljs-keyword">return</span> decoder_outputs,decoder_hidden<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluation</span>(<span class="hljs-params">self,inputs,input_length</span>):<br>        encoder_outputs,encoder_hidden = self.encoder(inputs,input_length)<br>        decoded_sentence = self.decoder.evaluation(encoder_hidden)<br>        <span class="hljs-keyword">return</span> decoded_sentence<br></code></pre></td></tr></table></figure><h2 id="8-完成训练逻辑"><a href="#8-完成训练逻辑" class="headerlink" title="8. 完成训练逻辑"></a>8. 完成训练逻辑</h2><p>为了加速训练，可以考虑在gpu上运行，那么在我们自顶一个所以的tensor和model都需要转化为CUDA支持的类型。</p><p>当前的数据量为500多万条，在GTX1070（8G显存）上训练，大概需要90分一个epoch，耐心的等待吧</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> config<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> optim<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">from</span> encoder <span class="hljs-keyword">import</span> Encoder<br><span class="hljs-keyword">from</span> decoder <span class="hljs-keyword">import</span> Decoder<br><span class="hljs-keyword">from</span> seq2seq <span class="hljs-keyword">import</span> Seq2Seq<br><span class="hljs-keyword">from</span> dataset <span class="hljs-keyword">import</span> data_loader <span class="hljs-keyword">as</span> train_dataloader<br><span class="hljs-keyword">from</span> word_sequence <span class="hljs-keyword">import</span> word_sequence<br><br>encoder = Encoder()<br>decoder = Decoder()<br>model = Seq2Seq(encoder,decoder)<br><br><span class="hljs-comment">#device在config文件中实现</span><br>model.to(config.device)<br><br><span class="hljs-built_in">print</span>(model)<br><br>model.load_state_dict(torch.load(<span class="hljs-string">&quot;model/seq2seq_model.pkl&quot;</span>))<br>optimizer =  optim.Adam(model.parameters())<br>optimizer.load_state_dict(torch.load(<span class="hljs-string">&quot;model/seq2seq_optimizer.pkl&quot;</span>))<br>criterion= nn.NLLLoss(ignore_index=word_sequence.PAD,reduction=<span class="hljs-string">&quot;mean&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_loss</span>(<span class="hljs-params">decoder_outputs,target</span>):<br>    target = target.view(-<span class="hljs-number">1</span>) <span class="hljs-comment">#[batch_size*max_len]</span><br>    decoder_outputs = decoder_outputs.view(config.batch_size*config.max_len,-<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span> criterion(decoder_outputs,target)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">epoch</span>):<br>    <span class="hljs-keyword">for</span> idx,(<span class="hljs-built_in">input</span>,target,input_length,target_len) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_dataloader):<br>        <span class="hljs-built_in">input</span> = <span class="hljs-built_in">input</span>.to(config.device)<br>        target = target.to(config.device)<br>        input_length = input_length.to(config.device)<br>        target_len = target_len.to(config.device)<br><br>        optimizer.zero_grad()<br>        <span class="hljs-comment">##[seq_len,batch_size,vocab_size] [batch_size,seq_len]</span><br>        decoder_outputs,decoder_hidden = model(<span class="hljs-built_in">input</span>,target,input_length,target_len)<br>        loss = get_loss(decoder_outputs,target)<br>        loss.backward()<br>        optimizer.step()<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Train Epoch: &#123;&#125; [&#123;&#125;/&#123;&#125; (&#123;:.0f&#125;%)]\tLoss: &#123;:.6f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<br>            epoch, idx * <span class="hljs-built_in">len</span>(<span class="hljs-built_in">input</span>), <span class="hljs-built_in">len</span>(train_dataloader.dataset),<br>                   <span class="hljs-number">100.</span> * idx / <span class="hljs-built_in">len</span>(train_dataloader), loss.item()))<br><br>        torch.save(model.state_dict(), <span class="hljs-string">&quot;model/seq2seq_model.pkl&quot;</span>)<br>        torch.save(optimizer.state_dict(), <span class="hljs-string">&#x27;model/seq2seq_optimizer.pkl&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>        train(i)<br></code></pre></td></tr></table></figure><p>训练10个epoch之后的效果如下,可以看出损失依然很高：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dns">Train Epoch: <span class="hljs-number">9</span> [<span class="hljs-number">2444544</span>/<span class="hljs-number">4889919</span> (<span class="hljs-number">50</span>%)]Loss: <span class="hljs-number">4.923604</span><br>Train Epoch: <span class="hljs-number">9</span> [<span class="hljs-number">2444800</span>/<span class="hljs-number">4889919</span> (<span class="hljs-number">50</span>%)]Loss: <span class="hljs-number">4.364594</span><br>Train Epoch: <span class="hljs-number">9</span> [<span class="hljs-number">2445056</span>/<span class="hljs-number">4889919</span> (<span class="hljs-number">50</span>%)]Loss: <span class="hljs-number">4.613254</span><br>Train Epoch: <span class="hljs-number">9</span> [<span class="hljs-number">2445312</span>/<span class="hljs-number">4889919</span> (<span class="hljs-number">50</span>%)]Loss: <span class="hljs-number">4.143538</span><br>Train Epoch: <span class="hljs-number">9</span> [<span class="hljs-number">2445568</span>/<span class="hljs-number">4889919</span> (<span class="hljs-number">50</span>%)]Loss: <span class="hljs-number">4.412729</span><br>Train Epoch: <span class="hljs-number">9</span> [<span class="hljs-number">2445824</span>/<span class="hljs-number">4889919</span> (<span class="hljs-number">50</span>%)]Loss: <span class="hljs-number">4.516526</span><br>Train Epoch: <span class="hljs-number">9</span> [<span class="hljs-number">2446080</span>/<span class="hljs-number">4889919</span> (<span class="hljs-number">50</span>%)]Loss: <span class="hljs-number">4.124945</span><br>Train Epoch: <span class="hljs-number">9</span> [<span class="hljs-number">2446336</span>/<span class="hljs-number">4889919</span> (<span class="hljs-number">50</span>%)]Loss: <span class="hljs-number">4.777015</span><br>Train Epoch: <span class="hljs-number">9</span> [<span class="hljs-number">2446592</span>/<span class="hljs-number">4889919</span> (<span class="hljs-number">50</span>%)]Loss: <span class="hljs-number">4.358538</span><br>Train Epoch: <span class="hljs-number">9</span> [<span class="hljs-number">2446848</span>/<span class="hljs-number">4889919</span> (<span class="hljs-number">50</span>%)]Loss: <span class="hljs-number">4.513412</span><br>Train Epoch: <span class="hljs-number">9</span> [<span class="hljs-number">2447104</span>/<span class="hljs-number">4889919</span> (<span class="hljs-number">50</span>%)]Loss: <span class="hljs-number">4.202757</span><br>Train Epoch: <span class="hljs-number">9</span> [<span class="hljs-number">2447360</span>/<span class="hljs-number">4889919</span> (<span class="hljs-number">50</span>%)]Loss: <span class="hljs-number">4.589584</span><br></code></pre></td></tr></table></figure><h2 id="9-小结"><a href="#9-小结" class="headerlink" title="9.小结"></a>9.小结</h2><p>效果不好</p><h1 id="Attention的原理和实现"><a href="#Attention的原理和实现" class="headerlink" title="Attention的原理和实现"></a>Attention的原理和实现</h1><h2 id="目标-23"><a href="#目标-23" class="headerlink" title="目标"></a>目标</h2><ol><li>知道Attention的作用</li><li>知道Attention的实现机制</li><li>能够使用代码完成Attention代码的编写</li></ol><h2 id="1-Attention的介绍"><a href="#1-Attention的介绍" class="headerlink" title="1. Attention的介绍"></a>1. Attention的介绍</h2><p>在普通的RNN结构中，Encoder需要把一个句子转化为一个向量，然后在Decoder中使用，这就要求Encoder把源句子中所有的信息都包含进去，但是当句子长度过长的时候，这个要求就很难达到，或者说会产生瓶颈（比如，输入一篇文章等场长内容），当然我们可以使用更深的RNN和大多的单元来解决这个问题，但是这样的代价也很大。那么有没有什么方法能够优化现有的RNN结构呢？</p><p>为此，Bahdanau等人在2015年提出了<code>Attenion</code>机制，<code>Attention</code>翻译成为中文叫做注意力，把这种模型称为<code>Attention based model</code>。就像我们自己看到一副画，我们能够很快的说出画的主要内容，而忽略画中的背景，因为我们注意的，更关注的往往是其中的主要内容。</p><p>通过这种方式，在我们的RNN中，我们有通过LSTM或者是GRU得到的所有信息，那么这些信息中只去关注重点，而不需要在Decoder的每个time step使用全部的encoder的信息，这样就可以解决第一段所说的问题了</p><p>那么现在要讲的<code>Attention机制</code>就能够帮助我们解决这个问题</p><h2 id="2-Attenion的实现机制"><a href="#2-Attenion的实现机制" class="headerlink" title="2. Attenion的实现机制"></a>2. Attenion的实现机制</h2><p>假设我们现在有一个文本翻译的需求，即<code>机器学习</code>翻译为<code>machine learning</code>。那么这个过程通过前面所学习的Seq2Seq就可以实现</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/attention1.png"></p><p>上图的左边是Encoder，能够得到<code>hidden_state</code>在右边使用</p><p>Deocder中<strong>蓝色方框</strong>中的内容，是为了提高模型的训练速度而使用teacher forcing手段，否则的话会把前一次的输出作为下一次的输入（<strong>但是在Attention模型中不再是这样了</strong>）</p><p>那么整个过程中如果使用Attention应该怎么做呢？</p><p>在之前我们把encoder的最后一个输出，作为decoder的初始的隐藏状态，现在我们不再这样做</p><h3 id="2-1-Attention的实现过程"><a href="#2-1-Attention的实现过程" class="headerlink" title="2.1 Attention的实现过程"></a>2.1 Attention的实现过程</h3><ol><li><p>初始化一个Decoder的隐藏状态$z_0$</p></li><li><p>这个$z_o$会和encoder第一个time step的output进行match操作（或者是socre操作），得到$\alpha_0^1$ ，这里的match可以使很多中操作，比如：</p><ul><li>z和h的余弦值</li><li>是一个神经网络，输入为z和h</li><li>或者$\alpha &#x3D; h^T W z$等</li><li><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/Attention2.png"></li></ul></li><li><p>encoder中的每个output都和$z_0$进行计算之后，得到的结果进行softmax，让他们的和为1(可以理解为权重)</p></li><li><p>之后把所有的softmax之后的结果和原来encoder的输出$h_i$进行相加求和得到$c^0$<br>$$<br>即： c^0 &#x3D; \sum\hat{\alpha}_0^ih^i<br>$$</p><ul><li><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/Attention3.png"></li></ul></li><li><p>得到$c^0$之后，把它作为decoder的input，同和传入初始化的$z^0$，得到第一个time step的输出和hidden_state（$Z^1$）</p><ul><li><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/Attention4.png"></li></ul></li><li><p>把$Z_1$再和所有的encoder的output进行match操作，得到的结果进行softmax之后作为权重和encoder的每个timestep的结果相乘求和得到$c^1$</p></li><li><p>再把$c^1$作为decoder的input，和$Z^1$作为输入得到下一个输出，如此循环,只到最终decoder的output为终止符</p><ul><li><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/Attention5.png"></li></ul></li><li><p>上述参考：<a href="http://speech.ee.ntu.edu.tw/~tlkagk/courses_MLSD15_2.html">http://speech.ee.ntu.edu.tw/~tlkagk/courses_MLSD15_2.html</a></p></li><li><p>整个过程写成数学公式如下：<br>$$<br>\begin{align*}<br>\alpha_{ij} &amp;&#x3D; \frac{exp(score(h_i,\overline{h}_j))}{\sum exp(score(h_n,\overline{h}<em>m))} &amp; [attention \quad weight]\<br>c_i &amp;&#x3D;\sum \alpha</em>{ij}\overline{h}_s  &amp; [context\quad vector] \<br>\alpha_i &amp;&#x3D; f(c_i,h_i) &#x3D; tanh(W_c[c_i;h_i]) &amp;[attenton \quad result]<br>\end{align*}<br>$$</p><ol><li>先计算attention权重</li><li>在计算上下文向量，图中的$c^i$</li><li>最后计算结果，往往会把当前的output([batch_size,1,hidden_size])和上下文向量进行拼接然后使用</li></ol></li></ol><h3 id="2-2-不同Attention的介绍"><a href="#2-2-不同Attention的介绍" class="headerlink" title="2.2 不同Attention的介绍"></a>2.2 不同Attention的介绍</h3><p>在上述过程中，使用decoder的状态和encoder的状态的计算后的结果作为权重，乘上encoder每个时间步的输出，这需要我们去训练一个合适的match函数，得到的结果就能够在不同的时间步上使用不同的encoder的相关信息，从而达到只关注某一个局部的效果，也就是注意力的效果</p><h3 id="2-2-1-Soft-Attention-和-Hard-Attention"><a href="#2-2-1-Soft-Attention-和-Hard-Attention" class="headerlink" title="2.2.1 Soft-Attention 和 Hard-Attention"></a>2.2.1 <code>Soft-Attention 和 Hard-Attention</code></h3><p>最开始<code>Bahdanau</code>等人提出的Attention机制通常被称为<code>soft-attention</code>,所谓的<code>soft-attention</code>指的是encoder中输入的每个词语都会计算得到一个注意力的概率。</p><p>在进行图像捕捉的时候，提出了一种<code>hard-attenion</code>的方法，希望直接从input中找到一个和输出的某个词对应的那一个词。但是由于NLP中词语和词语之间往往存在联系，不会只关注某一个词语，所以都会使用soft-attention，所以这里的就不多介绍hard-attention</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/soft-hard%20attention.jpg"></p><h3 id="2-2-3-Global-Attention-和Local-Attention"><a href="#2-2-3-Global-Attention-和Local-Attention" class="headerlink" title="2.2.3 Global-Attention 和Local Attention"></a>2.2.3 <code>Global-Attention 和Local Attention</code></h3><p><code>Bahdanau</code>等人提出的<code>Bahdanau Attention</code> 被称为<code>local attention</code>,后来<code>Luong</code>等人提出的<code>Luong Attention</code>是一种全局的attenion。</p><p>所谓全局的attenion指的是：使用的全部的encoder端的输入的attenion的权重</p><p><code>local-attenion</code>就是使用了部分的encoder端的输入的权重(当前时间步上的encoder的hidden state)，这样可以减少计算量，特别是当句子的长度比较长的时候。</p><h3 id="2-2-4-Bahdanau-Attention和-Luong-Attenion的区别"><a href="#2-2-4-Bahdanau-Attention和-Luong-Attenion的区别" class="headerlink" title="2.2.4  Bahdanau Attention和 Luong Attenion的区别"></a>2.2.4  <code>Bahdanau Attention和 Luong Attenion</code>的区别</h3><p>区别在于两个地方：</p><ol><li><p>attention的计算数据和位置</p><ol><li><code>Bahdanau Attention</code>会使用<code>前一次的隐藏</code>状态来计算attention weight，所以我们会在代码中的GRU之前使用attention的操作，同时会把attention的结果和word embedding的结果进行concat，作为GRU的输出(参考的是pytorch Toritul)。Bahdanau使用的是双向的GRU，会使用正反的encoder的output的concat的结果作为encoder output,如下图所示<ul><li><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/Bahdanau.png"></li></ul></li><li><code>Luong Attenion</code>使用的是<code>当前一次的decoder的output</code>来计算得到attention weight，所以在代码中会在GRU的后面进行attention的操作，同时会把<code>context vector</code>和gru的结果进行concat的操作，最终的output。Luong使用的是多层GRU，只会使用最后一层的输出(encoder output)<ul><li><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/Luong.png"></li></ul></li></ol></li><li><p>计算attention weights的方法不同</p><ol><li><p><code>Bahdanau Attention</code>的match函数，$a_i^j &#x3D; v^T_a tanh (W_aZ_{i-1},+U_ah_j)$，计算出所有的$a_i^j$之后，在计算softmax，得到$\hat{a}_i^j$，即$\hat{a}_i^j &#x3D; \frac{exp(a_i^j)}{\sum exp(a_i^j)}$</p><p>其中</p><ol><li>$v_a^T是一个参数矩阵，需要被训练，W_a是实现对Z_{i-1}的形状变化$，</li><li>$U_a实现对h_j的形状变化（矩阵乘法，理解为线性回归，实现数据形状的对齐）$，</li><li>$Z_{i-1}是decoder端前一次的隐藏状态，h_j是encoder的output$</li></ol></li><li><p><code>Luong Attenion</code>整体比<code>Bahdanau Attention</code>更加简单，他使用了三种方法来计算得到权重</p><ol><li>矩阵乘法：general<ul><li>直接对decoder的隐藏状态进行一个矩阵变换（线性回归），然后和encoder outputs进行矩阵乘法</li></ul></li><li>dot<ul><li>直接对decoder的隐藏状态和encoder outputs进行矩阵乘法</li></ul></li><li>concat<ul><li>把decoder的隐藏状态和encoder的output进行concat，把这个结果使用tanh进行处理后的结果进行对齐计算之后，和encoder outputs进行矩阵乘法</li></ul></li><li><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/scores.png"><ul><li>$h_t\text{是当前的decoder hidden state,}h_s\text{是所有的encoder 的hidden state(encoder outputs)}$</li></ul></li></ol></li></ol></li></ol><p>最终两个attention的结果区别并不太大，所以以后我们可以考虑使用Luong attention完成代码</p><h2 id="3-Attention的代码实现"><a href="#3-Attention的代码实现" class="headerlink" title="3. Attention的代码实现"></a>3. Attention的代码实现</h2><p>完成代码之前，我们需要确定我们的思路，通过attention的代码，需要实现计算的是attention weight</p><p>通过前面的学习，我们知道<code>attention_weight = f(hidden,encoder_outputs)</code>，主要就是实现Luong attention中的三种操作</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/attention6.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Attention</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,method,batch_size,hidden_size</span>):<br>        <span class="hljs-built_in">super</span>(Attention,self).__init__()<br>        self.method = method<br>        self.hidden_size = hidden_size<br><br>        <span class="hljs-keyword">assert</span> self.method <span class="hljs-keyword">in</span> [<span class="hljs-string">&quot;dot&quot;</span>,<span class="hljs-string">&quot;general&quot;</span>,<span class="hljs-string">&quot;concat&quot;</span>],<span class="hljs-string">&quot;method 只能是 dot,general,concat,当前是&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(self.method)<br><br>        <span class="hljs-keyword">if</span> self.method == <span class="hljs-string">&quot;dot&quot;</span>:<br>            <span class="hljs-keyword">pass</span><br>        <span class="hljs-keyword">elif</span> self.method == <span class="hljs-string">&quot;general&quot;</span>:<br>            self.Wa = nn.Linear(hidden_size,hidden_size,bias=<span class="hljs-literal">False</span>)<br>        <span class="hljs-keyword">elif</span> self.method == <span class="hljs-string">&quot;concat&quot;</span>:<br>            self.Wa = nn.Linear(hidden_size*<span class="hljs-number">2</span>,hidden_size,bias=<span class="hljs-literal">False</span>)<br>            self.Va = nn.Parameter(torch.FloatTensor(batch_size,hidden_size))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, hidden,encoder_outputs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :param hidden:[1,batch_size,hidden_size]</span><br><span class="hljs-string">        :param encoder_outputs: [batch_size,seq_len,hidden_size]</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        batch_size,seq_len,hidden_size = encoder_outputs.size()<br><br>        hidden = hidden.squeeze(<span class="hljs-number">0</span>) <span class="hljs-comment">#[batch_size,hidden_size]</span><br><br>        <span class="hljs-keyword">if</span> self.method == <span class="hljs-string">&quot;dot&quot;</span>:<br>            <span class="hljs-keyword">return</span> self.dot_score(hidden,encoder_outputs)<br>        <span class="hljs-keyword">elif</span> self.method == <span class="hljs-string">&quot;general&quot;</span>:<br>            <span class="hljs-keyword">return</span> self.general_score(hidden,encoder_outputs)<br>        <span class="hljs-keyword">elif</span> self.method == <span class="hljs-string">&quot;concat&quot;</span>:<br>            <span class="hljs-keyword">return</span> self.concat_score(hidden,encoder_outputs)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_score</span>(<span class="hljs-params">self,batch_size,seq_len,hidden,encoder_outputs</span>):<br>        <span class="hljs-comment"># 速度太慢</span><br>        <span class="hljs-comment"># [batch_size,seql_len]</span><br>        attn_energies = torch.zeros(batch_size,seq_len).to(config.device)<br>        <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(batch_size):<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(seq_len):<br>                <span class="hljs-comment">#encoder_output : [batch_size,seq_len,hidden_size]</span><br>                <span class="hljs-comment">#deocder_hidden :[batch_size,hidden_size]</span><br>                <span class="hljs-comment">#torch.Size([256, 128]) torch.Size([128]) torch.Size([256, 24, 128]) torch.Size([128])</span><br>                <span class="hljs-comment"># print(&quot;attn size:&quot;,hidden.size(),hidden[b,:].size(),encoder_output.size(),encoder_output[b,i].size())</span><br>                    attn_energies[b,i] = hidden[b,:].dot(encoder_outputs[b,i]) <span class="hljs-comment">#dot score</span><br>        <span class="hljs-keyword">return</span> F.softmax(attn_energies).unsqueeze(<span class="hljs-number">1</span>)  <span class="hljs-comment"># [batch_size,1,seq_len]</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">dot_score</span>(<span class="hljs-params">self,hidden,encoder_outputs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        dot attention</span><br><span class="hljs-string">        :param hidden:[batch_size,hidden_size] ---&gt;[batch_size,hidden_size,1]</span><br><span class="hljs-string">        :param encoder_outputs: [batch_size,seq_len,hidden_size]</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment">#hiiden :[hidden_size] --&gt;[hidden_size,1] ，encoder_output:[seq_len,hidden_size]</span><br>        <br>        <br>        hidden = hidden.unsqueeze(-<span class="hljs-number">1</span>)<br>        attn_energies = torch.bmm(encoder_outputs, hidden)<br>        attn_energies = attn_energies.squeeze(-<span class="hljs-number">1</span>) <span class="hljs-comment">#[batch_size,seq_len,1] ==&gt;[batch_size,seq_len]</span><br><br>        <span class="hljs-keyword">return</span> F.softmax(attn_energies).unsqueeze(<span class="hljs-number">1</span>)  <span class="hljs-comment"># [batch_size,1,seq_len]</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">general_score</span>(<span class="hljs-params">self,hidden,encoder_outputs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        general attenion</span><br><span class="hljs-string">        :param batch_size:int</span><br><span class="hljs-string">        :param hidden: [batch_size,hidden_size]</span><br><span class="hljs-string">        :param encoder_outputs: [batch_size,seq_len,hidden_size]</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        x = self.Wa(hidden) <span class="hljs-comment">#[batch_size,hidden_size]</span><br>        x = x.unsqueeze(-<span class="hljs-number">1</span>) <span class="hljs-comment">#[batch_size,hidden_size,1]</span><br>        attn_energies = torch.bmm(encoder_outputs,x).squeeze(-<span class="hljs-number">1</span>) <span class="hljs-comment">#[batch_size,seq_len,1]</span><br>        <span class="hljs-keyword">return</span> F.softmax(attn_energies,dim=-<span class="hljs-number">1</span>).unsqueeze(<span class="hljs-number">1</span>)      <span class="hljs-comment"># [batch_size,1,seq_len]</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">concat_score</span>(<span class="hljs-params">self,hidden,encoder_outputs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        concat attention</span><br><span class="hljs-string">        :param batch_size:int</span><br><span class="hljs-string">        :param hidden: [batch_size,hidden_size]</span><br><span class="hljs-string">        :param encoder_outputs: [batch_size,seq_len,hidden_size]</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment">#需要先进行repeat操作，变成和encoder_outputs相同的形状,让每个batch有seq_len个hidden_size</span><br>        x = hidden.repeat(<span class="hljs-number">1</span>,encoder_outputs.size(<span class="hljs-number">1</span>),<span class="hljs-number">1</span>) <span class="hljs-comment">##[batch_size,seq_len,hidden_size]</span><br>        x = torch.tanh(self.Wa(torch.cat([x,encoder_outputs],dim=-<span class="hljs-number">1</span>))) <span class="hljs-comment">#[batch_size,seq_len,hidden_size*2] --&gt; [batch_size,seq_len,hidden_size]</span><br>        <span class="hljs-comment">#va [batch_size,hidden_size] ---&gt; [batch_size,hidden_size,1]</span><br>        attn_energis = torch.bmm(x,self.Va.unsqueeze(<span class="hljs-number">2</span>))  <span class="hljs-comment">#[batch_size,seq_len,1]</span><br>        attn_energis = attn_energis.squeeze(-<span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># print(&quot;concat attention:&quot;,attn_energis.size(),encoder_outputs.size())</span><br>        <span class="hljs-keyword">return</span> F.softmax(attn_energis,dim=-<span class="hljs-number">1</span>).unsqueeze(<span class="hljs-number">1</span>) <span class="hljs-comment">#[batch_size,1,seq_len]</span><br></code></pre></td></tr></table></figure><p>完成了<code>attention weight</code>的计算之后，需要再对代码中<code>forward_step</code>的内容进行修改</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward_step</span>(<span class="hljs-params">self,decoder_input,decoder_hidden,encoder_outputs</span>):<br>       <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">       :param decoder_input:[batch_size,1]</span><br><span class="hljs-string">       :param decoder_hidden: [1,batch_size,hidden_size]</span><br><span class="hljs-string">       :param encoder_outputs: encoder中所有的输出，[batch_size,seq_len,hidden_size]</span><br><span class="hljs-string">       :return: out:[batch_size,vocab_size],decoder_hidden:[1,batch_size,didden_size]</span><br><span class="hljs-string">       &quot;&quot;&quot;</span><br>       embeded = self.embedding(decoder_input)  <span class="hljs-comment">#embeded: [batch_size,1 , embedding_dim]</span><br>       <br>       <span class="hljs-comment">#TODO 可以把embeded的结果和前一次的context（初始值为全0tensor） concate之后作为结果</span><br>       <span class="hljs-comment">#rnn_input = torch.cat((embeded, last_context.unsqueeze(0)), 2)</span><br>       <br>       <span class="hljs-comment"># gru_out:[256,1, 128]  decoder_hidden: [1, batch_size, hidden_size]</span><br>       gru_out,decoder_hidden = self.gru(embeded,decoder_hidden)<br>       gru_out = gru_out.squeeze(<span class="hljs-number">1</span>)<br>       <br>       <span class="hljs-comment">#TODO 注意：如果是单层，这里使用decoder_hidden没问题（output和hidden相同）</span><br>       <span class="hljs-comment"># 如果是多层，可以使用GRU的output作为attention的输入</span><br>       <span class="hljs-comment">#开始使用attention</span><br>       attn_weights = self.attn(decoder_hidden,encoder_outputs)<br>       <span class="hljs-comment"># attn_weights [batch_size,1,seq_len] * [batch_size,seq_len,hidden_size]</span><br>       context = attn_weights.bmm(encoder_outputs) <span class="hljs-comment">#[batch_size,1,hidden_size]</span><br><br>       gru_out = gru_out.squeeze(<span class="hljs-number">0</span>)  <span class="hljs-comment"># [batch_size,hidden_size]</span><br>       context = context.squeeze(<span class="hljs-number">1</span>)  <span class="hljs-comment"># [batch_size,hidden_size]</span><br>       <span class="hljs-comment">#把output和attention的结果合并到一起</span><br>       concat_input = torch.cat((gru_out, context), <span class="hljs-number">1</span>) <span class="hljs-comment">#[batch_size,hidden_size*2]</span><br>       <br>       concat_output = torch.tanh(self.concat(concat_input)) <span class="hljs-comment">#[batch_size,hidden_size]</span><br><br>       output = F.log_softmax(self.fc(concat_output),dim=-<span class="hljs-number">1</span>) <span class="hljs-comment">#[batch_Size, vocab_size]</span><br>       <span class="hljs-comment"># out = out.squeeze(1)</span><br>       <span class="hljs-keyword">return</span> output,decoder_hidden,attn_weights<br></code></pre></td></tr></table></figure><p>attetnion的Bahdanau实现可以参考：<a href="https://github.com/spro/practical-pytorch/blob/master/seq2seq-translation/seq2seq-translation.ipynb">https://github.com/spro/practical-pytorch/blob/master/seq2seq-translation/seq2seq-translation.ipynb</a></p><h1 id="Beam-Search"><a href="#Beam-Search" class="headerlink" title="Beam Search"></a>Beam Search</h1><h2 id="目标-24"><a href="#目标-24" class="headerlink" title="目标"></a>目标</h2><ol><li>知道beam search的概念和原理</li><li>能够在代码中使用Beam search 完成预测过程</li></ol><h2 id="1-Beam-Search的介绍"><a href="#1-Beam-Search的介绍" class="headerlink" title="1. Beam Search的介绍"></a>1. Beam Search的介绍</h2><blockquote><p>在进行模型评估的过程中，每次我们选择概率最大的token id作为输出，那么整个输出的句子的概率就是最大的么？</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/greedy%20search.png"></p></blockquote><p><code>Beam search</code>的又被称作<code>束集搜索</code>，是一种seq2seq中用来优化输出结果的算法(不在训练过程中使用)。</p><p>例如：传统的获取解码器输出的过程中，每次只选择概率最大的那个结果，作为当前时间步的输出，等到输出结束，我们会发现，整个句子可能并不通顺。虽然在每一个时间步上的输出确实是概率最大的，但是整体的概率确不一定最大的，我们经常把它叫做<code>greedy search[贪心算法]</code></p><p>为了解决上述的问题，可以考虑计算全部的输出的概率乘积，选择最大的哪一个，但是这样的话，意味着如果句子很长，候选词很多，那么需要保存的数据就会非常大，需要计算的数据量就很大</p><p>那么Beam Search 就是介于上述两种方法的一个这种的方法，假设Beam width&#x3D;2，表示每次保存的最大的概率的个数，这里每次保存两个，在下一个时间步骤一样，也是保留两个，这样就可以达到约束搜索空间大小的目的，从而提高算法的效率。</p><p>beam width &#x3D;1 时，就是贪心算法，beam width&#x3D;候选词的时候，就是计算全部的概率。beam width 是一个超参数。</p><p>比如在下图中:</p><p>使用一个树状图来表示每个time step的可能输出，其中的数字表示是条件概率</p><p>黄色的箭头表示的是一种greedy search，概率并不是最大的</p><p>如果把beam width设置为2，那么后续可以找到绿色路径的结果，这个结果是最大的</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/greedy%20search.png"></p><p>下图是要给beam width&#x3D;3的例子</p><ol><li>首先输入<code>start token &lt;s&gt;</code>,然后得到四个输出(这里假设一个就四个输出:<code>x,y,z,&lt;/s&gt;</code>)，选择概率最大三个，x,y,w</li><li>然后分别把x,y,z放到下一个time step中作为输入，分别得到三个不同的输出，找到三个输出中概率最大的三个，x,y,y</li><li>继续重复上述步骤，直到获得结束符(概率最大)或者是达到句子的最大长度，那么此时选择概率乘积最大的一个。</li><li>拼接整个路径上概率最大的所有结果，比如这里可能是<code>&lt;s&gt;,y,y,x,w,&lt;/s&gt;</code></li></ol><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/beamsearch.png"></p><h2 id="2-Beam-serach的实现"><a href="#2-Beam-serach的实现" class="headerlink" title="2. Beam serach的实现"></a>2. Beam serach的实现</h2><p>在上述描述的思路中，我们需要注意以下几个内容：</p><ol><li>数据该如何保存，每一次的输出的最大的beam width个结果，和之后之前的结果该如何保存</li><li>保存了之后的概率应该如何比较大小，保留下概率最大的三个</li><li>不能够仅仅只保存当前概率最大的信息，还需要有当前概率最大的三个中，前面的路径的输出结果</li></ol><h3 id="2-1-数据结构-堆-的认识"><a href="#2-1-数据结构-堆-的认识" class="headerlink" title="2.1 数据结构-堆-的认识"></a>2.1 数据结构-堆-的认识</h3><p>对于上面所说的，保留有限个数据，同时需要根据大小来保留，可以使用一种带有优先级的数据结构来实现，这里我们可以使用<code>堆</code>这种数据结构</p><p><code>堆</code>是一种优先级的队列，但是他其实并不是队列，我们常说的队列都是<code>先进先出或者是先进后出</code>，但是<code>堆</code>只根据优先级的高低来取出数据。</p><p>和<code>堆</code>在一起的另外一种数据结构叫做<code>栈</code>,有入栈和出栈的操作，可以理解为是一种先进后出的数据结构，关于栈，大家可以下来在了解。</p><p>在python自带的模块中，有一个叫做<code>heapq</code>的模块，提供了堆所有的方法。通过下面的代码我们来了解下heapq的使用方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">my_heap = [] <span class="hljs-comment">#使用列表保存数据</span><br><br> <span class="hljs-comment">#往列表中插入数据，优先级使用插入的内容来表示，就是一个比较大小的操作，越大优先级越高</span><br>heapq.heappush(my_heap,[<span class="hljs-number">29</span>,<span class="hljs-literal">True</span>,<span class="hljs-string">&quot;xiaohong&quot;</span>]) <br>heapq.heappush(my_heap,[<span class="hljs-number">28</span>,<span class="hljs-literal">False</span>,<span class="hljs-string">&quot;xiaowang&quot;</span>])<br>heapq.heappush(my_heap,[<span class="hljs-number">29</span>,<span class="hljs-literal">False</span>,<span class="hljs-string">&quot;xiaogang&quot;</span>])<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>    ret= heapq.heappop(my_heap)  <span class="hljs-comment">#pop操作，优先级最小的数据</span><br>    <span class="hljs-built_in">print</span>(ret)<br>    <br><span class="hljs-comment">#输出如下：</span><br>[<span class="hljs-number">28</span>, <span class="hljs-literal">False</span>, <span class="hljs-string">&#x27;xiaowang&#x27;</span>]<br>[<span class="hljs-number">29</span>, <span class="hljs-literal">False</span>, <span class="hljs-string">&#x27;xiaogang&#x27;</span>]<br>[<span class="hljs-number">29</span>, <span class="hljs-literal">True</span>, <span class="hljs-string">&#x27;xiaohong&#x27;</span>]<br></code></pre></td></tr></table></figure><p>可以发现，输出的顺序并不是数据插入的顺序，而是根据其优先级，从小往大pop（False&lt;True）。</p><h3 id="2-2-使用堆来实现beam-search"><a href="#2-2-使用堆来实现beam-search" class="headerlink" title="2.2 使用堆来实现beam search"></a>2.2 使用堆来实现beam search</h3><p>为了实现数据的的保存，我们可以把beam search中的数据保存在堆中，同时在往这个堆中添加数据的同时，判断数据的个数，仅仅保存beam width个数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Beam</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.heap = <span class="hljs-built_in">list</span>() <span class="hljs-comment">#保存数据的位置</span><br>        self.beam_width = config.beam_width <span class="hljs-comment">#保存数据的总数</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self,probility,complete,seq,decoder_input,decoder_hidden</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        添加数据，同时判断总的数据个数，多则删除</span><br><span class="hljs-string">        :param probility: 概率乘积</span><br><span class="hljs-string">        :param complete: 最后一个是否为EOS</span><br><span class="hljs-string">        :param seq: list，所有token的列表</span><br><span class="hljs-string">        :param decoder_input: 下一次进行解码的输入，通过前一次获得</span><br><span class="hljs-string">        :param decoder_hidden: 下一次进行解码的hidden，通过前一次获得</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        heapq.heappush(self.heap,[probility,complete,seq,decoder_input,decoder_hidden])<br>        <span class="hljs-comment">#判断数据的个数，如果大，则弹出。保证数据总个数小于等于3</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.heap)&gt;self.beam_width:<br>            heapq.heappop(self.heap)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):<span class="hljs-comment">#让该beam能够被迭代</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">iter</span>(self.heap)<br></code></pre></td></tr></table></figure><p>实现方法，完成模型eval过程中的beam search搜索</p><p>思路：</p><ol><li>构造<code>&lt;SOS&gt;</code>开始符号等第一次输入的信息，保存在堆中</li><li>取出堆中的数据，进行forward_step的操作，获得当前时间步的output，hidden</li><li>从output中选择topk（k&#x3D;beam width）个输出，作为下一次的input</li><li>把下一个时间步骤需要的输入等数据保存在一个新的堆中</li><li>获取新的堆中的优先级最高（概率最大）的数据，判断数据是否是EOS结尾或者是否达到最大长度，如果是，停止迭代</li><li>如果不是，则重新遍历新的堆中的数据</li></ol><p>代码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># decoder中的新方法</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluatoin_beamsearch_heapq</span>(<span class="hljs-params">self,encoder_outputs,encoder_hidden</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;使用 堆 来完成beam search，对是一种优先级的队列，按照优先级顺序存取数据&quot;&quot;&quot;</span><br><br>    batch_size = encoder_hidden.size(<span class="hljs-number">1</span>)<br>    <span class="hljs-comment">#1. 构造第一次需要的输入数据，保存在堆中</span><br>    decoder_input = torch.LongTensor([[word_sequence.SOS] * batch_size]).to(config.device)<br>    decoder_hidden = encoder_hidden <span class="hljs-comment">#需要输入的hidden</span><br><br>    prev_beam = Beam()<br>    prev_beam.add(<span class="hljs-number">1</span>,<span class="hljs-literal">False</span>,[decoder_input],decoder_input,decoder_hidden)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        cur_beam = Beam()<br>        <span class="hljs-comment">#2. 取出堆中的数据，进行forward_step的操作，获得当前时间步的output，hidden</span><br>        <span class="hljs-comment">#这里使用下划线进行区分</span><br>        <span class="hljs-keyword">for</span> _probility,_complete,_seq,_decoder_input,_decoder_hidden <span class="hljs-keyword">in</span> prev_beam:<br>            <span class="hljs-comment">#判断前一次的_complete是否为True，如果是，则不需要forward</span><br>            <span class="hljs-comment">#有可能为True，但是概率并不是最大</span><br>            <span class="hljs-keyword">if</span> _complete == <span class="hljs-literal">True</span>:<br>                cur_beam.add(_probility,_complete,_seq,_decoder_input,_decoder_hidden)<br>            <span class="hljs-keyword">else</span>:<br>                decoder_output_t, decoder_hidden,_ = self.forward_step(_decoder_input, _decoder_hidden,encoder_outputs)<br>                value, index = torch.topk(decoder_output_t, config.beam_width)  <span class="hljs-comment"># [batch_size=1,beam_widht=3]</span><br>             <span class="hljs-comment">#3. 从output中选择topk（k=beam width）个输出，作为下一次的input</span><br>            <span class="hljs-keyword">for</span> m, n <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(value[<span class="hljs-number">0</span>], index[<span class="hljs-number">0</span>]):<br>                    decoder_input = torch.LongTensor([[n]]).to(config.device)<br>                    seq = _seq + [n]<br>                    probility = _probility * m<br>                    <span class="hljs-keyword">if</span> n.item() == word_sequence.EOS:<br>                    complete = <span class="hljs-literal">True</span><br>                    <span class="hljs-keyword">else</span>:<br>                        complete = <span class="hljs-literal">False</span><br><br>                 <span class="hljs-comment">#4. 把下一个实践步骤需要的输入等数据保存在一个新的堆中</span><br>                  cur_beam.add(probility,complete,seq,<br>                                   decoder_input,decoder_hidden)<br>          <span class="hljs-comment">#5. 获取新的堆中的优先级最高（概率最大）的数据，判断数据是否是EOS结尾或者是否达到最大长度，如果是，停止迭代</span><br>          best_prob,best_complete,best_seq,_,_ = <span class="hljs-built_in">max</span>(cur_beam)<br>         <span class="hljs-keyword">if</span> best_complete == <span class="hljs-literal">True</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(best_seq)-<span class="hljs-number">1</span> == config.max_len: <span class="hljs-comment">#减去sos</span><br>            <span class="hljs-keyword">return</span> self._prepar_seq(best_seq)<br>         <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment">#6. 则重新遍历新的堆中的数据</span><br>            prev_beam = cur_beam<br>                                    <br>      <span class="hljs-keyword">def</span> <span class="hljs-title function_">_prepar_seq</span>(<span class="hljs-params">self,seq</span>):<span class="hljs-comment">#对结果进行基础的处理，共后续转化为文字使用</span><br>        <span class="hljs-keyword">if</span> seq[<span class="hljs-number">0</span>].item() == word_sequence.SOS:<br>            seq=  seq[<span class="hljs-number">1</span>:]<br>        <span class="hljs-keyword">if</span>  seq[-<span class="hljs-number">1</span>].item() == word_sequence.EOS:<br>            seq = seq[:-<span class="hljs-number">1</span>]<br>        seq = [i.item() <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> seq]<br>        <span class="hljs-keyword">return</span> seq<br></code></pre></td></tr></table></figure><h3 id="2-3-修改seq2seq"><a href="#2-3-修改seq2seq" class="headerlink" title="2.3 修改seq2seq"></a>2.3 修改seq2seq</h3><p>在seq2seq中使用evaluatoin_beamsearch_heapq查看效果，会发现使用beam search的效果比单独使用attention的效果更好</p><p>使用小黄鸡语料（50万个问答），单个字作为token，5个epoch之后的训练结果，左边为问，右边是回答</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">你在干什么 &gt;&gt;&gt;&gt;&gt; 你想干啥？<br>你妹 &gt;&gt;&gt;&gt;&gt; 不是我<br>你叫什么名字 &gt;&gt;&gt;&gt;&gt; 你猜<br>你个垃圾 &gt;&gt;&gt;&gt;&gt; 你才是，你<br>你是傻逼 &gt;&gt;&gt;&gt;&gt; 是你是傻<br>笨蛋啊 &gt;&gt;&gt;&gt;&gt; 我不是，你<br></code></pre></td></tr></table></figure><h1 id="闲聊机器人的优化"><a href="#闲聊机器人的优化" class="headerlink" title="闲聊机器人的优化"></a>闲聊机器人的优化</h1><h2 id="目标-25"><a href="#目标-25" class="headerlink" title="目标"></a>目标</h2><ol><li>知道如何优化模型的效果</li><li>知道常见的优化手段</li></ol><h2 id="1-seq2seq中使用teacher-forcing"><a href="#1-seq2seq中使用teacher-forcing" class="headerlink" title="1. seq2seq中使用teacher forcing"></a>1. seq2seq中使用<code>teacher forcing</code></h2><p>在前面的seq2seq的案例中，我们介绍了<code>teacher frocing</code>是什么，当时我们的输入和输出很相似，所以当时我们的<code>teacher forcing</code>是在每个time step中实现的，那么现在我们的输入和输出不同的情况下，该如何使用呢？</p><p>我们可以在每个batch遍历time step的外层使用<code>teacher forcing</code></p><p>代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">use_teacher_forcing = random.random() &gt; <span class="hljs-number">0.5</span><br><span class="hljs-keyword">if</span> use_teacher_forcing: <span class="hljs-comment">#使用teacher forcing</span><br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(config.max_len):<br>        decoder_output_t, decoder_hidden, decoder_attn_t = self.forward_step(decoder_input, decoder_hidden,<br>                                                                             encoder_outputs)<br>        decoder_outputs[:, t, :] = decoder_output_t<br>        <span class="hljs-comment">#使用正确的输出作为下一步的输入</span><br>        decoder_input = target[:, t].unsqueeze(<span class="hljs-number">1</span>)  <span class="hljs-comment"># [batch_size,1]</span><br><br><span class="hljs-keyword">else</span>:<span class="hljs-comment">#不适用teacher forcing，使用预测的输出作为下一步的输入</span><br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(config.max_len):<br>        decoder_output_t ,decoder_hidden,decoder_attn_t = self.forward_step(decoder_input,decoder_hidden,encoder_outputs)<br>        decoder_outputs[:,t,:] = decoder_output_t<br>        value, index = torch.topk(decoder_output_t, <span class="hljs-number">1</span>) <span class="hljs-comment"># index [batch_size,1]</span><br>        decoder_input = index<br></code></pre></td></tr></table></figure><h2 id="2-使用梯度裁剪"><a href="#2-使用梯度裁剪" class="headerlink" title="2. 使用梯度裁剪"></a>2. 使用梯度裁剪</h2><p>前面，我们给大家介绍了<code>梯度消失(梯度过小，在多层计算后导致其值太小而无法计算)</code>和<code>梯度爆炸（梯度过大，导致其值在多层的计算后太大而无法计算）</code>。</p><p>在常见的深度神经网络中，特别是RNN中，我们经常会使用<code>梯度裁剪</code>的手段，来抑制过大的梯度，能够有效防止梯度爆炸。</p><p>梯度裁剪的实现非常简单，仅仅只需要设置一个阈值，把梯度大于该阈值时设置为该阈值。</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/grad_clip.png"></p><p>实现代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">loss.backward()<br><span class="hljs-comment">#进行梯度裁剪</span><br>nn.utils.clip_grad_norm_(model.parameters(),[<span class="hljs-number">5</span>,<span class="hljs-number">10</span>,<span class="hljs-number">15</span>])<br>optimizer.step()<br></code></pre></td></tr></table></figure><h2 id="3-其他优化方法"><a href="#3-其他优化方法" class="headerlink" title="3. 其他优化方法"></a>3. 其他优化方法</h2><ol><li>根据特定的问题，使用分类模型进行训练，然后再训练单独的回个该为题的为模型<ul><li>比如询问名字，可以使用fasttext先进行意图识别，命中<code>询问名字</code>分类后，直接返回名字</li><li>或者是手动构造和名字相关的很多问题，来进行训练，从而能够更加个性化的回答出结果</li></ul></li><li>直接对现有的语料进行修改和清洗，把语料中更多的答案进行替换，比如咨询名字的，咨询天气的等，这样能够更大程度上的回答出更加规范的答案</li><li>使用2.4 会讲的搜索模型，不再使用这种生成模型</li></ol><h1 id="问答机器人介绍"><a href="#问答机器人介绍" class="headerlink" title="问答机器人介绍"></a>问答机器人介绍</h1><h2 id="目标-26"><a href="#目标-26" class="headerlink" title="目标"></a>目标</h2><ol><li>知道问答机器人是什么</li><li>知道问答机器人实现的逻辑</li></ol><h2 id="1-问答机器人"><a href="#1-问答机器人" class="headerlink" title="1. 问答机器人"></a>1. 问答机器人</h2><p>在前面的课程中，我们已经对问答机器人介绍过，这里的问答机器人是我们在分类之后，对特定问题进行回答的一种机器人。至于回答的问题的类型，取决于我们的语料。</p><p>当前我们需要实现的问答机器人是一个回答编程语言（比如<code>python是什么</code>，<code>python难么</code>等）相关问题的机器人</p><h2 id="2-问答机器人的实现逻辑"><a href="#2-问答机器人的实现逻辑" class="headerlink" title="2. 问答机器人的实现逻辑"></a>2. 问答机器人的实现逻辑</h2><p>主要实现逻辑：从现有的问答对中，选择出和问题最相似的问题，并且获取其相似度（一个数值），如果相似度大于阈值，则返回这个最相似的问题对应的答案</p><p>问答机器人的实现可以大致分为三步步骤：</p><ol><li>对问题的处理</li><li>对答案进行的机器学习召回</li><li>对召回的结果进行排序</li></ol><h3 id="2-1-对问题的处理"><a href="#2-1-对问题的处理" class="headerlink" title="2.1 对问题的处理"></a>2.1 对问题的处理</h3><p>对问题的处理过程中，我们可以考虑以下问题：</p><ol><li>对问题进行基础的清洗，去除特殊符号等</li><li>问题主语的识别，判断问题中是否包含特定的主语，比如<code>python</code>等，提取出来之后，方便后续对问题进行过滤。<ul><li>可以看出，不仅需要对用户输入的问题进行处理，获取主语，还需要对现有问答对进行处理</li></ul></li><li>获取问题的词向量，可以考虑使用词频，tdidf等值，方便召回的时候使用</li></ol><h3 id="2-2-问题的召回"><a href="#2-2-问题的召回" class="headerlink" title="2.2 问题的召回"></a>2.2 问题的召回</h3><p>召回：可以理解为是一个海选的操作，就是从现有的问答对中选择可能相似的前K个问题。</p><p>为什么要进行召回?</p><blockquote><p>主要目的是为了后续进行排序的时候，减少需要计算的数据量，比如有10万个问答对，直接通过深度学习肯定是可以获取所有的相似度，但是速度慢。</p><p>所以考虑使用机器学习的方法进行一次海选</p></blockquote><p>那么，如何实现召回呢？</p><blockquote><p>前面我们介绍，召回就是选择前K个最相似的问题，所以召回的实现就是想办法通过机器学习的手段计算器相似度。</p></blockquote><p>可以思考的方法：</p><ol><li>使用词袋模型，获取词频矩阵，计算相似度</li><li>使用tfidf，获取tdidf的矩阵，计算相似度</li></ol><p>上述的方法理论上都可行，知识当候选计算的词语数量太多的时候，需要挨个计算相似度，非常耗时。</p><p>所以可以考虑以下两点：</p><ol><li>通过前面获取的主语，对问题进行过滤</li><li>使用聚类的方法，对数据先聚类，再计算某几个类别中的相似度，而不用去计算全部。</li></ol><p>但是还有一个问题，供大家慢慢思考：</p><blockquote><p>不管是词频，还是tdidf，获取的结果肯定是没有考虑文字顺序的，效果不一定是最好的，那么此时，应该如何让最后召回的效果更好呢？</p></blockquote><h3 id="2-3-问题的排序"><a href="#2-3-问题的排序" class="headerlink" title="2.3 问题的排序"></a>2.3 问题的排序</h3><p>排序过程，使用了召回的结果作为输入，同时输出的是最相似的那一个。</p><p>整个过程使用深度学习实现。深度学习虽然训练的速度慢，但是整体效果肯定比机器学习好（机器学习受限于特征工程，数据量等因素，没有办法深入的学会不同问题之间的内在相似度），所以通过自建的模型，获取最后的相似度。</p><p>使用深度学习的模型这样一个黑匣子，在训练数据足够多的时候，能够学习到用户的各种不同输入的问题，当我们把目标值（相似的问题）给定的情况下，让模型自己去找到这些训练数据目标值和特征值之间相似的表示方法。</p><p>那么此时，有以下两个问题：</p><ol><li><p>使用什么数据，来训练模型，最后返回模型的相似度</p><blockquote><p>训练的数据的来源：可以考虑根据现有的问答对去手动构造，但是构造的数据不一定能够覆盖后续用户提问的全部问题。所以可以考虑通过程序去采集网站上相似的问题，比如百度知道的搜索结果。</p></blockquote></li><li><p>模型该如何构建</p><blockquote><p>模型可以有两个输入，输出为一个数值，两个输入的处理方法肯定是一样的。这种网络结构我们经常把它称作孪生神经网络。</p></blockquote><p>很明显，我们队输入的数据需要进行编码的操作，比如word embedding + LSTM&#x2F;GRU&#x2F;BIGRU等</p><p>两个编码之后的结果，我们可以进行组合，然后通过一个多层的神经网络，输出一个数字，把这个数值定义为我们的相似度。</p><p>当然我们的深层的神经网络在最开始的时候也并不是计算的相似度，但是我们的训练数据的目标值是相似度，在N多次的训练之后，确定了输入和输出的表示方法之后，那么最后的模型输出就是相似度了。</p></li></ol><p>前面我们介绍了问答机器人的实现的大致思路，那么接下来，我们就来一步步的实现它</p><h1 id="问答机器人的召回"><a href="#问答机器人的召回" class="headerlink" title="问答机器人的召回"></a>问答机器人的召回</h1><h2 id="目标-27"><a href="#目标-27" class="headerlink" title="目标"></a>目标</h2><ol><li>知道召回的目的</li><li>能够说出召回的流程</li><li>能够优化基础的召回逻辑</li></ol><h2 id="1-召回的流程"><a href="#1-召回的流程" class="headerlink" title="1. 召回的流程"></a>1. 召回的流程</h2><p>流程如下：</p><ol><li>准备数据，问答对的数据等</li><li>问题转化为向量</li><li>计算相似度</li></ol><h2 id="2-对现有问答对的准备"><a href="#2-对现有问答对的准备" class="headerlink" title="2. 对现有问答对的准备"></a>2. 对现有问答对的准备</h2><p>这里说的问答对，是带有标准答案的问题，后续命中问答对中的问题后，会返回该问题对应的答案</p><p>为了后续使用方便，我们可以把现有问答对的处理成如下的格式，可以考虑存入数据库或者本地文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">&quot;问题1&quot;</span>:&#123;<br>        <span class="hljs-string">&quot;主体&quot;</span>:[<span class="hljs-string">&quot;主体1&quot;</span>,<span class="hljs-string">&quot;主体3&quot;</span>,<span class="hljs-string">&quot;主体3&quot;</span>..],<br>        <span class="hljs-string">&quot;问题1分词后的句子&quot;</span>:[<span class="hljs-string">&quot;word1&quot;</span>,<span class="hljs-string">&quot;word2&quot;</span>,<span class="hljs-string">&quot;word3&quot;</span>...],<br>        <span class="hljs-string">&quot;答案&quot;</span>:<span class="hljs-string">&quot;答案&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;问题2&quot;</span>:&#123;<br>        ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># lib/get_qa_dcit.py</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_qa_dict</span>():<br>    chuanzhi_q_path = <span class="hljs-string">&quot;./问答对/Q.txt&quot;</span><br>    chuanzhi_a_path = <span class="hljs-string">&quot;./问答对/A.txt&quot;</span><br>    QA_dict = &#123;&#125;<br>    <span class="hljs-keyword">for</span> q,a <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(<span class="hljs-built_in">open</span>(chuanzhi_q_path).readlines(),<span class="hljs-built_in">open</span>(chuanzhi_a_path).readlines()):<br>        QA_dict[q.strip()] = &#123;&#125;<br>        QA_dict[q.strip()][<span class="hljs-string">&quot;ans&quot;</span>] = a.strip()<br>        QA_dict[q.strip()][<span class="hljs-string">&quot;entity&quot;</span>] = sentence_entity(q.strip())[-<span class="hljs-number">1</span>]<br><br>    <span class="hljs-comment">#准备短问答的问题</span><br>    python_duan_path = <span class="hljs-string">&quot;./data/Python短问答-11月汇总.xlsx&quot;</span><br><br>    ret = pd.read_excel(python_duan_path)<br>    column_list = ret.columns<br>    <span class="hljs-keyword">assert</span> <span class="hljs-string">&#x27;问题&#x27;</span> <span class="hljs-keyword">in</span> column_list <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;答案&quot;</span> <span class="hljs-keyword">in</span> column_list, <span class="hljs-string">&quot;excel 中必须包含问题和答案&quot;</span><br>    <span class="hljs-keyword">for</span> q, a <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(ret[<span class="hljs-string">&quot;问题&quot;</span>], ret[<span class="hljs-string">&quot;答案&quot;</span>]):<br>        q = re.sub(<span class="hljs-string">&quot;\s+&quot;</span>, <span class="hljs-string">&quot; &quot;</span>, q)<br>        QA_dict[q.strip()] = &#123;&#125;<br>        QA_dict[q.strip()][<span class="hljs-string">&quot;ans&quot;</span>] = a<br>        cuted,entiry = sentence_entity(q.strip())[-<span class="hljs-number">1</span>]<br>        QA_dict[q.strip()][<span class="hljs-string">&quot;entity&quot;</span>] = entiry<br>        QA_dict[q.strip()][<span class="hljs-string">&quot;q_cuted&quot;</span>] = cuted<br><br>    <span class="hljs-keyword">return</span> QA_dict<br><br>QA_dict = get_qa_dict()<br></code></pre></td></tr></table></figure><h2 id="3-把问题转化为向量"><a href="#3-把问题转化为向量" class="headerlink" title="3. 把问题转化为向量"></a>3. 把问题转化为向量</h2><p>把问答对中的问题，和用户输出的问题，转化为向量，为后续计算相似度做准备。</p><p>这里，我们使用tfidf对问答对中的问题进行处理，转化为向量矩阵。</p><blockquote><p>TODO，使用单字，使用n-garm，使用BM25，使用word2vec等，让其结果更加准确</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sklearn.feature_extraction.text <span class="hljs-keyword">import</span> TfidfVectorizer<br><span class="hljs-keyword">from</span> lib <span class="hljs-keyword">import</span> QA_dict<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">build_q_vectors</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;对问题建立索引&quot;&quot;&quot;</span><br>    lines_cuted= [q[<span class="hljs-string">&quot;q_cuted&quot;</span>] <span class="hljs-keyword">for</span> q <span class="hljs-keyword">in</span> QA_dict]<br>    tfidf_vectorizer = TfidfVectorizer()<br>    features_vec = tfidf_vectorizer.fit_transform(lines_cuted)<br>    <span class="hljs-comment">#返回tfidf_vectorizer，后续还需要对用户输入的问题进行同样的处理</span><br><span class="hljs-keyword">return</span> tfidf_vectorizer,features_vec，lines_cuted<br></code></pre></td></tr></table></figure><h2 id="4-计算相似度"><a href="#4-计算相似度" class="headerlink" title="4. 计算相似度"></a>4. 计算相似度</h2><p>思路很简单。对用户输入的问题使用<code>tfidf_vectorizer</code>进行处理，然后和<code>features_vec</code>中的每一个结果进行计算，获取相似度。</p><p>但是由于耗时可能会很久，所以考虑使用其他方法来实现</p><h3 id="4-1-pysparnn的介绍"><a href="#4-1-pysparnn的介绍" class="headerlink" title="4.1 pysparnn的介绍"></a>4.1 <code>pysparnn</code>的介绍</h3><p>官方地址：<code>https://github.com/facebookresearch/pysparnn</code></p><p><code>pysparnn</code>是一个对sparse数据进行相似邻近搜索的python库，这个库是用来实现 高维空间中寻找最相似的数据的。</p><h3 id="4-2-pysparnn的使用方法"><a href="#4-2-pysparnn的使用方法" class="headerlink" title="4.2 pysparnn的使用方法"></a>4.2 <code>pysparnn</code>的使用方法</h3><p>pysparnn的使用非常简单，仅仅需要以下步骤，就能够完成从高维空间中寻找相似数据的结果</p><ol><li>准备源数据和待搜索数据</li><li>对源数据进行向量化，把向量结果和源数据构造搜索的索引</li><li>对待搜索的数据向量化，传入索引，获取结果</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pysparnn.cluster_index <span class="hljs-keyword">as</span> ci<br><br><span class="hljs-keyword">from</span> sklearn.feature_extraction.text <span class="hljs-keyword">import</span> TfidfVectorizer<br><br><span class="hljs-comment">#1. 原始数据</span><br>data = [<br>    <span class="hljs-string">&#x27;hello world&#x27;</span>,<br>    <span class="hljs-string">&#x27;oh hello there&#x27;</span>,<br>    <span class="hljs-string">&#x27;Play it&#x27;</span>,<br>    <span class="hljs-string">&#x27;Play it again Sam&#x27;</span>,<br>]  <br><br><span class="hljs-comment">#2. 原始数据向量化</span><br><br>tv = TfidfVectorizer()<br>tv.fit(data)<br><br>features_vec = tv.transform(data)<br><br><span class="hljs-comment"># 原始数据构造索引</span><br>cp = ci.MultiClusterIndex(features_vec, data)<br><br><span class="hljs-comment"># 待搜索的数据向量化</span><br>search_data = [<br>    <span class="hljs-string">&#x27;oh there&#x27;</span>,<br>    <span class="hljs-string">&#x27;Play it again Frank&#x27;</span><br>]<br><br>search_features_vec = tv.transform(search_data)<br><br><span class="hljs-comment">#3. 索引中传入带搜索数据，返回结果</span><br>cp.search(search_features_vec, k=<span class="hljs-number">1</span>, k_clusters=<span class="hljs-number">2</span>, return_distance=<span class="hljs-literal">False</span>)<br>&gt;&gt; [[<span class="hljs-string">&#x27;oh hello there&#x27;</span>], [<span class="hljs-string">&#x27;Play it again Sam&#x27;</span>]]<br></code></pre></td></tr></table></figure><p>使用注意点：</p><ol><li>构造索引是需要传入向量和原数据，最终的结果会返回源数据</li><li>传入待搜索的数据时，需要传入一下几个参数：<ol><li><code>search_features_vec</code>：搜索的句子的向量</li><li><code>k</code>:最大的几个结果，k&#x3D;1，返回最大的一个</li><li><code>k_clusters</code>:对数据分为多少类进行搜索</li><li><code>return_distance</code>:是否返回距离</li></ol></li></ol><h3 id="4-3-使用pysparnn完成召回的过程"><a href="#4-3-使用pysparnn完成召回的过程" class="headerlink" title="4.3 使用pysparnn完成召回的过程"></a>4.3 使用pysparnn完成召回的过程</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#构造索引</span><br>cp = ci.MultiClusterIndex(features_vec, lines_cuted)<br><br><span class="hljs-comment">#对用户输入的句子进行向量化</span><br>search_vec = tfidf_vec.transform(ret)<br><span class="hljs-comment">#搜索获取结果，返回最大的8个数据，之后根据`main_entiry`进行过滤结果</span><br>cp_search_list = cp.search(search_vec, k=<span class="hljs-number">8</span>, k_clusters=<span class="hljs-number">10</span>, return_distance=<span class="hljs-literal">True</span>)<br><br>exist_same_entiry = <span class="hljs-literal">False</span><br>search_lsit = []<br><span class="hljs-keyword">for</span> _temp_call_line <span class="hljs-keyword">in</span> cp_search_list[<span class="hljs-number">0</span>]:<br>    cur_entity = QA_dict[_temp_call_line[<span class="hljs-number">1</span>]][<span class="hljs-string">&quot;main_entity&quot;</span>]<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">set</span>(main_entity) &amp; <span class="hljs-built_in">set</span>(cur_entity))&gt;<span class="hljs-number">0</span>:  <span class="hljs-comment">#命名体的集合存在交集的时候返回</span><br>        exist_same_entiry  = <span class="hljs-literal">True</span><br>        search_lsit.append(_temp_call_line[<span class="hljs-number">1</span>])<br><br><span class="hljs-keyword">if</span> exist_same_entiry: <span class="hljs-comment">#存在相同的主体的时候</span><br>    <span class="hljs-keyword">return</span> search_lsit<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-comment"># print(cp_search_list)</span><br>    <span class="hljs-keyword">return</span> [i[<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> cp_search_list[<span class="hljs-number">0</span>]]<br><br></code></pre></td></tr></table></figure><p>在这个过程中，需要注意，提前把<code>cp,tfidf_vec</code>等内容提前准备好，而不应该在每次接收到用户的问题之后重新生成一遍，否则效率会很低</p><h3 id="4-4-pysparnn的原理介绍"><a href="#4-4-pysparnn的原理介绍" class="headerlink" title="4.4 pysparnn的原理介绍"></a>4.4 <code>pysparnn</code>的原理介绍</h3><p>参考地址：<code>https://nlp.stanford.edu/IR-book/html/htmledition/cluster-pruning-1.html</code></p><p>前面我们使用的<code>pysparnn</code>使用的是一种<code>cluster pruning(簇修剪)</code>的技术，即，开始的时候对数据进行聚类，后续再有限个类别中进行数据的搜索，根据计算的余弦相似度返回结果。</p><p>数据预处理过程如下：</p><ol><li>随机选择$\sqrt{N}$个样本作为leader</li><li>选择非leader的数据(follower),使用余弦相似度计算找到最近的leader</li></ol><p>当获取到一个问题q的时候，查询过程：</p><ol><li>计算每个leader和q的相似度，找到最相似的leader</li><li>然后计算问题q和leader所在簇的相似度，找到最相似的k个，作为最终的返回结果</li></ol><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/pysparnn.png"></p><p>在上述的过程中，可以设置两个大于0的数字<code>b1和b2</code></p><ul><li>b1表示在<code>数据预处理</code>阶段，每个follower选择b1个最相似的leader，而不是选择单独一个lader，这样不同的簇是有数据交叉的；</li><li>b2表示在查询阶段，找到最相似的b2个leader，然后再计算不同的leader中下的topk的结果</li></ul><p>前面的描述就是b1&#x3D;b2&#x3D;1的情况，通过增加<code>b1和b2</code>的值，我们能够有更大的机会找到更好的结果，但是这样会需要更加大量的计算。</p><p>在pysparnn中实例化索引的过程中</p><p> 即：<code>ci.MultiClusterIndex(features, records_data, num_indexes)</code>中，<code>num_indexes</code>能够设置b1的值，默认为2。</p><p>在搜索的过程中，<code>cp.search(search_vec, k=8, k_clusters=10, return_distance=True,num_indexes)</code>，<code>num_Indexes</code>可以设置b2的值，默认等于b1的值。</p><h1 id="召回过程优化"><a href="#召回过程优化" class="headerlink" title="召回过程优化"></a>召回过程优化</h1><h2 id="目标-28"><a href="#目标-28" class="headerlink" title="目标"></a>目标</h2><ol><li>知道优化的方法和思路</li><li>知道BM25方法的原理和实现</li><li>能够使用word2vector完成优化过程</li></ol><h2 id="1-优化思路"><a href="#1-优化思路" class="headerlink" title="1. 优化思路"></a>1. 优化思路</h2><p>前面的学习，我们能够返回相似的召回结果，但是，如何让这些结果更加准确呢？</p><p>我们可以从下面的角度出发：</p><ol><li>tfidf使用的是词频和整个文档的词语，如果用户问题的某个词语没有出现过，那么此时，计算出来的相似度可能就不准确。该问题的解决思路：<ul><li>对用户输入的问题进行文本的对齐，比如，使用训练好的word2vector，往句子中填充非主语的其他词语的相似词语。例如<code>python 好学 么 --&gt;填充后是 ：python 好学 么 简单 难 嘛 </code>，这里假设word2vector同学会了<code>好学，简单，难</code>他们之间是相似的</li><li>使用word2vector对齐的好处除了应对未出现的词语，还能够提高主语的重要程度，让主语位置的tfidf的值更大，从而让相似度更加准确</li></ul></li><li>tfidf是一个词袋模型，没有考虑词和词之间的顺序<ul><li>使用n-garm和词一起作为特征，转化为特征向量</li></ul></li><li>不去使用tfidf处理句子得到向量。<ul><li>使用BM25算法</li><li>或者 使用fasttext、word2vector，把句子转化为向</li></ul></li></ol><h2 id="2-通过BM25算法代替TFIDF"><a href="#2-通过BM25算法代替TFIDF" class="headerlink" title="2. 通过BM25算法代替TFIDF"></a>2. 通过BM25算法代替TFIDF</h2><h3 id="2-1-BM25算法原理"><a href="#2-1-BM25算法原理" class="headerlink" title="2.1 BM25算法原理"></a>2.1 BM25算法原理</h3><p>BM25(BM&#x3D;best matching)是TDIDF的优化版本，首先我们来看看TFIDF是怎么计算的<br>$$<br>tfidf_i &#x3D; tf*idf &#x3D; \frac{词i的数量}{词语总数}*log\frac{总文档数}{包含词i的文档数}<br>$$<br>其中tf称为词频，idf为逆文档频率</p><p>那么BM25是如何计算的呢？<br>$$<br>BM25(i) &#x3D; \frac{词i的数量}{总词数}*\frac{(k+1)C}{C+k(1-b+b\frac{|d|}{avdl}）}*log(\frac{总文档数}{包含i的文档数}) \<br>C &#x3D; tf&#x3D;\frac{词i的数量}{总词数},k&gt;0,b\in [0,1]，d为文档i的长度，avdl是文档平均长度<br>$$<br>大家可以看到，BM25和tfidf的计算结果很相似，唯一的区别在于中多了一项，这一项是用来对tf的结果进行的一种变换。</p><p>把$1-b+b\frac{d}{avdl}$中的b看成0，那么此时中间项的结果为$\frac{(k+1)tf}{k+tf}$，通过设置一个k，就能够保证其最大值为$1$，达到限制tf过大的目的。</p><p>即：<br>$$<br>\begin{align}<br>&amp;\frac{(k+1)tf}{k+tf}&#x3D; \frac{k+1}{1+\frac{k}{tf}} \qquad \qquad \qquad,上下同除tf<br>\end{align}<br>$$<br>k不变的情况下，上式随着tf的增大而增大，上限为k+1,但是增加的程度会变小，如下图所示。</p><p>在一个句子中，某个词重要程度应该是随着词语的数量逐渐衰减的，所以中间项对词频进行了惩罚，随着次数的增加，影响程度的增加会越来越小。通过设置k值，能够保证其最大值为k+1，<code>k往往取值1.2</code>。</p><p>其变化如下图（无论k为多少，中间项的变化程度会随着次数的增加，越来越小）：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/bm25.png"></p><p>同时$1-b+b\frac{d}{avdl}$的作用是用来对文本的长度进行归一化。</p><p>例如在考虑整个句子的tdidf的时候，如果句子的长度太短，那么计算的总的tdidf的值是要比长句子的tdidf的值要低的。所以可以考虑对句子的长度进行归一化处理。</p><p>可以看到，当句子的长度越短，$1-b+b\frac{|d|}{avdl}$的值是越小，作为分母的位置，会让整个第二项越大，从而达到提高短文本句子的BM25的值的效果。当b的值为0，可以禁用归一化，<code>b往往取值0.75</code></p><p>其变化效果如下：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/bm25_2.png"></p><h3 id="2-2-BM25算法实现"><a href="#2-2-BM25算法实现" class="headerlink" title="2.2 BM25算法实现"></a>2.2 BM25算法实现</h3><p>通过前面的学习，我们知道其实BM25和Tfidf的区别不大，所以我们可以在之前sciket-learn的TfidfVectorizer基础上进行修改，获取我们的BM25的计算结果，主要也是修改其中的<code>fit</code>方法和<code>transform</code>方法</p><p>在sklearn的<code>TfidfVectorizer中</code>，首先接受参数，其次会调用<code>TfidfTransformer</code>来完成其他方法的调用</p><ol><li><p>继承TfidfVectorizer完成 参数的接受</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sklearn.feature_extraction.text <span class="hljs-keyword">import</span> TfidfVectorizer,TfidfTransformer,_document_frequency<br><span class="hljs-keyword">from</span> sklearn.base <span class="hljs-keyword">import</span> BaseEstimator,TransformerMixin<br><span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> normalize<br><span class="hljs-keyword">from</span> sklearn.utils.validation <span class="hljs-keyword">import</span> check_is_fitted<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> scipy.sparse <span class="hljs-keyword">as</span> sp<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Bm25Vectorizer</span>(<span class="hljs-title class_ inherited__">CountVectorizer</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,k=<span class="hljs-number">1.2</span>,b=<span class="hljs-number">0.75</span>, norm=<span class="hljs-string">&quot;l2&quot;</span>, use_idf=<span class="hljs-literal">True</span>, smooth_idf=<span class="hljs-literal">True</span>,sublinear_tf=<span class="hljs-literal">False</span>,*args,**kwargs</span>):<br>        <span class="hljs-built_in">super</span>(Bm25Vectorizer,self).__init__(*args,**kwargs)<br>        self._tfidf = Bm25Transformer(k=k,b=b,norm=norm, use_idf=use_idf,<br>                                       smooth_idf=smooth_idf,<br>                                       sublinear_tf=sublinear_tf)<br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">k</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> self._tfidf.k<br><br><span class="hljs-meta">    @k.setter</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">k</span>(<span class="hljs-params">self, value</span>):<br>        self._tfidf.k = value<br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">b</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> self._tfidf.b<br><br><span class="hljs-meta">    @b.setter</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">b</span>(<span class="hljs-params">self, value</span>):<br>        self._tfidf.b = value<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fit</span>(<span class="hljs-params">self, raw_documents, y=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Learn vocabulary and idf from training set.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        X = <span class="hljs-built_in">super</span>(Bm25Vectorizer, self).fit_transform(raw_documents)<br>        self._tfidf.fit(X)<br>        <span class="hljs-keyword">return</span> self<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fit_transform</span>(<span class="hljs-params">self, raw_documents, y=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Learn vocabulary and idf, return term-document matrix.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        X = <span class="hljs-built_in">super</span>(Bm25Vectorizer, self).fit_transform(raw_documents)<br>        self._tfidf.fit(X)<br>        <span class="hljs-keyword">return</span> self._tfidf.transform(X, copy=<span class="hljs-literal">False</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">self, raw_documents, copy=<span class="hljs-literal">True</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Transform documents to document-term matrix.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        check_is_fitted(self, <span class="hljs-string">&#x27;_tfidf&#x27;</span>, <span class="hljs-string">&#x27;The tfidf vector is not fitted&#x27;</span>)<br><br>        X = <span class="hljs-built_in">super</span>(Bm25Vectorizer, self).transform(raw_documents)<br>        <span class="hljs-keyword">return</span> self._tfidf.transform(X, copy=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure></li><li><p>完成自己的<code>Bm25transformer</code>,只需要再原来基础的代码上进心修改部分即可。sklearn中的转换器类的实现要求，不能直接继承已有的转换器类</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Bm25Transformer</span>(BaseEstimator, TransformerMixin):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,k=<span class="hljs-number">1.2</span>,b=<span class="hljs-number">0.75</span>, norm=<span class="hljs-string">&#x27;l2&#x27;</span>, use_idf=<span class="hljs-literal">True</span>, smooth_idf=<span class="hljs-literal">True</span>,</span><br><span class="hljs-params">                 sublinear_tf=<span class="hljs-literal">False</span></span>):<br>        self.k = k<br>        self.b = b<br>        <span class="hljs-comment">##################以下是TFIDFtransform代码##########################</span><br>        self.norm = norm<br>        self.use_idf = use_idf<br>        self.smooth_idf = smooth_idf<br>        self.sublinear_tf = sublinear_tf<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fit</span>(<span class="hljs-params">self, X, y=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Learn the idf vector (global term weights)</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Parameters</span><br><span class="hljs-string">        ----------</span><br><span class="hljs-string">        X : sparse matrix, [n_samples, n_features]</span><br><span class="hljs-string">            a matrix of term/token counts</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        _X = X.toarray()<br>        self.avdl = _X.<span class="hljs-built_in">sum</span>()/_X.shape[<span class="hljs-number">0</span>] <span class="hljs-comment">#句子的平均长度</span><br>        <span class="hljs-comment"># print(&quot;原来的fit的数据：\n&quot;,X)</span><br><br>        <span class="hljs-comment">#计算每个词语的tf的值</span><br>        self.tf = _X.<span class="hljs-built_in">sum</span>(<span class="hljs-number">0</span>)/_X.<span class="hljs-built_in">sum</span>()  <span class="hljs-comment">#[M] #M表示总词语的数量</span><br>        self.tf = self.tf.reshape([<span class="hljs-number">1</span>,self.tf.shape[<span class="hljs-number">0</span>]]) <span class="hljs-comment">#[1,M]</span><br>        <span class="hljs-comment"># print(&quot;tf\n&quot;,self.tf)</span><br>        <span class="hljs-comment">##################以下是TFIDFtransform代码##########################</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> sp.issparse(X):<br>            X = sp.csc_matrix(X)<br>        <span class="hljs-keyword">if</span> self.use_idf:<br>            n_samples, n_features = X.shape<br>            df = _document_frequency(X)<br><br>            <span class="hljs-comment"># perform idf smoothing if required</span><br>            df += <span class="hljs-built_in">int</span>(self.smooth_idf)<br>            n_samples += <span class="hljs-built_in">int</span>(self.smooth_idf)<br><br>            <span class="hljs-comment"># log+1 instead of log makes sure terms with zero idf don&#x27;t get</span><br>            <span class="hljs-comment"># suppressed entirely.</span><br>            idf = np.log(<span class="hljs-built_in">float</span>(n_samples) / df) + <span class="hljs-number">1.0</span><br>            self._idf_diag = sp.spdiags(idf, diags=<span class="hljs-number">0</span>, m=n_features,<br>                                        n=n_features, <span class="hljs-built_in">format</span>=<span class="hljs-string">&#x27;csr&#x27;</span>)<br><br>        <span class="hljs-keyword">return</span> self<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">self, X, copy=<span class="hljs-literal">True</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Transform a count matrix to a tf or tf-idf representation</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Parameters</span><br><span class="hljs-string">        ----------</span><br><span class="hljs-string">        X : sparse matrix, [n_samples, n_features]</span><br><span class="hljs-string">            a matrix of term/token counts</span><br><span class="hljs-string"></span><br><span class="hljs-string">        copy : boolean, default True</span><br><span class="hljs-string">            Whether to copy X and operate on the copy or perform in-place</span><br><span class="hljs-string">            operations.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Returns</span><br><span class="hljs-string">        -------</span><br><span class="hljs-string">        vectors : sparse matrix, [n_samples, n_features]</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br> <span class="hljs-comment">########### 计算中间项  ###############</span><br>        cur_tf = np.multiply(self.tf, X.toarray()) <span class="hljs-comment">#[N,M] #N表示数据的条数，M表示总词语的数量</span><br>        norm_lenght = <span class="hljs-number">1</span> - self.b + self.b*(X.toarray().<span class="hljs-built_in">sum</span>(-<span class="hljs-number">1</span>)/self.avdl) <span class="hljs-comment">#[N] #N表示数据的条数</span><br>        norm_lenght = norm_lenght.reshape([norm_lenght.shape[<span class="hljs-number">0</span>],<span class="hljs-number">1</span>]) <span class="hljs-comment">#[N,1]</span><br>        middle_part = (self.k+<span class="hljs-number">1</span>)*cur_tf /(cur_tf +self.k*norm_lenght)<br>        <span class="hljs-comment">############# 结算结束  ################</span><br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(X, <span class="hljs-string">&#x27;dtype&#x27;</span>) <span class="hljs-keyword">and</span> np.issubdtype(X.dtype, np.floating):<br>            <span class="hljs-comment"># preserve float family dtype</span><br>            X = sp.csr_matrix(X, copy=copy)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># convert counts or binary occurrences to floats</span><br>            X = sp.csr_matrix(X, dtype=np.float64, copy=copy)<br><br>        n_samples, n_features = X.shape<br><br>        <span class="hljs-keyword">if</span> self.sublinear_tf:<br>            np.log(X.data, X.data)<br>            X.data += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> self.use_idf:<br>            check_is_fitted(self, <span class="hljs-string">&#x27;_idf_diag&#x27;</span>, <span class="hljs-string">&#x27;idf vector is not fitted&#x27;</span>)<br><br>            expected_n_features = self._idf_diag.shape[<span class="hljs-number">0</span>]<br>            <span class="hljs-keyword">if</span> n_features != expected_n_features:<br>                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;Input has n_features=%d while the model&quot;</span><br>                                 <span class="hljs-string">&quot; has been trained with n_features=%d&quot;</span> % (<br>                                     n_features, expected_n_features))<br>            <span class="hljs-comment"># *= doesn&#x27;t work</span><br>            X = X * self._idf_diag<br><br>        <span class="hljs-comment">############# 中间项和结果相乘  ############</span><br>        X = X.toarray()*middle_part<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> sp.issparse(X):<br>            X = sp.csr_matrix(X, dtype=np.float64)<br>        <span class="hljs-comment">############# #########</span><br>        <br>        <span class="hljs-keyword">if</span> self.norm:<br>            X = normalize(X, norm=self.norm, copy=<span class="hljs-literal">False</span>)<br><br>        <span class="hljs-keyword">return</span> X<br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">idf_</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment">##################以下是TFIDFtransform代码##########################</span><br>        <span class="hljs-comment"># if _idf_diag is not set, this will raise an attribute error,</span><br>        <span class="hljs-comment"># which means hasattr(self, &quot;idf_&quot;) is False</span><br>        <span class="hljs-keyword">return</span> np.ravel(self._idf_diag.<span class="hljs-built_in">sum</span>(axis=<span class="hljs-number">0</span>))<br><br></code></pre></td></tr></table></figure><p>完整代码参考：<code>https://github.com/SpringMagnolia/Bm25Vectorzier/blob/master/BM25Vectorizer.py</code></p></li><li><p>测试简单使用，观察和tdidf的区别：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> BM25Vectorizer <span class="hljs-keyword">import</span> Bm25Vectorizer<br><span class="hljs-keyword">from</span> sklearn.feature_extraction.text <span class="hljs-keyword">import</span> TfidfVectorizer<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment"># format_weibo(word=False)</span><br>    <span class="hljs-comment"># format_xiaohuangji_corpus(word=True)</span><br>    bm_vec = Bm25Vectorizer()<br>    tf_vec = TfidfVectorizer()<br>    <span class="hljs-comment"># 1. 原始数据</span><br>    data = [<br>        <span class="hljs-string">&#x27;hello world&#x27;</span>,<br>        <span class="hljs-string">&#x27;oh hello there&#x27;</span>,<br>        <span class="hljs-string">&#x27;Play it&#x27;</span>,<br>        <span class="hljs-string">&#x27;Play it again Sam,24343,123&#x27;</span>,<br>    ]<br><br>    <span class="hljs-comment"># 2. 原始数据向量化</span><br>    bm_vec.fit(data)<br>    tf_vec.fit(data)<br>    features_vec_bm = bm_vec.transform(data)<br>    features_vec_tf = tf_vec.transform(data)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Bm25 result:&quot;</span>,features_vec_bm.toarray())<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;*&quot;</span>*<span class="hljs-number">100</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Tfidf result:&quot;</span>,features_vec_tf.toarray())<br></code></pre></td></tr></table></figure><p>输出如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python">Bm25 result: [[<span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.47878333</span> <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span><br>  <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.8779331</span> ]<br> [<span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.35073401</span> <span class="hljs-number">0.</span>         <span class="hljs-number">0.66218791</span><br>  <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.66218791</span> <span class="hljs-number">0.</span>        ]<br> [<span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.70710678</span> <span class="hljs-number">0.</span><br>  <span class="hljs-number">0.70710678</span> <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>        ]<br> [<span class="hljs-number">0.47038081</span> <span class="hljs-number">0.47038081</span> <span class="hljs-number">0.47038081</span> <span class="hljs-number">0.</span>         <span class="hljs-number">0.23975776</span> <span class="hljs-number">0.</span><br>  <span class="hljs-number">0.23975776</span> <span class="hljs-number">0.47038081</span> <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>        ]]<br>**********************************************************************************<br>Tfidf result: [[<span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.6191303</span>  <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span><br>  <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.78528828</span>]<br> [<span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.48693426</span> <span class="hljs-number">0.</span>         <span class="hljs-number">0.61761437</span><br>  <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.61761437</span> <span class="hljs-number">0.</span>        ]<br> [<span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.70710678</span> <span class="hljs-number">0.</span><br>  <span class="hljs-number">0.70710678</span> <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>        ]<br> [<span class="hljs-number">0.43671931</span> <span class="hljs-number">0.43671931</span> <span class="hljs-number">0.43671931</span> <span class="hljs-number">0.</span>         <span class="hljs-number">0.34431452</span> <span class="hljs-number">0.</span><br>  <span class="hljs-number">0.34431452</span> <span class="hljs-number">0.43671931</span> <span class="hljs-number">0.</span>         <span class="hljs-number">0.</span>        ]]<br><br></code></pre></td></tr></table></figure><h3 id="2-3-修改之前的召回代码"><a href="#2-3-修改之前的召回代码" class="headerlink" title="2.3 修改之前的召回代码"></a>2.3 修改之前的召回代码</h3><p>修改之前召回的代码只需要把调用tfidfvectorizer改成调用Bm25vectorizer</p></li></ol><h2 id="3-使用Fasttext实现获取句子向量"><a href="#3-使用Fasttext实现获取句子向量" class="headerlink" title="3. 使用Fasttext实现获取句子向量"></a>3. 使用Fasttext实现获取句子向量</h2><h3 id="3-1-基础方法介绍"><a href="#3-1-基础方法介绍" class="headerlink" title="3.1 基础方法介绍"></a>3.1 基础方法介绍</h3><p>这里我们可以使用fasttext，word2vector等方式实现获取词向量，然后对一个句子中的所有词语的词向量进行平均，获取整个句子的向量表示，即<code>sentence Vector</code>，该实现方法在fasttext和Word2vector中均有实现，而且通过参数的控制，实现N-garm的效果</p><p>假设我们有文本<code>a.txt</code>如下：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">我 很 喜欢 她 <br>今天 天气 不错<br>我 爱 深度学习<br></code></pre></td></tr></table></figure><p>那么我们可以实现获取句子向量的方法如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> fastText <span class="hljs-keyword">import</span> FastText<br><span class="hljs-comment">#训练模型，设置n-garm=2</span><br>model = FastText.train_unsupervised(<span class="hljs-built_in">input</span>=<span class="hljs-string">&quot;./a.txt&quot;</span>,minCount=<span class="hljs-number">1</span>,wordNgrams=<span class="hljs-number">2</span>)<br><span class="hljs-comment">#获取句子向量，是对词向量的平均</span><br>model.get_sentence_vector(<span class="hljs-string">&quot;我 是 谁&quot;</span>)<br></code></pre></td></tr></table></figure><h3 id="3-2-训练模型和封装代码"><a href="#3-2-训练模型和封装代码" class="headerlink" title="3.2 训练模型和封装代码"></a>3.2 训练模型和封装代码</h3><p>这里我们使用之前采集的相似文本数据作为训练样本</p><p>步骤如下：</p><ol><li>进行分词之后写入文件中</li><li>进行模型的训练</li><li>使用模型获取句子向量，并且封装代码</li><li>将之前的BM25的代码替换为该代码</li></ol><h4 id="3-2-1-分词写入文件"><a href="#3-2-1-分词写入文件" class="headerlink" title="3.2.1 分词写入文件"></a>3.2.1 分词写入文件</h4><p>这里我们使用单个字作为特征，只需要注意，英文使用单个词作为特征</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">使用单个字作为特征，进行fasttext训练，最后封装代码获取召回结果</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> string<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">word_split</span>(<span class="hljs-params">line</span>):<br>    <span class="hljs-comment">#对中文按照字进行处理，对英文不分为字母</span><br>    <span class="hljs-comment">#即 I爱python --&gt; i 爱 python</span><br>    letters = string.ascii_lowercase+<span class="hljs-string">&quot;+&quot;</span>+<span class="hljs-string">&quot;/&quot;</span>  <span class="hljs-comment">#c++,ui/ue</span><br>    result = []<br>    temp = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> line:<br>        <span class="hljs-keyword">if</span> word.lower() <span class="hljs-keyword">in</span> letters:<br>            temp+=word.lower()<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> temp !=<span class="hljs-string">&quot;&quot;</span>:<br>                result.append(temp)<br>                temp = <span class="hljs-string">&quot;&quot;</span><br>            result.append(word)<br>    <span class="hljs-keyword">if</span> temp!=<span class="hljs-string">&quot;&quot;</span>:<br>        result.append(temp)<br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_data</span>():<br>    path1 = <span class="hljs-string">r&quot;corpus\final_data\merged_q.txt&quot;</span><br>    path2 = <span class="hljs-string">r&quot;corpus\final_data\merged_sim_q.txt&quot;</span><br>    save_path =  <span class="hljs-string">r&quot;corpus\recall_fasttext_data\data.txt&quot;</span><br><br>    <span class="hljs-built_in">filter</span> = <span class="hljs-built_in">set</span>()<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path1) <span class="hljs-keyword">as</span> f,<span class="hljs-built_in">open</span>(save_path,<span class="hljs-string">&quot;a&quot;</span>) <span class="hljs-keyword">as</span> save_f:<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:<br>            line = line.strip()<br>            <span class="hljs-keyword">if</span> line <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">filter</span>:<br>                <span class="hljs-built_in">filter</span>.add(line)<br>                _temp = <span class="hljs-string">&quot; &quot;</span>.join(word_split(line))<br>                save_f.write(_temp+<span class="hljs-string">&quot;\n&quot;</span>)<br><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path2) <span class="hljs-keyword">as</span> f,<span class="hljs-built_in">open</span>(save_path,<span class="hljs-string">&quot;a&quot;</span>) <span class="hljs-keyword">as</span> save_f:<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:<br>            line = line.strip()<br>            <span class="hljs-keyword">if</span> line <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">filter</span>:<br>                <span class="hljs-built_in">filter</span>.add(line)<br>                _temp = <span class="hljs-string">&quot; &quot;</span>.join(word_split(line))<br>                save_f.write(_temp+<span class="hljs-string">&quot;\n&quot;</span>)<br></code></pre></td></tr></table></figure><h4 id="3-2-2-训练模型"><a href="#3-2-2-训练模型" class="headerlink" title="3.2.2 训练模型"></a>3.2.2 训练模型</h4><ol><li><p>训练fasttext的model,用来生成词向量</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_model</span>(<span class="hljs-params">fasttext_model_path</span>):<br> logging.basicConfig(<span class="hljs-built_in">format</span>=<span class="hljs-string">&#x27;%(asctime)s : %(levelname)s : %(message)s&#x27;</span>, level=logging.INFO)<br> save_path =  <span class="hljs-string">r&quot;corpus\recall_fasttext_data\data.txt&quot;</span><br><br> model = FastText.train_unsupervised(save_path,epoch=<span class="hljs-number">20</span>,minCount=<span class="hljs-number">3</span>,wordNgrams=<span class="hljs-number">2</span>)<br> model.save_model(fasttext_model_path)<br></code></pre></td></tr></table></figure></li><li><p>对现有的QA问答对，生成向量，传入pysparnn中构建索引</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_base_text_vectors</span>(<span class="hljs-params">cp_dump_path,model</span>):<br>    <span class="hljs-comment">#保存到本地pkl文件，防止每次都生成一次</span><br>    <span class="hljs-keyword">if</span> os.path.exists(cp_dump_path):<br>        cp = pickle.load(<span class="hljs-built_in">open</span>(cp_dump_path,<span class="hljs-string">&quot;rb&quot;</span>))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(QA_dict)<br>        q_lines = [q <span class="hljs-keyword">for</span> q <span class="hljs-keyword">in</span> QA_dict]<br>        q_cuted_list = [<span class="hljs-string">&quot; &quot;</span>.join(word_split(i)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> q_lines]<br>        lines_vectors = []<br>        <span class="hljs-keyword">for</span> q_cuted <span class="hljs-keyword">in</span> q_cuted_list:<br>            lines_vectors.append(model.get_sentence_vector(q_cuted))<br>        cp = ci.MultiClusterIndex(lines_vectors,q_lines)<br>        pickle.dump(cp,<span class="hljs-built_in">open</span>(cp_dump_path,<span class="hljs-string">&quot;wb&quot;</span>))<br>    <span class="hljs-keyword">return</span> cp<br></code></pre></td></tr></table></figure></li><li><p>传入用户的问题，进行分词和句子向量的获取，获取搜索的结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_search_vectors</span>(<span class="hljs-params">cp,model,search_line</span>):<br>    line_cuted = <span class="hljs-string">&quot; &quot;</span>.join(word_split(search_line))<br>    line_vec = model.get_sentence_vector(line_cuted)<br>    <span class="hljs-comment">#这里的line_vec中可以有多个句子的向量表示，能够返回每个句子的搜索结果</span><br>    cp_search_list = cp.search(line_vec,k=<span class="hljs-number">10</span>,k_clusters=<span class="hljs-number">10</span>,return_distance=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment">#TODO 对搜索的结果进行关键字的过滤</span><br>    <span class="hljs-keyword">return</span> cp_search_list<br></code></pre></td></tr></table></figure></li><li><p>测试模型的效果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> fastext_vectors <span class="hljs-keyword">import</span> get_search_vectors,train_model,get_base_text_vectors<br><span class="hljs-keyword">import</span> fastText<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    fasttext_model_path = <span class="hljs-string">&quot;corpus/build_questions/fasttext_recall.model&quot;</span><br>    cp_dump_path = <span class="hljs-string">&quot;corpus/build_questions/cp_recall.pkl&quot;</span><br>    <br>    <span class="hljs-comment"># train_model(fasttext_model_path)</span><br>    <br>    model = fastText.load_model(fasttext_model_path)<br><br>    cp = get_base_text_vectors(cp_dump_path,model)<br><br>    ret = get_search_vectors(cp,model,<span class="hljs-string">&quot;女孩学python容易么？&quot;</span>)<br>    <span class="hljs-built_in">print</span>(ret)<br></code></pre></td></tr></table></figure><p>输出如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">[[(<span class="hljs-string">&#x27;0.0890376&#x27;</span>, <span class="hljs-string">&#x27;学习Python需要什么基础，学起来更容易？&#x27;</span>), <br>  (<span class="hljs-string">&#x27;0.090688944&#x27;</span>, <span class="hljs-string">&#x27;学习PHP的女生多吗？女生可以学吗？&#x27;</span>), <br>  (<span class="hljs-string">&#x27;0.092773676&#x27;</span>, <span class="hljs-string">&#x27;Python适合什么人学习？&#x27;</span>), <br>  (<span class="hljs-string">&#x27;0.09416294&#x27;</span>, <span class="hljs-string">&#x27;Python语言适合什么样的人学？&#x27;</span>), <br>  (<span class="hljs-string">&#x27;0.102790296&#x27;</span>, <span class="hljs-string">&#x27;python语言容易学习吗？&#x27;</span>), <br>  (<span class="hljs-string">&#x27;0.1050359&#x27;</span>, <span class="hljs-string">&#x27;学习测试的女生多吗？女生可以学吗？&#x27;</span>), <br>  (<span class="hljs-string">&#x27;0.10546541&#x27;</span>, <span class="hljs-string">&#x27;Python好学吗？&#x27;</span>), <br>  (<span class="hljs-string">&#x27;0.11058545&#x27;</span>, <span class="hljs-string">&#x27;学习Python怎样？&#x27;</span>), <br>  (<span class="hljs-string">&#x27;0.11080605&#x27;</span>, <span class="hljs-string">&#x27;怎样学好Python？&#x27;</span>), <br>  (<span class="hljs-string">&#x27;0.11124289&#x27;</span>, <span class="hljs-string">&#x27;学生怎么上课的？&#x27;</span>)]]<br></code></pre></td></tr></table></figure></li></ol><h3 id="3-2-3-基础封装"><a href="#3-2-3-基础封装" class="headerlink" title="3.2.3  基础封装"></a>3.2.3  基础封装</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#lib/SentenceVectorizer</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">使用fasttext 实现sentence to vector</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> fastText<br><span class="hljs-keyword">from</span> fastText <span class="hljs-keyword">import</span> FastText<br><span class="hljs-keyword">import</span> config<br><span class="hljs-keyword">from</span> lib <span class="hljs-keyword">import</span> cut<br><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SentenceVectorizer</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> os.path.exists(config.recall_fasttext_model_path):<br>            self.model = fastText.load_model(config.recall_fasttext_model_path)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># self.process_data()</span><br>            self.model = self.build_model()<br><br>        self.fited = <span class="hljs-literal">False</span><br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fit_transform</span>(<span class="hljs-params">self,sentences</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;处理全部问题数据&quot;&quot;&quot;</span><br>        lines_vectors = self.fit(sentences)<br>        <span class="hljs-keyword">return</span> lines_vectors<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fit</span>(<span class="hljs-params">self,lines</span>):<br>        lines_vectors = []<br>        <span class="hljs-keyword">for</span> q_cuted <span class="hljs-keyword">in</span> lines:<br>            lines_vectors.append(self.model.get_sentence_vector(q_cuted))<br>        self.fited = <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> lines_vectors<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">self,sentence</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;处理用户输入的数据&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">assert</span> self.fited = <span class="hljs-literal">True</span><br>        line_vec = self.model.get_sentence_vector(<span class="hljs-string">&quot; &quot;</span>.join(sentence))<br>        <span class="hljs-keyword">return</span> line_vec<br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_model</span>(<span class="hljs-params">self</span>):<br>        logging.basicConfig(<span class="hljs-built_in">format</span>=<span class="hljs-string">&#x27;%(asctime)s : %(levelname)s : %(message)s&#x27;</span>, level=logging.INFO)<br>        model = FastText.train_unsupervised(config.recall_fasttext_data_path, epoch=<span class="hljs-number">20</span>, minCount=<span class="hljs-number">3</span>, wordNgrams=<span class="hljs-number">2</span>)<br>        model.save_model(config.recall_fasttext_model_path)<br>        <span class="hljs-keyword">return</span> model<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_data</span>(<span class="hljs-params">self</span>):<br>        path1 = <span class="hljs-string">r&quot;corpus\final_data\merged_q.txt&quot;</span><br>    path2 = <span class="hljs-string">r&quot;corpus\final_data\merged_sim_q.txt&quot;</span><br>    save_path =  <span class="hljs-string">r&quot;corpus\recall_fasttext_data\data.txt&quot;</span><br><br>        <span class="hljs-built_in">filter</span> = <span class="hljs-built_in">set</span>()<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path1) <span class="hljs-keyword">as</span> f, <span class="hljs-built_in">open</span>(save_path, <span class="hljs-string">&quot;a&quot;</span>) <span class="hljs-keyword">as</span> save_f:<br>            <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:<br>                line = line.strip()<br>                <span class="hljs-keyword">if</span> line <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">filter</span>:<br>                    <span class="hljs-built_in">filter</span>.add(line)<br>                    _temp = <span class="hljs-string">&quot; &quot;</span>.join(cut(line,by_word=<span class="hljs-literal">True</span>))<br>                    save_f.write(_temp + <span class="hljs-string">&quot;\n&quot;</span>)<br><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path2) <span class="hljs-keyword">as</span> f, <span class="hljs-built_in">open</span>(save_path, <span class="hljs-string">&quot;a&quot;</span>) <span class="hljs-keyword">as</span> save_f:<br>            <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:<br>                line = line.strip()<br>                <span class="hljs-keyword">if</span> line <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">filter</span>:<br>                    <span class="hljs-built_in">filter</span>.add(line)<br>                    _temp = <span class="hljs-string">&quot; &quot;</span>.join(cut(line,by_word=<span class="hljs-literal">True</span>))<br>                    save_f.write(_temp + <span class="hljs-string">&quot;\n&quot;</span>)<br><br></code></pre></td></tr></table></figure><h1 id="问答机器人排序模型"><a href="#问答机器人排序模型" class="headerlink" title="问答机器人排序模型"></a>问答机器人排序模型</h1><h2 id="目标-29"><a href="#目标-29" class="headerlink" title="目标"></a>目标</h2><ol><li>知道模型中排序中的概念和目的</li><li>知道模型中排序的实现方法</li></ol><h2 id="1-排序模型的介绍"><a href="#1-排序模型的介绍" class="headerlink" title="1. 排序模型的介绍"></a>1. 排序模型的介绍</h2><p>前面的课程中为了完成一个问答机器人，我们先进行了召回，相当于是通过海选的方法找到呢大致相似的问题。</p><p>通过现在的排序模型，我们需要精选出最相似的哪一个问题，返回对应的答案</p><h2 id="2-排序模型的实现思路"><a href="#2-排序模型的实现思路" class="headerlink" title="2. 排序模型的实现思路"></a>2. 排序模型的实现思路</h2><p>我们需要实现的排序模型是两个输入，即两个问题，输出的是一个相似度。所以和之前的深度学习模型一样，我们需要实现的步骤如下：</p><ol><li>准备数据</li><li>构建模型</li><li>模型评估</li><li>对外提供接口返回结果</li></ol><h3 id="2-1-准备数据"><a href="#2-1-准备数据" class="headerlink" title="2.1 准备数据"></a>2.1 准备数据</h3><p>这里的数据，我们使用之前采集的百度问答的相似问题和手动构造的数据。那么，我们需要把他格式化为最终模型需要的格式，即两个输入和输出的相似度。</p><h4 id="2-1-1-两个输入"><a href="#2-1-1-两个输入" class="headerlink" title="2.1.1 两个输入"></a>2.1.1 两个输入</h4><p>这里的输入，我们可以使用单个字作为特征，也可以使用一个分词之后的词语作为特征。所以在实现准备输入数据方法的过程中，可以提前准备。</p><h4 id="2-1-2-相似度准备"><a href="#2-1-2-相似度准备" class="headerlink" title="2.1.2 相似度准备"></a>2.1.2 相似度准备</h4><p>这里我们使用每个问题搜索结果的前两页认为他们是相似的，相似度为1，最后两页的结果是不相似的，相似度为0。</p><h3 id="2-2-构建模型"><a href="#2-2-构建模型" class="headerlink" title="2.2 构建模型"></a>2.2 构建模型</h3><p>介绍模型的构建之前，我们先介绍下孪生神经网络(Siamese Network)和其名字的由来。</p><p>Siamese和Chinese有点像。Siamese是古时候泰国的称呼，中文译作暹罗。Siamese在英语中是“孪生”、“连体”的意思。为什么孪生和泰国有关系呢？</p><blockquote><p>十九世纪泰国出生了一对连体婴儿，当时的医学技术无法使两人分离出来，于是两人顽强地生活了一生，1829年被英国商人发现，进入马戏团，在全世界各地表演，1839年他们访问美国北卡罗莱那州后来成为马戏团的台柱，最后成为美国公民。1843年4月13日跟英国一对姐妹结婚，恩生了10个小孩，昌生了12个，姐妹吵架时，兄弟就要轮流到每个老婆家住三天。1874年恩因肺病去世，另一位不久也去世，两人均于63岁离开人间。两人的肝至今仍保存在费城的马特博物馆内。从此之后“暹罗双胞胎”（Siamese twins）就成了连体人的代名词，也因为这对双胞胎让全世界都重视到这项特殊疾病。</p></blockquote><p>所以孪生神经网络就是有两个共享权值的网络的组成，或者只用实现一个，另一个直接调用，有两个输入，一个输出。1993年就已经被用来进行支票签名的验证。</p><p>孪生神经网络通过两个输入，被DNN进行编码，得到向量的表示之后，根据实际的用途来制定损失函数。比如我们需要计算相似度的时候，可以使用余弦相似度，或者使用$exp^{-||h^{left}-h^{right}||}$来确定向量的距离。</p><p>孪生神经网络被用于有多个输入和一个输出的场景，比如手写字体识别、文本相似度检验、人脸识别等</p><p>在计算相似度之前，我们可以考虑在传统的孪生神经网络的基础上，在计算相似度之前，把我们的编码之后的向量通过多层神经网络进行非线性的变化，结果往往会更加好，那么此时其网络结构大致如下：</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/deepqa.png"></p><p>其中Network1和network2为权重参数共享的两个形状相同的网络，用来对输入的数据进行编码，包括（<code>word-embedding,GRU,biGRU等</code>），Network3部分是一个深层的神经网络，包含（<code>batchnorm、dropout、relu、Linear</code>等层）</p><h3 id="2-3-模型的评估"><a href="#2-3-模型的评估" class="headerlink" title="2.3 模型的评估"></a>2.3 模型的评估</h3><p>编写预测和评估的代码，预测的过程只需要修改获得结果，不需要上图中的损失计算的过程</p><h2 id="3-代码实现"><a href="#3-代码实现" class="headerlink" title="3. 代码实现"></a>3. 代码实现</h2><h3 id="3-1-数据准备-1"><a href="#3-1-数据准备-1" class="headerlink" title="3.1 数据准备"></a>3.1 数据准备</h3><h5 id="3-1-1-对文本进行分词分开存储"><a href="#3-1-1-对文本进行分词分开存储" class="headerlink" title="3.1.1 对文本进行分词分开存储"></a>3.1.1 对文本进行分词分开存储</h5><p>这里的分词可以对之前的分词方法进行修改</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">cut_sentence_by_word</span>(<span class="hljs-params">sentence</span>):<br>    <span class="hljs-comment"># 对中文按照字进行处理，对英文不分为字母</span><br>    letters = string.ascii_lowercase + <span class="hljs-string">&quot;+&quot;</span> + <span class="hljs-string">&quot;/&quot;</span>  <span class="hljs-comment"># c++,ui/ue</span><br>    result = []<br>    temp = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> line:<br>        <span class="hljs-keyword">if</span> word.lower() <span class="hljs-keyword">in</span> letters:<br>            temp += word.lower()<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> temp != <span class="hljs-string">&quot;&quot;</span>:<br>                result.append(temp)<br>                temp = <span class="hljs-string">&quot;&quot;</span><br>            result.append(word)<br>    <span class="hljs-keyword">if</span> temp != <span class="hljs-string">&quot;&quot;</span>:<br>        result.append(temp)<br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">jieba_cut</span>(<span class="hljs-params">sentence,by_word=<span class="hljs-literal">False</span>,with_sg=<span class="hljs-literal">False</span>,use_stopwords=<span class="hljs-literal">False</span></span>):<br>    <span class="hljs-keyword">if</span> by_word:<br>        <span class="hljs-keyword">return</span> cut_sentence_by_word(sentence)<br>    ret = psg.lcut(sentence)<br>    <span class="hljs-keyword">if</span> use_stopwords:<br>        ret = [(i.word, i.flag) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ret <span class="hljs-keyword">if</span> i.word <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> stopwords_list]<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> with_sg:<br>        ret = [i[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ret]<br>    <span class="hljs-keyword">return</span> ret<br></code></pre></td></tr></table></figure><h5 id="3-1-2-准备word-Sequence代码"><a href="#3-1-2-准备word-Sequence代码" class="headerlink" title="3.1.2 准备word Sequence代码"></a>3.1.2 准备<code>word Sequence</code>代码</h5><p>该处的代码和seq2seq中的代码相同，直接使用</p><h5 id="3-1-3-准备Dataset和DataLoader"><a href="#3-1-3-准备Dataset和DataLoader" class="headerlink" title="3.1.3 准备Dataset和DataLoader"></a>3.1.3 准备<code>Dataset</code>和<code>DataLoader</code></h5><p>和seq2seq中的代码大致相同</p><h3 id="3-2-模型的搭建"><a href="#3-2-模型的搭建" class="headerlink" title="3.2 模型的搭建"></a>3.2 模型的搭建</h3><p>前面做好了准备工作之后，就需要开始进行模型的搭建。</p><p>虽然我们知道了整个结构的大致情况，但是我们还是不知道其中具体的细节。</p><p>2016年<code>AAAI</code>会议上，有一篇<code>Siamese Recurrent Architectures for Learning Sentence Similarity</code>的论文（地址：<a href="https://www.aaai.org/ocs/index.php/AAAI/AAAI16/paper/download/12195/12023%EF%BC%89%E3%80%82%E6%95%B4%E4%B8%AA%E7%BB%93%E6%9E%84%E5%A6%82%E4%B8%8B%E5%9B%BE%EF%BC%9A">https://www.aaai.org/ocs/index.php/AAAI/AAAI16/paper/download/12195/12023）。整个结构如下图：</a></p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/AAAI.png"></p><p>可以看到word 经过embedding之后进行LSTM的处理，然后经过exp来确定相似度，可以看到整个模型是非常简单的，之后很多人在这个结构上增加了更多的层，比如加入attention、dropout、pooling等层。</p><p>那么这个时候，请思考下面几个问题：</p><ol><li><p>attention在这个网络结构中该如何实现</p><ul><li><p>之前我们的attention是用在decoder中，让decoder的hidden和encoder的output进行运算，得到attention的weight，再和decoder的output进行计算，作为下一次decoder的输入</p></li><li><p>那么在当前我们可以把<code>句子A的output理解为句子B的encoder的output</code>，那么我们就可以进行attention的计算了</p><blockquote><p>和这个非常相似的有一个attention的变种，叫做<code>self attention</code>。前面所讲的Attention是基于source端和target端的隐变量（hidden state）计算Attention的，得到的结果是源端的每个词与目标端每个词之间的依赖关系。<code>Self Attention</code>不同，它分别在source端和target端进行，仅与source input或者target input自身相关的Self Attention，捕捉source端或target端自身的词与词之间的依赖关系。</p></blockquote></li></ul></li><li><p>dropout用在什么地方</p><ul><li>dropout可以用在很多地方，比如embedding之后</li><li>BiGRU结构中</li><li>或者是相似度计算之前</li></ul></li><li><p>pooling是什么如何使用</p><ul><li>pooling叫做池化，是一种降采样的技术，用来减少特征(feature)的数量。常用的方法有<code>max pooling</code> 或者是<code>average pooling</code></li></ul></li></ol><h4 id="3-2-1-编码部分"><a href="#3-2-1-编码部分" class="headerlink" title="3.2.1 编码部分"></a>3.2.1 编码部分</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python">  <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, *<span class="hljs-built_in">input</span></span>):<br>      <br>      sent1, sent2 = <span class="hljs-built_in">input</span>[<span class="hljs-number">0</span>], <span class="hljs-built_in">input</span>[<span class="hljs-number">1</span>]<br>      <span class="hljs-comment">#这里使用mask，在后面计算attention的时候，让其忽略pad的位置</span><br>      mask1, mask2 = sent1.eq(<span class="hljs-number">0</span>), sent2.eq(<span class="hljs-number">0</span>)<br><br>      <span class="hljs-comment"># embeds: batch_size * seq_len =&gt; batch_size * seq_len * batch_size</span><br>      x1 = self.embeds(sent1)<br>      x2 = self.embeds(sent2)<br><br>      <span class="hljs-comment"># batch_size * seq_len * dim =&gt; batch_size * seq_len * hidden_size</span><br>      output1, _ = self.lstm1(x1)<br>      output2, _ = self.lstm1(x2)<br><br>      <span class="hljs-comment"># 进行Attention的操作，同时进行形状的对齐</span><br>      <span class="hljs-comment"># batch_size * seq_len * hidden_size</span><br>      q1_align, q2_align = self.soft_attention_align(output1, output2, mask1, mask2)<br><br>      <span class="hljs-comment"># 拼接之后再传入LSTM中进行处理</span><br>      <span class="hljs-comment"># batch_size * seq_len * (8 * hidden_size)</span><br>      q1_combined = torch.cat([output1, q1_align, self.submul(output1, q1_align)], -<span class="hljs-number">1</span>)<br>      q2_combined = torch.cat([output2, q2_align, self.submul(output2, q2_align)], -<span class="hljs-number">1</span>)<br><br>      <span class="hljs-comment"># batch_size * seq_len * (2 * hidden_size)</span><br>      q1_compose, _ = self.lstm2(q1_combined)<br>      q2_compose, _ = self.lstm2(q2_combined)<br><br>      <span class="hljs-comment"># 进行Aggregate操作，也就是进行pooling</span><br>      <span class="hljs-comment"># input: batch_size * seq_len * (2 * hidden_size)</span><br>      <span class="hljs-comment"># output: batch_size * (4 * hidden_size)</span><br>      q1_rep = self.apply_pooling(q1_compose)<br>      q2_rep = self.apply_pooling(q2_compose)<br><br><span class="hljs-comment"># Concate合并到一起，用来进行计算相似度</span><br>      x = torch.cat([q1_rep, q2_rep], -<span class="hljs-number">1</span>)<br>      <br> <span class="hljs-keyword">def</span> <span class="hljs-title function_">submul</span>(<span class="hljs-params">self,x1,x2</span>):<br>      mul = x1 * x2<br>      sub = x1 - x2<br>      <span class="hljs-keyword">return</span> torch.cat([sub,mul],dim=-<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><h5 id="atttention的计算"><a href="#atttention的计算" class="headerlink" title="atttention的计算"></a>atttention的计算</h5><p>实现思路：</p><ol><li>先获取attention_weight</li><li>在使用attention_weight和encoder_output进行相乘</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">soft_attention_align</span>(<span class="hljs-params">self, x1, x2, mask1, mask2</span>):<br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    x1: batch_size * seq_len_1 * hidden_size</span><br><span class="hljs-string">    x2: batch_size * seq_len_2 * hidden_size</span><br><span class="hljs-string">    mask1:x1中pad的位置为1，其他为0</span><br><span class="hljs-string">    mask2:x2中pad 的位置为1，其他为0</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-comment"># attention: batch_size * seq_len_1 * seq_len_2</span><br>    attention_weight = torch.matmul(x1, x2.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))<br>    <span class="hljs-comment">#mask1 : batch_size,seq_len1</span><br>    mask1 = mask1.<span class="hljs-built_in">float</span>().masked_fill_(mask1, <span class="hljs-built_in">float</span>(<span class="hljs-string">&#x27;-inf&#x27;</span>))<br>    <span class="hljs-comment">#mask2 : batch_size,seq_len2</span><br>    mask2 = mask2.<span class="hljs-built_in">float</span>().masked_fill_(mask2, <span class="hljs-built_in">float</span>(<span class="hljs-string">&#x27;-inf&#x27;</span>))<br><br>    <span class="hljs-comment"># weight: batch_size * seq_len_1 * seq_len_2</span><br>    weight1 = F.softmax(attention_weight + mask2.unsqueeze(<span class="hljs-number">1</span>), dim=-<span class="hljs-number">1</span>)<br>    <span class="hljs-comment">#batch_size*seq_len_1*hidden_size</span><br>    x1_align = torch.matmul(weight1, x2)<br>    <br>    <span class="hljs-comment">#同理，需要对attention_weight进行permute操作</span><br>    weight2 = F.softmax(attention_weight.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) + mask1.unsqueeze(<span class="hljs-number">1</span>), dim=-<span class="hljs-number">1</span>)<br>    x2_align = torch.matmul(weight2, x1)<br></code></pre></td></tr></table></figure><h5 id="Pooling实现"><a href="#Pooling实现" class="headerlink" title="Pooling实现"></a>Pooling实现</h5><p>池化的过程有一个<code>窗口</code>的概念在其中，所以max 或者是average指的是窗口中的值取最大值还是取平均估值。整个过程可以理解为拿着窗口在源数据上取值</p><p>窗口有窗口大小(kernel_size，窗口多大)和步长(stride，每次移动多少)两个概念</p><ul><li>&#96;&#96;&#96;python<blockquote><blockquote><blockquote><p>input &#x3D; torch.tensor([[[1,2,3,4,5,6,7]]])<br>F.avg_pool1d(input, kernel_size&#x3D;3, stride&#x3D;2)<br>tensor([[[ 2.,  4.,  6.]]]) #[1,2,3] [3,4,5] [5,6,7]的平均估值</p></blockquote></blockquote></blockquote><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><br>![](<span class="hljs-variable">%E6</span><span class="hljs-variable">%B7</span><span class="hljs-variable">%B1</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%BA</span><span class="hljs-variable">%A6</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%AD</span><span class="hljs-variable">%A6</span><span class="hljs-variable">%E4</span><span class="hljs-variable">%B9</span><span class="hljs-variable">%A0</span>/pooling.png)<br><br>```python<br>def apply_pooling(self<span class="hljs-punctuation">,</span> <span class="hljs-keyword">x</span>):<br>    # input: batch_size * seq_len * (<span class="hljs-number">2</span> * hidden_size)<br>    #进行平均池化<br>    p<span class="hljs-number">1</span> <span class="hljs-operator">=</span> F.avg_pool<span class="hljs-number">1</span>d(<span class="hljs-keyword">x</span>.transpose(<span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span>)<span class="hljs-punctuation">,</span> <span class="hljs-keyword">x</span>.size(<span class="hljs-number">1</span>)).squeeze(<span class="hljs-number">-1</span>)<br>    #进行最大池化<br>    p<span class="hljs-number">2</span> <span class="hljs-operator">=</span> F.max_pool<span class="hljs-number">1</span>d(<span class="hljs-keyword">x</span>.transpose(<span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span>)<span class="hljs-punctuation">,</span> <span class="hljs-keyword">x</span>.size(<span class="hljs-number">1</span>)).squeeze(<span class="hljs-number">-1</span>)<br>    # output: batch_size * (<span class="hljs-number">4</span> * hidden_size)<br>    return torch.cat([p<span class="hljs-number">1</span><span class="hljs-punctuation">,</span> p<span class="hljs-number">2</span>]<span class="hljs-punctuation">,</span> <span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure></li></ul><h5 id="3-2-2-相似度计算部分"><a href="#3-2-2-相似度计算部分" class="headerlink" title="3.2.2 相似度计算部分"></a>3.2.2 相似度计算部分</h5><p>相似度的计算我们可以使用一个传统的距离计算公式，或者是exp的方法来实现，但是其效果不一定好，所以这里我们使用一个深层的神经网络来实现，使用pytorch中的Sequential对象来实现非常简单</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">self.fc = nn.Sequential(<br>    nn.BatchNorm1d(self.hidden_size * <span class="hljs-number">8</span>),<br>    <br>    nn.Linear(self.hidden_size * <span class="hljs-number">8</span>, self.linear_size),<br>    nn.ELU(inplace=<span class="hljs-literal">True</span>),<br>    nn.BatchNorm1d(self.linear_size),<br>    nn.Dropout(self.dropout),<br>    <br>    nn.Linear(self.linear_size, self.linear_size),<br>    nn.ELU(inplace=<span class="hljs-literal">True</span>),<br>    nn.BatchNorm1d(self.linear_size),<br>    nn.Dropout(self.dropout),<br>    <br>    nn.Linear(self.linear_size, <span class="hljs-number">2</span>),<br>    nn.Softmax(dim=-<span class="hljs-number">1</span>)<br>)<br></code></pre></td></tr></table></figure><p>在上述过程中，我们使用了激活函数ELU，而没有使用RELU，因为在有噪声的数据中ELU的效果往往会更好。</p><p>$ELU(<em>x</em>)&#x3D;max(0,x)+min(0,α∗(exp(x)−1))$,其中$\alpha$在torch中默认值为1。</p><p>通过下图可以看出他和RELU的区别，RELU在小于0的位置全部为0,但是ELU在小于零的位置是从0到-1的。可以理解为正常的数据汇总难免出现噪声，小于0的值，而RELU会直接把他处理为0，认为其实正常值，但是ELU却会保留他，所以ELU比RELU更有鲁棒性</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/elu.png"></p><h5 id="3-2-3-损失函数部分"><a href="#3-2-3-损失函数部分" class="headerlink" title="3.2.3 损失函数部分"></a>3.2.3 损失函数部分</h5><p>在孪生神经网络中我们经常会使用对比损失（Contrastive Loss），作为损失函数，对比损失是<code>Yann LeCun</code>提出的用来判断数据降维之后和源数据是否相似的问题。在这里我们用它来判断两个句子的表示是否相似。</p><p>对比损失的计算公式如下：<br>$$<br>L &#x3D; \frac{1}{2N}\sum^N_{n&#x3D;1}(yd^2 + (1-y)max(margin-d,0)^2)<br>$$<br>其中$d &#x3D; ||a_n-b_n||_2$,代表两个两本特征的欧氏距离，y表示是否匹配，y&#x3D;1表示匹配，y&#x3D;0表示不匹配，margin是一个阈值，比如margin&#x3D;1。</p><p>上式可分为两个部分，即：</p><ol><li>y &#x3D; 1时，只剩下左边，$\sum yd^2$，即相似的样本，如果距离太大，则效果不好，损失变大</li><li>y&#x3D;0的时候，只剩下右边部分，即样本不相似的时候，如果距离小的话，效果反而不好，损失变大</li></ol><p>下图红色是相似样本的损失，蓝色是不相似样本的损失</p><p><img src="/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E5%AF%B9%E6%AF%94%E6%8D%9F%E5%A4%B1.png"></p><p>但是前面我们已经计算出了相似度，所以在这里我们有两个操作</p><ol><li>使用前面的相似度的结果，把整个问题转化为分类（相似，不相似）的问题，或者是转化为回归问题（相似度是多少）</li><li>不是用前面相似度的计算结果部分，只用编码之后的结果，然后使用对比损失。最后在获取距离的时候使用欧氏距离来计算器相似度</li></ol><h5 id="使用DNN-均方误差来计算得到结果"><a href="#使用DNN-均方误差来计算得到结果" class="headerlink" title="使用DNN+均方误差来计算得到结果"></a>使用DNN+均方误差来计算得到结果</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">model,optimizer,loss_func,epoch</span>):<br>    model.tarin()<br>        <span class="hljs-keyword">for</span> batch_idx, (q,simq,q_len,simq_len,sim) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_loader):<br>            optimizer.zero_grad()<br>        output = model(q.to(config.device),simq.to(config.device))<br>            loss = loss_func(output,sim.to(config.deivce))<br>            loss.backward()<br>            optimizer.step()<br>            <span class="hljs-keyword">if</span> batch_idx%<span class="hljs-number">100</span>==<span class="hljs-number">0</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;...&quot;</span>)<br>            torch.save(model.state_dict(), <span class="hljs-string">&#x27;./DNN/data/model_paramters.pkl&#x27;</span>)<br>                torch.save(optimizer.state_dict(),<span class="hljs-string">&quot;./DNN/data/optimizer_paramters.pkl&quot;</span>)<br><br>            <br>model = SiameseNetwork().cuda()<br>loss =  torch.nn.MSELoss()<br>optimizer = optim.Adam(model.parameters(), lr=<span class="hljs-number">0.001</span>)<br><span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,config.epoch+<span class="hljs-number">1</span>):<br>    train(model,optimizer,loss,epoch)<br></code></pre></td></tr></table></figure><h4 id="使用对比损失来计算得到结果"><a href="#使用对比损失来计算得到结果" class="headerlink" title="使用对比损失来计算得到结果"></a>使用对比损失来计算得到结果</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#contrastive_loss.py</span><br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ContrastiveLoss</span>(torch.nn.Module):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Contrastive loss function.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, margin=<span class="hljs-number">1.0</span></span>):<br>        <span class="hljs-built_in">super</span>(ContrastiveLoss, self).__init__()<br>        self.margin = margin<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x0, x1, y</span>):<br>        <span class="hljs-comment"># 欧式距离</span><br>        diff = x0 - x1<br>        dist_sq = torch.<span class="hljs-built_in">sum</span>(torch.<span class="hljs-built_in">pow</span>(diff, <span class="hljs-number">2</span>), <span class="hljs-number">1</span>)<br>        dist = torch.sqrt(dist_sq)<br><br>        mdist = self.margin - dist<br>        <span class="hljs-comment">#clamp(input,min,max),和numpy中裁剪的效果相同</span><br>        dist = torch.clamp(mdist, <span class="hljs-built_in">min</span>=<span class="hljs-number">0.0</span>)<br>        loss = y * dist_sq + (<span class="hljs-number">1</span> - y) * torch.<span class="hljs-built_in">pow</span>(dist, <span class="hljs-number">2</span>)<br>        loss = torch.<span class="hljs-built_in">sum</span>(loss) / <span class="hljs-number">2.0</span> / x0.size()[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">return</span> loss<br></code></pre></td></tr></table></figure><p>之后只需要把原来的损失函数改为当前的损失函数即可</p><h3 id="3-3-不同模型的结果对比"><a href="#3-3-不同模型的结果对比" class="headerlink" title="3.3 不同模型的结果对比"></a>3.3 不同模型的结果对比</h3><h1 id="代码封装和对外提供接口"><a href="#代码封装和对外提供接口" class="headerlink" title="代码封装和对外提供接口"></a>代码封装和对外提供接口</h1><h2 id="目标-30"><a href="#目标-30" class="headerlink" title="目标"></a>目标</h2><ol><li>能够完成封装的代码</li><li>能够使用grpc对外提供接口</li><li>能够使用supervisord完成服务的管理</li></ol><h2 id="1-完成代码的封装"><a href="#1-完成代码的封装" class="headerlink" title="1. 完成代码的封装"></a>1. 完成代码的封装</h2><p>代码封装过程中，需要注意，在整个结构中，我们有很多的结算结果是dump到本地的，为了防止后续每次的重复计算。所以laod的结果，应该提前加载到内容，而不是每次调用load义词</p><h3 id="1-1-完成意图识别代码封装"><a href="#1-1-完成意图识别代码封装" class="headerlink" title="1.1 完成意图识别代码封装"></a>1.1 完成意图识别代码封装</h3><p>完成判断用户意图的代码，即在使用fasttext的模型，判断用户输入句子的分类</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> fastText<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">from</span> lib <span class="hljs-keyword">import</span> jieba_cut<br><br>fc_word_mode = fastText.load_model(<span class="hljs-string">&quot;./classify/data/ft_classify.model&quot;</span>)<br>fc_word_mode = fastText.load_model(<span class="hljs-string">&quot;./classify/data/ft_classify_words.model&quot;</span>)<br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_QA</span>(<span class="hljs-params">sentence_info</span>):<br>    python_qs_list = [<span class="hljs-string">&quot; &quot;</span>.join(sentence_info[<span class="hljs-string">&quot;cuted_sentence&quot;</span>])]<br>    result = fc_word_mode.predict(python_qs_list)<br><br>    python_qs_list = [<span class="hljs-string">&quot; &quot;</span>.join(sentence_info[<span class="hljs-string">&quot;cuted_word_sentence&quot;</span>])]<br>    words_result = fc_word_mode.predict(python_qs_list)<br>    <span class="hljs-keyword">for</span> index, (label,acc,word_label,word_acc) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(*result,*words_result)):<br>        label = label[<span class="hljs-number">0</span>]<br>        acc = acc[<span class="hljs-number">0</span>]<br>        word_label = word_label[<span class="hljs-number">0</span>]<br>        word_acc = word_acc[<span class="hljs-number">0</span>]<br>        <span class="hljs-comment">#以label_qa为准，如果预测结果是label_chat，则label_qa的概率=1-labele_chat</span><br>        <span class="hljs-keyword">if</span> label == <span class="hljs-string">&quot;__label__chat&quot;</span>:<br>            label = <span class="hljs-string">&quot;__label__QA&quot;</span><br>            acc = <span class="hljs-number">1</span>-acc<br>        <span class="hljs-keyword">if</span> word_label == <span class="hljs-string">&quot;__label__chat&quot;</span>:<br>            word_label = <span class="hljs-string">&quot;__label__QA&quot;</span><br>            word_acc = <span class="hljs-number">1</span> - word_acc<br>        <span class="hljs-keyword">if</span> acc&gt;<span class="hljs-number">0.95</span> <span class="hljs-keyword">or</span> word_acc&gt;<span class="hljs-number">0.95</span>:<br>            <span class="hljs-comment">#是QA</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><h3 id="1-2-完成对chatbot代码的封装"><a href="#1-2-完成对chatbot代码的封装" class="headerlink" title="1.2 完成对chatbot代码的封装"></a>1.2 完成对chatbot代码的封装</h3><p>提供predict的接口</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">准备闲聊的模型</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">from</span> lib <span class="hljs-keyword">import</span> jieba_cut<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> chatbot <span class="hljs-keyword">import</span> Sequence2Sequence<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Chatbot</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,ws_path=<span class="hljs-string">&quot;./chatbot/data/ws.pkl&quot;</span>,save_path=<span class="hljs-string">&quot;./chatbot/model/seq2seq_chatbot.ckpt&quot;</span></span>):<br>        self.ws_chatbot = pickle.load(<span class="hljs-built_in">open</span>(ws_path, <span class="hljs-string">&quot;rb&quot;</span>))<br>        self.save_path = save_path<br><span class="hljs-comment">#TODO .....</span><br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">self,s</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :param s:没有分词的</span><br><span class="hljs-string">        :param ws:</span><br><span class="hljs-string">        :param ws_words:</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment">#TODO ...</span><br>        <span class="hljs-keyword">return</span> ans<br></code></pre></td></tr></table></figure><h3 id="1-3-完成对问答系统召回的封装"><a href="#1-3-完成对问答系统召回的封装" class="headerlink" title="1.3 完成对问答系统召回的封装"></a>1.3 完成对问答系统召回的封装</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">进行召回的方法</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> pickle<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Recall</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,topk=<span class="hljs-number">20</span></span>):<br>        <span class="hljs-comment"># 准备问答的mode等模块</span><br>        self.topk = topk<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">self,sentence</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :param sentence:</span><br><span class="hljs-string">        :param debug:</span><br><span class="hljs-string">        :return: [recall list],[entity]</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment">#TODO recall</span><br>        <span class="hljs-keyword">return</span> recall_list<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_answer</span>(<span class="hljs-params">self,s</span>):<br>        <span class="hljs-keyword">return</span> self.QA_dict[s]<br><br></code></pre></td></tr></table></figure><h3 id="1-4-完成对问答排序模型的封装"><a href="#1-4-完成对问答排序模型的封装" class="headerlink" title="1.4 完成对问答排序模型的封装"></a>1.4 完成对问答排序模型的封装</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">深度学习排序</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">from</span> DNN2 <span class="hljs-keyword">import</span> SiamsesNetwork<br><span class="hljs-keyword">from</span> lib <span class="hljs-keyword">import</span> jieba_cut<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DNNSort</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment">#使用词语和单字两个模型的均值作为最后的结果</span><br>        self.dnn_sort_words = DNNSortWords()<br>        self.dnn_sort_single_word = DNNSortSingleWord()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">self,s,c_list</span>):<br>        sort1 = self.dnn_sort_words.predict(s,c_list)<br>        sort2 = self.dnn_sort_single_word.predict(s,c_list)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> sort1:<br>            sort1[i] = (sort1[i]+ sort2[i])/<span class="hljs-number">2</span><br>        sorts = <span class="hljs-built_in">sorted</span>(sort1.items(),key=<span class="hljs-keyword">lambda</span> x:x[-<span class="hljs-number">1</span>],reverse=<span class="hljs-literal">True</span>)<br>        <span class="hljs-keyword">return</span> sorts[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>],sorts[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DNNSortWords</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,ws_path=<span class="hljs-string">&quot;./DNN2/data/ws_80000.pkl&quot;</span>,save_path=<span class="hljs-string">&quot;./DNN2/model_keras/esim_model_softmax.ckpt&quot;</span></span>):<br>        self.ws = pickle.load(<span class="hljs-built_in">open</span>(ws_path, <span class="hljs-string">&quot;rb&quot;</span>))<br>        self.save_path = save_path<br><span class="hljs-comment">#TOOD ...</span><br>        <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">self,s,c_list</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :param s:没有分词的</span><br><span class="hljs-string">        :param c_list: 带比较的列表</span><br><span class="hljs-string">        :param ws:</span><br><span class="hljs-string">        :param ws_words:</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment">#TOOD ...</span><br>        <span class="hljs-keyword">return</span> sim_dict<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DNNSortSingleWord</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,ws_path=<span class="hljs-string">&quot;./DNN2/data/ws_word.pkl&quot;</span>,save_path=<span class="hljs-string">&quot;./DNN2/data/esim_word_model_softmax.ckpt&quot;</span></span>):<br>        self.ws = pickle.load(<span class="hljs-built_in">open</span>(ws_path, <span class="hljs-string">&quot;rb&quot;</span>))<br>        self.save_path = save_path<br>        <span class="hljs-comment">#TOOD ...</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">self,s,c_list</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :param s:没有分词的</span><br><span class="hljs-string">        :param c_list: 带比较的列表</span><br><span class="hljs-string">        :param ws:</span><br><span class="hljs-string">        :param ws_words:</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br><span class="hljs-comment">#TOOD ...</span><br>        <span class="hljs-keyword">return</span> sim_dict<br></code></pre></td></tr></table></figure><h3 id="1-5-实现对聊天记录的保存"><a href="#1-5-实现对聊天记录的保存" class="headerlink" title="1.5 实现对聊天记录的保存"></a>1.5 实现对聊天记录的保存</h3><p>不同的用户，连续10分钟内的对话认为是一轮对话，如果10分还没有下一次对话，认为该轮对话结束，如果10分钟后开始对话，认为是下一轮对话。是要是为了保存不同轮中的聊天主题，后续可以实现基本的对话管理。比如用户刚问了python相关的问题，后续如果问题中不带主体，那么就把redis中的python作为其主体</p><p>主要实现逻辑为：</p><ol><li>使用redis存储用户基本的数据</li><li>使用mongodb存储对话记录</li></ol><p>具体思路如下：</p><ol><li>根据用户id，获取对话id，根据对话id判断当前的对话是否存在</li><li>如果对话id存在：<ol><li>更新对话的entity，上一次对话的时间，设置对话id的过期时间</li><li>保存数据到mongodb</li></ol></li><li>如果对话id不存在：<ol><li>创建用户的基础信息（user_id,entity,对话时间）</li><li>把用户的基础信息存入redis，同时设置对话id和过期时间</li><li>保存数据到mongodb中</li></ol></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">获取，更新用户的信息</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pymongo <span class="hljs-keyword">import</span> MongoClient<br><span class="hljs-keyword">import</span> redis<br><span class="hljs-keyword">from</span> uuid <span class="hljs-keyword">import</span> uuid1<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> json<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">### redis</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">user_id:&quot;id&quot;,</span><br><span class="hljs-string">user_background:&#123;&#125;</span><br><span class="hljs-string">last_entity:[]</span><br><span class="hljs-string">last_conversation_time:int(time):</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">userid_conversation_id:&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">### monodb 存储对话记录</span><br><span class="hljs-string">&#123;user_id:,conversion_id:,from:user/bot,message:&quot;&quot;,create_time,entity:[],attention:[]&#125;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>HOST = <span class="hljs-string">&quot;localhost&quot;</span><br>CNVERSION_EXPERID_TIME = <span class="hljs-number">60</span> * <span class="hljs-number">10</span>  <span class="hljs-comment"># 10分钟，连续10分钟没有通信，意味着会话结束</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageManager</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.client = MongoClient(host=HOST)<br>        self.m = self.client[<span class="hljs-string">&quot;toutiao&quot;</span>][<span class="hljs-string">&quot;dialogue&quot;</span>]<br>        self.r = redis.Redis(host=HOST, port=<span class="hljs-number">6379</span>, db=<span class="hljs-number">10</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">last_entity</span>(<span class="hljs-params">self, user_id</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;最近一次的entity&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> json.loads(self.r.hget(user_id, <span class="hljs-string">&quot;entity&quot;</span>))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">gen_conversation_id</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> uuid1().<span class="hljs-built_in">hex</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">bot_message_pipeline</span>(<span class="hljs-params">self, user_id, message</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;保存机器人的回复记录&quot;&quot;&quot;</span><br>        conversation_id_key = <span class="hljs-string">&quot;&#123;&#125;_conversion_id&quot;</span>.<span class="hljs-built_in">format</span>(user_id)<br>        conversation_id = self.user_exist(conversation_id_key)<br>        <span class="hljs-keyword">if</span> conversation_id:<br>            <span class="hljs-comment"># 更新conversation_id的过期时间</span><br>            self.r.expire(conversation_id_key, CNVERSION_EXPERID_TIME)<br>            data = &#123;<span class="hljs-string">&quot;user_id&quot;</span>: user_id,<br>                    <span class="hljs-string">&quot;conversation_id&quot;</span>: conversation_id,<br>                    <span class="hljs-string">&quot;from&quot;</span>: <span class="hljs-string">&quot;bot&quot;</span>,<br>                    <span class="hljs-string">&quot;message&quot;</span>: message,<br>                    <span class="hljs-string">&quot;create_time&quot;</span>: <span class="hljs-built_in">int</span>(time.time()),<br>                    &#125;<br>            self.m.save(data)<br><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;没有会话id，但是机器人尝试回复....&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">user_message_pipeline</span>(<span class="hljs-params">self, user_id, message, create_time, attention, entity=[]</span>):<br>        <span class="hljs-comment"># 确定用户相关的信息</span><br>        <span class="hljs-comment"># 1. 用户是否存在</span><br>        <span class="hljs-comment"># 2.1 用户存在，返回用户的最近的entity，存入最近的对话</span><br>        <span class="hljs-comment"># 3.1 判断是否为新的对话，如果是新对话，开启新的回话，update用户的对话信息</span><br>        <span class="hljs-comment"># 3.2 如果不是新的对话，update用户的对话信息</span><br>        <span class="hljs-comment"># 3. 更新用户的基本信息</span><br>        <span class="hljs-comment"># 4  返回用户相关信息</span><br>        <span class="hljs-comment"># 5. 调用预测接口，发来对话的结构</span><br><br>        <span class="hljs-comment"># 要保存的data数据，缺少conversation_id</span><br>        data = &#123;<br>            <span class="hljs-string">&quot;user_id&quot;</span>: user_id,<br>            <span class="hljs-string">&quot;from&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>,<br>            <span class="hljs-string">&quot;message&quot;</span>: message,<br>            <span class="hljs-string">&quot;create_time&quot;</span>: create_time,<br>            <span class="hljs-string">&quot;entity&quot;</span>: json.dumps(entity),<br>            <span class="hljs-string">&quot;attention&quot;</span>: attention,<br>        &#125;<br><br>        conversation_id_key = <span class="hljs-string">&quot;&#123;&#125;_conversion_id&quot;</span>.<span class="hljs-built_in">format</span>(user_id)<br>        conversation_id = self.user_exist(conversation_id_key)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;conversation_id&quot;</span>,conversation_id)<br>        <span class="hljs-keyword">if</span> conversation_id:<br>            <span class="hljs-keyword">if</span> entity:<br>                <span class="hljs-comment"># 更新当前用户的 last_entity</span><br>                self.r.hset(user_id, <span class="hljs-string">&quot;last_entity&quot;</span>, json.dumps(entity))<br>            <span class="hljs-comment"># 更新最后的对话时间</span><br>            self.r.hset(user_id, <span class="hljs-string">&quot;last_conversion_time&quot;</span>, create_time)<br>            <span class="hljs-comment"># 设置conversation id的过期时间</span><br>            self.r.expire(conversation_id_key, CNVERSION_EXPERID_TIME)<br><br>            <span class="hljs-comment"># 保存聊天记录到mongodb中</span><br>            data[<span class="hljs-string">&quot;conversation_id&quot;</span>] = conversation_id<br><br>            self.m.save(data)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mongodb 保存数据成功&quot;</span>)<br><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># 不存在</span><br>            user_basic_info = &#123;<br>                <span class="hljs-string">&quot;user_id&quot;</span>: user_id,<br>                <span class="hljs-string">&quot;last_conversion_time&quot;</span>: create_time,<br>                <span class="hljs-string">&quot;last_entity&quot;</span>: json.dumps(entity)<br>            &#125;<br>            self.r.hmset(user_id, user_basic_info)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;redis存入 user_basic_info success&quot;</span>)<br>            conversation_id = self.gen_conversation_id()<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;生成conversation_id&quot;</span>,conversation_id)<br><br>            <span class="hljs-comment"># 设置会话的id</span><br>            self.r.<span class="hljs-built_in">set</span>(conversation_id_key, conversation_id, ex=CNVERSION_EXPERID_TIME)<br>            <span class="hljs-comment"># 保存聊天记录到mongodb中</span><br>            data[<span class="hljs-string">&quot;conversation_id&quot;</span>] = conversation_id<br>            self.m.save(data)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mongodb 保存数据成功&quot;</span>)<br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">user_exist</span>(<span class="hljs-params">self, conversation_id_key</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        判断用户是否存在</span><br><span class="hljs-string">        :param user_id:用户id</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        conversation_id = self.r.get(conversation_id_key)<br>        <span class="hljs-keyword">if</span> conversation_id:<br>            conversation_id = conversation_id.decode()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;load conversation_id&quot;</span>,conversation_id)<br>        <span class="hljs-keyword">return</span> conversation_id<br><br></code></pre></td></tr></table></figure><h2 id="2-使用GRPC对外提供服务"><a href="#2-使用GRPC对外提供服务" class="headerlink" title="2. 使用GRPC对外提供服务"></a>2. 使用GRPC对外提供服务</h2><h3 id="2-1-安装grpc相关环境"><a href="#2-1-安装grpc相关环境" class="headerlink" title="2.1 安装grpc相关环境"></a>2.1 安装grpc相关环境</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">gRPC 的安装：`pip install grpcio`<br>安装 ProtoBuf 相关的 python 依赖库：`pip install protobuf`<br>安装 python grpc 的 protobuf 编译工具：`pip install grpcio-tools`<br></code></pre></td></tr></table></figure><h3 id="2-2-定义GRPC的接口"><a href="#2-2-定义GRPC的接口" class="headerlink" title="2.2 定义GRPC的接口"></a>2.2 定义GRPC的接口</h3><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs protobuf"><span class="hljs-comment">//chatbot.proto 文件</span><br>syntax = <span class="hljs-string">&quot;proto3&quot;</span>;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">ReceivedMessage</span> &#123;<br>    <span class="hljs-type">string</span> user_id = <span class="hljs-number">1</span>; <span class="hljs-comment">//用户id</span><br>    <span class="hljs-type">string</span> user_message = <span class="hljs-number">2</span>; <span class="hljs-comment">//当前用户传递的消息</span><br>    <span class="hljs-type">int32</span> create_time = <span class="hljs-number">3</span>; <span class="hljs-comment">//当前消息发送的时间</span><br>&#125;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">ResponsedMessage</span> &#123;<br>    <span class="hljs-type">string</span> user_response = <span class="hljs-number">1</span>; <span class="hljs-comment">//返回给用户的消息</span><br>    <span class="hljs-type">int32</span> create_time = <span class="hljs-number">2</span>; <span class="hljs-comment">//返回给用户的时间</span><br>&#125;<br><br><span class="hljs-keyword">service </span><span class="hljs-title class_">ChatBotService</span> &#123;<br>  <span class="hljs-function"><span class="hljs-keyword">rpc</span> Chatbot (ReceivedMessage) <span class="hljs-keyword">returns</span> (ResponsedMessage)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-编译生成protobuf文件"><a href="#2-3-编译生成protobuf文件" class="headerlink" title="2.3 编译生成protobuf文件"></a>2.3 编译生成protobuf文件</h3><p>使用下面的命令编译，得到<code>chatbot_pb2.py</code>和<code>chatbot_pb2_grpc.py</code>文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">python -m grpc_tools.protoc -I. –python_out=. –grpc_python_out=. ./chatbot.proto<br></code></pre></td></tr></table></figure><h3 id="2-4-使用grpc提供服务"><a href="#2-4-使用grpc提供服务" class="headerlink" title="2.4 使用grpc提供服务"></a>2.4 使用grpc提供服务</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> dialogue<br><span class="hljs-keyword">from</span> classify <span class="hljs-keyword">import</span> is_QA<br><span class="hljs-keyword">from</span> dialogue.process_sentence <span class="hljs-keyword">import</span> process_user_sentence<br><br><span class="hljs-keyword">from</span> chatbot_grpc <span class="hljs-keyword">import</span> chatbot_pb2_grpc<br><span class="hljs-keyword">from</span> chatbot_grpc <span class="hljs-keyword">import</span> chatbot_pb2<br><span class="hljs-keyword">import</span> time<br><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">chatServicer</span>(chatbot_pb2_grpc.ChatBotServiceServicer):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment">#提前加载各种模型</span><br>        self.recall = dialogue.Recall(topk=<span class="hljs-number">20</span>)<br>        self.dnnsort = dialogue.DNNSort()<br>        self.chatbot = dialogue.Chatbot()<br>        self.message_manager = dialogue.MessageManager()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Chatbot</span>(<span class="hljs-params">self, request, context</span>):<br>        user_id = request.user_id<br>        message = request.user_message<br>        create_time = request.create_time<br>        <span class="hljs-comment">#对用户的输出进行基础的处理，如分词</span><br>        message_info = process_user_sentence(message)<br>        <span class="hljs-keyword">if</span> is_QA(message_info):<br>            attention = <span class="hljs-string">&quot;QA&quot;</span><br>            <span class="hljs-comment">#实现对对话数据的保存</span><br>            self.message_manager.user_message_pipeline(user_id, message, create_time, attention, entity=message_info[<span class="hljs-string">&quot;entity&quot;</span>])<br>            recall_list,entity = self.recall.predict(message_info)<br>            line, score = self.dnnsort.predict(message,recall_list)<br>            <span class="hljs-keyword">if</span> score &gt; <span class="hljs-number">0.7</span>:<br>                ans = self.recall.get_answer(line)<br>                user_response = ans[<span class="hljs-string">&quot;ans&quot;</span>]<br><br>            <span class="hljs-keyword">else</span>:<br>                user_response = <span class="hljs-string">&quot;不好意思，这个问题我还没学习到...&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            attention = <span class="hljs-string">&quot;chat&quot;</span><br>            <span class="hljs-comment"># 实现对对话数据的保存</span><br>            self.message_manager.user_message_pipeline(user_id,message,create_time,attention,entity=message_info[<span class="hljs-string">&quot;entity&quot;</span>])<br>            user_response = self.chatbot.predict(message)<br><br>        self.message_manager.bot_message_pipeline(user_id,user_response)<br><br>        user_response = user_response<br>        create_time = <span class="hljs-built_in">int</span>(time.time())<br>        <span class="hljs-keyword">return</span> chatbot_pb2.ResponsedMessage(user_response=user_response,create_time=create_time)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">serve</span>():<br>    <span class="hljs-keyword">import</span> grpc<br>    <span class="hljs-keyword">from</span> concurrent <span class="hljs-keyword">import</span> futures<br>    <span class="hljs-comment"># 多线程服务器</span><br>    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="hljs-number">10</span>))<br>    <span class="hljs-comment"># 注册本地服务</span><br>    chatbot_pb2_grpc.add_ChatBotServiceServicer_to_server(chatServicer(), server)<br>    <span class="hljs-comment"># 监听端口</span><br>    server.add_insecure_port(<span class="hljs-string">&quot;[::]:9999&quot;</span>)<br>    <span class="hljs-comment"># 开始接收请求进行服务</span><br>    server.start()<br>    <span class="hljs-comment"># 使用 ctrl+c 可以退出服务</span><br>    <span class="hljs-keyword">try</span>:<br>        time.sleep(<span class="hljs-number">1000</span>)<br>    <span class="hljs-keyword">except</span> KeyboardInterrupt:<br>        server.stop(<span class="hljs-number">0</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    serve()<br></code></pre></td></tr></table></figure><h2 id="3-使用supervisor完成对服务的管理"><a href="#3-使用supervisor完成对服务的管理" class="headerlink" title="3. 使用supervisor完成对服务的管理"></a>3. 使用supervisor完成对服务的管理</h2><h3 id="3-1-编写简单的执行脚本"><a href="#3-1-编写简单的执行脚本" class="headerlink" title="3.1  编写简单的执行脚本"></a>3.1  编写简单的执行脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><br>cd `$dirname`|exit 0<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">source</span> activate ds</span><br>python grpc_predict.py<br></code></pre></td></tr></table></figure><p>添加可执行权限：<code>chmod +x 文件名</code></p><h3 id="3-2-安装、配置supervisor"><a href="#3-2-安装、配置supervisor" class="headerlink" title="3.2 安装、配置supervisor"></a>3.2 安装、配置supervisor</h3><p>supervisor现在的官方版本还是python2的，但是可以使用下面的命令安装python3版本</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">pip3 install git+https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/Supervisor/</span>supervisor    <br></code></pre></td></tr></table></figure><ol><li><p>完成supervisor的配置文件的编写，conf中使用分号作为注释符号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">;conf.d<br>[program:chat_service]<br><br>command=/root/chat_service/run.sh  ;执行的命令<br><br>stdout_logfile=/root/chat_service/log/out.log ;log的位置<br><br>stderr_logfile=/root/chat_service/log/error.log  ;错误log的位置<br><br>directory=/root/chat_service  ;路径<br><br>autostart=true  ;是否自动启动<br><br>autorestart=true  ;是否自动重启<br><br>startretries=10 ;失败的最大尝试次数<br></code></pre></td></tr></table></figure></li><li><p>在supervisor的基础配置中添加上述配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">;/etc/supervisord/supervisor.conf <br>[include]<br>files=/root/chat_service/conf.d<br></code></pre></td></tr></table></figure></li><li><p>运行supervisord</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">supervisord -c /etc/supervisord/supervisor.conf<br></code></pre></td></tr></table></figure></li></ol><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Python</tag>
      
      <tag>深度学习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>机器学习</title>
    <link href="/2022/10/21/python/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    <url>/2022/10/21/python/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Python</tag>
      
      <tag>机器学习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>python基础</title>
    <link href="/2022/10/21/python/python%E5%9F%BA%E7%A1%80/"/>
    <url>/2022/10/21/python/python%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="python中的算数运算符"><a href="#python中的算数运算符" class="headerlink" title="python中的算数运算符"></a><strong>python中的算数运算符</strong></h1><table><thead><tr><th>运算符</th><th>描述</th><th>实例</th></tr></thead><tbody><tr><td>+</td><td>加</td><td>10 + 20 &#x3D; 30</td></tr><tr><td>-</td><td>减</td><td>10 - 20 &#x3D; -10</td></tr><tr><td>*</td><td>乘</td><td>10 * 20 &#x3D; 200</td></tr><tr><td>&#x2F;</td><td>除</td><td>10 &#x2F; 20 &#x3D; 0.5</td></tr><tr><td>&#x2F;&#x2F;</td><td>取整除</td><td>返回除法的整数部分(商) 9&#x2F;&#x2F;2输出结果 4</td></tr><tr><td>%</td><td>取余数</td><td>返回除法的余数 9 % 2 &#x3D; 1</td></tr><tr><td>**</td><td>幂</td><td>又称次方、乘方， 2 ** 3 &#x3D; 8</td></tr></tbody></table><h1 id="赋值运算符"><a href="#赋值运算符" class="headerlink" title="赋值运算符"></a>赋值运算符</h1><table><thead><tr><th>运算符</th><th>描述</th><th>实例</th></tr></thead><tbody><tr><td>&#x3D;</td><td>简单的赋值运算符</td><td>c &#x3D; a + b将a+b的运算结果赋值给c</td></tr><tr><td>+&#x3D;</td><td>加法赋值运算符</td><td>c +&#x3D; a 等效于 c &#x3D; c + a</td></tr><tr><td>-&#x3D;</td><td>减法赋值运算符</td><td>c -&#x3D; a 等效于 c &#x3D; c - a</td></tr><tr><td>*&#x3D;</td><td>乘法赋值运算符</td><td>c *&#x3D; a 等效于 c &#x3D; c * a</td></tr><tr><td>&#x2F;&#x3D;</td><td>除法赋值运算符</td><td>c &#x2F;&#x3D; a 等效于 c &#x3D; c &#x2F; a</td></tr><tr><td>&#x2F;&#x2F;&#x3D;</td><td>取整除赋值运算符</td><td>c &#x2F;&#x2F;&#x3D; a 等效于 c &#x3D; c &#x2F;&#x2F; a</td></tr><tr><td>%&#x3D;</td><td>取 模(余数)赋值运算符</td><td>c %&#x3D; a 等效于 c &#x3D; c % a</td></tr><tr><td>**&#x3D;</td><td>幂赋值运算符</td><td>c **&#x3D; a 等效于 c &#x3D; c xx a</td></tr></tbody></table><h1 id="python中的变量类型"><a href="#python中的变量类型" class="headerlink" title="python中的变量类型"></a><strong>python中的变量类型</strong></h1><ul><li><p>在Python中定义变量是不需要指定类型</p></li><li><p>数据类型可以分为数据子和非数字型</p></li><li><p>数字型</p><ul><li>整行 int</li><li>浮点型 float</li><li>布尔型 bool<ul><li>真true 非0数 –非零即真</li><li>假 false 0</li></ul></li><li>复数型（complex）<ul><li>主要用于科学计算，例如：平面场问题、波动问题、电感电容等问题</li></ul></li></ul></li><li><p>非数字型</p><ul><li>字符串</li><li>列表</li><li>元组</li><li>字典</li></ul></li></ul><p>提示：在Python2.x中，整数根据保存数值的长度还分为：</p><ul><li>int （整数）</li><li>long （长整数）</li><li>使用type函数可以查看一个变量的类型</li></ul><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-type">In</span> [<span class="hljs-number">1</span>]:<span class="hljs-keyword">type</span>(name)<br></code></pre></td></tr></table></figure><h1 id="变量的格式化输出"><a href="#变量的格式化输出" class="headerlink" title="变量的格式化输出"></a><strong>变量的格式化输出</strong></h1><ul><li>% 被称为格式化操作符，专门用于处理字符串中的格式<ul><li>包含 % 的字符串，被称为格式化字符串</li><li>% 和不同的字符串连用，不同类型的数据需要使用不同的格式化字符</li></ul></li></ul><table><thead><tr><th>格式化字符</th><th>含义</th></tr></thead><tbody><tr><td>%s</td><td>字符串</td></tr><tr><td>%d</td><td>有符号十进制整数，%06d表述输出的数据显示位数，不足的地方使用0补全</td></tr><tr><td>%f</td><td>浮点数，%.02f 表示小数点后只显示两位</td></tr><tr><td>%%</td><td>输出 %</td></tr></tbody></table><ul><li>语法格式如下：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&quot;格式化字符串&quot;</span> % 变量<span class="hljs-number">1</span>)</span></span><br><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&quot;格式化字符串&quot;</span> % (变量<span class="hljs-number">1</span>,变量<span class="hljs-number">2</span>...)</span></span>)<br><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&quot;我的名字叫 %s，请多多关照&quot;</span> % name)</span></span><br></code></pre></td></tr></table></figure><h1 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h1><ul><li>关键字就是在Python内部已经使用的标识符</li><li>关键字具有特殊的功能和含义</li><li>开发者不允许定义和关键字相同的名字的标识符</li></ul><p>通过以下命令可以查看Python中的关键字</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">In <span class="hljs-selector-attr">[1]</span>: import keyword<br>In <span class="hljs-selector-attr">[2]</span>: <span class="hljs-built_in">print</span>(keyword.kwlist)<br></code></pre></td></tr></table></figure><p>提示：关键字的学习及使用</p><ul><li>import 关键字可以导入一个“工具包”</li><li>在Python中不同的工具包，提供有不同的工具</li></ul><h1 id="判断-if-elseif-else-语句"><a href="#判断-if-elseif-else-语句" class="headerlink" title="判断(if-elseif-else)语句"></a>判断(if-elseif-else)语句</h1><p>在Python中，if语句就是用来进行判断的，格式如下：</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-keyword">if</span> 条件<span class="hljs-number">1</span>：<br>条件成立时，要做的事情<br><span class="hljs-params">...</span><span class="hljs-params">...</span><br>elseif 条件<span class="hljs-number">2</span>:<br>条件成立时，要做的事情<br><span class="hljs-params">...</span><span class="hljs-params">...</span><br>elseif 条件<span class="hljs-number">3</span>:<br>条件成立时，要做的事情<br><span class="hljs-params">...</span><span class="hljs-params">...</span><br><span class="hljs-keyword">else</span>:<br>条件不成立时，要做的事情<br><span class="hljs-params">...</span><span class="hljs-params">...</span><br></code></pre></td></tr></table></figure><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">age</span> = <span class="hljs-function"><span class="hljs-title">int</span>(<span class="hljs-title">input</span>(<span class="hljs-variable">please</span> <span class="hljs-variable">scan</span> <span class="hljs-variable">age</span>:))</span><br><br><span class="hljs-variable"><span class="hljs-keyword">if</span></span> <span class="hljs-variable">age</span>&gt;=<span class="hljs-number">18</span> :<br>    <span class="hljs-function"><span class="hljs-title">print</span>(<span class="hljs-string">&quot;成年了&quot;</span>)</span><br>    <span class="hljs-function"><span class="hljs-title">print</span>(<span class="hljs-string">&quot;dasfasdf&quot;</span>)</span><br><span class="hljs-variable"><span class="hljs-keyword">else</span></span>:<br>    <span class="hljs-function"><span class="hljs-title">print</span>(<span class="hljs-string">&quot;没成年&quot;</span>)</span><br><span class="hljs-function"><span class="hljs-title">print</span>(<span class="hljs-string">&quot;走下面的逻辑&quot;</span>)</span><br></code></pre></td></tr></table></figure><h1 id="逻辑运行-and、or、not"><a href="#逻辑运行-and、or、not" class="headerlink" title="逻辑运行(and、or、not)"></a>逻辑运行(and、or、not)</h1><h1 id="if嵌套"><a href="#if嵌套" class="headerlink" title="if嵌套"></a>if嵌套</h1><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-keyword">if</span> 条件<span class="hljs-number">1</span>:<br>条件<span class="hljs-number">1</span>满足执行的代码<br><span class="hljs-params">...</span><span class="hljs-params">...</span><br><span class="hljs-keyword">if</span> 条件<span class="hljs-number">1</span>基础上的条件<span class="hljs-number">2</span>:<br>条件<span class="hljs-number">2</span>满足时，执行的代码<br><span class="hljs-keyword">else</span>:<br>条件<span class="hljs-number">2</span>不满足时，执行的代码<br><span class="hljs-keyword">else</span>:<br>条件<span class="hljs-number">1</span>不满足时，执行的代码<br></code></pre></td></tr></table></figure><h1 id="随机数的处理"><a href="#随机数的处理" class="headerlink" title="随机数的处理"></a>随机数的处理</h1><ul><li>在Python中，要使用随机数，首先需要导入随机数的模块–”工具包“</li></ul><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">import</span> random<br></code></pre></td></tr></table></figure><ul><li>导入模块后，可以直接在模块名称后面敲一个.然后按Tab键，会提示该模块中包含的所有函数</li><li>random.randint(a,b)，返回[a,b]之间的整数，包含a和b</li></ul><h1 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h1><p>while语句基本语法</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-keyword">while</span> 条件<span class="hljs-comment">(判断 计数器 是否达到 目标次数)</span>:<br>条件满足时，做的事情<span class="hljs-number">1</span><br>条件满足时，做的事情<span class="hljs-number">2</span><br>条件满足时，做的事情<span class="hljs-number">3</span><br>......<br><br>处理条件<span class="hljs-comment">(计数器 + 1)</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">i = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> i &lt;= <span class="hljs-number">5</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello World&quot;</span>)<br><br>    i = i + <span class="hljs-number">1</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;循环结束后的 i = %d&quot;</span> % i)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">i = <span class="hljs-number">0</span><br>count = <span class="hljs-number">0</span><br><span class="hljs-keyword">while</span> i&lt;=<span class="hljs-number">100</span>:<br>    count = count + i<br>    i = i + <span class="hljs-number">1</span><br><br><span class="hljs-built_in">print</span>(count)<br></code></pre></td></tr></table></figure><p>break和continue</p><ul><li>break 满足某一条件时，退出循环，不再执循环</li><li>continue 满足某一条件时，不执行该次循环后续的代码</li></ul><h1 id="循环嵌套"><a href="#循环嵌套" class="headerlink" title="循环嵌套"></a>循环嵌套</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">while</span> 条件<span class="hljs-number">1</span>:<br>条件满足时，做的事情<span class="hljs-number">1</span><br>条件满足时，做的事情<span class="hljs-number">2</span><br>条件满足时，做的事情<span class="hljs-number">3</span><br>......<br><span class="hljs-keyword">while</span> 条件<span class="hljs-number">2</span>：<br>条件满足时，做的事情<span class="hljs-number">1</span><br>条件满足时，做的事情<span class="hljs-number">2</span><br>条件满足时，做的事情<span class="hljs-number">3</span><br>......<br>处理条件<span class="hljs-number">2</span><br>处理条件<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">row = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> row &lt;= <span class="hljs-number">9</span>:<br>    col = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> col &lt;= row:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;%d * %d = %d\t&quot;</span> % (row, col, row * col),end=<span class="hljs-string">&quot;&quot;</span>)<br>        col = col + <span class="hljs-number">1</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;</span>)<br>    row = row + <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h1 id="字符串中的转义字符"><a href="#字符串中的转义字符" class="headerlink" title="字符串中的转义字符"></a>字符串中的转义字符</h1><table><thead><tr><th>转义字符</th><th>描述</th></tr></thead><tbody><tr><td>\\</td><td>反斜杠符号</td></tr><tr><td>\&#39;</td><td>单引号</td></tr><tr><td>\“</td><td>双引号</td></tr><tr><td>\n</td><td>换行</td></tr><tr><td>\t</td><td>横向制表符</td></tr><tr><td>\r</td><td>回车</td></tr></tbody></table><h1 id="函数基础"><a href="#函数基础" class="headerlink" title="函数基础"></a>函数基础</h1><ul><li>所谓函数，就是把具有独立功能的代码块组织为一个小模块，在需要的时候调用</li><li>函数的使用包含两个步骤：<ol><li>定义函数 – 封装独立的功能</li><li>调用函数 – 销售封装的效果</li></ol></li><li>函数的作用，在开发程序时，使用函数可以提高编写的效率以及代码的重用</li></ul><p>函数的定义格式如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">函数名</span>():<br>函数封装的代码<br>......<br></code></pre></td></tr></table></figure><p>带参函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">sum_2_num</span>(<span class="hljs-params">num1, num2</span>):<br><span class="hljs-string">&quot;&quot;&quot;对两个数字求和&quot;&quot;&quot;</span><br>result = num1 + num2<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;%d + %d = %d&quot;</span> % (num1, num2, result))<br><br><br>sum_2_num(<span class="hljs-number">50</span>, <span class="hljs-number">20</span>)<br></code></pre></td></tr></table></figure><p>函数返回值:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">sum_2_num</span>(<span class="hljs-params">num1, num2</span>):<br><span class="hljs-string">&quot;&quot;&quot;对两个数字求和&quot;&quot;&quot;</span><br><span class="hljs-keyword">return</span> num1 + num2<br><br><br>result = sum_2_num(<span class="hljs-number">50</span>, <span class="hljs-number">20</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;计算结果是 %d&quot;</span> % result)<br></code></pre></td></tr></table></figure><p>嵌套函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test1</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;*&quot;</span> * <span class="hljs-number">50</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test2</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">50</span>)<br><br>    test1()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">50</span>)<br><br><br>test2()<br><br></code></pre></td></tr></table></figure><h1 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h1><p>模块是Python程序架构的一个核心概念</p><ul><li>模块就好比是工具包，下用药使用这个工具包中的工具，就需要导入import这个模块</li><li>每一个以扩展名 py 结尾的 Python 源代码文件都是一个模块</li><li>在模块中定义的全局变量、函数 都是模块能够提供给外界直接使用的工具</li><li>可以在一个Python文件中定义变量或者函数</li><li>然后再另外一个文件中使用import导入这个模块</li><li>导入之后，就可以使用 模块名.变量&#x2F;模块名.函数 的方式，使用这个模块中定义的变量或者函数</li></ul><p>模块方便代码复用</p><h1 id="Pyc文件"><a href="#Pyc文件" class="headerlink" title="Pyc文件"></a>Pyc文件</h1><p>C是compiled 编译过的意思</p><p>操作步骤</p><ol><li>浏览程序目录会发现一个__pycache的目录</li><li>目录下面会有一个***.cpyhon-35.pyc文件，cpython-35表示Python解释器的版本</li><li>这个pyc文件是由Python解释器将模块的源码转换为字节码<ul><li>Python这样保存字节码是作为一种启动速度的优化</li></ul></li></ol><p>字节码</p><ul><li>Python在解释源程序时是分成两个步骤的<ol><li>首先处理源代码，编译生成一个二进制字节码</li><li>在对字节码进行处理，才会生成CPU能够识别的机器码</li></ol></li><li>有了模块的字节码文件之后，下一次运行程序时，如果在上次保存字节码之后没有修改过源代码，Python将会加载.pyc文件并跳过编译这个步骤</li><li>当Python重编译时，它会自动检查源文件和字节码文件的时间戳</li><li>如果你又修改了源代码，下次程序运行时，字节码将自动重新创建</li></ul><h1 id="高级变量类型"><a href="#高级变量类型" class="headerlink" title="高级变量类型"></a>高级变量类型</h1><p>ps：对象.之后按Tab键可以查看对象可以使用的操作方法</p><ul><li>列表</li><li>元组</li><li>字典</li><li>字符串</li><li>公共方法</li><li>变量高级</li></ul><h2 id="1、列表（可以修改）"><a href="#1、列表（可以修改）" class="headerlink" title="1、列表（可以修改）"></a>1、列表（可以修改）</h2><h3 id="定义："><a href="#定义：" class="headerlink" title="定义："></a><strong>定义：</strong></h3><ul><li>List（列表）是Python中使用最频繁的数据类型。</li><li>专门用于存储一串信息</li><li>列表用[ ]定义，数据之间使用，分隔</li><li>列表的索引从0开始<ul><li>索引就是数据在列表中的位置编号，索引又可以被称为下标</li></ul></li></ul><ol><li>定义一个列表，例如：name_list &#x3D; []</li><li>列表的各类方法：</li></ol><table><thead><tr><th>序号</th><th>分类</th><th>关键字&#x2F;函数&#x2F;方法</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td>增加</td><td>列表.insert(索引，数据)</td><td>在指定位置插入数据</td></tr><tr><td></td><td></td><td>列表.append(数据)</td><td>在末尾追加数据</td></tr><tr><td></td><td></td><td>列表.extend(列表2)</td><td>将列表2的数据追加到列表</td></tr><tr><td>2</td><td>修改</td><td>列表[索引] &#x3D; 数据</td><td>修改指定索引的数据</td></tr><tr><td>3</td><td>删除</td><td>del列表[索引]</td><td>删除指定索引的数据</td></tr><tr><td></td><td></td><td>列表.remove[数据]</td><td>删除第一个出现的指定数据</td></tr><tr><td></td><td></td><td>列表.pop</td><td>删除末尾数据</td></tr><tr><td></td><td></td><td>列表.pop(索引)</td><td>删除指定索引数据</td></tr><tr><td></td><td></td><td>列表.clear</td><td>清空列表</td></tr><tr><td>4</td><td>统计</td><td>len(列表)</td><td>列表长度</td></tr><tr><td></td><td></td><td>列表.count(数据)</td><td>数据在列表中出现的次数</td></tr><tr><td>5</td><td>排序</td><td>列表.sort()</td><td>升序排序</td></tr><tr><td></td><td></td><td>列表.sort(reverse&#x3D;True)</td><td>降序排序</td></tr><tr><td></td><td></td><td>列表.reverse()</td><td>逆序，反转</td></tr></tbody></table><h3 id="循环遍历"><a href="#循环遍历" class="headerlink" title="循环遍历"></a>循环遍历</h3><ul><li><p>遍历 就是 从头到尾 依次从列表中获取数据</p><ul><li>在循环体内部针对每一个元素，执行相同的操作</li></ul></li><li><p>在Python中为了提高列表的遍历效率，专门提供的迭代Iteration遍历</p></li><li><p>使用for就能够实现迭代遍历</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># for 循环内部使用的变量 in 列表</span><br><span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> name_list:<br>循环内部针对列表元素进行操作<br><span class="hljs-built_in">print</span>(name)<br></code></pre></td></tr></table></figure></li></ul><h2 id="2、元组（不可修改）"><a href="#2、元组（不可修改）" class="headerlink" title="2、元组（不可修改）"></a>2、元组（不可修改）</h2><h3 id="定义：-1"><a href="#定义：-1" class="headerlink" title="定义："></a><strong>定义：</strong></h3><ul><li>Tuple（元组）与列表类似，不同之处在于元组的元素不能修改<ul><li>元组表示多个元素组成的序列</li><li>元组在Python开发中，有特定的应用场景</li></ul></li><li>用于存储一串信息，数据之间使用，分割</li><li>元组用()定义</li><li>元组的索引 从0开始<ul><li>索引就是数据在元组中的位置编号</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">info_tuple = (<span class="hljs-string">&quot;zhangsan&quot;</span>,<span class="hljs-number">18</span>,<span class="hljs-number">1.75</span>)<br></code></pre></td></tr></table></figure><p>创建空元组</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">tuple</span> = ()<br></code></pre></td></tr></table></figure><p>元组中 只包含一个元素时，需要在元素后面添加逗号</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">info_tuple</span> = (<span class="hljs-number">50</span>,)<br></code></pre></td></tr></table></figure><p>元组的常用方法</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">info</span>.count<span class="hljs-keyword">info</span>.<span class="hljs-keyword">index</span><br></code></pre></td></tr></table></figure><h3 id="循环遍历-1"><a href="#循环遍历-1" class="headerlink" title="循环遍历"></a>循环遍历</h3><ul><li>取值 就是从 元组中获取存储在指定位置的数据</li><li>遍历就是从头到尾依次从元组中获取数据</li></ul><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># for 循环内部使用的变量 in 元组</span><br><span class="hljs-keyword">for</span> <span class="hljs-built_in">item</span> <span class="hljs-keyword">in</span> info:<br>循环内部针对元组元素进行操作<br>print(<span class="hljs-built_in">item</span>)<br></code></pre></td></tr></table></figure><ul><li><strong>在 Python中，可以使用for循环遍历所有非数字型类型的变量：列表、元组、字典以及字符串</strong></li><li>ps：在实际开发中，除非能够确认元组中的数据类型，否则针对元组的循环遍历需求并不是很多</li></ul><h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a><strong>应用场景</strong></h3><ul><li>尽管可以使用for in 遍历元组</li><li>但是在开发中，更多的应用场景是：<ul><li>函数的参数和返回值，一个函数可以接受任意多个参数，或者一次返回多个数据</li><li>格式字符串，格式化字符串后面的()本质上就是一个元组</li><li>让列表不可以被修改，以保护数据安全</li></ul></li></ul><p><strong>元组和列表之间的转化</strong></p><ul><li>使用 list 函数可以把元组转换成列表</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">list</span><span class="hljs-params">(元组)</span></span><br></code></pre></td></tr></table></figure><ul><li>使用tuple函数可以把列表转换成元组</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">tuple</span><span class="hljs-params">(列表)</span></span><br></code></pre></td></tr></table></figure><h2 id="3、字典"><a href="#3、字典" class="headerlink" title="3、字典"></a>3、字典</h2><h3 id="定义：-2"><a href="#定义：-2" class="headerlink" title="定义："></a><strong>定义：</strong></h3><ul><li>dictionary（字典）是除列表以外Python之中最灵活的数据类型</li><li>字典同样可以用来存储多个数据<ul><li>通常用于存储描述一个<strong>物体</strong>的相关信息</li></ul></li><li>和列表的区别<ul><li>列表是有序的对象集合</li><li>字典是无序的对象集合</li></ul></li><li>字典用{}定义</li><li>字典使用<strong>键值对</strong>存储数据，键值对之间使用，分隔<ul><li>键key是索引</li><li>值value是数据</li><li>键和值之间使用:分割</li><li>键必须是唯一的</li><li>值可以取任何数据类型，但<strong>键</strong>只能使用字符串、数字或元组</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">xiaoming = &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;小明&quot;</span>,<br><span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">18</span>,<br><span class="hljs-string">&quot;gender&quot;</span>: <span class="hljs-literal">True</span>,<br><span class="hljs-string">&quot;height&quot;</span>: <span class="hljs-number">1.75</span>&#125;<br></code></pre></td></tr></table></figure><h3 id="常用操作："><a href="#常用操作：" class="headerlink" title="常用操作："></a><strong>常用操作：</strong></h3><p>len(字典)：获取字典的键值对数量</p><p>字典.keys()：获取所有key列表</p><p>字典.values()：所有value列表</p><p>字典.items()：所有(key,value)元组列表</p><p>字典[key]：可以从字典中取值，key不存在会报错</p><p>字典.get(key)：可以从字典中取值，key不存在不会报错</p><p>del 字典[key]：删除指定键值对，key不会存在报错</p><p>字典.pop(key)：删除指定键值对，key不存在会报错</p><p>字典.popitem()：随机删除一个键值对</p><p>字典[key] &#x3D; value：如果key存在，修改数据，如果key不存在，新增键值对</p><p>字典.setdefault(key,value)：如果key存在，不会修改数据秒如果key不存在，新增键值对</p><p>字典.update(字典2)：将字典2的数据合并到字典1</p><h3 id="循环遍历-2"><a href="#循环遍历-2" class="headerlink" title="循环遍历"></a>循环遍历</h3><ul><li>遍历就是依次从字典中获取所有键值对</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># for 循环内部使用的 key的变量 in 字典</span><br><span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> xiaoming：<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;</span>%s : %s<span class="hljs-string">&quot; % (key,xiaoming[key]))</span><br></code></pre></td></tr></table></figure><p>ps：在实际开发中，由于字典中每一个键值对保存数据的类型是不同的，所有正对字典的循环遍历需求并不是很多。</p><h3 id="应用场景-1"><a href="#应用场景-1" class="headerlink" title="应用场景"></a>应用场景</h3><ul><li>尽管可以使用for in遍历字典</li><li>但是在开发中，更多的应用场景是：<ul><li>使用多个键值对，存储描述一个物体的相关信息——描述更复杂的数据信息</li><li>将多个字典放在一个列表中，再进行遍历，再循环体内部针对每一个字典进行相同的处理</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">card_list = [&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;zhangsan&quot;</span>,<br>  <span class="hljs-string">&quot;qq&quot;</span>:<span class="hljs-string">&quot;123456&quot;</span>,<br>  <span class="hljs-string">&quot;phone&quot;</span>:<span class="hljs-string">&quot;110&quot;</span>&#125;,<br> &#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;lisi&quot;</span>,<br>  <span class="hljs-string">&quot;qq&quot;</span>:<span class="hljs-string">&quot;56789&quot;</span>,<br>  <span class="hljs-string">&quot;phone&quot;</span>:<span class="hljs-string">&quot;11111&quot;</span><br>&#125;]<br></code></pre></td></tr></table></figure><h2 id="4、字符串"><a href="#4、字符串" class="headerlink" title="4、字符串"></a>4、字符串</h2><h3 id="定义：-3"><a href="#定义：-3" class="headerlink" title="定义："></a>定义：</h3><ul><li>字符串就是一串字符，是编程语言中表示文本的数据类型</li><li>在Python中可以使用一对双引号””或者一对单引号’’定义一个字符串<ul><li>跟java一样需要用到多重引号需要转义</li></ul></li><li>可以使用索引获取一个字符串中指定位置的字符，索引计数从0开始</li><li>也可以使用for循环遍历字符串中每一个字符</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">string = <span class="hljs-string">&quot;Hello Python&quot;</span><br><br><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> string:<br><span class="hljs-built_in">print</span>(c)<br></code></pre></td></tr></table></figure><h3 id="常用操作：-1"><a href="#常用操作：-1" class="headerlink" title="常用操作："></a>常用操作：</h3><p>len(字符串)：获取字符串的长度</p><p>字符串.count(字符串)：小字符串在大字符串出现的次数</p><p>字符串[索引]：从字符串中取出单个字符</p><p>字符串.index(字符串)：获取小字符串第一次出现的索引</p><h4 id="判断类型"><a href="#判断类型" class="headerlink" title="判断类型"></a><strong>判断类型</strong></h4><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>string.isspace()</td><td>如果string中只包含空额，则返回True</td></tr><tr><td>string.isalnum()</td><td>如果string至少有一个字符并且所有字符都是字母或数字则返回True</td></tr><tr><td>string.isalpha()</td><td>如果string至少有一个字符并且所有字符都是字母则返回True</td></tr><tr><td>string.isdecimal()</td><td>如果string只包含数字则返回True，全角数字</td></tr><tr><td>string.isdigit()</td><td>如果string只包含数字则返回True，全角数字、(1)、\u00b2</td></tr><tr><td>string.isnumeric()</td><td>如果string只包含数字则返回True，全角数字，汉字数字</td></tr><tr><td>string.istitle</td><td>如果string是标题化的（每个单词的首字母大写）则返回True</td></tr><tr><td>string.islower()</td><td>如果string中包含至少一个区分大小写的字符，并且所有这些（区分大小写的）字符都是小写，则返回True</td></tr><tr><td>string.isupper()</td><td>如果string中包含至少一个区分大小写的字符，并且所有这些（区分大小写的）字符都是大写，则返回True</td></tr></tbody></table><h4 id="查找和替换"><a href="#查找和替换" class="headerlink" title="查找和替换"></a>查找和替换</h4><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>string.startswith(str)</td><td>检查字符串是否是以str开头，是则返回True</td></tr><tr><td>string.endswith(str)</td><td>检查字符串是否是以str结束，是则返回True</td></tr><tr><td>string.find(str,start&#x3D;0,end&#x3D;len(string))</td><td>检测str是否包含在string中，如果start和end指定范围，则检测是否包含在指定范围内，如果是返回开始的索引值，否则返回-1</td></tr><tr><td>string.rfind(str,start&#x3D;0,end&#x3D;len(string))</td><td>类似于find()函数，不过是从右边开始查找</td></tr><tr><td>string.index(str,start&#x3D;0,end&#x3D;len(string))</td><td>跟find()方法类似，只不过如果str不在string会报错</td></tr><tr><td>string.rindex(str,start&#x3D;0,end&#x3D;len(string))</td><td>类似于index()，不过是从右边开始</td></tr><tr><td>string.replace(old_str,new_str,num&#x3D;string.count(old))</td><td>把string中的old_str替换new_str,如果num指定，则替换不超过num次</td></tr></tbody></table><h4 id="大小写转化"><a href="#大小写转化" class="headerlink" title="大小写转化"></a>大小写转化</h4><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>string.capitalize()</td><td>把字符串的第一个字符大写</td></tr><tr><td>string.title()</td><td>把字符串的每个单词首字母大写</td></tr><tr><td>string.lower()</td><td>转换 string 中所有大写字符为小写</td></tr><tr><td>string.upper()</td><td>转换 string 中的小写字母为大写</td></tr><tr><td>string.swapcase()</td><td>翻转 string 中的大小写</td></tr></tbody></table><h4 id="文本对齐"><a href="#文本对齐" class="headerlink" title="文本对齐"></a>文本对齐</h4><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>string.ljust(width)</td><td>返回一个原字符串左对齐，并使用空格填充至长度 width 的新字符串</td></tr><tr><td>string.rjust(width)</td><td>返回一个原字符串右对齐，并使用空格填充至长度 width 的新字符串</td></tr><tr><td>string.center(width)</td><td>返回一个原字符串居中，并使用空格填充至长度 width 的新字符串</td></tr></tbody></table><h4 id="去除空白字符"><a href="#去除空白字符" class="headerlink" title="去除空白字符"></a>去除空白字符</h4><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>string.lstrip()</td><td>截掉string 左边(开始)的空白字符</td></tr><tr><td>string.rstrip()</td><td>截掉 string 右边(末尾)的空白字符</td></tr><tr><td>string.strip()</td><td>截掉string左右两边的空白字符</td></tr></tbody></table><h4 id="拆分和连接"><a href="#拆分和连接" class="headerlink" title="拆分和连接"></a>拆分和连接</h4><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>string.partition(str)</td><td>把字符串 string 分成一个3元素的元组(str前面,str,str后面)</td></tr><tr><td>string.rpartition(str)</td><td>类似于 partition0方法，不过是从右边开始查找</td></tr><tr><td>string.split(str&#x3D;””,num)</td><td>以str 为分隔符拆分 string，如果 num 有指定值，则仅分隔 num +1个子字符串，str 默认包含 r; tn’和空格</td></tr><tr><td>string.splitlines()</td><td>按照行(‘\r’,’\n’,’\r\n’)分隔，返回一个包含各行作为元素的列表</td></tr><tr><td>string.join(seq)</td><td>以string 作为分隔符，将 seq中所有的元素 (的字符串表示) 合并为一个新的字符串</td></tr></tbody></table><h3 id="字符串的切片："><a href="#字符串的切片：" class="headerlink" title="字符串的切片："></a>字符串的切片：</h3><ul><li>切片 方法适用于字符串、列表、元组<ul><li>切片 使用索引值来限定范围，从一个大的字符串中切出小的字符串</li><li>列表和元组都是有序的集合，都能够通过索引值获取到对应的数据</li><li>字典是一个无序的集合，是使用键值对保存数据</li></ul></li></ul><p><img src="/python%E5%9F%BA%E7%A1%80/image-20230314162133065.png" alt="image-20230314162133065"></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">字符串<span class="hljs-selector-attr">[开始索引:结束索引:步长]</span><br></code></pre></td></tr></table></figure><p><strong>注意：</strong></p><ol><li>指定的区间属于左闭右开型 [开始索引，结束索引）&#x3D;&gt; 开始索引 &gt;&#x3D; 范围 &lt; 结束索引</li><li>从头开始，开始索引数字可以省略，冒号不能省略</li><li>到末尾结束，结束索引数字可以省略，冒号不能省略</li><li>步长默认为1，如果连续切片，数字和冒号都可以省略</li></ol><h2 id="5、公共方法"><a href="#5、公共方法" class="headerlink" title="5、公共方法"></a>5、公共方法</h2><h3 id="5-1、Python内置函数"><a href="#5-1、Python内置函数" class="headerlink" title="5.1、Python内置函数"></a>5.1、Python内置函数</h3><p>Python包含了一下内置函数：</p><table><thead><tr><th>函数</th><th>描述</th><th>备注</th></tr></thead><tbody><tr><td>len(item)</td><td>计算容器中元素个数</td><td></td></tr><tr><td>del(item)</td><td>删除变量</td><td>del有两种方式</td></tr><tr><td>max(item)</td><td>返回容器中元素最大值</td><td>如果是字典，只针对key比较</td></tr><tr><td>min(item)</td><td>返回容器中元素最小值</td><td>如果是字典，只针对key比较</td></tr><tr><td>cmp(item1,item2)</td><td>比较两个值，-1小于&#x2F;0相等&#x2F;1大于</td><td>Python 3.x取消了cmp函数</td></tr></tbody></table><p>ps：字符串标胶符合一下规则：”0” &lt; “A” &lt; “a”</p><h3 id="5-2、切片"><a href="#5-2、切片" class="headerlink" title="5.2、切片"></a>5.2、切片</h3><table><thead><tr><th>描述</th><th>Python表达式</th><th>结果</th><th>支持的数据类型</th></tr></thead><tbody><tr><td>切片</td><td>“0123456789”[::-2]</td><td>“97531”</td><td>字符串、列表、元组</td></tr></tbody></table><ul><li>切片使用索引值来限定范围，从一个大的字符串中切出小的字符串</li><li>列表和元组都是有序的集合，都能够通过索引值获取到对应的数据</li><li>字典是一个无序的集合，时使用键值对保存数据</li></ul><h3 id="5-3、运算符"><a href="#5-3、运算符" class="headerlink" title="5.3、运算符"></a>5.3、运算符</h3><table><thead><tr><th>运算符</th><th>Python表达式</th><th>结果</th><th>描述</th><th>支持的数据类型</th></tr></thead><tbody><tr><td>+</td><td>[1,2]+[3,4]</td><td>[1,2,3,4]</td><td>合并</td><td>字符串、列表、元组</td></tr><tr><td>*</td><td>[“Hi!”] * 4</td><td>[“Hi!”,”Hi!”,”Hi!”,”Hi!”]</td><td>重复</td><td>字符串、列表、元组</td></tr><tr><td>ln</td><td>3 in (1,2,3)</td><td>True</td><td>元素是否存在</td><td>字符串、列表、元组、字典</td></tr><tr><td>not in</td><td>4 not in（1,2,3）</td><td>True</td><td>元素是否不存在</td><td>字符串、列表、元组、字典</td></tr><tr><td>&gt; &gt;&#x3D; &#x3D;&#x3D; &lt; &lt;&#x3D;</td><td>(1,2,3) &lt; (2,2,3)</td><td>True</td><td>元素比较</td><td>字符串、列表、元组</td></tr></tbody></table><p>ps：</p><ul><li>in在对字典操作时，判断的是字典的键</li><li>in和not in 被称为成员运算符</li></ul><h3 id="5-4、完整的For循环语法"><a href="#5-4、完整的For循环语法" class="headerlink" title="5.4、完整的For循环语法"></a>5.4、完整的For循环语法</h3><p>在Python中完成的for循环的语法如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> 变量 <span class="hljs-keyword">in</span> 集合:<br>循环体代码<br><span class="hljs-keyword">else</span>:<br>没有通过<span class="hljs-keyword">break</span>退出循环，循环结束后，会执行的代码<br></code></pre></td></tr></table></figure><h1 id="变量进阶"><a href="#变量进阶" class="headerlink" title="变量进阶"></a>变量进阶</h1><p>目标：</p><ul><li>变量的引用</li><li>可变和不可变类型</li><li>局部变量和全局变量</li></ul><h2 id="1、变量的引用"><a href="#1、变量的引用" class="headerlink" title="1、变量的引用"></a>1、变量的引用</h2><ul><li>变量和数据都是保存在内存中的</li><li>在Python中函数的参数传递以及返回值都是靠引用传递的</li></ul><h3 id="1-1、引用的概念"><a href="#1-1、引用的概念" class="headerlink" title="1.1、引用的概念"></a>1.1、引用的概念</h3><p>在Python中</p><ul><li>变量和数据是分开存储的</li><li>数据保存在内存中的一个位置</li><li>变量中保存着数据在内存中的地址</li><li>变量中记录数据的地址，就叫作引用</li><li>使用id()函数可以查看变量中保存数据所在的内存地址</li></ul><p>ps：如果变量已经被定义，当给一个变量赋值的时候，本质上是修改了数据的引用</p><ul><li>变量不再对之前的数据引用</li><li>变量改为对新赋值的数据引用</li></ul><h3 id="1-2、变量引用的示例"><a href="#1-2、变量引用的示例" class="headerlink" title="1.2、变量引用的示例"></a>1.2、变量引用的示例</h3><h3 id="1-3、函数的参数和返回值的传递"><a href="#1-3、函数的参数和返回值的传递" class="headerlink" title="1.3、函数的参数和返回值的传递"></a>1.3、函数的参数和返回值的传递</h3><p>在Python中，函数的实参&#x2F;返回值 都是靠引用来传递来的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>(<span class="hljs-params">num</span>):<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">50</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;%d 在函数内的内存地址是 %x&quot;</span> % (num, <span class="hljs-built_in">id</span>(num)))<br><br>result = <span class="hljs-number">100</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;返回值 %d 在内存中的地址是 %x&quot;</span> % (result, <span class="hljs-built_in">id</span>(result)))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">50</span>)<br><br><span class="hljs-keyword">return</span> result<br><br>a = <span class="hljs-number">10</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;调用函数前 实参内存地址是 %x&quot;</span> % <span class="hljs-built_in">id</span>(a))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;调用函数前 返回值内存地址是 %x&quot;</span> % <span class="hljs-built_in">id</span>(r))<br><br></code></pre></td></tr></table></figure><h2 id="2、可变和不可变类型"><a href="#2、可变和不可变类型" class="headerlink" title="2、可变和不可变类型"></a>2、可变和不可变类型</h2><ul><li>不可变类型，内存中的数据不允许被修改<ul><li>数据类型 int，bool，float，complex，long(2.x)</li><li>字符串 str</li><li>元组 tuple</li></ul></li><li>可变类型，内存中的数据可以被修改<ul><li>列表 list</li><li>字典 dict</li></ul></li></ul><p>ps：字典的key只能使用不可变类型的数据</p><ol><li>可变类型的数据变化，是通过方法来实现的</li><li>如果给一个可变类型的变量，赋值了一个新的数据，引用会修改<ul><li>变量不再对之前的数据引用</li><li>变量改为对新赋值的数据引用</li></ul></li></ol><p>哈希（hash）</p><ul><li>Python中内置有一个名字叫做hash(o)的函数<ul><li>接受一个不可变类型的数据作为参数</li><li>返回结果是一个整数</li></ul></li><li>hash是一种算法，其作用就是提起数据的特征码（指纹）<ul><li>相同的内容得到相同的结果</li><li>不同的内容得到不同的结果</li></ul></li><li>在Python中，设置字典的键值对时，会首先对key进行hash已决定如何在内存中保存字典的数据，以方便后续对字典的操作：CRUD<ul><li>键值对的key必须是不可变类型数据</li><li>键值对的value可以是任意类型的数据</li></ul></li></ul><h2 id="3、局部变量和全局变量"><a href="#3、局部变量和全局变量" class="headerlink" title="3、局部变量和全局变量"></a>3、局部变量和全局变量</h2><ul><li>局部变量实在函数内部定义的变量，只能在函数内部使用</li><li>全局变量实在函数外部定义的变量（没有定义在某一个函数内），所有函数内部都可以使用这个变量</li></ul><h3 id="3-1-局部变量"><a href="#3-1-局部变量" class="headerlink" title="3.1 局部变量"></a>3.1 局部变量</h3><ul><li>局部变量是在函数内部定义的变量，只能在函数内部使用</li><li>函数执行结束后，函数内部的局部变量会被系统回收</li><li>不同的函数，可以定义相同名字的局部变量，但是各用各的不会产生影响</li></ul><p>局部变量的生命周期</p><ul><li>所谓生命周期就是变量从被创建到被系统回收的过程</li><li>局部变量在函数执行时，才会被创建</li><li>函数执行结束后局部变量被系统回收</li><li>局部变量在生命周期内，可以用来存储函数内部临时使用到的数据</li></ul><h3 id="3-2-全局变量"><a href="#3-2-全局变量" class="headerlink" title="3.2 全局变量"></a>3.2 全局变量</h3><ul><li>全局变量是在函数外部定义的变量，所有函数内部都可以使用这个变量</li></ul><p>ps：函数执行时，需要处理变量时会：</p><ol><li>首先查找函数内部是否存在指定名称的局部变量，如果有，直接使用</li><li>如果没有，查找函数外部是否存在指定名称的全局变量，如果有，直接使用</li><li>如果还没有，程序报错。</li></ol><p>1）函数不能直接修改全局变量的引用</p><ul><li>全局变量是在函数外部定义的变量（没有定义在某一个函数内），所有函数内部都可以使用这个变量</li><li>在函数内部，可以通过全局变量的引用获取对应的数据</li><li>但是，不允许直接修改全局变量的引用——使用赋值语句修改全局变量的值</li></ul><p>ps：如果在函数内部定义了一个与全局变量相同的局部变量，他们只是名称相同而已，在函数内部不能直接修改全局变量的值。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">demo1()<br><span class="hljs-comment">#全局变量</span><br>num = <span class="hljs-number">10</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">demo1</span>():<br>num = <span class="hljs-number">99</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;demo1 ==&gt; %d&quot;</span> % num)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">demo2</span>():<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;demo1 ==&gt; %d&quot;</span> % num)<br><br>demo1()<br>demo2()<br></code></pre></td></tr></table></figure><p>2）在函数内部修改全局变量的值</p><ul><li><p>如果在函数中需要修改全局变量，需要使用global进行声明</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">num = <span class="hljs-number">10</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">demo1</span>():<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;demo1&quot;</span> + <span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">50</span>)<br><br><span class="hljs-keyword">global</span> num<br><br>num = <span class="hljs-number">100</span><br><span class="hljs-built_in">print</span>(<span class="hljs-number">100</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">demo2</span>():<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;demo2&quot;</span> + <span class="hljs-string">&quot;-&quot;</span> *<span class="hljs-number">50</span>)<br><span class="hljs-built_in">print</span>(num)<br><br>demo1()<br>demo2()<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;over&quot;</span>)<br></code></pre></td></tr></table></figure></li></ul><p>3）全局变量定义的位置</p><ul><li>为了保证所有的函数都能够正确使用到全局变量，应该将全局变量定义在其他函数的上方</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">a = <span class="hljs-number">10</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">demo</span>():<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;%d&quot;</span> % a)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;%d&quot;</span> % b)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;%d&quot;</span> % c)<br><br>b = <span class="hljs-number">20</span><br>demo()<br>c = <span class="hljs-number">30</span><br></code></pre></td></tr></table></figure><p><strong>注意</strong></p><ul><li>由于全局变量c，是在调用函数之后，才定义的，在执行函数时，变量还没有定义，所以程序会报错！</li></ul><p>代码的结构示意图如下</p><p><img src="/python%E5%9F%BA%E7%A1%80/image-20230327214025738.png" alt="image-20230327214025738"></p><p>4）全局变量命名的建议</p><ul><li>为了避免局部变量和全局变量出现混淆，在定义全局变量时，有一些公司会有开发要求，例如：全局变量名前应该改加g_或者gl的前缀</li></ul><h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><p>目标</p><ul><li>函数参数和返回值的作用</li><li>函数的返回值 进阶</li><li>函数的参数 进阶</li><li>递归函数</li></ul><h2 id="01-函数参数和返回值的作用"><a href="#01-函数参数和返回值的作用" class="headerlink" title="01.函数参数和返回值的作用"></a>01.函数参数和返回值的作用</h2><p>函数根据有没有参数以及有没有返回值，可以相互组合，一共有四种组合形式</p><ol><li>无参数，无返回值</li><li>无参数，有返回值</li><li>有参数，无返回值</li><li>有参数，有返回值</li></ol><p><img src="/python%E5%9F%BA%E7%A1%80/image-20230327214521586.png" alt="image-20230327214521586"></p><h2 id="02-函数的返回值-进阶"><a href="#02-函数的返回值-进阶" class="headerlink" title="02.函数的返回值 进阶"></a>02.函数的返回值 进阶</h2><ul><li>在程序开发中，有时候，会希望一个函数执行结束后，告诉调用者一个结果，以便调用者针对具体的结果做后续的处理</li><li>返回值 是函数 完成过工作后，最后 给调用者的一个结果</li><li>在函数中使用 return 关键字可以返回结果</li><li>调用函数一方，可以使用变量来接受函数的返回结果</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">当方法返回值是一个元组时，<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ab</span>():<br><span class="hljs-keyword">return</span> a,b;<br>可以使用一个元组来接收<br>result = ab()<br>也可以将元组拆开来接收<br>a, b = ab();<br></code></pre></td></tr></table></figure><p>交换两个数字</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 解法1 - 使用临时变量</span><br>c = b<br>b = a<br>a = c<br><br><span class="hljs-comment"># 解法2 - 不适用临时变量</span><br>a = a + b<br>b = a - b<br>a = a - b<br><br><span class="hljs-comment"># 解法3 - python的元组</span><br>a, b = b, a<br></code></pre></td></tr></table></figure><h2 id="03-函数的参数-进阶"><a href="#03-函数的参数-进阶" class="headerlink" title="03.函数的参数 进阶"></a>03.函数的参数 进阶</h2><p><strong>3.1.不可变和可变的参数</strong></p><p><strong>问题1：</strong>在函数内部，针对参数使用的赋值语句，会不会影响到调用函数时传递的实参变量？</p><p>不会</p><ul><li>无论传递的参数是可变的还是不可变的<ul><li>只要针对参数使用赋值语句，会在函数内部修改局部变量的引用，不会影响到外部变量的引用</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">demo</span>(<span class="hljs-params">num, num_list</span>):<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;函数内部&quot;</span>)<br><br><span class="hljs-comment"># 赋值语句</span><br>num = <span class="hljs-number">200</span><br>num_list = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<br><br><span class="hljs-built_in">print</span>(num)<br><span class="hljs-built_in">print</span>(num_list)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;函数代码完成&quot;</span>)<br><br>gl_num = <span class="hljs-number">99</span><br>gl_list = [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]<br>demo(gl_num, gl_list)<br><span class="hljs-built_in">print</span>(gl_num)<br><span class="hljs-built_in">print</span>(gl_list)<br><br></code></pre></td></tr></table></figure><p><strong>问题2：</strong>如果传递的参数是可变类型，在函数内部，使用方法修改了数据的内容，同样会影响到外部的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">mutable</span>(<span class="hljs-params">num_list</span>):<br><span class="hljs-comment"># num_list = [1, 2, 3]</span><br>num_list.extend([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])<br><br><span class="hljs-built_in">print</span>(num_list)<br><br>gl_list = [<span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>]<br>mutable(gl_list)<br><span class="hljs-built_in">print</span>(gl_list)<br></code></pre></td></tr></table></figure><ul><li>在python中，列表变量调用+&#x3D;本质上实在执行列表变量的extend方法，不会修改变量的引用</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">demo</span>(<span class="hljs-params">num, num_list</span>):<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;函数内部代码&quot;</span>)<br><br><span class="hljs-comment"># num = num + num</span><br>num += num<br><span class="hljs-comment"># num_list.extend(num_list)由于是调用方法，使用不会修改变量的引用</span><br><span class="hljs-comment"># 函数执行结束后， 外部数据同样会发生变化</span><br>num_list += num_list<br><br><span class="hljs-built_in">print</span>(num)<br><span class="hljs-built_in">print</span>(num_list)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;函数代码完成&quot;</span>)<br><br>gl_num = <span class="hljs-number">9</span><br>gl_list = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<br>demo(gl_num, gl_list)<br><span class="hljs-built_in">print</span>(gl_num)<br><span class="hljs-built_in">print</span>(gl_list)<br></code></pre></td></tr></table></figure><p><strong>3.2 缺省参数</strong></p><ul><li>定义函数时，可以给某个参数指定一个默认值，具有默认值的参数就叫做缺省参数</li><li>调用函数时，如果没有传入缺省参数的值，则在函数内部使用定义函数时指定的参数默认值</li><li>函数的缺省参数，将常见的值设置为参数的缺省值，从而简化函数的调用</li><li>例如：对列表排序的方法</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">gl_num_list = [<span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">9</span>]<br><br><span class="hljs-comment"># 默认就是升序排序，因为这种应用需求更多</span><br>gl_num_list.sort()<br><span class="hljs-built_in">print</span>(gl_num_list)<br><br><span class="hljs-comment"># 只有当需要降序排序时，才需要传递&quot;reverse&quot;参数</span><br>gl_num_list.sort(reverse=<span class="hljs-literal">True</span>)<br><span class="hljs-built_in">print</span>(gl_num_list)<br></code></pre></td></tr></table></figure><p><strong>指定函数的缺省参数</strong></p><ul><li>在参数后使用赋值语句，可以指定参数的缺省值</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">print_info</span>(<span class="hljs-params">name, gender=<span class="hljs-literal">True</span></span>):<br><br>gender_text = <span class="hljs-string">&quot;男生&quot;</span><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> gender:<br>gender_text = <span class="hljs-string">&quot;女生&quot;</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;%s 是 %s&quot;</span> % (name, gender_text))<br></code></pre></td></tr></table></figure><p>ps:</p><ol><li>缺省参数，需要使用最常见的值作为默认值！</li><li>如果一个参数的值布恩那个确定，则不应该设置默认值，具体的数值在调用函数时，由外界传递</li></ol><p><strong>缺省参数的注意事项</strong></p><p>1）缺省参数的定义位置</p><ul><li>必须保证带有默认值的缺省参数在参数列表末尾</li><li>所以，一下定义是错误的！</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">print_info</span>(<span class="hljs-params">name, gender=<span class="hljs-literal">True</span>, title</span>):<br></code></pre></td></tr></table></figure><p>2)调用带有多个缺省参数的函数</p><ul><li>在调用函数时，如果有多个缺省参数，需要指定参数名，这样解释器才能够知道参数的对应关系！</li></ul><p><strong>3.3 多值参数</strong></p><p><strong>定义支持多值参数的参数</strong></p><ul><li>有时可能需要一个函数能够处理的参数 个数 是不确定的，这个时候，就可以使用多值参数</li><li>python 中有两种多值参数：<ul><li>参数名前面增加一个 * 可以接收元组</li><li>参数名前面增加两个 * 可以接收字典</li></ul></li><li>一般在给多值参数命名时，习惯使用以下两个名字<ul><li>*args ——存放 元组参数，前面有一个 * </li><li>*<em>kwargs —— 存放 字典 参数，前面有两个</em></li></ul></li><li>args 是 arguments 的缩写，有变量的含义</li><li>kw 是 keyword的缩写，kwargs 可以记忆键值对参数</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">demo</span>(<span class="hljs-params">num, *args, **kwargs</span>):<br><br><span class="hljs-built_in">print</span>(num)<br><span class="hljs-built_in">print</span>(args)<br><span class="hljs-built_in">print</span>(kwargs)<br><br>demo(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, name=<span class="hljs-string">&quot;小明&quot;</span>, age=<span class="hljs-number">18</span>, gender=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p>提示：多指参数的应用会经常出现在网络上一些大牛开发的框架中，知道多指参数，有利于我们能够读懂大牛的代码</p><p><strong>多值参数案例——计算任意多个数字的和</strong></p><p><strong>需求</strong></p><ol><li>定义一个函数sum_numbers,可以接收的任意多个整数</li><li>功能要求：将传递的所有数字累加并返回累加结果</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">sum_numbers</span>(<span class="hljs-params">*args</span>):<br><br>num = <span class="hljs-number">0</span><br><span class="hljs-comment"># 遍历args元组顺序求和</span><br><span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> args:<br>num += n<br><br><span class="hljs-keyword">return</span> num<br><br><span class="hljs-built_in">print</span>(sum_numbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>))<br></code></pre></td></tr></table></figure><p><strong>元组和字典的拆包</strong></p><ul><li>在调节带有多值参数的函数时，如果希望<ul><li>将一个元组变量，直接传递给args</li><li>将一个字典变量，直接传递给kwargs</li></ul></li><li>就可以使用拆包，简化参数的传递，拆包的方式是：<ul><li>在元组变量前，增加一个*</li><li>在字典变量前，增加两个*</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">demo</span>(<span class="hljs-params">*args, **kwargs</span>):<br><br><span class="hljs-built_in">print</span>(args)<br><span class="hljs-built_in">print</span>(kwargs)<br><br><br><span class="hljs-comment"># 需要将一个元组变量/字典变量传递给函数对应的参数</span><br>gl_nums(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br>gl_xiaoming = &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;小明&quot;</span>, <span class="hljs-string">&quot;ages&quot;</span>: <span class="hljs-number">18</span>&#125;<br><br><span class="hljs-comment">#会把 num_tuple和xiaoming作为元组传递给args</span><br><span class="hljs-comment"># demo(gl_nums, gl_xiaoming)</span><br>demo(*gl_nums, **gl_xiaoming)<br></code></pre></td></tr></table></figure><h2 id="04-函数的递归"><a href="#04-函数的递归" class="headerlink" title="04.函数的递归"></a>04.函数的递归</h2><p>函数调用自身的编程技巧称为递归</p><p><strong>4.1递归函数的特点</strong></p><ul><li>一个函数 内部 调用自己<ul><li>函数内部可以调用其他函数，当然在函数内部也可以调用自己</li></ul></li></ul><p>代码特点</p><ol><li>函数内部的代码是相同的，只是针对参数不同，处理的结果不同</li><li>当参数满足一个条件时，函数不再执行</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">sum_numbers</span>(<span class="hljs-params">num</span>):<br><br><span class="hljs-built_in">print</span>(num)<br><br><span class="hljs-keyword">if</span> num == <span class="hljs-number">1</span><br><span class="hljs-keyword">return</span><br><br>sum_numbers(num - <span class="hljs-number">1</span>)<br><br>sum_numbers(<span class="hljs-number">3</span>)<br></code></pre></td></tr></table></figure><p><img src="/python%E5%9F%BA%E7%A1%80/image-20230328100709669.png" alt="image-20230328100709669"></p><p><strong>4.2 递归案例——计算数字累加</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">sum_numbers</span>(<span class="hljs-params">num</span>):<br><br><span class="hljs-keyword">if</span> num == <span class="hljs-number">1</span>:<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br><br>temp = sum_numbers(num - <span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">return</span> num + temp<br><br><span class="hljs-built_in">print</span>(sum_numbers(<span class="hljs-number">2</span>))<br></code></pre></td></tr></table></figure><h1 id="面向对象-oop-基本概念"><a href="#面向对象-oop-基本概念" class="headerlink" title="面向对象(oop)基本概念"></a>面向对象(oop)基本概念</h1><p>面向对象编程——Object Oriented Programming 简写OOP</p><p><strong>目标</strong></p><ul><li>了解面向对象基本概念</li></ul><h2 id="01-面向对象基本概念"><a href="#01-面向对象基本概念" class="headerlink" title="01.面向对象基本概念"></a>01.面向对象基本概念</h2><h3 id="1-1-过程和函数（科普）"><a href="#1-1-过程和函数（科普）" class="headerlink" title="1.1 过程和函数（科普）"></a>1.1 过程和函数（科普）</h3><ul><li>过程 是早期的一个编程概念</li><li>过程类似于函数，只能执行，但是没有返回值</li><li>函数不仅能执行，还可以返回结果</li></ul><h3 id="1-2-面向过程和面向对象基本概念"><a href="#1-2-面向过程和面向对象基本概念" class="headerlink" title="1.2 面向过程和面向对象基本概念"></a>1.2 面向过程和面向对象基本概念</h3><p>1）面向过程——怎么做？</p><ol><li>把完成某一个需求的所有步骤从头到尾逐步实现</li><li>根据开发需求，将某些功能独立的代码封装成一个又一个函数</li><li>最后完成的代码，就是顺序的调用不同的函数</li></ol><p>特点</p><ol><li>注重步骤与过程，不注重职责分工</li><li>如果需求复杂，代码会变得很复杂</li><li>开发复杂项目，没有固定的套路，开发难度很大</li></ol><p><img src="/python%E5%9F%BA%E7%A1%80/image-20230328132003869.png" alt="image-20230328132003869"></p><p>2）面向对象——谁来做？</p><p>相比较函数，面向对象是更大的封装，根据职责在一个对象中封装多个方法</p><ol><li>在完成某一个需求前，首先确定职责——要做的事情（方法）</li><li>根据职责确定不同的对象，在对象内部封装不同的方法（多个）</li><li>最后完成的代码，就是顺序地让不同的对象调用不同的方法</li></ol><p>特点</p><ol><li>注重对象和职责，不同的对象承担不同的职责</li><li>更加适合对复杂的需求变化，是专门应对复杂项目开发，提供的固定套路</li><li>需要在面向过程基础上，在学习一些面向对象的语法</li></ol><h1 id="类和对象"><a href="#类和对象" class="headerlink" title="类和对象"></a>类和对象</h1><p>目标</p><ul><li>类和对象的概念</li><li>类和对象的关系</li><li>类的设计</li></ul><h2 id="01-类和对象的概念"><a href="#01-类和对象的概念" class="headerlink" title="01.类和对象的概念"></a>01.类和对象的概念</h2><p>类和对象是面向对象编程的两个核心概念</p><h3 id="1-1-类"><a href="#1-1-类" class="headerlink" title="1.1 类"></a>1.1 类</h3><ul><li>类 是对一群具有相同特征或者行为的事务的一个统称，是抽象的，不能直接使用<ul><li>特征被称为属性</li><li>行为被称为方法</li></ul></li><li>类 就相当于制造飞机时的图纸，是一个模板，是负责创建对象的</li></ul><h3 id="1-2-对象"><a href="#1-2-对象" class="headerlink" title="1.2 对象"></a>1.2 对象</h3><ul><li>对象是由类创造出来的一个具体存在，可以直接使用</li><li>由 哪一个类创造出来的对象，就拥有在哪一个类中定义的<ul><li>属性</li><li>方法</li></ul></li><li>对象就相当于用图纸制造的飞机</li></ul><p>在程序开发中，应该先有类，再有对象</p><h2 id="0-2-类和对象的关系"><a href="#0-2-类和对象的关系" class="headerlink" title="0.2.类和对象的关系"></a>0.2.类和对象的关系</h2><ul><li>类是模板，对象是根据类这个模板创建出来的，应该先有类，再有对象</li><li>类只有一个，而对象可以有很多个<ul><li>不同的对象之间属性可能会各不相同</li></ul></li><li>类中定义了什么属性和方法，对象中就有什么属性和方法，不可能多也不可能少</li></ul><h2 id="03-类的设计"><a href="#03-类的设计" class="headerlink" title="03.类的设计"></a>03.类的设计</h2><p>在使用面向对象开发前，应该首先分析需求，确定一定，程序中需要包含哪些类</p><p><img src="/python%E5%9F%BA%E7%A1%80/image-20230328192440145.png" alt="image-20230328192440145"></p><p>在程序卡法中，要设计一个类，通常需要满足以下三个要素：</p><ol><li>类名 这类事物的名字，满足大驼峰命名法</li><li>属性 这类事物具有什么样的特征</li><li>方法 这类事物具有什么样的行为</li></ol><h3 id="3-1-类名的确定"><a href="#3-1-类名的确定" class="headerlink" title="3.1 类名的确定"></a><strong>3.1 类名的确定</strong></h3><p>名词提炼法分析整个业务流程，出现的名词，通常就是找到的类</p><h3 id="3-2-属性和方法的确定"><a href="#3-2-属性和方法的确定" class="headerlink" title="3.2 属性和方法的确定"></a>3.2 属性和方法的确定</h3><ul><li>对 对象的特征描述，通常可以定义成属性</li><li>对象具有的行为(动词)，通常可以定义成方法</li></ul><h1 id="面向对象基础语法"><a href="#面向对象基础语法" class="headerlink" title="面向对象基础语法"></a>面向对象基础语法</h1><p>目标</p><ul><li>dir 内置函数</li><li>定义简单的类(只包含方法)</li><li>方法中的self参数</li><li>初始化方法</li><li>内置方法和属性</li></ul><h2 id="01-dir内置函数"><a href="#01-dir内置函数" class="headerlink" title="01.dir内置函数"></a>01.dir内置函数</h2><ul><li>在Python中对象几乎是无所不在的，我们之前学习的变量、数据、函数都是对象</li></ul><p>在Python中可以使用一下两个方法验证：</p><ol><li>在标识符&#x2F;数据后输入一个  .  ，然后按下TAB键，iPython会提示该对象能够调用的方法列表</li><li>使用内置函数dir传入标识符&#x2F;数据，可以查看对象内的 所有属性及方法</li></ol><blockquote><table><thead><tr><th>序号</th><th>方法名</th><th>类型</th><th>作用</th></tr></thead><tbody><tr><td>01</td><td>双下划线+new+双下划线</td><td>方法</td><td>创建对象时，会被自动调用</td></tr><tr><td>02</td><td>双下划线+init+双下划线</td><td>方法</td><td>对象被初始化时，会被自动调用</td></tr><tr><td>03</td><td>双下划线+del+双下划线</td><td>方法</td><td>对象被从内存中销毁前，会被自动调用</td></tr><tr><td>04</td><td>双下划线+str+双下划线</td><td>方法</td><td>返回对象的描述信息，print函数输出使用</td></tr></tbody></table></blockquote><h2 id="02-定义简单的类（只包含方法）"><a href="#02-定义简单的类（只包含方法）" class="headerlink" title="02.定义简单的类（只包含方法）"></a>02.定义简单的类（只包含方法）</h2><blockquote><p>面向对象是更大的封装，在一个类中封装多个方法，这样通过这个类创建出来的对象，就可以直接调用这些方法了！</p></blockquote><h3 id="2-1-定义只包含方法的类"><a href="#2-1-定义只包含方法的类" class="headerlink" title="2.1 定义只包含方法的类"></a>2.1 定义只包含方法的类</h3><ul><li>在Python中要定义一个只包含方法的类，语法格式如下：</li></ul><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">class</span> 类名：<br><br><span class="hljs-symbol">def</span> 方法<span class="hljs-symbol">1</span>(<span class="hljs-symbol">self,</span>参数列表):<br><span class="hljs-symbol">pass</span><br><br><span class="hljs-symbol">def</span> 方法<span class="hljs-symbol">2</span>(<span class="hljs-symbol">self,</span>参数列表):<br><span class="hljs-symbol">pass</span><br></code></pre></td></tr></table></figure><ul><li>方法的定义格式和之前学习过的函数几乎一样</li><li>区别在于第一个参数必须是self。</li></ul><h3 id="2-2-创建对象"><a href="#2-2-创建对象" class="headerlink" title="2.2 创建对象"></a>2.2 创建对象</h3><ul><li>当一个类定义完成之后，要是用这个类来创建对象，语法格式如下：</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">对象变量 <span class="hljs-operator">=</span> 类名()<br></code></pre></td></tr></table></figure><h3 id="2-3-第一个面向对象程序"><a href="#2-3-第一个面向对象程序" class="headerlink" title="2.3 第一个面向对象程序"></a>2.3 第一个面向对象程序</h3><p>需求</p><ul><li>小猫爱吃鱼，小猫要喝水</li></ul><p>分析</p><ol><li>定义一个猫类Cat</li><li>定义两个方法eat和drink</li><li>按照需求——不需要定义属性</li></ol><p><img src="/python%E5%9F%BA%E7%A1%80/image-20230401103925673.png" alt="image-20230401103925673"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span>:<br><span class="hljs-string">&quot;&quot;&quot;这是一个猫类&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">eat</span>(<span class="hljs-params">self</span>):<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;小猫爱吃鱼&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">drink</span>(<span class="hljs-params">self</span>):<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;小猫在喝水&quot;</span>)<br><br>tom = Cat()<br>tom.drink()<br>tom.eat()<br><br>lazy_cat = Cat()<br>lazy_cat2 = lazy_cat<br><br><span class="hljs-built_in">print</span>(tom)<br><span class="hljs-built_in">print</span>(lazy_cat)<br><span class="hljs-built_in">print</span>(lazy_cat2)<br></code></pre></td></tr></table></figure><p><strong>引用概念的强调</strong></p><blockquote><p>在面向对象开发中，引用的概念是同样适用的！</p></blockquote><ul><li>在Python中使用类创建对象之后，tom变量中仍然记录的时对象在内存中的地址</li><li>也就是tom变量引用了新建的猫对象</li><li>使用print输出对象变量，默认情况下，是能够输出这个变量引用的对象 是 由哪一个类创建的对象，以及在内存中的地址（十六进制表示）</li></ul><blockquote><p>提示：在计算机中，通常使用十六进制 表示内存地址</p><ul><li><p>十进制 和 十六进制都是用来表达数字的，只是表示的方式不一样</p></li><li><p>十进制 和 十六进制 的数字之间可以来回转化</p></li></ul></blockquote><ul><li>%d 可以以 10进制 输出数字</li><li>%x 可以以 16进制 输出数字</li></ul><h2 id="03-方法中的self参数"><a href="#03-方法中的self参数" class="headerlink" title="03.方法中的self参数"></a>03.方法中的self参数</h2><h3 id="3-1-案列改造——给对象增加属性"><a href="#3-1-案列改造——给对象增加属性" class="headerlink" title="3.1 案列改造——给对象增加属性"></a>3.1 案列改造——给对象增加属性</h3><ul><li>在Python中，要给对象设置属性，非常的容易，但是不推荐使用<ul><li>因为：对象属性的封装应该封装在类的内部</li></ul></li><li>只需要在类的外部代码中直接通过.设置一个属性即可</li></ul><blockquote><p>ps：这种方式虽然简单，但是不推荐使用！</p></blockquote><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs abnf">tom.name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Tom&quot;</span><br>...<br><br>lazy_cat.name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;大懒猫&quot;</span><br></code></pre></td></tr></table></figure><h3 id="3-2-使用self在方法内部输出每一只猫的名字"><a href="#3-2-使用self在方法内部输出每一只猫的名字" class="headerlink" title="3.2 使用self在方法内部输出每一只猫的名字"></a>3.2 使用self在方法内部输出每一只猫的名字</h3><blockquote><p>由 哪一个对象 调用的方法，方法内的self就是 哪一个对象的引用</p></blockquote><ul><li>在类封装的方法内部，self就表示当前调用方法的对象自己</li><li>调用方法时，程序员不需要传递self参数</li><li>在方法内部<ul><li>可以通过self，访问对象的属性</li><li>也可以通过self，调用其他的对象方法</li></ul></li><li>改造代码如下：</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs css">class Cat:<br><br>def <span class="hljs-built_in">eat</span>(self):<br> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;%s 爱吃鱼&quot;</span> % self.name)<br> <br>tom = <span class="hljs-built_in">Cat</span>()<br>tom.name = <span class="hljs-string">&quot;Tom&quot;</span><br>tom.<span class="hljs-built_in">eat</span>()<br><br>lazy_cat = <span class="hljs-built_in">Cat</span>()<br>lazy_cat.name = <span class="hljs-string">&quot;大懒猫&quot;</span><br>lazy_cat.<span class="hljs-built_in">eat</span>()<br></code></pre></td></tr></table></figure><ul><li>在类的外部，通过 变量名.  访问对象的属性和方法</li><li>在 类封装的方法中，通过 self.  访问对象的属性和方法</li></ul><h2 id="04-初始化方法"><a href="#04-初始化方法" class="headerlink" title="04.初始化方法"></a>04.初始化方法</h2><h3 id="4-1-之前代码存在的问题-——-在类的外部给对象增加属性"><a href="#4-1-之前代码存在的问题-——-在类的外部给对象增加属性" class="headerlink" title="4.1 之前代码存在的问题 —— 在类的外部给对象增加属性"></a>4.1 之前代码存在的问题 —— 在类的外部给对象增加属性</h3><ul><li>将案例代码进行调整，先调用方法 在设置属性，观察一下执行效果</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">tom = <span class="hljs-built_in">Cat</span>()<br>tom<span class="hljs-selector-class">.drink</span>()<br>tom<span class="hljs-selector-class">.eat</span>()<br>tom<span class="hljs-selector-class">.name</span>() = <span class="hljs-string">&quot;Tom&quot;</span><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(tom)</span></span><br></code></pre></td></tr></table></figure><ul><li>程序执行报错如下：</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">AttributeError: <span class="hljs-string">&#x27;Cat&#x27;</span> <span class="hljs-keyword">object</span> has <span class="hljs-keyword">no</span> <span class="hljs-keyword">attribute</span> <span class="hljs-string">&#x27;name&#x27;</span><br></code></pre></td></tr></table></figure><p>提示</p><ul><li>在日常开发中，不推荐在类的外部给对象增加属性<ul><li>如果在运行时，没有找到属性，程序会报错</li></ul></li><li>对象应该包含有哪些属性，应该 封装在类的内部</li></ul><h3 id="4-2-初始化方法"><a href="#4-2-初始化方法" class="headerlink" title="4.2 初始化方法"></a>4.2 初始化方法</h3><ul><li>当使用 类名() 创建对象时，会自动执行以下操作：<ol><li>为对象在内存中分配空间——创建对象</li><li>为对象的属性设置初始值——初始化方法（__init__）</li></ol></li><li>这个初始化方法就是 __init__方法，__init__是对象的内置方法</li></ul><blockquote><p>init 方法是专门用来定义一个类 具有哪些属性的方法</p></blockquote><p>在Cat中增加init方法，验证该方法在创建对象时会被自动调用</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">class</span> <span class="hljs-symbol">Cat:</span><br><span class="hljs-symbol"></span><br><span class="hljs-symbol"> <span class="hljs-symbol">def</span></span> <span class="hljs-symbol">__init__</span>(<span class="hljs-symbol">self</span>):<br> <span class="hljs-symbol">print</span>(&quot;初始化方法&quot;)<br></code></pre></td></tr></table></figure><h3 id="4-3-在初始化方法内部定义属性"><a href="#4-3-在初始化方法内部定义属性" class="headerlink" title="4.3 在初始化方法内部定义属性"></a>4.3 在初始化方法内部定义属性</h3><ul><li>在init 方法内部使用 self.属性名 &#x3D; 属性的初始值 就可以定义属性</li><li>定义属性之后，再使用Cat类创建的对象，都会拥有该属性</li></ul><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span>:<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):<br><br>print(<span class="hljs-string">&quot;这是一个初始化方法&quot;</span>)<br><br><span class="hljs-variable language_">self</span>.name = <span class="hljs-string">&quot;Tom&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">eat</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):<br>print(<span class="hljs-string">&quot;%s 爱吃鱼&quot;</span> % <span class="hljs-variable language_">self</span>.name)<br><br>tom = Cat()<br><br>tom.eat()<br></code></pre></td></tr></table></figure><h3 id="4-4-改造初始化方法——初始化的同时设置初始值"><a href="#4-4-改造初始化方法——初始化的同时设置初始值" class="headerlink" title="4.4 改造初始化方法——初始化的同时设置初始值"></a>4.4 改造初始化方法——初始化的同时设置初始值</h3><ul><li>在开发中，如果希望在创建对象的同时，就设置对象的属性，可以对__init__方法进行改造<ol><li>把希望设置的属性值，定义成__init__方法的参数</li><li>在方法内部使用 self.属性 &#x3D; 形参 接收外部传递的参数</li><li>在创建对象时，使用 类名(属性1，属性2…) 调用</li></ol></li></ul><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span>：<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>,name</span>):<br>print(<span class="hljs-string">&quot;初始化方法 %s&quot;</span> % name)<br><span class="hljs-variable language_">self</span>.name = name<br>...<br><br>tom = Cat(<span class="hljs-string">&quot;Tom&quot;</span>)<br>...<br><br>lazy_cat = Cat(<span class="hljs-string">&quot;大懒猫&quot;</span>)<br>...<br></code></pre></td></tr></table></figure><h2 id="05-内置方法和属性"><a href="#05-内置方法和属性" class="headerlink" title="05.内置方法和属性"></a>05.内置方法和属性</h2><table><thead><tr><th>序号</th><th>方法名</th><th>类型</th><th>作用</th></tr></thead><tbody><tr><td>01</td><td>__del__</td><td>方法</td><td>对象被从内存中销毁前，会被自动调用</td></tr><tr><td>02</td><td>__str__</td><td>方法</td><td>返回对象的描述信息，print函数输出使用</td></tr></tbody></table><h3 id="5-1-del-方法"><a href="#5-1-del-方法" class="headerlink" title="5.1 __del__方法"></a>5.1 __del__方法</h3><ul><li>在Python中<ul><li>当使用 类名() 创建对象时，为对象分配完空间后，自动调用__init__方法</li><li>当一个对象被从内存中销毁前，会自动调用__del__方法</li></ul></li><li>应用场景<ul><li>__init__改造初始化方法，可以让创建对象更加灵活</li><li>__del__如果希望在对象被销毁前，再做一些事情，可以考虑一下__del__方法</li></ul></li><li>生命周期<ul><li>一个对象从调用 类名() 创建，生命周期开始</li><li>一个对象的__del__方法一旦被调用，生命周期结束</li><li>在对象的生命周期内，可以访问对象属性，或者让对象调用方法</li></ul></li></ul><h3 id="5-2-str-方法"><a href="#5-2-str-方法" class="headerlink" title="5.2 __str__方法"></a>5.2 __str__方法</h3><ul><li>在Python中，使用print输出对象变量，默认情况下，会输出这个变量引用的对象是由哪一个类创建的对象，以及在内存中的地址（十六进制表示）</li><li>如果在开发中，希望使用print输出对象时，能够打印自定义的内容，就可以利用__str__这个内置方法了</li></ul><blockquote><p>ps:__str__方法必须返回一个字符串</p></blockquote><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span>:<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, new_name</span>):<br><br><span class="hljs-variable language_">self</span>.name = new_name<br><br>print(<span class="hljs-string">&quot;%s 来了&quot;</span> % <span class="hljs-variable language_">self</span>.name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__del__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):<br><br>print(<span class="hljs-string">&quot;%s 去了&quot;</span> % <span class="hljs-variable language_">self</span>.name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;我是小猫: %s&quot;</span> % <span class="hljs-variable language_">self</span>.name<br><br>tom = Cat(<span class="hljs-string">&quot;Tom&quot;</span>)<br>print(tom)<br></code></pre></td></tr></table></figure><h1 id="面向对象封装案列"><a href="#面向对象封装案列" class="headerlink" title="面向对象封装案列"></a>面向对象封装案列</h1><p><strong>目标</strong></p><ul><li>封装</li><li>小明爱跑步</li><li>存放家具</li></ul><h2 id="01-封装"><a href="#01-封装" class="headerlink" title="01.封装"></a>01.封装</h2><ol><li>封装是面向对象编程的一大特点</li><li>面向对象编程的第一步——将属性和方法封装到一个抽象的类中</li><li>外接使用类创建对象，然后让对象调用方法</li><li>对象方法的细节，被封装在类的内部</li></ol><h2 id="02-小明爱跑步"><a href="#02-小明爱跑步" class="headerlink" title="02.小明爱跑步"></a>02.小明爱跑步</h2><p><strong>需求</strong></p><ol><li>小明体重75公斤</li><li>小明每次跑步会减肥0.5kg</li><li>小明每次吃东西体重增加1kg</li></ol><p><img src="/python%E5%9F%BA%E7%A1%80/image-20230404191843224.png" alt="image-20230404191843224"></p><h2 id="03-摆放家具"><a href="#03-摆放家具" class="headerlink" title="03.摆放家具"></a>03.摆放家具</h2><p><strong>需求</strong></p><ol><li>房子（House）有 户型、总面积 和 家具名称列表<ul><li>新房子没有任何家具</li></ul></li><li>家具（HousrItem）有名字 和占地面积<ul><li>席梦思（bed）占地4平米</li><li>衣柜（chest）占地2平米</li><li>餐桌（table）占地1.5平米</li></ul></li><li>将以上三件家具添加到房子中</li><li>打印房子时，要求输出：户型、总面积、剩余面积、家具名称列表</li></ol><p><img src="/python%E5%9F%BA%E7%A1%80/image-20230404194416886.png" alt="image-20230404194416886"></p><p><strong>剩余面积</strong></p><ol><li>在创建房子对象时，定义一个剩余面积的属性，初始值和总面积相等</li><li>当调用add_item方法，向房间添加家具时，让 剩余面积 -&#x3D; 家具面积</li></ol><p>思考：应该先开发哪一个类？</p><p>答案——家具类</p><ol><li>家具简单</li><li>房子要使用到家具，被使用的类通常应该先开发</li></ol><p><strong>小结</strong></p><ol><li>创建了一个房子类，使用到__init__ 和 __str__两个内置方法</li><li>准备了一个 add_item 方法 准备添加家具</li><li>使用房子类 创建了 一个房子对象</li><li>让房子对象调用了三次 add_item方法，将 三件家具 以实参船吊 add_item内部</li></ol><p><strong>添加家具：</strong></p><p><strong>需求</strong></p><ul><li>判断 家具的面积 是否 超过剩余面积，如果超过，提示不能添加这件家具</li><li>将 家具的名称追加到家具名称列表中</li><li>用 房子的剩余面积 - 家具面积</li></ul><h1 id="私有属性和私有方法"><a href="#私有属性和私有方法" class="headerlink" title="私有属性和私有方法"></a>私有属性和私有方法</h1><h2 id="01-应用场景及定义方式"><a href="#01-应用场景及定义方式" class="headerlink" title="01.应用场景及定义方式"></a>01.应用场景及定义方式</h2><p><strong>应用场景</strong></p><ul><li>在实际开发中，对象的某些属性或方法可能只希望在对象的内部被使用，而不希望在外部被访问到</li><li>私有属性就是对象不希望公开的属性</li><li>私有方法就是对象不希望公开的方法</li></ul><p><strong>定义方式</strong></p><ul><li>在定义属性或方法时，在属性名或者方法名前增加两个下划线，定义的就是私有属性或方法</li></ul><p><img src="/python%E5%9F%BA%E7%A1%80/image-20230407185607587.png" alt="image-20230407185607587"></p><h2 id="02-伪私有属性和私有方法（科普）"><a href="#02-伪私有属性和私有方法（科普）" class="headerlink" title="02.伪私有属性和私有方法（科普）"></a>02.伪私有属性和私有方法（科普）</h2><blockquote><p>ps：在日常开发中，不要使用这种方式，访问对象的私有属性或私有方法</p></blockquote><p>Python中，并没有真正意义的私有</p><ul><li>在给属性、方法命名时，实际是对名称做了一些特殊处理，使得外界无法访问到</li><li>处理方式：在 名称 前面加上 _类名 &#x3D;&gt; _类名__名称</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 私有属性，外部不能直接访问到</span><br><span class="hljs-built_in">print</span>(xiaofang._Women__age)<br><br><span class="hljs-comment"># 私有方法，外部不能直接调用</span><br>xiaofang._Women__secret()<br></code></pre></td></tr></table></figure><h1 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h1><p><strong>目标</strong></p><ul><li>单继承</li><li>多继承</li></ul><p><strong>面向对象三大特征</strong>：封装、继承、多态</p><h2 id="01-单继承"><a href="#01-单继承" class="headerlink" title="01.单继承"></a>01.单继承</h2><h3 id="1-1-继承的概念、语法和特点"><a href="#1-1-继承的概念、语法和特点" class="headerlink" title="1.1 继承的概念、语法和特点"></a>1.1 继承的概念、语法和特点</h3><p><strong>继承的概念</strong>：子类 拥有 父类的所有方法和属性</p><p><img src="/python%E5%9F%BA%E7%A1%80/image-20230407190504525.png" alt="image-20230407190504525"></p><p>1）<strong>继承的语法</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">class</span> 类名(父类名)：<br><br><span class="hljs-symbol">pass</span><br></code></pre></td></tr></table></figure><ul><li>子类 继承自 父类，可以直接享受 父类中已经封装好的方法，不需要再次开发</li><li>子类 中应该根据 职责，封装子类特有的属性和方法</li></ul><p>2）<strong>专业术语</strong></p><ul><li>Dog 类是 Animal 类的子类，Animal类是 Dog 类的父类，Dog 类从 Animal 类继承</li><li>Dog 类是 Animal的派生类，Animal类是Dog类的基类，Dog类从Animal类派生</li></ul><p>3）<strong>继承的传递性</strong></p><ul><li>C 类从 B类继承，B类又从A类继承</li><li>那么 C 类就具有B类和A类的所有属性和方法</li></ul><p>子类拥有父类以及父类的父类中封装的所有属性和方法</p><h3 id="1-2方法的重写"><a href="#1-2方法的重写" class="headerlink" title="1.2方法的重写"></a>1.2方法的重写</h3><ul><li>子类 拥有父类的所有方法和属性</li><li>子类 继承自父类，可以直接享受父类中硬件封装好的方法，不需要再次开发</li></ul><p><strong>应用场景</strong></p><ul><li>当 父类 的方法实现不能满足子类需求时，可以对方法进行 重写(override)</li></ul><p><img src="/python%E5%9F%BA%E7%A1%80/image-20230408104141174.png" alt="image-20230408104141174"></p><p><strong>重写</strong> 父类方法有两种情况：</p><ol><li><strong>覆盖</strong> 父类的方法</li><li>对父类方法进行 <strong>扩展</strong></li></ol><p>1）<strong>覆盖父类的方法</strong></p><ul><li>如果在开发中，父类的方法实现和子类的方法实现，完全不同</li><li>就可以使用 覆盖的方式，在子类中重新编写父类的方法实现</li></ul><blockquote><p>具体的实现方式，就相当于在子类中 定义了一个 和 父类同名的方法并且实现</p></blockquote><p>重写之后，在运行时，只会调用子类中重写的方法，而不再会调用父类封装的方法</p><p>2）<strong>对父类方法进行扩展</strong></p><ul><li>如果在开发中，子类的方法实现中包含父类方法实现<ul><li>父类原本封装的方法实现是子类方法的一部分</li></ul></li><li>就可以使用扩展的方式<ol><li>在子类中 重写父类的方法</li><li>在需要的位置使用super().父类方法 来调用父类方法的执行</li><li>代码其他的位置针对子类的需求，编写子类特有的代码实现</li></ol></li></ul><p>关于super</p><ul><li>在Python中super是一个特殊的类</li><li>super()就是使用super类创建出来的对象</li><li>最常 使用的场景就是在 重写父类方法时，调用在父类中封装的方法实现</li></ul><p><strong>调用父类方法的另外一种方式（不推荐使用）</strong></p><blockquote><p>在Python 2.x时，如果需要调用父类的方法，还可以使用以下方式</p></blockquote><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crystal">父类名.方法(<span class="hljs-keyword">self</span>)<br></code></pre></td></tr></table></figure><ul><li>这种方式，目前在Python 3.x还支持这种方式</li><li>这种方法不推荐使用，因为一旦父类发生变化，方法调用位置的类名同样需要求改</li></ul><p><strong>提示</strong></p><ul><li>在开发时，父类名 和 super()两种方式不要混用</li><li>如果使用当前子类名调用方法，会形成递归调用，出现死循环</li></ul><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Python</tag>
      
      <tag>Python基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SSM</title>
    <link href="/2022/10/21/JavaWeb+SSM+SpringBoot/SSM/"/>
    <url>/2022/10/21/JavaWeb+SSM+SpringBoot/SSM/</url>
    
    <content type="html"><![CDATA[<h1 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h1><h2 id="1、Spring是什么"><a href="#1、Spring是什么" class="headerlink" title="1、Spring是什么"></a>1、Spring是什么</h2><p>Spring是分层的Java  SE&#x2F;EE应用full-stack轻量级开源框架，以IoC(Inverse  Of  Control)和 AOP(Aspect  Oriented  Programming面向切面编程)为内核。</p><p>提供了展现层SpringMVC和持久层Spring  JDBCTemplate以及业务层事务管理等众多的企业级应用技术，还能整合开源世界众多著名的第三方框架和类库，逐渐成为使用最多的Java EE企业应用开源框架。</p><h2 id="2、Spring的发展历程"><a href="#2、Spring的发展历程" class="headerlink" title="2、Spring的发展历程"></a>2、Spring的发展历程</h2><p>略</p><h2 id="3、Spring的优势"><a href="#3、Spring的优势" class="headerlink" title="3、Spring的优势"></a>3、Spring的优势</h2><p>①方便接偶，简化开发</p><p>通过Spring提供的IoC容器，可以将对象的依赖关系交由Spring进行控制，避免硬编码所造成的过度耦合。用户也不必再为了单列模式、属性文件解析等这些很低层的需求写代码，可以更专注于上层的应用。</p><p>②AOP编程的支持</p><p>通过Spring的AOP功能，方便进行面向切面编程，许多不容易用传统OOP实现的功能可以通过AOP轻松实现。</p><p>③声明式事物的支持</p><p>可以将我们从单调烦闷的事务管理代码中解脱出来，通过声明方式灵活的进行事务管理，提高开发效率。</p><p>④方便程序的测试</p><p>可以用非容器依赖的编程方式进行几乎所有的测试工作，测试不再是昂贵的操作，而是随手可做的事情。</p><p>⑤方便集成各种优秀的框架</p><p>Spring对各种优秀框架（Struts、Hibernate、Hessian、Quartz等）的支持。</p><p>⑥降低JavaEE  API的使用难度</p><p>Spring对JavaEE  API（如JDBC、JavaMail、远程调用等）进行了薄薄的封装，使这些API的使用难度大为降低。</p><p>⑦Java源码是经典学习范例</p><p>Spring的源代码设计精妙、结构清晰、匠心独用，处处体现着大师对Java设计模式灵活运用以及对Java技术的高深造诣。它的源代码无疑是Java技术的最佳实践的范例。</p><h2 id="4、Spring的体系结构"><a href="#4、Spring的体系结构" class="headerlink" title="4、Spring的体系结构"></a>4、Spring的体系结构</h2><p><img src="/SSM/SSM/WEBRESOURCE3d63121abd7d1f5de2a13d0783ec8f5f.png"></p><p>Instrumentation（仪表）</p><h2 id="5、Spring快速入门"><a href="#5、Spring快速入门" class="headerlink" title="5、Spring快速入门"></a>5、Spring快速入门</h2><h3 id="5-1、Spring程序开发步骤"><a href="#5-1、Spring程序开发步骤" class="headerlink" title="5.1、Spring程序开发步骤"></a>5.1、Spring程序开发步骤</h3><p><img src="/SSM/SSM/WEBRESOURCE8d942c7c5823ee45b5ffa5a18f3d5f2a.png"></p><p>①使用Maven导入Spring开发的基本jar包</p><p>②编写Dao接口和实现类</p><p>③创建Spring核心配置文件</p><p>④在Spring配置文件中配置UserDaoImpl</p><p>⑤使用Spring的API获得Bean实例</p><h3 id="5-2、Spring快速入门代码实现"><a href="#5-2、Spring快速入门代码实现" class="headerlink" title="5.2、Spring快速入门代码实现"></a>5.2、Spring快速入门代码实现</h3><p>Spring的开发步骤</p><p>①导入jar包</p><p>②创建Bean</p><p>③创建applicationContext.xml</p><p>④在配置文件中进行配置</p><p>⑤创建ApplicationContext对象getBean</p><h2 id="6、Spring配置文件"><a href="#6、Spring配置文件" class="headerlink" title="6、Spring配置文件"></a>6、Spring配置文件</h2><h3 id="6-1、Bean标签的基本配置"><a href="#6-1、Bean标签的基本配置" class="headerlink" title="6.1、Bean标签的基本配置"></a>6.1、Bean标签的基本配置</h3><p>用于配置对象交由Spring来创建</p><p>默认情况下它调用的是类中的无参构造函数，如果没有无参构造函数则不能创建成功</p><p>基本属性：</p><ul><li><p>id：Bean实例在Spring容器中的唯一表示</p></li><li><p>class：Bean的全限定名称</p></li></ul><h3 id="6-2、Bean标签范围配置"><a href="#6-2、Bean标签范围配置" class="headerlink" title="6.2、Bean标签范围配置"></a>6.2、Bean标签范围配置</h3><p>scope：指对象的作用范围，取值如下：</p><p><img src="/SSM/WEBRESOURCE813ac7758ad458ec25b49d81b1bff4ea.png"></p><p>①当scope的取值为singleton时</p><p>Bean的实例化个数：1个</p><p>Bean的实例化时机：当Spring核心文件被加载时，实例化配置的Bean实例</p><p>Bean的生命周期：</p><ul><li><p>对象创建：当应用加载，创建容器时，对象就被创建了</p></li><li><p>对象运行：只要容器在，对象一直活着</p></li><li><p>对象销毁：当应用卸载，销毁容器时，对象就被销毁了</p></li></ul><p>②当scope的取值为prototype时</p><p>Bean的实例化个数：多个</p><p>Bean的实例化时机：当调用getBean()方法时实例化Bean</p><p>Bean的生命周期：</p><ul><li><p>对象创建：当使用对象时，创建新的对象实例</p></li><li><p>对象运行：只要对象在使用中，就一直或者</p></li><li><p>对象销毁：当对象长时间不用时，被Java的垃圾回收器(GC)回收了</p></li></ul><h3 id="6-3、Bean生命周期配置"><a href="#6-3、Bean生命周期配置" class="headerlink" title="6.3、Bean生命周期配置"></a>6.3、Bean生命周期配置</h3><ul><li><p>init-method：指定类中的初始化方法名称</p></li><li><p>destroy-mothod：指定类中销毁方法名称</p></li></ul><h3 id="6-4、Bean实例化三种方式"><a href="#6-4、Bean实例化三种方式" class="headerlink" title="6.4、Bean实例化三种方式"></a>6.4、Bean实例化三种方式</h3><ul><li><p>无参构造方法实例化（最常用）</p></li><li><p>工厂静态方法实例化</p></li><li><p>工厂实例方法实例化</p></li></ul><h3 id="6-5、Bean的依赖注入分析"><a href="#6-5、Bean的依赖注入分析" class="headerlink" title="6.5、Bean的依赖注入分析"></a>6.5、Bean的依赖注入分析</h3><p>目前UserService实例和UserDao实例都存在与Spring容器中，当前的做法时在容器外部获得UserService实例和UserDao实例，然后在程序中进行结合。</p><p><img src="/SSM/WEBRESOURCEf9fe0e28d90d88a4229bd9c6ffc30eb8.png"></p><p>因为UserService和UserDao都在Spring容器中，而最终程序直接使用的时UserService，所以可以在Spring容器中，将UserDao设置到UserService内部。</p><p><img src="/SSM/WEBRESOURCE32c2321410fb1800364b5f6200cd8bb4.png"></p><h3 id="6-6、Bean的依赖注入概念"><a href="#6-6、Bean的依赖注入概念" class="headerlink" title="6.6、Bean的依赖注入概念"></a>6.6、Bean的依赖注入概念</h3><p>依赖注入（Dependency Injection）：它是Spring框架核心IOC的具体实现。</p><p>在编写程序时，通过控制反转，把对象的创建交给了Spring，但是代码中不可能出现没有依赖的情况。IOC解耦只是降低他们的依赖关系，但不会消除。例如：业务层仍会调用持久层的方法。</p><p>那这种业务层和持久层的依赖关系，在使用Spring之后，就让Spring来维护了。</p><p>简单的说，就是坐等框架把持久层对象传入业务层，而不用我们自己去获取。</p><p>如何将UserDao注入到UserService内部呢？</p><ul><li><p>set方法</p></li><li><p>构造方法</p></li></ul><p>具体实现为：</p><ul><li>set方法</li></ul><p>1）set方法①</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs applescript">&lt;bean <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;userService&quot;</span> <span class="hljs-built_in">class</span>=<span class="hljs-string">&quot;com.company.SpringIoC.service.impl.UserServiceImpl&quot;</span>&gt;<br>        &lt;<span class="hljs-keyword">property</span> <span class="hljs-built_in">name</span>=<span class="hljs-string">&quot;userDao&quot;</span> <span class="hljs-keyword">ref</span>=<span class="hljs-string">&quot;userDao&quot;</span>&gt;&lt;/<span class="hljs-keyword">property</span>&gt;<br>&lt;/bean&gt;<br></code></pre></td></tr></table></figure><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@time</span>: 2022/5/26 15:12</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserDao</span> userDao;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setUserDao</span>(<span class="hljs-params">UserDao userDao</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">userDao</span> = userDao;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">save</span>(<span class="hljs-params"></span>) &#123;<br>        userDao.<span class="hljs-title function_">save</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>2）set方法②</p><p>P命名空间注入本质也是set方法注入，但比起上述的set方法注入更加方便，主要体现在配置文件中，如下：</p><p>首先，需要引入P命名空间：</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">xmlns:</span>p=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span><br></code></pre></td></tr></table></figure><p>其次，需要修改注入方式</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&lt;bean <span class="hljs-attribute">id</span>=<span class="hljs-string">&quot;userService&quot;</span> <span class="hljs-attribute">class</span>=<span class="hljs-string">&quot;com.company.SpringIoC.service.impl.UserServiceImpl&quot;</span> p:<span class="hljs-attribute">userDao-ref</span>=<span class="hljs-string">&quot;userDao&quot;</span>/&gt;<br></code></pre></td></tr></table></figure><ul><li>构造方法</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf">&lt;bean id<span class="hljs-operator">=</span><span class="hljs-string">&quot;userService&quot;</span> class<span class="hljs-operator">=</span><span class="hljs-string">&quot;com.company.SpringIoC.service.impl.UserServiceImpl&quot;</span>&gt;<br>        &lt;constructor-arg name<span class="hljs-operator">=</span><span class="hljs-string">&quot;userDao&quot;</span> ref<span class="hljs-operator">=</span><span class="hljs-string">&quot;userDao&quot;</span>&gt;&lt;/constructor-arg&gt;<br>&lt;/bean&gt;<br></code></pre></td></tr></table></figure><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@time</span>: 2022/5/26 15:12</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> UserDao userDao;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UserServiceImpl</span><span class="hljs-params">(UserDao userDao)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.userDao = userDao;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UserServiceImpl</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">save</span><span class="hljs-params">()</span> </span>&#123;<br>        userDao.save();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="6-7、Bean的依赖注入的数据类型"><a href="#6-7、Bean的依赖注入的数据类型" class="headerlink" title="6.7、Bean的依赖注入的数据类型"></a>6.7、Bean的依赖注入的数据类型</h3><p>上面的操作，都是注入的引用Bean，除了对象的引用可以注入，普通数据类型或集合都可以在容器中进行注入</p><p>注入数据的三种数据类型</p><ul><li><p>普通数据类型</p></li><li><p>引用数据类型(UserDao引用注入到UserService，就是对象引用数据类型注入，6.6已讲)</p></li><li><p>集合数据类型</p></li></ul><p>具体实现为：</p><ul><li>普通数据类型</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs abnf">&lt;bean id<span class="hljs-operator">=</span><span class="hljs-string">&quot;userDao&quot;</span> class<span class="hljs-operator">=</span><span class="hljs-string">&quot;com.company.SpringIoC.dao.impl.UserDaoImpl&quot;</span>&gt;<br>        &lt;property name<span class="hljs-operator">=</span><span class="hljs-string">&quot;age&quot;</span> value<span class="hljs-operator">=</span><span class="hljs-string">&quot;18&quot;</span>&gt;&lt;/property&gt;<br>        &lt;property name<span class="hljs-operator">=</span><span class="hljs-string">&quot;name&quot;</span> value<span class="hljs-operator">=</span><span class="hljs-string">&quot;lhg&quot;</span>&gt;&lt;/property&gt;<br>&lt;/bean&gt;<br></code></pre></td></tr></table></figure><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@time</span>: 2022/5/26 14:22</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDao</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;<br>    <span class="hljs-keyword">private</span> int age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setName</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setAge</span>(<span class="hljs-params">int age</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">save</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(name+<span class="hljs-string">&quot;===&quot;</span>+age);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>集合数据类型</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@time</span>: 2022/5/26 14:22</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDao</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt; strList;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>,<span class="hljs-title class_">User</span>&gt; userMap;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Properties</span> properties;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setStrList</span>(<span class="hljs-params">List&lt;<span class="hljs-built_in">String</span>&gt; strList</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">strList</span> = strList;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setUserMap</span>(<span class="hljs-params"><span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, User&gt; userMap</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">userMap</span> = userMap;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setProperties</span>(<span class="hljs-params">Properties properties</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">properties</span> = properties;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">save</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(strList);<br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(userMap);<br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(properties);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userService&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.company.SpringIoC.service.impl.UserServiceImpl&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;userDao&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;userDao&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userDao&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.company.SpringIoC.dao.impl.UserDaoImpl&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;strList&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>aaa<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>bbb<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>ccc<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;userMap&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;u1&quot;</span> <span class="hljs-attr">value-ref</span>=<span class="hljs-string">&quot;user1&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;u2&quot;</span> <span class="hljs-attr">value-ref</span>=<span class="hljs-string">&quot;user2&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;properties&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">props</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;p1&quot;</span>&gt;</span>111<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;p2&quot;</span>&gt;</span>222<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;p3&quot;</span>&gt;</span>333<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">props</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user1&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.company.SpringIoC.pojo.User&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;tom&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;addr&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;hunan&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user2&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.company.SpringIoC.pojo.User&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;lucy&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;addr&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;beijing&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p><img src="/SSM/WEBRESOURCE73f60dd7a65c6fabf702d4fd708eb887.png"></p><h3 id="6-8、引入其他配置文件-分模块开发"><a href="#6-8、引入其他配置文件-分模块开发" class="headerlink" title="6.8、引入其他配置文件(分模块开发)"></a>6.8、引入其他配置文件(分模块开发)</h3><p>实际开发中，Spring的配置内容非常多，这就导致Spring配置很繁杂且体积很大，所以，可以将部分配置拆解到其他配置文件中，而在Spring主配置文件通过import标签进行加载。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&lt;import <span class="hljs-attribute">resource</span>=<span class="hljs-string">&quot;applicationContext-xxx.xml&quot;</span>&gt;<br></code></pre></td></tr></table></figure><p><img src="/SSM/WEBRESOURCE2299298cb398a2e87776ae85270644fb.png"></p><p>applicationContext.xml引用applicationContext-product.xml和applicationContext-user.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;applicationContext-product.xml&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">import</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;applicationContext-user.xml&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">import</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="6-9、Spring的重点配置知识要点"><a href="#6-9、Spring的重点配置知识要点" class="headerlink" title="6.9、Spring的重点配置知识要点"></a>6.9、Spring的重点配置知识要点</h3><p><img src="/SSM/WEBRESOURCE3603690e2304b8b167a9a91cd09f8848.png"></p><h2 id="7、Spring相关API"><a href="#7、Spring相关API" class="headerlink" title="7、Spring相关API"></a>7、Spring相关API</h2><h3 id="7-1、ApplicationContext的继承体系"><a href="#7-1、ApplicationContext的继承体系" class="headerlink" title="7.1、ApplicationContext的继承体系"></a>7.1、ApplicationContext的继承体系</h3><p>Diagram</p><p><img src="/SSM/WEBRESOURCE91ca0f067d4d218d2539e29d4ee2b39d.png"></p><h3 id="7-2、ApplicationContext的实现类"><a href="#7-2、ApplicationContext的实现类" class="headerlink" title="7.2、ApplicationContext的实现类"></a>7.2、ApplicationContext的实现类</h3><p>①ClassPathXmlApplicationContext</p><p>它是从类的根路径下加载配置文件推荐使用这种</p><p>②FileSystemXmlApplicationContext</p><p>它是从磁盘路径上加载配置文件，配置文件可以在磁盘的任意位置</p><p>③AnnotationConfigApplicationContext</p><p>当使用注解配置容器对象时，需要使用此类来创建spring容器。它用来读取注解。</p><h3 id="7-3、getBean-方法的使用"><a href="#7-3、getBean-方法的使用" class="headerlink" title="7.3、getBean()方法的使用"></a>7.3、getBean()方法的使用</h3><p>主要学习使根据d获取和根据类型获取</p><p><img src="/SSM/WEBRESOURCE94d8d9867d280c63554446ba106bb360.png"></p><h2 id="8、Spring配置数据源"><a href="#8、Spring配置数据源" class="headerlink" title="8、Spring配置数据源"></a>8、Spring配置数据源</h2><h3 id="8-1、数据源（连接池）的作用"><a href="#8-1、数据源（连接池）的作用" class="headerlink" title="8.1、数据源（连接池）的作用"></a>8.1、数据源（连接池）的作用</h3><ul><li><p>数据源(连接池)是提高程序性能而出现的</p></li><li><p>事先实例化数据源，初始化部分连接资源</p></li><li><p>使用连接资源时从数据源中获取</p></li><li><p>使用完毕后将连接资源归还给数据源</p></li></ul><p>常见的数据源(连接池)：DBCP、C3P0、BoneCP、Druid等</p><h3 id="8-2、数据源的开发步骤"><a href="#8-2、数据源的开发步骤" class="headerlink" title="8.2、数据源的开发步骤"></a>8.2、数据源的开发步骤</h3><p>①导入数据源的坐标和数据库驱动坐标</p><p>②创建数据源对象</p><p>③设置数据源的基本连接数据</p><p>④使用数据源获取连接资源和归还连接资源</p><h3 id="8-3、数据源的手动创建"><a href="#8-3、数据源的手动创建" class="headerlink" title="8.3、数据源的手动创建"></a>8.3、数据源的手动创建</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.company.SpringIoC_anno;<br><br><span class="hljs-keyword">import</span> com.alibaba.druid.pool.DruidDataSource;<br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.ComboPooledDataSource;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><br><span class="hljs-keyword">import</span> java.beans.PropertyVetoException;<br><span class="hljs-keyword">import</span> java.sql.Connection;<br><span class="hljs-keyword">import</span> java.util.ResourceBundle;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@time</span>: 2022/5/27 14:12</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceTest</span> &#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-comment">//测试手动创建c3p0数据源</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ComboPooledDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComboPooledDataSource</span>();<br>        dataSource.setDriverClass(<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);<br>        dataSource.setJdbcUrl(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/javaweb&quot;</span>);<br>        dataSource.setUser(<span class="hljs-string">&quot;root&quot;</span>);<br>        dataSource.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> dataSource.getConnection();<br>        System.out.println(connection);<br>        connection.close();<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-comment">//测试手动创建druid数据源</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">DruidDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DruidDataSource</span>();<br>        dataSource.setDriverClassName(<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);<br>        dataSource.setUrl(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/javaweb&quot;</span>);<br>        dataSource.setUsername(<span class="hljs-string">&quot;root&quot;</span>);<br>        dataSource.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> dataSource.getConnection();<br>        System.out.println(connection);<br>        connection.close();<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-comment">//测试手动创建c3p0数据源(加载properties配置文件)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test3</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//读取配置文件</span><br>        <span class="hljs-type">ResourceBundle</span> <span class="hljs-variable">resourceBundle</span> <span class="hljs-operator">=</span> ResourceBundle.getBundle(<span class="hljs-string">&quot;jdbc&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">driver</span> <span class="hljs-operator">=</span> resourceBundle.getString(<span class="hljs-string">&quot;jdbc.driver&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> resourceBundle.getString(<span class="hljs-string">&quot;jdbc.url&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> resourceBundle.getString(<span class="hljs-string">&quot;jdbc.username&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> resourceBundle.getString(<span class="hljs-string">&quot;jdbc.password&quot;</span>);<br>        <span class="hljs-comment">//创建数据源对象 设置连接参数</span><br>        <span class="hljs-type">ComboPooledDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComboPooledDataSource</span>();<br>        dataSource.setDriverClass(driver);<br>        dataSource.setJdbcUrl(url);<br>        dataSource.setUser(username);<br>        dataSource.setPassword(password);<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> dataSource.getConnection();<br>        System.out.println(connection);<br>        connection.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>jdbc.properties</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">jdbc.driver</span>=com.mysql.cj.jdbc.Driver<br><span class="hljs-attr">jdbc.url</span>=jdbc:mysql://localhost:<span class="hljs-number">3306</span>/javaweb<br><span class="hljs-attr">jdbc.username</span>=root<br><span class="hljs-attr">jdbc.password</span>=<span class="hljs-number">123456</span><br></code></pre></td></tr></table></figure><h3 id="8-4、Spring配置数据源"><a href="#8-4、Spring配置数据源" class="headerlink" title="8.4、Spring配置数据源"></a>8.4、Spring配置数据源</h3><p>可以将DataSource的创建权交由Spring容器去完成</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.company.SpringIoC_anno;<br><br><span class="hljs-keyword">import</span> com.alibaba.druid.pool.DruidDataSource;<br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.ComboPooledDataSource;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><span class="hljs-keyword">import</span> java.sql.Connection;<br><span class="hljs-keyword">import</span> java.util.ResourceBundle;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@time</span>: 2022/5/27 14:12</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceTest</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-comment">//测试Spring容器产生数据源对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test4</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;applicationContext.xml&quot;</span>);<br>        <span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> applicationContext.getBean(DataSource.class);<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> dataSource.getConnection();<br>        System.out.println(connection);<br>        connection.close();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>applicationContext.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driverClass&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;jdbcUrl&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/javaweb&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;root&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;123456&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="8-5、抽取jdbc配置文件"><a href="#8-5、抽取jdbc配置文件" class="headerlink" title="8.5、抽取jdbc配置文件"></a>8.5、抽取jdbc配置文件</h3><p>applicationContext.xml加载jdbc.properties配置文件获得连接信息（Spring容器加载properties文件）</p><p>首先，需要引入context命名控件和约束路径：</p><ul><li><p>命名空间：xmlns:context&#x3D;”<a href="http://www.springframework.org/schema/context&quot;">http://www.springframework.org/schema/context&quot;</a></p></li><li><p>约束路径：<a href="http://www.springframework.org/schema/context">http://www.springframework.org/schema/context</a></p><p><a href="http://www.springframework.org/schema/context/spring-context.xsd">http://www.springframework.org/schema/context/spring-context.xsd</a></p></li></ul><p>再将外部properties文件使用context:property-placeholder标签加载到applicationContext.xml中来。</p><p>最后使用EL表达式调用对应值</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="hljs-string"><span class="hljs-tag"><span class="language-xml">                            http://www.springframework.org/schema/contxt http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="language-xml">    </span><br><span class="language-xml"><span class="hljs-comment">&lt;!--加载外部的properties文件--&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;classpath:jdbc.properties&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">context:property-placeholder</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driverClass&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$</span></span></span><span class="hljs-template-variable">&#123;jdbc.driver&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;jdbcUrl&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$</span></span></span><span class="hljs-template-variable">&#123;jdbc.url&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$</span></span></span><span class="hljs-template-variable">&#123;jdbc.username&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$</span></span></span><span class="hljs-template-variable">&#123;jdbc.password&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span></span><br></code></pre></td></tr></table></figure><h2 id="9、Spring注解开发"><a href="#9、Spring注解开发" class="headerlink" title="9、Spring注解开发"></a>9、Spring注解开发</h2><h3 id="9-1、Spring原始注解"><a href="#9-1、Spring原始注解" class="headerlink" title="9.1、Spring原始注解"></a>9.1、Spring原始注解</h3><p>Spring是轻代码而重配置的框架，配置比较繁重，影响开发效率，所以注解开发是一种趋势，注解代替xml配置文件可以简化配置，提高开发效率。</p><p>Spring原始注解主要是替代<Bean>的配置</p><table><thead><tr><th>注解</th><th>说明</th></tr></thead><tbody><tr><td>@Component</td><td>使用在类上用于实例化Bean</td></tr><tr><td>@Controller</td><td>使用在web层类上用于实例化Bean</td></tr><tr><td>@Service</td><td>使用在service层类上用于实例化Bean</td></tr><tr><td>@Repository</td><td>使用在dao层类上用于实例化Bean</td></tr><tr><td>@Autowired</td><td>使用在字段上用于根据类型依赖注入</td></tr><tr><td>@Qualifier</td><td>结合@Autowired一起使用用于根据名称进行依赖注入</td></tr><tr><td>@Resource</td><td>相当于@Autowired+@Qualifier，按照名称进行注入</td></tr><tr><td>@Value</td><td>注入普通属性</td></tr><tr><td>@Scope</td><td>标注Bean的作用范围</td></tr><tr><td>@PostConstruct</td><td>使用在方法上标注该方法是Bean的初始化方法</td></tr><tr><td>@PreDestroy</td><td>使用在方法上标注该方法时Bean的销毁方法</td></tr></tbody></table><p>在使用注解开发时，需要使用在applicationContext.xml中配置组件扫描。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">&quot;</span>&gt;</span><br><span class="hljs-comment">&lt;!--配置组件扫描--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">&quot;com.company.SpringIoC_anno&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">context:component-scan</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="9-2、Spring新注解"><a href="#9-2、Spring新注解" class="headerlink" title="9.2、Spring新注解"></a>9.2、Spring新注解</h3><p>使用上面的注解还不能全部代替xml配置文件，还需要使用注解替代的配置如下：</p><ul><li><p>非自定义的Bean的配置：<bean></p></li><li><p>加载properties文件的配置：<a href="context:property-placeholder">context:property-placeholder</a></p></li><li><p>组件扫描的配置：<a href="context:component-scan">context:component-scan</a></p></li><li><p>引入其他文件：<import></p></li></ul><table><thead><tr><th>注解</th><th>说明</th></tr></thead><tbody><tr><td>@Configuration</td><td>用于指定当前类是一个Spring配置类，当前创建容器时会从该类上加载注解</td></tr><tr><td>@ComponentScan</td><td>用于指定Spring在初始化容器时要扫描的包。<br>作用和在Spring的xml配置文件中的&lt;context:component-scan base-package&#x3D;”com.company.SpringIoC_anno”&#x2F;&gt;一样</td></tr><tr><td>@Bean</td><td>使用在方法上，标注将该方法的返回值存储Spring容器中</td></tr><tr><td>@PropertySource</td><td>用于加载properties文件中的配置</td></tr><tr><td>@Import</td><td>用于导入其他配置类</td></tr></tbody></table><h2 id="10、Srping集成Junit"><a href="#10、Srping集成Junit" class="headerlink" title="10、Srping集成Junit"></a>10、Srping集成Junit</h2><p>①导入spring继承Junit的坐标</p><p>②使用@Runwith直接替换原来的运行周期</p><p>③使用@ContextConfiguration指定配置文件或配置类</p><p>④使用@Autowired注入需要测试的对象</p><p>⑤创建测试方法进行测试</p><h2 id="11、Spring集成web环境"><a href="#11、Spring集成web环境" class="headerlink" title="11、Spring集成web环境"></a>11、Spring集成web环境</h2><h3 id="11-1、ApplicationContext应用上下文获取方式"><a href="#11-1、ApplicationContext应用上下文获取方式" class="headerlink" title="11.1、ApplicationContext应用上下文获取方式"></a>11.1、ApplicationContext应用上下文获取方式</h3><p>应用上下文对象是通过new ClasspathXmlApplicationContext(spring配置文件)方式获取的，但是每次从容其中获得Bean时都要编写new ClasspathXmlApplicationContext(spring配置文件)，这样的弊端是配置文件加载多次，应用上下文对象创建多次。</p><p>在Web项目中，可以使用ServletContextListener监听Web应用的启动，我们可以在Web应用启动时，就加载Spring的配置文件，创建应用上下文对象ApplicationContext，再将其存储到最大的域servletContext域中，这样就可以在任意位置从余种获得应用上下文ApplicationContext对象了。</p><h3 id="11-2、Spring提供给获取应用上下文的工具"><a href="#11-2、Spring提供给获取应用上下文的工具" class="headerlink" title="11.2、Spring提供给获取应用上下文的工具"></a>11.2、Spring提供给获取应用上下文的工具</h3><p>上面的分析不用手动实现，Spring提供了一个监听器ContextLoaderListener就是对上述功能的封装，该监听器内部加载Spring配置文件，创建应用上下文对象，并存储到ServletContext域中，提供了一个客户端工具WebApplicationContextUtils供使用者获得应用上下文对象。</p><p>所以我们需要做的只有两件事：</p><p>①在web.xml中配置ContextLoaderListener监听器(导入spring-web坐标)</p><p>②使用WebApplicationContextUtils获得应用上下文对象ApplicationContext</p><h1 id="Spring的AOP简介"><a href="#Spring的AOP简介" class="headerlink" title="Spring的AOP简介"></a>Spring的AOP简介</h1><h2 id="1-1、什么是AOP"><a href="#1-1、什么是AOP" class="headerlink" title="1.1、什么是AOP"></a>1.1、什么是AOP</h2><p>AOP为Aspect Oriented Programming的缩写，意思为面向切面编程，是通过预编译方式和运行期动态代理实现程序功能的统一维护的一种技术。</p><p>AOP时OOP的延续，是软件开发中的一个热点，也是Spring框架中的一个重要内容，是函数时变成的一种衍生泛型。利用AOP可以对业务逻辑的各个部分进行隔离，从而使得业务逻辑各部分之间的耦合度降低，提高程序的可重用性，同时提高了开发的效率。</p><h2 id="1-2、AOP的作用及其优势"><a href="#1-2、AOP的作用及其优势" class="headerlink" title="1.2、AOP的作用及其优势"></a>1.2、AOP的作用及其优势</h2><ul><li><p>作用：在程序运行期间，在不修改源码的情况下对方法进习性功能增强</p></li><li><p>优势：减少重复代码，提高开发效率，并且便于维护</p></li></ul><h2 id="1-3、AOP的底层实现"><a href="#1-3、AOP的底层实现" class="headerlink" title="1.3、AOP的底层实现"></a>1.3、AOP的底层实现</h2><p>实际上，AOP的底层是通过Spring提供的动态代理技术实现的。在运行期间，Spring通过动态代理技术动态的生成代理对象，代理对象方法执行时进行增强功能的接入，在去调用目标对象的方法，从而完成功能的增强。</p><h2 id="1-4、AOP的动态代理技术"><a href="#1-4、AOP的动态代理技术" class="headerlink" title="1.4、AOP的动态代理技术"></a>1.4、AOP的动态代理技术</h2><p>常用的动态代理技术：</p><ul><li><p>JDK代理：基于接口的动态代理技术</p></li><li><p>cglib代理：基于父类的动态代理技术</p></li></ul><p><img src="/SSM/WEBRESOURCE3f15acacc6173069d50651dd296117f8.png"></p><h2 id="1-5、基于JDK的动态代理"><a href="#1-5、基于JDK的动态代理" class="headerlink" title="1.5、基于JDK的动态代理"></a>1.5、基于JDK的动态代理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.company.Spring_aop;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyTest</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">//目标对象</span><br>        <span class="hljs-type">Target</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Target</span>();<br><br>        <span class="hljs-comment">//增强对象</span><br>        <span class="hljs-type">Advice</span> <span class="hljs-variable">advice</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Advice</span>();<br>        <span class="hljs-comment">//返回值就是动态生成的代理对象</span><br>        <span class="hljs-type">TargetInterface</span> <span class="hljs-variable">targetInterface</span> <span class="hljs-operator">=</span> (TargetInterface) Proxy.newProxyInstance(<br>                target.getClass().getClassLoader(), <span class="hljs-comment">//目标对象类加载器</span><br>                target.getClass().getInterfaces(),<span class="hljs-comment">//目标对象相同的接口字节码对象数组</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvocationHandler</span>() &#123;<br>                    <span class="hljs-comment">//调用代理对象的任何方法 实质执行的都是invoke方法</span><br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>                        advice.before();<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">invoke</span> <span class="hljs-operator">=</span> method.invoke(target, args);<span class="hljs-comment">//执行目标方法</span><br>                        advice.afterReturning();<br>                        <span class="hljs-keyword">return</span> invoke;<br>                    &#125;<br>                &#125;<br>        );<br>        <span class="hljs-comment">//调用代理对象的方法</span><br>        targetInterface.save();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="1-6、基于cglib的动态代理"><a href="#1-6、基于cglib的动态代理" class="headerlink" title="1.6、基于cglib的动态代理"></a>1.6、基于cglib的动态代理</h2><p>难度过高、暂略。</p><p><a href="https://www.bilibili.com/video/BV1WZ4y1P7Bp?p=125&amp;spm_id_from=pageDriver&amp;vd_source=e3b8237315186129c5794d1094b57c6a">https://www.bilibili.com/video/BV1WZ4y1P7Bp?p=125&amp;spm_id_from=pageDriver&amp;vd_source=e3b8237315186129c5794d1094b57c6a</a></p><h2 id="1-7、AOP相关概念"><a href="#1-7、AOP相关概念" class="headerlink" title="1.7、AOP相关概念"></a>1.7、AOP相关概念</h2><p>Spring的AOP是新鲜底层就是对上面的动态代理的代码进行了封装，封装后我们只需要对需要关注的部分进行代码编写，并通过配置的方式完成指定目标的方法增强。</p><p>在正式讲解AOP的操作之前，我们必须理解AOP的相关术语，常用的术语如下：</p><ul><li><p>Target(目标对象)：代理的目标对象</p></li><li><p>Proxy(代理)：一个类被AOP织入增强后，就产生一个结果代理类</p></li><li><p>JoinPoint(连接点)：所谓连接点是指那些被拦截到的点。在Spring中这些点指的是方法，因为Spring支支持方法类型的连接点</p></li><li><p>Pointcut(切入点)：所谓切入点是指我们要对哪些Joinpoint进行拦截的定义</p></li><li><p>Advice(通知&#x2F;增强)：所谓通知是指拦截到Joinpoint之后所要做的事情就是通知</p></li><li><p>Aspect(切面)：是切入点和通知(引介)的结合</p></li><li><p>Weaving(织入)：是指把增强应用到目标对象来创建新的代理对象的过程。Spring采用动态代理织入，而AspectJ采用编译期织入和类装载器织入。</p></li></ul><h2 id="1-8、AOP开发的明确的事项"><a href="#1-8、AOP开发的明确的事项" class="headerlink" title="1.8、AOP开发的明确的事项"></a>1.8、AOP开发的明确的事项</h2><p>需要编写的内容</p><ul><li><p>编写核心业务代码（目标类的目标方法）</p></li><li><p>编写切面类，切面类中有通知（增强功能方法）</p></li><li><p>在配置文件中，配置织入关系，即将哪些通知与哪些连接点进行结合</p></li></ul><p>AOP底层使用哪种代理方式</p><p>在spring中，框架会根据目标是否实现了接口来决定采用哪种动态代理的方式。</p><p>目标对象有接口就会使用JDK的那种。</p><p>否则使用cglib那种。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:aop</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/aop&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/aop</span></span><br><span class="hljs-string"><span class="hljs-tag">      http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--目标对象    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;targetImpl&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.company.Test3.Service.TargetImpl&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--切面对象    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;targetAspect&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.company.Test3.Service.TargetAspect&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--配置织入： 告诉spring框架 哪些方法(切点)需要进行哪些增强(前置、后置)....    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">aop:config</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 切点表达式的抽取--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">aop:pointcut</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;pointcut&quot;</span> <span class="hljs-attr">expression</span>=<span class="hljs-string">&quot;execution(public void com.company.Test3.Service.TargetImpl.save())&quot;</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!--声明切面    --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">aop:aspect</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;targetAspect&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--切面：切点+通知    --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">aop:before</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;before&quot;</span> <span class="hljs-attr">pointcut-ref</span>=<span class="hljs-string">&quot;pointcut&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">aop:before</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">aop:after-returning</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;afterReturning&quot;</span> <span class="hljs-attr">pointcut-ref</span>=<span class="hljs-string">&quot;pointcut&quot;</span> <span class="hljs-attr">returning</span>=<span class="hljs-string">&quot;result&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">aop:after-returning</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">aop:aspect</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">aop:config</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2-1、XML配置AOP详解"><a href="#2-1、XML配置AOP详解" class="headerlink" title="2.1、XML配置AOP详解"></a>2.1、XML配置AOP详解</h2><p><img src="/SSM/WEBRESOURCE3cef0f6841539dee533856a3b79d5e83.png"></p><p><img src="/SSM/WEBRESOURCE48f073c93a1e6d842e1ab1836f35f91c.png"></p><p><img src="/SSM/WEBRESOURCEee1ada72ad976ebccbf4a5de7683208a.png"></p><h2 id="3-1、基于注解的AOP开发"><a href="#3-1、基于注解的AOP开发" class="headerlink" title="3.1、基于注解的AOP开发"></a>3.1、基于注解的AOP开发</h2><h1 id="SpringMVC"><a href="#SpringMVC" class="headerlink" title="SpringMVC"></a>SpringMVC</h1><h2 id="1、SpringMVC简介"><a href="#1、SpringMVC简介" class="headerlink" title="1、SpringMVC简介"></a>1、SpringMVC简介</h2><h3 id="1-1、SpringMVC概述"><a href="#1-1、SpringMVC概述" class="headerlink" title="1.1、SpringMVC概述"></a>1.1、SpringMVC概述</h3><p>SpringMVC是一种基于Java的实现MVC设计模型的请求驱动类型的轻量级Web框架，属于SpringFrameWork的后续产品，已经融合在Spring Web Flow中</p><p>SpringMVC已经称为目前最主流的MVC框架之一，并且随着Spring3.0的发布，全面超越Struts2，称为最优秀的MVC框架。它通过一套注解，让一个简单的Java类成为处理请求的控制器，而无需实现任何接口。同时它还支持RESTful编程风格的请求。</p><h3 id="1-2、SpringMVC快速入门"><a href="#1-2、SpringMVC快速入门" class="headerlink" title="1.2、SpringMVC快速入门"></a>1.2、SpringMVC快速入门</h3><p><img src="/SSM/WEBRESOURCE2a48a9d4bb83e804bac3fd07d7bd6073.png"></p><p>需求：客户端发起请求，服务器端接受请求，执行逻辑并进行试图跳转。</p><p>开发步骤：</p><p>①导入SpringMVC相关坐标</p><p>②配置SpringMVC核心控制器DispathcerServlet</p><p>③创建Controller类和视图页面</p><p>④使用注解配置Controller类中业务方法的映射地址</p><p>⑤配置SpringMVC核心文件spring-mvc.xml</p><p>⑥客户端发起请求测试</p><h3 id="1-3、SpringMVC流程图"><a href="#1-3、SpringMVC流程图" class="headerlink" title="1.3、SpringMVC流程图"></a>1.3、SpringMVC流程图</h3><p><img src="/SSM/WEBRESOURCE60ee809af5b78762fdae7725f18e02f5.png"></p><h2 id="2、SpringMVC组件解析"><a href="#2、SpringMVC组件解析" class="headerlink" title="2、SpringMVC组件解析"></a>2、SpringMVC组件解析</h2><h3 id="2-1、SpringMVC的执行流程"><a href="#2-1、SpringMVC的执行流程" class="headerlink" title="2.1、SpringMVC的执行流程"></a>2.1、SpringMVC的执行流程</h3><p><img src="/SSM/WEBRESOURCE25f679777ede905bb9cd702e917de75f.png"></p><p>①用户发送请求至前端控制器DispatcherServlet。</p><p>②DispatcherServlet收到请求调用HandlerMapping处理器映射器。</p><p>③处理器映射器找到具体的处理器(可以根据xml配置、注解进行查找)，生成处理器对象处理器拦截器(如果有则生成)一并返回给DispatcherServlet</p><p>④DispatcherServlet调用HandlerAdapter处理器适配器</p><p>⑤HandlerAdapter经过适配调用具体的处理器(Controller,也叫后端控制器)。</p><p>⑥Controller执行完成返回ModelAndView。</p><p>⑦HandlerAdapter将controller执行结果ModelAndView返回给DispatcherServlet。</p><p>⑧DispatcherServlet将ModelAndView传给ViewReslover视图解析器。</p><p>⑨ViewReslover解析后返回具体View。</p><p>⑩DispatcherServlet根据View进行渲染视图(即将模型数据填充至视图中)DispatcherServlet响应用户。</p><h3 id="2-2、SpringMVC注解解析"><a href="#2-2、SpringMVC注解解析" class="headerlink" title="2.2、SpringMVC注解解析"></a>2.2、SpringMVC注解解析</h3><p>@RequestMapping</p><p>作用：请求映射，主要是用于建立请求URL和处理请求方法之间的对应关系。</p><p>位置：</p><ul><li><p>类上：请求URL的第一级访问目录。此处不写的话，就相当于应用的根目录</p></li><li><p>方法上：请求URL的第二级访问目录，与类上的使用@ReqquestMapping标注的一级目录一起组成访问虚拟路径。</p></li></ul><p>属性：</p><ul><li><p>value：用于指定请求的URL。它和paht属性的作用是一样的</p></li><li><p>method：用于指定请求的方式</p></li><li><p>params：用于指定限制请求参数的条件。它支持简单的表达式。要求请求参数的key和value必须和配置的一摸一样。</p></li></ul><h3 id="2-3、知识要点"><a href="#2-3、知识要点" class="headerlink" title="2.3、知识要点"></a>2.3、知识要点</h3><p><img src="/SSM/WEBRESOURCE83f302b30935f8c9804b21aa072cbb88.png"></p><h2 id="3、SpringMVC的数据响应"><a href="#3、SpringMVC的数据响应" class="headerlink" title="3、SpringMVC的数据响应"></a>3、SpringMVC的数据响应</h2><h3 id="3-1、SpringMVC的数据相应方式"><a href="#3-1、SpringMVC的数据相应方式" class="headerlink" title="3.1、SpringMVC的数据相应方式"></a>3.1、SpringMVC的数据相应方式</h3><p><img src="/SSM/WEBRESOURCEb84a6abf71eaf072ccccba135acd7514.png"></p><ul><li><p>使用map</p></li><li><p>使用ModelAndView</p></li><li><p>使用req.setAttribute</p></li></ul><h2 id="4、SpringMVC的请求"><a href="#4、SpringMVC的请求" class="headerlink" title="4、SpringMVC的请求"></a>4、SpringMVC的请求</h2><h3 id="4-1、获得请求参数"><a href="#4-1、获得请求参数" class="headerlink" title="4.1、获得请求参数"></a>4.1、获得请求参数</h3><p>格式：?name&#x3D;value&amp;name&#x3D;value</p><p>服务器端要获得请求的参数，有时还需要进行数据的封装，SpringMVC可以接受如下类型的参数：</p><ul><li><p>基本类型参数</p></li><li><p>POJO类型参数</p></li><li><p>数组类型参数</p></li><li><p>集合类型参数</p></li></ul><p>Controller中的业务方法的参数名称要与请求参数的name一致，参数值会自动映射匹配。</p><h1 id="MyBatis"><a href="#MyBatis" class="headerlink" title="MyBatis"></a>MyBatis</h1><h2 id="1、Mybatis简介"><a href="#1、Mybatis简介" class="headerlink" title="1、Mybatis简介"></a>1、Mybatis简介</h2><p><img src="/SSM/WEBRESOURCE09193dd79b01d0115816d5418822641e.png"></p><p><img src="/SSM/WEBRESOURCE15a49bbb138e9222fef82bcbd77d1b4d.png"></p><h3 id="1-2、原始jdbc操作的分析"><a href="#1-2、原始jdbc操作的分析" class="headerlink" title="1.2、原始jdbc操作的分析"></a>1.2、原始jdbc操作的分析</h3><p>原始jdbc开发存在的问题如下：</p><p>①数据库连接创建、释放频繁造成系统资源浪费从而影响系统性能。</p><p>②sql语句在代码中硬编码，造成代码不宜维护，实际应用sql变化的可能比较大，sql变动需要改变java代码。</p><p>③查询操作时，需要手动将结果集中的数据手动封装到实体中。插入操作时，需要手动将实体的数据设置到sql语句的占位符位置</p><p>应对上述问题给出的解决方案：</p><p>①使用数据库连接池初始化连接资源</p><p>②将sql语句抽取到xml配置文件中</p><p>③使用反射、内省等底层技术，自动将实体与表进行属性与字段的自动映射</p><h3 id="1-3、什么是Mybatis"><a href="#1-3、什么是Mybatis" class="headerlink" title="1.3、什么是Mybatis"></a>1.3、什么是Mybatis</h3><ul><li><p>mybatis是一个优秀的基于java的持久层框架，它内部封装了jdbc，使开发者只需要关注sql语句本身，而不需要花费精力去处理加载驱动、创建链接、创建statement等繁杂的过程</p></li><li><p>mybatis通过xml或注解的方式将要执行的各种statement配置起来，并通过java对象和statement中sql的动态参数进行映射生成最终执行的sql语句</p></li><li><p>最后mybatis框架执行sql并将结果映射为java对象并返回，采用ORM思想解决了实体和数据库映射的我呢提，对jdbc进行了封装，屏蔽了jdbc api底层访问细节，是我们不用与jdbc api打交道，就可以完成对数据库的持久化操作。</p></li></ul><h2 id="2、Mybatis的快速入门"><a href="#2、Mybatis的快速入门" class="headerlink" title="2、Mybatis的快速入门"></a>2、Mybatis的快速入门</h2><p>MyBatis官网地址：<a href="https://mybatis.org/mybatis-3/">https://mybatis.org/mybatis-3/</a></p><h3 id="2-1、MyBatis开发步骤"><a href="#2-1、MyBatis开发步骤" class="headerlink" title="2.1、MyBatis开发步骤"></a>2.1、MyBatis开发步骤</h3><p>①添加MyBatis的坐标</p><p>②创建user数据表</p><p>③编写User实体类</p><p>④编写映射文件UserMapper.xml</p><p>⑤编写核心文件SqlMapConfig.xml</p><p>⑥编写测试类</p><p>ps:④UserMapper.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;userMapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findAll&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.company.MyBatis_quick.Pojo.User&quot;</span>&gt;</span><br>        select * from user<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ps:⑤SqlMapConfig.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">configuration</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--数据源环境    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">environments</span> <span class="hljs-attr">default</span>=<span class="hljs-string">&quot;development&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">environment</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;development&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">transactionManager</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;JDBC&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">transactionManager</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;POOLED&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driver&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test?useSSL=false<span class="hljs-symbol">&amp;amp;</span>useUnicode=true<span class="hljs-symbol">&amp;amp;</span>characterEncoding=UTF-8<span class="hljs-symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;root&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;123456&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">environments</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--加载映射文件    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;com/company/mapper/UserMapper.xml&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ps:⑥测试类</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//获取核心配置文件</span><br>InputStream resourceAsStream = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Resources</span>.</span></span>get<span class="hljs-constructor">ResourceAsStream(<span class="hljs-string">&quot;SqlMapConfig.xml&quot;</span>)</span>;<br><span class="hljs-comment">//获取session工厂对象</span><br>SqlSessionFactory sqlSessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-constructor">SqlSessionFactoryBuilder()</span>.build(resourceAsStream);<br><span class="hljs-comment">//获得session会话对象</span><br>SqlSession sqlSession = sqlSessionFactory.<span class="hljs-keyword">open</span><span class="hljs-constructor">Session()</span>;<br><span class="hljs-comment">//执行操作 参数：namespace+id</span><br>List&lt;User&gt; userList = sqlSession.select<span class="hljs-constructor">List(<span class="hljs-string">&quot;userMapper.findAll&quot;</span>)</span>;<br><span class="hljs-comment">//打印数据</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(userList);<br><span class="hljs-comment">//释放资源</span><br>sqlSession.close<span class="hljs-literal">()</span>;<br></code></pre></td></tr></table></figure><h2 id="3、Mybatis映射文件概述"><a href="#3、Mybatis映射文件概述" class="headerlink" title="3、Mybatis映射文件概述"></a>3、Mybatis映射文件概述</h2><p><img src="/SSM/WEBRESOURCE1c4f8ffcac86042e493f22ffc2deae08.png"></p><h2 id="4、Mybatis的增删改查"><a href="#4、Mybatis的增删改查" class="headerlink" title="4、Mybatis的增删改查"></a>4、Mybatis的增删改查</h2><h3 id="4-1、MyBatis的插入数据操作"><a href="#4-1、MyBatis的插入数据操作" class="headerlink" title="4.1、MyBatis的插入数据操作"></a>4.1、MyBatis的插入数据操作</h3><h4 id="4-1-1、插入操作需要注意的问题："><a href="#4-1-1、插入操作需要注意的问题：" class="headerlink" title="4.1.1、插入操作需要注意的问题："></a>4.1.1、插入操作需要注意的问题：</h4><ul><li><p>插入语句使用insert标签</p></li><li><p>在映射文件中使用parameterType属性指定要插入的数据类型</p></li><li><p>Sql语句中使用#{实体属性名}方式引用实体中的属性值</p></li><li><p>插入操作使用的API是sqlSession.insert(“命名空间.id”，实体对象);</p></li><li><p>插入操作设计数据库数据变化，需要使用sqlSession对象进行事务提交，即sqlSession.commit();</p></li></ul><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-comment">&lt;!--插入操作    --&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;save&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.company.MyBatis_quick.Pojo.User&quot;</span>&gt;</span></span><br><span class="language-xml">    insert into user (id, username, password)values(#</span><span class="hljs-template-variable">&#123;id&#125;</span><span class="language-xml">,#</span><span class="hljs-template-variable">&#123;username&#125;</span><span class="language-xml">,#</span><span class="hljs-template-variable">&#123;password&#125;</span><span class="language-xml">)</span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span></span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user.setUsername(<span class="hljs-string">&quot;小羊&quot;</span>);<br>    user.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>    <span class="hljs-comment">//获取核心配置文件</span><br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">resourceAsStream</span> <span class="hljs-operator">=</span> Resources.getResourceAsStream(<span class="hljs-string">&quot;SqlMapConfig.xml&quot;</span>);<br>    <span class="hljs-comment">//获取session工厂对象</span><br>    <span class="hljs-type">SqlSessionFactory</span> <span class="hljs-variable">sqlSessionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(resourceAsStream);<br>    <span class="hljs-comment">//获得session会话对象</span><br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();<br>    <span class="hljs-comment">//执行操作</span><br>    sqlSession.insert(<span class="hljs-string">&quot;userMapper.save&quot;</span>,user);<br>    <span class="hljs-comment">//mybatis执行更新操作需要提交事务</span><br>    sqlSession.commit();<br>    <span class="hljs-comment">//释放资源</span><br>    sqlSession.close();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="4-1-2、修改操作需要注意的问题："><a href="#4-1-2、修改操作需要注意的问题：" class="headerlink" title="4.1.2、修改操作需要注意的问题："></a>4.1.2、修改操作需要注意的问题：</h4><ul><li><p>修改语句使用insert标签</p></li><li><p>在映射文件中使用parameterType属性指定要修改的数据类型</p></li><li><p>Sql语句中使用#{实体属性名}方式引用实体中的属性值</p></li><li><p>修改操作使用的API是sqlSession.update(“命名空间.id”，实体对象);</p></li><li><p>修改操作设计数据库数据变化，需要使用sqlSession对象进行事务提交，即sqlSession.commit();</p></li></ul><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-comment">&lt;!--修改操作    --&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;update&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.company.MyBatis_quick.Pojo.User&quot;</span>&gt;</span></span><br><span class="language-xml">    update user set username = #</span><span class="hljs-template-variable">&#123;username&#125;</span><span class="language-xml">,password = #</span><span class="hljs-template-variable">&#123;password&#125;</span><span class="language-xml"> where id = #</span><span class="hljs-template-variable">&#123;id&#125;</span><span class="language-xml">;</span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span></span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test3</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user.setUsername(<span class="hljs-string">&quot;小绵羊&quot;</span>);<br>    user.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>    user.setId(<span class="hljs-number">4</span>);<br>    <span class="hljs-comment">//获取核心配置文件</span><br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">resourceAsStream</span> <span class="hljs-operator">=</span> Resources.getResourceAsStream(<span class="hljs-string">&quot;SqlMapConfig.xml&quot;</span>);<br>    <span class="hljs-comment">//获取session工厂对象</span><br>    <span class="hljs-type">SqlSessionFactory</span> <span class="hljs-variable">sqlSessionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(resourceAsStream);<br>    <span class="hljs-comment">//获得session会话对象</span><br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();<br>    <span class="hljs-comment">//执行操作</span><br>    sqlSession.update(<span class="hljs-string">&quot;userMapper.update&quot;</span>,user);<br>    <span class="hljs-comment">//mybatis执行更新操作需要提交事务</span><br>    sqlSession.commit();<br>    <span class="hljs-comment">//释放资源</span><br>    sqlSession.close();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="4-1-3、删除操作需要注意的问题："><a href="#4-1-3、删除操作需要注意的问题：" class="headerlink" title="4.1.3、删除操作需要注意的问题："></a>4.1.3、删除操作需要注意的问题：</h4><ul><li><p>删除语句使用insert标签</p></li><li><p>在映射文件中使用parameterType属性指定要删除的数据类型</p></li><li><p>Sql语句中使用#{实体属性名}方式引用实体中的属性值</p></li><li><p>删除操作使用的API是sqlSession.delete(“命名空间.id”，实体对象);</p></li><li><p>删除操作设计数据库数据变化，需要使用sqlSession对象进行事务提交，即sqlSession.commit();</p></li></ul><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-comment">&lt;!--删除操作    --&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;delete&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="language-xml">    delete from user where id=#</span><span class="hljs-template-variable">&#123;id&#125;</span><span class="language-xml">;</span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span></span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test4</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br>    <span class="hljs-comment">//获取核心配置文件</span><br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">resourceAsStream</span> <span class="hljs-operator">=</span> Resources.getResourceAsStream(<span class="hljs-string">&quot;SqlMapConfig.xml&quot;</span>);<br>    <span class="hljs-comment">//获取session工厂对象</span><br>    <span class="hljs-type">SqlSessionFactory</span> <span class="hljs-variable">sqlSessionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(resourceAsStream);<br>    <span class="hljs-comment">//获得session会话对象</span><br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();<br>    <span class="hljs-comment">//执行操作</span><br>    sqlSession.delete(<span class="hljs-string">&quot;userMapper.delete&quot;</span>,id);<br>    <span class="hljs-comment">//mybatis执行删除操作需要提交事务</span><br>    sqlSession.commit();<br>    <span class="hljs-comment">//释放资源</span><br>    sqlSession.close();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5、Mybatis核心配置文件"><a href="#5、Mybatis核心配置文件" class="headerlink" title="5、Mybatis核心配置文件"></a>5、Mybatis核心配置文件</h2><h3 id="5-1、MyBatis核心配置文件层级关系"><a href="#5-1、MyBatis核心配置文件层级关系" class="headerlink" title="5.1、MyBatis核心配置文件层级关系"></a>5.1、MyBatis核心配置文件层级关系</h3><ul><li><p>configuration配置</p></li><li><p>properties 属性</p></li><li><p>settings 设置</p></li><li><p>typeAliases 类型别名</p></li><li><p>typeHandlers 类型处理器</p></li><li><p>objectFactory 对象工厂</p></li><li><p>plugins 插件</p></li><li><p>environments 环境</p></li><li><p>environment 环境变量</p></li><li><p>transactionManager 事务管理器</p></li><li><p>dataSource 数据源</p></li><li><p>databaseIdProvider 数据库厂商便是</p></li><li><p>mappers 映射器</p></li></ul><h3 id="5-2、MyBatis常用配置解析"><a href="#5-2、MyBatis常用配置解析" class="headerlink" title="5.2、MyBatis常用配置解析"></a>5.2、MyBatis常用配置解析</h3><p>官方文档：<a href="https://mybatis.net.cn/configuration.html">https://mybatis.net.cn/configuration.html</a></p><p>1、environments标签</p><p>数据库环境的配置，支持多环境配置</p><p><img src="/SSM/WEBRESOURCE83eaa2a0e2824e1060ad943aa222b732.png"></p><p>其中，事务管理器(transactionManager)类型有两种：</p><ul><li><p>JDBC：这个配置就是直接使用了JDBC的提交和回滚设置，它依赖于从数据源得到的链接来管理事务作用域</p></li><li><p>MANAGED：这个配置几乎没做什么。他从来不提交或回滚一个连接，而是让容器来管理事务的整个生命周期(比如JEE应用服务器的上下文)。默认情况下它会关闭连接，然而一些容器并不希望这样，因此需要将closeConnection属性设置为false来阻止它默认的关闭行为。</p></li></ul><p>其中，数据源(dataSource)类型有三种：</p><ul><li><p>UNPOOLED：这个数据源的实现只是每次请求打开和关闭链接</p></li><li><p>POOLED：这种数据源的实现利用”池“的概念将JDBC连接对象组织起来。</p></li><li><p>JNDI：这个数据源的实现是为了能在比如EJB或应用服务器这类容器中使用，容器可以其中或在外部配置数据源，然后放置一个JNDI上下文的引用。</p></li></ul><p>2、mapper标签</p><p>该标签的作用是加载映射的，加载方式有如下几种：</p><ul><li><p>使用相对于类路径的资源引用，例如：<mapper resource="org/mybatis/builder/builder/AuthorMapper.xml"/></p></li><li><p>使用完全限定资源定位符(URL)，例如：<mapper url="file:///var/mappers/AuthorMapper.xml"/></p></li><li><p>使用映射器接口实现类的完全限定类名，例如：<mapper class="org.mybatis.builder.AuthorMapper"/></p></li><li><p>将包内的映射器接口实现全部注册为映射器，例如：<package name="org.mybatis.builder"/></p></li></ul><p><img src="/SSM/WEBRESOURCEdb3fe4d75af0a5ab2d11fe77f8b96b58.png"></p><p>3、Properties标签</p><p>实际开发中，习惯将数据源的配置信息单独抽取成一个properties文件，该标签可以加载额外配置的properties文件。</p><p><img src="/SSM/WEBRESOURCE03324357bf4da77fab672943c6d4fe46.png"></p><p>4、typeAliases标签</p><p><img src="/SSM/WEBRESOURCE718aa05b9a65243c539535055113dfc7.png"></p><p><img src="/SSM/WEBRESOURCE00352f0140ee769dd03be6056f636555.png"></p><h2 id="6、Mybatis相应API"><a href="#6、Mybatis相应API" class="headerlink" title="6、Mybatis相应API"></a>6、Mybatis相应API</h2><h3 id="6-1、SqlSession工厂构建器SqlSessionFactoryBuilder"><a href="#6-1、SqlSession工厂构建器SqlSessionFactoryBuilder" class="headerlink" title="6.1、SqlSession工厂构建器SqlSessionFactoryBuilder"></a>6.1、SqlSession工厂构建器SqlSessionFactoryBuilder</h3><p>常用API：SqlSessionFactory build(InputStream inputStream)</p><p>通过加载mybatis的核心文件的输入流的形式构建一个SqlSessionFactory对象</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs abnf">String resource <span class="hljs-operator">=</span> <span class="hljs-string">&quot;org/mybatis/builder/mybatis-config.xml&quot;</span><span class="hljs-comment">;</span><br>InputStream inputStream <span class="hljs-operator">=</span> Resources.getResourceAsStream(resource)<span class="hljs-comment">;</span><br>SqlSessionFactoryBuilder builder <span class="hljs-operator">=</span> new SqlSessionFactoryBuilder()<span class="hljs-comment">;</span><br>SqlSessionFactory factory <span class="hljs-operator">=</span> builder.build(inputStream)<br></code></pre></td></tr></table></figure><p>其中Resources工具类，这个类在org.apache.ibatis.io包中。Resources类帮助你从类路径下、系统文件或一个web URL中加载资源文件。</p><h3 id="6-2、SqlSession工厂对象SqlSessionFactory"><a href="#6-2、SqlSession工厂对象SqlSessionFactory" class="headerlink" title="6.2、SqlSession工厂对象SqlSessionFactory"></a>6.2、SqlSession工厂对象SqlSessionFactory</h3><p>SqlSessionFactory有多个方法创建SqlSession实力，常用的有如下两个：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">open</span><span class="hljs-constructor">Session()</span> 会默认开启一个事务，但事务不会自动提交。<br><span class="hljs-keyword">open</span><span class="hljs-constructor">Session(<span class="hljs-params">boolean</span> <span class="hljs-params">autoCommit</span>)</span>  参数为是否自动提交。<br></code></pre></td></tr></table></figure><h3 id="6-3、SqlSession会话对象"><a href="#6-3、SqlSession会话对象" class="headerlink" title="6.3、SqlSession会话对象"></a>6.3、SqlSession会话对象</h3><p>SqlSession实例在MyBatis中是非常强大的一个类。在这里你会看到所有执行语句、提交或回滚事务和获取映射器实例的方法。执行语句的方法主要有：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">&lt;T&gt; T selectOne(String <span class="hljs-keyword">statement</span>,<span class="hljs-keyword">Object</span> parameter)<br>&lt;E&gt; List&lt;E&gt; selectList (Stringg <span class="hljs-keyword">statement</span>,<span class="hljs-keyword">Object</span> parameter)<br><span class="hljs-type">int</span> <span class="hljs-keyword">insert</span> (String <span class="hljs-keyword">statement</span>,<span class="hljs-keyword">Object</span> parameter)<br><span class="hljs-type">int</span> <span class="hljs-keyword">update</span> (String <span class="hljs-keyword">statement</span>,<span class="hljs-keyword">Object</span> parameter)<br><span class="hljs-type">int</span> <span class="hljs-keyword">delete</span> (String <span class="hljs-keyword">statement</span>,<span class="hljs-keyword">Object</span> parameter)<br></code></pre></td></tr></table></figure><p>操作事务的主要方法有：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">commit</span>()</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">rollback</span>()</span><br></code></pre></td></tr></table></figure><h2 id="7、Mybatis的dao层实现"><a href="#7、Mybatis的dao层实现" class="headerlink" title="7、Mybatis的dao层实现"></a>7、Mybatis的dao层实现</h2><h3 id="7-1、传统开发方式"><a href="#7-1、传统开发方式" class="headerlink" title="7.1、传统开发方式"></a>7.1、传统开发方式</h3><p>与javaweb结构相似</p><h3 id="7-2、代理开发方式"><a href="#7-2、代理开发方式" class="headerlink" title="7.2、代理开发方式"></a>7.2、代理开发方式</h3><h4 id="7-2-1、代理开发方式介绍"><a href="#7-2-1、代理开发方式介绍" class="headerlink" title="7.2.1、代理开发方式介绍"></a>7.2.1、代理开发方式介绍</h4><p>采用Mybatis的代理开发方式实现DAO层的开发，这种方式是我们后面进入企业的主流。</p><p>Mapper接口开发方法只需要程序员编写Mapper接口(相当于Dao接口)，有Mybatis框架根据接口定义创建接口的动态代理对象，代理对象的方法体同上边Dao接口实现类方法。</p><p>Mapper接口开发需要遵循一下规范：</p><p>①Mapper.xml文件中的namespace与mapper接口的全限定名相同</p><p>②Mapper接口方法名和Mapper.xml中定义的每个statement的id相同</p><p>③Mapper接口方法的输入参数类型和mapper.xml中定义的每个sql的parameterType的类型相同</p><p>④Mapper接口方法的输出参数类型和mapper.xml中定义的每个sql的resultType的类型相同</p><h4 id="7-2-2、编写UserMapper接口"><a href="#7-2-2、编写UserMapper接口" class="headerlink" title="7.2.2、编写UserMapper接口"></a>7.2.2、编写UserMapper接口</h4><p><img src="/SSM/WEBRESOURCE75ba046470c50cde99e457b967986d74.png"></p><h2 id="8、Mybatis映射文件深入"><a href="#8、Mybatis映射文件深入" class="headerlink" title="8、Mybatis映射文件深入"></a>8、Mybatis映射文件深入</h2><h3 id="8-1、动态sql语句-https-mybatis-net-cn-dynamic-sql-html"><a href="#8-1、动态sql语句-https-mybatis-net-cn-dynamic-sql-html" class="headerlink" title="8.1、动态sql语句(https://mybatis.net.cn/dynamic-sql.html)"></a>8.1、动态sql语句(<a href="https://mybatis.net.cn/dynamic-sql.html">https://mybatis.net.cn/dynamic-sql.html</a>)</h3><h4 id="8-1-1、动态sql语句"><a href="#8-1-1、动态sql语句" class="headerlink" title="8.1.1、动态sql语句"></a>8.1.1、动态sql语句</h4><ul><li><if></li></ul><p>我们根据实体类的不同取值，使用不同的SQL语句来进行查新，比如在id如果不为空时可以根据id查询，如果username不为空时还要加入用户名作为条件。这种情况在我们的多条件组合查询中经常碰到。</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="language-xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="hljs-meta"><span class="language-xml">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.company.MyBatis_Dao.Dao.UserMapper&quot;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-comment">&lt;!--根据Condition查询操作    --&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findByCondition&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;User&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span></span><br><span class="language-xml">        select * from user</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;id!=0&quot;</span>&gt;</span></span><br><span class="language-xml">                and id=#</span><span class="hljs-template-variable">&#123;id&#125;</span><span class="language-xml"></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;username!=null&quot;</span>&gt;</span></span><br><span class="language-xml">                and username=#</span><span class="hljs-template-variable">&#123;username&#125;</span><span class="language-xml"></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;password!=null&quot;</span>&gt;</span></span><br><span class="language-xml">                and password=#</span><span class="hljs-template-variable">&#123;password&#125;</span><span class="language-xml"></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></span><br></code></pre></td></tr></table></figure><ul><li><foreach></li></ul><p>循环执行sql的拼接操作，例如：select * from user where id in（1，2，5）</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="language-xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="hljs-meta"><span class="language-xml">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.company.MyBatis_Dao.Dao.UserMapper&quot;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findByIds&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;list&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span></span><br><span class="language-xml">        select * from user</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;list&quot;</span> <span class="hljs-attr">open</span>=<span class="hljs-string">&quot;id in(&quot;</span> <span class="hljs-attr">close</span>=<span class="hljs-string">&quot;)&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span>&gt;</span></span><br><span class="language-xml">                #</span><span class="hljs-template-variable">&#123;id&#125;</span><span class="language-xml"></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></span><br></code></pre></td></tr></table></figure><h3 id="8-2、sql片段的抽取"><a href="#8-2、sql片段的抽取" class="headerlink" title="8.2、sql片段的抽取"></a>8.2、sql片段的抽取</h3><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="language-xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="hljs-meta"><span class="language-xml">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.company.MyBatis_Dao.Dao.UserMapper&quot;</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">    <span class="hljs-comment">&lt;!--sql语句抽取    --&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectUser&quot;</span>&gt;</span>select * from user<span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-comment">&lt;!--根据Condition查询操作    --&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findByCondition&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;User&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectUser&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;id!=0&quot;</span>&gt;</span></span><br><span class="language-xml">                and id=#</span><span class="hljs-template-variable">&#123;id&#125;</span><span class="language-xml"></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;username!=null&quot;</span>&gt;</span></span><br><span class="language-xml">                and username=#</span><span class="hljs-template-variable">&#123;username&#125;</span><span class="language-xml"></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;password!=null&quot;</span>&gt;</span></span><br><span class="language-xml">                and password=#</span><span class="hljs-template-variable">&#123;password&#125;</span><span class="language-xml"></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findByIds&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;list&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectUser&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;list&quot;</span> <span class="hljs-attr">open</span>=<span class="hljs-string">&quot;id in(&quot;</span> <span class="hljs-attr">close</span>=<span class="hljs-string">&quot;)&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span>&gt;</span></span><br><span class="language-xml">                #</span><span class="hljs-template-variable">&#123;id&#125;</span><span class="language-xml"></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></span><br></code></pre></td></tr></table></figure><h2 id="9、Mybatis核心配置文件深入"><a href="#9、Mybatis核心配置文件深入" class="headerlink" title="9、Mybatis核心配置文件深入"></a>9、Mybatis核心配置文件深入</h2><h3 id="9-1、typeHandlers标签"><a href="#9-1、typeHandlers标签" class="headerlink" title="9.1、typeHandlers标签"></a>9.1、typeHandlers标签</h3><p>无论是MyBatis在处理语句(PreparedStatement)中设置一个参数时，还是从结果集中取出一个值时，都会用类型处理器将获取的值以合适的方式转换成Java类型。下标描述了一些默认的类型处理器(部分)</p><table><thead><tr><th>类处理器</th><th>Java类型</th><th>JDBC类型</th></tr></thead><tbody><tr><td>BooleanTypeHandler</td><td>java.lang.Boolean,boolean</td><td>数据库兼容的BOOLEAN</td></tr><tr><td>ByteTypeHandler</td><td>java.lang.Byte,byte</td><td>数据库兼容的NUMERIC或BYTE</td></tr><tr><td>ShortTypeHandler</td><td>java.lang.Short,short</td><td>数据库兼容的NUMERIC或SHORT INTEGER</td></tr><tr><td>IntegerTypeHandler</td><td>java.lang.Integer,int</td><td>数据库兼容的NUMERIC或INTEGER</td></tr><tr><td>LongTypeHnadler</td><td>java.lang.long,long</td><td>数据库兼容的NUMERIC或LONG INTEGER</td></tr></tbody></table><p>你可以重写类型处理器或创建自己的类型处理器来处理不持支的或非标准的类型。具体做法为：实现org.apache.ibatis.type.TybeHandler接口，或继承一个很便利的类org.apache.ibatis.type.BaseTypeHandler,然后可以选择性地将它映射到一个JDBC类型。例如需求：一个Java中的Date数据类型，我想将之存入到数据库的时候存成一个1790至今的毫秒数，取出来时转换成java的Date，即java的Date与数据库的varchar毫秒之间转换。</p><p>开发步骤：</p><p>①定义转换继承类BaseTypeHandler<T></p><p>②覆盖4个为实现的方法，其中setNonNullParameter为java程序设置数据到数据库的回调方法，getNullableResult为查询时mysql的字符串类型转换成java的Type类型的方法</p><p>③在MyBatis核心配置文件中进行注册</p><p>④测试转换是否正确</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.company.MyBatis_Dao.Handler;<br><br><span class="hljs-keyword">import</span> org.apache.ibatis.type.BaseTypeHandler;<br><span class="hljs-keyword">import</span> org.apache.ibatis.type.JdbcType;<br><br><span class="hljs-keyword">import</span> java.sql.CallableStatement;<br><span class="hljs-keyword">import</span> java.sql.PreparedStatement;<br><span class="hljs-keyword">import</span> java.sql.ResultSet;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateTypeHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;Date&gt; &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(PreparedStatement preparedStatement, <span class="hljs-type">int</span> i, Date date, JdbcType jdbcType)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> date.getTime();<br>        preparedStatement.setLong(i,time);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(ResultSet resultSet, String s)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">aLong</span> <span class="hljs-operator">=</span> resultSet.getLong(s);<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(aLong);<br>        <span class="hljs-keyword">return</span> date;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(ResultSet resultSet, <span class="hljs-type">int</span> i)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">aLong</span> <span class="hljs-operator">=</span> resultSet.getLong(i);<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(aLong);<br>        <span class="hljs-keyword">return</span> date;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(CallableStatement callableStatement, <span class="hljs-type">int</span> i)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">aLong</span> <span class="hljs-operator">=</span> callableStatement.getLong(i);<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(aLong);<br>        <span class="hljs-keyword">return</span> date;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--注册类型处理器    --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">typeHandlers</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">typeHandler</span> <span class="hljs-attr">handler</span>=<span class="hljs-string">&quot;com.company.MyBatis_Dao.Handler.DateTypeHandler&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">typeHandler</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">typeHandlers</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="9-2、plugins标签"><a href="#9-2、plugins标签" class="headerlink" title="9.2、plugins标签"></a>9.2、plugins标签</h3><p>MyBatis可以使用第三方的插件来对功能进行扩展，分页助手PageHelper是将分页的复杂操作进行封装，使用简单的方式即可获得分页的相关数据</p><p>开发步骤：</p><p>①导入通用PageHelper的坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.pagehelper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pagehelper<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.7.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.jsqlparser<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jsqlparser<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>②在mybatis核心配置文件中配置PageHelper插件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--配置分页助手插件    --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span> <span class="hljs-attr">interceptor</span>=<span class="hljs-string">&quot;com.github.pagehelper.PageHelper&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dialect&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;mysql&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br></code></pre></td></tr></table></figure><p>③测试分页数据获取</p><h2 id="10、Mybatis的多表操作"><a href="#10、Mybatis的多表操作" class="headerlink" title="10、Mybatis的多表操作"></a>10、Mybatis的多表操作</h2><h3 id="10-1、一对一的封装查询"><a href="#10-1、一对一的封装查询" class="headerlink" title="10.1、一对一的封装查询()"></a>10.1、一对一的封装查询<resultMap>(<association>)</h3><ul><li>Order</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.company.MyBatis_multi.Pojo;<br><br><span class="hljs-keyword">import</span> java.sql.Timestamp;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> id;<br>  <span class="hljs-keyword">private</span> java.sql.Timestamp ordertime;<br>  <span class="hljs-keyword">private</span> Double total;<br><br>  <span class="hljs-comment">//表示当前订单属于哪一个用户</span><br>  <span class="hljs-keyword">private</span> User user;<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li>User</li></ul><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">package</span> com.company.MyBatis_multi.Pojo;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> int id;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> username;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> password;<br>    <span class="hljs-keyword">private</span> Date Birthday;<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li>OrderMapper.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.company.MyBatis_multi.Dao.OrderMapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;orderMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;Order&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--手动指定字段与实体属性的映射关系(column：数据库的字段名称 property：实体的属性名称)--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;oid&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;ordertime&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;ordertime&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;total&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;total&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;uid&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;user.id&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;user.username&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;user.password&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;birthday&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;user.birthday&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectOrders&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;orderMap&quot;</span>&gt;</span><br>        select *,o.id oid from `order` o,`user` u where o.uid=u.id<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li><association>标签</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.company.MyBatis_multi.Dao.OrderMapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;orderMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;Order&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--手动指定字段与实体属性的映射关系(column：数据库的字段名称 property：实体的属性名称)--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;oid&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;ordertime&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;ordertime&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;total&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;total&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">association</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">javaType</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;uid&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;username&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;Birthday&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;Birthday&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">association</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectOrders&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;orderMap&quot;</span>&gt;</span><br>        select *,o.id oid from `order` o,`user` u where o.uid=u.id<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="10-2、一对多或多对一的封装查询"><a href="#10-2、一对多或多对一的封装查询" class="headerlink" title="10.2、一对多或多对一的封装查询+"></a>10.2、一对多或多对一的封装查询<resultMap>+<collection></h3><ul><li><collection>标签</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.company.MyBatis_multi.Dao.UserMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;user&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;uid&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;username&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;birthday&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;birthday&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--property:集合名称--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;orderList&quot;</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">&quot;Order&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;oid&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;ordertime&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;ordertime&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;total&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;total&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findAll&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;userMap&quot;</span>&gt;</span><br>        select *,o.id oid from `user` u,`order` o where u.id=o.uid<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>User</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.company.MyBatis_multi.Pojo;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> Date Birthday;<br><br>    <span class="hljs-keyword">private</span> List&lt;Order&gt; orderList;<br>    <br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="10-3、多对多的封装查询"><a href="#10-3、多对多的封装查询" class="headerlink" title="10.3、多对多的封装查询+"></a>10.3、多对多的封装查询<resultMap>+<collection></h3><p><img src="/SSM/WEBRESOURCE3318f9cbd6ce3ab910188e2530281530.png"></p><p>和一对多相似</p><h2 id="11、Mybatis的注解开发"><a href="#11、Mybatis的注解开发" class="headerlink" title="11、Mybatis的注解开发"></a>11、Mybatis的注解开发</h2><h3 id="11-1、MyBatis的常用注解"><a href="#11-1、MyBatis的常用注解" class="headerlink" title="11.1、MyBatis的常用注解"></a>11.1、MyBatis的常用注解</h3><p>这几年来注解开发越来越流行，Mybatis也可以使用注解开发方式，这样我们就可以减少编写Mapper映射文件了。我们先围绕一些基本的CRUD来学习，再学习复杂映射多表操作。</p><p>@Insert：实现新增</p><p>@Update：实现更新</p><p>@Delete：实现删除</p><p>@Select：实现查询</p><p>@Result：实现结果集封装</p><p>@Results：可以与@Result一起使用，封装多个结果集</p><p>@One：实现一对一结果集封装</p><p>@Many：实现一对多结果集封装</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Results</span>(id=<span class="hljs-string">&quot;groupWithUsers&quot;</span>,<br>         value = &#123; <br>            <span class="hljs-variable">@Result</span>(property = <span class="hljs-string">&quot;groupId&quot;</span>, column = <span class="hljs-string">&quot;group_id&quot;</span>, id = true),<br>            <span class="hljs-variable">@Result</span>(property = <span class="hljs-string">&quot;name&quot;</span>, column = <span class="hljs-string">&quot;name&quot;</span>), <br>            <span class="hljs-variable">@Result</span>(property = <span class="hljs-string">&quot;accountId&quot;</span>, column = <span class="hljs-string">&quot;account_id&quot;</span>),<br>            <span class="hljs-variable">@Result</span>(property = <span class="hljs-string">&quot;deleteFlag&quot;</span>, column = <span class="hljs-string">&quot;delete_Flag&quot;</span>),<br>            <span class="hljs-variable">@Result</span>(property = <span class="hljs-string">&quot;parentId&quot;</span>, column = <span class="hljs-string">&quot;parent_Id&quot;</span>), <br>            <span class="hljs-variable">@Result</span>(property = <span class="hljs-string">&quot;userList&quot;</span>, javaType=List.class, many =<span class="hljs-variable">@Many</span>(select=<span class="hljs-string">&quot;selectUsersByGroupId&quot;</span>), column = <span class="hljs-string">&quot;group_id&quot;</span>)&#125;)<br><span class="hljs-comment">//查询</span><br><span class="hljs-variable">@Select</span>(&#123;<span class="hljs-string">&quot;select * from group where account_id=#&#123;accountId&#125; and delete_flag=0&quot;</span>&#125;)<br>List&lt;Group&gt; <span class="hljs-built_in">selectGroupWithUsers</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">&quot;accountId&quot;</span>) String accountId);<br> <br> <br><span class="hljs-variable">@Select</span>(&#123;<span class="hljs-string">&quot;select u.* from user u&quot;</span>,<br><span class="hljs-string">&quot;inner join user_group ug on u.user_id = ug.user_id&quot;</span>,<br><span class="hljs-string">&quot;where ug.group_id=#&#123;groupId&#125; and u.delete_flag=0&quot;</span><br>&#125;)<br>List&lt;User&gt; <span class="hljs-built_in">selectUsersByGroupId</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">&quot;groupId&quot;</span>) String groupId);<br><br></code></pre></td></tr></table></figure><h1 id="Spring与Mybatis的整合"><a href="#Spring与Mybatis的整合" class="headerlink" title="Spring与Mybatis的整合"></a>Spring与Mybatis的整合</h1><p><img src="/SSM/WEBRESOURCEb85f881a311fe197b40fdb3c4fc3abb6.png"></p><p><img src="/SSM/WEBRESOURCEcf8846dd2f2ef47bcf68c2953b23cecd.png"></p><p><img src="/SSM/WEBRESOURCEe3ab70c2f586a09f8fe0b72d88f8b824.png"></p><p><img src="/SSM/WEBRESOURCE4231fd93fe416597d86830f309ab8fa7.png"></p><p><img src="/SSM/WEBRESOURCE699b422bba9bdd40a84faa2c9f4e5384.png"></p><p><img src="/SSM/WEBRESOURCE8353a293c162c1c7728f3312367fad88.png"></p><p><img src="/SSM/WEBRESOURCE66cc208e423d6e8b8f8d668663a8361a.png"></p><p><img src="/SSM/WEBRESOURCE8c6e280f2ddbec8ec55dacce5b06e0ce.png"></p><p><img src="/SSM/WEBRESOURCEe629d56ba9f288205e6ae57dfd3f1165.png"></p><p><img src="/SSM/WEBRESOURCEb15736c567cc6153e7dfbb2059579fd5.png"></p><p><img src="/SSM/WEBRESOURCE9d452d403992cc0392c08a6b5f23a0cd.png"></p><p><img src="/SSM/WEBRESOURCE991f998e3da65b66ab134ec7ac50bc7f.png"></p><p>applicationContext.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:aop</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/aop&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:tx</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/tx&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">      http://www.springframework.org/schema/context/spring-context.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/aop</span></span><br><span class="hljs-string"><span class="hljs-tag">      http://www.springframework.org/schema/aop/spring-aop.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/tx</span></span><br><span class="hljs-string"><span class="hljs-tag">      http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">&quot;com.company.MS1&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">aop:aspectj-autoproxy</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">tx:annotation-driven</span> <span class="hljs-attr">transaction-manager</span>=<span class="hljs-string">&quot;txManager&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driverClassName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test?useSSL=false<span class="hljs-symbol">&amp;amp;</span>useUnicode=true<span class="hljs-symbol">&amp;amp;</span>characterEncoding=utf-8<span class="hljs-symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;root&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;123456&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;configLocation&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Mybatis_config.xml&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;mapperLocations&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>com.company.mapper/ProviderMapper.xml<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-comment">&lt;!-- SqlSessionTemplate--&gt;</span><br><span class="hljs-comment">&lt;!--    &lt;bean id=&quot;sqlSessionTemplate&quot; class=&quot;org.mybatis.spring.SqlSessionTemplate&quot;&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--        &lt;constructor-arg name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot;/&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--    &lt;/bean&gt;--&gt;</span><br><br><span class="hljs-comment">&lt;!--    &lt;bean id=&quot;providerMapper&quot; class=&quot;com.company.MS1.Mapper.Impl.ProviderMapperImpl&quot;&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--        &lt;property name=&quot;sqlSessionTemplate&quot; ref=&quot;sqlSessionTemplate&quot;&gt;&lt;/property&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--    &lt;/bean&gt;    --&gt;</span><br><br><span class="hljs-comment">&lt;!-- MapperFactoryBean--&gt;</span><br><span class="hljs-comment">&lt;!--    &lt;bean id=&quot;providerMapper&quot; class=&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--        &lt;property name=&quot;mapperInterface&quot; value=&quot;com.company.MS1.Mapper.ProviderMapper&quot;&gt;&lt;/property&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--        &lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot;&gt;&lt;/property&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--    &lt;/bean&gt;--&gt;</span><br><br><span class="hljs-comment">&lt;!--    &lt;bean id=&quot;providerService&quot; class=&quot;com.company.MS1.Service.Impl.ProviderServiceImpl&quot;&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--        &lt;property name=&quot;providerMapper&quot; ref=&quot;providerMapper&quot;&gt;&lt;/property&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--    &lt;/bean&gt;    --&gt;</span><br><br><span class="hljs-comment">&lt;!--    &lt;bean id=&quot;providerService&quot; class=&quot;com.company.MS1.Service.Impl.ProviderServiceImpl&quot;&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--        &lt;property name=&quot;providerMapper&quot; ref=&quot;providerMapper&quot;&gt;&lt;/property&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--    &lt;/bean&gt;--&gt;</span><br><br><span class="hljs-comment">&lt;!-- MapperScannerConfigurer--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;basePackage&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.company.MS1.Mapper&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sqlSessionFactoryBeanName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;txManager&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <br>    <span class="hljs-comment">&lt;!--事务处理的配置--&gt;</span><br><span class="hljs-comment">&lt;!--    &lt;tx:advice id=&quot;transactionInterceptor&quot; transaction-manager=&quot;txManager&quot;&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--        &lt;tx:attributes&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--            &lt;tx:method name=&quot;select*&quot; propagation=&quot;REQUIRED&quot;/&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--            &lt;tx:method name=&quot;*&quot; propagation=&quot;REQUIRED&quot;/&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--        &lt;/tx:attributes&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--    &lt;/tx:advice&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--    --&gt;</span><br><span class="hljs-comment">&lt;!--    &lt;aop:config&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--        &lt;aop:pointcut id=&quot;pointcut&quot; expression=&quot;execution(* com.company.MS1..*.*(..))&quot;/&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--        &lt;aop:advisor advice-ref=&quot;transactionInterceptor&quot; pointcut-ref=&quot;pointcut&quot;&gt;&lt;/aop:advisor&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--    &lt;/aop:config&gt;--&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>JavaWeb+SSM+SpringBoot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Spring</tag>
      
      <tag>SpringMVC</tag>
      
      <tag>MyBatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JavaWeb</title>
    <link href="/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/"/>
    <url>/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/</url>
    
    <content type="html"><![CDATA[<h1 id="1、JavaWeb基础"><a href="#1、JavaWeb基础" class="headerlink" title="1、JavaWeb基础"></a>1、JavaWeb基础</h1><h2 id="1-1、程序架构和Tomcat的操作"><a href="#1-1、程序架构和Tomcat的操作" class="headerlink" title="1.1、程序架构和Tomcat的操作"></a>1.1、程序架构和Tomcat的操作</h2><p>略</p><h2 id="1-2、部署Web项目、JSP入门"><a href="#1-2、部署Web项目、JSP入门" class="headerlink" title="1.2、部署Web项目、JSP入门"></a>1.2、部署Web项目、JSP入门</h2><p>略</p><h1 id="2、JSP实现数据传递和保存"><a href="#2、JSP实现数据传递和保存" class="headerlink" title="2、JSP实现数据传递和保存"></a>2、JSP实现数据传递和保存</h1><h2 id="2-1、JSP九大内置对象"><a href="#2-1、JSP九大内置对象" class="headerlink" title="2.1、JSP九大内置对象"></a>2.1、JSP九大内置对象</h2><p>JSP 中定义了 9 个内置对象，它们分别是：request、response、session、application、out、pagecontext、config、page 和 exception，这些对象在客户端和服务器端交互的过程中分别完成不同的功能。</p><table><thead><tr><th>对  象</th><th>类型</th><th>说  明</th></tr></thead><tbody><tr><td>request</td><td>javax.servlet.http.HttpServletRequest</td><td>获取用户请求信息</td></tr><tr><td>response</td><td>javax.servlet.http.HttpServletResponse</td><td>响应客户端请求，并将处理信息返回到客户端</td></tr><tr><td>out</td><td>javax.servlet.jsp.JspWriter</td><td>输出内容到 HTML 中</td></tr><tr><td>session</td><td>javax.servlet.http.HttpSession</td><td>用来保存用户信息</td></tr><tr><td>application</td><td>javax.servlet.ServletContext</td><td>所有用户共享信息</td></tr><tr><td>config</td><td>javax.servlet.ServletConfig</td><td>这是一个 Servlet 配置对象，用于 Servlet 和页面的初始化参数</td></tr><tr><td>pageContext</td><td>javax.servlet.jsp.PageContext</td><td>JSP 的页面容器，用于访问 page、request、application 和 session 的属性</td></tr><tr><td>page</td><td>javax.servlet.jsp.HttpJspPage</td><td>类似于 Java 类的 this 关键字，表示当前 JSP 页面</td></tr><tr><td>exception</td><td>java.lang.Throwable</td><td>该对象用于处理 JSP 文件执行时发生的错误和异常；只有在 JSP 页面的 page 指令中指定 isErrorPage 的取值 true 时，才可以在本页面使用 exception 对象。</td></tr></tbody></table><p>JSP 的内置对象主要有以下特点：</p><ul><li><p>由 JSP 规范提供，不用编写者实例化；</p></li><li><p>通过 Web 容器实现和管理；</p></li><li><p>所有 JSP 页面均可使用；</p></li><li><p>只有在脚本元素的表达式或代码段中才能使用。</p></li></ul><h2 id="2-2、四大域对象"><a href="#2-2、四大域对象" class="headerlink" title="2.2、四大域对象"></a>2.2、四大域对象</h2><p>在 JSP 九大内置对象中，包含四个域对象，它们分别是：pageContext（page 域对象）、request（request 域对象）、session（session 域对象）、以及 application（application 域对象）。</p><p>JSP 中的 4 个域对象都能通过以下 3 个方法，对属性进行保存、获取和移除操作。</p><table><thead><tr><th>返回值类型</th><th>方法</th><th>作用</th></tr></thead><tbody><tr><td>void</td><td>setAttribute(String name, Object o)</td><td>将属性保存到域对象中</td></tr><tr><td>Object</td><td>getAttribute(String name)</td><td>获取域对象中的属性值</td></tr><tr><td>void</td><td>removeAttribute(String name)</td><td>将属性从域对象中移除</td></tr></tbody></table><p>JSP 中的 4 个域对象的作用域各不相同，如下表。</p><table><thead><tr><th>作用域</th><th>描述</th><th>作用范围</th></tr></thead><tbody><tr><td>page</td><td>如果把属性保存到 pageContext 中，则它的作用域是 page。</td><td>该作用域中的属性只在当前 JSP 页面有效，跳转页面后失效。</td></tr><tr><td>request</td><td>如果把属性保存到 request 中，则它的作用域是 request。</td><td>该作用域中的属性只在当前请求范围内有效。request作用域是在一次请求当中<br>服务器跳转页面后有效，例如&lt;jsp:forward&gt;；<br>客户端跳转页面后无效，例如超链接。</td></tr><tr><td>session</td><td>如果把属性保存到 session 中，则它的作用域是 session。</td><td>该作用域中的属性只在当前会话范围内有效，网页关闭后失效。</td></tr><tr><td>application</td><td>如果把属性保存到 application 中，则它的作用域是 application。</td><td>该作用域中的属性在整个应用范围内有效，服务器重启后失效。</td></tr></tbody></table><h2 id="2-3、获取input输入框中的值"><a href="#2-3、获取input输入框中的值" class="headerlink" title="2.3、获取input输入框中的值"></a>2.3、获取input输入框中的值</h2><p>单值：</p><p>getParameter(inputname)</p><p>数组：</p><p>getParameterValues(inputname)</p><h2 id="2-4、post方式出现乱码情况的解决方法"><a href="#2-4、post方式出现乱码情况的解决方法" class="headerlink" title="2.4、post方式出现乱码情况的解决方法"></a>2.4、post方式出现乱码情况的解决方法</h2><p>在最开头设置request.setcharacterEncoding(“utf-8”)和response.setcharacterEncoding(“utf-8”)</p><p>get方式出现乱码情况</p><p>方式一：修改server.xml配置文件（不建议使用）</p><p>方式二：利用代码方式解决</p><p>userName  &#x3D;  new  string(userName.getParameter(“”)………);</p><h2 id="2-5、post与get的区别"><a href="#2-5、post与get的区别" class="headerlink" title="2.5、post与get的区别"></a>2.5、post与get的区别</h2><ol><li><p>GET提交的数据放在URL中，POST则不会。这是最显而易见的差别。这点意味着GET更不安全（POST也不安全，因为HTTP是明文传输抓包就能获取数据内容，要想安全还得加密）</p></li><li><p>GET回退浏览器无害，POST会再次提交请求（GET方法回退后浏览器再缓存中拿结果，POST每次都会创建新资源）</p></li><li><p>GET提交的数据大小有限制（是因为浏览器对URL的长度有限制，GET本身没有限制），POST也有但是大小很大有几个G。</p></li><li><p>GET可以被保存为书签，POST不可以。这一点也能感受到。</p></li><li><p>GET能被缓存，POST不能</p></li><li><p>GET只允许ASCII字符，POST没有限制</p></li><li><p>GET会保存再浏览器历史记录中，POST不会。这点也能感受到。</p></li><li><p>URL可传播</p></li></ol><p>一般情况下使用post方式</p><h2 id="2-6、转发和重定向"><a href="#2-6、转发和重定向" class="headerlink" title="2.6、转发和重定向"></a>2.6、转发和重定向</h2><p>转发a—&gt;b—&gt;转发—&gt;c(一次请求)</p><p>request.setAttribute(“msg”,“注册失败”)</p><p>request.getRequestDispatcher(filename).forward(request,response)</p><p>request.getAttribute(“msg”,“注册失败”)</p><p>重定向a—&gt;b重定向b—&gt;c(两次请求)</p><p>response.sendRedirect()</p><h1 id="3、使用JDBC-Java-DataBase-Connectivity-操作数据库"><a href="#3、使用JDBC-Java-DataBase-Connectivity-操作数据库" class="headerlink" title="3、使用JDBC(Java DataBase Connectivity)操作数据库"></a>3、使用JDBC(Java DataBase Connectivity)操作数据库</h1><p>Connection数据库连接</p><p>PreparedStatementsql语句</p><p>ResultSet执行查询时，返回的结果集</p><p>DriverManager管理驱动包中的连接</p><h2 id="3-1、JDBC访问数据库的步骤"><a href="#3-1、JDBC访问数据库的步骤" class="headerlink" title="3.1、JDBC访问数据库的步骤"></a>3.1、JDBC访问数据库的步骤</h2><ol><li><p>Class.forName()加载驱动</p></li><li><p>DriverManager获取Connection丽娜姐</p></li><li><p>创建Statement执行SQL语句</p></li><li><p>返回ResultSet</p></li><li><p>释放资源</p></li></ol><h2 id="3-2、JDCB公共部分的解耦"><a href="#3-2、JDCB公共部分的解耦" class="headerlink" title="3.2、JDCB公共部分的解耦"></a>3.2、JDCB公共部分的解耦</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.company.JDBC;<br><br><span class="hljs-keyword">import</span> java.sql.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@time</span>: 2022/5/13 19:20</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NewsDao</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">preparedStatement</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://localhost:3306/javaweb?characterEncoding=utf8&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;root&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123456&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *<span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment">        获取连接</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@return</span>: java.sql.Connection</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@time</span>: 2022/5/14 14:22</span><br><span class="hljs-comment">      */</span><br>    <span class="hljs-keyword">private</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (connection==<span class="hljs-literal">null</span>||connection.isClosed())&#123;<br>                <span class="hljs-comment">//1、建立连接</span><br>                Class.forName(<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>);<br>                <span class="hljs-comment">//2、获取链接</span><br>                connection = DriverManager.getConnection(url,user,password);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> connection;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *<span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment">        关闭连接</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@return</span>: void</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@time</span>: 2022/5/14 14:24</span><br><span class="hljs-comment">      */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeConnection</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (resultSet!=<span class="hljs-literal">null</span>)&#123;<br>                resultSet.close();<br>            &#125;<br>            <span class="hljs-keyword">if</span> (preparedStatement!=<span class="hljs-literal">null</span>)&#123;<br>                preparedStatement.close();<br>            &#125;<br>            <span class="hljs-keyword">if</span> (connection!=<span class="hljs-literal">null</span>)&#123;<br>                connection.close();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *<span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment">        添加</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@return</span>: int</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@time</span>: 2022/5/14 14:36</span><br><span class="hljs-comment">      */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addNews</span><span class="hljs-params">(<span class="hljs-type">int</span> categoryId,String title)</span>&#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">addNewsDetail</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            connection = <span class="hljs-built_in">this</span>.getConnection();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;insert into news_detail(categoryId, title) values (?,?)&quot;</span>;<br>            preparedStatement = connection.prepareStatement(sql);<br>            preparedStatement.setInt(<span class="hljs-number">1</span>,categoryId);<br>            preparedStatement.setString(<span class="hljs-number">2</span>,title);<br>            System.out.println(<span class="hljs-string">&quot;addNews param categoryId:&quot;</span>+categoryId+<span class="hljs-string">&quot;,title:&quot;</span>+title);<br>            addNewsDetail = preparedStatement.executeUpdate();<br>            System.out.println(<span class="hljs-string">&quot;addNews param categoryId:&quot;</span>+categoryId+<span class="hljs-string">&quot;,title:&quot;</span>+title+<span class="hljs-string">&quot;,result:&quot;</span>+addNewsDetail);<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;queryNewsByTitle is error,param categoryId：&quot;</span>+categoryId+<span class="hljs-string">&quot;,title:&quot;</span>+title);<br>        &#125;<br>        <span class="hljs-keyword">return</span> addNewsDetail;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *<span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment">        删除</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>: int</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@time</span>: 2022/5/14 14:36</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">delNews</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span>&#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">delNewsDetail</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            connection = <span class="hljs-built_in">this</span>.getConnection();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;delete from news_detail where id=?&quot;</span>;<br>            preparedStatement = connection.prepareStatement(sql);<br>            preparedStatement.setInt(<span class="hljs-number">1</span>,id);<br>            System.out.println(<span class="hljs-string">&quot;addNews param id:&quot;</span>+id);<br>            delNewsDetail = preparedStatement.executeUpdate();<br>            System.out.println(<span class="hljs-string">&quot;addNews param id:&quot;</span>+id+<span class="hljs-string">&quot;,result:&quot;</span>+delNewsDetail);<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;delNews is error,param id:&quot;</span>+id);<br>        &#125;<br>        <span class="hljs-keyword">return</span> delNewsDetail;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *<span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment">        修改</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@return</span>: int</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@time</span>: 2022/5/14 14:59</span><br><span class="hljs-comment">      */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">updateNews</span><span class="hljs-params">(<span class="hljs-type">int</span> id,String title)</span>&#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">updateNewsDetail</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            connection = <span class="hljs-built_in">this</span>.getConnection();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;update news_detail set title=? where id=?;&quot;</span>;<br>            preparedStatement = connection.prepareStatement(sql);<br>            preparedStatement.setString(<span class="hljs-number">1</span>,title);<br>            preparedStatement.setInt(<span class="hljs-number">2</span>,id);<br>            System.out.println(<span class="hljs-string">&quot;addNews param id:&quot;</span>+id+<span class="hljs-string">&quot;,title:&quot;</span>+title);<br>            updateNewsDetail = preparedStatement.executeUpdate();<br>            System.out.println(<span class="hljs-string">&quot;addNews param id:&quot;</span>+id+<span class="hljs-string">&quot;,title:&quot;</span>+title+<span class="hljs-string">&quot;,result:&quot;</span>+updateNewsDetail);<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;updateNewsDetail is error,param id:&quot;</span>+id+<span class="hljs-string">&quot;,title:&quot;</span>+title);<br>        &#125;<br>        <span class="hljs-keyword">return</span> updateNewsDetail;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *<span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment">        查询</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@return</span>: void</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@time</span>: 2022/5/14 14:25</span><br><span class="hljs-comment">      */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryNewsByTitle</span><span class="hljs-params">(String queryTitle)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            connection = <span class="hljs-built_in">this</span>.getConnection();<br>            <span class="hljs-comment">//3、发送指令(sql)</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select id,title from news_detail where title like ?&quot;</span>;<br>            System.out.println(<span class="hljs-string">&quot;NewsDao sql:&quot;</span>+sql);<br>            <span class="hljs-comment">//4、数据库执行指令</span><br>            preparedStatement = connection.prepareStatement(sql);<br>            preparedStatement.setString(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;%&quot;</span>+queryTitle+<span class="hljs-string">&quot;%&quot;</span>);<br>            resultSet = preparedStatement.executeQuery();<br>            <span class="hljs-keyword">while</span> (resultSet.next())&#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> resultSet.getInt(<span class="hljs-string">&quot;id&quot;</span>);<span class="hljs-comment">//使用columnLabel来获取列</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">title</span> <span class="hljs-operator">=</span> resultSet.getString(<span class="hljs-string">&quot;title&quot;</span>);<span class="hljs-comment">//使用columnIndex来获取列</span><br>                System.out.println(<span class="hljs-string">&quot;id:&quot;</span>+id+<span class="hljs-string">&quot;,title:&quot;</span>+title);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;queryNewsByTitle is error,param:&quot;</span>+queryTitle);<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            closeConnection();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *<span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment">        入口</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@return</span>: void</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment">      * <span class="hljs-doctag">@time</span>: 2022/5/14 14:52</span><br><span class="hljs-comment">      */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">NewsDao</span> <span class="hljs-variable">newsDao</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NewsDao</span>();<br><br><span class="hljs-comment">//        //添加</span><br><span class="hljs-comment">//        int addNewCount = newsDao.addNews(3,&quot;爱上服务器二7345375&quot;);</span><br><span class="hljs-comment">//        System.out.println(&quot;main method para categoryId:3,title=爱上服务器二7345375,&quot;+&quot;result:&quot;+addNewCount);</span><br><span class="hljs-comment">//        if (addNewCount&lt;0)&#123;</span><br><span class="hljs-comment">//            System.out.println(&quot;添加失败&quot;);</span><br><span class="hljs-comment">//        &#125;else &#123;</span><br><span class="hljs-comment">//            System.out.println(&quot;添加成功&quot;);</span><br><span class="hljs-comment">//        &#125;</span><br><br><span class="hljs-comment">//        //删除</span><br><span class="hljs-comment">//        int delNewCount = newsDao.delNews(2);</span><br><span class="hljs-comment">//        System.out.println(&quot;main method para id:2&quot;+&quot;result:&quot;+delNewCount);</span><br><span class="hljs-comment">//        if (delNewCount&lt;0)&#123;</span><br><span class="hljs-comment">//            System.out.println(&quot;添加失败&quot;);</span><br><span class="hljs-comment">//        &#125;else &#123;</span><br><span class="hljs-comment">//            System.out.println(&quot;添加成功&quot;);</span><br><span class="hljs-comment">//        &#125;</span><br><br><span class="hljs-comment">//        //修改</span><br><span class="hljs-comment">//        int updateNewCount = newsDao.updateNews(4,&quot;哈哈哈哈哈哈哈哈哈哈哈&quot;);</span><br><span class="hljs-comment">//        System.out.println(&quot;main method para id:4&quot;+&quot;result:&quot;+updateNewCount);</span><br><span class="hljs-comment">//        if (updateNewCount&lt;0)&#123;</span><br><span class="hljs-comment">//            System.out.println(&quot;添加失败&quot;);</span><br><span class="hljs-comment">//        &#125;else &#123;</span><br><span class="hljs-comment">//            System.out.println(&quot;添加成功&quot;);</span><br><span class="hljs-comment">//        &#125;</span><br>        <span class="hljs-comment">//查询</span><br>        newsDao.queryNewsByTitle(<span class="hljs-string">&quot;哈哈哈哈哈哈哈哈哈&quot;</span>);<br><br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="3-3、Statement与PreparedStatement区别"><a href="#3-3、Statement与PreparedStatement区别" class="headerlink" title="3.3、Statement与PreparedStatement区别"></a>3.3、Statement与PreparedStatement区别</h2><p>Statement：Statement对象不使用SQL参数，不会解析并编译SQL语句，每次调用执行SQL语句时都要进行SQL语句的解析和编译操作，效率低。</p><p>PreparedStatement：创建PreparedStatement对象时使用SQL语句做参数，会解析并编译SQL语句（预编译）。也可以使用带占位符“?”的SQL语句做参数，在通过setXxx()方法给占位符赋值后执行SQL语句时无需再解析和编译SQL语句，直接执行的。当进行批处理（多次执行相同操作）时，效率高。</p><p>安全性相对来说PreparedStatement比Statement高一些。</p><h2 id="3-4、JDBC工作原理"><a href="#3-4、JDBC工作原理" class="headerlink" title="3.4、JDBC工作原理"></a>3.4、JDBC工作原理</h2><p><img src="/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/WEBRESOURCE75396f683d74401cb2c2ff4c39f793b9.png"></p><p><img src="/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/WEBRESOURCE57a9f12c9fc1a7848b54ca07a475cf9f.png"></p><h1 id="4、DAO模式及单例模式"><a href="#4、DAO模式及单例模式" class="headerlink" title="4、DAO模式及单例模式"></a>4、DAO模式及单例模式</h1><h2 id="设计模式：https-www-runoob-com-design-pattern-singleton-pattern-html"><a href="#设计模式：https-www-runoob-com-design-pattern-singleton-pattern-html" class="headerlink" title="设计模式：https://www.runoob.com/design-pattern/singleton-pattern.html"></a>设计模式：<a href="https://www.runoob.com/design-pattern/singleton-pattern.html">https://www.runoob.com/design-pattern/singleton-pattern.html</a></h2><h2 id="4-1、DAO模式"><a href="#4-1、DAO模式" class="headerlink" title="4.1、DAO模式"></a>4.1、DAO模式</h2><p>DAO 模式</p><p>DAO (DataAccessobjects 数据存取对象)是指位于业务逻辑和持久化数据之间实现对持久化数据的访问。通俗来讲，就是将数据库操作都封装起来。</p><p>对外提供相应的接口在面向对象设计过程中，有一些”套路”用于解决特定问题称为模式。</p><p>DAO 模式提供了访问关系型数据库系统所需操作的接口，将数据访问和业务逻辑分离对上层提供面向对象的数据访问接口。</p><p>从以上 DAO 模式使用可以看出，DAO 模式的优势就在于它实现了两次隔离。</p><ul><li><p>1、隔离了数据访问代码和业务逻辑代码。业务逻辑代码直接调用DAO方法即可，完全感觉不到数据库表的存在。分工明确，数据访问层代码变化不影响业务逻辑代码,这符合单一职能原则，降低了藕合性，提高了可复用性。</p></li><li><p>2、隔离了不同数据库实现。采用面向接口编程，如果底层数据库变化，如由 MySQL 变成 Oracle 只要增加 DAO 接口的新实现类即可，原有 MySQ 实现不用修改。这符合 “开-闭” 原则。该原则降低了代码的藕合性，提高了代码扩展性和系统的可移植性。</p></li></ul><p>一个典型的DAO 模式主要由以下几部分组成。</p><ul><li><p>1、DAO接口： 把对数据库的所有操作定义成抽象方法，可以提供多种实现。</p></li><li><p>2、DAO 实现类： 针对不同数据库给出DAO接口定义方法的具体实现。</p></li><li><p>3、实体类：用于存放与传输对象数据。</p></li><li><p>4、数据库连接和关闭工具类： 避免了数据库连接和关闭代码的重复使用，方便修改。</p></li></ul><h2 id="4-2、DAO模式封装JDBC再解耦"><a href="#4-2、DAO模式封装JDBC再解耦" class="headerlink" title="4.2、DAO模式封装JDBC再解耦"></a>4.2、DAO模式封装JDBC再解耦</h2><p><img src="/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/WEBRESOURCEe2e6fa1394521576f61580ca14646764.png"></p><h2 id="4-3、单列模式"><a href="#4-3、单列模式" class="headerlink" title="4.3、单列模式"></a>4.3、单列模式</h2><p>单例模式（Singleton Pattern）是 Java 中最简单的设计模式之一。这种类型的设计模式属于创建型模式，它提供了一种创建对象的最佳方式。</p><p>这种模式涉及到一个单一的类，该类负责创建自己的对象，同时确保只有单个对象被创建。这个类提供了一种访问其唯一的对象的方式，可以直接访问，不需要实例化该类的对象。</p><ul><li><p>1、单例类只能有一个实例。</p></li><li><p>2、单例类必须自己创建自己的唯一实例。</p></li><li><p>3、单例类必须给所有其他对象提供这一实例。</p></li></ul><h2 id="4-4、懒汉模式"><a href="#4-4、懒汉模式" class="headerlink" title="4.4、懒汉模式"></a>4.4、懒汉模式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.company.JDBC.Utils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:懒汉模式（多线程问题）</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@time</span>: 2022/5/15 16:57</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigUtil_Lazy</span> &#123;<br><br>    <span class="hljs-keyword">private</span>  Properties properties;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ConfigUtil_Lazy configUtilLazy;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> ConfigUtil_Lazy <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">if</span> (configUtilLazy ==<span class="hljs-literal">null</span>)&#123;<br>            configUtilLazy =<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigUtil_Lazy</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> configUtilLazy;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ConfigUtil_Lazy</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String filePath=<span class="hljs-string">&quot;database.properties&quot;</span>;<br>            inputStream = ConfigUtil_Lazy.class.getClassLoader().getResourceAsStream(filePath);<br>            properties = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>            properties.load(inputStream);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (inputStream!=<span class="hljs-literal">null</span>)&#123;<br>                    inputStream.close();<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getValueByKey</span><span class="hljs-params">(String key)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;getValueByKey key:&quot;</span>+key);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) properties.get(key);<br>        System.out.println(<span class="hljs-string">&quot;getValueByKey key:&quot;</span>+key+<span class="hljs-string">&quot;,value:&quot;</span>+value);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="4-5、饿汉模式"><a href="#4-5、饿汉模式" class="headerlink" title="4.5、饿汉模式"></a>4.5、饿汉模式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.company.JDBC.Utils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:饿汉模式</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@time</span>: 2022/5/15 18:59</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigUtil_Hunger</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Properties properties;<br><br>    <span class="hljs-comment">//方式1:直接创建实体类对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ConfigUtil_Hunger</span> <span class="hljs-variable">configUtil_hunger</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigUtil_Hunger</span>();<br><br><span class="hljs-comment">//    //方式2：在静态代码块中创建实体类对象</span><br><span class="hljs-comment">//    public static ConfigUtil_Hunger configUtil_hunger;</span><br><span class="hljs-comment">//    static &#123;</span><br><span class="hljs-comment">//        configUtil_hunger = new ConfigUtil_Hunger();</span><br><span class="hljs-comment">//    &#125;</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ConfigUtil_Hunger <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> configUtil_hunger;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ConfigUtil_Hunger</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String filePath=<span class="hljs-string">&quot;database.properties&quot;</span>;<br>            inputStream = ConfigUtil_Hunger.class.getClassLoader().getResourceAsStream(filePath);<br>            properties = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>            properties.load(inputStream);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (inputStream!=<span class="hljs-literal">null</span>)&#123;<br>                    inputStream.close();<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getValueByKey</span><span class="hljs-params">(String key)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;getValueByKey key:&quot;</span>+key);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) properties.get(key);<br>        System.out.println(<span class="hljs-string">&quot;getValueByKey key:&quot;</span>+key+<span class="hljs-string">&quot;,value:&quot;</span>+value);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="4-6、枚举式"><a href="#4-6、枚举式" class="headerlink" title="4.6、枚举式"></a>4.6、枚举式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.company.JDBC.Utils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:枚举单列模式</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@time</span>: 2022/5/15 19:08</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ConfigUtil_Enum</span> &#123;<br><br>    INSTANCE;<br><br>    <span class="hljs-keyword">private</span> Properties properties;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ConfigUtil_Enum</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String filePath=<span class="hljs-string">&quot;database.properties&quot;</span>;<br>            inputStream = ConfigUtil_Hunger.class.getClassLoader().getResourceAsStream(filePath);<br>            properties = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>            properties.load(inputStream);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (inputStream!=<span class="hljs-literal">null</span>)&#123;<br>                    inputStream.close();<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getValueByKey</span><span class="hljs-params">(String key)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;getValueByKey key:&quot;</span>+key);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) properties.get(key);<br>        System.out.println(<span class="hljs-string">&quot;getValueByKey key:&quot;</span>+key+<span class="hljs-string">&quot;,value:&quot;</span>+value);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="5、数据源及分层开发"><a href="#5、数据源及分层开发" class="headerlink" title="5、数据源及分层开发"></a>5、数据源及分层开发</h1><h2 id="5-1、理解数据源、连接池的作用"><a href="#5-1、理解数据源、连接池的作用" class="headerlink" title="5.1、理解数据源、连接池的作用"></a>5.1、理解数据源、连接池的作用</h2><p>之前的方式访问数据库存在一些缺陷：</p><ul><li><p>访问前现需要先获取连接</p></li><li><p>每次操作结束后，需要释放资源</p></li><li><p>频繁的连接导致系统的安全性和稳定性差</p></li></ul><p>使用数据源、连接池可以解决这些问题。</p><p><img src="/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/WEBRESOURCEe1a20d7470c4336cf0f7ebeb24e5a0aa.png"></p><p><img src="/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/WEBRESOURCE792286b57b3af693bd16a256c1b768f4.png"></p><h2 id="5-2、掌握JNDI连接数据库（JNDI会出现严重的漏洞）"><a href="#5-2、掌握JNDI连接数据库（JNDI会出现严重的漏洞）" class="headerlink" title="5.2、掌握JNDI连接数据库（JNDI会出现严重的漏洞）"></a>5.2、掌握JNDI连接数据库（JNDI会出现严重的漏洞）</h2><p>通过JNDI–获取–&gt;DataSource–创建好连接对象–&gt;Connection—-&gt;连接池（管理连接对象）</p><p>1、修改Tomcat中conf的context.xml配置文件内容</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&lt;Resource <span class="hljs-attribute">auth</span>=<span class="hljs-string">&quot;Container&quot;</span> <span class="hljs-attribute">driverClassName</span>=<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span><br>          <span class="hljs-attribute">maxActive</span>=<span class="hljs-string">&quot;100&quot;</span> <span class="hljs-attribute">maxIdle</span>=<span class="hljs-string">&quot;30&quot;</span> <span class="hljs-attribute">maxWait</span>=<span class="hljs-string">&quot;10000&quot;</span><br>          <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;jdbc/news&quot;</span> <span class="hljs-attribute">password</span>=<span class="hljs-string">&quot;123456&quot;</span> <span class="hljs-attribute">type</span>=<span class="hljs-string">&quot;javax.sql.DataSource&quot;</span><br>          <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/javaweb&quot;</span> <span class="hljs-attribute">username</span>=<span class="hljs-string">&quot;root&quot;</span>/&gt;<br></code></pre></td></tr></table></figure><p>2、使用JNDI获取数据源，使用数据源获取连接对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *<span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment">    通过数据源获取数据库连接对象</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span>:</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@time</span>: 2022/5/16 8:48</span><br><span class="hljs-comment">  */</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getConnection2</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//初始化上下文对象</span><br>        <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        <span class="hljs-comment">//获取与逻辑名称相关联的数据源对象</span><br>        <span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> (DataSource) context.lookup(<span class="hljs-string">&quot;java:comp/env/jdbc/news&quot;</span>);<br>        <span class="hljs-comment">//通过数据源获取数据库连接</span><br>        connection = dataSource.getConnection();<br>    &#125; <span class="hljs-keyword">catch</span> (NamingException e) &#123;<br>        e.printStackTrace();<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-3、使用JavaBean传递数据"><a href="#5-3、使用JavaBean传递数据" class="headerlink" title="5.3、使用JavaBean传递数据"></a>5.3、使用JavaBean传递数据</h2><p>JavaBean（pojo、entity、DTO、VO…）</p><ul><li><p>就是一个Java类</p></li><li><p>封装业务逻辑</p></li><li><p>封装数据</p></li></ul><p>列如：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs typescript">package com.<span class="hljs-property">company</span>.<span class="hljs-property">JavaBean</span>.<span class="hljs-property">pojo</span>;<br><br><span class="hljs-keyword">import</span> java.<span class="hljs-property">io</span>.<span class="hljs-property">Serializable</span>;<br><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Date</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:新闻JavaBean：封装数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@time</span>: 2022/5/16 10:52</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">News</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final long serialVersionUID = -2227279597126347529L;<br><br>    <span class="hljs-keyword">private</span> int id;<br>    <span class="hljs-keyword">private</span> int categoryId;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> title;<br>    <span class="hljs-keyword">private</span>  <span class="hljs-title class_">String</span> summary;<br>    <span class="hljs-keyword">private</span>  <span class="hljs-title class_">String</span> content;<br>    <span class="hljs-keyword">private</span>  <span class="hljs-title class_">String</span> picPath;<br>    <span class="hljs-keyword">private</span>  <span class="hljs-title class_">String</span> author;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Date</span> createDate;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Date</span> modifyDate;<br><br>    <span class="hljs-keyword">public</span> int <span class="hljs-title function_">getId</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setId</span>(<span class="hljs-params">int id</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;<br>    &#125;<br>    <span class="hljs-keyword">public</span> int <span class="hljs-title function_">getCategoryId</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> categoryId;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setCategoryId</span>(<span class="hljs-params">int categoryId</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">categoryId</span> = categoryId;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getTitle</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> title;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setTitle</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> title</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = title;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getSummary</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> summary;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setSummary</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> summary</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">summary</span> = summary;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getContent</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> content;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setContent</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> content</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span> = content;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPicPath</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> picPath;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setPicPath</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> picPath</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">picPath</span> = picPath;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getAuthor</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> author;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setAuthor</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> author</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">author</span> = author;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Date</span> <span class="hljs-title function_">getCreateDate</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> createDate;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setCreateDate</span>(<span class="hljs-params"><span class="hljs-built_in">Date</span> createDate</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">createDate</span> = createDate;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Date</span> <span class="hljs-title function_">getModifyDate</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> modifyDate;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setModifyDate</span>(<span class="hljs-params"><span class="hljs-built_in">Date</span> modifyDate</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">modifyDate</span> = modifyDate;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">toString</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;News&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;id=&quot;</span> + id +<br>                <span class="hljs-string">&quot;, categoryId=&quot;</span> + categoryId +<br>                <span class="hljs-string">&quot;, title=&#x27;&quot;</span> + title + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, summary=&#x27;&quot;</span> + summary + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, content=&#x27;&quot;</span> + content + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, picPath=&#x27;&quot;</span> + picPath + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, author=&#x27;&quot;</span> + author + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, createDate=&quot;</span> + createDate +<br>                <span class="hljs-string">&quot;, modifyDate=&quot;</span> + modifyDate +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>idea如何设置实体类自动生成SerialVersionUID：</p><p>IDEA的File-&gt;Settings-&gt;Editor-&gt;Inspections,然后在搜索框输入serialV，出现对应的</p><p>选择：</p><ul><li><p>Serializable class without ‘serialVersionUID’</p></li><li><p>‘serialVersionUID’ field not declared ‘private static final long’</p></li></ul><p>然后点击需要添加serialVersionUID的实体类名，Alt+Enter，出现Add ‘serialVersionUID’ field，即可给类添加serialVersionUID标识。</p><p><img src="/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/WEBRESOURCEb4ff26f268f66c89eada8da65f986f0e.png"></p><h2 id="5-4、对service层的剥离"><a href="#5-4、对service层的剥离" class="headerlink" title="5.4、对service层的剥离"></a>5.4、对service层的剥离</h2><p>Controller—-&gt;service接口—-&gt;serviceImpl—-&gt;dao接口—-&gt;daoImpl—-&gt;mapper—-&gt;database</p><p>注：现阶段使用JSP直接调用service接口、daoImpl直接调用database，但在实际应用中，这种方法并不适用。各层之间使用JavaBean传递数据，即封装好的实体类。</p><h2 id="5-5、对MVC（Model、View、Controller）三层模式的初步解析"><a href="#5-5、对MVC（Model、View、Controller）三层模式的初步解析" class="headerlink" title="5.5、对MVC（Model、View、Controller）三层模式的初步解析"></a>5.5、对MVC（Model、View、Controller）三层模式的初步解析</h2><p>Model：模型代表一个存取数据的对象或 JAVA POJO。它也可以带有逻辑，在数据变化时更新控制器。</p><p>View： 视图代表模型包含的数据的可视化。</p><p>Controller： 控制器作用于模型和视图上。它控制数据流向模型对象，并在数据变化时更新视图。它使视图与模型分离开。</p><p>例如：</p><p><img src="/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/WEBRESOURCE73ea99d61d1f3d1b66cee9aa720aec3f.png"></p><h2 id="5-6、JSTL（JavaServer-Pages-Standard-Tag-Library：JSP标准标签库）"><a href="#5-6、JSTL（JavaServer-Pages-Standard-Tag-Library：JSP标准标签库）" class="headerlink" title="5.6、JSTL（JavaServer Pages Standard Tag Library：JSP标准标签库）"></a>5.6、JSTL（JavaServer Pages Standard Tag Library：JSP标准标签库）</h2><p>暂时了解以下三个标签：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">jsp:forward</span> <span class="hljs-attr">page</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">jsp:forward</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">jsp:useBean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">jsp:useBean</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">jsp:include</span> <span class="hljs-attr">page</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">jsp:include</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="6、第三方控件"><a href="#6、第三方控件" class="headerlink" title="6、第三方控件"></a>6、第三方控件</h1><h2 id="6-1、CKeditor"><a href="#6-1、CKeditor" class="headerlink" title="6.1、CKeditor"></a>6.1、CKeditor</h2><p>略</p><h2 id="6-2、使用comons-fileupload-jar实现文件上传下载"><a href="#6-2、使用comons-fileupload-jar实现文件上传下载" class="headerlink" title="6.2、使用comons-fileupload.jar实现文件上传下载"></a>6.2、使用comons-fileupload.jar实现文件上传下载</h2><h3 id="6-2-1、上传"><a href="#6-2-1、上传" class="headerlink" title="6.2.1、上传"></a>6.2.1、上传</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">package com.company.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Javaweb</span>.</span></span>servlet;<br><br>import com.company.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Javaweb</span>.</span></span>pojo.News;<br>import com.company.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Javaweb</span>.</span></span>service.Impl.NewsServiceImpl;<br>import com.company.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Javaweb</span>.</span></span>service.NewsService;<br>import org.apache.commons.fileupload.FileItem;<br>import org.apache.commons.fileupload.FileItemFactory;<br>import org.apache.commons.fileupload.FileUploadException;<br>import org.apache.commons.fileupload.disk.DiskFileItemFactory;<br>import org.apache.commons.fileupload.servlet.ServletFileUpload;<br>import org.apache.commons.io.FilenameUtils;<br><br>import javax.servlet.ServletException;<br>import javax.servlet.http.HttpServlet;<br>import javax.servlet.http.HttpServletRequest;<br>import javax.servlet.http.HttpServletResponse;<br>import java.io.File;<br>import java.io.IOException;<br>import java.util.Date;<br>import java.util.List;<br>import java.util.UUID;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @description:用户增加新闻的处理Servlet，接收用户表单提交的新闻数据，调用Service的方法将新闻保存大哦数据库，跳转到新闻列表页面</span><br><span class="hljs-comment"> * @author: Kblayt</span><br><span class="hljs-comment"> * @time: 2022/5/23 18:49</span><br><span class="hljs-comment"> */</span><br>public <span class="hljs-keyword">class</span> AddServlet extends HttpServlet &#123;<br><br>    @Override<br>    protected void <span class="hljs-keyword">do</span><span class="hljs-constructor">Get(HttpServletRequest <span class="hljs-params">request</span>, HttpServletResponse <span class="hljs-params">response</span>)</span> throws ServletException, IOException &#123;<br>        this.<span class="hljs-keyword">do</span><span class="hljs-constructor">Post(<span class="hljs-params">request</span>, <span class="hljs-params">response</span>)</span>;<br>    &#125;<br><br>    @Override<br>    protected void <span class="hljs-keyword">do</span><span class="hljs-constructor">Post(HttpServletRequest <span class="hljs-params">request</span>, HttpServletResponse <span class="hljs-params">response</span>)</span> throws ServletException, IOException &#123;<br>        request.set<span class="hljs-constructor">CharacterEncoding(<span class="hljs-string">&quot;utf-8&quot;</span>)</span>;<br>        News news=<span class="hljs-keyword">new</span> <span class="hljs-constructor">News()</span>;<br>        news.set<span class="hljs-constructor">CreateDate(<span class="hljs-params">new</span> Date()</span>);<br>        NewsService newsService=<span class="hljs-keyword">new</span> <span class="hljs-constructor">NewsServiceImpl()</span>;<br>        <span class="hljs-comment">//判断类型</span><br>        boolean isM= <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ServletFileUpload</span>.</span></span>is<span class="hljs-constructor">MultipartContent(<span class="hljs-params">request</span>)</span>;<br>        <span class="hljs-keyword">if</span>(isM)&#123;<br>            <span class="hljs-comment">//from 表单提示正确</span><br>            FileItemFactory fi=<span class="hljs-keyword">new</span> <span class="hljs-constructor">DiskFileItemFactory()</span>;<br>            ServletFileUpload sfu=<span class="hljs-keyword">new</span> <span class="hljs-constructor">ServletFileUpload(<span class="hljs-params">fi</span>)</span>;<br>            List&lt;FileItem&gt; <span class="hljs-built_in">list</span>= null;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-built_in">list</span> = sfu.parse<span class="hljs-constructor">Request(<span class="hljs-params">request</span>)</span>;<br>            &#125; catch (FileUploadException e) &#123;<br>                e.print<span class="hljs-constructor">StackTrace()</span>;<br>            &#125;<br>            <span class="hljs-keyword">for</span>(FileItem item:<span class="hljs-built_in">list</span>)&#123;<br>                <span class="hljs-comment">//判断类型，选择存值</span><br>                <span class="hljs-keyword">if</span>(item.is<span class="hljs-constructor">FormField()</span>)&#123;<br>                    <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;title&quot;</span>.equals(item.get<span class="hljs-constructor">FieldName()</span>))&#123;<br>                        news.set<span class="hljs-constructor">Title(<span class="hljs-params">item</span>.<span class="hljs-params">getString</span>(<span class="hljs-string">&quot;utf-8&quot;</span>)</span>);<br>                    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;summary&quot;</span>.equals(item.get<span class="hljs-constructor">FieldName()</span>))&#123;<br>                        news.set<span class="hljs-constructor">Summary(<span class="hljs-params">item</span>.<span class="hljs-params">getString</span>(<span class="hljs-string">&quot;utf-8&quot;</span>)</span>);<br>                    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;newscontent&quot;</span>.equals(item.get<span class="hljs-constructor">FieldName()</span>))&#123;<br>                        news.set<span class="hljs-constructor">Content(<span class="hljs-params">item</span>.<span class="hljs-params">getString</span>(<span class="hljs-string">&quot;utf-8&quot;</span>)</span>);<br>                    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;picPath&quot;</span>.equals(item.get<span class="hljs-constructor">FieldName()</span>))&#123;<br>                        news.set<span class="hljs-constructor">PicPath(<span class="hljs-params">item</span>.<span class="hljs-params">getString</span>(<span class="hljs-string">&quot;utf-8&quot;</span>)</span>);<br>                    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;author&quot;</span>.equals(item.get<span class="hljs-constructor">FieldName()</span>))&#123;<br>                        news.set<span class="hljs-constructor">Author(<span class="hljs-params">item</span>.<span class="hljs-params">getString</span>(<span class="hljs-string">&quot;utf-8&quot;</span>)</span>);<br>                    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;categoryId&quot;</span>.equals(item.get<span class="hljs-constructor">FieldName()</span>))&#123;<br>                        String s=item.get<span class="hljs-constructor">String(<span class="hljs-string">&quot;utf-8&quot;</span>)</span>;<br>                        news.set<span class="hljs-constructor">CategoryId(Integer.<span class="hljs-params">parseInt</span>(<span class="hljs-params">s</span>)</span>);<br>                    &#125;<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-comment">//文件的上传</span><br>                    String filename=item.get<span class="hljs-constructor">Name()</span>;<br>                    <span class="hljs-keyword">if</span>(filename!=null &amp;&amp;!<span class="hljs-string">&quot;&quot;</span>.equals(filename))&#123;<br>                        <span class="hljs-comment">//分割后缀名</span><br>                        String endName=<span class="hljs-string">&quot;.&quot;</span>+ <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">FilenameUtils</span>.</span></span>get<span class="hljs-constructor">Extension(<span class="hljs-params">filename</span>)</span>;<br>                        <span class="hljs-comment">//拼接完整路径</span><br>                        String picPath=<span class="hljs-string">&quot;d:/&quot;</span>+ <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">UUID</span>.</span></span>random<span class="hljs-constructor">UUID()</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>+endName;<br>                        news.set<span class="hljs-constructor">PicPath(<span class="hljs-params">picPath</span>)</span>;<br>                        <span class="hljs-comment">//根据路径封装文件</span><br>                        File file=<span class="hljs-keyword">new</span> <span class="hljs-constructor">File(<span class="hljs-params">picPath</span>)</span>;<br>                        <span class="hljs-comment">//上传</span><br>                        <span class="hljs-keyword">try</span> &#123;<br>                            item.write(file);<br>                        &#125; catch (Exception e) &#123;<br>                            e.print<span class="hljs-constructor">StackTrace()</span>;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        boolean flag=newsService.add<span class="hljs-constructor">News(<span class="hljs-params">news</span>)</span>;<br>        <span class="hljs-keyword">if</span>(flag)&#123;<br>            response.send<span class="hljs-constructor">Redirect(<span class="hljs-string">&quot;/admin/newsDetailList.jsp&quot;</span>)</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="6-2-2、下载"><a href="#6-2-2、下载" class="headerlink" title="6.2.2、下载"></a>6.2.2、下载</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.company.Javaweb.servlet;<br><br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.ServletOutputStream;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@time</span>: 2022/5/24 10:48</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DownloadServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-built_in">this</span>.doPost(request, response);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br><span class="hljs-comment">//        JSP页面中实现需要关闭 out</span><br><span class="hljs-comment">//        out.clear();</span><br><span class="hljs-comment">//        out=pageContext.pushBody();</span><br><span class="hljs-comment">//        //根据路径 获取文件</span><br>        String picPath=request.getParameter(<span class="hljs-string">&quot;picPath&quot;</span>);<br>        File file=<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(picPath);<br>        <span class="hljs-keyword">if</span>(file.exists())&#123;<br>            <span class="hljs-comment">//设置相应类型</span><br>            response.setContentType(<span class="hljs-string">&quot;application/x-msdownload&quot;</span>);<br>            <span class="hljs-comment">//设置相应头</span><br>            response.setHeader(<span class="hljs-string">&quot;Content-Disposition&quot;</span>, <span class="hljs-string">&quot;attachment;filename=&quot;</span>+picPath);<br>            <span class="hljs-comment">//获取输入输出流</span><br>            InputStream is=<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);<br>            ServletOutputStream sos=response.getOutputStream();<br>            <span class="hljs-comment">//使用字节流输出</span><br>            <span class="hljs-type">byte</span> []b=<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> len=<span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">while</span>((len=is.read(b))!=-<span class="hljs-number">1</span>)&#123;<br>                sos.write(b, <span class="hljs-number">0</span>, len);<br>            &#125;<br>            sos.close();<br>            is.close();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="7、分页查询"><a href="#7、分页查询" class="headerlink" title="7、分页查询"></a>7、分页查询</h1><h1 id="8、EL-Expression-Language-与JSTL-JavaServerPages-Standard-Tag-Library"><a href="#8、EL-Expression-Language-与JSTL-JavaServerPages-Standard-Tag-Library" class="headerlink" title="8、EL(Expression Language)与JSTL(JavaServerPages Standard Tag Library)"></a>8、EL(Expression Language)与JSTL(JavaServerPages Standard Tag Library)</h1><h2 id="8-1、EL表达式"><a href="#8-1、EL表达式" class="headerlink" title="8.1、EL表达式"></a>8.1、EL表达式</h2><p>为什么要使用EL表达式</p><ul><li><p>JSP脚本有哪些不足</p></li><li><p>代码结构混乱</p></li><li><p>脚本与HTML混合，容易出错</p></li><li><p>代码不宜与维护</p></li><li><p>使用EL表达式来优化程序代码，增加程序可读性</p></li></ul><h2 id="8-2、EL语法"><a href="#8-2、EL语法" class="headerlink" title="8.2、EL语法"></a>8.2、EL语法</h2><p>EL表达式</p><ul><li>${EL 表达式}例如：${username}</li></ul><p>EL操作符</p><ul><li><p>操作符“.”</p></li><li><p>获取对象的属性，例如：${news.title}</p></li><li><p>操作符“[]”</p></li><li><p>获取对象的属性，例如：${news[“title”]}</p></li><li><p>获取集合中的对象，例如：newsList[0]</p></li></ul><p><img src="/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/WEBRESOURCE49988252cc330d20f8b4642a6b94ec11.png"></p><p><img src="/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/WEBRESOURCE444b5dbab8a3186b87439ffb875e0bc6.png"></p><h2 id="8-3、JSTL介绍"><a href="#8-3、JSTL介绍" class="headerlink" title="8.3、JSTL介绍"></a>8.3、JSTL介绍</h2><ul><li><p>JSTL</p></li><li><p>JSP标准标签库</p></li><li><p>实现JSP页面中的逻辑控制</p></li><li><p>JSTL使用步骤</p></li><li><p>添加jstl.jar和standard.jar包</p></li><li><p>在JSP页面中添加如下指令</p></li></ul><p>&lt;%@ taglib uri&#x3D;”<a href="http://java.sun.com/jsp/jstl/core&quot;">http://java.sun.com/jsp/jstl/core&quot;</a> prefix&#x3D;”c”%&gt;</p><p>&lt;%@ taglib uri&#x3D;”<a href="http://java.sun.com/jsp/jstl/fmt&quot;">http://java.sun.com/jsp/jstl/fmt&quot;</a> prefix&#x3D;”fmt”%&gt;</p><p><img src="/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/WEBRESOURCE2489f52d280439c37df16ec02776723c.png"></p><h1 id="9、Servlet"><a href="#9、Servlet" class="headerlink" title="9、Servlet"></a>9、Servlet</h1><h2 id="9-1、Servlet生命周期"><a href="#9-1、Servlet生命周期" class="headerlink" title="9.1、Servlet生命周期"></a>9.1、Servlet生命周期</h2><p><img src="/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/WEBRESOURCE7f1a9492e9fe6eab45a38d07e88d749b.png"></p><h2 id="9-2、ServletAPI"><a href="#9-2、ServletAPI" class="headerlink" title="9.2、ServletAPI"></a>9.2、ServletAPI</h2><ul><li><p>javax.servlet.Servlet接口</p></li><li><p>所有Java Servlet的基础接口类，规定了必须由Servlet具体类实现的方法集。</p></li><li><p>javax.setvlet.GenericServlet类</p></li><li><p>是Servlet的通用版本，是一种与协议无关的Servlet</p></li><li><p>javax.servlet.http.HttpServlet类</p></li><li><p>在GenericServlet基础上扩展的基于Http协议的Servlet</p></li></ul><h2 id="9-3、Servlet中主要方法"><a href="#9-3、Servlet中主要方法" class="headerlink" title="9.3、Servlet中主要方法"></a>9.3、Servlet中主要方法</h2><ul><li><p>init()：Servlet的初始化方法，仅仅会执行一次。</p></li><li><p>service()：处理请求和生成响应。（派发器，用户请求类型调用响应的doGet()、doPost()）</p></li><li><p>doGet()：</p></li><li><p>doPost()：</p></li><li><p>destroy：在服务器停止并且程序中的Servlet对象不再使用的时候调用，只执行一次。</p></li></ul><h2 id="9-4、Servlet中重定向和转发相对路径和绝对路径问题"><a href="#9-4、Servlet中重定向和转发相对路径和绝对路径问题" class="headerlink" title="9.4、Servlet中重定向和转发相对路径和绝对路径问题"></a>9.4、Servlet中重定向和转发相对路径和绝对路径问题</h2><p>HttpServletResponse 重定向response.sendRedirect()</p><p>若当前路径为：<a href="http://localhost:8080/Javaweb/servlet/AddServlet.class">http://localhost:8080/Javaweb/servlet/AddServlet.class</a></p><ul><li><p>相对路径</p></li><li><p>response.sendRedirect(“newsDetailList.jsp”);</p></li><li><p>实际访问路径为：<a href="http://localhost:8080/Javaweb/servlet/newsDetailList.jsp">http://localhost:8080/Javaweb/servlet/newsDetailList.jsp</a></p></li><li><p>绝对路径</p></li><li><p>response.sendRedirect(“&#x2F;Javaweb&#x2F;jsp&#x2F;admin&#x2F;newsDetailList.jsp”);</p></li><li><p>实际访问路径为：<a href="http://localhost:8080/Javaweb/jsp/admin/newsDetailList.jsp">http://localhost:8080/Javaweb/jsp/admin/newsDetailList.jsp</a></p></li></ul><p>HttpServletRequest转发request.getRequestDispatcher().forword()</p><p>若当前路径为：<a href="http://localhost:8080/Javaweb/servlet/AddServlet.class">http://localhost:8080/Javaweb/servlet/AddServlet.class</a></p><ul><li><p>相对路径</p></li><li><p>request.getRequestDispatcher(“newsDetailList.jsp”).forword(request,response)</p></li><li><p>实际访问路径为：<a href="http://localhost:8080/Javaweb/servlet/newsDetailList.jsp">http://localhost:8080/Javaweb/servlet/newsDetailList.jsp</a></p></li><li><p>绝对路径</p></li><li><p>request.getRequestDispatcher(“&#x2F;jsp&#x2F;admin&#x2F;newsDetailList.jsp”).forword(request,response)</p></li><li><p>实际访问路径为：<a href="http://localhost:8080/Javaweb/jsp/admin/newsDetailList.jsp">http://localhost:8080/Javaweb/jsp/admin/newsDetailList.jsp</a></p></li></ul><h1 id="10、Filter-过滤器-和Listener-监听器"><a href="#10、Filter-过滤器-和Listener-监听器" class="headerlink" title="10、Filter(过滤器)和Listener(监听器)"></a>10、Filter(过滤器)和Listener(监听器)</h1><h2 id="10-1、过滤器"><a href="#10-1、过滤器" class="headerlink" title="10.1、过滤器"></a>10.1、过滤器</h2><ul><li><p>是向Web应用程序的请求和响应添加功能的Web服务组件</p></li><li><p>过滤器可以统一的集中处理请求和响应</p></li><li><p>使用过滤器技术实现对请求数据的过滤</p></li></ul><p><img src="/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/WEBRESOURCE277454b3d7603570f51d24dcbf05ccbd.png"></p><p><img src="/2022/10/21/JavaWeb+SSM+SpringBoot/JavaWeb/WEBRESOURCEe7df8ee34688604773aef094dcd20911.png"></p><p>过滤器的生命周期</p><p>init()（初始化）</p><p>doFilter()（执行过滤器）</p><p>destroy()（销毁）</p><h2 id="10-2、监听器"><a href="#10-2、监听器" class="headerlink" title="10.2、监听器"></a>10.2、监听器</h2><ul><li><p>Listener是Servlet的监听器</p></li><li><p>监听客户端的请求和服务器端的操作、</p></li><li><p>通过实现Listener接口的类可以在特定事件(Event)发生时，自动激发一些操作</p></li></ul><h3 id="10-2-1、HttpSessionBindingListener"><a href="#10-2-1、HttpSessionBindingListener" class="headerlink" title="10.2.1、HttpSessionBindingListener"></a>10.2.1、HttpSessionBindingListener</h3><ul><li><p>HttpSessionBindingListener</p></li><li><p>当一个实现了该接口的对象被捆绑到session中或从session中被解放的时候启用此监听器()session的值发生改变的时候)</p></li><li><p>关键点</p></li><li><p>创建实现HttpSessionBindingListener接口</p></li><li><p>valueBound()</p></li><li><p>valueUnbound()</p></li><li><p>不需要再web.xml中配置监听器</p></li><li><p>监听范围：一对一</p></li></ul><h3 id="10-2-2、HttpSessionListener"><a href="#10-2-2、HttpSessionListener" class="headerlink" title="10.2.2、HttpSessionListener"></a>10.2.2、HttpSessionListener</h3><ul><li><p>HttpSessionListener</p></li><li><p>在Web应用中，当一个session被创建或者被销毁时启用这个监听器</p></li><li><p>关键点</p></li><li><p>sessionCreate(HttpSessionEvent event)</p></li><li><p>客户第一次和服务器交互时触发</p></li><li><p>sessionDestroyed(HttpSessionEvent event)</p></li><li><p>销毁会话的时候触发</p></li><li><p>必须在web.xml中配置监听器</p></li><li><p>监听范围：这只一次就可以监听所有session</p></li></ul><h2 id="10-2-2、HttpContextListener"><a href="#10-2-2、HttpContextListener" class="headerlink" title="10.2.2、HttpContextListener"></a>10.2.2、HttpContextListener</h2><ul><li><p>HttpContextListener</p></li><li><p>在web应用中，当一个容器产生或销毁时启用这个监听器</p></li></ul><h1 id="11、Ajax与Jquery的使用"><a href="#11、Ajax与Jquery的使用" class="headerlink" title="11、Ajax与Jquery的使用"></a>11、Ajax与Jquery的使用</h1><p>参考：<a href="https://note.youdao.com/s/48YEmaJu">https://note.youdao.com/s/48YEmaJu</a></p><h1 id="12、实现在Linux上的项目部署"><a href="#12、实现在Linux上的项目部署" class="headerlink" title="12、实现在Linux上的项目部署"></a>12、实现在Linux上的项目部署</h1><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>JavaWeb+SSM+SpringBoot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JavaWeb</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git</title>
    <link href="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/"/>
    <url>/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/</url>
    
    <content type="html"><![CDATA[<h1 id="1、版本控制"><a href="#1、版本控制" class="headerlink" title="1、版本控制"></a>1、版本控制</h1><h2 id="1-1、什么是版本控制"><a href="#1-1、什么是版本控制" class="headerlink" title="1.1、什么是版本控制"></a>1.1、什么是版本控制</h2><p>版本控制（Revision control）是一种在开发的过程中用于管理我们对文件、目录或工程等内容的修改历史，方便查看更改历史记录，备份以便恢复以前的版本的软件工程技术。</p><ul><li><p>实现跨区域多人协同开发</p></li><li><p>追踪和记载一个或者多个文件的历史记录</p></li><li><p>组织和保护你的源代码和文档</p></li><li><p>统计工作量</p></li><li><p>并行开发、提高开发效率</p></li><li><p>跟踪记录整个软件的开发过程</p></li><li><p>减轻开发人员的负担，节省时间，同时降低人为错误</p></li></ul><p>简单说就是用于管理多人协同开发项目的技术。</p><p>没有进行版本控制或者版本控制本身缺乏正确的流程管理，在软件开发过程中将会引入很多问题，如软件代码的一致性、软件内容的冗余、软件过程的事物性、软件开发过程中的并发性、软件源代码的安全性，以及软件的整合等问题。</p><p>无论是工作还是学习，或者是自己做笔记，都经历过这样一个阶段！我们就迫切需要一个版本控制工具！</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCE5781b88d50a965f6baa98c08f3bdc81d.jpeg"></p><p>多人开发就必须要使用版本控制！</p><h2 id="1-2、常见的版本控制工具"><a href="#1-2、常见的版本控制工具" class="headerlink" title="1.2、常见的版本控制工具"></a>1.2、常见的版本控制工具</h2><p>我们学习的东西，一定是当下最流行的！</p><p>主流的版本控制器有如下这些：</p><ul><li><p>Git</p></li><li><p>SVN（Subversion）</p></li><li><p>CVS（Concurrent Versions System）</p></li><li><p>VSS（Micorosoft Visual SourceSafe）</p></li><li><p>TFS（Team Foundation Server）</p></li><li><p>Visual Studio Online</p></li></ul><p>版本控制产品非常的多（Perforce、Rational ClearCase、RCS（GNU Revision Control System）、Serena Dimention、SVK、BitKeeper、Monotone、Bazaar、Mercurial、SourceGear Vault），现在影响力最大且使用最广泛的是Git与SVN</p><h2 id="1-3版本控制分类"><a href="#1-3版本控制分类" class="headerlink" title="1.3版本控制分类"></a>1.3版本控制分类</h2><h3 id="1-3-1、本地版本控制"><a href="#1-3-1、本地版本控制" class="headerlink" title="1.3.1、本地版本控制"></a>1.3.1、本地版本控制</h3><p>记录文件每次的更新，可以对每个版本做一个快照，或是记录补丁文件，适合个人用，如RCS。</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCE34d172540721e9729fe384f7eed4653a.png"></p><h3 id="1-3-2、集中版本控制-SVN"><a href="#1-3-2、集中版本控制-SVN" class="headerlink" title="1.3.2、集中版本控制  SVN"></a>1.3.2、集中版本控制  SVN</h3><p>所有的版本数据都保存在服务器上，协同开发者从服务器上同步更新或上传自己的修改</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCE6a78ce9141d1732ca8bd879058b34116.png"></p><p>所有的版本数据都存在服务器上，用户的本地只有自己以前所同步的版本，如果不连网的话，用户就看不到历史版本，也无法切换版本验证问题，或在不同分支工作。而且，所有数据都保存在单一的服务器上，有很大的风险这个服务器会损坏，这样就会丢失所有的数据，当然可以定期备份。代表产品：SVN、CVS、VSS</p><h3 id="1-3-3、分布式版本控制-Git"><a href="#1-3-3、分布式版本控制-Git" class="headerlink" title="1.3.3、分布式版本控制 Git"></a>1.3.3、分布式版本控制 Git</h3><p>每个人都拥有全部的代码！安全隐患！</p><p>所有版本信息仓库全部同步到本地的每个用户，这样就可以在本地查看所有版本历史，可以离线在本地提交，只需在连网时push到相应的服务器或其他用户那里。由于每个用户那里保存的都是所有的版本数据，只要有一个用户的设备没有问题就可以恢复所有的数据，但这增加了本地存储空间的占用。</p><p>不会因为服务器损坏或者网络问题，造成不能工作的情况！</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCEacdf78d4e5d49ec15b4e1d76fb8cc1c3.jpeg"></p><h2 id="1-4、Git与SVN的主要区别"><a href="#1-4、Git与SVN的主要区别" class="headerlink" title="1.4、Git与SVN的主要区别"></a>1.4、Git与SVN的主要区别</h2><p>SVN是集中式版本控制系统，版本库是集中放在中央服务器的，而工作的时候，用的都是自己的电脑，所以首先要从中央服务器得到最新的版本，然后工作，完成工作后，需要把自己做完的活推送到中央服务器。集中式版本控制系统是必须联网才能工作，对网络带宽要求较高。</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCEd57ed7f0e43c5642ac5c107ea02ab7e4.jpeg"></p><p>Git是分布式版本控制系统，没有中央服务器，每个人的电脑就是一个完整的版本库，工作的时候不需要联网了，因为版本都在自己电脑上。协同的方法是这样的：比如说自己在电脑上改了文件A，其他人也在电脑上改了文件A，这时，你们两之间只需把各自的修改推送给对方，就可以互相看到对方的修改了。Git可以直接看到更新了哪些代码和文件！</p><p>Git是目前世界上最先进的分布式版本控制系统。</p><h1 id="2、聊聊Git的历史"><a href="#2、聊聊Git的历史" class="headerlink" title="2、聊聊Git的历史"></a>2、聊聊Git的历史</h1><p>同生活中的许多伟大事物一样，Git 诞生于一个极富纷争大举创新的年代。</p><p>Linux 内核开源项目有着为数众广的参与者。绝大多数的 Linux 内核维护工作都花在了提交补丁和保存归档的繁琐事务上(1991－2002年间)。到 2002 年，整个项目组开始启用一个专有的分布式版本控制系统 BitKeeper 来管理和维护代码。</p><p>Linux社区中存在很多的大佬！破解研究 BitKeeper ！</p><p>到了 2005 年，开发 BitKeeper 的商业公司同 Linux 内核开源社区的合作关系结束，他们收回了 Linux 内核社区免费使用 BitKeeper 的权力。这就迫使 Linux 开源社区(特别是 Linux 的缔造者 Linus Torvalds)基于使用 BitKeeper 时的经验教训，开发出自己的版本系统。（2周左右！） 也就是后来的 Git！</p><p>Git是目前世界上最先进的分布式版本控制系统。</p><p>Git是免费、开源的，最初Git是为辅助 Linux 内核开发的，来替代 BitKeeper！</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCEe91ebf7ea6f112387a01257360b325ac.jpeg"></p><p>Linux和Git之父李纳斯·托沃兹（Linus Benedic Torvalds）1969、芬兰</p><h1 id="3、Git环境配置"><a href="#3、Git环境配置" class="headerlink" title="3、Git环境配置"></a>3、Git环境配置</h1><h2 id="3-1、软件下载"><a href="#3-1、软件下载" class="headerlink" title="3.1、软件下载"></a>3.1、软件下载</h2><p>打开 [git官网] <a href="https://git-scm.com/%EF%BC%8C%E4%B8%8B%E8%BD%BDgit%E5%AF%B9%E5%BA%94%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%89%88%E6%9C%AC%E3%80%82">https://git-scm.com/，下载git对应操作系统的版本。</a></p><p>所有东西下载慢的话就可以去找镜像！</p><p>官网下载太慢，我们可以使用淘宝镜像下载：<a href="http://npm.taobao.org/mirrors/git-for-windows/">http://npm.taobao.org/mirrors/git-for-windows/</a></p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCE4e5f2652c7e918b34855c3feb6add319.jpeg"></p><p>下载对应的版本即可安装！</p><p>安装：无脑下一步即可！安装完毕就可以使用了！</p><h2 id="3-2、启动Git"><a href="#3-2、启动Git" class="headerlink" title="3.2、启动Git"></a>3.2、启动Git</h2><p>安装成功后在开始菜单中会有Git项，菜单下有3个程序：任意文件夹下右键也可以看到对应的程序！</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCEfee0d982805082ebdf7bc9e9af75f98e.png"></p><p>Git Bash：Unix与Linux风格的命令行，使用最多，推荐最多</p><p>Git CMD：Windows风格的命令行</p><p>Git GUI：图形界面的Git，不建议初学者使用，尽量先熟悉常用命令</p><h2 id="3-3、常用的Linux命令"><a href="#3-3、常用的Linux命令" class="headerlink" title="3.3、常用的Linux命令"></a>3.3、常用的Linux命令</h2><p>平时一定要多使用这些基础的命令！</p><p>1）、cd : 改变目录。</p><p>2）、cd . . 回退到上一个目录，直接cd进入默认目录</p><p>3）、pwd : 显示当前所在的目录路径。</p><p>4）、ls(ll):  都是列出当前目录中的所有文件，只不过ll(两个ll)列出的内容更为详细。</p><p>5）、touch : 新建一个文件 如 touch index.js 就会在当前目录下新建一个index.js文件。</p><p>6）、rm:  删除一个文件, rm index.js 就会把index.js文件删除。</p><p>7）、mkdir:  新建一个目录,就是新建一个文件夹。</p><p>8）、rm -r :  删除一个文件夹, rm -r src 删除src目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> -rf / 切勿在Linux中尝试！删除电脑中全部文件！<br></code></pre></td></tr></table></figure><p>9）、mv 移动文件, mv index.html src index.html 是我们要移动的文件, src 是目标文件夹,当然, 这样写,必须保证文件和目标文件夹在同一目录下。</p><p>10）、reset 重新初始化终端&#x2F;清屏。</p><p>11）、clear 清屏。</p><p>12）、history 查看命令历史。</p><p>13）、help 帮助。</p><p>14）、exit 退出。</p><p>15）、#表示注释</p><h2 id="3-4、Git配置"><a href="#3-4、Git配置" class="headerlink" title="3.4、Git配置"></a>3.4、Git配置</h2><p>所有的配置文件，其实都保存在本地！</p><p>查看配置 git config -l</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCE4374aa416f84a58c58615b990a71854d.jpeg"></p><p>查看不同级别的配置文件：</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">#查看系统configgit config</span> <span class="hljs-literal">--</span><span class="hljs-comment">system</span> <span class="hljs-literal">--</span><span class="hljs-comment">list　　#查看当前用户（global）配置git config</span> <span class="hljs-literal">--</span><span class="hljs-comment">global</span>  <span class="hljs-literal">--</span><span class="hljs-comment">list</span><br></code></pre></td></tr></table></figure><p>Git相关的配置文件：</p><p>1）、Git\etc\gitconfig  ：Git 安装目录下的 gitconfig     –system 系统级</p><p>2）、C:\Users\Administrator\ .gitconfig    只适用于当前登录用户的配置  –global 全局</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCEd020d58a5afd538f9c1cee8175e564e9.png"></p><p>这里可以直接编辑配置文件，通过命令设置后会响应到这里。</p><h2 id="设置用户名与邮箱（用户标识，必要）"><a href="#设置用户名与邮箱（用户标识，必要）" class="headerlink" title="设置用户名与邮箱（用户标识，必要）"></a>设置用户名与邮箱（用户标识，必要）</h2><p>当你安装Git后首先要做的事情是设置你的用户名称和e-mail地址。这是非常重要的，因为每次Git提交都会使用该信息。它被永远的嵌入到了你的提交中：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">git config <span class="hljs-attr">--global</span> user<span class="hljs-selector-class">.name</span> <span class="hljs-string">&quot;kuangshen&quot;</span>  #名称git config <span class="hljs-attr">--global</span> user<span class="hljs-selector-class">.email</span> <span class="hljs-number">24736743</span>@qq<span class="hljs-selector-class">.com</span>   #邮箱<br></code></pre></td></tr></table></figure><p>只需要做一次这个设置，如果你传递了–global 选项，因为Git将总是会使用该信息来处理你在系统中所做的一切操作。如果你希望在一个特定的项目中使用不同的名称或e-mail地址，你可以在该项目中运行该命令而不要–global选项。总之–global为全局配置，不加为某个项目的特定配置。</p><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="></p><h1 id="4、Git基本理论（重要）"><a href="#4、Git基本理论（重要）" class="headerlink" title="4、Git基本理论（重要）"></a>4、Git基本理论（重要）</h1><h2 id="4-1、三个区域"><a href="#4-1、三个区域" class="headerlink" title="4.1、三个区域"></a>4.1、三个区域</h2><p>Git本地有三个工作区域：工作目录（Working Directory）、暂存区(Stage&#x2F;Index)、资源库(Repository或Git Directory)。如果在加上远程的git仓库(Remote Directory)就可以分为四个工作区域。文件在这四个区域之间的转换关系如下：</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCE0d40cd8de9988128d9d781f435577e6f.png"></p><ul><li><p>Workspace：工作区，就是你平时存放项目代码的地方</p></li><li><p>Index &#x2F; Stage：暂存区，用于临时存放你的改动，事实上它只是一个文件，保存即将提交到文件列表信息</p></li><li><p>Repository：仓库区（或本地仓库），就是安全存放数据的位置，这里面有你提交到所有版本的数据。其中HEAD指向最新放入仓库的版本</p></li><li><p>Remote：远程仓库，托管代码的服务器，可以简单的认为是你项目组中的一台电脑用于远程数据交换</p></li></ul><p>本地的三个区域确切的说应该是git仓库中HEAD指向的版本：</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCE02d33c7ff37bb246e0606c21dd83d0ce.png"></p><ul><li><p>Directory：使用Git管理的一个目录，也就是一个仓库，包含我们的工作空间和Git的管理空间。</p></li><li><p>WorkSpace：需要通过Git进行版本控制的目录和文件，这些目录和文件组成了工作空间。</p></li><li><p>.git：存放Git管理信息的目录，初始化仓库的时候自动创建。</p></li><li><p>Index&#x2F;Stage：暂存区，或者叫待提交更新区，在提交进入repo之前，我们可以把所有的更新放在暂存区。</p></li><li><p>Local Repo：本地仓库，一个存放在本地的版本库；HEAD会只是当前的开发分支（branch）。</p></li><li><p>Stash：隐藏，是一个工作状态保存栈，用于保存&#x2F;恢复WorkSpace中的临时状态。</p></li></ul><h2 id="4-2、工作流程"><a href="#4-2、工作流程" class="headerlink" title="4.2、工作流程"></a>4.2、工作流程</h2><p>git的工作流程一般是这样的：</p><p>１、在工作目录中添加、修改文件；</p><p>２、将需要进行版本管理的文件放入暂存区域；</p><p>３、将暂存区域的文件提交到git仓库。</p><p>因此，git管理的文件有三种状态：已修改（modified）,已暂存（staged）,已提交(committed)</p><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="></p><h1 id="5、Git项目搭建"><a href="#5、Git项目搭建" class="headerlink" title="5、Git项目搭建"></a>5、Git项目搭建</h1><h2 id="5-1、创建工作目录与常用指令"><a href="#5-1、创建工作目录与常用指令" class="headerlink" title="5.1、创建工作目录与常用指令"></a>5.1、创建工作目录与常用指令</h2><p>工作目录（WorkSpace)一般就是你希望Git帮助你管理的文件夹，可以是你项目的目录，也可以是一个空目录，建议不要有中文。</p><p>日常使用只要记住下图6个命令：</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCE2cab9f228518b50c6c129094774c1d19.png"></p><h2 id="5-2、本地仓库搭建"><a href="#5-2、本地仓库搭建" class="headerlink" title="5.2、本地仓库搭建"></a>5.2、本地仓库搭建</h2><p>创建本地仓库的方法有两种：一种是创建全新的仓库，另一种是克隆远程仓库。</p><p>1、创建全新的仓库，需要用GIT管理的项目的根目录执行：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-meta"># 在当前目录新建一个Git代码库$ git init</span><br></code></pre></td></tr></table></figure><p>2、执行后可以看到，仅仅在项目目录多出了一个.git目录，关于版本等的所有信息都在这个目录里面。</p><h2 id="5-3、克隆远程仓库"><a href="#5-3、克隆远程仓库" class="headerlink" title="5.3、克隆远程仓库"></a>5.3、克隆远程仓库</h2><p>1、另一种方式是克隆远程目录，由于是将远程服务器上的仓库完全镜像一份至本地！</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clean"># 克隆一个项目和它的整个代码历史(版本信息)$ git clone [url]  # https:<span class="hljs-comment">//gitee.com/kuangstudy/openclass.git</span><br></code></pre></td></tr></table></figure><p>2、去 gitee 或者 github 上克隆一个测试！</p><h1 id="6、Git文件操作"><a href="#6、Git文件操作" class="headerlink" title="6、Git文件操作"></a>6、Git文件操作</h1><h2 id="6-1、文件的四种状态"><a href="#6-1、文件的四种状态" class="headerlink" title="6.1、文件的四种状态"></a>6.1、文件的四种状态</h2><p>版本控制就是对文件的版本控制，要对文件进行修改、提交等操作，首先要知道文件当前在什么状态，不然可能会提交了现在还不想提交的文件，或者要提交的文件没提交上。</p><ul><li><p>Untracked: 未跟踪, 此文件在文件夹中, 但并没有加入到git库, 不参与版本控制. 通过git add 状态变为Staged.</p></li><li><p>Unmodify: 文件已经入库, 未修改, 即版本库中的文件快照内容与文件夹中完全一致. 这种类型的文件有两种去处, 如果它被修改, 而变为Modified. 如果使用git rm移出版本库, 则成为Untracked文件</p></li><li><p>Modified: 文件已修改, 仅仅是修改, 并没有进行其他的操作. 这个文件也有两个去处, 通过git add可进入暂存staged状态, 使用git checkout 则丢弃修改过, 返回到unmodify状态, 这个git checkout即从库中取出文件, 覆盖当前修改 !</p></li><li><p>Staged: 暂存状态. 执行git commit则将修改同步到库中, 这时库中的文件和本地文件又变为一致, 文件为Unmodify状态. 执行git reset HEAD filename取消暂存, 文件状态为Modified</p></li></ul><h2 id="6-2、查看文件状态"><a href="#6-2、查看文件状态" class="headerlink" title="6.2、查看文件状态"></a>6.2、查看文件状态</h2><p>上面说文件有4种状态，通过如下命令可以查看到文件的状态：</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clean">#查看指定文件状态git status [filename]#查看所有文件状态git status# git add .                  添加所有文件到暂存区# git commit -m <span class="hljs-string">&quot;消息内容&quot;</span>    提交暂存区中的内容到本地仓库 -m 提交信息<br></code></pre></td></tr></table></figure><h2 id="6-3、忽略文件"><a href="#6-3、忽略文件" class="headerlink" title="6.3、忽略文件"></a>6.3、忽略文件</h2><p>有些时候我们不想把某些文件纳入版本控制中，比如数据库文件，临时文件，设计文件等</p><p>在主目录下建立”.gitignore”文件，此文件有如下规则：</p><ol><li><p>忽略文件中的空行或以井号（#）开始的行将会被忽略。</p></li><li><p>可以使用Linux通配符。例如：星号（*）代表任意多个字符，问号（？）代表一个字符，方括号（[abc]）代表可选字符范围，大括号（{string1,string2,…}）代表可选的字符串等。</p></li><li><p>如果名称的最前面有一个感叹号（!），表示例外规则，将不被忽略。</p></li><li><p>如果名称的最前面是一个路径分隔符（&#x2F;），表示要忽略的文件在此目录下，而子目录中的文件不忽略。</p></li><li><p>如果名称的最后面是一个路径分隔符（&#x2F;），表示要忽略的是此目录下该名称的子目录，而非文件（默认文件或目录都忽略）。</p></li></ol><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">#为注释*.txt        #忽略所有 .txt结尾的文件,这样的话上传就不会被选中！!lib.txt     #但lib.txt除外<span class="hljs-regexp">/temp        #仅忽略项目根目录下的TODO文件,不包括其它目录tempbuild/</span>       #忽略build<span class="hljs-regexp">/目录下的所有文件doc/</span>*.txt    #会忽略 doc<span class="hljs-regexp">/notes.txt 但不包括 doc/</span>server/arch.txt<br></code></pre></td></tr></table></figure><h1 id="7、使用码云"><a href="#7、使用码云" class="headerlink" title="7、使用码云"></a>7、使用码云</h1><p>github 是有墙的，比较慢，在国内的话，我们一般使用 gitee ，公司中有时候会搭建自己的gitlab服务器</p><p>这个其实可以作为大家未来找工作的一个重要信息！</p><p>1、注册登录码云，完善个人信息</p><p>2、设置本机绑定SSH公钥，实现免密码登录！（免密码登录，这一步挺重要的，码云是远程仓库，我们是平时工作在本地仓库！)</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clean"># 进入 C:\Users\Administrator\.ssh 目录# 生成公钥ssh-keygen<br></code></pre></td></tr></table></figure><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCE940564f6e1e011817aa5dbc800e7e8ac.jpeg"></p><p>3、将公钥信息public key 添加到码云账户中即可！</p><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="></p><p>4、使用码云创建一个自己的仓库！</p><p>许可证：开源是否可以随意转载，开源但是不能商业使用，不能转载，…  限制！</p><p>克隆到本地！</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCEfd19c479ccf30232601db572fb8f3c81.jpeg"></p><h1 id="8、IDEA中集成Git"><a href="#8、IDEA中集成Git" class="headerlink" title="8、IDEA中集成Git"></a>8、IDEA中集成Git</h1><h2 id="8-1、新建项目，绑定git。"><a href="#8-1、新建项目，绑定git。" class="headerlink" title="8.1、新建项目，绑定git。"></a>8.1、新建项目，绑定git。</h2><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCE04f24196c61b219edbb3e678cbac4781.jpeg"></p><p>注意观察idea中的变化</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCE87f45e62915ef55532164726f54fbbbb.png"></p><h2 id="8-2、修改文件，使用IDEA操作git。"><a href="#8-2、修改文件，使用IDEA操作git。" class="headerlink" title="8.2、修改文件，使用IDEA操作git。"></a>8.2、修改文件，使用IDEA操作git。</h2><ul><li><p>添加到暂存区</p></li><li><p>commit 提交</p></li><li><p>push到远程仓库</p></li></ul><h2 id="8-3、提交测试"><a href="#8-3、提交测试" class="headerlink" title="8.3、提交测试"></a>8.3、提交测试</h2><p>这些都是单个人的操作！</p><p>学习的方式最重要！学会学习！我上课的更多时候都是在教大家去学习一种理念和思想（学习方式）</p><p>有道无术、术尚可求。有术无道、止于术！</p><p>真正的教学，授人以渔！</p><h2 id="8-4、说明：GIT分支"><a href="#8-4、说明：GIT分支" class="headerlink" title="8.4、说明：GIT分支"></a>8.4、说明：GIT分支</h2><p>分支在GIT中相对较难，分支就是科幻电影里面的平行宇宙，如果两个平行宇宙互不干扰，那对现在的你也没啥影响。不过，在某个时间点，两个平行宇宙合并了，我们就需要处理一些问题了！</p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCE938a99855af5fdf607f209749411aba8.png"></p><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCEe5506ec1efb324ac64ce8c7b74ec21e4.png"></p><p>git分支中常用指令：</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clean"># 列出所有本地分支git branch# 列出所有远程分支git branch -r# 新建一个分支，但依然停留在当前分支git branch [branch-name]# 新建一个分支，并切换到该分支git checkout -b [branch]# 合并指定分支到当前分支$ git merge [branch]# 删除分支$ git branch -d [branch-name]# 删除远程分支$ git push origin --delete [branch-name]$ git branch -dr [remote/branch]<br></code></pre></td></tr></table></figure><h1 id="9、IDEA中操作"><a href="#9、IDEA中操作" class="headerlink" title="9、IDEA中操作"></a>9、IDEA中操作</h1><p><img src="/2022/10/21/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/Git/WEBRESOURCE24a92beaa781c9bef1cc5d9227a4adc1.png"></p><p>如果同一个文件在合并分支时都被修改了则会引起冲突：解决的办法是我们可以修改冲突文件后重新提交！选择要保留他的代码还是你的代码！</p><p>master主分支应该非常稳定，用来发布新版本，一般情况下不允许在上面工作，工作一般情况下在新建的dev分支上工作，工作完后，比如上要发布，或者说dev分支代码稳定后可以合并到主分支master上来。</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>项目管理工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
      <tag>gitee</tag>
      
      <tag>github</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java反射与XML&amp;JSON</title>
    <link href="/2022/10/21/Java/Java%E5%8F%8D%E5%B0%84/"/>
    <url>/2022/10/21/Java/Java%E5%8F%8D%E5%B0%84/</url>
    
    <content type="html"><![CDATA[<h1 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h1><h2 id="类的加载概述和分类"><a href="#类的加载概述和分类" class="headerlink" title="类的加载概述和分类"></a>类的加载概述和分类</h2><h4 id="1-类加载的概述"><a href="#1-类加载的概述" class="headerlink" title="1.类加载的概述"></a>1.类加载的概述</h4><p>当程序要使用某个类时，如果该类还未被加载到内存中，则系统会通过加载，链接，初始化三步来实现对这个类进行初始化。</p><p>加载</p><p>就是指class文件读入内存，并且为之创建一个Class对象。任何类被使用时系统都会建立一个class对象。</p><p>链接</p><p>验证 是否有正确的内部结构，并和其它类协调一致。</p><p>准备 负责为类的静态成员分配内村，并设置默认初始化值。</p><p>解析 酱类的二进制数据中的符号引用替换为直接引用</p><p>初始化</p><p>默认初始化、显式初始化、构造方法初始化等等。</p><h4 id="2-加载时机"><a href="#2-加载时机" class="headerlink" title="2.加载时机"></a>2.加载时机</h4><p>创建类的实例（Person p &#x3D; new Person()）</p><p>访问类的静态变量，或者为静态变量赋值（p.静态变量 或者 p.静态变量 &#x3D; 0；）</p><p>调用类的静态方法</p><p>使用反射方式来强制创建某个类或接口对应的java.long.Class对象</p><p>初始化某个类的子类</p><p>直接使用java.exe命令来运行某个主类</p><h4 id="3-类加载器的概述"><a href="#3-类加载器的概述" class="headerlink" title="3.类加载器的概述"></a>3.类加载器的概述</h4><p>负责将.class文件加载到内存中，并为之生成对应的Class对象，虽然我们不需要关心类加载机制，但是了解这个机制我们就能更好地理解程序的运行。</p><h4 id="4-类加载器的分类"><a href="#4-类加载器的分类" class="headerlink" title="4.类加载器的分类"></a>4.类加载器的分类</h4><p>Bootstrap ClassLoader 根类加载器</p><p>Extension ClassLoader 扩展类加载器</p><p>System ClassLoader 系统类加载器</p><h4 id="5-类加载器的作用"><a href="#5-类加载器的作用" class="headerlink" title="5.类加载器的作用"></a>5.类加载器的作用</h4><p>Bootstrap ClassLoader 根类加载器</p><p>也被称为引导类加载器，负责Java核心类的加载</p><p>比如System，String等。在JDK中JRE的lib目录下rt.jar文件中</p><p>Extension ClassLoader扩展类加载器</p><p>负责JRE的扩展目录中jar的加载</p><p>在JDK中JRE的lib目录下ext目录</p><p>System ClassLoader 系统类加载器</p><p>负责在JVM启动时加载来自java命令的class文件，以及classpath环境变量所指定的jar包和类路径</p><h2 id="反射概述"><a href="#反射概述" class="headerlink" title="反射概述"></a>反射概述</h2><p>Java反射机制是在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；</p><p>对于任意一个对象，都能够调用它的任意一个方法和属性；</p><p>这种动态获取的信息以及动态调用对象的方法的功能称为java语言的反射机制。</p><p>要想解剖一个类，就必须要获取到该类的字节码文件对象</p><p>而解剖使用的就是Class类中的方法，所以要先获取到每一个字节码文件对应的Class类型对象。</p><h4 id="三种方式"><a href="#三种方式" class="headerlink" title="三种方式"></a>三种方式</h4><p>1.Object类的getClass()方法，判断两个对象是否时同一个字节码文件</p><p>2.静态属性class，锁对象</p><p>3.Class类中静态方法forName(),读取配置文件</p><p><img src="/2022/10/21/Java/Java%E5%8F%8D%E5%B0%84/WEBRESOURCE59d8c4c388d4fa76527dcf6a69038ba1.png"></p><p><img src="/2022/10/21/Java/Java%E5%8F%8D%E5%B0%84/WEBRESOURCE7903b6f0673f48b511e7f09f5aa7aab0.png"></p><h4 id="通过反射获取带参构造方法并使用"><a href="#通过反射获取带参构造方法并使用" class="headerlink" title="通过反射获取带参构造方法并使用"></a>通过反射获取带参构造方法并使用</h4><p>Constructor</p><p>Class类的newInstance()方法是使用该无参的构造函数创建对象，如果一个类没有无参的构造函数，就不能这样创建了，可以调用Class类的getConstructor（String.class,int.class）方法获取一个指定的构造函数然后再调用Constructor类的newInstance(“张三”，20)方法创建对象</p><h4 id="通过反射获取成员变量并使用"><a href="#通过反射获取成员变量并使用" class="headerlink" title="通过反射获取成员变量并使用"></a>通过反射获取成员变量并使用</h4><p>Field</p><p>Class.getField(String)方法可以获取类中的指定字段(可见的)，如果时私有的可以用getDeclaedField(“name”)方法获取，通过set(obj，”李四”)方法可以设置指定对象上该字段的值，如果是私有的需要先调用setAccessible(true)设置访问权限，用获取的指定的字段调用get(obj)可以获取指定对象中该字段的值</p><h4 id="通过反射获取方法并使用"><a href="#通过反射获取方法并使用" class="headerlink" title="通过反射获取方法并使用"></a>通过反射获取方法并使用</h4><p>Method</p><p>Class.getMethod(String，Class…)和Class.getDeclareMethod(String,Class…)方法可以获取类中的指定方法，调用invoke(object，object…)可以调用该法ing发，Class.getMethod(”eat“)invoke(obj)Class.getMethod(“eat”，int.class)invoke(obj,10)</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>反射</tag>
      
      <tag>XML</tag>
      
      <tag>JSON</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>多线程和网络编程</title>
    <link href="/2022/10/21/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    <url>/2022/10/21/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="多线程（Thread）"><a href="#多线程（Thread）" class="headerlink" title="多线程（Thread）"></a>多线程（Thread）</h1><h2 id="1-什么是线程、主线程和其他子线程"><a href="#1-什么是线程、主线程和其他子线程" class="headerlink" title="1.什么是线程、主线程和其他子线程"></a>1.什么是线程、主线程和其他子线程</h2><p>线程是程序执行的一条路径，一个进程中可以包含多条线程</p><p>多线程并发执行可以提高程序的效率，可以同时完成多项工作</p><p>main()方法即为主线程入口</p><h2 id="2-多线程并行和并发的区别"><a href="#2-多线程并行和并发的区别" class="headerlink" title="2.多线程并行和并发的区别"></a>2.多线程并行和并发的区别</h2><p>并行是指两个任务同时进行，就是甲任务进行的同时，乙任务也在进行。（需多核CPU）</p><p>并发是指两个任务都请求运行，而处理器只能接受一个任务，就把这两个任务安排轮流进行，由于时间间隔较短，使人感觉两个任务都在运行。</p><h2 id="3-Java程序运行原理和JVM的启动是多线程的吗？"><a href="#3-Java程序运行原理和JVM的启动是多线程的吗？" class="headerlink" title="3.Java程序运行原理和JVM的启动是多线程的吗？"></a>3.Java程序运行原理和JVM的启动是多线程的吗？</h2><p>A：Jva程序运行原理</p><p>Java命令会启动java虚拟机，启动JVM，等于启动了一个应用程序，也就是启动了一个进程。该进程会自动启动一个”主线程“，然后主线程去调用某个类的main方法。</p><p>B：JVM的启动是多线程的吗</p><p>JVM启动至少启动了垃圾回收线程和主线程，所以是多线程的。</p><h2 id="4-多线程程序实现的方式"><a href="#4-多线程程序实现的方式" class="headerlink" title="4.多线程程序实现的方式"></a>4.多线程程序实现的方式</h2><p>①继承Thread(无返回值)</p><p>定义类继承Thread</p><p>重写run()方法</p><p>把新线程要做的事写在run()方法中</p><p>创建线程对象</p><p>开启新线程，内部会自动执行run()方法</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadTest</span> &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>&#123;<br>        MyThread mt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">MyThread</span>();                   <span class="hljs-comment">//4.创建Thread类的子类对象</span><br>        mt.<span class="hljs-built_in">start</span>();                                     <span class="hljs-comment">//5.开启线程</span><br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span> ; i &lt; <span class="hljs-number">1000</span>; i++)&#123;<br>            System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;bbbbbbb&quot;</span>);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span></span>&#123;               <span class="hljs-comment">//1.继承Thread</span><br>    public void run()&#123;                              <span class="hljs-comment">//2.重写run方法</span><br>        <span class="hljs-keyword">for</span> (int i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">1000</span>; i++)&#123;                 <span class="hljs-comment">//3.将要执行的代码写在run方法中</span><br>            <span class="hljs-type">System</span>.out.println(<span class="hljs-string">&quot;aaaaaaaa&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>②实现Runnable接口(无返回值)</p><p>定义实现Runnable接口</p><p>实现run()方法</p><p>把新线程要做的事写在run()方法中</p><p>创建自定义的Runnable的子类对象</p><p>创建Thread对象，传入Runnable</p><p>调用start()开启新线程，内部会自动调用Runnable的run()方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadTest</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">MyRunnable</span> <span class="hljs-variable">mr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>();            <span class="hljs-comment">//4.创建Runnable的子类对象</span><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span>  <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(mr);                  <span class="hljs-comment">//5.将子类对象当作参数传递给Thread的构造函数</span><br>        t.start();                                   <span class="hljs-comment">//6.开启线程</span><br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span> ; i &lt; <span class="hljs-number">1000</span>; i++)&#123;<br>            System.out.println(<span class="hljs-string">&quot;bbbbbbb&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">MyRunnable</span> <span class="hljs-symbol">implements</span> <span class="hljs-symbol">Runnable</span>&#123;        <span class="hljs-comment">//1.定义一个类实现Runnable</span><br>    @Override<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> run() &#123;                             <span class="hljs-comment">//2.重写run方法</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">1000</span>; i++)&#123;                 <span class="hljs-comment">//3.将要执行的代码写在run方法中</span><br>            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;aaaaaaaa&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>③Callable方式(有返回值)</p><h2 id="5-两种方式的区别"><a href="#5-两种方式的区别" class="headerlink" title="5.两种方式的区别"></a>5.两种方式的区别</h2><p>查看源码的区别：</p><p>①继承Thread：由于子类重写了Thread类的run()，当调用start()时，直接找子类的run()方法</p><p>②实现Runnable：构造函数中传入了Runnable的引用，成员变量记住了它，start()调用run()方法时内部判断成员变量Runnable的引用是否为空，不为空编译时看的时Runnable的run()，运行时执行的是子类的run()方法。</p><p>继承Thread</p><p>好处是：可以直接使用Thread类中的方法，代码简单</p><p>弊端是：如果已经有了父类，就不能用这种方法</p><p>实现Runnable接口</p><p>好处是：即使自己定义的线程类有了父类也没关系，因为有了父类也可以实现接口，而且接口是可以多实现的</p><p>弊端是：不能直接使用Thread中的方法需要先获取到线程对象后，才能得到Thread的方法，代码复杂</p><h2 id="6-匿名内部类实现线程的两种方式"><a href="#6-匿名内部类实现线程的两种方式" class="headerlink" title="6.匿名内部类实现线程的两种方式"></a>6.匿名内部类实现线程的两种方式</h2><p>①继承(extends)Thread类</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Demo4</span> &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> &#123;<br>        <span class="hljs-keyword">new</span> Thread()&#123;                                       <span class="hljs-comment">//1.继承Thread类</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span> &#123;                             <span class="hljs-comment">//2.重写run方法</span><br>                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;            <span class="hljs-comment">//3.将执行的代码写入run方法中</span><br>                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;aaaaaaaaaaaaa&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;.start();                                          <span class="hljs-comment">//4.开启线程</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>②实现(implement)Runnable接口（可实现数据共享）</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Demo4</span> &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> &#123;<br>        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable()&#123;                          <span class="hljs-comment">//1.将Runnable的子类对象传递给Thread的构造方法</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span>&#123;                              <span class="hljs-comment">//2.重写run方法</span><br>                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;            <span class="hljs-comment">//3.将执行的代码写入run方法中</span><br>                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;bbbbbbbbbb&quot;</span>);       <br>                &#125;<br>            &#125;<br>        &#125;).start();                                         <span class="hljs-comment">//4.开启线程</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>③(有返回值)</p><h2 id="7-线程的getName-、setName-、currentThread-方法"><a href="#7-线程的getName-、setName-、currentThread-方法" class="headerlink" title="7.线程的getName()、setName()、currentThread()方法"></a>7.线程的getName()、setName()、currentThread()方法</h2><p>currentThread()方法用于Runnable中，使之可以顺利的执行getName()、setName()方法。</p><h2 id="8-休眠线程"><a href="#8-休眠线程" class="headerlink" title="8.休眠线程"></a>8.休眠线程</h2><p>Thread.sleep(毫秒,纳秒)，控制当前线程休眠若干毫秒1s&#x3D;1000毫秒&#x3D;1000<em>1000</em>1000纳秒</p><h2 id="9-守护线程"><a href="#9-守护线程" class="headerlink" title="9.守护线程"></a>9.守护线程</h2><h2 id="10-线程的状态转换-五个状态"><a href="#10-线程的状态转换-五个状态" class="headerlink" title="10.线程的状态转换(五个状态)"></a>10.线程的状态转换(五个状态)</h2><h2 id="11-线程调度"><a href="#11-线程调度" class="headerlink" title="11.线程调度"></a>11.线程调度</h2><p>void setPriority(int newPriority)</p><p>static void sleep(long millis)</p><p>void join()强制</p><p>static void yield()”礼让“</p><p>void interrupt()</p><h2 id="12-锁synchronized"><a href="#12-锁synchronized" class="headerlink" title="12.锁synchronized"></a>12.锁synchronized</h2><p>①public synchronized void 方法名(){</p><p>}</p><p>②同步代码块</p><p>synchronized（this）{</p><p>&#x2F;&#x2F;所控制的变量或代码块</p><p>}</p><h1 id="网络编程（socket）-传输层）（TCP-x2F-IP）"><a href="#网络编程（socket）-传输层）（TCP-x2F-IP）" class="headerlink" title="网络编程（socket）(传输层）（TCP&#x2F;IP）"></a>网络编程（socket）(传输层）（TCP&#x2F;IP）</h1><h2 id="1-基础原理（7层模型）"><a href="#1-基础原理（7层模型）" class="headerlink" title="1.基础原理（7层模型）"></a>1.基础原理（7层模型）</h2><h2 id="2-什么是Socket"><a href="#2-什么是Socket" class="headerlink" title="2.什么是Socket"></a>2.什么是Socket</h2><p>流式套接字（SOCK_STREAM）</p><p>面向链接、可靠的数据传输服务，基于TCP协议</p><p>数据报式套接字（SOCK_DGRAM）</p><p>无连接服务(UDP)</p><p>原始套接字（SOCK_RAW）</p><p>操作下层</p><p>传输层的API</p><h2 id="3-java-net包"><a href="#3-java-net包" class="headerlink" title="3.java.net包"></a>3.java.net包</h2><p>Socket</p><p>ServerSocket</p><p>DatagramPacket</p><p>DatagramSocket</p><p>InetAddress</p><p>…</p><h2 id="4-基于TCP协议的socket网络编程一般可以分为以下几个步骤"><a href="#4-基于TCP协议的socket网络编程一般可以分为以下几个步骤" class="headerlink" title="4.基于TCP协议的socket网络编程一般可以分为以下几个步骤"></a>4.基于TCP协议的socket网络编程一般可以分为以下几个步骤</h2><p>&lt;C&#x2F;S&gt;模式</p><p>①创建Client端和Server端两个Socket对象，对于Client端时Socket对象、对于Server端是ServerSocket对象</p><p>②在Client端和Server端之间建立连接</p><p>③在输入和输出之间借助数据流来传递信息</p><p>④关闭所有数据流和Socket</p><h2 id="5-socket中实现对象的传输"><a href="#5-socket中实现对象的传输" class="headerlink" title="5.socket中实现对象的传输"></a>5.socket中实现对象的传输</h2><p>借助于序列化和反序列化就能实现</p><p><img src="/2022/10/21/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/WEBRESOURCE97f71c4a1f3001729950f4a437554737.png"></p><h2 id="6-多线程处理多请求"><a href="#6-多线程处理多请求" class="headerlink" title="6.多线程处理多请求"></a>6.多线程处理多请求</h2><p>借助多线程，实现多客户端与服务器网络通信</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>多线程</tag>
      
      <tag>网络编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java实现10种排序</title>
    <link href="/2022/10/21/Java/Java%E6%8E%92%E5%BA%8F/"/>
    <url>/2022/10/21/Java/Java%E6%8E%92%E5%BA%8F/</url>
    
    <content type="html"><![CDATA[<p>#Java实现10种排序算法<br>参考：<a href="https://blog.csdn.net/weixin_44531966/article/details/116464294">https://blog.csdn.net/weixin_44531966/article/details/116464294</a></p><p>#Java排序实现<br>参考：<a href="https://blog.csdn.net/whp1473/article/details/79678974">https://blog.csdn.net/whp1473/article/details/79678974</a></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>排序算法</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java重写(Override)与重载(Overload)</title>
    <link href="/2022/10/21/Java/Java%E9%87%8D%E5%86%99-Override-%E4%B8%8E%E9%87%8D%E8%BD%BD-Overload/"/>
    <url>/2022/10/21/Java/Java%E9%87%8D%E5%86%99-Override-%E4%B8%8E%E9%87%8D%E8%BD%BD-Overload/</url>
    
    <content type="html"><![CDATA[<h1 id="重写-Override"><a href="#重写-Override" class="headerlink" title="重写(Override)"></a>重写(Override)</h1><p>重写是子类对父类的允许访问的方法的实现过程进行重新编写, 返回值和形参都不能改变。即外壳不变，核心重写！</p><p>重写的好处在于子类可以根据需要，定义特定于自己的行为。 也就是说子类能够根据需要实现父类的方法。</p><p>重写方法不能抛出新的检查异常或者比被重写方法申明更加宽泛的异常。例如： 父类的一个方法申明了一个检查异常 IOException，但是在重写这个方法的时候不能抛出 Exception 异常，因为 Exception 是 IOException 的父类，抛出 IOException 异常或者 IOException 的子类异常。</p><p>在面向对象原则里，重写意味着可以重写任何现有方法。实例如下：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">Animal</span>&#123;<br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">move</span>()</span>&#123;<br>      System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;动物可以移动&quot;</span>);<br>   &#125;<br>&#125;<br> <br><span class="hljs-keyword">class</span> <span class="hljs-title">Dog</span> <span class="hljs-title">extends</span> <span class="hljs-title">Animal</span>&#123;<br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">move</span>()</span>&#123;<br>      System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;狗可以跑和走&quot;</span>);<br>   &#125;<br>&#125;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestDog</span>&#123;<br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String args[]</span>)</span>&#123;<br>      Animal a = <span class="hljs-keyword">new</span> Animal(); <span class="hljs-comment">// Animal 对象</span><br>      Animal b = <span class="hljs-keyword">new</span> Dog(); <span class="hljs-comment">// Dog 对象</span><br> <br>      a.move();<span class="hljs-comment">// 执行 Animal 类的方法</span><br> <br>      b.move();<span class="hljs-comment">//执行 Dog 类的方法</span><br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>以上实例编译运行结果如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">动物可以移动<br>狗可以跑和走<br></code></pre></td></tr></table></figure><p>在上面的例子中可以看到，尽管 b 属于 Animal 类型，但是它运行的是 Dog 类的 move方法。</p><p>这是由于在编译阶段，只是检查参数的引用类型。</p><p>然而在运行时，Java 虚拟机(JVM)指定对象的类型并且运行该对象的方法。</p><p>因此在上面的例子中，之所以能编译成功，是因为 Animal 类中存在 move 方法，然而运行时，运行的是特定对象的方法。</p><p>思考以下例子：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">Animal</span>&#123;<br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">move</span>()</span>&#123;<br>      System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;动物可以移动&quot;</span>);<br>   &#125;<br>&#125;<br> <br><span class="hljs-keyword">class</span> <span class="hljs-title">Dog</span> <span class="hljs-title">extends</span> <span class="hljs-title">Animal</span>&#123;<br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">move</span>()</span>&#123;<br>      System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;狗可以跑和走&quot;</span>);<br>   &#125;<br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">bark</span>()</span>&#123;<br>      System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;狗可以吠叫&quot;</span>);<br>   &#125;<br>&#125;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestDog</span>&#123;<br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String args[]</span>)</span>&#123;<br>      Animal a = <span class="hljs-keyword">new</span> Animal(); <span class="hljs-comment">// Animal 对象</span><br>      Animal b = <span class="hljs-keyword">new</span> Dog(); <span class="hljs-comment">// Dog 对象</span><br> <br>      a.move();<span class="hljs-comment">// 执行 Animal 类的方法</span><br>      b.move();<span class="hljs-comment">//执行 Dog 类的方法</span><br>      b.bark();<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>以上实例编译运行结果如下：</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">TestDog.java:<span class="hljs-number">30</span>: cannot find symbol<br>symbol  : <span class="hljs-keyword">method</span> <span class="hljs-title function_">bark</span><span class="hljs-params">()</span><br><span class="hljs-title function_">location</span>: <span class="hljs-keyword">class</span> Animal<br>                b.bark()<span class="hljs-punctuation">;</span><br>                 ^<br></code></pre></td></tr></table></figure><p>该程序将抛出一个编译错误，因为b的引用类型Animal没有bark方法。</p><hr><h2 id="方法的重写规则"><a href="#方法的重写规则" class="headerlink" title="方法的重写规则"></a>方法的重写规则</h2><ul><li><p>参数列表与被重写方法的参数列表必须完全相同。</p></li><li><p>返回类型与被重写方法的返回类型可以不相同，但是必须是父类返回值的派生类（java5 及更早版本返回类型要一样，java7 及更高版本可以不同）。</p></li><li><p>访问权限不能比父类中被重写的方法的访问权限更低。例如：如果父类的一个方法被声明为 public，那么在子类中重写该方法就不能声明为 protected。</p></li><li><p>父类的成员方法只能被它的子类重写。</p></li><li><p>声明为 final 的方法不能被重写。</p></li><li><p>声明为 static 的方法不能被重写，但是能够被再次声明。</p></li><li><p>子类和父类在同一个包中，那么子类可以重写父类所有方法，除了声明为 private 和 final 的方法。</p></li><li><p>子类和父类不在同一个包中，那么子类只能够重写父类的声明为 public 和 protected 的非 final 方法。</p></li><li><p>重写的方法能够抛出任何非强制异常，无论被重写的方法是否抛出异常。但是，重写的方法不能抛出新的强制性异常，或者比被重写方法声明的更广泛的强制性异常，反之则可以。</p></li><li><p>构造方法不能被重写。</p></li><li><p>如果不能继承一个类，则不能重写该类的方法。</p></li></ul><hr><h2 id="Super-关键字的使用"><a href="#Super-关键字的使用" class="headerlink" title="Super 关键字的使用"></a>Super 关键字的使用</h2><p>当需要在子类中调用父类的被重写方法时，要使用 super 关键字。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span>&#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">move</span>(<span class="hljs-params"></span>)&#123;<br>      <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;动物可以移动&quot;</span>);<br>   &#125;<br>&#125;<br> <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span>&#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">move</span>(<span class="hljs-params"></span>)&#123;<br>      <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">move</span>(); <span class="hljs-comment">// 应用super类的方法</span><br>      <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;狗可以跑和走&quot;</span>);<br>   &#125;<br>&#125;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestDog</span>&#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> args[]</span>)&#123;<br> <br>      <span class="hljs-title class_">Animal</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(); <span class="hljs-comment">// Dog 对象</span><br>      b.<span class="hljs-title function_">move</span>(); <span class="hljs-comment">//执行 Dog类的方法</span><br> <br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>以上实例编译运行结果如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">动物可以移动<br>狗可以跑和走<br></code></pre></td></tr></table></figure><h2 id="重载-Overload"><a href="#重载-Overload" class="headerlink" title="重载(Overload)"></a>重载(Overload)</h2><p>重载(overloading) 是在一个类里面，方法名字相同，而参数不同。返回类型可以相同也可以不同。</p><p>每个重载的方法（或者构造函数）都必须有一个独一无二的参数类型列表。</p><p>最常用的地方就是构造器的重载。</p><p>重载规则:</p><ul><li><p>被重载的方法必须改变参数列表(参数个数或类型不一样)；</p></li><li><p>被重载的方法可以改变返回类型；</p></li><li><p>被重载的方法可以改变访问修饰符；</p></li><li><p>被重载的方法可以声明新的或更广的检查异常；</p></li><li><p>方法能够在同一个类中或者在一个子类中被重载。</p></li><li><p>无法以返回值类型作为重载函数的区分标准。</p></li></ul><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Overloading</span> &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">test</span>()</span>&#123;<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;test1&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br> <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> a</span>)</span>&#123;<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;test2&quot;</span>);<br>    &#125;   <br> <br>    <span class="hljs-comment">//以下两个参数类型顺序不同</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> a,String s</span>)</span>&#123;<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;test3&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;returntest3&quot;</span>;<br>    &#125;   <br> <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test</span>(<span class="hljs-params">String s,<span class="hljs-built_in">int</span> a</span>)</span>&#123;<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;test4&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;returntest4&quot;</span>;<br>    &#125;   <br> <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span>&#123;<br>        Overloading o = <span class="hljs-keyword">new</span> Overloading();<br>        System.<span class="hljs-keyword">out</span>.println(o.test());<br>        o.test(<span class="hljs-number">1</span>);<br>        System.<span class="hljs-keyword">out</span>.println(o.test(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;test3&quot;</span>));<br>        System.<span class="hljs-keyword">out</span>.println(o.test(<span class="hljs-string">&quot;test4&quot;</span>,<span class="hljs-number">1</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="重写与重载之间的区别"><a href="#重写与重载之间的区别" class="headerlink" title="重写与重载之间的区别"></a>重写与重载之间的区别</h2><table><thead><tr><th>区别点</th><th>重载方法</th><th>重写方法</th></tr></thead><tbody><tr><td>参数列表</td><td>必须修改</td><td>一定不能修改</td></tr><tr><td>返回类型</td><td>可以修改</td><td>一定不能修改</td></tr><tr><td>异常</td><td>可以修改</td><td>可以减少或删除，一定不能抛出新的或者更广的异常</td></tr><tr><td>访问</td><td>可以修改</td><td>一定不能做更严格的限制（可以降低限制）</td></tr></tbody></table><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>方法的重写(Overriding)和重载(Overloading)是java多态性的不同表现，重写是父类与子类之间多态性的一种表现，重载可以理解成多态的具体表现形式。</p><ul><li><p>(1)方法重载是一个类中定义了多个方法名相同,而他们的参数的数量不同或数量相同而类型和次序不同,则称为方法的重载(Overloading)。</p></li><li><p>(2)方法重写是在子类存在方法与父类的方法的名字相同,而且参数的个数与类型一样,返回值也一样的方法,就称为重写(Overriding)。</p></li><li><p>(3)方法重载是一个类的多态性表现,而方法重写是子类与父类的一种多态性表现。</p></li></ul><p><img src="/2022/10/21/Java/Java%E9%87%8D%E5%86%99-Override-%E4%B8%8E%E9%87%8D%E8%BD%BD-Overload/WEBRESOURCE45b7836d5382c120eea20fcb0db55d5b.png"></p><p><img src="/2022/10/21/Java/Java%E9%87%8D%E5%86%99-Override-%E4%B8%8E%E9%87%8D%E8%BD%BD-Overload/WEBRESOURCE9f2ee55d8ea4cd593246c0c4fa8be779.png"></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Java重写(Override)与重载(Overload)</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java高级</title>
    <link href="/2022/10/21/Java/Java%E9%AB%98%E7%BA%A7/"/>
    <url>/2022/10/21/Java/Java%E9%AB%98%E7%BA%A7/</url>
    
    <content type="html"><![CDATA[<p>#接口</p><p>##接口的描述：</p><p>接口就是一种公共的规范标准，只要符合规范标准，大家都可以通用，Java中的接口更多的体现在对行为的抽象</p><p>##接口的特点：</p><p>接口用关键字interface修饰</p><p>public interface 接口名{}</p><p>类实现接口用implements表示</p><p>public class 类名 implement 接口名{}</p><p>接口不能实例化</p><p>接口如何实例化呢？参照多态的方式，通过实现类对象实例化，这叫接口多态。</p><p>多态的形式：具体类多态，抽象类多态，接口多态。</p><p>多态的前提：有继承或者实现关系；有方法重写；有父（类&#x2F;接口）英勇只想（子&#x2F;实现）类对象</p><p>接口的实现类</p><p>要么重写接口中的所有抽象方法</p><p>要么是抽象类</p><p>##接口的成员特点：</p><p>###成员变量</p><p>###只能是常量</p><p>默认修饰符：public static final</p><p>###构造方法</p><p>接口没有构造方法，应为接口主要是对行为进行抽象的，是没有具体存在</p><p>一个类如果没有父类，默认继承自Object类</p><p>###成员方法</p><p>只能是抽象方法</p><p>默认修饰符：public abstract</p><p>#类和接口的关系：</p><p>类和类的关系</p><p>继承关系，只能单继承，但是可以多层继承</p><p>类和接口的关系</p><p>实现关系，可以单实线，也可以多实现，还可以在继承一个类的同时实现多个接口</p><p>接口和接口的关系</p><p>继承关系，可以单继承，也可以多继承</p><p>    </p><p>#抽象类和接口的区别</p><p>成员区别</p><p>|抽象类|变量，常量；有构造方法；有抽象方法，也有非抽象方法。|</p><p>|接口|常量；抽象方法。|</p><blockquote></blockquote><p>关系区别</p><p>|类与类|继承，单继承，多层继承|</p><p>|类与接口|实现，可以单实现，也可以多实现|</p><p>|接口与接口|继承，单继承，多继承|</p><blockquote></blockquote><p>设计理念区别</p><p>|抽象类|对类抽象，包括属性、行为|</p><p>|接口|对行为抽象，主要是行为|</p><blockquote></blockquote><p>形参和返回值</p><p>抽象类名作为形参和返回值</p><p>方法的形参是抽象类名，其实需要的时该抽象类的子类对象</p><p>方法的返回值是抽象类名，其实返回的是该抽象类的子类对象</p><p>接口名作为形参和和返回值</p><p>方法的形参是接口名，其实需要的是该接口的实现类对象</p><p>方法的返回值是接口名，其实返回的是该接口的实现类对象</p><p>内部类</p><p>内部类：就是在一个类中定义一个类。举例：在一个类A的内部定义一个类B，类B就被称为内部类</p><p>pblic class A{</p><p>public class B{</p><p>}</p><p>}</p><p>内部类的访问特点：</p><p>内部类可以直接访问外部类的成员，包括私有。</p><p>外部类要访问内部类的成员，必须创建对象。</p><p>成员内部类</p><p>按照内部类在类中定义的位置不同，可以分为如下两种形式</p><p>在类的成员位置：成员内部类</p><p>在类的局部位置：局部内部类</p><p>成员内部类，外界如何创建对象使用呢？</p><p>格式：外部类名.内部类名 对象名 &#x3D; 外部类对象.内部类对象；</p><p>范例：Outer.Inner oi &#x3D; new Outer().new Inner();</p><p>当成员内部类为私有时，在外部类中创建方法间接调用内部类：</p><p><img src="/2022/10/21/Java/Java%E9%AB%98%E7%BA%A7/A671AF24A1314FA4B56D98FB43007486.png"></p><p>局部内部类</p><p>是在方法中定义的类，所以外界是无法直接使用的，需要在方法内部创建对象并使用</p><p>该类可以直接访问外部类的成员，也可以访问方法内的局部变量。</p><p>匿名内部类</p><p>格式：</p><p>new 类名或接口名（）{</p><p>重写方法；</p><p>}；</p><p>范例：</p><p>new Inter（）{</p><p>public void show（）{</p><p>}</p><p>}；</p><p>本质：是一个继承了该类或者实现了该接口的子类匿名对象</p><p><img src="/2022/10/21/Java/Java%E9%AB%98%E7%BA%A7/32E1A5D1032C411B98EC1B46B2BBAE38.png"></p><p>调用：</p><p><img src="/2022/10/21/Java/Java%E9%AB%98%E7%BA%A7/AB98A7AD90824370990DD54D9EE8E7D1.png"></p><p>Math,System,Object类的toString(),Object类的equals()</p><p>intellIj如何看方法的源码：选中方法，按下Ctrl+B</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Java高级</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java8新特性之Stream流的集合操作</title>
    <link href="/2022/10/21/Java/Java8%E6%96%B0%E7%89%B9%E6%80%A7%E4%B9%8BStream%E6%B5%81%E7%9A%84%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C/"/>
    <url>/2022/10/21/Java/Java8%E6%96%B0%E7%89%B9%E6%80%A7%E4%B9%8BStream%E6%B5%81%E7%9A%84%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h1 id="概JDK8-Stream详解"><a href="#概JDK8-Stream详解" class="headerlink" title="概JDK8 Stream详解"></a>概JDK8 Stream详解</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><blockquote></blockquote><p>Stream是Java8 API的新成员，它允许以声明性方式处理数据集合 。</p><h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><blockquote></blockquote><p>（1）代码简洁：函数式编程写出的代码简洁且意图明确，使用stream接口让你从此告别for循环。<br>（2）多核友好：Java函数式编程使得编写并行程序从未如此简单，你需要的全部就是调用一下方法。</p><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs glsl"><span class="hljs-number">1</span>）第一步：把集合转换为流<span class="hljs-keyword">stream</span><br><span class="hljs-number">2</span>）第二步：操作<span class="hljs-keyword">stream</span>流<br><span class="hljs-keyword">stream</span>流在管道中经过中间操作（intermediate operation）的处理，最后由最终操作(terminal operation)得到前面处理的结果<br><br></code></pre></td></tr></table></figure><h2 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h2><blockquote></blockquote><p>两种：中间操作符、终止操作符</p><h3 id="中间操作符"><a href="#中间操作符" class="headerlink" title="中间操作符"></a>中间操作符</h3><table><thead><tr><th>流方法</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td>filter</td><td>用于通过设置的条件过滤出元素</td><td>List&lt;String&gt; strings &#x3D; Arrays.asList(“abc”, “”, “bc”, “efg”, “abcd”,””, “jkl”);List&lt;String&gt; filtered &#x3D; strings.stream().filter(string -&gt; !string.isEmpty()).collect(Collectors.toList());</td></tr><tr><td>distinct</td><td>返回一个元素各异（根据流所生成元素的hashCode和equals方法实现）的流。</td><td>List&lt;Integer&gt; numbers &#x3D; Arrays.asList(1, 2, 1, 3, 3, 2, 4);numbers.stream().filter(i -&gt; i % 2 &#x3D;&#x3D; 0).distinct().forEach(System.out::println);</td></tr><tr><td>limit</td><td>会返回一个不超过给定长度的流。</td><td>List&lt;String&gt; strings &#x3D; Arrays.asList(“abc”, “abc”, “bc”, “efg”, “abcd”,”jkl”, “jkl”);List&lt;String&gt; limited &#x3D; strings.stream().limit(3).collect(Collectors.toList());</td></tr><tr><td>skip</td><td>返回一个扔掉了前n个元素的流。</td><td>List&lt;String&gt; strings &#x3D; Arrays.asList(“abc”, “abc”, “bc”, “efg”, “abcd”,”jkl”, “jkl”);List&lt;String&gt; skiped &#x3D; strings.stream().skip(3).collect(Collectors.toList());</td></tr><tr><td>map</td><td>接受一个函数作为参数。这个函数会被应用到每个元素上，并将其映射成一个新的元素（使用映射一词，是因为它和转换类似，但其中的细微差别在于它是&quot;创建一个新版本”而不是去&quot;修改”）。</td><td>List&lt;String&gt; strings &#x3D; Arrays.asList(“abc”, “abc”, “bc”, “efg”, “abcd”,”jkl”, “jkl”);List&lt;String&gt; mapped &#x3D; strings.stream().map(str-&gt;str+”-itcast”).collect(Collectors.toList());</td></tr><tr><td>flatMap</td><td>使用flatMap方法的效果是，各个数组并不是分别映射成一个流，而是映射成流的内容。所有使用map(Arrays::stream)时生成的单个流都被合并起来，即扁平化为一个流。</td><td>List&lt;String&gt; strings &#x3D; Arrays.asList(“abc”, “abc”, “bc”, “efg”, “abcd”,”jkl”, “jkl”);Stream&lt;Character&gt; flatMap &#x3D; strings.stream().flatMap(Java8StreamTest::getCharacterByString);</td></tr><tr><td>sorted</td><td>返回排序后的流</td><td>List&lt;String&gt; strings1 &#x3D; Arrays.asList(“abc”, “abd”, “aba”, “efg”, “abcd”,”jkl”, “jkl”);List&lt;String&gt; sorted1 &#x3D; strings1.stream().sorted().collect(Collectors.toList());</td></tr></tbody></table><blockquote></blockquote><p>示例代码：<br>1）filter</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">/**<br>* 功能描述:根据条件过滤集合数据<br>* @return : void<br>*/<br>  @Test<br>  public void filter()&#123;<br>  List&lt;String&gt; strings = Arrays.asList(&quot;abc&quot;, &quot;&quot;, &quot;bc&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;&quot;, &quot;jkl&quot;);<br>  List&lt;String&gt; filtered = strings.stream().filter(string -&gt; !string.isEmpty()).collect(Collectors.toList());<br>  out.println(filtered);<br>  &#125;<br></code></pre></td></tr></table></figure><p>2）distinct</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">/**<br>* 功能描述:去除集合中重复数据<br>* @return : void<br>*/<br>  @Test<br>  public void distinct()&#123;<br>  List&lt;String&gt; strings = Arrays.asList(&quot;abc&quot;, &quot;abc&quot;, &quot;bc&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;jkl&quot;, &quot;jkl&quot;);<br>  List&lt;String&gt; distincted = strings.stream().distinct().collect(Collectors.toList());<br>  out.println(distincted);<br>  &#125;<br></code></pre></td></tr></table></figure><p>3）limit</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">/**<br>* 功能描述:指定获取集合前x条数据，重新构造一个新的集合<br>* @return : void<br>*/<br>  @Test<br>  public void limit()&#123;<br>  List&lt;String&gt; strings = Arrays.asList(&quot;abc&quot;, &quot;abc&quot;, &quot;bc&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;jkl&quot;, &quot;jkl&quot;);<br>  List&lt;String&gt; limited = strings.stream().limit(3).collect(Collectors.toList());<br>  out.println(limited);<br>  &#125;<br></code></pre></td></tr></table></figure><p>4）skip</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">/**<br>* 功能描述:排除集合前x条数据，把后面的数据重新构造一个新的集合<br>* @return : void<br>*/<br>  @Test<br>  public void skip()&#123;<br>  List&lt;String&gt; strings = Arrays.asList(&quot;abc&quot;, &quot;abc&quot;, &quot;bc&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;jkl&quot;, &quot;jkl&quot;);<br>  List&lt;String&gt; skiped = strings.stream().skip(3).collect(Collectors.toList());<br>  out.println(skiped);<br>  &#125;<br></code></pre></td></tr></table></figure><p>5）map</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">    /**<br>    * 功能描述:对集合中所有元素统一处理<br>* @return : void<br>  */<br>  @Test<br>  public void map()&#123;<br>  List&lt;String&gt; strings = Arrays.asList(&quot;abc&quot;, &quot;abc&quot;, &quot;bc&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;jkl&quot;, &quot;jkl&quot;);<br>  List&lt;String&gt; mapped = strings.stream().map(str-&gt;str+&quot;-itcast&quot;).collect(Collectors.toList());<br>  out.println(mapped);<br>  &#125;<br></code></pre></td></tr></table></figure><p>6）flatMap</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">/**<br>* 功能描述:对集合中所有元素统一处理<br>* @return : void<br>*/<br>  @Test<br>  public void flatMap()&#123;<br>  List&lt;String&gt; strings = Arrays.asList(&quot;abc&quot;, &quot;abc&quot;, &quot;bc&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;jkl&quot;, &quot;jkl&quot;);<br>  Stream&lt;String&gt; stringStream = strings.stream().map(x -&gt; x);<br>  Stream&lt;String&gt; stringStream1 = strings.stream().flatMap(x -&gt; Arrays.asList(x.split(&quot; &quot;)).stream());<br>  &#125;<br></code></pre></td></tr></table></figure><p>7）sorted</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">/**<br>* 功能描述 : 对集合进行排序<br>* @return : void<br>*/<br>  @Test<br>  public void sorted()&#123;<br>  List&lt;String&gt; strings1 = Arrays.asList(&quot;abc&quot;, &quot;abd&quot;, &quot;aba&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;jkl&quot;, &quot;jkl&quot;);<br>  List&lt;String&gt; strings2 = Arrays.asList(&quot;张三&quot;, &quot;李四&quot;, &quot;王五&quot;, &quot;赵柳&quot;, &quot;张哥&quot;,&quot;李哥&quot;, &quot;王哥&quot;);<br>  List&lt;Integer&gt; strings3 = Arrays.asList(10, 2, 30, 22, 1,0, -9);<br>  List&lt;String&gt; sorted1 = strings1.stream().sorted().collect(Collectors.toList());<br>  List&lt;String&gt; sorted2 = strings2.stream().sorted(Collections.reverseOrder(Collator.getInstance(Locale.CHINA))).collect(Collectors.toList());<br>  List&lt;Integer&gt; sorted3 = strings3.stream().sorted().collect(Collectors.toList());<br>  out.println(sorted1);<br>  out.println(sorted2);<br>  out.println(sorted3);<br>  &#125;<br></code></pre></td></tr></table></figure><p>Map、flatMap区别</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-built_in">map</span>：对流中每一个元素进行处理<br>flatMap：流扁平化，让你把一个流中的“每个值”都换成另一个流，然后把所有的流连接起来成为一个流 <br>总结：<span class="hljs-built_in">map</span>是对一级元素进行操作，flatmap是对二级元素操作。<br><br></code></pre></td></tr></table></figure><p>本质区别：map返回一个值；flatmap返回一个流，多个值。</p><p>应用场景：map对集合中每个元素加工,返回加工后结果；flatmap对集合中每个元素加工后，做扁平化处理后（拆分层级，放到同一层）然后返回</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 方法一</span><br><span class="hljs-comment"> * 功能描述:  通过使用map、flatMap把字符串转换为字符输出对比区别</span><br><span class="hljs-comment"> * @return : void</span><br><span class="hljs-comment"> */</span><br>@Test<br>public void flat<span class="hljs-constructor">Map2Map()</span>&#123;<br>    List&lt;String&gt; strings = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Arrays</span>.</span></span><span class="hljs-keyword">as</span><span class="hljs-constructor">List(<span class="hljs-string">&quot;abc&quot;</span>, <span class="hljs-string">&quot;abc&quot;</span>, <span class="hljs-string">&quot;bc&quot;</span>, <span class="hljs-string">&quot;efg&quot;</span>, <span class="hljs-string">&quot;abcd&quot;</span>,<span class="hljs-string">&quot;jkl&quot;</span>, <span class="hljs-string">&quot;jkl&quot;</span>)</span>;<br>    final Stream&lt;Character&gt; flatMap = strings.stream<span class="hljs-literal">()</span>.flat<span class="hljs-constructor">Map(Java8StreamTest::<span class="hljs-params">getCharacterByString</span>)</span>;<br>    flatMap.<span class="hljs-keyword">for</span><span class="hljs-constructor">Each(System.<span class="hljs-params">out</span>::<span class="hljs-params">println</span>)</span>;<br>    <span class="hljs-comment">//----------------------------------------------</span><br>    final Stream&lt;Stream&lt;Character&gt;&gt; mapStream = strings.stream<span class="hljs-literal">()</span>.map(Java8StreamTest::getCharacterByString);<br>    <span class="hljs-comment">//mapStream.forEach(System.out::println);</span><br>    out.println(<span class="hljs-string">&quot;------------------------------------------------&quot;</span>);<br>    mapStream.<span class="hljs-keyword">for</span><span class="hljs-constructor">Each(<span class="hljs-params">stream</span>-&gt; &#123;<span class="hljs-params">stream</span>.<span class="hljs-params">forEach</span>(<span class="hljs-params">character</span>-&gt;&#123;System.<span class="hljs-params">out</span>.<span class="hljs-params">println</span>(<span class="hljs-params">character</span>)</span>;&#125;);&#125;);<br><br>&#125;<br><br></code></pre></td></tr></table></figure><blockquote></blockquote><p>公共方法（字符串转换为字符流）</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 功能描述:字符串转换为字符流</span><br><span class="hljs-comment">* @param str</span><br><span class="hljs-comment">* @return : java.util.stream.Stream&lt;java.lang.Character&gt;</span><br><span class="hljs-comment">*/</span><br><span class="hljs-built_in">public</span> static Stream&lt;<span class="hljs-type">Character</span>&gt; getCharacterByString(String str) &#123;<br>    List&lt;<span class="hljs-type">Character</span>&gt; characterList = <span class="hljs-built_in">new</span> ArrayList&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">Character</span> <span class="hljs-type">character</span> : str.toCharArray()) &#123;<br>    characterList.<span class="hljs-keyword">add</span>(<span class="hljs-type">character</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> characterList.stream();<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="终止操作符"><a href="#终止操作符" class="headerlink" title="终止操作符"></a>终止操作符</h3><table><thead><tr><th>流方法</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td>anyMatch</td><td>检查是否至少匹配一个元素，返回boolean。</td><td>List&lt;String&gt; strings &#x3D; Arrays.asList(“abc”, “abd”, “aba”, “efg”, “abcd”,”jkl”, “jkl”);boolean b &#x3D; strings.stream().anyMatch(s -&gt; s &#x3D;&#x3D; “abc”);</td></tr><tr><td>allMatch</td><td>检查是否匹配所有元素，返回boolean。</td><td>List&lt;String&gt; strings &#x3D; Arrays.asList(“abc”, “abd”, “aba”, “efg”, “abcd”,”jkl”, “jkl”);boolean b &#x3D; strings.stream().allMatch(s -&gt; s &#x3D;&#x3D; “abc”);</td></tr><tr><td>noneMatch</td><td>检查是否没有匹配所有元素，返回boolean。</td><td>List&lt;String&gt; strings &#x3D; Arrays.asList(“abc”, “abd”, “aba”, “efg”, “abcd”,”jkl”, “jkl”);boolean b &#x3D; strings.stream().noneMatch(s -&gt; s &#x3D;&#x3D; “abc”);</td></tr><tr><td>findAny</td><td>将返回当前流中的任意元素。</td><td>List&lt;String&gt; strings &#x3D; Arrays.asList(“cv”, “abd”, “aba”, “efg”, “abcd”,”jkl”, “jkl”);Optional&lt;String&gt; any &#x3D; strings.stream().findAny();</td></tr><tr><td>findFirst</td><td>返回第一个元素</td><td>List&lt;String&gt; strings &#x3D; Arrays.asList(“cv”, “abd”, “aba”, “efg”, “abcd”,”jkl”, “jkl”);Optional&lt;String&gt; first &#x3D; strings.stream().findFirst();</td></tr><tr><td>forEach</td><td>遍历流</td><td>List&lt;String&gt; strings &#x3D; Arrays.asList(“cv”, “abd”, “aba”, “efg”, “abcd”,”jkl”, “jkl”);strings.stream().forEach(s -&gt; out.println(s));</td></tr><tr><td>collect</td><td>收集器，将流转换为其他形式。</td><td>List&lt;String&gt; strings &#x3D; Arrays.asList(“cv”, “abd”, “aba”, “efg”, “abcd”,”jkl”, “jkl”);Set&lt;String&gt; set &#x3D; strings.stream().collect(Collectors.toSet());List&lt;String&gt; list &#x3D; strings.stream().collect(Collectors.toList());Map&lt;String, String&gt; map &#x3D; strings.stream().collect(Collectors.toMap(v -&gt;v.concat(“_name”), v1 -&gt; v1, (v1, v2) -&gt; v1));</td></tr><tr><td>reduce</td><td>可以将流中元素反复结合起来，得到一个值。使用 reduce((T, T) -&gt; T) 和 reduce(T, (T, T) -&gt; T) 用于组合流中的元素，如求和，求积，求最大值等。</td><td>List&lt;String&gt; strings &#x3D; Arrays.asList(“cv”, “abd”, “aba”, “efg”, “abcd”,”jkl”, “jkl”);Optional&lt;String&gt; reduce &#x3D; strings.stream().reduce((acc,item) -&gt; {return acc+item;});if(reduce.isPresent())out.println(reduce.get());</td></tr><tr><td>count</td><td>返回流中元素总数。</td><td>List&lt;String&gt; strings &#x3D; Arrays.asList(“cv”, “abd”, “aba”, “efg”, “abcd”,”jkl”, “jkl”);long count &#x3D; strings.stream().count();</td></tr></tbody></table><blockquote></blockquote><p>示例代码<br>1）anyMatch</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">/**<br>* 功能描述 : 判断集合中是否至少存在一个元素满足条件<br>* @return : void<br>*/<br>  @Test<br>  public void anyMatch()&#123;<br>  List&lt;String&gt; strings = Arrays.asList(&quot;abc&quot;, &quot;abd&quot;, &quot;aba&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;jkl&quot;, &quot;jkl&quot;);<br>  boolean b = strings.stream().anyMatch(s -&gt; s == &quot;abc&quot;);<br>  out.println(b);<br>  &#125;<br></code></pre></td></tr></table></figure><p>2）allMatch</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">/**<br>* 功能描述 : 判断集合中是否所有元素都满足条件<br>* @return : void<br>*/<br>  @Test<br>  public void allMatch()&#123;<br>  List&lt;String&gt; strings = Arrays.asList(&quot;abc&quot;, &quot;abd&quot;, &quot;aba&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;jkl&quot;, &quot;jkl&quot;);<br>  boolean b = strings.stream().allMatch(s -&gt; s == &quot;abc&quot;);<br>  out.println(b);<br>  &#125;<br></code></pre></td></tr></table></figure><p>3）noneMatch</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">/**<br>* 功能描述 : 判断集合中是否所有元素都不满足条件<br>* @return : void<br>*/<br>  @Test<br>  public void noneMatch()&#123;<br>  List&lt;String&gt; strings = Arrays.asList(&quot;abc&quot;, &quot;abd&quot;, &quot;aba&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;jkl&quot;, &quot;jkl&quot;);<br>  boolean b = strings.stream().noneMatch(s -&gt; s == &quot;abc&quot;);<br>  out.println(b);<br>  &#125;<br></code></pre></td></tr></table></figure><p>4）findAny</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">/**<br>* 功能描述 : 返回当前流中任意元素<br>* @return : void<br>*/<br>  @Test<br>  public void findAny()&#123;<br>  List&lt;String&gt; strings = Arrays.asList(&quot;cv&quot;, &quot;abd&quot;, &quot;aba&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;jkl&quot;, &quot;jkl&quot;);<br>  Optional&lt;String&gt; any = strings.stream().findAny();<br>  if(any.isPresent()) out.println(any.get());<br>  &#125;<br></code></pre></td></tr></table></figure><p>5）findFirst</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">/**<br>* 功能描述 : 返回当前流中第一个元素<br>* @return : void<br>*/<br>  @Test<br>  public void findFirst()&#123;<br>  List&lt;String&gt; strings = Arrays.asList(&quot;cv&quot;, &quot;abd&quot;, &quot;aba&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;jkl&quot;, &quot;jkl&quot;);<br>  Optional&lt;String&gt; first = strings.stream().findFirst();<br>  if(first.isPresent()) out.println(first.get());<br>  &#125;<br></code></pre></td></tr></table></figure><p>6）forEach java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">/**<br>* 功能描述 : 遍历流<br>* @return : void<br>*/<br>  @Test<br>  public void foreach()&#123;<br>  List&lt;String&gt; strings = Arrays.asList(&quot;cv&quot;, &quot;abd&quot;, &quot;aba&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;jkl&quot;, &quot;jkl&quot;);<br>  strings.stream().forEach(s -&gt; out.println(s));<br>  &#125;<br></code></pre></td></tr></table></figure><p>7）collect</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">/**<br>* 功能描述 : 流转换为其他形式<br>* @return : void<br>*/<br>  @Test<br>  public void collect()&#123;<br>  List&lt;String&gt; strings = Arrays.asList(&quot;cv&quot;, &quot;abd&quot;, &quot;aba&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;jkl&quot;, &quot;jkl&quot;);<br>  Set&lt;String&gt; set = strings.stream().collect(Collectors.toSet());<br>  List&lt;String&gt; list = strings.stream().collect(Collectors.toList());<br>  Map&lt;String, String&gt; map = strings.stream().collect(Collectors.toMap(v -&gt;v.concat(&quot;_name&quot;), v1 -&gt; v1, (v1, v2) -&gt; v1));<br>  out.println(set);<br>  out.println(list);<br>  out.println(map);<br>  &#125;<br></code></pre></td></tr></table></figure><p>8）reduce</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs angular2html">/**<br>* 功能描述 : 将流中元素反复结合起来，得到一个值<br>* @return : void<br>*/<br>  @Test<br>  public void reduce()&#123;<br>  List&lt;String&gt; strings = Arrays.asList(&quot;cv&quot;, &quot;abd&quot;, &quot;aba&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;jkl&quot;, &quot;jkl&quot;);<br>  //reduce方法一<br>  Optional&lt;String&gt; reduce1 = strings.stream().reduce((acc,item) -&gt; &#123;return acc+item;&#125;);<br>  //reduce方法二<br>  String reduce2 = strings.stream().reduce(&quot;itcast&quot;, (acc, item) -&gt; &#123;<br>  return acc + item;<br>  &#125;);<br>  //reduce方法三<br>  ArrayList&lt;String&gt; reduce3 = strings.stream().reduce(<br>  new ArrayList&lt;String&gt;(),<br>  new BiFunction&lt;ArrayList&lt;String&gt;, String, ArrayList&lt;String&gt;&gt;() &#123;<br>  @Override<br>  public ArrayList&lt;String&gt; apply(ArrayList&lt;String&gt; acc, String item) &#123;<br>  acc.add(item);<br>  return acc;<br>  &#125;<br>  &#125;,<br>  new BinaryOperator&lt;ArrayList&lt;String&gt;&gt;() &#123;<br>  @Override<br>  public ArrayList&lt;String&gt; apply(ArrayList&lt;String&gt; acc, ArrayList&lt;String&gt; item) &#123;<br>  return acc;<br>  &#125;<br>  &#125;<br>  );<br>  if(reduce1.isPresent())out.println(reduce1.get());<br>  out.println(reduce2);<br>  out.println(reduce3);<br>  &#125;<br></code></pre></td></tr></table></figure><p>9）count</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 功能描述 : 返回流中元素总数</span><br><span class="hljs-comment">* @return : void</span><br><span class="hljs-comment">*/</span><br>  @Test<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-keyword">count</span>()&#123;<br>  List&lt;String&gt; strings = Arrays.<span class="hljs-keyword">asList</span>(<span class="hljs-string">&quot;cv&quot;</span>, <span class="hljs-string">&quot;abd&quot;</span>, <span class="hljs-string">&quot;aba&quot;</span>, <span class="hljs-string">&quot;efg&quot;</span>, <span class="hljs-string">&quot;abcd&quot;</span>,<span class="hljs-string">&quot;jkl&quot;</span>, <span class="hljs-string">&quot;jkl&quot;</span>);<br>  <span class="hljs-keyword">long</span> <span class="hljs-keyword">count</span> = strings.stream().<span class="hljs-keyword">count</span>();<br>  out.<span class="hljs-keyword">println</span>(<span class="hljs-keyword">count</span>);<br>  &#125;<br></code></pre></td></tr></table></figure><p>注意：文章中因排序部分用到外部比较器，需要导入外部jar包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--apache集合操作工具包--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure><h1 id="https-www-cnblogs-com-shoshana-kong-p-14406683-html"><a href="#https-www-cnblogs-com-shoshana-kong-p-14406683-html" class="headerlink" title="https://www.cnblogs.com/shoshana-kong/p/14406683.html"></a><a href="https://www.cnblogs.com/shoshana-kong/p/14406683.html">https://www.cnblogs.com/shoshana-kong/p/14406683.html</a></h1><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java8新特性</tag>
      
      <tag>Stream流代替for循环</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>IO流、序列化、反序列化</title>
    <link href="/2022/10/21/Java/IO%E6%B5%81%E3%80%81%E5%BA%8F%E5%88%97%E5%8C%96%E3%80%81%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2022/10/21/Java/IO%E6%B5%81%E3%80%81%E5%BA%8F%E5%88%97%E5%8C%96%E3%80%81%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="IOStream"><a href="#IOStream" class="headerlink" title="IOStream"></a>IOStream</h1><p>1.字节流（操作字节）</p><p>字节流的抽象父类</p><p>InputStream</p><p>OutputStream</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">ByteCopy<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test4</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;jietu.png&quot;</span>);<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;copy.png&quot;</span>);<br><br>        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<span class="hljs-comment">//“容器”</span><br>        <span class="hljs-type">int</span> len;<br>        <span class="hljs-keyword">while</span> ((len=fis.read(bytes))!=-<span class="hljs-number">1</span>)&#123;<br>            fos.write(bytes,<span class="hljs-number">0</span>,len);<br>        &#125;<br>        fos.close();<br>        fis.close();<br>&#125;<br></code></pre></td></tr></table></figure><p>BufferedInputStream类</p><p>BufferedOutputStream类</p><p>BufferedInputStream内置了一个缓冲区（数组）</p><p>从BufferedInputStream中读取一个字节时BufferedInputStream会一次性从文件中读取8192个，存在缓冲区中，每次返回给程序一个</p><p>程序再次读取时，就不用找文件了，直接从缓冲区中获取，知道缓冲区中所有的都被使用过，才重新从文件中读取8192个。</p><p>BufferedOutputStream也内置了一个缓冲区（数组）</p><p>程序向流中写出字节时，不会直接写到文件，先写到缓冲区中，知道缓冲区写满，BufferedOutputStream才会吧缓冲区中的数据一次</p><p>性写到文件里。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">BufferCopy<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test5</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;jietu.png&quot;</span>);<br>    <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(fis);<br>    <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;copy.png&quot;</span>);<br>    <span class="hljs-type">BufferedOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedOutputStream</span>(fos);<br>    <br>    <span class="hljs-type">int</span> b;<br>    <span class="hljs-keyword">while</span> ((b = bis.read()) != -<span class="hljs-number">1</span>) &#123;<br>        bos.write(b);<br>    &#125;<br><br>    bis.close();<span class="hljs-comment">//close方法具备刷新的功能，在关闭之前们就会先刷新一次缓冲区，将缓冲区的字节全部都刷新到文件上，再关闭</span><br>    bos.close();<br>&#125;<br></code></pre></td></tr></table></figure><p>字节流读取中文时是可能有问题的，因为有时可能会读到半个中文造成乱码。</p><p>输入输出的标准代码</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test4</span>()</span>&#123;<br>    FileInputStream fis;<br>    FileOutputStream fos;<br>    <span class="hljs-keyword">try</span> &#123;<br>        fis = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;jietu.png&quot;</span>);<br>        fos = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;copy.png&quot;</span>);<br>        <span class="hljs-built_in">int</span> b;<br>        <span class="hljs-keyword">while</span> ((b = fis.read()) != <span class="hljs-number">-1</span>) &#123;<br>            fos.write(b);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>    &#125;<span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span>(bis != <span class="hljs-literal">null</span>)<br>            fis.close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                fos.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>2.字符流（操作字符）</p><p>字符流的抽象父类</p><p>Reader类</p><p>Writer类</p><p>DateInputStream类</p><p>DateOutputStream类</p><p>4.IO程序书写</p><p>使用前，导入IO包中的类</p><p>使用时，进行IO异常处理</p><p>使用后，释放资源</p><h1 id="Serializable（json、ProtoBuf）"><a href="#Serializable（json、ProtoBuf）" class="headerlink" title="Serializable（json、ProtoBuf）"></a>Serializable（json、ProtoBuf）</h1><p>(Java序列化就是指把Java对象转换为字节序列的过程</p><p>Java反序列化就是指把字节序列恢复为Java对象的过程。</p><p>序列化最重要的作用：在传递和保存对象时.保证对象的完整性和可传递性。对象转换为有序字节流,以便在网络上传输或者保存在本地文件中。</p><p>反序列化的最重要的作用：根据字节流中保存的对象状态及描述信息，通过反序列化重建对象。</p><p>总结：核心作用就是对象状态的保存和重建。（整个过程核心点就是字节流中所保存的对象状态及描述信息）</p><p>实体类序列化</p><p>对象序列化：ObjectOutputStream类</p><p>对象反序列化：ObjectInputStream类</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@time</span>: 2022/2/28 11:29</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final long serialVersionUID = -<span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> <span class="hljs-title class_">Name</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> <span class="hljs-title class_">Age</span>;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Name</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setName</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) &#123;<br>        <span class="hljs-title class_">Name</span> = name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getAge</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Age</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setAge</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> age</span>) &#123;<br>        <span class="hljs-title class_">Age</span> = age;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Student</span>(<span class="hljs-title class_">String</span> name, <span class="hljs-title class_">String</span> age) &#123;<br>        <span class="hljs-title class_">Name</span> = name;<br>        <span class="hljs-title class_">Age</span> = age;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:序列化和反序列化</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Kblayt</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@time</span>: 2022/2/28 11:32</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializableTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>        <span class="hljs-comment">//序列化</span><br>        FileOutputStream fos;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            fos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;object.out&quot;</span>);<br>            oos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(fos);<br>            s1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">&quot;lhg&quot;</span>,<span class="hljs-string">&quot;18&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                oos.writeObject(s1);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>                oos.flush();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>                oos.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//反序列化</span><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            fis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;object.out&quot;</span>);<br>            ois = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(fis);<br>            <span class="hljs-type">Student</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> (Student) ois.readObject();<br>            System.out.println(s2.getName()+<span class="hljs-string">&quot;&quot;</span>+s2.getAge());<br>        &#125; <span class="hljs-keyword">catch</span> (IOException | ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            ois.close();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>IO流</tag>
      
      <tag>序列化</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2022/10/04/hello-world/"/>
    <url>/2022/10/04/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
